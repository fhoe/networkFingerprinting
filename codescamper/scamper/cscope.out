cscope 15 $HOME/tfe/scamper               0001718913
	@dealias/scamper_dealias.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r_addr.h
"

40 
	~"sÿm³r_li¡.h
"

41 
	~"sÿm³r_icm³xt.h
"

42 
	~"sÿm³r_d—lŸs.h
"

43 
	~"uts.h
"

45 
	$sÿm³r_d—lŸs_id
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 **
´obes
,

46 
ušt32_t
 
´obec
, 
sÿm³r_d—lŸs_id_t
 *
id
)

48 cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
p
;

49 cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
r
;

50 
ušt32_t
 
bs_mšd
 = 0x30000;

51 
ušt32_t
 
bs_maxd
 = 0;

52 
ušt32_t
 
bs_sum
 = 0;

53 
ušt32_t
 
mšd
 = 0x30000;

54 
ušt32_t
 
maxd
 = 0;

55 
ušt32_t
 
sum
 = 0;

56 
ušt32_t
 
diff
;

57 
ušt32_t
 
cur
, 
´ev
;

58 
ušt32_t
 
i
;

59 
echo
, 
cÚs
;

61 
id
->
ty³
 = 
SCAMPER_DEALIAS_IPID_UNKNOWN
;

63 
echo
 = 1;

64 
cÚs
 = 1;

66 if(
´obec
 =ğ0 || 
´obes
[0] =ğ
NULL
 ||…robes[0]->
»¶yc
 != 1)

69 
´ev
 = 
´obes
[0]->
»¶›s
[0]->
id
;

70 
i
=1; i<
´obec
; i++)

72 if((
p
 = 
´obes
[
i
]è=ğ
NULL
)

75 if(
p
->
»¶yc
 != 1)

78 if((
r
 = 
p
->
»¶›s
[0]è=ğ
NULL
)

82 
cur
 = 
r
->
id
;

83 if(
cur
 > 
´ev
)

84 
diff
 = 
cur
 - 
´ev
;

85 if(
cur
 < 
´ev
)

86 
diff
 = 0x10000 + 
cur
 - 
´ev
;

88 
diff
 = 0;

89 if(
diff
 < 
mšd
)

90 
mšd
 = 
diff
;

91 if(
diff
 > 
maxd
)

92 
maxd
 = 
diff
;

93 
sum
 +ğ
diff
;

96 
cur
 = 
	`by‹sw­16
(
r
->
id
);

97 
´ev
 = 
	`by‹sw­16
(prev);

98 if(
cur
 > 
´ev
)

99 
diff
 = 
cur
 - 
´ev
;

100 if(
cur
 < 
´ev
)

101 
diff
 = 0x10000 + 
cur
 - 
´ev
;

103 
diff
 = 0;

104 if(
diff
 < 
bs_mšd
)

105 
bs_mšd
 = 
diff
;

106 if(
diff
 > 
maxd
)

107 
bs_maxd
 = 
diff
;

108 
bs_sum
 +ğ
diff
;

110 if(
echo
 !ğ0 && 
p
->
id
 !ğ
r
->id &&…->id !ğ
	`by‹sw­16
(r->ipid))

111 
echo
 = 0;

112 if(
cÚs
 !ğ0 && 
´obes
[
i
-1]->
»¶›s
[0]->
id
 !ğ
r
->ipid)

113 
cÚs
 = 0;

115 
´ev
 = 
r
->
id
;

118 if(
cÚs
 =ğ0 && 
echo
 == 0)

121 if(
sum
 < 
bs_sum
)

123 
id
->
mšd
 = mind;

124 
id
->
maxd
 = maxd;

128 
id
->
mšd
 = 
bs_mšd
;

129 
id
->
maxd
 = 
bs_maxd
;

131 
id
->
ty³
 = 
SCAMPER_DEALIAS_IPID_INCR
;

133 if(
cÚs
 != 0)

135 if(
´obes
[0]->
»¶›s
[0]->
id
 == 0)

136 
id
->
ty³
 = 
SCAMPER_DEALIAS_IPID_ZERO
;

138 
id
->
ty³
 = 
SCAMPER_DEALIAS_IPID_CONST
;

140 if(
echo
 != 0)

142 
id
->
ty³
 = 
SCAMPER_DEALIAS_IPID_ECHO
;

146 
	}
}

148 
	$d—lŸs_´obedef_ä“
(
sÿm³r_d—lŸs_´obedef_t
 *
´obedef
)

150 if(
´obedef
->
¤c
 !ğ
NULL
)

152 
	`sÿm³r_addr_ä“
(
´obedef
->
¤c
);

153 
´obedef
->
¤c
 = 
NULL
;

155 if(
´obedef
->
d¡
 !ğ
NULL
)

157 
	`sÿm³r_addr_ä“
(
´obedef
->
d¡
);

158 
´obedef
->
d¡
 = 
NULL
;

161 
	}
}

163 
	$d—lŸs_m”ÿtÜ_ä“
(*
d©a
)

165 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
 = (sÿm³r_d—lŸs_m”ÿtÜ_ˆ*)
d©a
;

166 
	`d—lŸs_´obedef_ä“
(&
m”ÿtÜ
->
´obedef
);

167 
	`ä“
(
m”ÿtÜ
);

169 
	}
}

171 
	$d—lŸs_®ly_ä“
(*
d©a
)

173 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = (sÿm³r_d—lŸs_®ly_ˆ*)
d©a
;

174 
	`d—lŸs_´obedef_ä“
(&
®ly
->
´obedefs
[0]);

175 
	`d—lŸs_´obedef_ä“
(&
®ly
->
´obedefs
[1]);

176 
	`ä“
(
®ly
);

178 
	}
}

180 
	$d—lŸs_¿d¬gun_ä“
(*
d©a
)

182 
sÿm³r_d—lŸs_¿d¬gun_t
 *
¿d¬gun
 = (sÿm³r_d—lŸs_¿d¬gun_ˆ*)
d©a
;

183 
ušt32_t
 
i
;

185 if(
¿d¬gun
->
´obedefs
 !ğ
NULL
)

187 
i
=0; i<
¿d¬gun
->
´obedefc
; i++)

189 
	`d—lŸs_´obedef_ä“
(&
¿d¬gun
->
´obedefs
[
i
]);

191 
	`ä“
(
¿d¬gun
->
´obedefs
);

193 
	`ä“
(
¿d¬gun
);

195 
	}
}

197 
	$d—lŸs_´efixsÿn_ä“
(*
d©a
)

199 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d©a
;

200 
ušt16_t
 
i
;

202 if(
´efixsÿn
 =ğ
NULL
)

205 if(
´efixsÿn
->
a
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(prefixscan->a);

206 if(
´efixsÿn
->
b
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(prefixscan->b);

207 if(
´efixsÿn
->
ab
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(prefixscan->ab);

209 if(
´efixsÿn
->
xs
 !ğ
NULL
)

211 
i
=0; i<
´efixsÿn
->
xc
; i++)

212 if(
´efixsÿn
->
xs
[
i
] !ğ
NULL
)

213 
	`sÿm³r_addr_ä“
(
´efixsÿn
->
xs
[
i
]);

214 
	`ä“
(
´efixsÿn
->
xs
);

217 if(
´efixsÿn
->
´obedefs
 !ğ
NULL
)

219 
i
=0; i<
´efixsÿn
->
´obedefc
; i++)

220 
	`d—lŸs_´obedef_ä“
(&
´efixsÿn
->
´obedefs
[
i
]);

221 
	`ä“
(
´efixsÿn
->
´obedefs
);

224 
	`ä“
(
´efixsÿn
);

227 
	}
}

229 
	$d—lŸs_bump_ä“
(*
d©a
)

231 
sÿm³r_d—lŸs_bump_t
 *
bump
 = (sÿm³r_d—lŸs_bump_ˆ*)
d©a
;

232 
	`d—lŸs_´obedef_ä“
(&
bump
->
´obedefs
[0]);

233 
	`d—lŸs_´obedef_ä“
(&
bump
->
´obedefs
[1]);

234 
	`ä“
(
bump
);

236 
	}
}

238 cÚ¡ *
	$sÿm³r_d—lŸs_´obedef_m‘hod_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_´obedef_t
 *
d
,

239 *
b
, 
size_t
 
l
)

241 cÚ¡ *
m
[] = {

242 
NULL
,

250 if(
d
->
m‘hod
 > (
m
è/ (*è|| m[d->m‘hod] =ğ
NULL
)

252 
	`¢´štf
(
b
, 
l
, "%d", 
d
->
m‘hod
);

253  
b
;

255  
m
[
d
->
m‘hod
];

256 
	}
}

258 
sÿm³r_d—lŸs_´obedef_t
 *
	$sÿm³r_d—lŸs_´obedef_®loc
()

260 
size_t
 
size
 = (
sÿm³r_d—lŸs_´obedef_t
);

261  (
sÿm³r_d—lŸs_´obedef_t
 *)
	`m®loc_z”o
(
size
);

262 
	}
}

264 
	$sÿm³r_d—lŸs_´obedef_ä“
(
sÿm³r_d—lŸs_´obedef_t
 *
´obedef
)

266 
	`d—lŸs_´obedef_ä“
(
´obedef
);

267 
	`ä“
(
´obedef
);

269 
	}
}

271 
sÿm³r_d—lŸs_´obe_t
 *
	$sÿm³r_d—lŸs_´obe_®loc
()

273 
size_t
 
size
 = (
sÿm³r_d—lŸs_´obe_t
);

274  (
sÿm³r_d—lŸs_´obe_t
 *)
	`m®loc_z”o
(
size
);

275 
	}
}

277 
	$sÿm³r_d—lŸs_´obe_ä“
(
sÿm³r_d—lŸs_´obe_t
 *
´obe
)

279 
ušt16_t
 
i
;

281 if(
´obe
->
»¶›s
 !ğ
NULL
)

283 
i
=0; i<
´obe
->
»¶yc
; i++)

285 if(
´obe
->
»¶›s
[
i
] !ğ
NULL
)

286 
	`sÿm³r_d—lŸs_»¶y_ä“
(
´obe
->
»¶›s
[
i
]);

288 
	`ä“
(
´obe
->
»¶›s
);

291 
	`ä“
(
´obe
);

293 
	}
}

295 
sÿm³r_d—lŸs_»¶y_t
 *
	$sÿm³r_d—lŸs_»¶y_®loc
()

297 
size_t
 
size
 = (
sÿm³r_d—lŸs_»¶y_t
);

298  (
sÿm³r_d—lŸs_»¶y_t
 *)
	`m®loc_z”o
(
size
);

299 
	}
}

301 
	$sÿm³r_d—lŸs_»¶y_ä“
(
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
)

303 if(
»¶y
->
¤c
 !ğ
NULL
)

304 
	`sÿm³r_addr_ä“
(
»¶y
->
¤c
);

305 
	`ä“
(
»¶y
);

307 
	}
}

309 
ušt32_t
 
	$sÿm³r_d—lŸs_»¶y_couÁ
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
)

311 
ušt32_t
 
rc
 = 0;

312 
ušt16_t
 
i
;

313 
i
=0; i<
d—lŸs
->
´obec
; i++)

315 if(
d—lŸs
->
´obes
[
i
] !ğ
NULL
)

316 
rc
 +ğ
d—lŸs
->
´obes
[
i
]->
»¶yc
;

318  
rc
;

319 
	}
}

321 
	$d—lŸs_´obe_tx_cmp
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
a
,

322 cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
b
)

324  
	`timev®_cmp
(&
a
->
tx
, &
b
->tx);

325 
	}
}

327 
	$d—lŸs_´obe_£q_cmp
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
a
,

328 cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
b
)

330 if(
a
->
£q
 < 
b
->seq)

332 if(
a
->
£q
 > 
b
->seq)

334 if(
a
->
def
->
id
 < 
b
->def->id)

336 if(
a
->
def
->
id
 > 
b
->def->id)

339 
	}
}

341 
	$d—lŸs_´obe_def_cmp
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
a
,

342 cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
b
)

344 if(
a
->
def
->
id
 < 
b
->def->id)

346 if(
a
->
def
->
id
 > 
b
->def->id)

348 if(
a
->
£q
 < 
b
->seq)

350 if(
a
->
£q
 > 
b
->seq)

353 
	}
}

355 
	$sÿm³r_d—lŸs_´obes_sÜt_tx
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

357 
	`¬¿y_qsÜt
((**)
d—lŸs
->
´obes
, d—lŸs->
´obec
,

358 (
¬¿y_cmp_t
)
d—lŸs_´obe_tx_cmp
);

360 
	}
}

362 
	$sÿm³r_d—lŸs_´obes_sÜt_£q
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

364 
	`¬¿y_qsÜt
((**)
d—lŸs
->
´obes
, d—lŸs->
´obec
,

365 (
¬¿y_cmp_t
)
d—lŸs_´obe_£q_cmp
);

367 
	}
}

369 
	$sÿm³r_d—lŸs_´obes_sÜt_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

371 
	`¬¿y_qsÜt
((**)
d—lŸs
->
´obes
, d—lŸs->
´obec
,

372 (
¬¿y_cmp_t
)
d—lŸs_´obe_def_cmp
);

374 
	}
}

376 
	$sÿm³r_d—lŸs_´obe_add
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

377 
sÿm³r_d—lŸs_´obe_t
 *
´obe
)

379 
size_t
 
size
 = (
d—lŸs
->
´obec
+1è* (
sÿm³r_d—lŸs_´obe_t
 *);

380 if(
	`»®loc_w¿p
((**)&
d—lŸs
->
´obes
, 
size
) == 0)

382 
d—lŸs
->
´obes
[d—lŸs->
´obec
++] = 
´obe
;

386 
	}
}

388 
	$sÿm³r_d—lŸs_»¶y_add
(
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

389 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
)

391 
size_t
 
size
 = (
´obe
->
»¶yc
+1è* (
sÿm³r_d—lŸs_»¶y_t
 *);

392 if(
	`»®loc_w¿p
((**)&
´obe
->
»¶›s
, 
size
) == 0)

394 
´obe
->
»¶›s
[´obe->
»¶yc
++] = 
»¶y
;

398 
	}
}

400 
	$sÿm³r_d—lŸs_®ly_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

402 if((
d—lŸs
->
d©a
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_®ly_t
))è!ğ
NULL
)

405 
	}
}

407 
	$sÿm³r_d—lŸs_m”ÿtÜ_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

409 if((
d—lŸs
->
d©a
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_m”ÿtÜ_t
))è!ğ
NULL
)

412 
	}
}

414 
	$sÿm³r_d—lŸs_¿d¬gun_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

416 if((
d—lŸs
->
d©a
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_¿d¬gun_t
))è!ğ
NULL
)

419 
	}
}

421 
	$sÿm³r_d—lŸs_´efixsÿn_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

423 
d—lŸs
->
d©a
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_´efixsÿn_t
));

424 if(
d—lŸs
->
d©a
 !ğ
NULL
)

427 
	}
}

429 
	$sÿm³r_d—lŸs_bump_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

431 if((
d—lŸs
->
d©a
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_bump_t
))è!ğ
NULL
)

435 
	}
}

437 
ušt16_t
 
	$d—lŸs_id16_diff
(
ušt32_t
 
a
, ušt32_ˆ
b
)

439 if(
b
 < 
a
)

440 
b
 += 0x10000;

441  
b
 - 
a
;

442 
	}
}

444 
	$d—lŸs_id16_š£q2
(
ušt16_t
 
a
, ušt16_ˆ
b
, ušt16_ˆ
fudge
)

446 if(
a
 =ğ
b
 || 
	`d—lŸs_id16_diff
×, bè> 
fudge
)

449 
	}
}

451 
	$d—lŸs_id16_š£q3
(
ušt32_t
 
a
,ušt32_ˆ
b
,ušt32_ˆ
c
,ušt32_ˆ
f
)

453 if(
a
 =ğ
b
 || b =ğ
c
 ||‡ == c)

456 if(
a
 > 
b
)

457 
b
 += 0x10000;

458 if(
a
 > 
c
)

459 
c
 += 0x10000;

461 if(
f
 != 0)

463 if(
b
 - 
a
 > 
f
 || 
c
 - b > f)

468 if(
a
 > 
b
 || b > 
c
)

473 
	}
}

475 
ušt16_t
 
	$d—lŸs_id32_diff
(
ušt64_t
 
a
, ušt64_ˆ
b
)

477 if(
b
 < 
a
)

478 
b
 += 0x100000000ULL;

479  
b
 - 
a
;

480 
	}
}

482 
	$d—lŸs_id32_š£q2
(
ušt32_t
 
a
, ušt32_ˆ
b
, ušt32_ˆ
fudge
)

484 if(
a
 =ğ
b
 || 
	`d—lŸs_id32_diff
×, bè> 
fudge
)

487 
	}
}

489 
	$d—lŸs_id32_š£q3
(
ušt64_t
 
a
,ušt64_ˆ
b
,ušt64_ˆ
c
,ušt64_ˆ
f
)

491 if(
a
 =ğ
b
 || b =ğ
c
 ||‡ == c)

494 if(
a
 > 
b
)

495 
b
 += 0x100000000ULL;

496 if(
a
 > 
c
)

497 
c
 += 0x100000000ULL;

499 if(
f
 != 0)

501 if(
b
 - 
a
 > 
f
 || 
c
 - b > f)

506 if(
a
 > 
b
 || b > 
c
)

511 
	}
}

513 
	$d—lŸs_id16_bo
(
sÿm³r_d—lŸs_´obe_t
 **
´obes
, 
´obec
)

515 
sÿm³r_d—lŸs_´obe_t
 **
s
 = 
NULL
;

516 
ušt16_t
 
a
, 
b
, 
c
 = 1, 
max_bs
 = 0, 
max_nobs
 = 0, 
u16
;

517 
i
, 
rc
 = 2;

519 if((
s
 = 
	`memdup
(
´obes
, (
sÿm³r_d—lŸs_´obe_t
 *è* 
´obec
)è=ğ
NULL
)

521 
	`¬¿y_qsÜt
((**)
s
, 
´obec
, (
¬¿y_cmp_t
)
d—lŸs_´obe_def_cmp
);

523 
i
=0; i<
´obec
-1; i++)

525 if(
s
[
i
]->
def
 != s[i+1]->def)

527 if(
c
 >= 3)

529 if(
max_nobs
 < 
max_bs
)

530 
rc
 = 0;

531 if(
max_nobs
 > 
max_bs
)

532 
rc
 = 1;

533 if(
rc
 == 0)

534 
dÚe
;

536 
c
 = 1; 
max_nobs
 = 0; 
max_bs
 = 0;

540 
a
 = 
s
[
i
]->
»¶›s
[0]->
id
; 
b
 = s[i+1]->replies[0]->ipid;

541 
u16
 = 
	`d—lŸs_id16_diff
(
a
, 
b
);

542 if(
u16
 > 
max_nobs
 || max_nobs == 0)

543 
max_nobs
 = 
u16
;

544 
u16
 = 
	`d—lŸs_id16_diff
(
	`by‹sw­16
(
a
), by‹sw­16(
b
));

545 if(
u16
 > 
max_bs
 || max_bs == 0)

546 
max_bs
 = 
u16
;

547 
c
++;

551 
dÚe
:

552 if(
s
 !ğ
NULL
è
	`ä“
(s);

553  
rc
;

554 
	}
}

556 
	$d—lŸs_id16_š£q
(
sÿm³r_d—lŸs_´obe_t
 **
´obes
,

557 
´obec
, 
ušt16_t
 
fudge
, 
bs
)

559 
ušt16_t
 
a
, 
b
, 
c
;

560 
i
;

566 if(
´obec
 == 2)

569 if(
fudge
 == 0)

572 
a
 = 
´obes
[0]->
»¶›s
[0]->
id
;

573 
b
 = 
´obes
[1]->
»¶›s
[0]->
id
;

574 if(
bs
 != 0)

576 
a
 = 
	`by‹sw­16
(a);

577 
b
 = 
	`by‹sw­16
(b);

579 if(
	`d—lŸs_id16_š£q2
(
a
, 
b
, 
fudge
) != 0)

584 
i
=0; i+2<
´obec
; i+=2)

586 
a
 = 
´obes
[
i
+0]->
»¶›s
[0]->
id
;

587 
b
 = 
´obes
[
i
+1]->
»¶›s
[0]->
id
;

588 
c
 = 
´obes
[
i
+2]->
»¶›s
[0]->
id
;

589 if(
bs
 != 0)

591 
a
 = 
	`by‹sw­16
(a);

592 
b
 = 
	`by‹sw­16
(b);

593 
c
 = 
	`by‹sw­16
(c);

595 if(
	`d—lŸs_id16_š£q3
(
a
, 
b
, 
c
, 
fudge
) == 0)

600 if(
´obec
 - 
i
 > 1)

602 
a
 = 
´obes
[
´obec
-3]->
»¶›s
[0]->
id
;

603 
b
 = 
´obes
[
´obec
-2]->
»¶›s
[0]->
id
;

604 
c
 = 
´obes
[
´obec
-1]->
»¶›s
[0]->
id
;

605 if(
bs
 != 0)

607 
a
 = 
	`by‹sw­16
(a);

608 
b
 = 
	`by‹sw­16
(b);

609 
c
 = 
	`by‹sw­16
(c);

611 if(
	`d—lŸs_id16_š£q3
(
a
, 
b
, 
c
, 
fudge
) == 0)

616 
	}
}

618 
	$d—lŸs_id32_bo
(
sÿm³r_d—lŸs_´obe_t
 **
´obes
, 
´obec
)

620 
sÿm³r_d—lŸs_´obe_t
 **
s
 = 
NULL
;

621 
ušt32_t
 
a
, 
b
, 
c
 = 1, 
max_bs
 = 0, 
max_nobs
 = 0, 
u32
;

622 
i
, 
rc
 = 2;

624 if((
s
 = 
	`memdup
(
´obes
, (
sÿm³r_d—lŸs_´obe_t
 *è* 
´obec
)è=ğ
NULL
)

626 
	`¬¿y_qsÜt
((**)
s
, 
´obec
, (
¬¿y_cmp_t
)
d—lŸs_´obe_def_cmp
);

628 
i
=0; i<
´obec
-1; i++)

630 if(
s
[
i
]->
def
 != s[i+1]->def)

632 if(
c
 >= 3)

634 if(
max_nobs
 < 
max_bs
)

635 
rc
 = 0;

636 if(
max_nobs
 > 
max_bs
)

637 
rc
 = 1;

638 if(
rc
 == 0)

639 
dÚe
;

641 
c
 = 1; 
max_nobs
 = 0; 
max_bs
 = 0;

645 
a
 = 
s
[
i
]->
»¶›s
[0]->
id32
; 
b
 = s[i+1]->replies[0]->ipid32;

646 
u32
 = 
	`d—lŸs_id32_diff
(
a
, 
b
);

647 if(
u32
 > 
max_nobs
 || max_nobs == 0)

648 
max_nobs
 = 
u32
;

649 
u32
 = 
	`d—lŸs_id32_diff
(
	`by‹sw­32
(
a
), by‹sw­32(
b
));

650 if(
u32
 > 
max_bs
 || max_bs == 0)

651 
max_bs
 = 
u32
;

652 
c
++;

656 
dÚe
:

657 if(
s
 !ğ
NULL
è
	`ä“
(s);

658  
rc
;

659 
	}
}

661 
	$d—lŸs_id32_š£q
(
sÿm³r_d—lŸs_´obe_t
 **
´obes
,

662 
´obec
, 
ušt16_t
 
fudge
, 
bs
)

664 
ušt32_t
 
a
, 
b
, 
c
;

665 
i
;

671 if(
´obec
 == 2)

674 if(
fudge
 == 0)

677 
a
 = 
´obes
[0]->
»¶›s
[0]->
id32
;

678 
b
 = 
´obes
[1]->
»¶›s
[0]->
id32
;

679 if(
bs
 != 0)

681 
a
 = 
	`by‹sw­32
(a);

682 
b
 = 
	`by‹sw­32
(b);

684 if(
	`d—lŸs_id32_š£q2
(
a
, 
b
, 
fudge
) != 0)

689 
i
=0; i+2<
´obec
; i+=2)

691 
a
 = 
´obes
[
i
+0]->
»¶›s
[0]->
id32
;

692 
b
 = 
´obes
[
i
+1]->
»¶›s
[0]->
id32
;

693 
c
 = 
´obes
[
i
+2]->
»¶›s
[0]->
id32
;

694 if(
bs
 != 0)

696 
a
 = 
	`by‹sw­32
(a);

697 
b
 = 
	`by‹sw­32
(b);

698 
c
 = 
	`by‹sw­32
(c);

700 if(
	`d—lŸs_id32_š£q3
(
a
, 
b
, 
c
, 
fudge
) == 0)

705 if(
´obec
 - 
i
 > 1)

707 
a
 = 
´obes
[
´obec
-3]->
»¶›s
[0]->
id32
;

708 
b
 = 
´obes
[
´obec
-2]->
»¶›s
[0]->
id32
;

709 
c
 = 
´obes
[
´obec
-1]->
»¶›s
[0]->
id32
;

710 if(
bs
 != 0)

712 
a
 = 
	`by‹sw­32
(a);

713 
b
 = 
	`by‹sw­32
(b);

714 
c
 = 
	`by‹sw­32
(c);

716 if(
	`d—lŸs_id32_š£q3
(
a
, 
b
, 
c
, 
fudge
) == 0)

721 
	}
}

723 
	$sÿm³r_d—lŸs_id_š£q
(
sÿm³r_d—lŸs_´obe_t
 **
´obes
,

724 
´obec
, 
ušt16_t
 
fudge
, 
bs
)

726 (*cÚ¡ 
š£q
[])(
sÿm³r_d—lŸs_´obe_t
 **,,
ušt16_t
,) = {

727 
d—lŸs_id16_š£q
,

728 
d—lŸs_id32_š£q
,

730 (*cÚ¡ 
bo
[])(
sÿm³r_d—lŸs_´obe_t
 **, ) = {

731 
d—lŸs_id16_bo
,

732 
d—lŸs_id32_bo
,

734 
i
, 
x
;

736 if(
´obec
 < 2)

739 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´obes
[0]->
def
->
d¡
))

740 
x
 = 0;

741 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
´obes
[0]->
def
->
d¡
))

742 
x
 = 1;

746 if(
bs
 == 3)

748 if((
i
 = 
bo
[
x
](
´obes
, 
´obec
)) == -1)

750  
š£q
[
x
](
´obes
, 
´obec
, 
fudge
, 
i
);

753 if(
bs
 == 2)

755 if(
š£q
[
x
](
´obes
, 
´obec
, 
fudge
, 0) == 1)

757  
š£q
[
x
](
´obes
, 
´obec
, 
fudge
, 1);

760  
š£q
[
x
](
´obes
, 
´obec
, 
fudge
, 
bs
);

761 
	}
}

763 
	$sÿm³r_d—lŸs_´obes_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
ušt32_t
 
út
)

765 
size_t
 
size
 = 
út
 * (
sÿm³r_d—lŸs_´obe_t
 *);

766 if((
d—lŸs
->
´obes
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

769 
	}
}

771 
	$sÿm³r_d—lŸs_»¶›s_®loc
(
sÿm³r_d—lŸs_´obe_t
 *
´obe
, 
ušt16_t
 
út
)

773 
size_t
 
size
 = 
út
 * (
sÿm³r_d—lŸs_»¶y_t
 *);

774 if((
´obe
->
»¶›s
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

777 
	}
}

779 
	$sÿm³r_d—lŸs_¿d¬gun_´obedefs_®loc
(
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
,

780 
ušt32_t
 
´obedefc
)

782 
size_t
 
Ën
 = 
´obedefc
 * (
sÿm³r_d—lŸs_´obedef_t
);

783 if((
rg
->
´obedefs
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

786 
	}
}

788 
	sd—lŸs_»sŞv


790 
sÿm³r_d—lŸs_´obe_t
 **
	m´obes
;

791 
	m´obec
;

792 
	m´ob‘
;

793 } 
	td—lŸs_»sŞv_t
;

795 
	$d—lŸs_fudge_š£q
(
sÿm³r_d—lŸs_´obe_t
 *
´_a
,

796 
sÿm³r_d—lŸs_´obe_t
 *
´_b
,

797 
bs
, 
fudge
)

799 
ušt32_t
 
a
 = 
´_a
->
»¶›s
[0]->
id
;

800 
ušt32_t
 
b
 = 
´_b
->
»¶›s
[0]->
id
;

802 if(
bs
 != 0)

804 
a
 = 
	`by‹sw­16
(a);

805 
b
 = 
	`by‹sw­16
(b);

808 if(
a
 > 
b
)

809 
b
 += 0x10000;

811 if(()(
b
 - 
a
è> 
fudge
)

815 
	}
}

817 
	$sÿm³r_d—lŸs_´efixsÿn_xs_add
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

818 
sÿm³r_addr_t
 *
addr
)

820 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

821 
tmp
;

823 if(
	`¬¿y_fšd
((**)
´efixsÿn
->
xs
,…»fixsÿn->
xc
, 
addr
,

824 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

827 if((
tmp
 = 
´efixsÿn
->
xc
) == 65535)

830 if(
	`¬¿y_š£¹
((***)&
´efixsÿn
->
xs
, &
tmp
, 
addr
,

831 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
) != 0)

834 
	`sÿm³r_addr_u£
(
addr
);

835 
´efixsÿn
->
xc
++;

837 
	}
}

839 
	$sÿm³r_d—lŸs_´efixsÿn_xs_š
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

840 
sÿm³r_addr_t
 *
addr
)

842 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

843 if(
	`¬¿y_fšd
((**)
´efixsÿn
->
xs
,…»fixsÿn->
xc
, 
addr
,

844 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

847 
	}
}

849 
	$sÿm³r_d—lŸs_´efixsÿn_xs_®loc
(
sÿm³r_d—lŸs_´efixsÿn_t
 *
p
,

850 
ušt16_t
 
xc
)

852 if((
p
->
xs
 = 
	`m®loc_z”o
((
sÿm³r_addr_t
 *è* 
xc
)è!ğ
NULL
)

855 
	}
}

857 
	$sÿm³r_d—lŸs_´efixsÿn_´obedefs_®loc
(
sÿm³r_d—lŸs_´efixsÿn_t
 *
p
,

858 
ušt32_t
 
´obedefc
)

860 
size_t
 
Ën
 = 
´obedefc
 * (
sÿm³r_d—lŸs_´obedef_t
);

861 if((
p
->
´obedefs
 = 
	`m®loc_z”o
(
Ën
)è!ğ
NULL
)

864 
	}
}

866 
	$sÿm³r_d—lŸs_´efixsÿn_´obedef_add
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

867 
sÿm³r_d—lŸs_´obedef_t
 *
def
)

869 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

870 
size_t
 
size
;

873 
size
 = (
sÿm³r_d—lŸs_´obedef_t
è* (
´efixsÿn
->
´obedefc
+1);

874 if(
	`»®loc_w¿p
((**)&
´efixsÿn
->
´obedefs
, 
size
) != 0)

878 
	`memıy
(&
´efixsÿn
->
´obedefs
[´efixsÿn->
´obedefc
],

879 
def
, (
sÿm³r_d—lŸs_´obedef_t
));

882 
def
 = &
´efixsÿn
->
´obedefs
[´efixsÿn->
´obedefc
];

883 
def
->
id
 = 
´efixsÿn
->
´obedefc
++;

884 
	`sÿm³r_addr_u£
(
def
->
¤c
);

885 
	`sÿm³r_addr_u£
(
def
->
d¡
);

888 
	}
}

890 
	$sÿm³r_d—lŸs_¿d¬gun_fudge
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

891 
sÿm³r_d—lŸs_´obedef_t
 *
def
,

892 
sÿm³r_d—lŸs_´obedef_t
 **
defs
, *
út
,

893 
fudge
)

895 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
 = 
d—lŸs
->
d©a
;

896 
sÿm³r_d—lŸs_´obe_t
 *
´
, *
´_a
, *
´_b
;

897 
sÿm³r_d—lŸs_»¶y_t
 *
»
, *
»_a
, *
»_b
, *
»_c
;

898 
d—lŸs_»sŞv_t
 *
dr
 = 
NULL
;

899 
d—lŸs_»sŞv_t
 *
drd
;

900 
ušt32_t
 
pid
, 
x
;

901 
i
, 
j
, 
k
, 
bs
, 
š£q
, 
d
 = 0;

903 if(
d—lŸs
->
m‘hod
 !ğ
SCAMPER_DEALIAS_METHOD_RADARGUN
)

904 
”r
;

906 if((
dr
 = 
	`m®loc_z”o
((
d—lŸs_»sŞv_t
è* 
rg
->
´obedefc
)è=ğ
NULL
)

907 
”r
;

909 
x
=0; x<
d—lŸs
->
´obec
; x++)

911 
´
 = 
d—lŸs
->
´obes
[
x
];

912 
pid
 = 
´
->
def
->
id
;

918 if(
dr
[
pid
].
´obec
 < 0)

921 if(
´
->
»¶yc
 > 1)

923 if(
dr
[
pid
].
´obes
 !ğ
NULL
)

924 
	`ä“
(
dr
[
pid
].
´obes
);

925 
dr
[
pid
].
´obec
 = -1;

927 if(
´
->
def
 == def)

928 
dÚe
;

933 
dr
[
pid
].
´ob‘
++;

935 if(
´
->
»¶yc
 == 0)

938 
»
 = 
´
->
»¶›s
[0];

944 if(
dr
[
pid
].
´obec
 == 2)

946 
´_a
 = 
dr
[
pid
].
´obes
[0];

947 
´_b
 = 
dr
[
pid
].
´obes
[1];

948 
»_a
 = 
´_a
->
»¶›s
[0];

949 
»_b
 = 
´_b
->
»¶›s
[0];

951 if((
»
->
id
 =ğ
´
->id && 
»_a
->id =ğ
´_a
->ipid &&

952 
»_b
->
id
 =ğ
´_b
->ipid) ||

953 (
»
->
id
 =ğ
»_a
->id &&„e->id =ğ
»_b
->ipid))

955 
	`ä“
(
dr
[
pid
].
´obes
);

956 
dr
[
pid
].
´obec
 = -1;

958 if(
´
->
def
 == def)

959 
dÚe
;

964 if(
	`¬¿y_š£¹
((***)&
dr
[
pid
].
´obes
,&dr[pid].
´obec
,
´
,
NULL
) != 0)

965 
”r
;

969 if(
dr
[
def
->
id
].
´obec
 < 3)

970 
dÚe
;

971 
»_a
 = 
dr
[
def
->
id
].
´obes
[0]->
»¶›s
[0];

972 
»_b
 = 
dr
[
def
->
id
].
´obes
[1]->
»¶›s
[0];

973 
»_c
 = 
dr
[
def
->
id
].
´obes
[2]->
»¶›s
[0];

974 if(
»_a
->
id
 < 
»_b
->ipid)

975 
i
 = 
»_b
->
id
 - 
»_a
->ipid;

977 
i
 = 0x10000 + 
»_b
->
id
 - 
»_a
->ipid;

978 if(
»_b
->
id
 < 
»_c
->ipid)

979 
i
 +ğ
»_c
->
id
 - 
»_b
->ipid;

981 
i
 +ğ0x10000 + 
»_c
->
id
 - 
»_b
->ipid;

982 if(
	`by‹sw­16
(
»_a
->
id
è< by‹sw­16(
»_b
->ipid))

983 
j
 = 
	`by‹sw­16
(
»_b
->
id
è- by‹sw­16(
»_a
->ipid);

985 
j
 = 0x10000 + 
	`by‹sw­16
(
»_b
->
id
è- by‹sw­16(
»_a
->ipid);

986 if(
	`by‹sw­16
(
»_b
->
id
è< by‹sw­16(
»_c
->ipid))

987 
j
 +ğ
	`by‹sw­16
(
»_c
->
id
è- by‹sw­16(
»_b
->ipid);

989 
j
 +ğ0x10000 + 
	`by‹sw­16
(
»_c
->
id
è- by‹sw­16(
»_b
->ipid);

990 if(
i
 < 
j
)

991 
bs
 = 0;

993 
bs
 = 1;

996 
drd
 = &
dr
[
def
->
id
]; 
d
 = 0;

997 
pid
=0;…id<
rg
->
´obedefc
;…id++)

999 if(&
rg
->
´obedefs
[
pid
] =ğ
def
 || 
dr
[pid].
´obec
 < 3)

1002 
j
 = 0; 
k
 = 0;

1005 if(
	`timev®_cmp
(&
drd
->
´obes
[
j
]->
tx
, &
dr
[
pid
].´obes[
k
]->tx) < 0)

1006 
´_a
 = 
drd
->
´obes
[
j
++];

1008 
´_a
 = 
dr
[
pid
].
´obes
[
k
++];

1012 if(
	`timev®_cmp
(&
drd
->
´obes
[
j
]->
tx
, &
dr
[
pid
].´obes[
k
]->tx) < 0)

1013 
´_b
 = 
drd
->
´obes
[
j
++];

1015 
´_b
 = 
dr
[
pid
].
´obes
[
k
++];

1017 if((
š£q
 = 
	`d—lŸs_fudge_š£q
(
´_a
, 
´_b
, 
bs
, 
fudge
)) == 0)

1020 if(
j
 =ğ
drd
->
´obec
 || 
k
 =ğ
dr
[
pid
].probec)

1028 if(
š£q
 == 0)

1031 
defs
[
d
++] = &
rg
->
´obedefs
[
pid
];

1032 if(
d
 =ğ*
út
)

1036 
dÚe
:

1037 *
út
 = 
d
;

1038 
x
=0; x<
rg
->
´obedefc
; x++)

1039 if(
dr
[
x
].
´obec
 > 0)

1040 
	`ä“
(
dr
[
x
].
´obes
);

1043 
”r
:

1044 if(
dr
 !ğ
NULL
)

1046 
x
=0; x<
rg
->
´obedefc
; x++)

1047 if(
dr
[
x
].
´obec
 > 0)

1048 
	`ä“
(
dr
[
x
].
´obes
);

1051 
	}
}

1053 cÚ¡ *
	$sÿm³r_d—lŸs_m‘hod_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d
, *
b
, 
size_t
 
l
)

1055 cÚ¡ *
m
[] = {

1056 
NULL
,

1063 if(
d
->
m‘hod
 > (
m
è/ (*è|| m[d->m‘hod] =ğ
NULL
)

1065 
	`¢´štf
(
b
, 
l
, "%d", 
d
->
m‘hod
);

1066  
b
;

1068  
m
[
d
->
m‘hod
];

1069 
	}
}

1071 cÚ¡ *
	$sÿm³r_d—lŸs_»suÉ_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d
, *
b
, 
size_t
 
l
)

1073 *
t
[] = {

1079 if(
d
->
»suÉ
 > (
t
è/ (*è||[d->»suÉ] =ğ
NULL
)

1081 
	`¢´štf
(
b
, 
l
, "%d", 
d
->
»suÉ
);

1082  
b
;

1084  
t
[
d
->
»suÉ
];

1085 
	}
}

1087 
	$sÿm³r_d—lŸs_ä“
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

1089 (*cÚ¡ 
func
[])(*) = {

1090 
d—lŸs_m”ÿtÜ_ä“
,

1091 
d—lŸs_®ly_ä“
,

1092 
d—lŸs_¿d¬gun_ä“
,

1093 
d—lŸs_´efixsÿn_ä“
,

1094 
d—lŸs_bump_ä“
,

1097 
ušt32_t
 
i
;

1099 if(
d—lŸs
 =ğ
NULL
)

1102 if(
d—lŸs
->
´obes
 !ğ
NULL
)

1104 
i
=0; i<
d—lŸs
->
´obec
; i++)

1106 if(
d—lŸs
->
´obes
[
i
] !ğ
NULL
)

1107 
	`sÿm³r_d—lŸs_´obe_ä“
(
d—lŸs
->
´obes
[
i
]);

1109 
	`ä“
(
d—lŸs
->
´obes
);

1112 if(
d—lŸs
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(dealias->cycle);

1113 if(
d—lŸs
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(dealias->list);

1115 if(
d—lŸs
->
d©a
 !ğ
NULL
)

1117 
	`as£¹
(
d—lŸs
->
m‘hod
 != 0);

1118 
	`as£¹
(
d—lŸs
->
m‘hod
 <= 5);

1119 
func
[
d—lŸs
->
m‘hod
-1](d—lŸs->
d©a
);

1122 
	`ä“
(
d—lŸs
);

1124 
	}
}

1126 
sÿm³r_d—lŸs_t
 *
	$sÿm³r_d—lŸs_®loc
()

1128  (
sÿm³r_d—lŸs_t
 *)
	`m®loc_z”o
((scamper_dealias_t));

1129 
	}
}

	@dealias/scamper_dealias.h

29 #iâdeà
__SCAMPER_DEALIAS_H


30 
	#__SCAMPER_DEALIAS_H


	)

32 
	#SCAMPER_DEALIAS_METHOD_MERCATOR
 1

	)

33 
	#SCAMPER_DEALIAS_METHOD_ALLY
 2

	)

34 
	#SCAMPER_DEALIAS_METHOD_RADARGUN
 3

	)

35 
	#SCAMPER_DEALIAS_METHOD_PREFIXSCAN
 4

	)

36 
	#SCAMPER_DEALIAS_METHOD_BUMP
 5

	)

38 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
 1

	)

39 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
 2

	)

40 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
 3

	)

41 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK_SPORT
 4

	)

42 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
 5

	)

43 
	#SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_SYN_SPORT
 6

	)

45 
	#SCAMPER_DEALIAS_RESULT_NONE
 0

	)

46 
	#SCAMPER_DEALIAS_RESULT_ALIASES
 1

	)

47 
	#SCAMPER_DEALIAS_RESULT_NOTALIASES
 2

	)

48 
	#SCAMPER_DEALIAS_RESULT_HALTED
 3

	)

50 
	#SCAMPER_DEALIAS_ALLY_FLAG_NOBS
 1

	)

51 
	#SCAMPER_DEALIAS_PREFIXSCAN_FLAG_NOBS
 1

	)

52 
	#SCAMPER_DEALIAS_RADARGUN_FLAG_SHUFFLE
 1

	)

54 
	#SCAMPER_DEALIAS_REPLY_FLAG_IPID32
 1

	)

56 
	#SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
def
) ( \

57 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
)

	)

59 
	#SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
def
) ( \

60 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
 || \

61 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
)

	)

63 
	#SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
) ( \

64 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
 || \

65 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK_SPORT
 || \

66 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_SYN_SPORT
)

	)

68 
	#SCAMPER_DEALIAS_PROBEDEF_VARY_TCP_SPORT
(
def
) ( \

69 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK_SPORT
 || \

70 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_SYN_SPORT
)

	)

72 
	#SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP_ACK
(
def
) ( \

73 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
 || \

74 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK_SPORT
)

	)

76 
	#SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP_SYN
(
def
) ( \

77 (
def
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_SYN_SPORT
)

	)

79 
	#SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
) ( \

80 ((
»¶y
)->
´Ùo
 =ğ1 || (»¶y)->´ÙØ=ğ58))

	)

82 
	#SCAMPER_DEALIAS_REPLY_IS_TCP
(
»¶y
) ( \

83 ((
»¶y
)->
´Ùo
 =ğ6))

	)

85 
	#SCAMPER_DEALIAS_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ( \

86 ((
»¶y
)->
´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 11) || \

87 ((
»¶y
)->
´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ3))

	)

89 
	#SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH
(
»¶y
) ( \

90 ((
»¶y
)->
´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 3) || \

91 ((
»¶y
)->
´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ1))

	)

93 
	#SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
) ( \

94 ((
»¶y
)->
´Ùo
 == 1 && \

95 (
»¶y
)->
icmp_ty³
 =ğ3 && (»¶y)->
icmp_code
 == 3) || \

96 ((
»¶y
)->
´Ùo
 == 58 && \

97 (
»¶y
)->
icmp_ty³
 =ğ1 && (»¶y)->
icmp_code
 =ğ4))

	)

99 
	#SCAMPER_DEALIAS_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
) ( \

100 ((
»¶y
)->
´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 0) || \

101 ((
»¶y
)->
´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ129))

	)

103 
	#SCAMPER_DEALIAS_METHOD_IS_MERCATOR
(
d
) ( \

104 (
d
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_MERCATOR
)

	)

106 
	#SCAMPER_DEALIAS_METHOD_IS_ALLY
(
d
) ( \

107 (
d
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_ALLY
)

	)

109 
	#SCAMPER_DEALIAS_METHOD_IS_RADARGUN
(
d
) ( \

110 (
d
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_RADARGUN
)

	)

112 
	#SCAMPER_DEALIAS_METHOD_IS_PREFIXSCAN
(
d
) ( \

113 (
d
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_PREFIXSCAN
)

	)

115 
	#SCAMPER_DEALIAS_METHOD_IS_BUMP
(
d
) ( \

116 (
d
)->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_BUMP
)

	)

118 
	#SCAMPER_DEALIAS_RESULT_IS_NONE
(
d
) ( \

119 (
d
)->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_NONE
)

	)

121 
	#SCAMPER_DEALIAS_RESULT_IS_ALIASES
(
d
) ( \

122 (
d
)->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_ALIASES
)

	)

124 
	#SCAMPER_DEALIAS_RESULT_IS_NOTALIASES
(
d
) ( \

125 (
d
)->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_NOTALIASES
)

	)

127 
	#SCAMPER_DEALIAS_ALLY_IS_NOBS
(
d
) ( \

128 (((
sÿm³r_d—lŸs_®ly_t
 *)(
d
)->
d©a
)->
æags
) & \

129 
SCAMPER_DEALIAS_ALLY_FLAG_NOBS
)

	)

131 
	#SCAMPER_DEALIAS_PREFIXSCAN_IS_NOBS
(
d
) ( \

132 (((
sÿm³r_d—lŸs_´efixsÿn_t
 *)(
d
)->
d©a
)->
æags
) & \

133 
SCAMPER_DEALIAS_PREFIXSCAN_FLAG_NOBS
)

	)

135 
	#SCAMPER_DEALIAS_REPLY_FROM_TARGET
(
p
, 
r
) ( \

136 (
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
((
p
)->
def
) && \

137 
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH_PORT
((
r
))) || \

138 (
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
((
p
)->
def
) && \

139 
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_ECHO_REPLY
((
r
))) || \

140 (
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
((
p
)->
def
) && \

141 
	`SCAMPER_DEALIAS_REPLY_IS_TCP
((
r
))))

	)

143 
	ssÿm³r_d—lŸs_»¶y


145 
sÿm³r_addr_t
 *
	m¤c
;

146 
timev®
 
	mrx
;

148 
ušt8_t
 
	mæags
;

149 
ušt8_t
 
	m´Ùo
;

150 
ušt8_t
 
	m‰l
;

151 
ušt8_t
 
	micmp_ty³
;

152 
ušt8_t
 
	micmp_code
;

153 
ušt8_t
 
	micmp_q__‰l
;

154 
ušt8_t
 
	mtı_æags
;

156 
ušt16_t
 
	mid
;

157 
ušt32_t
 
	mid32
;

159 
sÿm³r_icm³xt
 *
	micmp_ext
;

161 } 
	tsÿm³r_d—lŸs_»¶y_t
;

163 
	ssÿm³r_d—lŸs_´obedef_udp


165 
ušt16_t
 
	m¥Üt
;

166 
ušt16_t
 
	mdpÜt
;

167 } 
	tsÿm³r_d—lŸs_´obedef_udp_t
;

169 
	ssÿm³r_d—lŸs_´obedef_icmp


171 
ušt16_t
 
	mcsum
;

172 
ušt16_t
 
	mid
;

173 } 
	tsÿm³r_d—lŸs_´obedef_icmp_t
;

175 
	ssÿm³r_d—lŸs_´obedef_tı


177 
ušt16_t
 
	m¥Üt
;

178 
ušt16_t
 
	mdpÜt
;

179 
ušt8_t
 
	mæags
;

180 } 
	tsÿm³r_d—lŸs_´obedef_tı_t
;

182 
	ssÿm³r_d—lŸs_´obedef


184 
sÿm³r_addr_t
 *
	m¤c
;

185 
sÿm³r_addr_t
 *
	md¡
;

186 
ušt32_t
 
	mid
;

187 
ušt8_t
 
	mm‘hod
;

188 
ušt8_t
 
	m‰l
;

189 
ušt8_t
 
	mtos
;

190 
ušt16_t
 
	msize
;

191 
ušt16_t
 
	mmtu
;

194 
sÿm³r_d—lŸs_´obedef_udp_t
 
	mudp
;

195 
sÿm³r_d—lŸs_´obedef_tı_t
 
	mtı
;

196 
sÿm³r_d—lŸs_´obedef_icmp_t
 
	micmp
;

197 } 
	mun
;

198 } 
	tsÿm³r_d—lŸs_´obedef_t
;

200 
	ssÿm³r_d—lŸs_´obe


202 
sÿm³r_d—lŸs_´obedef_t
 *
	mdef
;

203 
ušt32_t
 
	m£q
;

204 
timev®
 
	mtx
;

205 
sÿm³r_d—lŸs_»¶y_t
 **
	m»¶›s
;

206 
ušt16_t
 
	m»¶yc
;

207 
ušt16_t
 
	mid
;

208 } 
	tsÿm³r_d—lŸs_´obe_t
;

210 
	ssÿm³r_d—lŸs_m”ÿtÜ


212 
sÿm³r_d—lŸs_´obedef_t
 
	m´obedef
;

213 
ušt8_t
 
	m©‹m±s
;

214 
ušt8_t
 
	mwa™_timeout
;

215 } 
	tsÿm³r_d—lŸs_m”ÿtÜ_t
;

217 
	ssÿm³r_d—lŸs_®ly


219 
sÿm³r_d—lŸs_´obedef_t
 
	m´obedefs
[2];

220 
ušt16_t
 
	mwa™_´obe
;

221 
ušt8_t
 
	mwa™_timeout
;

222 
ušt8_t
 
	m©‹m±s
;

223 
ušt8_t
 
	mæags
;

224 
ušt16_t
 
	mfudge
;

225 } 
	tsÿm³r_d—lŸs_®ly_t
;

243 
	ssÿm³r_d—lŸs_¿d¬gun


245 
sÿm³r_d—lŸs_´obedef_t
 *
	m´obedefs
;

246 
ušt32_t
 
	m´obedefc
;

247 
ušt16_t
 
	m©‹m±s
;

248 
ušt16_t
 
	mwa™_´obe
;

249 
ušt32_t
 
	mwa™_round
;

250 
ušt8_t
 
	mwa™_timeout
;

251 
ušt8_t
 
	mæags
;

252 } 
	tsÿm³r_d—lŸs_¿d¬gun_t
;

261 
	ssÿm³r_d—lŸs_´efixsÿn


263 
sÿm³r_addr_t
 *
	ma
;

264 
sÿm³r_addr_t
 *
	mb
;

265 
sÿm³r_addr_t
 *
	mab
;

266 
sÿm³r_addr_t
 **
	mxs
;

267 
ušt16_t
 
	mxc
;

268 
ušt8_t
 
	m´efix
;

269 
ušt8_t
 
	m©‹m±s
;

270 
ušt8_t
 
	m»¶yc
;

271 
ušt16_t
 
	mfudge
;

272 
ušt16_t
 
	mwa™_´obe
;

273 
ušt8_t
 
	mwa™_timeout
;

274 
ušt8_t
 
	mæags
;

275 
sÿm³r_d—lŸs_´obedef_t
 *
	m´obedefs
;

276 
ušt16_t
 
	m´obedefc
;

277 } 
	tsÿm³r_d—lŸs_´efixsÿn_t
;

285 
	ssÿm³r_d—lŸs_bump


287 
sÿm³r_d—lŸs_´obedef_t
 
	m´obedefs
[2];

288 
ušt16_t
 
	mwa™_´obe
;

289 
ušt16_t
 
	mbump_lim™
;

290 
ušt8_t
 
	m©‹m±s
;

291 } 
	tsÿm³r_d—lŸs_bump_t
;

293 
	ssÿm³r_d—lŸs


295 
sÿm³r_li¡_t
 *
	mli¡
;

296 
sÿm³r_cyşe_t
 *
	mcyşe
;

297 
ušt32_t
 
	mu£rid
;

298 
timev®
 
	m¡¬t
;

299 
ušt8_t
 
	mm‘hod
;

300 
ušt8_t
 
	m»suÉ
;

301 *
	md©a
;

302 
sÿm³r_d—lŸs_´obe_t
 **
	m´obes
;

303 
ušt32_t
 
	m´obec
;

304 } 
	tsÿm³r_d—lŸs_t
;

306 
sÿm³r_d—lŸs_t
 *
sÿm³r_d—lŸs_®loc
();

307 
sÿm³r_d—lŸs_ä“
(
sÿm³r_d—lŸs_t
 *);

309 
sÿm³r_d—lŸs_´obe_t
 *
sÿm³r_d—lŸs_´obe_®loc
();

310 
sÿm³r_d—lŸs_´obe_ä“
(
sÿm³r_d—lŸs_´obe_t
 *);

312 
sÿm³r_d—lŸs_´obedef_t
 *
sÿm³r_d—lŸs_´obedef_®loc
();

313 
sÿm³r_d—lŸs_´obedef_ä“
(
sÿm³r_d—lŸs_´obedef_t
 *);

315 
sÿm³r_d—lŸs_»¶y_t
 *
sÿm³r_d—lŸs_»¶y_®loc
();

316 
sÿm³r_d—lŸs_»¶y_ä“
(
sÿm³r_d—lŸs_»¶y_t
 *);

317 
ušt32_t
 
sÿm³r_d—lŸs_»¶y_couÁ
(cÚ¡ 
sÿm³r_d—lŸs_t
 *);

319 cÚ¡ *
sÿm³r_d—lŸs_m‘hod_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_t
 *, *, 
size_t
);

320 cÚ¡ *
sÿm³r_d—lŸs_»suÉ_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_t
 *, *, 
size_t
);

321 cÚ¡ *
sÿm³r_d—lŸs_´obedef_m‘hod_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_´obedef_t
 *,

322 *, 
size_t
);

324 
sÿm³r_d—lŸs_´obes_®loc
(
sÿm³r_d—lŸs_t
 *, 
ušt32_t
);

325 
sÿm³r_d—lŸs_»¶›s_®loc
(
sÿm³r_d—lŸs_´obe_t
 *, 
ušt16_t
);

328 
sÿm³r_d—lŸs_´obes_sÜt_tx
(
sÿm³r_d—lŸs_t
 *);

329 
sÿm³r_d—lŸs_´obes_sÜt_£q
(
sÿm³r_d—lŸs_t
 *);

330 
sÿm³r_d—lŸs_´obes_sÜt_def
(
sÿm³r_d—lŸs_t
 *);

332 
sÿm³r_d—lŸs_´obe_add
(
sÿm³r_d—lŸs_t
 *,

333 
sÿm³r_d—lŸs_´obe_t
 *);

334 
sÿm³r_d—lŸs_»¶y_add
(
sÿm³r_d—lŸs_´obe_t
 *,

335 
sÿm³r_d—lŸs_»¶y_t
 *);

337 
sÿm³r_d—lŸs_®ly_®loc
(
sÿm³r_d—lŸs_t
 *);

338 
sÿm³r_d—lŸs_m”ÿtÜ_®loc
(
sÿm³r_d—lŸs_t
 *);

339 
sÿm³r_d—lŸs_¿d¬gun_®loc
(
sÿm³r_d—lŸs_t
 *);

340 
sÿm³r_d—lŸs_´efixsÿn_®loc
(
sÿm³r_d—lŸs_t
 *);

341 
sÿm³r_d—lŸs_bump_®loc
(
sÿm³r_d—lŸs_t
 *);

354 
sÿm³r_d—lŸs_id_š£q
(
sÿm³r_d—lŸs_´obe_t
 **, , 
ušt16_t
, );

356 
sÿm³r_d—lŸs_´efixsÿn_xs_add
(
sÿm³r_d—lŸs_t
 *, 
sÿm³r_addr_t
 *);

357 
sÿm³r_d—lŸs_´efixsÿn_xs_š
(
sÿm³r_d—lŸs_t
 *, 
sÿm³r_addr_t
 *);

358 
sÿm³r_d—lŸs_´efixsÿn_xs_®loc
(
sÿm³r_d—lŸs_´efixsÿn_t
 *,

359 
ušt16_t
);

361 
sÿm³r_d—lŸs_´efixsÿn_´obedef_add
(
sÿm³r_d—lŸs_t
 *,

362 
sÿm³r_d—lŸs_´obedef_t
 *);

364 
sÿm³r_d—lŸs_´efixsÿn_´obedefs_®loc
(
sÿm³r_d—lŸs_´efixsÿn_t
 *,

365 
ušt32_t
);

367 
sÿm³r_d—lŸs_¿d¬gun_fudge
(
sÿm³r_d—lŸs_t
 *,

368 
sÿm³r_d—lŸs_´obedef_t
 *,

369 
sÿm³r_d—lŸs_´obedef_t
 **, *, );

371 
sÿm³r_d—lŸs_¿d¬gun_´obedefs_®loc
(
sÿm³r_d—lŸs_¿d¬gun_t
 *,

372 
ušt32_t
);

374 
	#SCAMPER_DEALIAS_IPID_UNKNOWN
 0

	)

375 
	#SCAMPER_DEALIAS_IPID_ZERO
 1

	)

376 
	#SCAMPER_DEALIAS_IPID_CONST
 2

	)

377 
	#SCAMPER_DEALIAS_IPID_ECHO
 3

	)

378 
	#SCAMPER_DEALIAS_IPID_INCR
 4

	)

380 
	ssÿm³r_d—lŸs_id


382 
ušt8_t
 
	mty³
;

383 
ušt32_t
 
	mmšd
;

384 
ušt32_t
 
	mmaxd
;

385 } 
	tsÿm³r_d—lŸs_id_t
;

387 
sÿm³r_d—lŸs_id
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 **
´obes
,

388 
ušt32_t
 
´obec
, 
sÿm³r_d—lŸs_id_t
 *
id
);

	@dealias/scamper_dealias_do.c

30 #iâdeà
lšt


31 cÚ¡ 
	grcsid
[] =

35 #ifdeà
HAVE_CONFIG_H


36 
	~"cÚfig.h
"

38 
	~"š‹º®.h
"

40 
	~"sÿm³r.h
"

41 
	~"sÿm³r_addr.h
"

42 
	~"sÿm³r_li¡.h
"

43 
	~"sÿm³r_icm³xt.h
"

44 
	~"sÿm³r_d—lŸs.h
"

45 
	~"sÿm³r_sk.h
"

46 
	~"sÿm³r_icmp_»¥.h
"

47 
	~"sÿm³r_fds.h
"

48 
	~"sÿm³r_dl.h
"

49 
	~"sÿm³r_dlhdr.h
"

50 
	~"sÿm³r_¹sock.h
"

51 
	~"sÿm³r_´obe.h
"

52 
	~"sÿm³r_g‘¤c.h
"

53 
	~"sÿm³r_udp4.h
"

54 
	~"sÿm³r_udp6.h
"

55 
	~"sÿm³r_icmp4.h
"

56 
	~"sÿm³r_icmp6.h
"

57 
	~"sÿm³r_queue.h
"

58 
	~"sÿm³r_fe.h
"

59 
	~"sÿm³r_İtiÚs.h
"

60 
	~"sÿm³r_debug.h
"

61 
	~"sÿm³r_d—lŸs_do.h
"

62 
	~"mjl_¥ÏyŒ“.h
"

63 
	~"mjl_li¡.h
"

64 
	~"uts.h
"

66 
sÿm³r_sk_funcs_t
 
	gfuncs
;

69 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

70 
size_t
 
	gpktbuf_Ën
 = 0;

73 
sÿm³r_addrÿche_t
 *
addrÿche
;

75 
	#DEALIAS_OPT_DPORT
 1

	)

76 
	#DEALIAS_OPT_FUDGE
 2

	)

77 
	#DEALIAS_OPT_METHOD
 3

	)

78 
	#DEALIAS_OPT_REPLYC
 4

	)

79 
	#DEALIAS_OPT_OPTION
 5

	)

80 
	#DEALIAS_OPT_PROBEDEF
 6

	)

81 
	#DEALIAS_OPT_ATTEMPTS
 7

	)

82 
	#DEALIAS_OPT_WAIT_ROUND
 8

	)

83 
	#DEALIAS_OPT_SPORT
 9

	)

84 
	#DEALIAS_OPT_TTL
 10

	)

85 
	#DEALIAS_OPT_USERID
 11

	)

86 
	#DEALIAS_OPT_WAIT_TIMEOUT
 12

	)

87 
	#DEALIAS_OPT_WAIT_PROBE
 13

	)

88 
	#DEALIAS_OPT_EXCLUDE
 14

	)

90 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

91 {'d', 
NULL
, 
DEALIAS_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

92 {'f', 
NULL
, 
DEALIAS_OPT_FUDGE
, 
SCAMPER_OPTION_TYPE_NUM
},

93 {'m', 
NULL
, 
DEALIAS_OPT_METHOD
, 
SCAMPER_OPTION_TYPE_STR
},

94 {'o', 
NULL
, 
DEALIAS_OPT_REPLYC
, 
SCAMPER_OPTION_TYPE_NUM
},

95 {'O', 
NULL
, 
DEALIAS_OPT_OPTION
, 
SCAMPER_OPTION_TYPE_STR
},

96 {'p', 
NULL
, 
DEALIAS_OPT_PROBEDEF
, 
SCAMPER_OPTION_TYPE_STR
},

97 {'q', 
NULL
, 
DEALIAS_OPT_ATTEMPTS
, 
SCAMPER_OPTION_TYPE_NUM
},

98 {'r', 
NULL
, 
DEALIAS_OPT_WAIT_ROUND
, 
SCAMPER_OPTION_TYPE_NUM
},

99 {'s', 
NULL
, 
DEALIAS_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

100 {'t', 
NULL
, 
DEALIAS_OPT_TTL
, 
SCAMPER_OPTION_TYPE_NUM
},

101 {'U', 
NULL
, 
DEALIAS_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

102 {'w', 
NULL
, 
DEALIAS_OPT_WAIT_TIMEOUT
, 
SCAMPER_OPTION_TYPE_NUM
},

103 {'W', 
NULL
, 
DEALIAS_OPT_WAIT_PROBE
, 
SCAMPER_OPTION_TYPE_NUM
},

104 {'x', 
NULL
, 
DEALIAS_OPT_EXCLUDE
, 
SCAMPER_OPTION_TYPE_STR
},

106 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

108 
	#DEALIAS_PROBEDEF_OPT_CSUM
 1

	)

109 
	#DEALIAS_PROBEDEF_OPT_DPORT
 2

	)

110 
	#DEALIAS_PROBEDEF_OPT_IP
 3

	)

111 
	#DEALIAS_PROBEDEF_OPT_PROTO
 4

	)

112 
	#DEALIAS_PROBEDEF_OPT_SPORT
 5

	)

113 
	#DEALIAS_PROBEDEF_OPT_TTL
 6

	)

114 
	#DEALIAS_PROBEDEF_OPT_SIZE
 7

	)

115 
	#DEALIAS_PROBEDEF_OPT_MTU
 8

	)

117 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	g´obedef_İts
[] = {

118 {'c', 
NULL
, 
DEALIAS_PROBEDEF_OPT_CSUM
, 
SCAMPER_OPTION_TYPE_STR
},

119 {'d', 
NULL
, 
DEALIAS_PROBEDEF_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

120 {'F', 
NULL
, 
DEALIAS_PROBEDEF_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

121 {'i', 
NULL
, 
DEALIAS_PROBEDEF_OPT_IP
, 
SCAMPER_OPTION_TYPE_STR
},

122 {'P', 
NULL
, 
DEALIAS_PROBEDEF_OPT_PROTO
, 
SCAMPER_OPTION_TYPE_STR
},

123 {'s', 
NULL
, 
DEALIAS_PROBEDEF_OPT_SIZE
, 
SCAMPER_OPTION_TYPE_NUM
},

124 {'t', 
NULL
, 
DEALIAS_PROBEDEF_OPT_TTL
, 
SCAMPER_OPTION_TYPE_NUM
},

125 {'M', 
NULL
, 
DEALIAS_PROBEDEF_OPT_MTU
, 
SCAMPER_OPTION_TYPE_NUM
},

127 cÚ¡ 
	g´obedef_İts_út
 = 
SCAMPER_OPTION_COUNT
(
´obedef_İts
);

129 cÚ¡ *
	$sÿm³r_do_d—lŸs_u§ge
()

136 
	}
}

138 
	sd—lŸs_rg‘


140 
sÿm³r_addr_t
 *
	maddr
;

141 
dli¡_t
 *
	m´obes
;

142 
ušt16_t
 
	mtı_¥Üt
;

143 
ušt16_t
 
	mudp_dpÜt
;

144 } 
	td—lŸs_rg‘_t
;

146 
	sd—lŸs_´obe


148 
d—lŸs_rg‘_t
 *
	mrg‘
;

149 
sÿm³r_d—lŸs_´obe_t
 *
	m´obe
;

150 
ušt16_t
 
	mm©ch_f›ld
;

151 
dli¡_node_t
 *
	mrg‘_node
;

152 } 
	td—lŸs_´obe_t
;

154 
	sd—lŸs_´efixsÿn


156 
sÿm³r_d—lŸs_´obedef_t
 *
	m´obedefs
;

157 
	m´obedefc
;

158 
sÿm³r_addr_t
 **
	m¯lŸ£s
;

159 
	m¯lŸsc
;

160 
	m©‹m±
;

161 
	m£q
;

162 
	mround0
;

163 
	mround
;

164 
	m»¶yc
;

165 } 
	td—lŸs_´efixsÿn_t
;

167 
	sd—lŸs_¿d¬gun


169 
ušt32_t
 *
	mÜd”
;

170 
ušt32_t
 
	mi
;

171 
timev®
 
	mÃxt_round
;

172 } 
	td—lŸs_¿d¬gun_t
;

174 
	sd—lŸs_bump


176 
ušt8_t
 
	m¡•
;

177 
ušt8_t
 
	m©‹m±
;

178 
ušt16_t
 
	mbump
;

179 } 
	td—lŸs_bump_t
;

181 
	sd—lŸs_İtiÚs


183 *
	maddr
;

184 
ušt8_t
 
	m©‹m±s
;

185 
ušt8_t
 
	m»¶yc
;

186 
ušt8_t
 
	mwa™_timeout
;

187 
ušt16_t
 
	mwa™_´obe
;

188 
ušt32_t
 
	mwa™_round
;

189 
ušt16_t
 
	m¥Üt
;

190 
ušt16_t
 
	mdpÜt
;

191 
ušt8_t
 
	m‰l
;

192 
ušt16_t
 
	mfudge
;

193 **
	m´obedefs
;

194 
ušt32_t
 
	m´obedefc
;

195 **
	mxs
;

196 
	mxc
;

197 
	mnobs
;

198 
	mshufæe
;

199 
	mš£q
;

200 } 
	td—lŸs_İtiÚs_t
;

202 
	sd—lŸs_´obedef


204 
sÿm³r_d—lŸs_´obedef_t
 *
	mdef
;

205 
d—lŸs_rg‘_t
 *
	mrg‘
;

206 
ušt32_t
 
	mtı_£q
;

207 
ušt32_t
 
	mtı_ack
;

208 
ušt16_t
 
	mpktbuf_Ën
;

209 
ušt8_t
 
	mæags
;

210 } 
	td—lŸs_´obedef_t
;

212 
	sd—lŸs_±b


214 
sÿm³r_d—lŸs_´obedef_t
 *
	mdef
;

215 
ušt8_t
 *
	mquÙe
;

216 
ušt16_t
 
	mquÙe_Ën
;

217 } 
	td—lŸs_±b_t
;

219 
	sd—lŸs_¡©e


221 
ušt8_t
 
	mid
;

222 
ušt8_t
 
	mæags
;

223 
ušt16_t
 
	micmp£q
;

224 
sÿm³r_d—lŸs_´obedef_t
 *
	m´obedefs
;

225 
ušt32_t
 
	m´obedefc
;

226 
d—lŸs_´obedef_t
 **
	mpds
;

227 
	mpdc
;

228 
ušt32_t
 
	m´obe
;

229 
ušt32_t
 
	mround
;

230 
timev®
 
	mÏ¡_tx
;

231 
timev®
 
	mÃxt_tx
;

232 
timev®
 
	m±b_tx
;

233 
d—lŸs_rg‘_t
 **
	mrg‘s
;

234 
	mrg‘c
;

235 
dli¡_t
 *
	m»ûÁ_´obes
;

236 *
	mm‘hod¡©e
;

237 
¦i¡_t
 *
	m±bq
;

238 
¦i¡_t
 *
	mdisÿrd
;

239 } 
	td—lŸs_¡©e_t
;

241 
	#DEALIAS_STATE_FLAG_DL
 0x01

	)

243 
	#DEALIAS_PROBEDEF_FLAG_RX_IPID
 0x01

	)

244 
	#DEALIAS_PROBEDEF_FLAG_TX_PTB
 0x02

	)

246 #ifdeà
NDEBUG


247 
	#d—lŸs_¡©e_as£¹
(
¡©e
è(()0)

	)

250 #iâdeà
NDEBUG


251 
	$d—lŸs_¡©e_as£¹
(cÚ¡ 
d—lŸs_¡©e_t
 *
¡©e
)

254 
i
;

255 
i
=0; i<
¡©e
->
pdc
; i++)

257 
	`as£¹
(
¡©e
->
pds
[
i
] !ğ
NULL
);

258 
	`as£¹
(
¡©e
->
pds
[
i
]->
def
->
id
 == i);

261 
	}
}

264 
sÿm³r_d—lŸs_t
 *
	$d—lŸs_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

266  
	`sÿm³r_sk_g‘d©a
(
sk
);

267 
	}
}

269 
d—lŸs_¡©e_t
 *
	$d—lŸs_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

271 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`sÿm³r_sk_g‘¡©e
(
sk
);

272 
	`d—lŸs_¡©e_as£¹
(
¡©e
);

273  
¡©e
;

274 
	}
}

276 
	$d—lŸs_®ly_queue
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
,

277 
d—lŸs_¡©e_t
 *
¡©e
,

278 cÚ¡ 
timev®
 *
now
, timev® *
tv
)

280 if(
¡©e
->
±b_tx
.
tv_£c
 == 0)

282 
	`timev®_add_s
(
tv
, &
¡©e
->
±b_tx
, 1);

283 if(
	`timev®_cmp
(
tv
, 
now
) > 0)

285 
	`mem£t
(&
¡©e
->
±b_tx
, 0, (
timev®
));

287 
	}
}

289 
	$d—lŸs_queue
(
sÿm³r_sk_t
 *
sk
)

291 (*cÚ¡ 
func
[])(cÚ¡ 
sÿm³r_d—lŸs_t
 *, 
d—lŸs_¡©e_t
 *,

292 cÚ¡ 
timev®
 *, timeval *) = {

293 
NULL
,

294 
d—lŸs_®ly_queue
,

295 
NULL
,

296 
NULL
,

297 
NULL
,

299 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

300 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

301 
timev®
 
tv
, 
now
;

302 
d—lŸs_´obe_t
 *
p
;

304 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

307 
	`g‘timeofday_w¿p
(&
now
);

311 if((
p
 = 
	`dli¡_h—d_g‘
(
¡©e
->
»ûÁ_´obes
)è=ğ
NULL
)

313 
	`timev®_add_s
(&
tv
, &
p
->
´obe
->
tx
, 10);

314 if(
	`timev®_cmp
(&
now
, &
tv
) < 0)

316 
	`dli¡_node_pİ
(
p
->
rg‘
->
´obes
,…->
rg‘_node
);

317 
	`dli¡_h—d_pİ
(
¡©e
->
»ûÁ_´obes
);

318 
	`ä“
(
p
);

321 if(
	`¦i¡_couÁ
(
¡©e
->
±bq
) > 0)

323 
	`sÿm³r_sk_queue_´obe
(
sk
);

327 if(
func
[
d—lŸs
->
m‘hod
-1] !ğ
NULL
 &&

328 
func
[
d—lŸs
->
m‘hod
-1](d—lŸs, 
¡©e
, &
now
, &
tv
) != 0)

330 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
tv
);

334 if(
	`timev®_cmp
(&
¡©e
->
Ãxt_tx
, &
now
) <= 0)

336 
	`sÿm³r_sk_queue_´obe
(
sk
);

340 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
¡©e
->
Ãxt_tx
);

342 
	}
}

344 
	$d—lŸs_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

346 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

348 
	}
}

350 
	$d—lŸs_»suÉ
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
»suÉ
)

352 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

353 
buf
[16];

354 
d—lŸs
->
»suÉ
 =„esult;

355 
	`sÿm³r_debug
(
__func__
, "%s",

356 
	`sÿm³r_d—lŸs_»suÉ_to¡r
(
d—lŸs
, 
buf
, (buf)));

357 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

359 
	}
}

361 
	$d—lŸs_±b_ä“
(
d—lŸs_±b_t
 *
±b
)

363 if(
±b
 =ğ
NULL
)

365 if(
±b
->
quÙe
 !ğ
NULL
)

366 
	`ä“
(
±b
->
quÙe
);

367 
	`ä“
(
±b
);

369 
	}
}

371 
	$d—lŸs_±b_add
(
d—lŸs_¡©e_t
 *
¡©e
, 
sÿm³r_dl_»c_t
 *
dl
,

372 
sÿm³r_d—lŸs_´obedef_t
 *
def
)

374 
d—lŸs_±b_t
 *
±b
;

376 if((
±b
 = 
	`m®loc_z”o
((
d—lŸs_±b_t
))è=ğ
NULL
)

378 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…tb");

379 
”r
;

381 
±b
->
def
 = def;

382 if(
dl
->
dl__size
 > 1280-40-8)

383 
±b
->
quÙe_Ën
 = 1280-40-8;

385 
±b
->
quÙe_Ën
 = 
dl
->
dl__size
;

386 if((
±b
->
quÙe
 = 
	`memdup
(
dl
->
dl_Ãt_¿w
,…tb->
quÙe_Ën
)è=ğ
NULL
)

388 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot dup…tb quote");

389 
”r
;

392 if(
	`¦i¡__push
(
¡©e
->
±bq
, 
±b
è=ğ
NULL
)

394 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot queue…tb");

395 
”r
;

399 
”r
:

400 if(
±b
 !ğ
NULL
è
	`d—lŸs_±b_ä“
(ptb);

402 
	}
}

404 
	$d—lŸs_rg‘_cmp
(cÚ¡ 
d—lŸs_rg‘_t
 *
a
,

405 cÚ¡ 
d—lŸs_rg‘_t
 *
b
)

407  
	`sÿm³r_addr_cmp
(
a
->
addr
, 
b
->addr);

408 
	}
}

410 
	$d—lŸs_rg‘_ä“
(
d—lŸs_rg‘_t
 *
tgt
)

412 
d—lŸs_´obe_t
 *
p
;

414 if(
tgt
 =ğ
NULL
)

416 if(
tgt
->
´obes
 !ğ
NULL
)

418 (
p
 = 
	`dli¡_h—d_pİ
(
tgt
->
´obes
)è!ğ
NULL
)

419 
	`ä“
(
p
);

420 
	`dli¡_ä“
(
tgt
->
´obes
);

422 if(
tgt
->
addr
 !ğ
NULL
)

423 
	`sÿm³r_addr_ä“
(
tgt
->
addr
);

424 
	`ä“
(
tgt
);

426 
	}
}

428 
d—lŸs_rg‘_t
 *
	$d—lŸs_rg‘_fšd
(
d—lŸs_¡©e_t
 *
s
,

429 
sÿm³r_addr_t
 *
addr
)

431 
d—lŸs_rg‘_t
 
fm
;

432 
fm
.
addr
 =‡ddr;

433  
	`¬¿y_fšd
((**)
s
->
rg‘s
, s->
rg‘c
, &
fm
,

434 (
¬¿y_cmp_t
)
d—lŸs_rg‘_cmp
);

435 
	}
}

437 
d—lŸs_rg‘_t
 *
	$d—lŸs_rg‘_g‘
(
d—lŸs_¡©e_t
 *
¡©e
,

438 
sÿm³r_addr_t
 *
addr
)

440 
d—lŸs_rg‘_t
 *
tgt
;

441 if((
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, 
addr
)è!ğ
NULL
)

442  
tgt
;

443 if((
tgt
 = 
	`m®loc_z”o
((
d—lŸs_rg‘_t
))è=ğ
NULL
 ||

444 (
tgt
->
´obes
 = 
	`dli¡_®loc
()è=ğ
NULL
)

446 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot mallocgt");

447 
”r
;

449 
tgt
->
addr
 = 
	`sÿm³r_addr_u£
(addr);

450 if(
	`¬¿y_š£¹
((***)&
¡©e
->
rg‘s
, &¡©e->
rg‘c
, 
tgt
,

451 (
¬¿y_cmp_t
)
d—lŸs_rg‘_cmp
) != 0)

453 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡ddgto‡rray");

454 
”r
;

456  
tgt
;

458 
”r
:

459 
	`d—lŸs_rg‘_ä“
(
tgt
);

460  
NULL
;

461 
	}
}

463 
	$d—lŸs_´obedef_add
(
d—lŸs_¡©e_t
 *
¡©e
,

464 
sÿm³r_d—lŸs_´obedef_t
 *
def
)

466 
d—lŸs_´obedef_t
 *
pd
 = 
NULL
;

468 if((
pd
 = 
	`m®loc_z”o
((
d—lŸs_´obedef_t
))è=ğ
NULL
)

470 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…d");

471 
”r
;

473 
pd
->
def
 = def;

474 if((
pd
->
rg‘
 = 
	`d—lŸs_rg‘_g‘
(
¡©e
, 
def
->
d¡
)è=ğ
NULL
)

475 
”r
;

477 if(
def
->
size
 == 0)

478 
pd
->
pktbuf_Ën
 = 2;

479 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
)

480 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
def
->
d¡
))

481 
pd
->
pktbuf_Ën
 = 
def
->
size
 - 28;

483 
pd
->
pktbuf_Ën
 = 
def
->
size
 - 48;

485 
”r
;

487 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
 &&

488 (
	`¿ndom_u32
(&
pd
->
tı_£q
è!ğ0 ||„ªdom_u32(&pd->
tı_ack
) != 0))

489 
”r
;

491 if(
	`¬¿y_š£¹
((***)&
¡©e
->
pds
, &¡©e->
pdc
, 
pd
, 
NULL
) != 0)

493 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…d");

494 
”r
;

499 
”r
:

500 if(
pd
 !ğ
NULL
è
	`ä“
(pd);

502 
	}
}

504 
	$d—lŸs_´efixsÿn_¬¿y_ä“
(
sÿm³r_addr_t
 **
addrs
, 
addrc
)

506 
i
;

508 if(
addrs
 =ğ
NULL
)

511 
i
=0; i<
addrc
; i++)

512 if(
addrs
[
i
] !ğ
NULL
)

513 
	`sÿm³r_addr_ä“
(
addrs
[
i
]);

515 
	`ä“
(
addrs
);

517 
	}
}

519 
	$d—lŸs_´efixsÿn_¬¿y_add
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

520 
sÿm³r_addr_t
 ***
out
, *
outc
,

521 
š_addr
 *
addr
)

523 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

524 
sÿm³r_addr_t
 **
¬¿y
 = *
out
;

525 
sÿm³r_addr_t
 *
§
;

528 
§
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_IPV4
, 
addr
);

529 if(
§
 =ğ
NULL
)

531 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get‡ddr");

539 if(
	`sÿm³r_addr_cmp
(
´efixsÿn
->
a
, 
§
) == 0 ||

540 
	`sÿm³r_d—lŸs_´efixsÿn_xs_š
(
d—lŸs
, 
§
) != 0)

542 
	`sÿm³r_addr_ä“
(
§
);

547 if(
	`¬¿y_š£¹
((***)&
¬¿y
, 
outc
, 
§
, 
NULL
) != 0)

549 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‡ddr");

550 
	`sÿm³r_addr_ä“
(
§
);

554 *
out
 = 
¬¿y
;

556 
	}
}

584 
	$d—lŸs_´efixsÿn_¬¿y
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

585 
sÿm³r_addr_t
 ***
out
, *
outc
)

587 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

588 
sÿm³r_addr_t
 **
¬¿y
 = 
NULL
;

589 
ušt32_t
 
ho¡id
, 
Ãtid
, 
mask
;

590 
ušt32_t
 
¦ash30
[4][3] = {{1, 2, 3}, {2, 0, 3}, {1, 0, 3}, {2, 1, 0}};

591 
ušt32_t
 
út
[] = {4, 8, 16, 32, 64, 128};

592 
ušt32_t
 
b™
;

593 
š_addr
 
a
;

594 
´e
, 
i
;

596 
	`memıy
(&
a
, 
´efixsÿn
->
b
->
addr
, (a));

597 *
outc
 = 0;

600 if(
´efixsÿn
->
´efix
 == 31)

602 
Ãtid
 = 
	`Áohl
(
a
.
s_addr
) & ~0x1;

603 
ho¡id
 = 
	`Áohl
(
a
.
s_addr
) & 0x1;

605 if(
ho¡id
 == 1)

606 
a
.
s_addr
 = 
	`htÚl
(
Ãtid
 | 0);

608 
a
.
s_addr
 = 
	`htÚl
(
Ãtid
 | 1);

610 if(
	`d—lŸs_´efixsÿn_¬¿y_add
(
d—lŸs
, &
¬¿y
, 
outc
, &
a
) != 0)

611 
”r
;

613 *
out
 = 
¬¿y
;

618 
mask
 = 0x3;

619 
Ãtid
 = 
	`Áohl
(
a
.
s_addr
è& ~
mask
;

620 
ho¡id
 = 
	`Áohl
(
a
.
s_addr
è& 
mask
;

621 
i
=0; i<3; i++)

623 
a
.
s_addr
 = 
	`htÚl
(
Ãtid
 | 
¦ash30
[
ho¡id
][
i
]);

624 if(
	`d—lŸs_´efixsÿn_¬¿y_add
(
d—lŸs
, &
¬¿y
, 
outc
, &
a
) != 0)

625 
”r
;

628 
´e
 = 29;…» >ğ
´efixsÿn
->
´efix
;…re--)

630 
b™
 = (0x1 << (31-
´e
));

631 
mask
 |ğ
b™
;

633 
	`memıy
(&
a
, 
´efixsÿn
->
b
->
addr
, (a));

634 
Ãtid
 = 
	`Áohl
(
a
.
s_addr
è& ~
mask
;

636 if((
	`Áohl
(
a
.
s_addr
è& 
b™
) != 0)

637 
b™
 = 0;

639 
ho¡id
=0; ho¡id<
út
[29-
´e
]; hostid++)

641 
a
.
s_addr
 = 
	`htÚl
(
Ãtid
 | 
b™
 | 
ho¡id
);

642 if(
	`d—lŸs_´efixsÿn_¬¿y_add
(
d—lŸs
, &
¬¿y
, 
outc
, &
a
) != 0)

643 
”r
;

647 *
out
 = 
¬¿y
;

650 
”r
:

651 
	`d—lŸs_´efixsÿn_¬¿y_ä“
(
¬¿y
, *
outc
);

653 
	}
}

655 
sÿm³r_d—lŸs_´obe_t
 *

656 
	$d—lŸs_´obe_udp_fšd
(
d—lŸs_¡©e_t
 *
¡©e
, 
d—lŸs_rg‘_t
 *
tgt
,

657 
ušt16_t
 
id
, ušt16_ˆ
¥Üt
, ušt16_ˆ
dpÜt
)

659 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

660 
d—lŸs_´obe_t
 *
dp
;

661 
dli¡_node_t
 *
n
;

663 
n
=
	`dli¡_h—d_node
(
tgt
->
´obes
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

665 
dp
 = 
	`dli¡_node_™em
(
n
); 
def
 = dp->
´obe
->def;

666 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
def
) == 0 ||

667 
def
->
un
.
udp
.
¥Üt
 != sport)

669 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tgt
->
addr
è&& 
dp
->
´obe
->
id
 != ipid)

672 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
)

674 if(
def
->
un
.
udp
.
dpÜt
 == dport)

675  
dp
->
´obe
;

677 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
)

679 if(
dp
->
m©ch_f›ld
 =ğ
dpÜt
)

680  
dp
->
´obe
;

684  
NULL
;

685 
	}
}

687 
sÿm³r_d—lŸs_´obe_t
 *

688 
	$d—lŸs_´obe_tı_fšd2
(
d—lŸs_¡©e_t
 *
¡©e
, 
d—lŸs_rg‘_t
 *
tgt
,

689 
ušt16_t
 
¥Üt
, ušt16_ˆ
dpÜt
)

691 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

692 
d—lŸs_´obe_t
 *
dp
;

693 
dli¡_node_t
 *
n
;

695 
n
=
	`dli¡_h—d_node
(
tgt
->
´obes
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

697 
dp
 = 
	`dli¡_node_™em
(
n
); 
def
 = dp->
´obe
->def;

698 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
) == 0 ||

699 
def
->
un
.
tı
.
dpÜt
 != dport)

702 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
)

704 if(
def
->
un
.
tı
.
¥Üt
 == sport)

705  
dp
->
´obe
;

707 if(
	`SCAMPER_DEALIAS_PROBEDEF_VARY_TCP_SPORT
(
def
))

709 if(
dp
->
m©ch_f›ld
 =ğ
¥Üt
)

710  
dp
->
´obe
;

714  
NULL
;

715 
	}
}

717 
sÿm³r_d—lŸs_´obe_t
 *

718 
	$d—lŸs_´obe_tı_fšd
(
d—lŸs_¡©e_t
 *
¡©e
, 
d—lŸs_rg‘_t
 *
tgt
,

719 
ušt16_t
 
id
, ušt16_ˆ
¥Üt
, ušt16_ˆ
dpÜt
)

721 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

722 
d—lŸs_´obe_t
 *
dp
;

723 
dli¡_node_t
 *
n
;

725 
n
=
	`dli¡_h—d_node
(
tgt
->
´obes
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

727 
dp
 = 
	`dli¡_node_™em
(
n
); 
def
 = dp->
´obe
->def;

728 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
) == 0 ||

729 
def
->
un
.
tı
.
dpÜt
 != dport)

731 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tgt
->
addr
è&& 
dp
->
´obe
->
id
 != ipid)

734 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
)

736 if(
def
->
un
.
tı
.
¥Üt
 == sport)

737  
dp
->
´obe
;

739 if(
	`SCAMPER_DEALIAS_PROBEDEF_VARY_TCP_SPORT
(
def
))

741 if(
dp
->
m©ch_f›ld
 =ğ
¥Üt
)

742  
dp
->
´obe
;

746  
NULL
;

747 
	}
}

749 
sÿm³r_d—lŸs_´obe_t
 *

750 
	$d—lŸs_´obe_icmp_fšd
(
d—lŸs_¡©e_t
 *
¡©e
, 
d—lŸs_rg‘_t
 *
tgt
,

751 
ušt16_t
 
id
, 
ušt8_t
 
ty³
, ušt8_ˆ
code
,

752 
ušt16_t
 
id
, ušt16_ˆ
£q
)

754 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

755 
d—lŸs_´obe_t
 *
dp
;

756 
dli¡_node_t
 *
n
;

757 
ušt8_t
 
m‘hod
;

759 if((
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tgt
->
addr
) &&

760 
ty³
 =ğ
ICMP_ECHO
 && 
code
 == 0) ||

761 (
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
tgt
->
addr
) &&

762 
ty³
 =ğ
ICMP6_ECHO_REQUEST
 && 
code
 == 0))

763 
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
;

765  
NULL
;

767 
n
=
	`dli¡_h—d_node
(
tgt
->
´obes
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

769 
dp
 = 
	`dli¡_node_™em
(
n
); 
def
 = dp->
´obe
->def;

770 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tgt
->
addr
è&& 
dp
->
´obe
->
id
 != ipid)

772 if(
def
->
m‘hod
 == method &&

773 
def
->
un
.
icmp
.
id
 =ğid && 
dp
->
m©ch_f›ld
 =ğ
£q
)

774  
dp
->
´obe
;

777  
NULL
;

778 
	}
}

780 
sÿm³r_d—lŸs_´obe_t
 *

781 
	$d—lŸs_´obe_echÜeq_fšd
(
d—lŸs_¡©e_t
 *
¡©e
, 
d—lŸs_rg‘_t
 *
tgt
,

782 
ušt16_t
 
id
, ušt16_ˆ
£q
)

784 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

785 
d—lŸs_´obe_t
 *
dp
;

786 
dli¡_node_t
 *
n
;

788 
n
=
	`dli¡_h—d_node
(
tgt
->
´obes
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

790 
dp
 = 
	`dli¡_node_™em
(
n
); 
def
 = dp->
´obe
->def;

791 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
 &&

792 
def
->
un
.
icmp
.
id
 =ğid && 
dp
->
m©ch_f›ld
 =ğ
£q
)

793  
dp
->
´obe
;

796  
NULL
;

797 
	}
}

799 
d—lŸs_´obedef_t
 *

800 
	$d—lŸs_m”ÿtÜ_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
d—lŸs_¡©e_t
 *
¡©e
)

802  
¡©e
->
pds
[¡©e->
´obe
];

803 
	}
}

805 
	$d—lŸs_m”ÿtÜ_po¡´obe
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

806 
d—lŸs_¡©e_t
 *
¡©e
)

809 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
 = 
d—lŸs
->
d©a
;

810 
	`timev®_add_s
(&
¡©e
->
Ãxt_tx
, &¡©e->
Ï¡_tx
, 
m”ÿtÜ
->
wa™_timeout
);

811 
¡©e
->
round
++;

813 
	}
}

815 
	$d—lŸs_m”ÿtÜ_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
,

816 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

817 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

818 
sÿm³r_dl_»c_t
 *
dl
)

820 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
) &&

821 
	`sÿm³r_addr_cmp
(
´obe
->
def
->
d¡
, 
»¶y
->
¤c
) != 0)

823 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

827 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

830 
	}
}

832 
	$d—lŸs_m”ÿtÜ_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

834 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

835 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
 = 
d—lŸs
->
d©a
;

837 if(
d—lŸs
->
´obec
 < 
m”ÿtÜ
->
©‹m±s
)

838 
	`d—lŸs_queue
(
sk
);

840 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

843 
	}
}

845 
d—lŸs_´obedef_t
 *

846 
	$d—lŸs_®ly_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
d—lŸs_¡©e_t
 *
¡©e
)

848  
¡©e
->
pds
[¡©e->
´obe
];

849 
	}
}

851 
	$d—lŸs_®ly_po¡´obe
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

852 
d—lŸs_¡©e_t
 *
¡©e
)

859 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
d—lŸs
->
d©a
;

860 if(
d—lŸs
->
´obec
 !ğ
®ly
->
©‹m±s
)

861 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, &¡©e->
Ï¡_tx
, 
®ly
->
wa™_´obe
);

863 
	`timev®_add_s
(&
¡©e
->
Ãxt_tx
, &¡©e->
Ï¡_tx
, 
®ly
->
wa™_timeout
);

864 if(++
¡©e
->
´obe
 == 2)

866 
¡©e
->
´obe
 = 0;

867 
¡©e
->
round
++;

870 
	}
}

872 
	$d—lŸs_®ly_®lz”o
(
sÿm³r_d—lŸs_t
 *
d—lŸs
)

874 
ušt32_t
 
i
;

875 
ušt16_t
 
j
;

877 if(
d—lŸs
->
´obec
 == 0)

879 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
d—lŸs
->
´obes
[0]->
def
->
d¡
) == 0)

882 
i
=0; i<
d—lŸs
->
´obec
; i++)

884 
	`as£¹
(
d—lŸs
->
´obes
[
i
] !ğ
NULL
);

885 
j
=0; j<
d—lŸs
->
´obes
[
i
]->
»¶yc
; j++)

887 
	`as£¹
(
d—lŸs
->
´obes
[
i
]->
»¶›s
[
j
] !ğ
NULL
);

888 if(
d—lŸs
->
´obes
[
i
]->
»¶›s
[
j
]->
id
 != 0)

894 
	}
}

905 
	$d—lŸs_®ly_hªdË»¶y_v6
(
sÿm³r_sk_t
 *
sk
,

906 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

907 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

908 
sÿm³r_dl_»c_t
 *
dl
)

910 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

911 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

912 
d—lŸs_´obedef_t
 *
pd
 = 
¡©e
->
pds
[
´obe
->
def
->
id
];

913 
¦i¡_node_t
 *
¢
;

914 
±b
 = 0, 
disÿrd
 = 0;

915 
ušt32_t
 
i
;

918 if(
¡©e
->
±b_tx
.
tv_£c
 !ğ0 || 
	`¦i¡_couÁ
(¡©e->
±bq
) > 0)

919 
±b
 = 1;

922 
¢
=
	`¦i¡_h—d_node
(
¡©e
->
disÿrd
); sÀ!ğ
NULL
; sn=
	`¦i¡_node_Ãxt
(sn))

924 if(
	`¦i¡_node_™em
(
¢
è=ğ
´obe
)

926 
disÿrd
 = 1;

932 if((
»¶y
->
æags
 & 
SCAMPER_DEALIAS_REPLY_FLAG_IPID32
) != 0)

934 
pd
->
æags
 |ğ
DEALIAS_PROBEDEF_FLAG_RX_IPID
;

935  (
disÿrd
 =ğ0 && 
±b
 == 0) ? 1 : 0;

939 if(
´obe
->
def
->
mtu
 !ğ0 &&…robe->def->mtu < 
dl
->
dl__size
 &&

940 (
pd
->
æags
 & 
DEALIAS_PROBEDEF_FLAG_TX_PTB
) == 0 &&

941 (
pd
->
æags
 & 
DEALIAS_PROBEDEF_FLAG_RX_IPID
) == 0)

944 
i
=0; i<
d—lŸs
->
´obec
; i++)

946 if(
	`¦i¡_h—d_push
(
¡©e
->
disÿrd
, 
d—lŸs
->
´obes
[
i
]è=ğ
NULL
)

948 
d—lŸs
->
´obes
[
i
] = 
NULL
;

950 
d—lŸs
->
´obec
 = 0;

951 
¡©e
->
round
 = 0;

954 
pd
->
æags
 |ğ
DEALIAS_PROBEDEF_FLAG_TX_PTB
;

955 if(
	`d—lŸs_±b_add
(
¡©e
, 
dl
, 
´obe
->
def
) != 0)

957 
	`d—lŸs_queue
(
sk
);

962 if(
±b
 =ğ0 && 
disÿrd
 == 0)

963 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

966 
	}
}

968 
	$d—lŸs_®ly_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
,

969 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

970 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

971 
sÿm³r_dl_»c_t
 *
dl
)

973 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

974 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
d—lŸs
->
d©a
;

975 
sÿm³r_d—lŸs_´obe_t
 *
´obes
[5];

976 
ušt32_t
 
k
;

977 
rc
, 
´obec
 = 0;

980 if(
´obe
->
»¶yc
 != 1 ||

981 !(
	`SCAMPER_DEALIAS_REPLY_FROM_TARGET
(
´obe
, 
»¶y
) ||

982 (
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) &&

983 
´obe
->
def
->
‰l
 != 255)))

985 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

989 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
»¶y
->
¤c
))

991 
rc
 = 
	`d—lŸs_®ly_hªdË»¶y_v6
(
sk
, 
´obe
, 
»¶y
, 
dl
);

992 if(
rc
 =ğ-1è
”r
;

993 if(
rc
 == 0) ;

997 if(
d—lŸs
->
´obec
 < 2)

1001 
k
=0; k<
d—lŸs
->
´obec
; k++)

1002 if(
´obe
 =ğ
d—lŸs
->
´obes
[
k
])

1004 if(
k
 =ğ
d—lŸs
->
´obec
)

1007 if(
k
 >ğ1 && 
d—lŸs
->
´obes
[k-1]->
»¶yc
 == 1)

1009 if(
k
 >ğ2 && 
d—lŸs
->
´obes
[k-2]->
»¶yc
 == 1)

1010 
´obes
[
´obec
++] = 
d—lŸs
->´obes[
k
-2];

1011 
´obes
[
´obec
++] = 
d—lŸs
->´obes[
k
-1];

1013 
´obes
[
´obec
++] = 
d—lŸs
->´obes[
k
];

1014 if(
k
+1 < 
d—lŸs
->
´obec
 && d—lŸs->
´obes
[k+1]->
»¶yc
 == 1)

1016 
´obes
[
´obec
++] = 
d—lŸs
->´obes[
k
+1];

1017 if(
k
+2 < 
d—lŸs
->
´obec
 && d—lŸs->
´obes
[k+2]->
»¶yc
 == 1)

1018 
´obes
[
´obec
++] = 
d—lŸs
->´obes[
k
+2];

1022 if(
´obec
 < 2)

1026 if(
	`SCAMPER_DEALIAS_ALLY_IS_NOBS
(
d—lŸs
))

1027 
rc
 = 
	`sÿm³r_d—lŸs_id_š£q
(
´obes
, 
´obec
, 
®ly
->
fudge
, 0);

1029 
rc
 = 
	`sÿm³r_d—lŸs_id_š£q
(
´obes
, 
´obec
, 
®ly
->
fudge
, 2);

1030 if(
rc
 == 0)

1031 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NOTALIASES
);

1035 
”r
:

1036 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1038 
	}
}

1040 
	$d—lŸs_®ly_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

1042 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1043 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
d—lŸs
->
d©a
;

1044 
ušt32_t
 
k
;

1045 
rc
;

1048 if(
d—lŸs
->
´obec
 =ğ
®ly
->
©‹m±s
)

1050 
k
=0; k<
d—lŸs
->
´obec
; k++)

1051 if(
d—lŸs
->
´obes
[
k
]->
»¶yc
 != 1)

1054 if(
k
 !ğ
d—lŸs
->
´obec
)

1056 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1060 if(
	`SCAMPER_DEALIAS_ALLY_IS_NOBS
(
d—lŸs
))

1061 
rc
 = 
	`sÿm³r_d—lŸs_id_š£q
(
d—lŸs
->
´obes
, 
k
, 
®ly
->
fudge
, 0);

1063 
rc
 = 
	`sÿm³r_d—lŸs_id_š£q
(
d—lŸs
->
´obes
, 
k
, 
®ly
->
fudge
, 3);

1066 if(
rc
 == 1)

1067 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

1068 if(
	`d—lŸs_®ly_®lz”o
(
d—lŸs
) != 0)

1069 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1071 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NOTALIASES
);

1075 
	}
}

1077 
d—lŸs_´obedef_t
 *

1078 
	$d—lŸs_¿d¬gun_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
d—lŸs_¡©e_t
 *
¡©e
)

1080 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
 = 
d—lŸs
->
d©a
;

1081 
d—lŸs_¿d¬gun_t
 *
rg¡©e
 = 
¡©e
->
m‘hod¡©e
;

1082 if((
rg
->
æags
 & 
SCAMPER_DEALIAS_RADARGUN_FLAG_SHUFFLE
) == 0)

1083  
¡©e
->
pds
[¡©e->
´obe
];

1084  
¡©e
->
pds
[
rg¡©e
->
Üd”
[rg¡©e->
i
++]];

1085 
	}
}

1087 
	$d—lŸs_¿d¬gun_po¡´obe
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1088 
d—lŸs_¡©e_t
 *
¡©e
)

1090 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
 = 
d—lŸs
->
d©a
;

1091 
d—lŸs_¿d¬gun_t
 *
rg¡©e
 = 
¡©e
->
m‘hod¡©e
;

1092 
timev®
 *
tv
 = &
¡©e
->
Ï¡_tx
;

1094 if(
¡©e
->
´obe
 == 0)

1095 
	`timev®_add_ms
(&
rg¡©e
->
Ãxt_round
, 
tv
, 
rg
->
wa™_round
);

1097 
¡©e
->
´obe
++;

1099 if(
¡©e
->
´obe
 < 
rg
->
´obedefc
)

1101 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, 
tv
, 
rg
->
wa™_´obe
);

1105 
¡©e
->
´obe
 = 0;

1106 
¡©e
->
round
++;

1108 if(
¡©e
->
round
 < 
rg
->
©‹m±s
)

1110 if(
	`timev®_cmp
(
tv
, &
rg¡©e
->
Ãxt_round
) >= 0 ||

1111 
	`timev®_diff_ms
(&
rg¡©e
->
Ãxt_round
, 
tv
è< 
rg
->
wa™_´obe
)

1113 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, 
tv
, 
rg
->
wa™_´obe
);

1117 
	`timev®_ıy
(&
¡©e
->
Ãxt_tx
, &
rg¡©e
->
Ãxt_round
);

1120 if((
rg
->
æags
 & 
SCAMPER_DEALIAS_RADARGUN_FLAG_SHUFFLE
) != 0)

1122 if(
	`shufæe32
(
rg¡©e
->
Üd”
, 
rg
->
´obedefc
) != 0)

1124 
rg¡©e
->
i
 = 0;

1130 
	`timev®_add_s
(&
¡©e
->
Ãxt_tx
, 
tv
, 
rg
->
wa™_timeout
);

1134 
	}
}

1136 
	$d—lŸs_¿d¬gun_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

1138 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1139 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1140 
sÿm³r_d—lŸs_¿d¬gun_t
 *
¿d¬gun
 = 
d—lŸs
->
d©a
;

1143 if(
¡©e
->
round
 !ğ
¿d¬gun
->
©‹m±s
)

1144 
	`d—lŸs_queue
(
sk
);

1146 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1149 
	}
}

1151 
	$d—lŸs_¿d¬gun_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
,

1152 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1153 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1154 
sÿm³r_dl_»c_t
 *
dl
)

1156 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1157 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
´obe
->
def
->
d¡
) &&

1158 (
»¶y
->
æags
 & 
SCAMPER_DEALIAS_REPLY_FLAG_IPID32
) == 0 &&

1159 
´obe
->
def
->
mtu
 !ğ0 &&…robe->def->mtu < 
dl
->
dl__size
)

1161 if(
	`d—lŸs_±b_add
(
¡©e
, 
dl
, 
´obe
->
def
) != 0)

1162 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1164 
	`d—lŸs_queue
(
sk
);

1167 
	}
}

1169 
d—lŸs_´obedef_t
 *

1170 
	$d—lŸs_´efixsÿn_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
d—lŸs_¡©e_t
 *
¡©e
)

1172  
¡©e
->
pds
[¡©e->
´obe
];

1173 
	}
}

1175 
	$d—lŸs_´efixsÿn_po¡´obe
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1176 
d—lŸs_¡©e_t
 *
¡©e
)

1178 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

1179 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
¡©e
->
m‘hod¡©e
;

1180 
sÿm³r_d—lŸs_´obedef_t
 *
def
 = &
¡©e
->
´obedefs
[¡©e->
´obe
];

1182 if(
def
->
id
 == 0)

1183 
pf¡©e
->
round0
++;

1185 
pf¡©e
->
round
++;

1186 
pf¡©e
->
©‹m±
++;

1187 
pf¡©e
->
»¶yc
 = 0;

1188 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, &¡©e->
Ï¡_tx
, 
´efixsÿn
->
wa™_´obe
);

1191 
	}
}

1193 
	$d—lŸs_´efixsÿn_Ãxt
(
sÿm³r_sk_t
 *
sk
)

1195 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1196 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1197 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
¡©e
->
m‘hod¡©e
;

1198 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

1199 
sÿm³r_d—lŸs_´obedef_t
 *
def
 = &
pf¡©e
->
´obedefs
[
¡©e
->
´obedefc
-1];

1200 
ušt32_t
 *
defids
 = 
NULL
, 
p
;

1206 if(
	`¬¿y_fšd
((**)
pf¡©e
->
¯lŸ£s
,…f¡©e->
¯lŸsc
, 
def
->
d¡
,

1207 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

1209 
´efixsÿn
->
ab
 = 
	`sÿm³r_addr_u£
(
def
->
d¡
);

1210 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

1215 if((
defids
 = 
	`m®loc
((
ušt32_t
è* 
d—lŸs
->
´obec
)è=ğ
NULL
)

1217 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc defids");

1218 
”r
;

1220 
p
=0;…<
d—lŸs
->
´obec
;…++)

1221 
defids
[
p
] = 
d—lŸs
->
´obes
[p]->
def
->
id
;

1224 if(
	`sÿm³r_d—lŸs_´efixsÿn_´obedef_add
(
d—lŸs
, 
def
) != 0)

1226 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…robedef");

1227 
”r
;

1231 
p
=0;…<
¡©e
->
pdc
;…++)

1232 
¡©e
->
pds
[
p
]->
def
 = &
´efixsÿn
->
´obedefs
[p];

1233 
p
=0;…<
d—lŸs
->
´obec
;…++)

1234 
d—lŸs
->
´obes
[
p
]->
def
 = &
´efixsÿn
->
´obedefs
[
defids
[p]];

1235 
	`ä“
(
defids
); defid ğ
NULL
;

1237 
def
 = &
´efixsÿn
->
´obedefs
[´efixsÿn->
´obedefc
-1];

1238 if(
	`d—lŸs_´obedef_add
(
¡©e
, 
def
) != 0)

1239 
”r
;

1241 
¡©e
->
´obedefs
 = 
´efixsÿn
->probedefs;

1242 
¡©e
->
´obedefc
 = 
´efixsÿn
->probedefc;

1246 
”r
:

1247 if(
defids
 !ğ
NULL
è
	`ä“
(defids);

1249 
	}
}

1251 
	$d—lŸs_´efixsÿn_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
,

1252 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1253 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1254 
sÿm³r_dl_»c_t
 *
dl
)

1256 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1257 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1258 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d—lŸs
->
d©a
;

1259 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
¡©e
->
m‘hod¡©e
;

1260 
sÿm³r_d—lŸs_´obe_t
 **
´obes
 = 
NULL
;

1261 
ušt32_t
 
defid
;

1262 
p
, 
s
, 
£q
;

1265 if(
´obe
 !ğ
d—lŸs
->
´obes
[d—lŸs->
´obec
-1])

1269 if(
´obe
->
»¶yc
 != 1)

1276 if(
	`sÿm³r_sk_queue_i¥robe
(
sk
))

1280 if(
	`SCAMPER_DEALIAS_REPLY_FROM_TARGET
(
´obe
, 
»¶y
))

1281 
pf¡©e
->
»¶yc
++;

1290 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
´obe
->
def
) &&

1291 
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
) &&

1292 
	`sÿm³r_addr_cmp
(
´obe
->
def
->
d¡
, 
»¶y
->
¤c
) != 0)

1294 if(
´obe
->
def
->
id
 == 0)

1300 if(
	`¬¿y_fšd
((**)
pf¡©e
->
¯lŸ£s
,…f¡©e->
¯lŸsc
,

1301 
»¶y
->
¤c
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è=ğ
NULL
)

1303 if(
	`¬¿y_š£¹
((***)&
pf¡©e
->
¯lŸ£s
, &pf¡©e->
¯lŸsc
,

1304 
»¶y
->
¤c
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
) != 0)

1306 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1308 
”r
;

1310 
	`sÿm³r_addr_u£
(
»¶y
->
¤c
);

1319 if(
	`sÿm³r_addr_cmp
(
»¶y
->
¤c
, 
´efixsÿn
->
a
) == 0 ||

1320 
	`¬¿y_fšd
((**)
pf¡©e
->
¯lŸ£s
,…f¡©e->
¯lŸsc
,

1321 
»¶y
->
¤c
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

1323 
´efixsÿn
->
ab
 = 
	`sÿm³r_addr_u£
(
´obe
->
def
->
d¡
);

1324 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

1334 
£q
 = ++
pf¡©e
->seq;

1335 
pf¡©e
->
©‹m±
 = 0;

1337 
	`as£¹
(
£q
 >ğ1 && seq <ğ
´efixsÿn
->
»¶yc
);

1345 if(
£q
 < 2)

1347 if(
¡©e
->
´obe
 != 0)

1349 
¡©e
->
´obe
 = 0;

1353 if(
¡©e
->
´obedefc
 == 1)

1356 if(
	`d—lŸs_´efixsÿn_Ãxt
(
sk
) != 0)

1357 
”r
;

1360 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_ALIASES
)

1364 
¡©e
->
´obe
 = s‹->
´obedefc
-1;

1365 
	`d—lŸs_queue
(
sk
);

1369 if((
´obes
 = 
	`m®loc_z”o
((
sÿm³r_d—lŸs_´obe_t
 *è* 
£q
)è=ğ
NULL
)

1371 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…robes");

1372 
”r
;

1374 
´obes
[
£q
-1] = 
´obe
;

1377 
p
 = 
d—lŸs
->
´obec
-2; 
defid
 = 
´obes
[
£q
-1]->
def
->
id
;

1378 
p
 >ğ0 && 
d—lŸs
->
´obes
[p]->
def
->
id
 =ğ
defid
)

1379 
p
--;

1380 if(
p
<0)

1381 
”r
;

1383 
s
=
£q
-1; s>0; s--)

1385 if(
´obes
[
s
]->
def
->
id
 == 0)

1386 
defid
 = 
¡©e
->
´obedefc
 - 1;

1388 
defid
 = 0;

1390 if(
p
 < 0)

1391 
”r
;

1393 
p
 >= 0)

1395 
	`as£¹
(
defid
 =ğ
d—lŸs
->
´obes
[
p
]->
def
->
id
);

1398 if(
d—lŸs
->
´obes
[
p
]->
»¶yc
 == 0)

1400 
p
--;

1405 
´obes
[
s
-1] = 
d—lŸs
->´obes[
p
];

1408 
p
 >ğ0 && 
d—lŸs
->
´obes
[p]->
def
->
id
 =ğ
defid
)

1409 
p
--;

1419 if(
	`SCAMPER_DEALIAS_PREFIXSCAN_IS_NOBS
(
d—lŸs
))

1420 
p
 = 
	`sÿm³r_d—lŸs_id_š£q
(
´obes
, 
£q
, 
´efixsÿn
->
fudge
, 0);

1422 
p
 = 
	`sÿm³r_d—lŸs_id_š£q
(
´obes
, 
£q
, 
´efixsÿn
->
fudge
,

1423 
£q
 < 
´efixsÿn
->
»¶yc
 ? 2 : 3);

1424 
	`ä“
(
´obes
);…robe ğ
NULL
;

1425 if(
p
 == -1)

1426 
”r
;

1428 if(
p
 == 1)

1430 if(
£q
 =ğ
´efixsÿn
->
»¶yc
)

1432 
p
 = 
¡©e
->
´obedefc
-1;

1433 
´efixsÿn
->
ab
 = 
	`sÿm³r_addr_u£
Õ»fixsÿn->
´obedefs
[
p
].
d¡
);

1434 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

1438 if(
¡©e
->
´obe
 == 0)

1439 
¡©e
->
´obe
 = s‹->
´obedefc
 - 1;

1441 
¡©e
->
´obe
 = 0;

1447 if(
¡©e
->
´obedefc
-1 =ğ
pf¡©e
->probedefc)

1449 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1453 if(
	`d—lŸs_´efixsÿn_Ãxt
(
sk
) != 0)

1454 
”r
;

1455 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_ALIASES
)

1458 
pf¡©e
->
round
 = 0;

1459 
pf¡©e
->
©‹m±
 = 0;

1460 
¡©e
->
´obe
 = s‹->
´obedefc
-1;

1462 if(
d—lŸs
->
´obes
[d—lŸs->
´obec
-1]->
def
->
id
 == 0)

1463 
pf¡©e
->
£q
 = 1;

1465 
pf¡©e
->
£q
 = 0;

1467 
	`d—lŸs_queue
(
sk
);

1470 
”r
:

1471 if(
´obes
 !ğ
NULL
è
	`ä“
(probes);

1472 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1474 
	}
}

1476 
	$d—lŸs_´efixsÿn_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

1478 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1479 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1480 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
¡©e
->
m‘hod¡©e
;

1481 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
;

1482 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

1483 
sÿm³r_d—lŸs_´obe_t
 *
´obe
;

1485 
´efixsÿn
 = 
d—lŸs
->
d©a
;

1486 
´obe
 = 
d—lŸs
->
´obes
[d—lŸs->
´obec
-1];

1487 
def
 = 
´obe
->def;

1489 if(
pf¡©e
->
»¶yc
 == 0)

1492 if(
pf¡©e
->
©‹m±
 < 
´efixsÿn
->
©‹m±s
)

1494 
dÚe
;

1501 if(
def
->
id
 !ğ0 && 
¡©e
->
´obedefc
-1 < (
ušt32_t
)
pf¡©e
->probedefc)

1503 if(
	`d—lŸs_´efixsÿn_Ãxt
(
sk
) != 0)

1504 
”r
;

1507 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_ALIASES
)

1510 
pf¡©e
->
round
 = 0;

1511 
pf¡©e
->
£q
 = 0;

1512 
pf¡©e
->
©‹m±
 = 0;

1513 
¡©e
->
´obe
 = s‹->
´obedefc
-1;

1515 
dÚe
;

1518 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1523 
dÚe
:

1524 if(
¡©e
->
´obe
 == 0)

1525 
¡©e
->
round
 = 
pf¡©e
->
round0
;

1527 
¡©e
->
round
 = 
pf¡©e
->round;

1531 
”r
:

1532 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1534 
	}
}

1536 
d—lŸs_´obedef_t
 *

1537 
	$d—lŸs_bump_def
(
sÿm³r_d—lŸs_t
 *
d—lŸs
, 
d—lŸs_¡©e_t
 *
¡©e
)

1539  
¡©e
->
pds
[¡©e->
´obe
];

1540 
	}
}

1542 
	$d—lŸs_bump_po¡´obe
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1543 
d—lŸs_¡©e_t
 *
¡©e
)

1545 
sÿm³r_d—lŸs_bump_t
 *
bump
 = 
d—lŸs
->
d©a
;

1546 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, &¡©e->
Ï¡_tx
, 
bump
->
wa™_´obe
);

1548 
	}
}

1550 
	$d—lŸs_bump_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

1552 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1553 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1554 
d—lŸs_bump_t
 *
bs
 = 
¡©e
->
m‘hod¡©e
;

1555 
sÿm³r_d—lŸs_bump_t
 *
bump
 = 
d—lŸs
->
d©a
;

1556 
sÿm³r_d—lŸs_´obe_t
 *
´obes
[3];

1557 
ušt32_t
 
i
, 
x
, 
y
;

1559 if(
bs
->
¡•
 < 2)

1561 
bs
->
¡•
++;

1563 if(
bs
->
¡•
 == 2)

1566 
i
=0; i<3; i++)

1567 if(
d—lŸs
->
´obes
[d—lŸs->
´obec
-3+
i
]->
»¶yc
 == 1)

1568 
´obes
[
i
] = 
d—lŸs
->´obes[d—lŸs->
´obec
-3+i];

1572 if(
i
 != 3)

1573 
nÚe
;

1575 if(
	`sÿm³r_d—lŸs_id_š£q
(
´obes
, 3, 0, 0) != 1)

1577 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NOTALIASES
);

1581 if(
bs
->
©‹m±
 > 
bump
->
©‹m±s
)

1583 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_ALIASES
);

1587 
x
 = 
´obes
[1]->
»¶›s
[0]->
id
;

1588 
y
 = 
´obes
[2]->
»¶›s
[0]->
id
;

1589 if(
x
 < 
y
)

1590 
i
 = 
y
 - 
x
;

1592 
i
 = 0x10000 + 
y
 - 
x
;

1594 if(
i
 * 2 > 65535)

1595 
nÚe
;

1597 
bs
->
bump
 = 
i
 * 2;

1598 if(
bs
->
bump
 == 2)

1599 
bs
->
bump
++;

1601 if(
bs
->
bump
 > bump->
bump_lim™
)

1602 
nÚe
;

1604 
bs
->
¡•
++;

1606 if(
bs
->
¡•
 == 3)

1608 if(
bs
->
bump
 != 0)

1610 
bs
->
bump
--;

1614 
bs
->
©‹m±
++;

1615 
bs
->
¡•
 = 1;

1618 if(
¡©e
->
´obe
 == 1)

1619 
¡©e
->
´obe
 = 0;

1621 
¡©e
->
´obe
 = 1;

1625 
nÚe
:

1626 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1628 
	}
}

1630 
	$d—lŸs_bump_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
,

1631 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1632 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1633 
sÿm³r_dl_»c_t
 *
dl
)

1636 if(
	`SCAMPER_DEALIAS_REPLY_FROM_TARGET
(
´obe
,
»¶y
è=ğ0 ||…robe->
»¶yc
 != 1)

1638 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_NONE
);

1643 
	}
}

1645 
	$do_d—lŸs_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1647 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_d—lŸs_´obe_t
 *,

1648 
sÿm³r_d—lŸs_»¶y_t
 *,

1649 
sÿm³r_dl_»c_t
 *) = {

1650 
d—lŸs_m”ÿtÜ_hªdË»¶y
,

1651 
d—lŸs_®ly_hªdË»¶y
,

1652 
d—lŸs_¿d¬gun_hªdË»¶y
,

1653 
d—lŸs_´efixsÿn_hªdË»¶y
,

1654 
d—lŸs_bump_hªdË»¶y
,

1656 
sÿm³r_d—lŸs_´obe_t
 *
´obe
 = 
NULL
;

1657 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
 = 
NULL
;

1658 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1659 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1660 
d—lŸs_rg‘_t
 *
tgt
;

1661 
sÿm³r_addr_t
 
a
;

1662 
v4
 = 0;

1665 if(
d—lŸs
->
´obec
 == 0)

1668 if(
dl
->
dl_af
 =ğ
AF_INET
)

1669 
v4
 = 1;

1670 if(
dl
->
dl_af
 !ğ
AF_INET6
)

1673 if(
v4
 && 
	`SCAMPER_DL_IS_TCP
(
dl
))

1675 if(
	`sÿm³r_dl_»c_¤c
(
dl
, &
a
) != 0 ||

1676 (
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, &
a
)è=ğ
NULL
)

1678 
´obe
 = 
	`d—lŸs_´obe_tı_fšd2
(
¡©e
, 
tgt
, 
dl
->
dl_tı_dpÜt
,

1679 
dl
->
dl_tı_¥Üt
);

1680 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

1682 if(
¡©e
->
æags
 & 
DEALIAS_STATE_FLAG_DL
 && 
	`SCAMPER_DL_IS_ICMP
(
dl
))

1685 if(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
) ||

1686 
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
) ||

1687 
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
))

1690 if(
v4
 && (
dl
->
dl_icmp__id
 & 0xff) != (dl->dl_icmp_ip_id >> 8))

1693 if(
	`sÿm³r_dl_»c_icmp__d¡
(
dl
, &
a
) != 0 ||

1694 (
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, &
a
)è=ğ
NULL
)

1697 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_UDP
)

1698 
´obe
 = 
	`d—lŸs_´obe_udp_fšd
(
¡©e
, 
tgt
, 
dl
->
dl_icmp__id
,

1699 
dl
->
dl_icmp_udp_¥Üt
,

1700 
dl
->
dl_icmp_udp_dpÜt
);

1701 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_ICMP
 ||

1702 
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_ICMPV6
)

1703 
´obe
 = 
	`d—lŸs_´obe_icmp_fšd
(
¡©e
, 
tgt
, 
dl
->
dl_icmp__id
,

1704 
dl
->
dl_icmp_icmp_ty³
,

1705 
dl
->
dl_icmp_icmp_code
,

1706 
dl
->
dl_icmp_icmp_id
,

1707 
dl
->
dl_icmp_icmp_£q
);

1708 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_TCP
)

1709 
´obe
 = 
	`d—lŸs_´obe_tı_fšd
(
¡©e
, 
tgt
, 
dl
->
dl_icmp__id
,

1710 
dl
->
dl_icmp_tı_¥Üt
,

1711 
dl
->
dl_icmp_tı_dpÜt
);

1713 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
) != 0)

1715 if(
	`sÿm³r_dl_»c_¤c
(
dl
, &
a
) != 0 ||

1716 (
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, &
a
)è=ğ
NULL
)

1718 
´obe
 = 
	`d—lŸs_´obe_echÜeq_fšd
(
¡©e
, 
tgt
,

1719 
dl
->
dl_icmp_id
, dl->
dl_icmp_£q
);

1723 
	`sÿm³r_dl_»c_icmp_´št
(
dl
);

1726 if(
´obe
 =ğ
NULL
 || 
	`sÿm³r_dl_»c_¤c
(
dl
, &
a
) != 0)

1729 if((
»¶y
 = 
	`sÿm³r_d—lŸs_»¶y_®loc
()è=ğ
NULL
)

1731 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc„eply");

1732 
”r
;

1734 if((
»¶y
->
¤c
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
a
.
ty³
,‡.
addr
)è=ğ
NULL
)

1736 
	`sÿm³r_debug
(
__func__
, "could‚ot get‡ddress from cache");

1737 
”r
;

1739 
	`timev®_ıy
(&
»¶y
->
rx
, &
dl
->
dl_tv
);

1740 
»¶y
->
‰l
 = 
dl
->
dl__‰l
;

1741 
»¶y
->
´Ùo
 = 
dl
->
dl__´Ùo
;

1743 if(
v4
)

1745 
»¶y
->
id
 = 
dl
->
dl__id
;

1747 if(
	`SCAMPER_DL_IS_IP_FRAG
(
dl
))

1749 
»¶y
->
æags
 |ğ
SCAMPER_DEALIAS_REPLY_FLAG_IPID32
;

1750 
»¶y
->
id32
 = 
dl
->
dl_6_id
;

1753 if(
	`SCAMPER_DL_IS_TCP
(
dl
))

1755 
»¶y
->
tı_æags
 = 
dl
->
dl_tı_æags
;

1759 
»¶y
->
icmp_ty³
 = 
dl
->
dl_icmp_ty³
;

1760 
»¶y
->
icmp_code
 = 
dl
->
dl_icmp_code
;

1761 
»¶y
->
icmp_q__‰l
 = 
dl
->
dl_icmp__‰l
;

1764 if(
	`sÿm³r_d—lŸs_»¶y_add
(
´obe
, 
»¶y
) != 0)

1766 
	`sÿm³r_debug
(
__func__
, "could‚ot‡dd„eplyo…robe");

1767 
”r
;

1770 if(
func
[
d—lŸs
->
m‘hod
-1] !ğ
NULL
)

1771 
func
[
d—lŸs
->
m‘hod
-1](
sk
, 
´obe
, 
»¶y
, 
dl
);

1775 
”r
:

1776 if(
»¶y
 !ğ
NULL
è
	`sÿm³r_d—lŸs_»¶y_ä“
(reply);

1777 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1779 
	}
}

1781 
	$do_d—lŸs_hªdË_icmp
(
sÿm³r_sk_t
 *
sk
,
sÿm³r_icmp_»¥_t
 *
œ
)

1783 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_d—lŸs_´obe_t
 *,

1784 
sÿm³r_d—lŸs_»¶y_t
 *,

1785 
sÿm³r_dl_»c_t
 *) = {

1786 
d—lŸs_m”ÿtÜ_hªdË»¶y
,

1787 
d—lŸs_®ly_hªdË»¶y
,

1788 
NULL
,

1789 
d—lŸs_´efixsÿn_hªdË»¶y
,

1790 
d—lŸs_bump_hªdË»¶y
,

1792 
sÿm³r_d—lŸs_´obe_t
 *
´obe
 = 
NULL
;

1793 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
 = 
NULL
;

1794 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1795 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

1796 
d—lŸs_rg‘_t
 *
tgt
;

1797 
sÿm³r_addr_t
 
a
;

1800 if(
d—lŸs
->
´obec
 == 0)

1804 if((
¡©e
->
æags
 & 
DEALIAS_STATE_FLAG_DL
) != 0)

1808 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) ||

1809 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ||

1810 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
))

1812 if(
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
è=ğ0 || ir->
œ_šÃr__off
 != 0)

1816 if(
œ
->
œ_af
 =ğ
AF_INET
 &&

1817 (
œ
->
œ_šÃr__id
 & 0xff) != (ir->ir_inner_ip_id >> 8))

1820 if(
	`sÿm³r_icmp_»¥_šÃr_d¡
(
œ
, &
a
) != 0 ||

1821 (
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, &
a
)è=ğ
NULL
)

1824 if(
œ
->
œ_šÃr__´Ùo
 =ğ
IPPROTO_UDP
)

1825 
´obe
 = 
	`d—lŸs_´obe_udp_fšd
(
¡©e
, 
tgt
, 
œ
->
œ_šÃr__id
,

1826 
œ
->
œ_šÃr_udp_¥Üt
,

1827 
œ
->
œ_šÃr_udp_dpÜt
);

1828 if(
œ
->
œ_šÃr__´Ùo
 =ğ
IPPROTO_ICMP
 ||

1829 
œ
->
œ_šÃr__´Ùo
 =ğ
IPPROTO_ICMPV6
)

1830 
´obe
 = 
	`d—lŸs_´obe_icmp_fšd
(
¡©e
, 
tgt
, 
œ
->
œ_šÃr__id
,

1831 
œ
->
œ_šÃr_icmp_ty³
,

1832 
œ
->
œ_šÃr_icmp_code
,

1833 
œ
->
œ_šÃr_icmp_id
,

1834 
œ
->
œ_šÃr_icmp_£q
);

1835 if(
œ
->
œ_šÃr__´Ùo
 =ğ
IPPROTO_TCP
)

1836 
´obe
 = 
	`d—lŸs_´obe_tı_fšd
(
¡©e
, 
tgt
, 
œ
->
œ_šÃr__id
,

1837 
œ
->
œ_šÃr_tı_¥Üt
,

1838 
œ
->
œ_šÃr_tı_dpÜt
);

1840 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
a
) != 0)

1843 if(
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
) != 0)

1845 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
a
) != 0 ||

1846 (
tgt
 = 
	`d—lŸs_rg‘_fšd
(
¡©e
, &
a
)è=ğ
NULL
)

1848 
´obe
 = 
	`d—lŸs_´obe_echÜeq_fšd
(
¡©e
, 
tgt
,

1849 
œ
->
œ_icmp_id
, ir->
œ_icmp_£q
);

1852 if(
´obe
 =ğ
NULL
)

1855 
	`sÿm³r_icmp_»¥_´št
(
œ
);

1857 if((
»¶y
 = 
	`sÿm³r_d—lŸs_»¶y_®loc
()è=ğ
NULL
)

1859 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc„eply");

1860 
”r
;

1862 if((
»¶y
->
¤c
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
a
.
ty³
,‡.
addr
)è=ğ
NULL
)

1864 
	`sÿm³r_debug
(
__func__
, "could‚ot get‡ddress from cache");

1865 
”r
;

1867 
	`timev®_ıy
(&
»¶y
->
rx
, &
œ
->
œ_rx
);

1868 
»¶y
->
‰l
 = (
ušt8_t
)
œ
->
œ__‰l
;

1869 
»¶y
->
icmp_ty³
 = 
œ
->
œ_icmp_ty³
;

1870 
»¶y
->
icmp_code
 = 
œ
->
œ_icmp_code
;

1871 
»¶y
->
icmp_q__‰l
 = 
œ
->
œ_šÃr__‰l
;

1873 if(
œ
->
œ_af
 =ğ
AF_INET
)

1875 
»¶y
->
id
 = 
œ
->
œ__id
;

1876 
»¶y
->
´Ùo
 = 
IPPROTO_ICMP
;

1880 
»¶y
->
´Ùo
 = 
IPPROTO_ICMPV6
;

1883 if(
	`sÿm³r_d—lŸs_»¶y_add
(
´obe
, 
»¶y
) != 0)

1885 
	`sÿm³r_debug
(
__func__
, "could‚ot‡dd„eplyo…robe");

1886 
”r
;

1889 if(
func
[
d—lŸs
->
m‘hod
-1] !ğ
NULL
)

1890 
func
[
d—lŸs
->
m‘hod
-1](
sk
, 
´obe
, 
»¶y
, 
NULL
);

1893 
”r
:

1894 if(
»¶y
 !ğ
NULL
è
	`sÿm³r_d—lŸs_»¶y_ä“
(reply);

1895 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

1897 
	}
}

1899 
	$do_d—lŸs_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

1901 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) = {

1902 
d—lŸs_m”ÿtÜ_hªdËtimeout
,

1903 
d—lŸs_®ly_hªdËtimeout
,

1904 
d—lŸs_¿d¬gun_hªdËtimeout
,

1905 
d—lŸs_´efixsÿn_hªdËtimeout
,

1906 
d—lŸs_bump_hªdËtimeout
,

1908 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

1909 
func
[
d—lŸs
->
m‘hod
-1](
sk
);

1911 
	}
}

1918 
	$d—lŸs_¡©e_´obe
(
d—lŸs_¡©e_t
 *
¡©e
,

1919 
d—lŸs_´obedef_t
 *
pdef
,

1920 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1921 
sÿm³r_´obe_t
 *
´
)

1923 
d—lŸs_´obe_t
 *
dp
 = 
NULL
;

1926 if((
dp
 = 
	`m®loc_z”o
((
d—lŸs_´obe_t
))è=ğ
NULL
)

1928 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc dealias_probe_t");

1929 
”r
;

1931 if(
pdef
->
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
)

1932 
dp
->
m©ch_f›ld
 = 
´
->
´_udp_dpÜt
;

1933 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
pdef
->
def
))

1934 
dp
->
m©ch_f›ld
 = 
´
->
´_icmp_£q
;

1935 if(
	`SCAMPER_DEALIAS_PROBEDEF_VARY_TCP_SPORT
(
pdef
->
def
))

1936 
dp
->
m©ch_f›ld
 = 
´
->
´_tı_¥Üt
;

1938 
dp
->
´obe
 =…robe;

1939 
dp
->
rg‘
 = 
pdef
->target;

1941 if((
dp
->
rg‘_node
 = 
	`dli¡_h—d_push
(dp->
rg‘
->
´obes
, dp)è=ğ
NULL
 ||

1942 
	`dli¡__push
(
¡©e
->
»ûÁ_´obes
, 
dp
è=ğ
NULL
)

1944 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…usho†ists");

1945 
”r
;

1950 
”r
:

1951 if(
dp
 !ğ
NULL
è
	`ä“
(dp);

1953 
	}
}

1955 
	$d—lŸs_´efixsÿn_ä“
(*
d©a
)

1957 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
d©a
;

1958 
j
;

1960 if(
pf¡©e
->
´obedefs
 !ğ
NULL
)

1962 
j
=0; j<
pf¡©e
->
´obedefc
; j++)

1964 if(
pf¡©e
->
´obedefs
[
j
].
¤c
 !ğ
NULL
)

1965 
	`sÿm³r_addr_ä“
(
pf¡©e
->
´obedefs
[
j
].
¤c
);

1966 if(
pf¡©e
->
´obedefs
[
j
].
d¡
 !ğ
NULL
)

1967 
	`sÿm³r_addr_ä“
(
pf¡©e
->
´obedefs
[
j
].
d¡
);

1969 
	`ä“
(
pf¡©e
->
´obedefs
);

1971 if(
pf¡©e
->
¯lŸ£s
 !ğ
NULL
)

1973 
j
=0; j<
pf¡©e
->
¯lŸsc
; j++)

1974 if(
pf¡©e
->
¯lŸ£s
[
j
] !ğ
NULL
)

1975 
	`sÿm³r_addr_ä“
(
pf¡©e
->
¯lŸ£s
[
j
]);

1976 
	`ä“
(
pf¡©e
->
¯lŸ£s
);

1978 
	`ä“
(
pf¡©e
);

1981 
	}
}

1983 
	$d—lŸs_´efixsÿn_®loc
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1984 
d—lŸs_¡©e_t
 *
¡©e
)

1986 
sÿm³r_d—lŸs_´efixsÿn_t
 *
pfxsÿn
 = 
d—lŸs
->
d©a
;

1987 
sÿm³r_d—lŸs_´obedef_t
 
pd
;

1988 
d—lŸs_´efixsÿn_t
 *
pf¡©e
 = 
NULL
;

1989 
sÿm³r_addr_t
 **
addrs
 = 
NULL
;

1990 
i
, 
addrc
 = 0;

1993 if(
	`d—lŸs_´efixsÿn_¬¿y
(
d—lŸs
, &
addrs
, &
addrc
) != 0)

1994 
”r
;

1996 if((
pf¡©e
 = 
	`m®loc_z”o
((
d—lŸs_´efixsÿn_t
))è=ğ
NULL
)

1998 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…fstate");

1999 
”r
;

2001 
¡©e
->
m‘hod¡©e
 = 
pf¡©e
;

2003 
pf¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
addrc
 * (
sÿm³r_d—lŸs_´obedef_t
));

2004 if(
pf¡©e
->
´obedefs
 =ğ
NULL
)

2006 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…robedefs");

2007 
”r
;

2009 
pf¡©e
->
´obedefc
 = 
addrc
;

2011 
i
=0; i<
addrc
; i++)

2013 
	`memıy
(&
pd
, &
pfxsÿn
->
´obedefs
[0], (pd));

2014 
pd
.
d¡
 = 
	`sÿm³r_addr_u£
(
addrs
[
i
]);

2015 
pd
.
¤c
 = 
	`sÿm³r_g‘¤c
Õd.
d¡
, 0);

2016 
	`memıy
(&
pf¡©e
->
´obedefs
[
i
], &
pd
, (pd));

2019 
	`d—lŸs_´efixsÿn_¬¿y_ä“
(
addrs
, 
addrc
);

2022 
”r
:

2023 if(
addrs
 !ğ
NULL
è
	`d—lŸs_´efixsÿn_¬¿y_ä“
×ddrs, 
addrc
);

2025 
	}
}

2027 
	$d—lŸs_¿d¬gun_ä“
(*
d©a
)

2029 
d—lŸs_¿d¬gun_t
 *
rg¡©e
 = 
d©a
;

2030 if(
rg¡©e
->
Üd”
 !ğ
NULL
)

2031 
	`ä“
(
rg¡©e
->
Üd”
);

2032 
	`ä“
(
rg¡©e
);

2034 
	}
}

2036 
	$d—lŸs_¿d¬gun_®loc
(
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
,

2037 
d—lŸs_¡©e_t
 *
¡©e
)

2039 
d—lŸs_¿d¬gun_t
 *
rg¡©e
 = 
NULL
;

2040 
ušt32_t
 
i
;

2042 if((
rg¡©e
 = 
	`m®loc_z”o
((
d—lŸs_¿d¬gun_t
))è=ğ
NULL
)

2044 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot malloc„gstate");

2047 
¡©e
->
m‘hod¡©e
 = 
rg¡©e
;

2050 if((
rg
->
æags
 & 
SCAMPER_DEALIAS_RADARGUN_FLAG_SHUFFLE
))

2052 if((
rg¡©e
->
Üd”
 = 
	`m®loc
((
ušt32_t
è* 
rg
->
´obedefc
)è=ğ
NULL
)

2054 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc order");

2057 
i
=0; i<
rg
->
´obedefc
; i++)

2058 
rg¡©e
->
Üd”
[
i
] = i;

2059 if(
	`shufæe32
(
rg¡©e
->
Üd”
, 
rg
->
´obedefc
) != 0)

2064 
	}
}

2066 
	$d—lŸs_bump_®loc
(
d—lŸs_¡©e_t
 *
¡©e
)

2068 
d—lŸs_bump_t
 *
b¡©e
 = 
NULL
;

2069 if((
b¡©e
 = 
	`m®loc_z”o
((
d—lŸs_bump_t
))è=ğ
NULL
)

2071 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc bstate");

2074 
¡©e
->
m‘hod¡©e
 = 
b¡©e
;

2076 
	}
}

2078 
	$d—lŸs_bump_ä“
(*
d©a
)

2080 
	`ä“
(
d©a
);

2082 
	}
}

2084 
	$d—lŸs_¡©e_ä“
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

2085 
d—lŸs_¡©e_t
 *
¡©e
)

2087 
sÿm³r_d—lŸs_´obe_t
 *
´obe
;

2088 
d—lŸs_±b_t
 *
±b
;

2089 
j
;

2091 if(
¡©e
 =ğ
NULL
)

2094 if(
¡©e
->
»ûÁ_´obes
 !ğ
NULL
)

2095 
	`dli¡_ä“
(
¡©e
->
»ûÁ_´obes
);

2097 if(
¡©e
->
m‘hod¡©e
 !ğ
NULL
)

2099 if(
	`SCAMPER_DEALIAS_METHOD_IS_PREFIXSCAN
(
d—lŸs
))

2100 
	`d—lŸs_´efixsÿn_ä“
(
¡©e
->
m‘hod¡©e
);

2101 if(
	`SCAMPER_DEALIAS_METHOD_IS_RADARGUN
(
d—lŸs
))

2102 
	`d—lŸs_¿d¬gun_ä“
(
¡©e
->
m‘hod¡©e
);

2103 if(
	`SCAMPER_DEALIAS_METHOD_IS_BUMP
(
d—lŸs
))

2104 
	`d—lŸs_bump_ä“
(
¡©e
->
m‘hod¡©e
);

2107 if(
¡©e
->
rg‘s
 !ğ
NULL
)

2109 
j
=0; j<
¡©e
->
rg‘c
; j++)

2110 if(
¡©e
->
rg‘s
[
j
] !ğ
NULL
)

2111 
	`d—lŸs_rg‘_ä“
(
¡©e
->
rg‘s
[
j
]);

2112 
	`ä“
(
¡©e
->
rg‘s
);

2115 if(
¡©e
->
pds
 !ğ
NULL
)

2117 
j
=0; j<
¡©e
->
pdc
; j++)

2118 if(
¡©e
->
pds
[
j
] !ğ
NULL
)

2119 
	`ä“
(
¡©e
->
pds
[
j
]);

2120 
	`ä“
(
¡©e
->
pds
);

2123 if(
¡©e
->
±bq
 !ğ
NULL
)

2125 (
±b
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
±bq
)è!ğ
NULL
)

2126 
	`d—lŸs_±b_ä“
(
±b
);

2127 
	`¦i¡_ä“
(
¡©e
->
±bq
);

2130 if(
¡©e
->
disÿrd
 !ğ
NULL
)

2132 (
´obe
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
disÿrd
)è!ğ
NULL
)

2133 
	`sÿm³r_d—lŸs_´obe_ä“
(
´obe
);

2134 
	`¦i¡_ä“
(
¡©e
->
disÿrd
);

2137 
	`ä“
(
¡©e
);

2139 
	}
}

2141 
	$do_d—lŸs_´obe
(
sÿm³r_sk_t
 *
sk
)

2143 (*cÚ¡ 
po¡´obe_func
[])(
sÿm³r_d—lŸs_t
 *,

2144 
d—lŸs_¡©e_t
 *) = {

2145 
d—lŸs_m”ÿtÜ_po¡´obe
,

2146 
d—lŸs_®ly_po¡´obe
,

2147 
d—lŸs_¿d¬gun_po¡´obe
,

2148 
d—lŸs_´efixsÿn_po¡´obe
,

2149 
d—lŸs_bump_po¡´obe
,

2151 
d—lŸs_´obedef_t
 *(*cÚ¡ 
def_func
[])(
sÿm³r_d—lŸs_t
 *,

2152 
d—lŸs_¡©e_t
 *) = {

2153 
d—lŸs_m”ÿtÜ_def
,

2154 
d—lŸs_®ly_def
,

2155 
d—lŸs_¿d¬gun_def
,

2156 
d—lŸs_´efixsÿn_def
,

2157 
d—lŸs_bump_def
,

2159 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

2160 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

2161 
d—lŸs_´obedef_t
 *
pdef
;

2162 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

2163 
sÿm³r_d—lŸs_´obe_t
 *
dp
 = 
NULL
;

2164 
sÿm³r_´obe_t
 
´obe
;

2165 
d—lŸs_±b_t
 *
±b
 = 
NULL
;

2166 
ušt16_t
 
u16
;

2168 if(
d—lŸs
->
´obec
 == 0)

2169 
	`g‘timeofday_w¿p
(&
d—lŸs
->
¡¬t
);

2171 
	`mem£t
(&
´obe
, 0, (probe));

2172 if((
¡©e
->
æags
 & 
DEALIAS_STATE_FLAG_DL
) != 0)

2173 
´obe
.
´_æags
 |ğ
SCAMPER_PROBE_FLAG_DL
;

2175 if(
	`¦i¡_couÁ
(
¡©e
->
±bq
) > 0)

2177 
±b
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
±bq
); 
def
 =…tb->def;

2178 
´obe
.
´__¤c
 = 
def
->
¤c
;

2179 
´obe
.
´__d¡
 = 
def
->
d¡
;

2180 
´obe
.
´__‰l
 = 255;

2181 
	`SCAMPER_PROBE_ICMP_PTB
(&
´obe
, 
def
->
mtu
);

2182 
´obe
.
´_d©a
 = 
±b
->
quÙe
;

2183 
´obe
.
´_Ën
 = 
±b
->
quÙe_Ën
;

2184 if(
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0)

2186 
”ºo
 = 
´obe
.
´_”ºo
;

2187 
”r
;

2189 
	`timev®_ıy
(&
¡©e
->
±b_tx
, &
´obe
.
´_tx
);

2190 
	`d—lŸs_±b_ä“
(
±b
);

2191 
	`d—lŸs_queue
(
sk
);

2195 if((
pdef
 = 
def_func
[
d—lŸs
->
m‘hod
-1](d—lŸs, 
¡©e
)è=ğ
NULL
)

2196 
”r
;

2197 
def
 = 
pdef
->def;

2199 if(
pktbuf_Ën
 < 
¡©e
->
pds
[
def
->
id
]->pktbuf_len)

2201 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
¡©e
->
pds
[
def
->
id
]->
pktbuf_Ën
) != 0)

2203 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc…ktbuf");

2204 
”r
;

2206 
pktbuf_Ën
 = 
¡©e
->
pds
[
def
->
id
]->pktbuf_len;

2209 
´obe
.
´__¤c
 = 
def
->
¤c
;

2210 
´obe
.
´__d¡
 = 
def
->
d¡
;

2211 
´obe
.
´__‰l
 = 
def
->
‰l
;

2212 
´obe
.
´__tos
 = 
def
->
tos
;

2213 
´obe
.
´_d©a
 = 
pktbuf
;

2214 
´obe
.
´_Ën
 = 
¡©e
->
pds
[
def
->
id
]->
pktbuf_Ën
;

2216 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
def
->
d¡
))

2218 
´obe
.
´_æags
 |ğ
SCAMPER_PROBE_FLAG_IPID
;

2219 
´obe
.
´__id
 = 
¡©e
->
id
 << 8 | state->id;

2220 
´obe
.
´__off
 = 
IP_DF
;

2223 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
def
))

2225 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

2226 
´obe
.
´_udp_¥Üt
 = 
def
->
un
.
udp
.
¥Üt
;

2228 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
)

2229 
´obe
.
´_udp_dpÜt
 = 
def
->
un
.
udp
.
dpÜt
;

2230 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
)

2231 
´obe
.
´_udp_dpÜt
 = 
def
->
un
.
udp
.
dpÜt
 + 
pdef
->
rg‘
->
udp_dpÜt
++;

2233 
”r
;

2236 
u16
 = 
	`htÚs
(
d—lŸs
->
´obec
 + 1);

2237 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

2238 
u16
 = 
	`sÿm³r_udp4_cksum
(&
´obe
);

2239 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

2241 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
def
))

2243 
	`SCAMPER_PROBE_ICMP_ECHO
(&
´obe
, 
def
->
un
.
icmp
.
id
, 
¡©e
->
icmp£q
++);

2246 
u16
 = 
	`htÚs
(
def
->
un
.
icmp
.
csum
);

2247 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

2248 
u16
 = 
	`sÿm³r_icmp4_cksum
(&
´obe
);

2249 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

2251 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
))

2253 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

2254 
´obe
.
´_tı_dpÜt
 = 
def
->
un
.
tı
.
dpÜt
;

2255 
´obe
.
´_tı_æags
 = 
def
->
un
.
tı
.
æags
;

2257 if(
def
->
m‘hod
 =ğ
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
)

2259 
´obe
.
´_tı_¥Üt
 = 
def
->
un
.
tı
.
¥Üt
;

2260 
´obe
.
´_tı_£q
 = 
¡©e
->
pds
[
def
->
id
]->
tı_£q
;

2261 
´obe
.
´_tı_ack
 = 
¡©e
->
pds
[
def
->
id
]->
tı_ack
;

2263 if(
	`SCAMPER_DEALIAS_PROBEDEF_VARY_TCP_SPORT
(
def
))

2265 
´obe
.
´_tı_¥Üt
 = 
def
->
un
.
tı
.
¥Üt
 + 
pdef
->
rg‘
->
tı_¥Üt
++;

2266 if(
	`¿ndom_u32
(&
´obe
.
´_tı_£q
) != 0 ||

2267 
	`¿ndom_u32
(&
´obe
.
´_tı_ack
) != 0)

2268 
”r
;

2270 
”r
;

2277 if((
dp
 = 
	`sÿm³r_d—lŸs_´obe_®loc
()è=ğ
NULL
)

2279 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…robe");

2280 
”r
;

2282 
dp
->
def
 = def;

2283 
dp
->
id
 = 
´obe
.
´__id
;

2284 
dp
->
£q
 = 
¡©e
->
round
;

2286 if(
	`d—lŸs_¡©e_´obe
(
¡©e
, 
pdef
, 
dp
, &
´obe
) != 0)

2287 
”r
;

2290 if(
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0)

2292 
”ºo
 = 
´obe
.
´_”ºo
;

2293 
”r
;

2297 
	`timev®_ıy
(&
dp
->
tx
, &
´obe
.
´_tx
);

2298 if(
	`sÿm³r_d—lŸs_´obe_add
(
d—lŸs
, 
dp
) != 0)

2300 
	`sÿm³r_debug
(
__func__
, "could‚ot‡dd…robeo dealias data");

2301 
”r
;

2305 
	`timev®_ıy
(&
¡©e
->
Ï¡_tx
, &
´obe
.
´_tx
);

2306 if(
po¡´obe_func
[
d—lŸs
->
m‘hod
-1](d—lŸs, 
¡©e
) != 0)

2307 
”r
;

2309 
	`as£¹
(
¡©e
->
id
 != 0);

2310 if(--
¡©e
->
id
 == 0)

2311 
¡©e
->
id
 = 255;

2313 
	`d—lŸs_queue
(
sk
);

2316 
”r
:

2317 if(
±b
 !ğ
NULL
è
	`d—lŸs_±b_ä“
(ptb);

2318 
	`d—lŸs_hªdË”rÜ
(
sk
, 
”ºo
);

2320 
	}
}

2322 
	$do_d—lŸs_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

2324 
	`sÿm³r_fe_wr™e_d—lŸs
(
sf
, 
	`d—lŸs_g‘d©a
(
sk
));

2326 
	}
}

2328 
	$do_d—lŸs_h®t
(
sÿm³r_sk_t
 *
sk
)

2330 
	`d—lŸs_»suÉ
(
sk
, 
SCAMPER_DEALIAS_RESULT_HALTED
);

2332 
	}
}

2334 
	$do_d—lŸs_ä“
(
sÿm³r_sk_t
 *
sk
)

2336 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
	`d—lŸs_g‘d©a
(
sk
);

2337 
d—lŸs_¡©e_t
 *
¡©e
 = 
	`d—lŸs_g‘¡©e
(
sk
);

2339 if(
¡©e
 !ğ
NULL
)

2340 
	`d—lŸs_¡©e_ä“
(
d—lŸs
, 
¡©e
);

2342 if(
d—lŸs
 !ğ
NULL
)

2343 
	`sÿm³r_d—lŸs_ä“
(
d—lŸs
);

2346 
	}
}

2348 
	$d—lŸs_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

2350 
tmp
;

2352 
İtid
)

2354 
DEALIAS_OPT_OPTION
:

2355 
DEALIAS_OPT_PROBEDEF
:

2356 
DEALIAS_OPT_EXCLUDE
:

2357 
tmp
 = 0;

2360 
DEALIAS_OPT_DPORT
:

2361 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2365 
DEALIAS_OPT_FUDGE
:

2366 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2370 
DEALIAS_OPT_METHOD
:

2371 if(
	`¡rÿ£cmp
(
·¿m
, "mercator") == 0)

2372 
tmp
 = 
SCAMPER_DEALIAS_METHOD_MERCATOR
;

2373 if(
	`¡rÿ£cmp
(
·¿m
, "ally") == 0)

2374 
tmp
 = 
SCAMPER_DEALIAS_METHOD_ALLY
;

2375 if(
	`¡rÿ£cmp
(
·¿m
, "radargun") == 0)

2376 
tmp
 = 
SCAMPER_DEALIAS_METHOD_RADARGUN
;

2377 if(
	`¡rÿ£cmp
(
·¿m
, "prefixscan") == 0)

2378 
tmp
 = 
SCAMPER_DEALIAS_METHOD_PREFIXSCAN
;

2379 if(
	`¡rÿ£cmp
(
·¿m
, "bump") == 0)

2380 
tmp
 = 
SCAMPER_DEALIAS_METHOD_BUMP
;

2385 
DEALIAS_OPT_ATTEMPTS
:

2386 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 500)

2390 
DEALIAS_OPT_SPORT
:

2391 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2395 
DEALIAS_OPT_TTL
:

2396 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 255)

2400 
DEALIAS_OPT_USERID
:

2401 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

2405 
DEALIAS_OPT_WAIT_TIMEOUT
:

2406 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 255)

2410 
DEALIAS_OPT_WAIT_PROBE
:

2411 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2415 
DEALIAS_OPT_WAIT_ROUND
:

2416 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 180000)

2420 
DEALIAS_OPT_REPLYC
:

2421 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 3 ||mp > 255)

2426 
	`sÿm³r_debug
(
__func__
, "unhªdËd o±id %d", 
İtid
);

2430 if(
out
 !ğ
NULL
)

2431 *
out
 = 
tmp
;

2433 
	}
}

2435 
	$d—lŸs_´obedef_¬gs
(
sÿm³r_d—lŸs_´obedef_t
 *
def
, *
¡r
)

2437 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

2438 
ušt16_t
 
dpÜt
 = 33435;

2439 
ušt16_t
 
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

2440 
ušt16_t
 
csum
 = 0;

2441 
ušt16_t
 
İts
 = 0;

2442 
ušt8_t
 
‰l
 = 255;

2443 
ušt8_t
 
tos
 = 0;

2444 
ušt16_t
 
size
 = 0;

2445 
ušt16_t
 
mtu
 = 0;

2446 *
’d
;

2447 
tmp
;

2450 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
´obedef_İts
, 
´obedef_İts_út
,

2451 &
İts_out
, &
’d
) != 0)

2453 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse options");

2454 
”r
;

2457 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

2460 if(
İts
 & (1<<(
İt
->
id
-1)))

2462 
	`sÿm³r_debug
(
__func__
,"İtiÚ %d s³cif›d muÉËimes",
İt
->
id
);

2463 
”r
;

2466 
İts
 |ğ(1 << (
İt
->
id
-1));

2468 
İt
->
id
)

2470 
DEALIAS_PROBEDEF_OPT_CSUM
:

2471 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 0 ||mp > 65535)

2473 
	`sÿm³r_debug
(
__func__
, "šv®id csum %s", 
İt
->
¡r
);

2474 
”r
;

2476 
csum
 = (
ušt16_t
)
tmp
;

2479 
DEALIAS_PROBEDEF_OPT_DPORT
:

2480 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2482 
	`sÿm³r_debug
(
__func__
, "šv®id dpÜˆ%s", 
İt
->
¡r
);

2483 
”r
;

2485 
dpÜt
 = (
ušt16_t
)
tmp
;

2488 
DEALIAS_PROBEDEF_OPT_IP
:

2489 
def
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
İt
->
¡r
);

2490 if(
def
->
d¡
 =ğ
NULL
)

2492 
	`sÿm³r_debug
(
__func__
, "šv®id d¡ i°%s", 
İt
->
¡r
);

2493 
”r
;

2497 
DEALIAS_PROBEDEF_OPT_MTU
:

2498 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 100 ||mp > 65535)

2500 
	`sÿm³r_debug
(
__func__
, "šv®id mtu siz%s", 
İt
->
¡r
);

2501 
”r
;

2503 
mtu
 = (
ušt16_t
)
tmp
;

2506 
DEALIAS_PROBEDEF_OPT_PROTO
:

2507 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "udp") == 0)

2508 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
;

2509 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "tcp-ack") == 0)

2510 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK
;

2511 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "icmp-echo") == 0)

2512 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_ICMP_ECHO
;

2513 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "tcp-ack-sport") == 0)

2514 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_ACK_SPORT
;

2515 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "udp-dport") == 0)

2516 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP_DPORT
;

2517 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "tcp-syn-sport") == 0)

2518 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_TCP_SYN_SPORT
;

2521 
	`sÿm³r_debug
(
__func__
, "šv®id…robty³ %s", 
İt
->
¡r
);

2522 
”r
;

2526 
DEALIAS_PROBEDEF_OPT_SIZE
:

2527 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 100 ||mp > 65535)

2529 
	`sÿm³r_debug
(
__func__
, "šv®id…robsiz%s", 
İt
->
¡r
);

2530 
”r
;

2532 
size
 = (
ušt16_t
)
tmp
;

2535 
DEALIAS_PROBEDEF_OPT_SPORT
:

2536 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

2538 
	`sÿm³r_debug
(
__func__
, "šv®id spÜˆ%s", 
İt
->
¡r
);

2539 
”r
;

2541 
¥Üt
 = (
ušt16_t
)
tmp
;

2544 
DEALIAS_PROBEDEF_OPT_TTL
:

2545 if(
	`¡ršg_tŞÚg
(
İt
->
¡r
, &
tmp
) != 0 ||mp < 1 ||mp > 255)

2547 
	`sÿm³r_debug
(
__func__
, "šv®id %s", 
İt
->
¡r
);

2548 
”r
;

2550 
‰l
 = (
ušt8_t
)
tmp
;

2554 
	`sÿm³r_debug
(
__func__
, "unhªdËd o±id %d", 
İt
->
id
);

2555 
”r
;

2559 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

2565 if(
’d
 !ğ
NULL
)

2567 
	`sÿm³r_debug
(
__func__
, "invalid option string");

2568 
”r
;

2572 
def
->
‰l
 =tl;

2573 
def
->
tos
 =os;

2574 
def
->
size
 = size;

2575 
def
->
mtu
 = mtu;

2578 if((
İts
 & (1<<(
DEALIAS_PROBEDEF_OPT_PROTO
-1))) == 0)

2579 
def
->
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
;

2581 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
def
))

2584 if(
İts
 & (1<<(
DEALIAS_PROBEDEF_OPT_CSUM
-1)))

2586 
	`sÿm³r_debug
(
__func__
, "csum option‚ot…ermitted for udp");

2587 
”r
;

2590 
def
->
un
.
udp
.
dpÜt
 = dport;

2591 
def
->
un
.
udp
.
¥Üt
 = sport;

2593 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
def
))

2596 if(
İts
 & (1<<(
DEALIAS_PROBEDEF_OPT_SPORT
-1)))

2598 
	`sÿm³r_debug
(
__func__
, "sport option‚ot…ermitted for icmp");

2599 
”r
;

2601 if(
İts
 & (1<<(
DEALIAS_PROBEDEF_OPT_DPORT
-1)))

2603 
	`sÿm³r_debug
(
__func__
, "dport option‚ot…ermitted for icmp");

2604 
”r
;

2606 
def
->
un
.
icmp
.
csum
 = csum;

2607 
def
->
un
.
icmp
.
id
 = 
	`sÿm³r_¥Üt_deçuÉ
();

2609 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
))

2612 if(
İts
 & (1<<(
DEALIAS_PROBEDEF_OPT_CSUM
-1)))

2614 
	`sÿm³r_debug
(
__func__
, "csum option‚ot…ermitted forcp");

2615 
”r
;

2618 
def
->
un
.
tı
.
dpÜt
 = dport;

2619 
def
->
un
.
tı
.
¥Üt
 = sport;

2620 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP_ACK
(
def
))

2621 
def
->
un
.
tı
.
æags
 = 
TH_ACK
;

2622 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP_SYN
(
def
))

2623 
def
->
un
.
tı
.
æags
 = 
TH_SYN
;

2626 
	`sÿm³r_debug
(
__func__
,"unhªdËd fÏg fÜ m‘hod %d",
def
->
m‘hod
);

2627 
”r
;

2632 
	`sÿm³r_debug
(
__func__
, "unhªdËd m‘hod %d", 
def
->
m‘hod
);

2633 
”r
;

2638 
”r
:

2639 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

2640 if(
def
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(def->dst);

2642 
	}
}

2644 
	$d—lŸs_®loc_m”ÿtÜ
(
sÿm³r_d—lŸs_t
 *
d
, 
d—lŸs_İtiÚs_t
 *
o
)

2646 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
;

2647 
sÿm³r_addr_t
 *
d¡
 = 
NULL
;

2650 if(
o
->
addr
 =ğ
NULL
)

2652 
	`sÿm³r_debug
(
__func__
, "missingarget‡ddress for mercator");

2653 
”r
;

2655 if((
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
o
->
addr
)è=ğ
NULL
)

2657 
	`sÿm³r_debug
(
__func__
, "unableo„esolve‡ddress for mercator");

2658 
”r
;

2660 if(
o
->
´obedefc
 !ğ0 || o->
xc
 !ğ0 || o->
wa™_´obe
 !ğ0 || o->
fudge
 != 0 ||

2661 
o
->
©‹m±s
 > 3 || o->
nobs
 !ğ0 || o->
»¶yc
 !ğ0 || o->
shufæe
 != 0 ||

2662 
o
->
š£q
 != 0)

2664 
	`sÿm³r_debug
(
__func__
, "invalid…arameters for mercator");

2665 
”r
;

2667 if(
o
->
©‹m±s
 == 0) o->attempts = 3;

2668 if(
o
->
dpÜt
 == 0) o->dport = 33435;

2669 if(
o
->
¥Üt
 =ğ0èo->¥Üˆğ
	`sÿm³r_¥Üt_deçuÉ
();

2670 if(
o
->
‰l
 == 0) o->ttl = 255;

2672 if(
	`sÿm³r_d—lŸs_m”ÿtÜ_®loc
(
d
) != 0)

2674 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc mercator structure");

2675 
”r
;

2677 
m”ÿtÜ
 = 
d
->
d©a
;

2678 
m”ÿtÜ
->
©‹m±s
 = 
o
->attempts;

2679 
m”ÿtÜ
->
wa™_timeout
 = 
o
->wait_timeout;

2680 
m”ÿtÜ
->
´obedef
.
id
 = 0;

2681 
m”ÿtÜ
->
´obedef
.
d¡
 = d¡; d¡ = 
NULL
;

2682 
m”ÿtÜ
->
´obedef
.
‰l
 = 
o
->ttl;

2683 
m”ÿtÜ
->
´obedef
.
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
;

2684 
m”ÿtÜ
->
´obedef
.
un
.
udp
.
¥Üt
 = 
o
->sport;

2685 
m”ÿtÜ
->
´obedef
.
un
.
udp
.
dpÜt
 = 
o
->dport;

2689 
”r
:

2690 if(
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(dst);

2692 
	}
}

2694 
	$d—lŸs_®loc_®ly
(
sÿm³r_d—lŸs_t
 *
d
, 
d—lŸs_İtiÚs_t
 *
o
)

2696 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
NULL
;

2697 
sÿm³r_d—lŸs_´obedef_t
 
pd
[2];

2698 
ušt8_t
 
æags
 = 0;

2699 *
addr2
;

2700 
i
;

2702 
	`mem£t
(&
pd
, 0, (pd));

2704 if(
o
->
´obedefc
 > 2 || o->
xc
 !ğ0 || o->
dpÜt
 !ğ0 || o->
¥Üt
 != 0 ||

2705 
o
->
‰l
 !ğ0 || o->
»¶yc
 !ğ0 || o->
shufæe
 != 0 ||

2706 (
o
->
š£q
 !ğ0 && o->
fudge
 != 0))

2708 
	`sÿm³r_debug
(
__func__
, "invalid…arameters for‡lly");

2709 
”r
;

2712 if(
o
->
wa™_´obe
 == 0) o->wait_probe = 150;

2713 if(
o
->
©‹m±s
 == 0) o->attempts = 5;

2715 if(
o
->
fudge
 =ğ0 && o->
š£q
 == 0)

2716 
o
->
fudge
 = 200;

2718 
i
=0; i<
o
->
´obedefc
; i++)

2720 if(
	`d—lŸs_´obedef_¬gs
(&
pd
[
i
], 
o
->
´obedefs
[i]) != 0)

2722 
	`sÿm³r_debug
(
__func__
, "could‚Ù„—d‡Îy…robedeà%d", 
i
);

2723 
”r
;

2727 if(
o
->
´obedefc
 == 0)

2729 
i
=0; i<2; i++)

2731 
pd
[
i
].
‰l
 = 255;

2732 
pd
[
i
].
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
;

2733 
pd
[
i
].
un
.
udp
.
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

2734 
pd
[
i
].
un
.
udp
.
dpÜt
 = 33435;

2737 if(
o
->
´obedefc
 == 1)

2739 if(
pd
[0].
d¡
 !ğ
NULL
 || 
o
->
addr
 == NULL)

2741 
	`sÿm³r_debug
(
__func__
, "dst IP specified incorrectly");

2742 
”r
;

2744 
	`memıy
(&
pd
[1], &pd[0], (
sÿm³r_d—lŸs_´obedef_t
));

2747 if(
o
->
addr
 =ğ
NULL
)

2749 if(
pd
[0].
d¡
 =ğ
NULL
 ||…d[1].dst == NULL)

2751 
	`sÿm³r_debug
(
__func__
, "missing destination IP‡ddress");

2752 
”r
;

2757 if(
pd
[0].
d¡
 !ğ
NULL
 ||…d[1].dst != NULL)

2759 
	`sÿm³r_debug
(
__func__
, "dst IP specified inconsisently");

2760 
”r
;

2764 if((
addr2
 = 
	`¡ršg_ÃxtwÜd
(
o
->
addr
)è=ğ
NULL
)

2766 
	`sÿm³r_debug
(
__func__
, "missing second‡ddress");

2767 
”r
;

2771 
pd
[0].
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
o
->
addr
);

2772 if(
pd
[0].
d¡
 =ğ
NULL
)

2774 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù„esŞv%s", 
o
->
addr
);

2775 
”r
;

2777 
pd
[1].
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
addr2
);

2778 if(
pd
[1].
d¡
 =ğ
NULL
)

2780 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù„esŞv%s", 
addr2
);

2781 
”r
;

2785 if(
pd
[0].
d¡
->
ty³
 !=…d[1].dst->type ||

2786 
	`SCAMPER_ADDR_TYPE_IS_IP
(
pd
[0].
d¡
) == 0 ||

2787 
	`SCAMPER_ADDR_TYPE_IS_IP
(
pd
[1].
d¡
) == 0)

2789 
	`sÿm³r_debug
(
__func__
, "dst IP specified incorrectly");

2790 
”r
;

2793 if(
o
->
nobs
 !ğ0 || 
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
pd
[0].
d¡
))

2794 
æags
 |ğ
SCAMPER_DEALIAS_ALLY_FLAG_NOBS
;

2796 if(
	`sÿm³r_d—lŸs_®ly_®loc
(
d
) != 0)

2798 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc‡lly structure");

2799 
”r
;

2801 
®ly
 = 
d
->
d©a
;

2803 
®ly
->
©‹m±s
 = 
o
->attempts;

2804 
®ly
->
wa™_´obe
 = 
o
->wait_probe;

2805 
®ly
->
wa™_timeout
 = 
o
->wait_timeout;

2806 
®ly
->
fudge
 = 
o
->fudge;

2807 
®ly
->
æags
 = flags;

2809 
i
=0; i<2; i++)

2810 
pd
[
i
].
id
 = i;

2812 
	`memıy
(
®ly
->
´obedefs
, 
pd
, (ally->probedefs));

2816 
”r
:

2817 if(
pd
[0].
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pd[0].dst);

2818 if(
pd
[1].
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pd[1].dst);

2820 
	}
}

2822 
	$d—lŸs_®loc_¿d¬gun
(
sÿm³r_d—lŸs_t
 *
d
, 
d—lŸs_İtiÚs_t
 *
o
)

2824 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
;

2825 
sÿm³r_d—lŸs_´obedef_t
 *
pd
 = 
NULL
, 
pd0
;

2826 
¦i¡_t
 *
pd_li¡
 = 
NULL
;

2827 
ušt32_t
 
i
, 
´obedefc
;

2828 
ušt8_t
 
æags
 = 0;

2829 
size_t
 
Ën
;

2830 *
a1
, *
a2
;

2832 
	`mem£t
(&
pd0
, 0, (pd0));

2834 if(
o
->
xc
 !ğ0 || o->
dpÜt
 !ğ0 || o->
¥Üt
 != 0 ||

2835 
o
->
‰l
 !ğ0 || o->
nobs
 !ğ0 || o->
»¶yc
 !ğ0 || o->
š£q
 != 0)

2837 
	`sÿm³r_debug
(
__func__
, "invalid…arameters for„adargun");

2838 
”r
;

2841 if(
o
->
wa™_´obe
 == 0) o->wait_probe = 150;

2842 if(
o
->
©‹m±s
 == 0) o->attempts = 30;

2843 if(
o
->
wa™_round
 =ğ0èo->wa™_round = o->
´obedefc
 * o->
wa™_´obe
;

2845 if(
o
->
shufæe
 != 0)

2846 
æags
 |ğ
SCAMPER_DEALIAS_RADARGUN_FLAG_SHUFFLE
;

2848 if(
o
->
´obedefc
 == 0)

2850 
pd0
.
‰l
 = 255;

2851 
pd0
.
m‘hod
 = 
SCAMPER_DEALIAS_PROBEDEF_METHOD_UDP
;

2852 
pd0
.
un
.
udp
.
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

2853 
pd0
.
un
.
udp
.
dpÜt
 = 33435;

2855 if(
o
->
´obedefc
 == 1)

2857 if(
	`d—lŸs_´obedef_¬gs
(&
pd0
, 
o
->
´obedefs
[0]) != 0)

2859 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse„adargun…robedef 0");

2860 
”r
;

2862 if(
pd0
.
d¡
 !ğ
NULL
 || 
o
->
addr
 == NULL)

2864 
	`sÿm³r_debug
(
__func__
, "dst‡ddrs‡re specified‡fter def");

2865 
”r
;

2869 if(
o
->
´obedefc
 >ğ2 && o->
addr
 =ğ
NULL
)

2871 
Ën
 = 
o
->
´obedefc
 * (
sÿm³r_d—lŸs_´obedef_t
);

2872 if((
pd
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

2874 
	`sÿm³r_debug
(
__func__
, "could‚ot malloc„adargun…d");

2875 
”r
;

2878 
i
=0; i<
o
->
´obedefc
; i++)

2880 if(
	`d—lŸs_´obedef_¬gs
(&
pd
[
i
], 
o
->
´obedefs
[i]) != 0 ||

2881 
pd
[
i
].
d¡
 =ğ
NULL
)

2883 
	`sÿm³r_debug
(
__func__
, "could‚Ù…¬£„ad¬guÀdeà%d", 
i
);

2884 
”r
;

2886 if(
i
 !ğ0 && 
pd
[0].
d¡
->
ty³
 !=…d[i].dst->type)

2888 
	`sÿm³r_debug
(
__func__
, "mixed‡ddress familys");

2889 
”r
;

2891 
pd0
.
id
 = 
i
;

2893 
´obedefc
 = 
o
->probedefc;

2895 if(
o
->
´obedefc
 < 2 && o->
addr
 !ğ
NULL
)

2897 if((
pd_li¡
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

2899 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…d_list");

2900 
”r
;

2902 
a1
 = 
o
->
addr
; 
i
 = 0;

2905 
a2
 = 
	`¡ršg_ÃxtwÜd
(
a1
);

2906 
pd0
.
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
a1
);

2907 if(
pd0
.
d¡
 =ğ
NULL
)

2908 
”r
;

2909 
pd0
.
id
 = 
i
++;

2910 if((
pd
 = 
	`memdup
(&
pd0
, Õd0))è=ğ
NULL
 ||

2911 
	`¦i¡__push
(
pd_li¡
, 
pd
è=ğ
NULL
)

2912 
”r
;

2913 
pd0
.
d¡
 = 
NULL
;

2914 if(
a2
 =ğ
NULL
)

2916 
a1
 = 
a2
;

2918 
´obedefc
 = 
	`¦i¡_couÁ
(
pd_li¡
);

2920 
”r
;

2922 if(
	`sÿm³r_d—lŸs_¿d¬gun_®loc
(
d
) != 0)

2924 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc„adargun structure");

2925 
”r
;

2927 
rg
 = 
d
->
d©a
;

2929 if(
	`sÿm³r_d—lŸs_¿d¬gun_´obedefs_®loc
(
rg
, 
´obedefc
) != 0)

2931 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc„adargun…robedefs");

2932 
”r
;

2935 
rg
->
©‹m±s
 = 
o
->attempts;

2936 
rg
->
wa™_´obe
 = 
o
->wait_probe;

2937 
rg
->
wa™_timeout
 = 
o
->wait_timeout;

2938 
rg
->
wa™_round
 = 
o
->wait_round;

2939 
rg
->
´obedefc
 =…robedefc;

2940 
rg
->
æags
 = flags;

2942 if(
pd_li¡
 =ğ
NULL
)

2944 
i
=0; i<
o
->
´obedefc
; i++)

2945 
	`memıy
(&
rg
->
´obedefs
[
i
], &
pd
[i], (
sÿm³r_d—lŸs_´obedef_t
));

2949 
i
=0;

2950 (
pd
 = 
	`¦i¡_h—d_pİ
(
pd_li¡
)è!ğ
NULL
)

2952 
	`memıy
(&
rg
->
´obedefs
[
i
], 
pd
, (
sÿm³r_d—lŸs_´obedef_t
));

2953 
	`ä“
(
pd
);

2954 
i
++;

2956 
	`¦i¡_ä“
(
pd_li¡
);…d_li¡ = 
NULL
;

2961 
”r
:

2962 if(
pd
 !ğ
NULL
)

2964 
i
=0; i<
o
->
´obedefc
; i++)

2965 if(
pd
[
i
].
d¡
 !ğ
NULL
)

2966 
	`sÿm³r_addr_ä“
(
pd
[
i
].
d¡
);

2967 
	`ä“
(
pd
);

2969 if(
pd_li¡
 !ğ
NULL
)

2971 (
pd
 = 
	`¦i¡_h—d_pİ
(
pd_li¡
)è!ğ
NULL
)

2973 
	`sÿm³r_addr_ä“
(
pd
->
d¡
);

2974 
	`ä“
(
pd
);

2976 
	`¦i¡_ä“
(
pd_li¡
);

2978 if(
pd0
.
d¡
 !ğ
NULL
)

2979 
	`sÿm³r_addr_ä“
(
pd0
.
d¡
);

2981 
	}
}

2983 
	$d—lŸs_®loc_´efixsÿn
(
sÿm³r_d—lŸs_t
 *
d
, 
d—lŸs_İtiÚs_t
 *
o
)

2985 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
;

2986 
sÿm³r_d—lŸs_´obedef_t
 
pd0
;

2987 
sÿm³r_addr_t
 *
d¡
 = 
NULL
;

2988 
ušt8_t
 
æags
 = 0;

2989 
ušt8_t
 
´efix
;

2990 *
addr2
 = 
NULL
, *
pfx¡r
;

2991 
tmp
;

2992 
xi
, 
af
;

2995 if(
o
->
´obedefc
 !ğ1 || o->
addr
 =ğ
NULL
 || o->
dpÜt
 !ğ0 || o->
¥Üt
 != 0 ||

2996 
o
->
‰l
 !ğ0 || o->
shufæe
 !ğ0 || (o->
š£q
 !ğ0 && o->
fudge
 != 0))

2998 
	`sÿm³r_debug
(
__func__
, "invalid…arameters for…refixscan");

2999 
”r
;

3002 if(
o
->
‰l
 == 0) o->ttl = 255;

3003 if(
o
->
wa™_´obe
 == 0) o->wait_probe = 1000;

3004 if(
o
->
©‹m±s
 == 0) o->attempts = 2;

3005 if(
o
->
»¶yc
 == 0) o->replyc = 5;

3007 if(
o
->
nobs
 != 0)

3008 
æags
 |ğ
SCAMPER_DEALIAS_PREFIXSCAN_FLAG_NOBS
;

3010 if(
o
->
fudge
 =ğ0 && o->
š£q
 == 0)

3011 
o
->
fudge
 = 200;

3019 if((
addr2
 = 
	`¡ršg_ÃxtwÜd
(
o
->
addr
)è=ğ
NULL
)

3021 
	`sÿm³r_debug
(
__func__
, "missing second‡ddress");

3022 
”r
;

3025 
	`¡ršg_nuÎ‹rm_ch¬
(
addr2
, '/', &
pfx¡r
);

3026 if(
pfx¡r
 =ğ
NULL
)

3028 
	`sÿm³r_debug
(
__func__
, "missing…refix");

3029 
”r
;

3032 if(
	`¡ršg_tŞÚg
(
pfx¡r
, &
tmp
) != 0 ||mp < 24 ||mp >= 32)

3034 
	`sÿm³r_debug
(
__func__
, "šv®id…»fix %s", 
pfx¡r
);

3035 
”r
;

3037 
´efix
 = (
ušt8_t
)
tmp
;

3040 
	`mem£t
(&
pd0
, 0, (pd0));

3041 if(
	`d—lŸs_´obedef_¬gs
(&
pd0
, 
o
->
´obedefs
[0]) != 0)

3043 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse…refixscan…robedef");

3044 
”r
;

3046 if(
pd0
.
d¡
 !ğ
NULL
)

3048 
	`sÿm³r_debug
(
__func__
, "prefixscan ip‡ddress spec. in…robedef");

3049 
	`sÿm³r_addr_ä“
(
pd0
.
d¡
);…d0.d¡ = 
NULL
;

3050 
”r
;

3053 if(
	`sÿm³r_d—lŸs_´efixsÿn_®loc
(
d
) != 0)

3055 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc…refixscan structure");

3056 
”r
;

3058 
´efixsÿn
 = 
d
->
d©a
;

3060 
´efixsÿn
->
©‹m±s
 = 
o
->attempts;

3061 
´efixsÿn
->
fudge
 = 
o
->fudge;

3062 
´efixsÿn
->
wa™_´obe
 = 
o
->wait_probe;

3063 
´efixsÿn
->
wa™_timeout
 = 
o
->wait_timeout;

3064 
´efixsÿn
->
»¶yc
 = 
o
->replyc;

3065 
´efixsÿn
->
´efix
 =…refix;

3066 
´efixsÿn
->
æags
 = flags;

3069 
´efixsÿn
->
a
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
o
->
addr
);

3070 if(
´efixsÿn
->
a
 =ğ
NULL
)

3072 
	`sÿm³r_debug
(
__func__
, "could‚Ù„esŞv%s", 
o
->
addr
);

3073 
”r
;

3075 
af
 = 
	`sÿm³r_addr_af
(
´efixsÿn
->
a
);

3076 
´efixsÿn
->
b
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, 
addr2
);

3077 if(
´efixsÿn
->
b
 =ğ
NULL
)

3079 
	`sÿm³r_debug
(
__func__
, "could‚Ù„esŞv%s", 
addr2
);

3080 
”r
;

3084 if(
	`sÿm³r_d—lŸs_´efixsÿn_´obedefs_®loc
(
´efixsÿn
, 1) != 0)

3086 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc…refixscan…robedefs");

3087 
”r
;

3089 
	`memıy
(
´efixsÿn
->
´obedefs
, &
pd0
, (pd0));

3090 
´efixsÿn
->
´obedefs
[0].
d¡
 = 
	`sÿm³r_addr_u£
Õ»fixsÿn->
a
);

3091 
´efixsÿn
->
´obedefs
[0].
id
 = 0;

3092 
´efixsÿn
->
´obedefc
 = 1;

3095 
xi
=0; xi<
o
->
xc
; xi++)

3097 if((
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, 
o
->
xs
[
xi
])è=ğ
NULL
)

3099 
	`sÿm³r_debug
(
__func__
, "could‚Ù„esŞv%s", 
o
->
xs
[
xi
]);

3100 
”r
;

3102 if(
	`sÿm³r_d—lŸs_´efixsÿn_xs_add
(
d
, 
d¡
) != 0)

3104 
	`sÿm³r_debug
(
__func__
, "could‚Ù‡dd % tØxs", 
o
->
xs
[
xi
]);

3105 
”r
;

3107 
	`sÿm³r_addr_ä“
(
d¡
); d¡ = 
NULL
;

3112 
”r
:

3114 
	}
}

3116 
	$d—lŸs_®loc_bump
(
sÿm³r_d—lŸs_t
 *
d
, 
d—lŸs_İtiÚs_t
 *
o
)

3118 
sÿm³r_d—lŸs_bump_t
 *
bump
 = 
NULL
;

3119 
sÿm³r_d—lŸs_´obedef_t
 
pd
[2];

3120 
i
;

3122 
	`mem£t
(&
pd
, 0, (pd));

3124 if(
o
->
´obedefc
 !ğ2 || o->
xc
 !ğ0 || o->
dpÜt
 !ğ0 || o->
¥Üt
 != 0 ||

3125 
o
->
‰l
 !ğ0 || o->
»¶yc
 !ğ0 || o->
shufæe
 !ğ0 || o->
addr
 !ğ
NULL
 ||

3126 (
o
->
š£q
 !ğ0 && o->
fudge
 != 0))

3128 
	`sÿm³r_debug
(
__func__
, "invalid…arameters for bump");

3129 
”r
;

3132 if(
o
->
wa™_´obe
 == 0) o->wait_probe = 1000;

3133 if(
o
->
©‹m±s
 == 0) o->attempts = 3;

3134 if(
o
->
fudge
 == 0) o->fudge = 30;

3136 
i
=0; i<2; i++)

3138 if(
	`d—lŸs_´obedef_¬gs
(&
pd
[
i
], 
o
->
´obedefs
[i]) != 0)

3140 
	`sÿm³r_debug
(
__func__
, "could‚Ù„—d bum°´obedeà%d", 
i
);

3141 
”r
;

3143 if(
pd
[
i
].
d¡
 =ğ
NULL
)

3145 
	`sÿm³r_debug
(
__func__
, "missšg d¡‡dd»s š…robedeà%d", 
i
);

3146 
”r
;

3148 if(
pd
[
i
].
d¡
->
ty³
 !ğ
SCAMPER_ADDR_TYPE_IPV4
)

3150 
	`sÿm³r_debug
(
__func__
, "d¡‡dd»s nÙ IPv4 iÀ´obedeà%d", 
i
);

3151 
”r
;

3153 
pd
[
i
].
id
 = i;

3156 if(
	`sÿm³r_d—lŸs_bump_®loc
(
d
) != 0)

3158 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc bump structure");

3159 
”r
;

3161 
bump
 = 
d
->
d©a
;

3163 
bump
->
©‹m±s
 = 
o
->attempts;

3164 
bump
->
wa™_´obe
 = 
o
->wait_probe;

3165 
bump
->
bump_lim™
 = 
o
->
fudge
;

3166 
	`memıy
(
bump
->
´obedefs
, 
pd
, (bump->probedefs));

3170 
”r
:

3171 if(
pd
[0].
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pd[0].dst);

3172 if(
pd
[1].
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pd[1].dst);

3174 
	}
}

3184 *
	$sÿm³r_do_d—lŸs_®loc
(*
¡r
)

3186 (*cÚ¡ 
®loc_func
[])(
sÿm³r_d—lŸs_t
 *, 
d—lŸs_İtiÚs_t
 *) = {

3187 
d—lŸs_®loc_m”ÿtÜ
,

3188 
d—lŸs_®loc_®ly
,

3189 
d—lŸs_®loc_¿d¬gun
,

3190 
d—lŸs_®loc_´efixsÿn
,

3191 
d—lŸs_®loc_bump
,

3193 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

3194 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
NULL
;

3195 
d—lŸs_İtiÚs_t
 
o
;

3196 
ušt8_t
 
m‘hod
 = 
SCAMPER_DEALIAS_METHOD_MERCATOR
;

3197 
ušt32_t
 
u£rid
 = 0;

3198 
size_t
 
Ën
;

3199 
tmp
 = 0;

3201 
	`mem£t
(&
o
, 0, (o));

3204 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
o
.
addr
) != 0)

3206 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse command");

3207 
”r
;

3210 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

3212 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

3213 
	`d—lŸs_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

3215 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

3216 
”r
;

3219 
İt
->
id
)

3221 
DEALIAS_OPT_METHOD
:

3222 
m‘hod
 = (
ušt8_t
)
tmp
;

3225 
DEALIAS_OPT_USERID
:

3226 
u£rid
 = (
ušt32_t
)
tmp
;

3229 
DEALIAS_OPT_OPTION
:

3230 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "nobs") == 0)

3231 
o
.
nobs
 = 1;

3232 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "shuffle") == 0)

3233 
o
.
shufæe
 = 1;

3234 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "inseq") == 0)

3235 
o
.
š£q
 = 1;

3238 
	`sÿm³r_debug
(
__func__
, "unknowÀİtiÚ %s", 
İt
->
¡r
);

3239 
”r
;

3243 
DEALIAS_OPT_ATTEMPTS
:

3244 
o
.
©‹m±s
 = (
ušt8_t
)
tmp
;

3247 
DEALIAS_OPT_DPORT
:

3248 
o
.
dpÜt
 = (
ušt16_t
)
tmp
;

3251 
DEALIAS_OPT_SPORT
:

3252 
o
.
¥Üt
 = (
ušt16_t
)
tmp
;

3255 
DEALIAS_OPT_FUDGE
:

3256 
o
.
fudge
 = (
ušt16_t
)
tmp
;

3259 
DEALIAS_OPT_TTL
:

3260 
o
.
‰l
 = (
ušt8_t
)
tmp
;

3263 
DEALIAS_OPT_PROBEDEF
:

3264 
Ën
 = (*è* (
o
.
´obedefc
+1);

3265 if(
	`»®loc_w¿p
((**)&
o
.
´obedefs
, 
Ën
) != 0)

3267 
	`sÿm³r_debug
(
__func__
, "could‚ot„ealloc…robedefs");

3268 
”r
;

3270 
o
.
´obedefs
[o.
´obedefc
++] = 
İt
->
¡r
;

3273 
DEALIAS_OPT_WAIT_TIMEOUT
:

3274 
o
.
wa™_timeout
 = (
ušt8_t
)
tmp
;

3277 
DEALIAS_OPT_WAIT_PROBE
:

3278 
o
.
wa™_´obe
 = (
ušt16_t
)
tmp
;

3281 
DEALIAS_OPT_WAIT_ROUND
:

3282 
o
.
wa™_round
 = (
ušt32_t
)
tmp
;

3285 
DEALIAS_OPT_EXCLUDE
:

3286 
Ën
 = (*è* (
o
.
xc
+1);

3287 if(
	`»®loc_w¿p
((**)&
o
.
xs
, 
Ën
) != 0)

3289 
	`sÿm³r_debug
(
__func__
, "could‚ot„eallocƒxcludes");

3290 
”r
;

3292 
o
.
xs
[o.
xc
++] = 
İt
->
¡r
;

3295 
DEALIAS_OPT_REPLYC
:

3296 
o
.
»¶yc
 = (
ušt8_t
)
tmp
;

3300 
	`sÿm³r_debug
(
__func__
, "unhªdËd o±iÚ %d", 
İt
->
id
);

3301 
”r
;

3305 
	`sÿm³r_İtiÚs_ä“
(
İts_out
);

3306 
İts_out
 = 
NULL
;

3308 if(
o
.
wa™_timeout
 == 0)

3309 
o
.
wa™_timeout
 = 5;

3311 if((
d—lŸs
 = 
	`sÿm³r_d—lŸs_®loc
()è=ğ
NULL
)

3313 
	`sÿm³r_debug
(
__func__
, "could‚ot‡lloc dealias structure");

3314 
”r
;

3316 
d—lŸs
->
m‘hod
 = method;

3317 
d—lŸs
->
u£rid
 = userid;

3318 if(
®loc_func
[
m‘hod
-1](
d—lŸs
, &
o
) != 0)

3319 
”r
;

3321 if(
o
.
´obedefs
 !ğ
NULL
)

3322 
	`ä“
(
o
.
´obedefs
);

3324  
d—lŸs
;

3326 
”r
:

3327 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

3328 if(
o
.
´obedefs
 !ğ
NULL
è
	`ä“
(o.probedefs);

3329 if(
d—lŸs
 !ğ
NULL
è
	`sÿm³r_d—lŸs_ä“
(dealias);

3330  
NULL
;

3331 
	}
}

3338 
	$sÿm³r_do_d—lŸs_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

3340  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

3341 
d—lŸs_¬g_·¿m_v®id©e
);

3342 
	}
}

3344 
	$sÿm³r_do_d—lŸs_ä“
(*
d©a
)

3346 
	`sÿm³r_d—lŸs_ä“
((
sÿm³r_d—lŸs_t
 *)
d©a
);

3348 
	}
}

3350 
	$´obedef2sig
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_d—lŸs_´obedef_t
 *
def
)

3352 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

3353 
buf
[32];

3355 if(
def
->
¤c
 =ğ
NULL
 && (def->¤øğ
	`sÿm³r_g‘¤c
(def->
d¡
, 0)) == NULL)

3357 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get src‡ddress for %s",

3358 
	`sÿm³r_addr_to¡r
(
def
->
d¡
, 
buf
, (buf)));

3359 
”r
;

3363 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

3364 
”r
;

3365 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
def
->
d¡
);

3366 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
def
->
¤c
);

3369 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

3370 
”r
;

3374 
”r
:

3375 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

3377 
	}
}

3379 
sÿm³r_sk_t
 *
	$sÿm³r_do_d—lŸs_®loùask
(*
d©a
,

3380 
sÿm³r_li¡_t
 *
li¡
,

3381 
sÿm³r_cyşe_t
 *
cyşe
)

3383 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = (sÿm³r_d—lŸs_ˆ*)
d©a
;

3384 
d—lŸs_¡©e_t
 *
¡©e
 = 
NULL
;

3385 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

3386 
sÿm³r_d—lŸs_´obedef_t
 *
def
;

3387 
sÿm³r_d—lŸs_´efixsÿn_t
 *
pfxsÿn
;

3388 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
;

3389 
sÿm³r_d—lŸs_¿d¬gun_t
 *
¿d¬gun
;

3390 
sÿm³r_d—lŸs_®ly_t
 *
®ly
;

3391 
sÿm³r_d—lŸs_bump_t
 *
bump
;

3392 
d—lŸs_´efixsÿn_t
 *
pf¡©e
;

3393 
ušt32_t
 
p
;

3394 
i
;

3397 if((
sk
 = 
	`sÿm³r_sk_®loc
(
d—lŸs
, &
funcs
)è=ğ
NULL
)

3398 
”r
;

3400 if((
¡©e
 = 
	`m®loc_z”o
((
d—lŸs_¡©e_t
))è=ğ
NULL
 ||

3401 (
¡©e
->
»ûÁ_´obes
 = 
	`dli¡_®loc
()è=ğ
NULL
 ||

3402 (
¡©e
->
±bq
 = 
	`¦i¡_®loc
()è=ğ
NULL
 ||

3403 (
¡©e
->
disÿrd
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

3405 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

3406 
”r
;

3408 
¡©e
->
id
 = 255;

3410 if(
d—lŸs
->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_MERCATOR
)

3412 
m”ÿtÜ
 = 
d—lŸs
->
d©a
;

3413 if(
	`´obedef2sig
(
sk
, &
m”ÿtÜ
->
´obedef
) != 0)

3414 
”r
;

3415 
¡©e
->
´obedefs
 = &
m”ÿtÜ
->
´obedef
;

3416 
¡©e
->
´obedefc
 = 1;

3418 if(
d—lŸs
->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_ALLY
)

3420 
®ly
 = 
d—lŸs
->
d©a
;

3421 
i
=0; i<2; i++)

3422 if(
	`´obedef2sig
(
sk
, &
®ly
->
´obedefs
[
i
]) != 0)

3423 
”r
;

3424 
¡©e
->
´obedefs
 = 
®ly
->probedefs;

3425 
¡©e
->
´obedefc
 = 2;

3427 if(
d—lŸs
->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_RADARGUN
)

3429 
¿d¬gun
 = 
d—lŸs
->
d©a
;

3430 
p
=0;…<
¿d¬gun
->
´obedefc
;…++)

3431 if(
	`´obedef2sig
(
sk
, &
¿d¬gun
->
´obedefs
[
p
]) != 0)

3432 
”r
;

3434 
¡©e
->
´obedefs
 = 
¿d¬gun
->probedefs;

3435 
¡©e
->
´obedefc
 = 
¿d¬gun
->probedefc;

3436 if(
	`d—lŸs_¿d¬gun_®loc
(
¿d¬gun
, 
¡©e
) != 0)

3437 
”r
;

3439 if(
d—lŸs
->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_PREFIXSCAN
)

3441 if(
	`d—lŸs_´efixsÿn_®loc
(
d—lŸs
, 
¡©e
) != 0)

3442 
”r
;

3443 
pfxsÿn
 = 
d—lŸs
->
d©a
;

3444 if(
	`´obedef2sig
(
sk
, &
pfxsÿn
->
´obedefs
[0]) != 0)

3445 
”r
;

3446 
¡©e
->
´obedefs
 = 
pfxsÿn
->probedefs;

3447 
¡©e
->
´obedefc
 = 
pfxsÿn
->probedefc;

3449 
pf¡©e
 = 
¡©e
->
m‘hod¡©e
;

3450 
i
=0; i<
pf¡©e
->
´obedefc
; i++)

3452 if(
	`´obedef2sig
(
sk
, &
pf¡©e
->
´obedefs
[
i
]) != 0)

3453 
”r
;

3456 if(
d—lŸs
->
m‘hod
 =ğ
SCAMPER_DEALIAS_METHOD_BUMP
)

3458 
bump
 = 
d—lŸs
->
d©a
;

3459 
i
=0; i<2; i++)

3460 if(
	`´obedef2sig
(
sk
, &
bump
->
´obedefs
[
i
]) != 0)

3461 
”r
;

3463 
¡©e
->
´obedefs
 = 
bump
->probedefs;

3464 
¡©e
->
´obedefc
 = 2;

3465 if(
	`d—lŸs_bump_®loc
(
¡©e
) != 0)

3466 
”r
;

3468 
”r
;

3470 
i
=0; i<
¡©e
->
´obedefc
; i++)

3472 
def
 = &
¡©e
->
´obedefs
[
i
];

3473 if(
def
->
mtu
 != 0)

3474 
¡©e
->
æags
 |ğ
DEALIAS_STATE_FLAG_DL
;

3475 if(
	`d—lŸs_´obedef_add
(
¡©e
, 
def
) != 0)

3476 
”r
;

3480 
d—lŸs
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

3481 
d—lŸs
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

3483 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

3484 
¡©e
 = 
NULL
;

3486  
sk
;

3488 
”r
:

3489 if(
sk
 !ğ
NULL
)

3491 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

3492 
	`sÿm³r_sk_ä“
(
sk
);

3494 if(
¡©e
 !ğ
NULL
è
	`d—lŸs_¡©e_ä“
(
d—lŸs
, state);

3495  
NULL
;

3496 
	}
}

3498 
	$sÿm³r_do_d—lŸs_ş—nup
()

3500 if(
pktbuf
 !ğ
NULL
)

3502 
	`ä“
(
pktbuf
);

3503 
pktbuf
 = 
NULL
;

3507 
	}
}

3509 
	$sÿm³r_do_d—lŸs_š™
()

3511 
funcs
.
´obe
 = 
do_d—lŸs_´obe
;

3512 
funcs
.
hªdË_icmp
 = 
do_d—lŸs_hªdË_icmp
;

3513 
funcs
.
hªdË_timeout
 = 
do_d—lŸs_hªdË_timeout
;

3514 
funcs
.
hªdË_dl
 = 
do_d—lŸs_hªdË_dl
;

3515 
funcs
.
wr™e
 = 
do_d—lŸs_wr™e
;

3516 
funcs
.
sk_ä“
 = 
do_d—lŸs_ä“
;

3517 
funcs
.
h®t
 = 
do_d—lŸs_h®t
;

3520 
	}
}

	@dealias/scamper_dealias_do.h

28 #iâdeà
__SCAMPER_DO_DEALIAS_H


29 
	#__SCAMPER_DO_DEALIAS_H


	)

31 *
sÿm³r_do_d—lŸs_®loc
(*
¡r
);

33 
sÿm³r_sk_t
 *
sÿm³r_do_d—lŸs_®loùask
(*
d©a
,

34 
sÿm³r_li¡_t
 *
li¡
,

35 
sÿm³r_cyşe_t
 *
cyşe
);

37 
sÿm³r_do_d—lŸs_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

39 
sÿm³r_do_d—lŸs_ä“
(*);

41 cÚ¡ *
sÿm³r_do_d—lŸs_u§ge
();

43 
sÿm³r_do_d—lŸs_ş—nup
();

44 
sÿm³r_do_d—lŸs_š™
();

	@dealias/scamper_dealias_json.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_d—lŸs.h
"

38 
	~"sÿm³r_fe.h
"

39 
	~"sÿm³r_d—lŸs_jsÚ.h
"

41 
	~"uts.h
"

43 *
	$d—lŸs_h—d”_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
)

45 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
mc
;

46 
sÿm³r_d—lŸs_®ly_t
 *
®ly
;

47 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
;

48 
sÿm³r_d—lŸs_´efixsÿn_t
 *
pf
;

49 
sÿm³r_d—lŸs_bump_t
 *
bump
;

50 
buf
[512], 
tmp
[64];

51 
size_t
 
off
 = 0;

52 
ušt16_t
 
u16
;

54 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

56 
	`sÿm³r_d—lŸs_m‘hod_to¡r
(
d—lŸs
, 
tmp
, (tmp)));

57 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"userid\":%u, \"result\":\"%s\"",

58 
d—lŸs
->
u£rid
,

59 
	`sÿm³r_d—lŸs_»suÉ_to¡r
(
d—lŸs
, 
tmp
, (tmp)));

60 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"start\":{\"sec\":%u, \"usec\":%u}",

61 
d—lŸs
->
¡¬t
.
tv_£c
, d—lŸs->¡¬t.
tv_u£c
);

63 if(
	`SCAMPER_DEALIAS_METHOD_IS_MERCATOR
(
d—lŸs
))

65 
mc
 = 
d—lŸs
->
d©a
;

66 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

68 
mc
->
©‹m±s
, mc->
wa™_timeout
);

70 if(
	`SCAMPER_DEALIAS_METHOD_IS_ALLY
(
d—lŸs
))

72 
®ly
 = 
d—lŸs
->
d©a
;

73 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

75 
®ly
->
wa™_´obe
,‡Îy->
wa™_timeout
);

76 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"attempts\":%u, \"fudge\":%u",

77 
®ly
->
©‹m±s
,‡Îy->
fudge
);

80 if(
	`SCAMPER_DEALIAS_METHOD_IS_RADARGUN
(
d—lŸs
))

82 
rg
 = 
d—lŸs
->
d©a
;

83 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"attempts\":%u, \"wait_probe\":%u",

84 
rg
->
©‹m±s
,„g->
wa™_´obe
);

85 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"wait_round\":%u, \"wait_timeout\":%u",

86 
rg
->
wa™_round
,„g->
wa™_timeout
);

89 if(
	`SCAMPER_DEALIAS_METHOD_IS_PREFIXSCAN
(
d—lŸs
))

91 
pf
 = 
d—lŸs
->
d©a
;

92 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"a\":\"%s\"",

93 
	`sÿm³r_addr_to¡r
(
pf
->
a
, 
tmp
, (tmp)));

94 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"b\":\"%s/%u\"",

95 
	`sÿm³r_addr_to¡r
(
pf
->
b
, 
tmp
, Ñmp)),…f->
´efix
);

96 if(
pf
->
ab
 !ğ
NULL
)

97 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"ab\":\"%s/%u\"",

98 
	`sÿm³r_addr_to¡r
(
pf
->
ab
, 
tmp
, (tmp)),

99 
	`sÿm³r_addr_´efixho¡s
(
pf
->
b
,…f->
ab
));

100 if(
pf
->
xc
 > 0)

102 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"xs\":[\"%s\"",

103 
	`sÿm³r_addr_to¡r
(
pf
->
xs
[0], 
tmp
, (tmp)));

104 
u16
=1; u16 < 
pf
->
xc
; u16++)

105 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"%s\"",

106 
	`sÿm³r_addr_to¡r
(
pf
->
xs
[
u16
], 
tmp
, (tmp)));

107 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "]");

109 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

111 
pf
->
©‹m±s
,…f->
»¶yc
,…f->
fudge
);

112 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

114 
pf
->
wa™_´obe
,…f->
wa™_timeout
);

117 if(
	`SCAMPER_DEALIAS_METHOD_IS_BUMP
(
d—lŸs
))

119 
bump
 = 
d—lŸs
->
d©a
;

120 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

122 
bump
->
wa™_´obe
, bump->
bump_lim™
, bump->
©‹m±s
);

125  
	`¡rdup
(
buf
);

126 
	}
}

128 *
	$d—lŸs_´obedef_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_´obedef_t
 *
def
)

130 
buf
[256], 
tmp
[64];

131 
size_t
 
off
 = 0;

132 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "{\"id\":%u, \"src\":\"%s\"",

133 
def
->
id
, 
	`sÿm³r_addr_to¡r
(def->
¤c
, 
tmp
, (tmp)));

134 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"dst\":\"%s\", \"ttl\":%u, \"size\":%u",

135 
	`sÿm³r_addr_to¡r
(
def
->
d¡
, 
tmp
, Ñmp)), def->
‰l
, def->
size
);

136 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"method\":\"%s\"",

137 
	`sÿm³r_d—lŸs_´obedef_m‘hod_to¡r
(
def
, 
tmp
, (tmp)));

138 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
def
))

139 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"icmp_id\":%u, \"icmp_csum\":%u",

140 
def
->
un
.
icmp
.
id
, def->un.icmp.
csum
);

141 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
def
))

142 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"udp_sport\":%u, \"udp_dport\":%u",

143 
def
->
un
.
udp
.
¥Üt
, def->un.udp.
dpÜt
);

144 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
def
))

145 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

147 
def
->
un
.
tı
.
¥Üt
, def->un.tı.
dpÜt
, def->un.tı.
æags
);

148 if(
def
->
mtu
 > 0)

149 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"mtu\":%u", 
def
->
mtu
);

150 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "}");

151  
	`¡rdup
(
buf
);

152 
	}
}

154 
	$d—lŸs_´obedefs_g‘
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
,

155 
sÿm³r_d—lŸs_´obedef_t
 **
defs
, *
defc
)

157 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
mc
;

158 
sÿm³r_d—lŸs_®ly_t
 *
®ly
;

159 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
;

160 
sÿm³r_d—lŸs_´efixsÿn_t
 *
pf
;

161 
sÿm³r_d—lŸs_bump_t
 *
bump
;

163 
d—lŸs
->
m‘hod
)

165 
SCAMPER_DEALIAS_METHOD_MERCATOR
:

166 
mc
 = 
d—lŸs
->
d©a
;

167 *
defs
 = &
mc
->
´obedef
; *
defc
 = 1;

170 
SCAMPER_DEALIAS_METHOD_ALLY
:

171 
®ly
 = 
d—lŸs
->
d©a
;

172 *
defs
 = 
®ly
->
´obedefs
; *
defc
 = 2;

175 
SCAMPER_DEALIAS_METHOD_RADARGUN
:

176 
rg
 = 
d—lŸs
->
d©a
;

177 *
defs
 = 
rg
->
´obedefs
; *
defc
 =„g->
´obedefc
;

180 
SCAMPER_DEALIAS_METHOD_PREFIXSCAN
:

181 
pf
 = 
d—lŸs
->
d©a
;

182 *
defs
 = 
pf
->
´obedefs
; *
defc
 =…f->
´obedefc
;

185 
SCAMPER_DEALIAS_METHOD_BUMP
:

186 
bump
 = 
d—lŸs
->
d©a
;

187 *
defs
 = 
bump
->
´obedefs
; *
defc
 = 2;

195 
	}
}

197 *
	$d—lŸs_»¶y_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
)

199 
buf
[256], 
tmp
[64];

200 
size_t
 
off
 = 0;

201 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

203 
	`sÿm³r_addr_to¡r
(
»¶y
->
¤c
, 
tmp
, (tmp)),

204 
»¶y
->
rx
.
tv_£c
,„•ly->rx.
tv_u£c
,„•ly->
‰l
);

205 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
»¶y
->
¤c
))

206 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"id\": %u", 
»¶y
->
id
);

207 if(
»¶y
->
æags
 & 
SCAMPER_DEALIAS_REPLY_FLAG_IPID32
)

208 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"id\": %u", 
»¶y
->
id32
);

209 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"´Ùo\":%u", 
»¶y
->
´Ùo
);

211 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
))

213 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"icmp_type\":%u, \"icmp_code\":%u",

214 
»¶y
->
icmp_ty³
,„•ly->
icmp_code
);

216 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_UNREACH
(
»¶y
) ||

217 
	`SCAMPER_DEALIAS_REPLY_IS_ICMP_TTL_EXP
(
»¶y
))

218 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

219 ", \"icmp_q_‰l\":%u",
»¶y
->
icmp_q__‰l
);

221 if(
	`SCAMPER_DEALIAS_REPLY_IS_TCP
(
»¶y
))

223 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"tı_æags\":%u", 
»¶y
->
tı_æags
);

226 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "}");

227  
	`¡rdup
(
buf
);

228 
	}
}

230 *
	$d—lŸs_´obe_to¡r
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
´obe
)

232 
h—d”
[256], **
»¶›s
 = 
NULL
, *
rc
 = NULL, *
¡r
 = NULL;

233 
size_t
 
Ën
, 
wc
 = 0, 
h—d”_Ën
 = 0, *
»¶y_Ëns
 = 
NULL
;

234 
i
;

236 
	`¡ršg_cÚÿt
(
h—d”
, (h—d”), &
h—d”_Ën
,

238 
´obe
->
def
->
id
,…robe->
£q
,…robe->
tx
.
tv_£c
,…robe->tx.
tv_u£c
);

239 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´obe
->
def
->
d¡
))

240 
	`¡ršg_cÚÿt
(
h—d”
, (h—d”), &
h—d”_Ën
, ", \"id\":%u", 
´obe
->
id
);

241 
	`¡ršg_cÚÿt
(
h—d”
, (h—d”), &
h—d”_Ën
, ", \"replies\":[");

242 
Ën
 = 
h—d”_Ën
;

243 if(
´obe
->
»¶yc
 > 0)

245 if((
»¶›s
 = 
	`m®loc_z”o
((*è* 
´obe
->
»¶yc
)è=ğ
NULL
 ||

246 (
»¶y_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
´obe
->
»¶yc
)è=ğ
NULL
)

247 
dÚe
;

248 
i
=0; i<
´obe
->
»¶yc
; i++)

250 if(
i
 > 0è
Ën
 += 2;

251 if((
»¶›s
[
i
] = 
	`d—lŸs_»¶y_to¡r
(
´obe
->»¶›s[i])è=ğ
NULL
)

252 
dÚe
;

253 
»¶y_Ëns
[
i
] = 
	`¡¾’
(
»¶›s
[i]);

254 
Ën
 +ğ
»¶y_Ëns
[
i
];

257 
Ën
 += 3;

259 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

260 
dÚe
;

261 
	`memıy
(
¡r
, 
h—d”
, 
h—d”_Ën
); 
wc
 += header_len;

262 if(
´obe
->
»¶yc
 > 0)

264 
i
=0; i<
´obe
->
»¶yc
; i++)

266 if(
i
 > 0)

268 
	`memıy
(
¡r
+
wc
, ", ", 2);

269 
wc
 += 2;

271 
	`memıy
(
¡r
+
wc
, 
»¶›s
[
i
], 
»¶y_Ëns
[i]);

272 
wc
 +ğ
»¶y_Ëns
[
i
];

275 
	`memıy
(
¡r
+
wc
, "]}\0", 3); wc += 3;

276 
	`as£¹
(
wc
 =ğ
Ën
);

278 
rc
 = 
¡r
;

280 
dÚe
:

281 if(
rc
 =ğ
NULL
 && 
¡r
 != NULL)

282 
	`ä“
(
¡r
);

283 if(
»¶›s
 !ğ
NULL
) {

284 
i
=0; i<
´obe
->
»¶yc
; i++)

285 if(
»¶›s
[
i
] !ğ
NULL
)

286 
	`ä“
(
»¶›s
[
i
]);

287 
	`ä“
(
»¶›s
);

289 if(
»¶y_Ëns
 !ğ
NULL
)

290 
	`ä“
(
»¶y_Ëns
);

291  
rc
;

292 
	}
}

294 
	$sÿm³r_fe_jsÚ_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

295 cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
)

297 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

298 
off_t
 
off
 = 0;

299 *
¡r
 = 
NULL
;

300 
size_t
 
Ën
 = 0;

301 
size_t
 
wc
 = 0;

302 *
h—d”
 = 
NULL
;

303 
size_t
 
h—d”_Ën
 = 0;

304 **
pds
 = 
NULL
;

305 
size_t
 *
pd_Ëns
 = 
NULL
;

306 **
´s
 = 
NULL
;

307 
size_t
 *
´_Ëns
 = 
NULL
;

308 
i
, 
rc
 = -1;

310 
sÿm³r_d—lŸs_´obedef_t
 *
defs
; 
defc
;

313 if(
fd
 !ğ1 && (
off
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1)

317 if((
h—d”
 = 
	`d—lŸs_h—d”_to¡r
(
d—lŸs
)è=ğ
NULL
)

318 
ş—nup
;

319 
Ën
 = (
h—d”_Ën
 = 
	`¡¾’
(
h—d”
));

320 
Ën
 += 2;

323 if(
	`d—lŸs_´obedefs_g‘
(
d—lŸs
, &
defs
, &
defc
) != 0 ||

324 (
pds
 = 
	`m®loc_z”o
((*è* 
defc
)è=ğ
NULL
 ||

325 (
pd_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
defc
)è=ğ
NULL
)

326 
ş—nup
;

327 
Ën
 += 16;

328 
i
=0; i<
defc
; i++)

330 if(
i
 > 0è
Ën
 += 2;

331 
pds
[
i
] = 
	`d—lŸs_´obedef_to¡r
(&
defs
[i]);

332 
pd_Ëns
[
i
] = 
	`¡¾’
(
pds
[i]);

333 
Ën
 +ğ
pd_Ëns
[
i
];

337 
Ën
 += 13;

338 if(
d—lŸs
->
´obec
 > 0)

340 if((
´s
 = 
	`m®loc_z”o
((*è* 
d—lŸs
->
´obec
)è=ğ
NULL
 ||

341 (
´_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
d—lŸs
->
´obec
)è=ğ
NULL
)

342 
ş—nup
;

344 
i
=0; i<
d—lŸs
->
´obec
; i++)

346 if(
i
 > 0è
Ën
 += 2;

347 if((
´s
[
i
] = 
	`d—lŸs_´obe_to¡r
(
d—lŸs
->
´obes
[i])è=ğ
NULL
)

348 
ş—nup
;

349 
´_Ëns
[
i
] = 
	`¡¾’
(
´s
[i]);

350 
Ën
 +ğ
´_Ëns
[
i
];

354 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

355 
ş—nup
;

356 
	`memıy
(
¡r
+
wc
, 
h—d”
, 
h—d”_Ën
); wc += header_len;

357 
	`memıy
(
¡r
+
wc
, ", \"probedefs\":[", 15); wc += 15;

358 
i
=0; i<
defc
; i++)

360 if(
i
 > 0)

362 
	`memıy
(
¡r
+
wc
, ", ", 2);

363 
wc
 += 2;

365 
	`memıy
(
¡r
+
wc
, 
pds
[
i
], 
pd_Ëns
[i]);

366 
wc
 +ğ
pd_Ëns
[
i
];

368 
	`memıy
(
¡r
+
wc
, "]", 1); wc++;

369 
	`memıy
(
¡r
+
wc
, ", \"probes\":[", 12); wc += 12;

370 if(
d—lŸs
->
´obec
 > 0)

372 
i
=0; i<
d—lŸs
->
´obec
; i++)

374 if(
i
 > 0 )

376 
	`memıy
(
¡r
+
wc
, ", ", 2);

377 
wc
 += 2;

379 
	`memıy
(
¡r
+
wc
, 
´s
[
i
], 
´_Ëns
[i]);

380 
wc
 +ğ
´_Ëns
[
i
];

383 
	`memıy
(
¡r
+
wc
, "]", 1); wc++;

384 
	`memıy
(
¡r
+
wc
, "}\n", 2); wc += 2;

386 
	`as£¹
(
wc
 =ğ
Ën
);

392 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
Ën
) != 0)

394 if(
fd
 != 1)

396 if(
	`árunÿ‹
(
fd
, 
off
) != 0)

397 
ş—nup
;

399 
ş—nup
;

401 
rc
 = 0;

403 
ş—nup
:

404 if(
¡r
 !ğ
NULL
è
	`ä“
(str);

405 if(
h—d”
 !ğ
NULL
è
	`ä“
(header);

406 if(
pd_Ëns
 !ğ
NULL
è
	`ä“
(pd_lens);

407 if(
´_Ëns
 !ğ
NULL
è
	`ä“
(pr_lens);

408 if(
pds
 !ğ
NULL
)

410 
i
=0; i<
defc
; i++)

411 if(
pds
[
i
] !ğ
NULL
)

412 
	`ä“
(
pds
[
i
]);

413 
	`ä“
(
pds
);

415 if(
´s
 !ğ
NULL
)

417 
i
=0; i<
d—lŸs
->
´obec
; i++)

418 if(
´s
[
i
] !ğ
NULL
)

419 
	`ä“
(
´s
[
i
]);

420 
	`ä“
(
´s
);

422  
rc
;

423 
	}
}

	@dealias/scamper_dealias_json.h

23 #iâdeà
__SCAMPER_DEALIAS_JSON_H


24 
	#__SCAMPER_DEALIAS_JSON_H


	)

26 
sÿm³r_fe_jsÚ_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_d—lŸs
 *
d—lŸs
);

	@dealias/scamper_dealias_text.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_d—lŸs.h
"

39 
	~"sÿm³r_d—lŸs_‹xt.h
"

40 
	~"uts.h
"

42 
	$sÿm³r_fe_‹xt_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

43 cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
)

45 
sÿm³r_d—lŸs_®ly_t
 *
®ly
;

46 
buf
[256], 
a
[64], 
b
[64], 
c
[32];

47 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

49 if(
	`SCAMPER_DEALIAS_METHOD_IS_ALLY
(
d—lŸs
))

51 
®ly
 = 
d—lŸs
->
d©a
;

52 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_ALIASES
)

53 
	`¢´štf
(
c
, (c), "aliases");

54 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_NOTALIASES
)

55 
	`¢´štf
(
c
, (c), "not‡liases");

56 if(
d—lŸs
->
»suÉ
 =ğ
SCAMPER_DEALIAS_RESULT_NONE
)

57 
	`¢´štf
(
c
, (c), "none");

59 
	`¢´štf
(
c
, (c), "%d", 
d—lŸs
->
»suÉ
);

61 
	`¢´štf
(
buf
, (buf), "%s %s %s\n",

62 
	`sÿm³r_addr_to¡r
(
®ly
->
´obedefs
[0].
d¡
, 
a
, (a)),

63 
	`sÿm³r_addr_to¡r
(
®ly
->
´obedefs
[1].
d¡
, 
b
, (b)),

64 
c
);

66 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
	`¡¾’
(buf));

69 
	}
}

	@dealias/scamper_dealias_text.h

24 #iâdeà
__SCAMPER_FILE_TEXT_DEALIAS_H


25 
	#__SCAMPER_FILE_TEXT_DEALIAS_H


	)

27 
sÿm³r_fe_‹xt_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

28 cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
);

	@dealias/scamper_dealias_warts.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_li¡.h
"

38 
	~"sÿm³r_icm³xt.h
"

39 
	~"sÿm³r_d—lŸs.h
"

40 
	~"sÿm³r_fe.h
"

41 
	~"sÿm³r_fe_w¬ts.h
"

42 
	~"sÿm³r_d—lŸs_w¬ts.h
"

44 
	~"mjl_¥ÏyŒ“.h
"

45 
	~"uts.h
"

47 
	#WARTS_DEALIAS_LIST_ID
 1

	)

48 
	#WARTS_DEALIAS_CYCLE_ID
 2

	)

49 
	#WARTS_DEALIAS_START
 3

	)

50 
	#WARTS_DEALIAS_METHOD
 4

	)

51 
	#WARTS_DEALIAS_RESULT
 5

	)

52 
	#WARTS_DEALIAS_PROBEC
 6

	)

53 
	#WARTS_DEALIAS_USERID
 7

	)

55 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_v¬s
[] =

57 {
WARTS_DEALIAS_LIST_ID
, 4, -1},

58 {
WARTS_DEALIAS_CYCLE_ID
, 4, -1},

59 {
WARTS_DEALIAS_START
, 8, -1},

60 {
WARTS_DEALIAS_METHOD
, 1, -1},

61 {
WARTS_DEALIAS_RESULT
, 1, -1},

62 {
WARTS_DEALIAS_PROBEC
, 4, -1},

63 {
WARTS_DEALIAS_USERID
, 4, -1},

65 
	#d—lŸs_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_v¬s
)

	)

67 
	#WARTS_DEALIAS_ALLY_WAIT_PROBE
 1

	)

68 
	#WARTS_DEALIAS_ALLY_WAIT_TIMEOUT
 2

	)

69 
	#WARTS_DEALIAS_ALLY_ATTEMPTS
 3

	)

70 
	#WARTS_DEALIAS_ALLY_FUDGE
 4

	)

71 
	#WARTS_DEALIAS_ALLY_FLAGS
 5

	)

73 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_®ly_v¬s
[] =

75 {
WARTS_DEALIAS_ALLY_WAIT_PROBE
, 2, -1},

76 {
WARTS_DEALIAS_ALLY_WAIT_TIMEOUT
, 1, -1},

77 {
WARTS_DEALIAS_ALLY_ATTEMPTS
, 1, -1},

78 {
WARTS_DEALIAS_ALLY_FUDGE
, 2, -1},

79 {
WARTS_DEALIAS_ALLY_FLAGS
, 1, -1},

81 
	#d—lŸs_®ly_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_®ly_v¬s
)

	)

83 
	#WARTS_DEALIAS_MERCATOR_ATTEMPTS
 1

	)

84 
	#WARTS_DEALIAS_MERCATOR_WAIT_TIMEOUT
 2

	)

86 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_m”ÿtÜ_v¬s
[] =

88 {
WARTS_DEALIAS_MERCATOR_ATTEMPTS
, 1, -1},

89 {
WARTS_DEALIAS_MERCATOR_WAIT_TIMEOUT
, 1, -1},

91 
	#d—lŸs_m”ÿtÜ_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_m”ÿtÜ_v¬s
)

	)

93 
	#WARTS_DEALIAS_RADARGUN_PROBEDEFC
 1

	)

94 
	#WARTS_DEALIAS_RADARGUN_ATTEMPTS
 2

	)

95 
	#WARTS_DEALIAS_RADARGUN_WAIT_PROBE
 3

	)

96 
	#WARTS_DEALIAS_RADARGUN_WAIT_ROUND
 4

	)

97 
	#WARTS_DEALIAS_RADARGUN_WAIT_TIMEOUT
 5

	)

98 
	#WARTS_DEALIAS_RADARGUN_FLAGS
 6

	)

100 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_¿d¬gun_v¬s
[] =

102 {
WARTS_DEALIAS_RADARGUN_PROBEDEFC
, 4, -1},

103 {
WARTS_DEALIAS_RADARGUN_ATTEMPTS
, 2, -1},

104 {
WARTS_DEALIAS_RADARGUN_WAIT_PROBE
, 2, -1},

105 {
WARTS_DEALIAS_RADARGUN_WAIT_ROUND
, 4, -1},

106 {
WARTS_DEALIAS_RADARGUN_WAIT_TIMEOUT
, 1, -1},

107 {
WARTS_DEALIAS_RADARGUN_FLAGS
, 1, -1},

109 
	#d—lŸs_¿d¬gun_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_¿d¬gun_v¬s
)

	)

111 
	#WARTS_DEALIAS_PREFIXSCAN_A
 1

	)

112 
	#WARTS_DEALIAS_PREFIXSCAN_B
 2

	)

113 
	#WARTS_DEALIAS_PREFIXSCAN_AB
 3

	)

114 
	#WARTS_DEALIAS_PREFIXSCAN_XS
 4

	)

115 
	#WARTS_DEALIAS_PREFIXSCAN_PREFIX
 5

	)

116 
	#WARTS_DEALIAS_PREFIXSCAN_ATTEMPTS
 6

	)

117 
	#WARTS_DEALIAS_PREFIXSCAN_FUDGE
 7

	)

118 
	#WARTS_DEALIAS_PREFIXSCAN_WAIT_PROBE
 8

	)

119 
	#WARTS_DEALIAS_PREFIXSCAN_WAIT_TIMEOUT
 9

	)

120 
	#WARTS_DEALIAS_PREFIXSCAN_PROBEDEFC
 10

	)

121 
	#WARTS_DEALIAS_PREFIXSCAN_FLAGS
 11

	)

122 
	#WARTS_DEALIAS_PREFIXSCAN_REPLYC
 12

	)

124 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_´efixsÿn_v¬s
[] =

126 {
WARTS_DEALIAS_PREFIXSCAN_A
, -1, -1},

127 {
WARTS_DEALIAS_PREFIXSCAN_B
, -1, -1},

128 {
WARTS_DEALIAS_PREFIXSCAN_AB
, -1, -1},

129 {
WARTS_DEALIAS_PREFIXSCAN_XS
, -1, -1},

130 {
WARTS_DEALIAS_PREFIXSCAN_PREFIX
, 1, -1},

131 {
WARTS_DEALIAS_PREFIXSCAN_ATTEMPTS
, 1, -1},

132 {
WARTS_DEALIAS_PREFIXSCAN_FUDGE
, 2, -1},

133 {
WARTS_DEALIAS_PREFIXSCAN_WAIT_PROBE
, 2, -1},

134 {
WARTS_DEALIAS_PREFIXSCAN_WAIT_TIMEOUT
, 1, -1},

135 {
WARTS_DEALIAS_PREFIXSCAN_PROBEDEFC
, 2, -1},

136 {
WARTS_DEALIAS_PREFIXSCAN_FLAGS
, 1, -1},

137 {
WARTS_DEALIAS_PREFIXSCAN_REPLYC
, 1, -1},

139 
	#d—lŸs_´efixsÿn_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_´efixsÿn_v¬s
)

	)

141 
	#WARTS_DEALIAS_BUMP_WAIT_PROBE
 1

	)

142 
	#WARTS_DEALIAS_BUMP_BUMP_LIMIT
 2

	)

143 
	#WARTS_DEALIAS_BUMP_ATTEMPTS
 3

	)

145 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_bump_v¬s
[] =

147 {
WARTS_DEALIAS_BUMP_WAIT_PROBE
, 2, -1},

148 {
WARTS_DEALIAS_BUMP_BUMP_LIMIT
, 2, -1},

149 {
WARTS_DEALIAS_BUMP_ATTEMPTS
, 1, -1},

151 
	#d—lŸs_bump_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_bump_v¬s
)

	)

153 
	#WARTS_DEALIAS_PROBEDEF_DST_GID
 1

	)

154 
	#WARTS_DEALIAS_PROBEDEF_SRC_GID
 2

	)

155 
	#WARTS_DEALIAS_PROBEDEF_ID
 3

	)

156 
	#WARTS_DEALIAS_PROBEDEF_METHOD
 4

	)

157 
	#WARTS_DEALIAS_PROBEDEF_TTL
 5

	)

158 
	#WARTS_DEALIAS_PROBEDEF_TOS
 6

	)

159 
	#WARTS_DEALIAS_PROBEDEF_4BYTES
 7

	)

160 
	#WARTS_DEALIAS_PROBEDEF_TCP_FLAGS
 8

	)

161 
	#WARTS_DEALIAS_PROBEDEF_ICMP_ID
 9

	)

162 
	#WARTS_DEALIAS_PROBEDEF_DST
 10

	)

163 
	#WARTS_DEALIAS_PROBEDEF_SRC
 11

	)

164 
	#WARTS_DEALIAS_PROBEDEF_SIZE
 12

	)

165 
	#WARTS_DEALIAS_PROBEDEF_MTU
 13

	)

166 
	#WARTS_DEALIAS_PROBEDEF_ICMP_CSUM
 14

	)

168 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_´obedef_v¬s
[] =

170 {
WARTS_DEALIAS_PROBEDEF_DST_GID
, 4, -1},

171 {
WARTS_DEALIAS_PROBEDEF_SRC_GID
, 4, -1},

172 {
WARTS_DEALIAS_PROBEDEF_ID
, 4, -1},

173 {
WARTS_DEALIAS_PROBEDEF_METHOD
, 1, -1},

174 {
WARTS_DEALIAS_PROBEDEF_TTL
, 1, -1},

175 {
WARTS_DEALIAS_PROBEDEF_TOS
, 1, -1},

176 {
WARTS_DEALIAS_PROBEDEF_4BYTES
, 4, -1},

177 {
WARTS_DEALIAS_PROBEDEF_TCP_FLAGS
, 1, -1},

178 {
WARTS_DEALIAS_PROBEDEF_ICMP_ID
, 2, -1},

179 {
WARTS_DEALIAS_PROBEDEF_DST
, -1, -1},

180 {
WARTS_DEALIAS_PROBEDEF_SRC
, -1, -1},

181 {
WARTS_DEALIAS_PROBEDEF_SIZE
, 2, -1},

182 {
WARTS_DEALIAS_PROBEDEF_MTU
, 2, -1},

183 {
WARTS_DEALIAS_PROBEDEF_ICMP_CSUM
, 2, -1},

185 
	#d—lŸs_´obedef_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_´obedef_v¬s
)

	)

187 
	#WARTS_DEALIAS_PROBE_DEF
 1

	)

188 
	#WARTS_DEALIAS_PROBE_TX
 2

	)

189 
	#WARTS_DEALIAS_PROBE_REPLYC
 3

	)

190 
	#WARTS_DEALIAS_PROBE_IPID
 4

	)

191 
	#WARTS_DEALIAS_PROBE_SEQ
 5

	)

193 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_´obe_v¬s
[] =

195 {
WARTS_DEALIAS_PROBE_DEF
, 4, -1},

196 {
WARTS_DEALIAS_PROBE_TX
, 8, -1},

197 {
WARTS_DEALIAS_PROBE_REPLYC
, 2, -1},

198 {
WARTS_DEALIAS_PROBE_IPID
, 2, -1},

199 {
WARTS_DEALIAS_PROBE_SEQ
, 4, -1},

201 
	#d—lŸs_´obe_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_´obe_v¬s
)

	)

203 
	#WARTS_DEALIAS_REPLY_SRC_GID
 1

	)

204 
	#WARTS_DEALIAS_REPLY_RX
 2

	)

205 
	#WARTS_DEALIAS_REPLY_IPID
 3

	)

206 
	#WARTS_DEALIAS_REPLY_TTL
 4

	)

207 
	#WARTS_DEALIAS_REPLY_ICMP_TC
 5

	)

208 
	#WARTS_DEALIAS_REPLY_ICMP_Q_TTL
 6

	)

209 
	#WARTS_DEALIAS_REPLY_ICMP_EXT
 7

	)

210 
	#WARTS_DEALIAS_REPLY_PROTO
 8

	)

211 
	#WARTS_DEALIAS_REPLY_TCP_FLAGS
 9

	)

212 
	#WARTS_DEALIAS_REPLY_SRC
 10

	)

213 
	#WARTS_DEALIAS_REPLY_IPID32
 11

	)

214 
	#WARTS_DEALIAS_REPLY_FLAG
 12

	)

216 cÚ¡ 
w¬ts_v¬_t
 
	gd—lŸs_»¶y_v¬s
[] =

218 {
WARTS_DEALIAS_REPLY_SRC_GID
, 4, -1},

219 {
WARTS_DEALIAS_REPLY_RX
, 8, -1},

220 {
WARTS_DEALIAS_REPLY_IPID
, 2, -1},

221 {
WARTS_DEALIAS_REPLY_TTL
, 1, -1},

222 {
WARTS_DEALIAS_REPLY_ICMP_TC
, 2, -1},

223 {
WARTS_DEALIAS_REPLY_ICMP_Q_TTL
, 1, -1},

224 {
WARTS_DEALIAS_REPLY_ICMP_EXT
, -1, -1},

225 {
WARTS_DEALIAS_REPLY_PROTO
, 1, -1},

226 {
WARTS_DEALIAS_REPLY_TCP_FLAGS
, 1, -1},

227 {
WARTS_DEALIAS_REPLY_SRC
, -1, -1},

228 {
WARTS_DEALIAS_REPLY_IPID32
, 4, -1},

229 {
WARTS_DEALIAS_REPLY_FLAG
, 1, -1},

231 
	#d—lŸs_»¶y_v¬s_mfb
 
	`WARTS_VAR_MFB
(
d—lŸs_»¶y_v¬s
)

	)

233 
	sw¬ts_d—lŸs_´obedef


235 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
d—lŸs_´obedef_v¬s
)];

236 
ušt16_t
 
	mæags_Ën
;

237 
ušt16_t
 
	m·¿ms_Ën
;

238 } 
	tw¬ts_d—lŸs_´obedef_t
;

240 
	sw¬ts_d—lŸs_d©a


242 
w¬ts_d—lŸs_´obedef_t
 *
	m´obedefs
;

243 
ušt32_t
 
	m´obedefc
;

244 
ušt8_t
 
	mæags
[1];

245 
ušt16_t
 
	mæags_Ën
;

246 
ušt16_t
 
	m·¿ms_Ën
;

247 } 
	tw¬ts_d—lŸs_d©a_t
;

249 
	sw¬ts_d—lŸs_»¶y


251 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
d—lŸs_»¶y_v¬s
)];

252 
ušt16_t
 
	mæags_Ën
;

253 
ušt16_t
 
	m·¿ms_Ën
;

254 } 
	tw¬ts_d—lŸs_»¶y_t
;

256 
	sw¬ts_d—lŸs_´obe


258 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
d—lŸs_´obe_v¬s
)];

259 
ušt16_t
 
	mæags_Ën
;

260 
ušt16_t
 
	m·¿ms_Ën
;

261 
w¬ts_d—lŸs_»¶y_t
 *
	m»¶›s
;

262 } 
	tw¬ts_d—lŸs_´obe_t
;

265 
	$w¬ts_d—lŸs_·¿ms
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
,

266 
ušt8_t
 *
æags
, 
ušt16_t
 *
æags_Ën
,

267 
ušt16_t
 *
·¿ms_Ën
)

269 
max_id
 = 0;

271 
	`mem£t
(
æags
, 0, 
d—lŸs_v¬s_mfb
);

272 *
·¿ms_Ën
 = 0;

274 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_LIST_ID
, &
max_id
); *
·¿ms_Ën
 += 4;

275 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_CYCLE_ID
, &
max_id
); *
·¿ms_Ën
 += 4;

276 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_START
, &
max_id
); *
·¿ms_Ën
 += 8;

277 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_METHOD
, &
max_id
); *
·¿ms_Ën
 += 1;

278 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_RESULT
, &
max_id
); *
·¿ms_Ën
 += 1;

279 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_PROBEC
, &
max_id
); *
·¿ms_Ën
 += 4;

281 if(
d—lŸs
->
u£rid
 != 0)

283 
	`æag_£t
(
æags
, 
WARTS_DEALIAS_USERID
, &
max_id
);

284 *
·¿ms_Ën
 += 4;

287 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

289 
	}
}

291 
	$w¬ts_d—lŸs_·¿ms_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

292 
w¬ts_¡©e_t
 *
¡©e
,

293 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

295 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

296 {&
d—lŸs
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

297 {&
d—lŸs
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

298 {&
d—lŸs
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

299 {&
d—lŸs
->
m‘hod
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

300 {&
d—lŸs
->
»suÉ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

301 {&
d—lŸs
->
´obec
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

302 {&
d—lŸs
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

304 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

305  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

306 
	}
}

308 
	$w¬ts_d—lŸs_·¿ms_wr™e
(cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
,

309 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

310 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

311 cÚ¡ 
ušt32_t
 
Ën
,

312 cÚ¡ 
ušt8_t
 *
æags
,

313 cÚ¡ 
ušt16_t
 
æags_Ën
,

314 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

316 
ušt32_t
 
li¡_id
, 
cyşe_id
;

317 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

318 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

319 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

320 {&
d—lŸs
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

321 {&
d—lŸs
->
m‘hod
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

322 {&
d—lŸs
->
»suÉ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

323 {&
d—lŸs
->
´obec
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

324 {&
d—lŸs
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

326 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

328 if(
	`w¬ts_li¡_g‘id
(
sf
, 
d—lŸs
->
li¡
, &
li¡_id
) == -1)  -1;

329 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
d—lŸs
->
cyşe
, &
cyşe_id
) == -1)  -1;

331 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

332 
hªdËr_út
);

334 
	}
}

336 
	$w¬ts_d—lŸs_´obedef_·¿ms
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

337 cÚ¡ 
sÿm³r_d—lŸs_´obedef_t
 *
p
,

338 
w¬ts_d—lŸs_´obedef_t
 *
¡©e
,

339 
w¬ts_add¹abË_t
 *
bË
,

340 
ušt32_t
 *
Ën
)

342 
max_id
 = 0;

344 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_´obedef_v¬s_mfb
);

345 
¡©e
->
·¿ms_Ën
 = 0;

347 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_DST
, &
max_id
);

348 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
d¡
);

349 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_SRC
, &
max_id
);

350 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
¤c
);

351 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_ID
, &
max_id
);

352 
¡©e
->
·¿ms_Ën
 += 4;

353 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_METHOD
, &
max_id
);

354 
¡©e
->
·¿ms_Ën
 += 1;

355 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_TTL
, &
max_id
);

356 
¡©e
->
·¿ms_Ën
 += 1;

357 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_TOS
, &
max_id
);

358 
¡©e
->
·¿ms_Ën
 += 1;

360 if(
p
->
size
 != 0)

362 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_SIZE
, &
max_id
);

363 
¡©e
->
·¿ms_Ën
 += 2;

365 if(
p
->
mtu
 != 0)

367 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_MTU
, &
max_id
);

368 
¡©e
->
·¿ms_Ën
 += 2;

372 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
p
) ||

373 
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
p
))

375 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_4BYTES
, &
max_id
);

376 
¡©e
->
·¿ms_Ën
 += 4;

380 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
p
))

382 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_ICMP_ID
, &
max_id
);

383 
¡©e
->
·¿ms_Ën
 += 2;

384 if(
p
->
un
.
icmp
.
csum
 != 0)

386 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_ICMP_CSUM
, &
max_id
);

387 
¡©e
->
·¿ms_Ën
 += 2;

392 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
p
))

394 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBEDEF_TCP_FLAGS
, &
max_id
);

395 
¡©e
->
·¿ms_Ën
 += 1;

398 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

401 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

402 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

405 
	}
}

407 
	$w¬ts_d—lŸs_´obedef_»ad
(
sÿm³r_d—lŸs_´obedef_t
 *
p
,

408 
w¬ts_¡©e_t
 *
¡©e
,

409 
w¬ts_add¹abË_t
 *
bË
,

410 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,ušt32_ˆ
Ën
)

412 
ušt8_t
 
by‹s
[4]; 
ušt16_t
 
by‹s_Ën
 = 4;

413 
ušt8_t
 
tı_æags
 = 0;

414 
ušt16_t
 
icmpid
 = 0, 
csum
 = 0;

415 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

416 {&
p
->
d¡
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

417 {&
p
->
¤c
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

418 {&
p
->
id
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

419 {&
p
->
m‘hod
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

420 {&
p
->
‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

421 {&
p
->
tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

422 {
by‹s
, (
w´_t
)
exŒaù_by‹s
, &
by‹s_Ën
},

423 {&
tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

424 {&
icmpid
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

425 {&
p
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

426 {&
p
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

427 {&
p
->
size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

428 {&
p
->
mtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

429 {&
csum
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

431 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

432 
ušt32_t
 
o
 = *
off
;

434 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

437 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
p
))

439 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_DEALIAS_PROBEDEF_4BYTES
))

440 
p
->
un
.
icmp
.
csum
 = 
	`by‹s_Áohs
(
by‹s
+2);

442 
p
->
un
.
icmp
.
csum
 = csum;

443 
p
->
un
.
icmp
.
id
 = 
icmpid
;

445 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
p
))

447 
p
->
un
.
tı
.
¥Üt
 = 
	`by‹s_Áohs
(
by‹s
+0);

448 
p
->
un
.
tı
.
dpÜt
 = 
	`by‹s_Áohs
(
by‹s
+2);

449 
p
->
un
.
tı
.
æags
 = 
tı_æags
;

451 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
p
))

453 
p
->
un
.
udp
.
¥Üt
 = 
	`by‹s_Áohs
(
by‹s
+0);

454 
p
->
un
.
udp
.
dpÜt
 = 
	`by‹s_Áohs
(
by‹s
+2);

462 
	}
}

464 
	$w¬ts_d—lŸs_´obedef_wr™e
(cÚ¡ 
sÿm³r_d—lŸs_´obedef_t
 *
p
,

465 
w¬ts_d—lŸs_´obedef_t
 *
¡©e
,

466 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

467 
w¬ts_add¹abË_t
 *
bË
,

468 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

469 cÚ¡ 
ušt32_t
 
Ën
)

471 
ušt8_t
 
by‹s
[4]; 
ušt16_t
 
by‹s_Ën
 = 4;

472 
ušt8_t
 
tı_æags
;

473 
ušt16_t
 
icmpid
, 
csum
;

474 
ušt16_t
 
u16
;

476 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

477 {
NULL
, NULL, NULL},

478 {
NULL
, NULL, NULL},

479 {&
p
->
id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

480 {&
p
->
m‘hod
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

481 {&
p
->
‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

482 {&
p
->
tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

483 {
by‹s
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
by‹s_Ën
},

484 {&
tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

485 {&
icmpid
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

486 {
p
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

487 {
p
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

488 {&
p
->
size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

489 {&
p
->
mtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

490 {&
csum
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

492 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

494 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_ICMP
(
p
))

496 
icmpid
 = 
p
->
un
.
icmp
.
id
;

497 
csum
 = 
p
->
un
.
icmp
.csum;

499 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_UDP
(
p
))

501 
u16
 = 
	`htÚs
(
p
->
un
.
udp
.
¥Üt
);

502 
	`memıy
(
by‹s
+0, &
u16
, 2);

503 
u16
 = 
	`htÚs
(
p
->
un
.
udp
.
dpÜt
);

504 
	`memıy
(
by‹s
+2, &
u16
, 2);

506 if(
	`SCAMPER_DEALIAS_PROBEDEF_PROTO_IS_TCP
(
p
))

508 
u16
 = 
	`htÚs
(
p
->
un
.
tı
.
¥Üt
);

509 
	`memıy
(
by‹s
+0, &
u16
, 2);

510 
u16
 = 
	`htÚs
(
p
->
un
.
tı
.
dpÜt
);

511 
	`memıy
(
by‹s
+2, &
u16
, 2);

512 
tı_æags
 = 
p
->
un
.
tı
.
æags
;

515 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

516 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

517 
hªdËrs
, 
hªdËr_út
);

520 
	}
}

522 
	$exŒaù_d—lŸs_´efixsÿn_xs
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

523 cÚ¡ 
ušt32_t
 
Ën
,

524 
sÿm³r_d—lŸs_´efixsÿn_t
 *
pfs
,

525 *
·¿m
)

527 
sÿm³r_addr_t
 **
xs
;

528 
ušt16_t
 
xc
, 
i
;

530 if(
	`exŒaù_ušt16
(
buf
, 
off
, 
Ën
, &
xc
, 
NULL
) != 0)

533 if(
	`sÿm³r_d—lŸs_´efixsÿn_xs_®loc
(
pfs
, 
xc
) != 0)

536 
xs
 = 
pfs
->xs;

537 
i
=0; i<
xc
; i++)

539 if(
	`exŒaù_addr
(
buf
, 
off
, 
Ën
, &
xs
[
i
], 
·¿m
) != 0)

543 
pfs
->
xs
 = xs;

544 
pfs
->
xc
 = xc;

547 
	}
}

549 
	$š£¹_d—lŸs_´efixsÿn_xs
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

550 cÚ¡ 
ušt32_t
 
Ën
,

551 cÚ¡ 
sÿm³r_d—lŸs_´efixsÿn_t
 *
p
,

552 *
·¿m
)

554 
ušt16_t
 
i
;

556 
i
 = 
	`htÚs
(
p
->
xc
);

557 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
i
, 
NULL
);

559 
i
=0; i<
p
->
xc
; i++)

560 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, 
p
->
xs
[
i
], 
·¿m
);

563 
	}
}

565 
	$w¬ts_d—lŸs_´efixsÿn_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

566 cÚ¡ *
d©a
,

567 
w¬ts_d—lŸs_d©a_t
 *
¡©e
,

568 
w¬ts_add¹abË_t
 *
bË
,

569 
ušt32_t
 *
Ën
)

571 cÚ¡ 
sÿm³r_d—lŸs_´efixsÿn_t
 *
p
 = 
d©a
;

572 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

573 
max_id
 = 0;

574 
ušt16_t
 
i
, 
j
;

575 
size_t
 
size
;

577 if(
p
->
´obedefc
 > 0)

579 
size
 = 
p
->
´obedefc
 * (
w¬ts_d—lŸs_´obedef_t
);

580 if((
¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

584 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_´efixsÿn_v¬s_mfb
);

585 
¡©e
->
·¿ms_Ën
 = 0;

587 
i
=0; i<(
d—lŸs_´efixsÿn_v¬s
)/(
w¬ts_v¬_t
); i++)

589 
v¬
 = &
d—lŸs_´efixsÿn_v¬s
[
i
];

591 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_A
)

593 if(
p
->
a
 !ğ
NULL
)

595 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

596 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
a
);

600 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_B
)

602 if(
p
->
b
 !ğ
NULL
)

604 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

605 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
b
);

609 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_AB
)

611 if(
p
->
ab
 !ğ
NULL
)

613 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

614 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
ab
);

618 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_XS
)

620 if(
p
->
xc
 > 0)

622 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

623 
¡©e
->
·¿ms_Ën
 += 2;

624 
j
=0; j<
p
->
xc
; j++)

625 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
p
->
xs
[
j
]);

629 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_PROBEDEFC
)

631 if(
p
->
´obedefc
 == 0)

634 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_FLAGS
)

636 if(
p
->
æags
 == 0)

639 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_PREFIXSCAN_REPLYC
)

641 if(
p
->
»¶yc
 == 5)

645 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

646 
	`as£¹
(
v¬
->
size
 >= 0);

647 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

650 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

652 
i
=0; i<
p
->
´obedefc
; i++)

654 if(
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
p
->
´obedefs
[
i
],

655 &
¡©e
->
´obedefs
[
i
], 
bË
, 
Ën
) != 0)

661 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

662 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

665 
	}
}

667 
	$w¬ts_d—lŸs_´efixsÿn_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

668 
w¬ts_¡©e_t
 *
¡©e
,

669 
w¬ts_add¹abË_t
 *
bË
,

670 
sÿm³r_d—lŸs_´obedef_t
 **
defs
,

671 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

672 
ušt32_t
 
Ën
)

674 
sÿm³r_d—lŸs_´efixsÿn_t
 
pfs
, *
p
;

675 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

676 {&
pfs
.
a
, (
w´_t
)
exŒaù_addr
, 
bË
},

677 {&
pfs
.
b
, (
w´_t
)
exŒaù_addr
, 
bË
},

678 {&
pfs
.
ab
, (
w´_t
)
exŒaù_addr
, 
bË
},

679 {&
pfs
, (
w´_t
)
exŒaù_d—lŸs_´efixsÿn_xs
, 
bË
},

680 {&
pfs
.
´efix
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

681 {&
pfs
.
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

682 {&
pfs
.
fudge
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

683 {&
pfs
.
wa™_´obe
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

684 {&
pfs
.
wa™_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

685 {&
pfs
.
´obedefc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

686 {&
pfs
.
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

687 {&
pfs
.
»¶yc
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

689 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

690 
ušt32_t
 
o
 = *
off
;

691 
ušt16_t
 
i
;

693 
	`mem£t
(&
pfs
, 0, (pfs));

694 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

697 if(
	`sÿm³r_d—lŸs_´efixsÿn_®loc
(
d—lŸs
) != 0)

700 
p
 = 
d—lŸs
->
d©a
;

701 
	`memıy
(
p
, &
pfs
, (pfs));

704 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_DEALIAS_PREFIXSCAN_REPLYC
) == 0)

705 
p
->
»¶yc
 = 5;

707 if(
p
->
´obedefc
 > 0)

709 if(
	`sÿm³r_d—lŸs_´efixsÿn_´obedefs_®loc
(
p
,…->
´obedefc
) != 0)

712 
i
=0; i<
p
->
´obedefc
; i++)

714 if(
	`w¬ts_d—lŸs_´obedef_»ad
(&
p
->
´obedefs
[
i
], 
¡©e
, 
bË
,

715 
buf
, 
off
, 
Ën
) != 0)

720 *
defs
 = 
p
->
´obedefs
;

722 
	}
}

724 
	$w¬ts_d—lŸs_´efixsÿn_wr™e
(cÚ¡ *
d©a
,

725 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

726 
w¬ts_add¹abË_t
 *
bË
,

727 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

728 cÚ¡ 
ušt32_t
 
Ën
,

729 
w¬ts_d—lŸs_d©a_t
 *
¡©e
)

731 cÚ¡ 
sÿm³r_d—lŸs_´efixsÿn_t
 *
´efixsÿn
 = 
d©a
;

732 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

733 {
´efixsÿn
->
a
, (
wpw_t
)
š£¹_addr
, 
bË
},

734 {
´efixsÿn
->
b
, (
wpw_t
)
š£¹_addr
, 
bË
},

735 {
´efixsÿn
->
ab
, (
wpw_t
)
š£¹_addr
, 
bË
},

736 {
´efixsÿn
, (
wpw_t
)
š£¹_d—lŸs_´efixsÿn_xs
, 
bË
},

737 {&
´efixsÿn
->
´efix
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

738 {&
´efixsÿn
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

739 {&
´efixsÿn
->
fudge
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

740 {&
´efixsÿn
->
wa™_´obe
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

741 {&
´efixsÿn
->
wa™_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

742 {&
´efixsÿn
->
´obedefc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

743 {&
´efixsÿn
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

744 {&
´efixsÿn
->
»¶yc
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

746 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

747 
ušt32_t
 
i
;

749 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

750 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

751 
hªdËrs
, 
hªdËr_út
);

753 
i
=0; i<
´efixsÿn
->
´obedefc
; i++)

755 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
´efixsÿn
->
´obedefs
[
i
],

756 &
¡©e
->
´obedefs
[
i
],

757 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

761 
	}
}

763 
	$w¬ts_d—lŸs_¿d¬gun_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

764 cÚ¡ *
d©a
,

765 
w¬ts_d—lŸs_d©a_t
 *
¡©e
,

766 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

768 cÚ¡ 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
 = 
d©a
;

769 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

770 
max_id
 = 0;

771 
size_t
 
size
;

772 
ušt32_t
 
i
;

774 if(
rg
->
´obedefc
 == 0)

777 
size
 = 
rg
->
´obedefc
 * (
w¬ts_d—lŸs_´obedef_t
);

778 if((
¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

781 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_¿d¬gun_v¬s_mfb
);

782 
¡©e
->
·¿ms_Ën
 = 0;

784 
i
=0; i<(
d—lŸs_¿d¬gun_v¬s
)/(
w¬ts_v¬_t
); i++)

786 
v¬
 = &
d—lŸs_¿d¬gun_v¬s
[
i
];

788 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_RADARGUN_FLAGS
)

790 if(
rg
->
æags
 == 0)

794 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

795 
	`as£¹
(
v¬
->
size
 >= 0);

796 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

799 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

801 
i
=0; i<
rg
->
´obedefc
; i++)

803 if(
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
rg
->
´obedefs
[
i
],

804 &
¡©e
->
´obedefs
[
i
], 
bË
, 
Ën
) != 0)

811 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

812 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

815 
	}
}

817 
	$w¬ts_d—lŸs_¿d¬gun_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

818 
w¬ts_¡©e_t
 *
¡©e
,

819 
w¬ts_add¹abË_t
 *
bË
,

820 
sÿm³r_d—lŸs_´obedef_t
 **
defs
,

821 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,ušt32_ˆ
Ën
)

823 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
;

824 
ušt32_t
 
´obedefc
 = 0;

825 
ušt16_t
 
©‹m±s
 = 0;

826 
ušt16_t
 
wa™_´obe
 = 0;

827 
ušt32_t
 
wa™_round
 = 0;

828 
ušt8_t
 
wa™_timeout
 = 0;

829 
ušt8_t
 
æags
 = 0;

830 
ušt32_t
 
i
;

831 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

832 {&
´obedefc
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

833 {&
©‹m±s
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

834 {&
wa™_´obe
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

835 {&
wa™_round
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

836 {&
wa™_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

837 {&
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

839 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

841 if(
	`sÿm³r_d—lŸs_¿d¬gun_®loc
(
d—lŸs
) != 0)

844 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

847 
rg
 = 
d—lŸs
->
d©a
;

848 if(
	`sÿm³r_d—lŸs_¿d¬gun_´obedefs_®loc
(
rg
, 
´obedefc
) != 0)

851 
rg
->
´obedefc
 =…robedefc;

852 
rg
->
©‹m±s
 =‡ttempts;

853 
rg
->
wa™_´obe
 = wait_probe;

854 
rg
->
wa™_round
 = wait_round;

855 
rg
->
wa™_timeout
 = wait_timeout;

856 
rg
->
æags
 = flags;

858 
i
=0; i<
´obedefc
; i++)

860 if(
	`w¬ts_d—lŸs_´obedef_»ad
(&
rg
->
´obedefs
[
i
], 
¡©e
, 
bË
,

861 
buf
, 
off
, 
Ën
) != 0)

865 *
defs
 = 
rg
->
´obedefs
;

867 
	}
}

869 
	$w¬ts_d—lŸs_¿d¬gun_wr™e
(cÚ¡ *
d©a
,

870 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

871 
w¬ts_add¹abË_t
 *
bË
,

872 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

873 cÚ¡ 
ušt32_t
 
Ën
,

874 
w¬ts_d—lŸs_d©a_t
 *
¡©e
)

876 cÚ¡ 
sÿm³r_d—lŸs_¿d¬gun_t
 *
rg
 = 
d©a
;

877 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

878 {&
rg
->
´obedefc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

879 {&
rg
->
©‹m±s
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

880 {&
rg
->
wa™_´obe
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

881 {&
rg
->
wa™_round
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

882 {&
rg
->
wa™_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

883 {&
rg
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

885 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

886 
ušt32_t
 
i
;

888 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

889 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

890 
hªdËrs
, 
hªdËr_út
);

892 
i
=0; i<
rg
->
´obedefc
; i++)

894 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
rg
->
´obedefs
[
i
], &
¡©e
->probedefs[i],

895 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

899 
	}
}

901 
	$w¬ts_d—lŸs_bump_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, cÚ¡ *
d©a
,

902 
w¬ts_d—lŸs_d©a_t
 *
¡©e
,

903 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

905 cÚ¡ 
sÿm³r_d—lŸs_bump_t
 *
bump
 = 
d©a
;

906 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

907 
i
, 
max_id
 = 0;

908 
size_t
 
size
 = (
w¬ts_d—lŸs_´obedef_t
) * 2;

910 if((
¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

913 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_bump_v¬s_mfb
);

914 
¡©e
->
·¿ms_Ën
 = 0;

916 
i
=0; i<(
d—lŸs_bump_v¬s
)/(
w¬ts_v¬_t
); i++)

918 
v¬
 = &
d—lŸs_bump_v¬s
[
i
];

919 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

920 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

923 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

925 if(
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
bump
->
´obedefs
[0],

926 &
¡©e
->
´obedefs
[0], 
bË
, 
Ën
) != 0 ||

927 
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
bump
->
´obedefs
[1],

928 &
¡©e
->
´obedefs
[1], 
bË
, 
Ën
) != 0)

934 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

935 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

938 
	}
}

940 
	$w¬ts_d—lŸs_bump_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

941 
w¬ts_¡©e_t
 *
¡©e
,

942 
w¬ts_add¹abË_t
 *
bË
,

943 
sÿm³r_d—lŸs_´obedef_t
 **
defs
,

944 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

946 
sÿm³r_d—lŸs_bump_t
 *
bump
;

947 
ušt16_t
 
wa™_´obe
 = 0;

948 
ušt16_t
 
bump_lim™
 = 0;

949 
ušt8_t
 
©‹m±s
 = 0;

950 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

951 {&
wa™_´obe
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

952 {&
bump_lim™
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

953 {&
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

955 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

957 if(
	`sÿm³r_d—lŸs_bump_®loc
(
d—lŸs
) != 0)

960 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

963 
bump
 = 
d—lŸs
->
d©a
;

964 
bump
->
wa™_´obe
 = wait_probe;

965 
bump
->
bump_lim™
 = bump_limit;

966 
bump
->
©‹m±s
 =‡ttempts;

968 if(
	`w¬ts_d—lŸs_´obedef_»ad
(&
bump
->
´obedefs
[0], 
¡©e
, 
bË
,

969 
buf
, 
off
, 
Ën
) != 0 ||

970 
	`w¬ts_d—lŸs_´obedef_»ad
(&
bump
->
´obedefs
[1], 
¡©e
, 
bË
,

971 
buf
, 
off
, 
Ën
) != 0)

976 *
defs
 = 
bump
->
´obedefs
;

978 
	}
}

980 
	$w¬ts_d—lŸs_bump_wr™e
(cÚ¡ *
d©a
,

981 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

982 
w¬ts_add¹abË_t
 *
bË
,

983 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

984 cÚ¡ 
ušt32_t
 
Ën
,

985 
w¬ts_d—lŸs_d©a_t
 *
¡©e
)

987 cÚ¡ 
sÿm³r_d—lŸs_bump_t
 *
bump
 = 
d©a
;

988 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

989 {&
bump
->
wa™_´obe
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

990 {&
bump
->
bump_lim™
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

991 {&
bump
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

993 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

994 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

995 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

996 
hªdËrs
, 
hªdËr_út
);

997 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
bump
->
´obedefs
[0], &
¡©e
->probedefs[0],

998 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

999 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
bump
->
´obedefs
[1], &
¡©e
->probedefs[1],

1000 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

1002 
	}
}

1004 
	$w¬ts_d—lŸs_®ly_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, cÚ¡ *
d©a
,

1005 
w¬ts_d—lŸs_d©a_t
 *
¡©e
,

1006 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

1008 cÚ¡ 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
d©a
;

1009 
max_id
 = 0;

1010 
size_t
 
size
 = (
w¬ts_d—lŸs_´obedef_t
) * 2;

1012 if((
¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1015 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_®ly_v¬s_mfb
);

1016 
¡©e
->
·¿ms_Ën
 = 0;

1018 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_ALLY_WAIT_PROBE
, &
max_id
);

1019 
¡©e
->
·¿ms_Ën
 += 2;

1020 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_ALLY_WAIT_TIMEOUT
, &
max_id
);

1021 
¡©e
->
·¿ms_Ën
 += 1;

1022 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_ALLY_ATTEMPTS
, &
max_id
);

1023 
¡©e
->
·¿ms_Ën
 += 1;

1024 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_ALLY_FUDGE
, &
max_id
);

1025 
¡©e
->
·¿ms_Ën
 += 2;

1027 if(
®ly
->
æags
 != 0)

1029 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_ALLY_FLAGS
, &
max_id
);

1030 
¡©e
->
·¿ms_Ën
 += 1;

1033 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

1035 if(
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
®ly
->
´obedefs
[0],

1036 &
¡©e
->
´obedefs
[0], 
bË
, 
Ën
) != 0 ||

1037 
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
®ly
->
´obedefs
[1],

1038 &
¡©e
->
´obedefs
[1], 
bË
, 
Ën
) != 0)

1044 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

1045 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

1048 
	}
}

1050 
	$w¬ts_d—lŸs_®ly_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1051 
w¬ts_¡©e_t
 *
¡©e
,

1052 
w¬ts_add¹abË_t
 *
bË
,

1053 
sÿm³r_d—lŸs_´obedef_t
 **
defs
,

1054 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1056 
sÿm³r_d—lŸs_®ly_t
 *
®ly
;

1057 
ušt16_t
 
wa™_´obe
 = 0;

1058 
ušt8_t
 
wa™_timeout
 = 0;

1059 
ušt8_t
 
©‹m±s
 = 0;

1060 
ušt16_t
 
fudge
 = 0;

1061 
ušt8_t
 
æags
 = 0;

1062 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1063 {&
wa™_´obe
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

1064 {&
wa™_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1065 {&
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1066 {&
fudge
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

1067 {&
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1069 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1071 if(
	`sÿm³r_d—lŸs_®ly_®loc
(
d—lŸs
) != 0)

1074 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

1077 
®ly
 = 
d—lŸs
->
d©a
;

1078 
®ly
->
wa™_´obe
 = wait_probe;

1079 
®ly
->
wa™_timeout
 = wait_timeout;

1080 
®ly
->
©‹m±s
 =‡ttempts;

1081 
®ly
->
fudge
 = fudge;

1082 
®ly
->
æags
 = flags;

1084 if(
	`w¬ts_d—lŸs_´obedef_»ad
(&
®ly
->
´obedefs
[0], 
¡©e
, 
bË
,

1085 
buf
, 
off
, 
Ën
) != 0 ||

1086 
	`w¬ts_d—lŸs_´obedef_»ad
(&
®ly
->
´obedefs
[1], 
¡©e
, 
bË
,

1087 
buf
, 
off
, 
Ën
) != 0)

1092 *
defs
 = 
®ly
->
´obedefs
;

1094 
	}
}

1096 
	$w¬ts_d—lŸs_®ly_wr™e
(cÚ¡ *
d©a
,

1097 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1098 
w¬ts_add¹abË_t
 *
bË
,

1099 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1100 cÚ¡ 
ušt32_t
 
Ën
,

1101 
w¬ts_d—lŸs_d©a_t
 *
¡©e
)

1103 cÚ¡ 
sÿm³r_d—lŸs_®ly_t
 *
®ly
 = 
d©a
;

1104 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1105 {&
®ly
->
wa™_´obe
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

1106 {&
®ly
->
wa™_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1107 {&
®ly
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1108 {&
®ly
->
fudge
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

1109 {&
®ly
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1111 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1112 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

1113 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

1114 
hªdËrs
, 
hªdËr_út
);

1115 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
®ly
->
´obedefs
[0], &
¡©e
->probedefs[0],

1116 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

1117 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
®ly
->
´obedefs
[1], &
¡©e
->probedefs[1],

1118 
sf
, 
bË
, 
buf
, 
off
, 
Ën
);

1120 
	}
}

1122 
	$w¬ts_d—lŸs_m”ÿtÜ_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1123 cÚ¡ *
d©a
,

1124 
w¬ts_d—lŸs_d©a_t
 *
¡©e
,

1125 
w¬ts_add¹abË_t
 *
bË
,
ušt32_t
 *
Ën
)

1127 cÚ¡ 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m
 = 
d©a
;

1128 
max_id
 = 0;

1129 
size_t
 
size
 = (
w¬ts_d—lŸs_´obedef_t
);

1131 if((
¡©e
->
´obedefs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1134 
	`as£¹
((
¡©e
->
æags
è>ğ
d—lŸs_m”ÿtÜ_v¬s_mfb
);

1136 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_m”ÿtÜ_v¬s_mfb
);

1137 
¡©e
->
·¿ms_Ën
 = 0;

1139 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_MERCATOR_ATTEMPTS
, &
max_id
);

1140 
¡©e
->
·¿ms_Ën
 += 1;

1141 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_MERCATOR_WAIT_TIMEOUT
, &
max_id
);

1142 
¡©e
->
·¿ms_Ën
 += 1;

1144 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

1146 if(
	`w¬ts_d—lŸs_´obedef_·¿ms
(
sf
, &
m
->
´obedef
, &
¡©e
->
´obedefs
[0],

1147 
bË
, 
Ën
) != 0)

1153 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

1154 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

1157 
	}
}

1159 
	$w¬ts_d—lŸs_m”ÿtÜ_»ad
(
sÿm³r_d—lŸs_t
 *
d—lŸs
,

1160 
w¬ts_¡©e_t
 *
¡©e
,

1161 
w¬ts_add¹abË_t
 *
bË
,

1162 
sÿm³r_d—lŸs_´obedef_t
 **
def
,

1163 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1164 
ušt32_t
 
Ën
)

1166 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m”ÿtÜ
;

1167 
ušt8_t
 
©‹m±s
 = 0;

1168 
ušt8_t
 
wa™_timeout
 = 0;

1169 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1170 {&
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1171 {&
wa™_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1173 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1175 if(
	`sÿm³r_d—lŸs_m”ÿtÜ_®loc
(
d—lŸs
) != 0)

1178 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

1181 
m”ÿtÜ
 = 
d—lŸs
->
d©a
;

1182 
m”ÿtÜ
->
©‹m±s
 =‡ttempts;

1183 
m”ÿtÜ
->
wa™_timeout
 = wait_timeout;

1185 if(
	`w¬ts_d—lŸs_´obedef_»ad
(&
m”ÿtÜ
->
´obedef
, 
¡©e
, 
bË
,

1186 
buf
, 
off
, 
Ën
) != 0)

1191 *
def
 = &
m”ÿtÜ
->
´obedef
;

1193 
	}
}

1195 
	$w¬ts_d—lŸs_m”ÿtÜ_wr™e
(cÚ¡ *
d©a
,

1196 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1197 
w¬ts_add¹abË_t
 *
bË
,

1198 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1199 cÚ¡ 
ušt32_t
 
Ën
,

1200 
w¬ts_d—lŸs_d©a_t
 *
¡©e
)

1202 cÚ¡ 
sÿm³r_d—lŸs_m”ÿtÜ_t
 *
m
 = 
d©a
;

1203 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1204 {&
m
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1205 {&
m
->
wa™_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1207 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1208 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

1209 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

1210 
hªdËrs
, 
hªdËr_út
);

1211 
	`w¬ts_d—lŸs_´obedef_wr™e
(&
m
->
´obedef
, &
¡©e
->
´obedefs
[0], 
sf
, 
bË
,

1212 
buf
, 
off
, 
Ën
);

1214 
	}
}

1216 
	$exŒaù_d—lŸs_»¶y_icm±c
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1217 
ušt32_t
 
Ën
,

1218 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1219 *
·¿m
)

1221 if(
Ën
 - *
off
 < 2)

1225 
»¶y
->
icmp_ty³
 = 
buf
[(*
off
)++];

1226 
»¶y
->
icmp_code
 = 
buf
[(*
off
)++];

1228 
	}
}

1230 
	$š£¹_d—lŸs_»¶y_icm±c
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1231 cÚ¡ 
ušt32_t
 
Ën
,

1232 cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1233 *
·¿m
)

1235 
	`as£¹
(
Ën
 - *
off
 >= 2);

1236 
buf
[(*
off
)++] = 
»¶y
->
icmp_ty³
;

1237 
buf
[(*
off
)++] = 
»¶y
->
icmp_code
;

1239 
	}
}

1241 
	$exŒaù_d—lŸs_»¶y_icm³xt
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1242 
ušt32_t
 
Ën
,

1243 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1244 *
·¿m
)

1246  
	`w¬ts_icm³xt_»ad
(
buf
, 
off
, 
Ën
, &
»¶y
->
icmp_ext
);

1247 
	}
}

1249 
	$š£¹_d—lŸs_»¶y_icm³xt
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1250 cÚ¡ 
ušt32_t
 
Ën
,

1251 cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1252 *
·¿m
)

1254 
	`w¬ts_icm³xt_wr™e
(
buf
, 
off
, 
Ën
, 
»¶y
->
icmp_ext
);

1256 
	}
}

1258 
	$w¬ts_d—lŸs_»¶y_¡©e
(cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1259 
w¬ts_d—lŸs_»¶y_t
 *
¡©e
,

1260 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1261 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

1263 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

1264 
sÿm³r_icm³xt_t
 *
›
;

1265 
i
, 
max_id
 = 0;

1267 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_»¶y_v¬s_mfb
);

1268 
¡©e
->
·¿ms_Ën
 = 0;

1271 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
è&&„•ly->
icmp_ext
 !ğ
NULL
)

1273 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_REPLY_ICMP_EXT
, &
max_id
);

1274 
¡©e
->
·¿ms_Ën
 += 2;

1276 
›
 = 
»¶y
->
icmp_ext
; i!ğ
NULL
; iğ›->
›_Ãxt
)

1278 
¡©e
->
·¿ms_Ën
 +ğ(2 + 1 + 1 + 
›
->
›_dl
);

1282 
i
=0; i<(
d—lŸs_»¶y_v¬s
)/(
w¬ts_v¬_t
); i++)

1284 
v¬
 = &
d—lŸs_»¶y_v¬s
[
i
];

1286 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_SRC_GID
)

1290 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_ICMP_TC
)

1292 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
) == 0)

1295 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_ICMP_Q_TTL
)

1297 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
) == 0)

1300 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_ICMP_EXT
)

1304 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_PROTO
)

1306 if(
	`SCAMPER_DEALIAS_REPLY_IS_ICMP
(
»¶y
))

1309 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_TCP_FLAGS
)

1311 if(
	`SCAMPER_DEALIAS_REPLY_IS_TCP
(
»¶y
) == 0)

1314 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_IPID
)

1316 if(!
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
»¶y
->
¤c
è||„•ly->
id
 == 0)

1319 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_IPID32
)

1321 if(!
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
»¶y
->
¤c
è||„•ly->
id32
 == 0)

1324 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_FLAG
)

1326 if(
»¶y
->
æags
 == 0)

1330 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

1332 if(
v¬
->
id
 =ğ
WARTS_DEALIAS_REPLY_SRC
)

1334 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
¤c
);

1338 
	`as£¹
(
v¬
->
size
 >= 0);

1339 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

1342 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

1345 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

1346 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

1349 
	}
}

1351 
	$w¬ts_d—lŸs_»¶y_»ad
(
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
,

1352 
w¬ts_¡©e_t
 *
¡©e
,

1353 
w¬ts_add¹abË_t
 *
bË
,

1354 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1356 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1357 {&
»¶y
->
¤c
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

1358 {&
»¶y
->
rx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

1359 {&
»¶y
->
id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

1360 {&
»¶y
->
‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1361 {
»¶y
, (
w´_t
)
exŒaù_d—lŸs_»¶y_icm±c
, 
NULL
},

1362 {&
»¶y
->
icmp_q__‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1363 {
»¶y
, (
w´_t
)
exŒaù_d—lŸs_»¶y_icm³xt
, 
NULL
},

1364 {&
»¶y
->
´Ùo
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1365 {&
»¶y
->
tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1366 {&
»¶y
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

1367 {&
»¶y
->
id32
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

1368 {&
»¶y
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1370 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1371 
ušt32_t
 
o
 = *
off
;

1372 
i
;

1374 if((
i
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0)

1375  
i
;

1377 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_DEALIAS_REPLY_PROTO
) == 0)

1379 if(
»¶y
->
¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

1380 
»¶y
->
´Ùo
 = 
IPPROTO_ICMP
;

1382 
»¶y
->
´Ùo
 = 
IPPROTO_ICMPV6
;

1385  
i
;

1386 
	}
}

1388 
	$w¬ts_d—lŸs_»¶y_wr™e
(cÚ¡ 
sÿm³r_d—lŸs_»¶y_t
 *
r
,

1389 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1390 
w¬ts_add¹abË_t
 *
bË
,

1391 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1392 cÚ¡ 
ušt32_t
 
Ën
,

1393 
w¬ts_d—lŸs_»¶y_t
 *
¡©e
)

1395 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1396 {
NULL
, NULL, NULL},

1397 {&
r
->
rx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

1398 {&
r
->
id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

1399 {&
r
->
‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1400 {
r
, (
wpw_t
)
š£¹_d—lŸs_»¶y_icm±c
, 
NULL
},

1401 {&
r
->
icmp_q__‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1402 {
r
, (
wpw_t
)
š£¹_d—lŸs_»¶y_icm³xt
, 
NULL
},

1403 {&
r
->
´Ùo
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1404 {&
r
->
tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1405 {
r
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

1406 {&
r
->
id32
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

1407 {&
r
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1409 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1410 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

1411 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

1412 
hªdËrs
, 
hªdËr_út
);

1414 
	}
}

1416 
	$w¬ts_d—lŸs_´obe_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1417 cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1418 
w¬ts_d—lŸs_´obe_t
 *
¡©e
,

1419 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

1421 
i
 = 0;

1422 
size_t
 
size
;

1424 
	`mem£t
(
¡©e
->
æags
, 0, 
d—lŸs_´obe_v¬s_mfb
);

1425 
¡©e
->
·¿ms_Ën
 = 0;

1427 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBE_DEF
, &
i
);

1428 
¡©e
->
·¿ms_Ën
 += 4;

1429 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBE_TX
, &
i
);

1430 
¡©e
->
·¿ms_Ën
 += 8;

1431 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBE_REPLYC
, &
i
);

1432 
¡©e
->
·¿ms_Ën
 += 2;

1433 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBE_SEQ
, &
i
);

1434 
¡©e
->
·¿ms_Ën
 += 4;

1436 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´obe
->
def
->
d¡
))

1438 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_DEALIAS_PROBE_IPID
, &
i
);

1439 
¡©e
->
·¿ms_Ën
 += 2;

1442 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
i
);

1443 
¡©e
->
»¶›s
 = 
NULL
;

1445 if(
´obe
->
»¶yc
 > 0)

1447 
size
 = (
w¬ts_d—lŸs_»¶y_t
è* 
´obe
->
»¶yc
;

1448 if((
¡©e
->
»¶›s
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1451 
i
=0; i<
´obe
->
»¶yc
; i++)

1453 if(
	`w¬ts_d—lŸs_»¶y_¡©e
(
´obe
->
»¶›s
[
i
], &
¡©e
->replies[i],

1454 
sf
, 
bË
, 
Ën
) != 0)

1456 
	`ä“
(
¡©e
->
»¶›s
);

1457 
¡©e
->
»¶›s
 = 
NULL
;

1464 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

1465 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

1468 
	}
}

1470 
	$w¬ts_d—lŸs_´obe_»ad
(
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1471 
w¬ts_¡©e_t
 *
¡©e
,

1472 
sÿm³r_d—lŸs_´obedef_t
 *
defs
,

1473 
w¬ts_add¹abË_t
 *
bË
,

1474 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1476 
i
;

1477 
ušt32_t
 
´obedef_id
;

1478 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1479 {&
´obedef_id
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

1480 {&
´obe
->
tx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

1481 {&
´obe
->
»¶yc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

1482 {&
´obe
->
id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

1483 {&
´obe
->
£q
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

1485 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1486 
sÿm³r_d—lŸs_»¶y_t
 *
»¶y
;

1488 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

1493 
´obe
->
def
 = 
defs
 + 
´obedef_id
;

1495 if(
´obe
->
»¶yc
 == 0)

1498 if(
	`sÿm³r_d—lŸs_»¶›s_®loc
(
´obe
,…robe->
»¶yc
) != 0)

1503 
i
=0; i<
´obe
->
»¶yc
; i++)

1505 if((
»¶y
 = 
	`sÿm³r_d—lŸs_»¶y_®loc
()è=ğ
NULL
)

1509 
´obe
->
»¶›s
[
i
] = 
»¶y
;

1511 if(
	`w¬ts_d—lŸs_»¶y_»ad
(
»¶y
, 
¡©e
, 
bË
, 
buf
, 
off
, 
Ën
) != 0)

1518 
	}
}

1520 
	$w¬ts_d—lŸs_´obe_wr™e
(cÚ¡ 
sÿm³r_d—lŸs_´obe_t
 *
´obe
,

1521 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1522 
w¬ts_add¹abË_t
 *
bË
,

1523 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1524 cÚ¡ 
ušt32_t
 
Ën
,

1525 
w¬ts_d—lŸs_´obe_t
 *
¡©e
)

1527 
i
;

1528 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1529 {&
´obe
->
def
->
id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

1530 {&
´obe
->
tx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

1531 {&
´obe
->
»¶yc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

1532 {&
´obe
->
id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

1533 {&
´obe
->
£q
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

1535 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1536 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

1537 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

1538 
hªdËrs
, 
hªdËr_út
);

1540 
i
=0; i<
´obe
->
»¶yc
; i++)

1542 
	`w¬ts_d—lŸs_»¶y_wr™e
(
´obe
->
»¶›s
[
i
], 
sf
, 
bË
, 
buf
, 
off
, 
Ën
,

1543 &
¡©e
->
»¶›s
[
i
]);

1547 
	}
}

1549 
	$sÿm³r_fe_w¬ts_d—lŸs_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1550 
sÿm³r_d—lŸs_t
 **
d—lŸs_out
)

1552 (*cÚ¡ 
»ad
[])(
sÿm³r_d—lŸs_t
 *,
w¬ts_¡©e_t
 *,

1553 
w¬ts_add¹abË_t
 *,
sÿm³r_d—lŸs_´obedef_t
 **,

1554 
ušt8_t
 *, 
ušt32_t
 *, uint32_t) = {

1555 
w¬ts_d—lŸs_m”ÿtÜ_»ad
,

1556 
w¬ts_d—lŸs_®ly_»ad
,

1557 
w¬ts_d—lŸs_¿d¬gun_»ad
,

1558 
w¬ts_d—lŸs_´efixsÿn_»ad
,

1559 
w¬ts_d—lŸs_bump_»ad
,

1561 
sÿm³r_d—lŸs_t
 *
d—lŸs
 = 
NULL
;

1562 
sÿm³r_d—lŸs_´obedef_t
 *
defs
;

1563 
sÿm³r_d—lŸs_´obe_t
 *
´obe
;

1564 
w¬ts_add¹abË_t
 
bË
;

1565 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1566 
ušt8_t
 *
buf
 = 
NULL
;

1567 
ušt32_t
 
off
 = 0;

1568 
ušt32_t
 
i
;

1570 
	`mem£t
(&
bË
, 0, (table));

1572 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1574 
”r
;

1576 if(
buf
 =ğ
NULL
)

1578 *
d—lŸs_out
 = 
NULL
;

1582 if((
d—lŸs
 = 
	`sÿm³r_d—lŸs_®loc
()è=ğ
NULL
)

1584 
”r
;

1587 if(
	`w¬ts_d—lŸs_·¿ms_»ad
(
d—lŸs
, 
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1589 
”r
;

1592 if(
»ad
[
d—lŸs
->
m‘hod
-1](d—lŸs,
¡©e
,&
bË
,&
defs
,
buf
,&
off
,
hdr
->
Ën
)!=0)

1593 
”r
;

1595 if(
d—lŸs
->
´obec
 == 0)

1596 
dÚe
;

1598 if(
	`sÿm³r_d—lŸs_´obes_®loc
(
d—lŸs
, d—lŸs->
´obec
) != 0)

1600 
”r
;

1603 
i
=0; i<
d—lŸs
->
´obec
; i++)

1605 if((
´obe
 = 
	`sÿm³r_d—lŸs_´obe_®loc
()è=ğ
NULL
)

1607 
”r
;

1609 
d—lŸs
->
´obes
[
i
] = 
´obe
;

1611 if(
	`w¬ts_d—lŸs_´obe_»ad
(
´obe
, 
¡©e
, 
defs
, &
bË
,

1612 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1614 
”r
;

1618 
dÚe
:

1619 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

1620 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1621 *
d—lŸs_out
 = 
d—lŸs
;

1622 
	`ä“
(
buf
);

1625 
”r
:

1626 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1627 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1628 if(
d—lŸs
 !ğ
NULL
è
	`sÿm³r_d—lŸs_ä“
(dealias);

1630 
	}
}

1632 
	$w¬ts_d—lŸs_´obes_ä“
(
w¬ts_d—lŸs_´obe_t
 *
´obes
,

1633 
ušt32_t
 
út
)

1635 
ušt32_t
 
i
;

1637 if(
´obes
 !ğ
NULL
)

1639 
i
=0; i<
út
; i++)

1640 if(
´obes
[
i
].
»¶›s
 !ğ
NULL
)

1641 
	`ä“
(
´obes
[
i
].
»¶›s
);

1642 
	`ä“
(
´obes
);

1646 
	}
}

1648 
	$sÿm³r_fe_w¬ts_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1649 cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
)

1651 (*cÚ¡ 
¡©e
[])(cÚ¡ 
sÿm³r_fe_t
 *, const *,

1652 
w¬ts_d—lŸs_d©a_t
 *, 
w¬ts_add¹abË_t
 *,

1653 
ušt32_t
 *) = {

1654 
w¬ts_d—lŸs_m”ÿtÜ_¡©e
,

1655 
w¬ts_d—lŸs_®ly_¡©e
,

1656 
w¬ts_d—lŸs_¿d¬gun_¡©e
,

1657 
w¬ts_d—lŸs_´efixsÿn_¡©e
,

1658 
w¬ts_d—lŸs_bump_¡©e
,

1660 (*cÚ¡ 
wr™e
[])(cÚ¡ *, cÚ¡ 
sÿm³r_fe_t
 *,

1661 
w¬ts_add¹abË_t
 *, 
ušt8_t
 *, 
ušt32_t
 *,

1662 cÚ¡ 
ušt32_t
, 
w¬ts_d—lŸs_d©a_t
 *) = {

1663 
w¬ts_d—lŸs_m”ÿtÜ_wr™e
,

1664 
w¬ts_d—lŸs_®ly_wr™e
,

1665 
w¬ts_d—lŸs_¿d¬gun_wr™e
,

1666 
w¬ts_d—lŸs_´efixsÿn_wr™e
,

1667 
w¬ts_d—lŸs_bump_wr™e
,

1669 
ušt8_t
 *
buf
 = 
NULL
;

1670 
ušt8_t
 
æags
[
d—lŸs_v¬s_mfb
];

1671 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

1672 
sÿm³r_d—lŸs_´obe_t
 *
´obe
;

1673 
w¬ts_d—lŸs_d©a_t
 
d©a
;

1674 
w¬ts_d—lŸs_´obe_t
 *
´obes
 = 
NULL
;

1675 
ušt32_t
 
Ën
, 
Ën2
, 
off
 = 0;

1676 
size_t
 
size
;

1677 
ušt32_t
 
i
;

1678 
w¬ts_add¹abË_t
 
bË
;

1680 
	`mem£t
(&
d©a
, 0, (data));

1681 
	`mem£t
(&
bË
, 0, (table));

1684 
	`w¬ts_d—lŸs_·¿ms
(
d—lŸs
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

1685 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

1688 if(
¡©e
[
d—lŸs
->
m‘hod
-1](
sf
, d—lŸs->
d©a
, &d©a, &
bË
, &
Ën
) != 0)

1690 
”r
;

1697 if(
d—lŸs
->
´obec
 > 0)

1699 
size
 = 
d—lŸs
->
´obec
 * (
w¬ts_d—lŸs_´obe_t
);

1700 if((
´obes
 = (
w¬ts_d—lŸs_´obe_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1702 
”r
;

1705 
i
=0; i<
d—lŸs
->
´obec
; i++)

1707 
´obe
 = 
d—lŸs
->
´obes
[
i
];

1708 
Ën2
 = 
Ën
;

1709 if(
	`w¬ts_d—lŸs_´obe_¡©e
(
sf
,
´obe
,&
´obes
[
i
],&
bË
,&
Ën2
) != 0)

1710 
”r
;

1711 if(
Ën2
 < 
Ën
)

1712 
”r
;

1713 
Ën
 = 
Ën2
;

1717 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1718 
”r
;

1719 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_DEALIAS
);

1721 if(
	`w¬ts_d—lŸs_·¿ms_wr™e
(
d—lŸs
, 
sf
, 
buf
, &
off
, 
Ën
,

1722 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

1724 
”r
;

1727 
wr™e
[
d—lŸs
->
m‘hod
-1](d—lŸs->
d©a
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
, &data);

1729 if(
d©a
.
´obedefs
 !ğ
NULL
)

1730 
	`ä“
(
d©a
.
´obedefs
);

1731 
d©a
.
´obedefs
 = 
NULL
;

1733 if(
d—lŸs
->
´obec
 > 0)

1735 
i
=0; i<
d—lŸs
->
´obec
; i++)

1737 
´obe
 = 
d—lŸs
->
´obes
[
i
];

1738 
	`w¬ts_d—lŸs_´obe_wr™e
(
´obe
,
sf
,&
bË
,
buf
,&
off
, 
Ën
, &
´obes
[
i
]);

1742 
	`w¬ts_d—lŸs_´obes_ä“
(
´obes
, 
d—lŸs
->
´obec
);

1743 
´obes
 = 
NULL
;

1745 
	`as£¹
(
off
 =ğ
Ën
);

1747 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

1749 
”r
;

1752 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1753 
	`ä“
(
buf
);

1756 
”r
:

1757 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1758 if(
´obes
 !ğ
NULL
è
	`w¬ts_d—lŸs_´obes_ä“
Õrobes, 
d—lŸs
->
´obec
);

1759 if(
d©a
.
´obedefs
 !ğ
NULL
è
	`ä“
(data.probedefs);

1760 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1762 
	}
}

	@dealias/scamper_dealias_warts.h

1 #iâdeà
__SCAMPER_FILE_WARTS_DEALIAS_H


2 
	#__SCAMPER_FILE_WARTS_DEALIAS_H


	)

4 
sÿm³r_fe_w¬ts_d—lŸs_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

5 
sÿm³r_d—lŸs_t
 **
d—lŸs_out
);

7 
sÿm³r_fe_w¬ts_d—lŸs_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

8 cÚ¡ 
sÿm³r_d—lŸs_t
 *
d—lŸs
);

	@fprinting/scamper_fprinting.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r_icm³xt.h
"

34 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_årštšg.h
"

39 
	~"uts.h
"

41 
	#NONE
 -1

	)

42 
	#DELETED
 -2

	)

43 
	#USED
 -3

	)

45 
	sHASHTABLE
 {

46 
DUAL
 *
	md©a
;

47 
size_t
 
	mlgMax
;

48 
size_t
 
	mlgCu¼’t
;

50 
size_t
 (*
hashFunùiÚ
)(*
	mkey
);

51 (*
	mcom·»FunùiÚ
)(*
	ma
, *
	mb
);

66 
size_t
 
hashFunùiÚQuad¿tic
(
	$size_t
 (*
hashFunùiÚ
)(*
key
), *key, cÚ¡ 
size_t
 
loİ
, cÚ¡ size_ˆ
Ëngth
);

75 
size_t
 
	`compu‹R—lC­ac™y
(size_ˆ
c
);

86 
	`growSize
(
HASHTABLE
 *
h
, *
key
, *
v®ue
, 
boŞ
 
grow
);

96 
	`š£¹EËm’tAt
(
HASHTABLE
 *
h
, *
key
, *
v®ue
, 
size_t
 
desœed
);

98 
size_t
 
	$compu‹R—lC­ac™y
(
size_t
 
c
) {

99 
size_t
 
i
 = 1;

100 
i
 < 
c
) {

101 
i
 *= 2;

103  
i
;

104 
	}
}

106 
size_t
 
	$hashFunùiÚQuad¿tic
(
	$size_t
 (*
hashFunùiÚ
)(*
key
), *key, cÚ¡ 
size_t
 
loİ
, cÚ¡ size_ˆ
Ëngth
) {

107 
size_t
 
hash
 = 
	`hashFunùiÚ
(
key
);

109 
hash
 +ğ(
size_t
)(()
loİ
 / 2.0 + ()loop * ()loop / 2.0);

110 
hash
 = hash % 
Ëngth
;

111  
hash
;

112 
	}
}

114 
	$growSize
(
HASHTABLE
 *
h
, *
key
, *
v®ue
, 
boŞ
 
grow
) {

115 
size_t
 
i
, 
to
;

116 
DUAL
 *
hNew
, *
tmp
;

118 
grow
? (
h
->
lgMax
 *= 2) : (h->lgMax /= 2);

119 
h
->
lgCu¼’t
 = 0;

120 
hNew
 = 
	`m®loc
(
h
->
lgMax
 * (
DUAL
));

121 if(!
hNew
) {

124 
	`mem£t
(
hNew
, 
NONE
, 
h
->
lgMax
 * (
DUAL
));

127 
tmp
 = 
h
->
d©a
;

128 
h
->
d©a
 = 
hNew
;

129 
hNew
 = 
tmp
;

131 
to
 = 
grow
? (
h
->
lgMax
 / 2) : (h->lgMax * 2);

132 
i
 = 0; i < 
to
; i++) {

133 if(
hNew
[
i
].
¥ec
 !ğ
NONE
 && hNew[i].¥eø!ğ
DELETED
) {

134 
	`š£¹EËm’t
(
h
, 
hNew
[
i
].
key
, hNew[i].
v®ue
);

137 if(
key
) {

138 
	`š£¹EËm’t
(
h
, 
key
, 
v®ue
);

141 
	`ä“
(
hNew
);

142 
	}
}

144 
	$š£¹EËm’tAt
(
HASHTABLE
 *
h
, *
key
, *
v®ue
, 
size_t
 
desœed
) {

145 
h
->
lgCu¼’t
++;

146 
h
->
d©a
[
desœed
].
key
 = key;

147 
h
->
d©a
[
desœed
].
v®ue
 = value;

148 
h
->
d©a
[
desœed
].
¥ec
 = 
USED
;

149 
	}
}

151 
HASHTABLE
* 
	$ü—‹HashTabË
(
size_t
 
ÿ·c™y
, 
	$size_t
 (*
hashFunùiÚ
)(*
key
), (*
com·»FunùiÚ
)(*
a
, *
b
)) {

152 
size_t
 
»®C­
 = 
	`compu‹R—lC­ac™y
(
ÿ·c™y
);

153 
HASHTABLE
 *
h
 = 
	`m®loc
((HASHTABLE));

154 if(!
h
) {

155  
NULL
;

158 
h
->
d©a
 = 
	`m®loc
(
»®C­
 * (
DUAL
));

159 if(!(
h
->
d©a
)) {

160 
	`ä“
(
h
);

161  
NULL
;

163 
	`mem£t
(
h
->
d©a
, 
NONE
, 
»®C­
 * (
DUAL
));

165 
h
->
lgMax
 = 
»®C­
;

166 
h
->
lgCu¼’t
 = 0;

167 
h
->
hashFunùiÚ
 = hashFunction;

168 
h
->
com·»FunùiÚ
 = compareFunction;

169  
h
;

170 
	}
}

172 
	$ä“HashTabË
(
HASHTABLE
* 
hashTabË
, 
boŞ
 
ä“Key
, boŞ 
ä“V®ue
) {

173 
size_t
 
i
;

175 if(
ä“V®ue
 || 
ä“Key
) {

176 
i
 = 0; i < 
hashTabË
->
lgMax
; i++) {

177 if(
hashTabË
->
d©a
[
i
].
¥ec
 !ğ
NONE
 && hashTabË->d©a[i].¥eø!ğ
DELETED
) {

178 if(
ä“Key
) {

179 
	`ä“
(
hashTabË
->
d©a
[
i
].
key
);

181 if(
ä“V®ue
 && 
hashTabË
->
d©a
[
i
].
v®ue
 !ğ
NULL
) {

182 
	`ä“
(
hashTabË
->
d©a
[
i
].
v®ue
);

187 
	`ä“
(
hashTabË
->
d©a
);

188 
	`ä“
(
hashTabË
);

189 
	}
}

191 * 
	$š£¹EËm’t
(
HASHTABLE
* 
hashTabË
, *
key
, * 
v®ue
) {

192 
size_t
 
hash
, 
i
 = 0, 
j
;

193 *
Şd
 = 
NULL
;

195 if(
hashTabË
->
lgCu¼’t
 + 1 > hashTabË->
lgMax
 >> 1) {

196 
	`growSize
(
hashTabË
, 0, 
NULL
, 
Œue
);

200 
hash
 = 
	`hashFunùiÚQuad¿tic
(
hashTabË
->
hashFunùiÚ
, 
key
, 
i
, hashTabË->
lgMax
);

201 if(
hashTabË
->
d©a
[
hash
].
¥ec
 =ğ
NONE
) {

202 
	`š£¹EËm’tAt
(
hashTabË
, 
key
, 
v®ue
, 
hash
);

203  
NULL
;

204 } ià(
hashTabË
->
d©a
[
hash
].
¥ec
 =ğ
DELETED
){

206 
j
 = 
i
 + 1; j < 
hashTabË
->
lgMax
; j++) {

207 
i
 = 
	`hashFunùiÚQuad¿tic
(
hashTabË
->
hashFunùiÚ
, 
key
, 
j
, hashTabË->
lgMax
);

208 if(
hashTabË
->
d©a
[
i
].
¥ec
 =ğ
NONE
) {

210 } if(!
hashTabË
->
	`com·»FunùiÚ
(hashTabË->
d©a
[
i
].
key
, key)) {

211 
Şd
 = 
hashTabË
->
d©a
[
i
].
v®ue
;

212 
	`š£¹EËm’tAt
(
hashTabË
, 
key
, 
v®ue
, 
i
);

213  
Şd
;

216 
	`š£¹EËm’tAt
(
hashTabË
, 
key
, 
v®ue
, 
hash
);

217  
NULL
;

218 } if(!
hashTabË
->
	`com·»FunùiÚ
(hashTabË->
d©a
[
hash
].
key
, key)) {

219 
Şd
 = 
hashTabË
->
d©a
[
hash
].
v®ue
;

220 
	`š£¹EËm’tAt
(
hashTabË
, 
key
, 
v®ue
, 
hash
);

221 
hashTabË
->
lgCu¼’t
--;

222  
Şd
;

224 
i
++;

226 } 
i
 !ğ
hashTabË
->
lgMax
);

236  
NULL
;

237 
	}
}

239 * 
	$»moveEËm’t
(
HASHTABLE
* 
hashTabË
, *
key
) {

240 
size_t
 
hash
, 
i
 = 0;

241 *
Şd
 = 
NULL
;

244 
hash
 = 
	`hashFunùiÚQuad¿tic
(
hashTabË
->
hashFunùiÚ
, 
key
, 
i
, hashTabË->
lgMax
);

245 if(
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && hashTabË->d©a[hash].¥eø!ğ
DELETED
 && !hashTabË->
	`com·»FunùiÚ
(hashTabË->d©a[hash].
key
, key)) {

246 
hashTabË
->
lgCu¼’t
--;

247 
Şd
 = 
hashTabË
->
d©a
[
hash
].
v®ue
;

248 
hashTabË
->
d©a
[
hash
].
key
 = (*)
DELETED
;

249 
hashTabË
->
d©a
[
hash
].
v®ue
 = (*)
NONE
;

250 
hashTabË
->
d©a
[
hash
].
¥ec
 = 
DELETED
;

254 if(
hashTabË
->
lgMax
 > 1 && hashTabË->
lgCu¼’t
 < hashTable->lgMax / 8) {

255 
	`growSize
(
hashTabË
, 0, 
NULL
, 
çl£
);

257  
Şd
;

259 
i
++;

261 } 
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && 
i
 !ğhashTabË->
lgMax
);

262  
NULL
;

263 
	}
}

265 
boŞ
 
	$hasKeyAndV®ue
(cÚ¡ 
HASHTABLE
* 
hashTabË
, * 
key
, **
out
) {

266 
size_t
 
hash
, 
i
 = 0;

269 
hash
 = 
	`hashFunùiÚQuad¿tic
(
hashTabË
->
hashFunùiÚ
, 
key
, 
i
, hashTabË->
lgMax
);

270 if(
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && hashTabË->d©a[hash].¥eø!ğ
DELETED
 && !hashTabË->
	`com·»FunùiÚ
(hashTabË->d©a[hash].
key
, key)) {

271 *
out
 = 
hashTabË
->
d©a
[
hash
].
v®ue
;

272  
Œue
;

274 
i
++;

276 } 
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && 
i
 !ğhashTabË->
lgMax
);

277 *
out
 = 
NULL
;

278  
çl£
;

279 
	}
}

282 * 
	$g‘V®ue
(cÚ¡ 
HASHTABLE
* 
hashTabË
, *
key
) {

283 
size_t
 
hash
, 
i
 = 0;

286 
hash
 = 
	`hashFunùiÚQuad¿tic
(
hashTabË
->
hashFunùiÚ
, 
key
, 
i
, hashTabË->
lgMax
);

287 if(
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && hashTabË->d©a[hash].¥eø!ğ
DELETED
 && !hashTabË->
	`com·»FunùiÚ
(hashTabË->d©a[hash].
key
, key)) {

288  
hashTabË
->
d©a
[
hash
].
v®ue
;

290 
i
++;

292 } 
hashTabË
->
d©a
[
hash
].
¥ec
 !ğ
NONE
 && 
i
 !ğhashTabË->
lgMax
);

293  
NULL
;

294 
	}
}

296 
DUAL
* 
	$g‘EËm’ts
(cÚ¡ 
HASHTABLE
 *
h
) {

297  
h
->
d©a
;

298 
	}
}

300 
size_t
 
	$g‘Size
(cÚ¡ 
HASHTABLE
 *
h
) {

301  
h
->
lgMax
;

302 
	}
}

310 
	$sÿm³r_årštšg_¡©s
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_årštšg_¡©s_t
 *
¡©s
) {

311 
sÿm³r_årštšg_»¶y_t
 *
»¶y
;

312 
årštšg__»¶›s_t
 *

;

313 
ušt16_t
 
i
 = 0;

314 
ušt32_t
 
n
 = 0, 
n2
 = 0, 
n3
 = 0, 
n4
 = 0, 
n5
 = 0, 
n6
 = 0, 
sum
 = 0;

315 
size_t
 
j
, 
l
;

316 
DUAL
 *
–s
;

318 
	`mem£t
(
¡©s
, 0, (
sÿm³r_årštšg_¡©s_t
));

320 
j
 = 
	`g‘Size
(
årštšg
->
_»¶›s
);

321 
–s
 = 
	`g‘EËm’ts
(
årštšg
->
_»¶›s
);

322 
l
 = 0;† < 
j
;†++) {

323 if(
–s
[
l
].
¥ec
 !ğ
NONE
 &&ƒls[l].¥eø!ğ
DELETED
) {

324 

 = (
årštšg__»¶›s_t
 *)
–s
[
l
].
v®ue
;

325 if(

 =ğ
NULL
) {

328 if(

->
tı
 && ip->tı !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

329 
»¶y
 = 

->
tı
;

330 
n2
++;

331 
»¶y
->
os_‰l
) {

333 
¡©s
->
ÁsynŸp
[0]++;

336 
¡©s
->
ÁsynŸp
[1]++;

339 
¡©s
->
ÁsynŸp
[2]++;

342 
¡©s
->
ÁsynŸp
[3]++;

345 
¡©s
->
ÁsynŸp
[4]++;

350 if(
»¶y
->
»¶y_tos
) {

351 
¡©s
->
Áos
++;

353 if(
»¶y
->
»¶y_df
) {

354 
¡©s
->
ndf
++;

357 if(

->
echo
 && ip->echØ!ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

358 
»¶y
 = 

->
echo
;

359 
n3
++;

360 
»¶y
->
os_‰l
) {

362 
¡©s
->
Áecho
[0]++;

365 
¡©s
->
Áecho
[1]++;

368 
¡©s
->
Áecho
[2]++;

371 
¡©s
->
Áecho
[3]++;

375 
¡©s
->
Áecho
[4]++;

381 if(

->
‰Ëxp
 && ip->‰Ëx°!ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

382 
»¶y
 = 

->
‰Ëxp
;

383 
sum
 +ğ
»¶y
->
»¶y_size
;

384 
n
++;

385 
»¶y
->
os_‰l
) {

387 
¡©s
->
Átim“xcŸp
[0]++;

390 
¡©s
->
Átim“xcŸp
[1]++;

393 
¡©s
->
Átim“xcŸp
[2]++;

396 
¡©s
->
Átim“xcŸp
[3]++;

399 
¡©s
->
Átim“xcŸp
[4]++;

405 if(

->
time
 && ip->tim!ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

406 
»¶y
 = 

->
time
;

407 
n5
++;

408 
»¶y
->
os_‰l
) {

410 
¡©s
->
Áicm±ime
[0]++;

413 
¡©s
->
Áicm±ime
[1]++;

416 
¡©s
->
Áicm±ime
[2]++;

419 
¡©s
->
Áicm±ime
[3]++;

422 
¡©s
->
Áicm±ime
[4]++;

428 if(

->
tim“xp
 && ip->tim“x°!ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

429 
»¶y
 = 

->
tim“xp
;

430 
n6
++;

431 
»¶y
->
os_‰l
) {

433 
¡©s
->
Áäg
[0]++;

436 
¡©s
->
Áäg
[1]++;

439 
¡©s
->
Áäg
[2]++;

442 
¡©s
->
Áäg
[3]++;

445 
¡©s
->
Áäg
[4]++;

451 if(

->
±uÄ—ch
 && ip->±uÄ—ch !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

452 
»¶y
 = 

->
±uÄ—ch
;

453 
n4
++;

454 
»¶y
->
os_‰l
) {

456 
¡©s
->
Áudp
[0]++;

459 
¡©s
->
Áudp
[1]++;

462 
¡©s
->
Áudp
[2]++;

465 
¡©s
->
Áudp
[3]++;

468 
¡©s
->
Áudp
[4]++;

479 if(
årštšg
->
i¥šg
)

480 
n
 = 1;

482 
¡©s
->
ÁsynŸp
[0] +ğ(
n
 - 
n2
);

483 if(
¡©s
->
ÁsynŸp
[0] > 0x0FFFFFFF) {

484 
¡©s
->
ÁsynŸp
[0] = 0;

486 
¡©s
->
Áecho
[0] +ğ(
n
 - 
n3
);

487 if(
¡©s
->
Áecho
[0] > 0x0FFFFFFF) {

488 
¡©s
->
Áecho
[0] = 0;

490 
¡©s
->
Áudp
[0] +ğ(
n
 - 
n4
);

491 if(
¡©s
->
Áudp
[0] > 0x0FFFFFFF) {

492 
¡©s
->
Áudp
[0] = 0;

494 
¡©s
->
Áicm±ime
[0] +ğ(
n
 - 
n5
);

495 if(
¡©s
->
Áicm±ime
[0] > 0x0FFFFFFF) {

496 
¡©s
->
Áicm±ime
[0] = 0;

498 
¡©s
->
Áäg
[0] +ğ(
n
 - 
n6
);

499 if(
¡©s
->
Áäg
[0] > 0x0FFFFFFF) {

500 
¡©s
->
Áäg
[0] = 0;

503 
¡©s
->
Ä•l›s
 = 
i
;

504 
¡©s
->
Áı
 = 
n2
;

505 
¡©s
->
tim“xc_avgËn
 = (
n
 > 0è? (()
sum
 / ()n) : 0.0f;

508 
	}
}

510 
sÿm³r_addr_t
 *
	$sÿm³r_årštšg_addr
(cÚ¡ *
va
) {

511  ((cÚ¡ 
sÿm³r_årštšg_t
 *)
va
)->
d¡
;

512 
	}
}

514 
sÿm³r_årštšg_t
 *
	$sÿm³r_årštšg_®loc
() {

515 
sÿm³r_årštšg_t
 *
t
 = 
	`m®loc_z”o
((scamper_fprinting_t));

516 if(
t
)

517 
t
->
_»¶›s
 = 
	`ü—‹HashTabË
(200, 
årštšg_addr_hash
, 
årštšg_addr_cmp
);

518  
t
;

519 
	}
}

521 
	$sÿm³r_årštšg_ä“
(
sÿm³r_årštšg_t
 *
årštšg
) {

522 
sÿm³r_årštšg_»¶y_t
 *
»¶y
;

523 
ušt16_t
 
i
;

525 if(
årštšg
 =ğ
NULL
) {

529 
»¶y
 = 
årštšg
->
årštšg_»¶›s
;

530 
»¶y
 !ğ
NULL
) {

531 
»¶y
 = 
årštšg
->
årštšg_»¶›s
->
Ãxt
;

532 
	`sÿm³r_årštšg_»¶y_ä“
(
årštšg
->
årštšg_»¶›s
);

533 
årštšg
->
årštšg_»¶›s
 = 
»¶y
;

535 if(
årštšg
->
ismuÉi
) {

536 
årštšg
->
md¡s
 !ğ
NULL
) {

537 
årštšg
->
curd¡s
 = f´štšg->
md¡s
;

538 
årštšg
->
md¡s
 = f´štšg->md¡s->
Ãxt
;

539 if(
årštšg
->
curd¡s
->
addr
 !ğ
NULL
)

540 
	`sÿm³r_addr_ä“
(
årštšg
->
curd¡s
->
addr
);

541 
	`ä“
(
årštšg
->
curd¡s
);

544 if(
årštšg
->
d¡
 !ğ
NULL
) {

545 
	`sÿm³r_addr_ä“
(
årštšg
->
d¡
);

549 if(
årštšg
->
¤c
 !ğ
NULL
) {

550 
	`sÿm³r_addr_ä“
(
årštšg
->
¤c
);

553 
	`ä“HashTabË
(
årštšg
->
_»¶›s
, 0, 1);

555 
	`ä“
(
årštšg
);

557 
	}
}

559 
ušt32_t
 
	$sÿm³r_årštšg_»¶y_couÁ
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
) {

560  
årštšg
->
»¶yc
;

561 
	}
}

563 
sÿm³r_årštšg_»¶y_t
 *
	$sÿm³r_årštšg_»¶y_®loc
() {

564  (
sÿm³r_årštšg_»¶y_t
 *)
	`m®loc_z”o
((scamper_fprinting_reply_t));

565 
	}
}

567 
	$sÿm³r_årštšg_»¶y_ä“
(
sÿm³r_årštšg_»¶y_t
 *
»¶y
) {

568 if(
»¶y
->
addr
 !ğ
NULL
) {

569 
	`sÿm³r_addr_ä“
(
»¶y
->
addr
);

571 
	`ä“
(
»¶y
);

573 
	}
}

575 
	$sÿm³r_årštšg_»¶y_­³nd
(
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_årštšg_»¶y_t
 *
»¶y
) {

576 
årštšg
->
»¶yc
++;

577 if(
årštšg
->
årštšg_»¶›s
 =ğ
NULL
) {

578 
årštšg
->
årštšg_»¶›s
 = 
»¶y
;

580 
»¶y
->
Ãxt
 = 
årštšg
->
årštšg_»¶›s
;

581 
årštšg
->
årštšg_»¶›s
 = 
»¶y
;

583 
	}
}

585 
	$årštšg_muÉi_addr_add
(
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_addr_t
 *
addr
) {

586 
årštšg_muÉi_addr_t
 *
t
 = 
	`ÿÎoc
(1, (fprinting_multi_addr_t));

587 if(
årštšg
->
md¡s
 =ğ
NULL
) {

588 
årštšg
->
md¡s
 = 
t
;

589 
årštšg
->
md¡s
->
addr
 =‡ddr;

591 
t
->
addr
 =‡ddr;

592 
t
->
Ãxt
 = 
årštšg
->
md¡s
;

593 
årštšg
->
md¡s
 = 
t
;

595 
	}
}

597 
	$årštšg_addr_cmp
(*
a
, *
b
) {

598  
	`sÿm³r_addr_cmp
((
sÿm³r_addr_t
 *)
a
, (sÿm³r_addr_ˆ*)
b
);

599 
	}
}

601 
size_t
 
	$årštšg_addr_hash
(*
a
) {

602 
sÿm³r_addr_t
 *
ad
 = (sÿm³r_addr_ˆ*)
a
;

603  (()
ad
->
ty³
 & (ïd->
addr
è| (ïd->
š‹º®
;

604 
	}
}

	@fprinting/scamper_fprinting.h

24 #iâdeà
__SCAMPER_FPRINTING_H


25 
	#__SCAMPER_FPRINTING_H


	)

27 
	#ådbg
(
x
èdo{
	`´š‹¼Ü
(0, 
¡»¼Ü
, 
__func__
, x);}0)

	)

29 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP
(
»¶y
èĞ\

	)

30 ((
	g»¶y
)->
	gaddr
->
	gty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

31 (
»¶y
)->
»¶y_´Ùo
 == 1) || \

32 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

33 (
»¶y
)->
»¶y_´Ùo
 == 58))

35 
	#SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
èĞ\

	)

36 ((
»¶y
)->
»¶y_´Ùo
 == 6))

38 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
èĞ\

	)

39 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

40 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 0) || \

41 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

42 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 129))

44 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
èĞ\

	)

45 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

46 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ11 && (»¶y)->
icmp_code
 == 0) || \

47 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

48 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 3))

50 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TIMEF_EXP
(
»¶y
èĞ\

	)

51 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

52 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ11 && (»¶y)->
icmp_code
 == 1) || \

53 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

54 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 3))

56 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
èĞ\

	)

57 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

58 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ3 && (»¶y)->
icmp_code
 == 3) || \

59 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

60 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 1))

62 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
èĞ\

	)

63 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

64 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 14))

67 
	#SCAMPER_FPRINTING_STOP_NONE
 0x00

	)

68 
	#SCAMPER_FPRINTING_STOP_COMPLETED
 0x01

	)

69 
	#SCAMPER_FPRINTING_STOP_ERROR
 0x02

	)

70 
	#SCAMPER_FPRINTING_STOP_HALTED
 0x03

	)

71 
	#SCAMPER_FPRINTING_STOP_TIMEOUT
 0x04

	)

73 
	#SCAMPER_DO_FPRINTING_PBTCP
 0

	)

74 
	#SCAMPER_DO_FPRINTING_PBECHO
 1

	)

75 
	#SCAMPER_DO_FPRINTING_PBUDP
 2

	)

77 
	~<¡dboŞ.h
>

78 
	~"sÿm³r_icm³xt.h
"

80 
	#NONE
 -1

	)

81 
	#DELETED
 -2

	)

82 
	#USED
 -3

	)

88 *
key
;

89 *
	mv®ue
;

90 
	m¥ec
;

91 } 
	tDUAL
;

92 
HASHTABLE
 
	tHASHTABLE
;

104 
HASHTABLE
* 
ü—‹HashTabË
(
size_t
 
ÿ·c™y
, 
	$size_t
 (*
hashFunùiÚ
)(*
key
), (*
com·»FunùiÚ
)(*
a
, *
b
));

113 
	`ä“HashTabË
(
HASHTABLE
* 
hashTabË
, 
boŞ
 
ä“Key
, boŞ 
ä“V®ue
);

124 * 
	`š£¹EËm’t
(
HASHTABLE
* 
hashTabË
, *
key
, * 
v®ue
);

134 * 
	`»moveEËm’t
(
HASHTABLE
* 
hashTabË
, *
key
);

145 
boŞ
 
	`hasKeyAndV®ue
(cÚ¡ 
HASHTABLE
* 
hashTabË
, * 
key
, **
out
);

155 * 
	`g‘V®ue
(cÚ¡ 
HASHTABLE
* 
hashTabË
, *
key
);

164 
DUAL
* 
	`g‘EËm’ts
(cÚ¡ 
HASHTABLE
 *
h
);

173 
size_t
 
	`g‘Size
(cÚ¡ 
HASHTABLE
 *
h
);

176 
	sårštšg_muÉi_addr
 {

177 
sÿm³r_addr_t
 *
addr
;

178 
årštšg_muÉi_addr
 *
Ãxt
;

179 } 
	tårštšg_muÉi_addr_t
;

183 
	ssÿm³r_årštšg_»¶y
 {

185 
sÿm³r_addr_t
 *
addr
;

187 
ušt8_t
 
»¶y_´Ùo
;

189 
ušt8_t
 
»¶y_‰l
;

190 
ušt8_t
 
os_‰l
;

191 
ušt8_t
 
»¶y_tos
;

192 
ušt8_t
 
»¶y_df
;

193 
ušt16_t
 
»¶y_size
;

194 
ušt8_t
 
»¶y_q_‰l
;

195 
ušt8_t
 
»¶y_q_tos
;

197 
sÿm³r_icm³xt_t
 *
»¶y_ext
;

198 
ušt8_t
 
is_m¶s
;

201 
ušt8_t
 
icmp_ty³
;

202 
ušt8_t
 
icmp_code
;

205 
ušt8_t
 
tı_æags
;

207 
ušt16_t
 
»¶y_tı_wš
;

208 
ušt16_t
 
»¶y_tı_mss
;

211 
sÿm³r_årštšg_»¶y
 *
Ãxt
;

213 } 
	tsÿm³r_årštšg_»¶y_t
;

216 
	sårštšg__»¶›s
 {

217 
ušt8_t
 
®»adyProbed
;

218 
sÿm³r_årštšg_»¶y_t
 *
echo
, *
±uÄ—ch
, *
time
, *
‰Ëxp
, *
tim“xp
, *
tı
;

219 } 
	tårštšg__»¶›s_t
;

224 
	ssÿm³r_årštšg
 {

226 
sÿm³r_addr_t
 *
¤c
;

227 
sÿm³r_addr_t
 *
d¡
;

229 
årštšg_muÉi_addr_t
 *
md¡s
;

231 
årštšg_muÉi_addr_t
 *
curd¡s
;

233 
timev®
 
¡¬t
;

234 
ušt8_t
 
¡İ_»asÚ
;

235 
ušt8_t
 
¡İ_d©a
;

236 
ušt8_t
 
i¡ı
;

237 
ušt8_t
 
i£chÙ
;

238 
ušt8_t
 
isicmpdËn
;

239 
ušt8_t
 
isdf
;

240 
ušt8_t
 
i¡os
;

241 
ušt8_t
 
isud±
;

242 
ušt8_t
 
isicm±im‘
;

243 
ušt8_t
 
ism¶s
;

244 
ušt8_t
 
i§df
;

245 
ušt8_t
 
i¥šg
;

246 
ušt8_t
 
pbmode
;

247 
ušt8_t
 
™
;

248 
ušt8_t
 
ismuÉi
;

250 
ušt8_t
 
nfšd
;

251 
ušt8_t
 
Årobe
;

253 
ušt16_t
 
¥Üt
;

254 
ušt16_t
 
dpÜt
;

256 
ušt32_t
 
»¶yc
;

257 
sÿm³r_årštšg_»¶y_t
 *
årštšg_»¶›s
;

258 
HASHTABLE
 *
_»¶›s
;

259 } 
	tsÿm³r_årštšg_t
;

262 
sÿm³r_årštšg_t
 *
	`sÿm³r_årštšg_®loc
();

263 
	`sÿm³r_årštšg_ä“
(
sÿm³r_årštšg_t
 *
pšg
);

264 
sÿm³r_addr_t
 *
	`sÿm³r_årštšg_addr
(cÚ¡ *
va
);

267 
	`sÿm³r_årštšg_»¶›s_®loc
(
sÿm³r_årštšg_t
 *
pšg
, 
couÁ
);

270 
sÿm³r_årštšg_»¶y_t
 *
	`sÿm³r_årštšg_»¶y_®loc
();

271 
	`sÿm³r_årštšg_»¶y_ä“
(
sÿm³r_årštšg_»¶y_t
 *
»¶y
);

272 
ušt32_t
 
	`sÿm³r_årštšg_»¶y_couÁ
(cÚ¡ 
sÿm³r_årštšg_t
 *
pšg
);

280 
	`sÿm³r_årštšg_»¶y_­³nd
(
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_årštšg_»¶y_t
 *
»¶y
);

281 
	`årštšg_muÉi_addr_add
(
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_addr_t
 *
addr
);

283 
	`årštšg_addr_cmp
(*
a
, *
b
);

284 
size_t
 
	`årštšg_addr_hash
(*
a
);

287 
	ssÿm³r_årštšg_¡©s
 {

288 
ušt32_t
 
Ä•l›s
;

289 
ušt16_t
 
Áı
;

291 
ušt32_t
 
Áos
;

292 
ušt32_t
 
ndf
;

293 
ušt32_t
 
ÁsynŸp
[5];

294 
ušt32_t
 
Átim“xcŸp
[5];

295 
ušt32_t
 
Áecho
[5];

296 
ušt32_t
 
Áudp
[5];

297 
ušt32_t
 
Áicm±ime
[5];

298 
ušt32_t
 
Áäg
[5];

299 
tim“xc_avgËn
;

300 } 
	tsÿm³r_årštšg_¡©s_t
;

311 
	`sÿm³r_årštšg_¡©s
(cÚ¡ 
sÿm³r_årštšg_t
 *
pšg
, 
sÿm³r_årštšg_¡©s_t
 *
¡©s
);

	@fprinting/scamper_fprinting_do.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_årštšg.h
"

36 
	~"sÿm³r_g‘¤c.h
"

37 
	~"sÿm³r_icmp_»¥.h
"

38 
	~"sÿm³r_icm³xt.h
"

39 
	~"sÿm³r_fds.h
"

40 
	~"sÿm³r_¹sock.h
"

41 
	~"sÿm³r_sk.h
"

42 
	~"sÿm³r_dl.h
"

43 
	~"sÿm³r_dlhdr.h
"

44 
	~"sÿm³r_´obe.h
"

45 
	~"sÿm³r_queue.h
"

46 
	~"sÿm³r_fe.h
"

47 
	~"sÿm³r_debug.h
"

48 
	~"sÿm³r_årštšg_do.h
"

49 
	~"sÿm³r_İtiÚs.h
"

50 
	~"sÿm³r_icmp4.h
"

51 
	~"uts.h
"

53 
	#SCAMPER_DO_FPRINTING_ITTL_MIN
 1

	)

54 
	#SCAMPER_DO_FPRINTING_ITTL_DEF
 1

	)

55 
	#SCAMPER_DO_FPRINTING_ITTL_MAX
 254

	)

57 
	#SCAMPER_DO_FPRINTING_NFIND_MIN
 1

	)

58 
	#SCAMPER_DO_FPRINTING_NFIND_DEF
 1

	)

59 
	#SCAMPER_DO_FPRINTING_NFIND_MAX
 15

	)

61 
	#SCAMPER_DO_FPRINTING_NPROBE_MIN
 1

	)

62 
	#SCAMPER_DO_FPRINTING_NPROBE_DEF
 1

	)

63 
	#SCAMPER_DO_FPRINTING_NPROBE_MAX
 20

	)

65 
	#FRP_BAD
 (
sÿm³r_årštšg_»¶y_t
 *)-1

	)

68 
sÿm³r_sk_funcs_t
 
	gårštšg_funcs
;

71 #iâdeà
_WIN32


72 
pid_t
 
	gpid
;

74 
DWORD
 
	gpid
;

78 
sÿm³r_addrÿche_t
 *
addrÿche
;

90 
	sårštšg_¡©e
 {

91 
ušt8_t
 
	md¡»ached
;

92 
ušt8_t
 
	m‰l
;

93 
ušt8_t
 
	mhİs_rg‘
;

94 
ušt8_t
 
	mtı_£Á
;

96 
ušt8_t
 
	m»ad
;

98 
	mpbs_£Á
;

99 
	mpbs_gÙ
;

101 
ušt8_t
 
	mpbcouÁ
;

103 
årštšg_muÉi_addr_t
 *
	maddrsw¬p
;

104 
årštšg_muÉi_addr_t
 *
	maddrs
;

106 } 
	tårštšg_¡©e_t
;

108 
	#FPRINTING_OPT_UDPTTL
 1

	)

109 
	#FPRINTING_OPT_ICMPDLEN
 2

	)

110 
	#FPRINTING_OPT_IPDF
 3

	)

111 
	#FPRINTING_OPT_TOS
 4

	)

112 
	#FPRINTING_OPT_ITTL
 5

	)

113 
	#FPRINTING_OPT_PING
 6

	)

114 
	#FPRINTING_OPT_ICMPECHOTTL
 8

	)

115 
	#FPRINTING_OPT_ICMPTIMETTL
 9

	)

116 
	#FPRINTING_OPT_MPLS
 10

	)

117 
	#FPRINTING_OPT_FINDPROTO
 11

	)

118 
	#FPRINTING_OPT_NFIND
 12

	)

119 
	#FPRINTING_OPT_MULTI
 13

	)

120 
	#FPRINTING_OPT_NPROBE
 14

	)

121 
	#FPRINTING_OPT_DF
 15

	)

123 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

124 {'u', 
NULL
, 
FPRINTING_OPT_UDPTTL
, 
SCAMPER_OPTION_TYPE_NULL
},

125 {'d', 
NULL
, 
FPRINTING_OPT_ICMPDLEN
, 
SCAMPER_OPTION_TYPE_NULL
},

126 {'f', 
NULL
, 
FPRINTING_OPT_IPDF
, 
SCAMPER_OPTION_TYPE_NULL
},

127 {'t', 
NULL
, 
FPRINTING_OPT_TOS
, 
SCAMPER_OPTION_TYPE_NULL
},

128 {'I', "™", 
FPRINTING_OPT_ITTL
, 
SCAMPER_OPTION_TYPE_NUM
},

129 {'p', "pšg", 
FPRINTING_OPT_PING
, 
SCAMPER_OPTION_TYPE_NULL
},

130 {'e', 
NULL
, 
FPRINTING_OPT_ICMPECHOTTL
, 
SCAMPER_OPTION_TYPE_NULL
},

131 {'m', 
NULL
, 
FPRINTING_OPT_ICMPTIMETTL
, 
SCAMPER_OPTION_TYPE_NULL
},

132 {'s', 
NULL
, 
FPRINTING_OPT_MPLS
, 
SCAMPER_OPTION_TYPE_NULL
},

133 {'O', "´Ùo", 
FPRINTING_OPT_FINDPROTO
, 
SCAMPER_OPTION_TYPE_STR
},

134 {'N', "nfšd", 
FPRINTING_OPT_NFIND
, 
SCAMPER_OPTION_TYPE_NUM
},

135 {'M', "muÉi", 
FPRINTING_OPT_MULTI
, 
SCAMPER_OPTION_TYPE_STR
},

136 {'P', "pbcouÁ", 
FPRINTING_OPT_NPROBE
, 
SCAMPER_OPTION_TYPE_NUM
},

137 {'a', 
NULL
, 
FPRINTING_OPT_DF
, 
SCAMPER_OPTION_TYPE_NULL
},

140 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

142 cÚ¡ *
	$sÿm³r_do_årštšg_u§ge
() {

144 
	}
}

146 
sÿm³r_årštšg_t
 *
	$årštšg_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
) {

147  
	`sÿm³r_sk_g‘d©a
(
sk
);

148 
	}
}

150 
årštšg_¡©e_t
 *
	$årštšg_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
) {

151  
	`sÿm³r_sk_g‘¡©e
(
sk
);

152 
	}
}

155 
	$årštšg_¡İ
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
»asÚ
, ušt8_ˆ
d©a
) {

156 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

157 
årštšg
->
¡İ_»asÚ
 = 
»asÚ
;

158 
årštšg
->
¡İ_d©a
 = 
d©a
;

160 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

162 
	}
}

164 
	$årštšg_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
) {

165 
	`sÿm³r_debug
(
__func__
, "error in fprinting...");

166 
	`årštšg_¡İ
(
sk
, 
SCAMPER_FPRINTING_STOP_ERROR
, 
”rÜ
);

168 
	}
}

170 
	$årštšg_¡©e_ä“
(
årštšg_¡©e_t
 *
¡©e
) {

171 
årštšg_muÉi_addr_t
 *
t
 = 
¡©e
->
addrsw¬p
;

172 
t
 !ğ
NULL
) {

173 
¡©e
->
addrs
 = 
t
;

174 
t
 =->
Ãxt
;

175 
	`ä“
(
¡©e
->
addrs
);

177 
	`ä“
(
¡©e
);

179 
	}
}

183 
	$årštšg_d¡»ached
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
gÙ
) {

184 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

185 
årštšg_¡©e_t
 *
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

186 
årštšg_muÉi_addr_t
 *
addrs
;

187 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

189 
¡©e
->
d¡»ached
 = 1;

190 
¡©e
->
hİs_rg‘
 = s‹->
‰l
;

191 
¡©e
->
‰l
 = 255;

192 
¡©e
->
tı_£Á
 = 1;

193 if(
gÙ
)

194 
¡©e
->
»ad
 = 0;

195 
¡©e
->
addrsw¬p
 = s‹->
addrs
;

197 
¡©e
->
pbcouÁ
 = 0;

200 
addrs
 = 
¡©e
->addrs;

201 
addrs
 !ğ
NULL
) {

203 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
) {

204 
”r
;

208 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
addrs
->
addr
);

209 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0) {

210 
”r
;

212 
addrs
 =‡ddrs->
Ãxt
;

216 if(
årštšg
->
ismuÉi
 && f´štšg->
curd¡s
->
Ãxt
 !ğ
NULL
) {

217 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
) {

218 
”r
;

220 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
årštšg
->
curd¡s
->
Ãxt
->
addr
);

221 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0) {

222 
”r
;

225 
	`sÿm³r_sk_sig_š¡®l
(
sk
);

229 
”r
:

230 if(
sig
 !ğ
NULL
)

231 
	`sÿm³r_sk_sig_ä“
(
sig
);

232 
	`årštšg_hªdË”rÜ
(
sk
, 3);

233 
	}
}

235 
	$årštšg_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
) {

236 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

237 
årštšg_¡©e_t
 *
¡©e
 = 
NULL
;

238 
size_t
 
size
;

239 
i
;

241 if((
¡©e
 = 
	`m®loc_z”o
((
årštšg_¡©e_t
))è=ğ
NULL
) {

242 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

243 
”r
;

245 
¡©e
->
‰l
 = 
årštšg
->
i¥šg
 ? 255 : f´štšg->
™
;

246 
¡©e
->
d¡»ached
 = 
årštšg
->
i¥šg
;

247 
¡©e
->
»ad
 = 1;

249 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

253 
”r
:

255 
	}
}

258 
	$do_årštšg_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
) {

259 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

260 
årštšg_¡©e_t
 *
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

261 
årštšg__»¶›s_t
 *
t
;

263 
¡©e
->
»ad
 = 1;

265 if((
årštšg
->
ismuÉi
 =ğ0 || f´štšg->
curd¡s
->
Ãxt
 =ğ
NULL
) &&

266 
¡©e
->
d¡»ached
 &&

267 ((
¡©e
->
tı_£Á
 =ğ¡©e->
hİs_rg‘
 + 1 || s‹->
addrs
 =ğ
NULL
) &&

268 (
¡©e
->
pbcouÁ
 =ğ
årštšg
->
Årobe
 || state->pbcount == 0))) {

269 
	`årštšg_¡İ
(
sk
, 
SCAMPER_FPRINTING_STOP_COMPLETED
, 0);

271 } if(!
¡©e
->
d¡»ached
) {

272 
¡©e
->
‰l
++;

275 if(
¡©e
->
d¡»ached
 =ğ0 && (¡©e->
‰l
 > 32 || s‹->
pbs_£Á
 - s‹->
pbs_gÙ
 > 4)) {

276 if(
¡©e
->
d¡»ached
 == 0) {

278 
	`årštšg_d¡»ached
(
sk
, 0);

279 } if(
årštšg
->
ismuÉi
 =ğ1 && f´štšg->
curd¡s
->
Ãxt
 !ğ
NULL
) {

281 
	`årštšg_¡©e_ä“
(
¡©e
);

282 if(
	`årštšg_¡©e_®loc
(
sk
) != 0) {

283 
	`årštšg_hªdË”rÜ
(
sk
, 7);

286 
	`g‘timeofday_w¿p
(&
årštšg
->
¡¬t
);

287 
årštšg
->
curd¡s
 = f´štšg->curd¡s->
Ãxt
;

288 
årštšg
->
d¡
 = f´štšg->
curd¡s
->
addr
;

290 
t
 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

291 if(
t
 =ğ
NULL
) {

292 
	`årštšg_hªdË”rÜ
(
sk
, 4);

295 
t
->
‰Ëxp
 = 
FRP_BAD
;

296 
t
->
®»adyProbed
 = 0;

297 
	`š£¹EËm’t
(
årštšg
->
_»¶›s
, f´štšg->
d¡
, 
t
);

300 
	`årštšg_hªdË”rÜ
(
sk
, 5);

305 
	}
}

307 
	$¡©e_muÉi_addr_add
(
årštšg_¡©e_t
 *
årštšg
, 
sÿm³r_addr_t
 *
addr
) {

308 
årštšg_muÉi_addr_t
 *
t
 = 
	`ÿÎoc
(1, (fprinting_multi_addr_t));

309 if(
årštšg
->
addrs
 =ğ
NULL
) {

310 
årštšg
->
addrs
 = 
t
;

311 
årštšg
->
addrs
->
addr
 =‡ddr;

313 
t
->
addr
 =‡ddr;

314 
t
->
Ãxt
 = 
årštšg
->
addrs
;

315 
årštšg
->
addrs
 = 
t
;

317 
	}
}

319 
	$do_årštšg_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
) {

320 
	`sÿm³r_fe_wr™e_årštšg
(
sf
, 
	`årštšg_g‘d©a
(
sk
));

322 
	}
}

325 
	$årštšg_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
) {

326 
tmp
 = 0;

327 
i
;

329 
İtid
) {

330 
FPRINTING_OPT_ITTL
:

331 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

332 
tmp
 < 
SCAMPER_DO_FPRINTING_ITTL_MIN
 ||

333 
tmp
 > 
SCAMPER_DO_FPRINTING_ITTL_MAX
) {

334 
”r
;

337 
FPRINTING_OPT_FINDPROTO
:

338 if(
	`¡ºcmp
("tı", 
·¿m
, 3) == 0)

339 
tmp
 = 
SCAMPER_DO_FPRINTING_PBTCP
;

340 if(
	`¡ºcmp
("echo", 
·¿m
, 4) == 0)

341 
tmp
 = 
SCAMPER_DO_FPRINTING_PBECHO
;

342 if(
	`¡ºcmp
("udp", 
·¿m
, 3) == 0)

343 
tmp
 = 
SCAMPER_DO_FPRINTING_PBUDP
;

345 
”r
;

347 
FPRINTING_OPT_NFIND
:

348 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

349 
tmp
 < 
SCAMPER_DO_FPRINTING_NFIND_MIN
 ||

350 
tmp
 > 
SCAMPER_DO_FPRINTING_NFIND_MAX
) {

351 
”r
;

354 
FPRINTING_OPT_NPROBE
:

355 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

356 
tmp
 < 
SCAMPER_DO_FPRINTING_NPROBE_MIN
 ||

357 
tmp
 > 
SCAMPER_DO_FPRINTING_NPROBE_MAX
) {

358 
”r
;

361 
FPRINTING_OPT_MULTI
:

362 
tmp
 = 0;

369 if(
out
 !ğ
NULL
) {

370 *
out
 = 
tmp
;

374 
”r
:

376 
	}
}

382 
	$sÿm³r_do_årštšg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
) {

383  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

384 
årštšg_¬g_·¿m_v®id©e
);

385 
	}
}

394 *
	$sÿm³r_do_årštšg_®loc
(*
¡r
) {

395 
ušt8_t
 
‰l
 = 
SCAMPER_DO_FPRINTING_ITTL_DEF
;

396 
ušt8_t
 
i£chÙ
 = 0;

397 
ušt8_t
 
isud±
 = 0;

398 
ušt8_t
 
isicmpdËn
 = 0;

399 
ušt8_t
 
isdf
 = 0;

400 
ušt8_t
 
i¡os
 = 0;

401 
ušt8_t
 
i¡ime
 = 0;

402 
ušt8_t
 
ism¶s
 = 0;

403 
ušt8_t
 
i¥šg
 = 0;

404 
ušt8_t
 
i§df
 = 0;

405 
ušt8_t
 
pbmode
 = 
SCAMPER_DO_FPRINTING_PBTCP
;

406 
ušt8_t
 
nfšd
 = 
SCAMPER_DO_FPRINTING_NFIND_DEF
;

407 
ušt8_t
 
Årobe
 = 
SCAMPER_DO_FPRINTING_NPROBE_DEF
;

408 
ušt8_t
 
ismuÉi
 = 0;

410 
mode_t
 
mode
;

411 
fd
;

412 
FILE
 *
fe
;

413 #iâdeà
_WIN32


414 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

416 
mode
 = 
_S_IREAD
 | 
_S_IWRITE
;

419 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

420 
sÿm³r_årštšg_t
 *
årštšg
 = 
NULL
;

421 
årštšg__»¶›s_t
 *
t
;

422 
ušt16_t
 
cmps
 = 0;

423 *
addr
 = 
NULL
;

424 
size_t
 
size
;

425 
tmp
 = 0;

426 
i
;

429 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0) {

430 
”r
;

434 if((
årštšg
 = 
	`sÿm³r_årštšg_®loc
()è=ğ
NULL
) {

435 
”r
;

439 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
) {

440 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

441 
	`årštšg_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0) {

442 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

443 
”r
;

446 
İt
->
id
) {

447 
FPRINTING_OPT_ICMPECHOTTL
:

448 
i£chÙ
 = 1;

451 
FPRINTING_OPT_UDPTTL
:

452 
isud±
 = 1;

455 
FPRINTING_OPT_ICMPDLEN
:

456 
isicmpdËn
 = 1;

459 
FPRINTING_OPT_IPDF
:

460 
isdf
 = 1;

463 
FPRINTING_OPT_TOS
:

464 
i¡os
 = 1;

467 
FPRINTING_OPT_ITTL
:

468 
‰l
 = (
ušt8_t
)
tmp
;

471 
FPRINTING_OPT_PING
:

472 
i¥šg
 = 1;

475 
FPRINTING_OPT_ICMPTIMETTL
:

476 
i¡ime
 = 1;

479 
FPRINTING_OPT_MPLS
:

480 
ism¶s
 = 1;

483 
FPRINTING_OPT_FINDPROTO
:

484 
pbmode
 = (
ušt8_t
)
tmp
;

487 
FPRINTING_OPT_NFIND
:

488 
nfšd
 = (
ušt8_t
)
tmp
;

491 
FPRINTING_OPT_NPROBE
:

492 
Årobe
 = (
ušt8_t
)
tmp
;

496 
FPRINTING_OPT_DF
:

497 
i§df
 = 1;

500 
FPRINTING_OPT_MULTI
:

501 
ismuÉi
 = 1;

502 if(
addr
 !ğ
NULL
) {

503 
	`årštšg_muÉi_addr_add
(
årštšg
, 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
addr
));

505 
addr
 = 
	`ÿÎoc
(255, 1);

506 if(
addr
 =ğ
NULL
è
”r
;

507 #iâdeà
WITHOUT_PRIVSEP


508 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
İt
->
¡r
, 
O_RDWR
, 
mode
);

510 
fd
 = 
	`İ’
(
İt
->
¡r
, 
O_RDWR
, 
mode
);

512 if(
fd
 == -1) {

513 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "Bad file");

514 
”r
;

516 if((
fe
 = 
	`fdİ’
(
fd
, "r")è=ğ
NULL
) {

517 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "Bad file");

518 
”r
;

520 
	`fg‘s
(
addr
, 254, 
fe
)) {

521 
	`årštšg_muÉi_addr_add
(
årštšg
, 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
addr
));

522 
	`mem£t
(
addr
, 0, 255);

524 
	`ä“
(
addr
);

525 
	`fşo£
(
fe
);

526 
årštšg
->
curd¡s
 = f´štšg->
md¡s
;

527 
årštšg
->
d¡
 = f´štšg->
curd¡s
->
addr
;

530 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

533 if(
ismuÉi
 =ğ0 && 
addr
 =ğ
NULL
) {

534 
”r
;

537 if(
ismuÉi
 =ğ0 && (
årštšg
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_UNSPEC
, 
addr
)è=ğ
NULL
) {

538 
”r
;

541 
t
 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

542 if(
t
 =ğ
NULL
) {

543 
”r
;

545 
t
->
‰Ëxp
 = 
FRP_BAD
;

546 
t
->
®»adyProbed
 = 0;

547 
	`š£¹EËm’t
(
årštšg
->
_»¶›s
, f´štšg->
d¡
, 
t
);

549 
årštšg
->
™
 = 
‰l
;

550 
årštšg
->
i£chÙ
 = isechottl;

551 
årštšg
->
i¥šg
 = isping;

552 
årštšg
->
isicmpdËn
 = isicmpdlen;

553 
årštšg
->
isdf
 = isipdf;

554 
årštšg
->
i¡os
 = istos;

555 
årštšg
->
isud±
 = isudpttl;

556 
årštšg
->
isicm±im‘
 = 
i¡ime
;

557 
årštšg
->
ism¶s
 = ismpls;

558 
årštšg
->
pbmode
 =…bmode;

559 
årštšg
->
nfšd
 =‚find;

560 
årštšg
->
Årobe
 =‚probe;

561 
årštšg
->
ismuÉi
 = ismulti;

562 
årštšg
->
i§df
 = isadf;

564 
årštšg
->
¥Üt
 = (
pid
 & 0xffff) | 0x8000;

565 
årštšg
->
dpÜt
 = 33435;

567  
årštšg
;

569 
”r
:

570 if(
årštšg
 !ğ
NULL
) {

571 
	`sÿm³r_årštšg_ä“
(
årštšg
);

573 if(
İts_out
 !ğ
NULL
) {

574 
	`sÿm³r_İtiÚs_ä“
(
İts_out
);

576  
NULL
;

577 
	}
}

579 
	$do_årštšg_h®t
(
sÿm³r_sk_t
 *
sk
) {

580 
	`årštšg_¡İ
(
sk
, 
SCAMPER_FPRINTING_STOP_HALTED
, 0);

582 
	}
}

584 
	$do_årštšg_ä“
(
sÿm³r_sk_t
 *
sk
) {

585 
sÿm³r_årštšg_t
 *
årštšg
;

586 
årštšg_¡©e_t
 *
¡©e
;

588 if((
årštšg
 = 
	`årštšg_g‘d©a
(
sk
)è!ğ
NULL
) {

589 
	`sÿm³r_årštšg_ä“
(
årštšg
);

592 if((
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
)è!ğ
NULL
) {

593 
	`årštšg_¡©e_ä“
(
¡©e
);

597 
	}
}

599 
sÿm³r_sk_t
 *
	$sÿm³r_do_årštšg_®loùask
(*
d©a
) {

600 
sÿm³r_årštšg_t
 *
årštšg
 = (sÿm³r_årštšg_ˆ*)
d©a
;

601 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

602 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

605 if((
sk
 = 
	`sÿm³r_sk_®loc
(
årštšg
, &
årštšg_funcs
)è=ğ
NULL
) {

606 
”r
;

610 if(
årštšg
->
ismuÉi
 == 0) {

611 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
) {

612 
”r
;

614 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
årštšg
->
d¡
);

615 if(
årštšg
->
¤c
 =ğ
NULL
 && (årštšg->¤øğ
	`sÿm³r_g‘¤c
(årštšg->
d¡
, 0)) == NULL) {

616 
”r
;

618 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0) {

619 
”r
;

621 
sig
 = 
NULL
;

623 
årštšg
->
curd¡s
 !ğ
NULL
) {

624 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
) {

625 
”r
;

627 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
årštšg
->
curd¡s
->
addr
);

628 if(
årštšg
->
¤c
 =ğ
NULL
 && (årštšg->¤øğ
	`sÿm³r_g‘¤c
(årštšg->
d¡
, 0)) == NULL) {

629 
”r
;

631 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0) {

632 
”r
;

634 
sig
 = 
NULL
;

635 
årštšg
->
curd¡s
 = f´štšg->curd¡s->
Ãxt
;

637 
årštšg
->
curd¡s
 = f´štšg->
md¡s
;

640  
sk
;

642 
”r
:

643 if(
sig
 !ğ
NULL
) {

644 
	`sÿm³r_sk_sig_ä“
(
sig
);

646 if(
sk
 !ğ
NULL
) {

647 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

648 
	`sÿm³r_sk_ä“
(
sk
);

650  
NULL
;

651 
	}
}

653 
	$sÿm³r_do_årštšg_ä“
(*
d©a
) {

654 
	`sÿm³r_årštšg_ä“
((
sÿm³r_årštšg_t
 *)
d©a
);

656 
	}
}

658 
	$sÿm³r_do_årštšg_ş—nup
() {

660 
	}
}

663 
ušt8_t
 
	$årštšg_»cÜd
(
sÿm³r_årštšg_t
 *
årštšg
, 
sÿm³r_årštšg_»¶y_t
 *
»¶y
) {

664 
ušt8_t
 
f¡
 = 0;

665 
sÿm³r_årštšg_»¶y_t
 *
r
, *
½
;

666 
årštšg__»¶›s_t
 *

 = 
	`g‘V®ue
(
årštšg
->
_»¶›s
, 
»¶y
->
addr
);

671 
	`sÿm³r_årštšg_»¶y_­³nd
(
årštšg
, 
»¶y
);

673 if(

 =ğ
NULL
)

674 

 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

675 if(

 =ğ
NULL
)

676 
”r
;

678 if(

->
tı
 =ğ
NULL
 && 
	`SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
)) {

679 
f¡
 = 1;

680 

->
tı
 = 
»¶y
;

681 } if(

->
echo
 =ğ
NULL
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
)) {

682 
f¡
 = 1;

683 

->
echo
 = 
»¶y
;

684 } if(

->
±uÄ—ch
 =ğ
NULL
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
)) {

685 
f¡
 = 1;

686 

->
±uÄ—ch
 = 
»¶y
;

687 } if(

->
‰Ëxp
 =ğ
NULL
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
)) {

688 
f¡
 = 1;

689 

->
‰Ëxp
 = 
»¶y
;

690 } if(

->
time
 =ğ
NULL
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
)) {

691 
f¡
 = 1;

692 

->
time
 = 
»¶y
;

695 if(
f¡
) {

696 

->
®»adyProbed
 = 1;

697 
	`š£¹EËm’t
(
årštšg
->
_»¶›s
, 
»¶y
->
addr
, 

);

700 
f¡
 = 2;

704 if(

->
tı
 !ğ
FRP_BAD
 && 
	`SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
è&& ip->tı->
os_‰l
 !=„eply->os_ttl) {

705 
f¡
 = 0;

706 

->
tı
 = 
FRP_BAD
;

707 } if(

->
echo
 !ğ
FRP_BAD
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
è&& ip->echo->
os_‰l
 !=„eply->os_ttl) {

708 
f¡
 = 0;

709 

->
echo
 = 
FRP_BAD
;

710 } if(

->
±uÄ—ch
 !ğ
FRP_BAD
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
è&& ip->±uÄ—ch->
os_‰l
 !=„eply->os_ttl) {

711 
f¡
 = 0;

712 

->
±uÄ—ch
 = 
FRP_BAD
;

713 } if(

->
‰Ëxp
 !ğ
FRP_BAD
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
è&& ip->‰Ëxp->
os_‰l
 !=„eply->os_ttl) {

714 
f¡
 = 0;

715 

->
‰Ëxp
 = 
FRP_BAD
;

716 } if(

->
time
 !ğ
FRP_BAD
 && 
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
è&& ip->time->
os_‰l
 !=„eply->os_ttl) {

717 
f¡
 = 0;

718 

->
time
 = 
FRP_BAD
;

720 
”r
;

722  
f¡
;

724 
”r
:

727 
	}
}

738 
ušt8_t
 
	$two_up
(
ušt8_t
 
ba£
) {

739 
ušt16_t
 
r
 = 32;

740 
r
 < 
ba£
) {

741 
r
 <<= 1;

743  (
r
 > 255è? 255 : (
ušt8_t
)r;

744 
	}
}

747 
	$do_årštšg_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
) {

748 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

749 
årštšg_¡©e_t
 *
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

750 
sÿm³r_årštšg_»¶y_t
 *
»¶y
 = 
NULL
;

751 
ušt8_t
 
»c
;

753 if(
dl
->
dl__off
 !ğ0 || 
¡©e
->
»ad
 == 0) {

760 if(!Ğ
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
) ||

761 
	`SCAMPER_DL_IS_TCP
(
dl
) ||

762 
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
)) ||

763 
	`sÿm³r_addr_cmp
(
årštšg
->
¤c
,

764 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
årštšg
->
d¡
->
ty³
,

765 
dl
->
dl__¤c
)) == 0) {

770 
¡©e
->
pbs_gÙ
++;

774 if((
»¶y
 = 
	`sÿm³r_årštšg_»¶y_®loc
()è=ğ
NULL
) {

775 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc fprinting„eply");

776 
”r
;

780 if((
»¶y
->
addr
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
årštšg
->
d¡
->
ty³
,

781 
dl
->
dl__¤c
)è=ğ
NULL
) {

782 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„eply‡ddr");

783 
”r
;

787 
»¶y
->
»¶y_size
 = 
dl
->
dl__size
;

788 
»¶y
->
»¶y_´Ùo
 = 
dl
->
dl__´Ùo
;

789 
»¶y
->
»¶y_‰l
 = 
dl
->
dl__‰l
;

790 
»¶y
->
os_‰l
 = 
	`two_up
Ô•ly->
»¶y_‰l
);

793 if(
	`SCAMPER_DL_IS_TCP
(
dl
)) {

794 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

795 
»¶y
->
tı_æags
 = 
dl
->
dl_tı_æags
;

796 
»¶y
->
»¶y_tos
 = 
dl
->
dl__tos
;

797 
»¶y
->
»¶y_df
 = 
dl
->
dl_æags
 & 
SCAMPER_DL_IP_FLAG_DF
;

798 
»¶y
->
»¶y_tı_wš
 = 
dl
->
dl_tı_wš
;

799 
»¶y
->
»¶y_tı_mss
 = 
dl
->
dl_tı_mss
;

800 } if(
	`SCAMPER_DL_IS_ICMP
(
dl
)) {

801 
	`sÿm³r_dl_»c_icmp_´št
(
dl
);

802 
»¶y
->
icmp_ty³
 = 
dl
->
dl_icmp_ty³
;

803 
»¶y
->
icmp_code
 = 
dl
->
dl_icmp_code
;

810 
»c
 = 
	`årštšg_»cÜd
(
årštšg
, 
»¶y
);

811 if(
¡©e
->
d¡»ached
 =ğ0 && 
	`sÿm³r_addr_cmp
(
»¶y
->
addr
, 
årštšg
->
d¡
) == 0) {

812 if(
»c
 == 1)

813 
	`¡©e_muÉi_addr_add
(
¡©e
, 
»¶y
->
addr
);

814 
	`årštšg_d¡»ached
(
sk
, 1);

815 } if(
»c
 =ğ1 && 
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
)) {

816 
	`¡©e_muÉi_addr_add
(
¡©e
, 
»¶y
->
addr
);

821 
”r
:

822 
	`årštšg_hªdË”rÜ
(
sk
, 1);

824 
	}
}

827 
	$do_årštšg_´obe
(
sÿm³r_sk_t
 *
sk
) {

828 
timev®
 
wa™_tv
;

829 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

830 
årštšg_¡©e_t
 *
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

831 
sÿm³r_´obe_t
 
´obe
, *
´obe2
;

832 
årštšg__»¶›s_t
 *

;

833 
ušt16_t
 
id
;

834 
ušt32_t
 
t
;

836 if(
¡©e
 =ğ
NULL
) {

837 if(
	`årštšg_¡©e_®loc
(
sk
) != 0)

838 
”r
;

839 
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

841 
	`g‘timeofday_w¿p
(&
årštšg
->
¡¬t
);

844 if(
årštšg
->
ismuÉi
 && f´štšg->
curd¡s
->
Ãxt
 !ğ
NULL
 &&

845 
¡©e
->
d¡»ached
 &&

846 ((
¡©e
->
tı_£Á
 =ğ¡©e->
hİs_rg‘
 + 1 || s‹->
addrs
 =ğ
NULL
) &&

847 (
¡©e
->
pbcouÁ
 =ğ
årštšg
->
Årobe
 || state->pbcount == 0))) {

848 
	`årštšg_¡©e_ä“
(
¡©e
);

849 
¡©e
 = 
NULL
;

850 
årštšg
->
curd¡s
 = f´štšg->curd¡s->
Ãxt
;

851 
årštšg
->
d¡
 = f´štšg->
curd¡s
->
addr
;

853 

 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

854 if(

 =ğ
NULL
) {

855 
	`årštšg_hªdË”rÜ
(
sk
, 4);

858 

->
‰Ëxp
 = 
FRP_BAD
;

859 

->
®»adyProbed
 = 0;

860 
	`š£¹EËm’t
(
årštšg
->
_»¶›s
, f´štšg->
d¡
, 

);

863 if(
¡©e
 =ğ
NULL
) {

864 if(
	`årštšg_¡©e_®loc
(
sk
) != 0)

865 
”r
;

866 
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

868 
	`g‘timeofday_w¿p
(&
årštšg
->
¡¬t
);

871 
¡©e
->
pbs_£Á
++;

874 
	`mem£t
(&
´obe
, 0, (probe));

875 
´obe
.
´__¤c
 = 
årštšg
->
¤c
;

876 
´obe
.
´__d¡
 = 
årštšg
->
d¡
;

877 
´obe
.
´__‰l
 = 
¡©e
->
‰l
;

878 
´obe
.
´_æags
 = 
SCAMPER_PROBE_FLAG_IPID
;

879 if(
årštšg
->
i§df
) {

880 
´obe
.
´__off
 = 
IP_DF
;

883 if(
¡©e
->
d¡»ached
 == 0) {

886 
´obe
.
´__id
 = 7954 - (
¡©e
->
‰l
 << 8);

887 if(
årštšg
->
pbmode
 =ğ
SCAMPER_DO_FPRINTING_PBTCP
) {

888 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

889 
´obe
.
´_tı_¥Üt
 = 
årštšg
->
¥Üt
;

890 
´obe
.
´_tı_dpÜt
 = 80;

891 
´obe
.
´_tı_æags
 = 
TH_SYN
;

892 
´obe
.
´_tı_£q
 = 0;

893 
´obe
.
´_tı_wš
 = 65535;

894 } if(
årštšg
->
pbmode
 =ğ
SCAMPER_DO_FPRINTING_PBECHO
) {

895 
	`SCAMPER_PROBE_ICMP_ECHO
(&
´obe
, 0, 0);

896 } if(
årštšg
->
pbmode
 =ğ
SCAMPER_DO_FPRINTING_PBUDP
) {

897 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

898 
´obe
.
´_udp_¥Üt
 = 
årštšg
->
¥Üt
;

899 
´obe
.
´_udp_dpÜt
 = 
årštšg
->
dpÜt
 + 20000;

903 if(
årštšg
->
ismuÉi
) {

904 

 = 
	`g‘V®ue
(
årštšg
->
_»¶›s
, f´štšg->
d¡
);

906 if(

->
®»adyProbed
 == 1){

909 if(

 && (->
echo
 || ip->
time
 || ip->
tı
 || ip->
±uÄ—ch
)) {

910 
¡©e
->
tı_£Á
++;

911 if(!
¡©e
->
d¡»ached
 || (¡©e->d¡»ached && (¡©e->
tı_£Á
 =ğ¡©e->
hİs_rg‘
 || s‹->
addrs
 =ğ
NULL
))) {

912 
	`timev®_add_s
(&
wa™_tv
, &
´obe
.
´_tx
, 1);

913 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
wa™_tv
);

915 
	`sÿm³r_sk_queue_´obe
(
sk
);

922 if(
årštšg
->
i¥šg
) {

923 
¡©e
->
hİs_rg‘
 = 1;

924 
¡©e
->
tı_£Á
 = 0;

926 if(
¡©e
->
addrs
 =ğ
NULL
) {

927 
”r_addr
;

930 
´obe
.
´__d¡
 = 
¡©e
->
addrs
->
addr
;

931 if(
¡©e
->
pbcouÁ
 =ğ
årštšg
->
Årobe
 - 1) {

932 
¡©e
->
addrs
 = s‹->addrs->
Ãxt
;

933 
¡©e
->
pbcouÁ
 = -1;

938 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

939 
	`¿ndom_u16
(&
´obe
.
´__id
);

940 
´obe
.
´_tı_¥Üt
 = 
årštšg
->
¥Üt
 + 
¡©e
->
pbcouÁ
;

941 
´obe
.
´_tı_dpÜt
 = 80;

942 
´obe
.
´_tı_æags
 = 
TH_SYN
;

943 
	`¿ndom_u32
(&
´obe
.
´_tı_£q
);

944 
´obe
.
´_tı_wš
 = 14600;

948 if(
årštšg
->
i£chÙ
) {

951 
´obe2
 = 
	`´obe_dup
(&
´obe
);

952 
ušt16_t
 
x
;

953 
	`¿ndom_u16
(&
x
);

954 
	`SCAMPER_PROBE_ICMP_ECHO
(
´obe2
, 
x
, 1);

956 if(
	`sÿm³r_´obe_sk
(
´obe2
, 
sk
) != 0) {

957 
”ºo
 = 
´obe2
->
´_”ºo
;

958 
”r
;

960 
	`u¦“p
(10000);

963 if(
årštšg
->
isicm±im‘
) {

964 
´obe2
 = 
	`´obe_dup
(&
´obe
);

965 
ušt16_t
 
x
;

966 
	`¿ndom_u16
(&
x
);

967 
	`SCAMPER_PROBE_ICMP_TIME
(
´obe2
, 
x
, 0);

968 
timev®
 
tv
;

969 
	`g‘timeofday_w¿p
(&
tv
);

970 
ušt8_t
 *
·ylßd
 = (ušt8_ˆ*)
	`m®loc
(12 * (uint8_t));

971 
	`mem£t
(
·ylßd
, 0, 12);

972 
	`by‹s_htÚl
(
·ylßd
,

973 ((
tv
.
tv_£c
 % 86400è* 1000è+ (tv.
tv_u£c
 / 1000));

974 
´obe2
->
´_d©a
 = 
·ylßd
;

975 
´obe2
->
´_Ën
 = 12;

977 if(
	`sÿm³r_´obe_sk
(
´obe2
, 
sk
) != 0) {

978 
”ºo
 = 
´obe2
->
´_”ºo
;

979 
”r
;

981 
	`ä“
(
·ylßd
);

982 
	`u¦“p
(10000);

984 if(
årštšg
->
isud±
) {

985 
´obe2
 = 
	`´obe_dup
(&
´obe
);

986 
´obe2
->
´__´Ùo
 = 
IPPROTO_UDP
;

987 
	`¿ndom_u16
(&
´obe2
->
´__id
);

988 
´obe2
->
´_udp_¥Üt
 = 
årštšg
->
¥Üt
;

989 
´obe2
->
´_udp_dpÜt
 = 
årštšg
->
dpÜt
 + 20000;

990 if(
	`sÿm³r_´obe_sk
(
´obe2
, 
sk
) != 0) {

991 
”ºo
 = 
´obe2
->
´_”ºo
;

992 
”r
;

994 
	`u¦“p
(10000);

1000 if(
¡©e
->
d¡»ached
 =ğ0 && 
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0) {

1001 
”ºo
 = 
´obe
.
´_”ºo
;

1002 
”r
;

1006 
id
 = 1; ipid < (
¡©e
->
d¡»ached
? 0 : 
årštšg
->
nfšd
); ipid++) {

1007 
	`u¦“p
(25000);

1011 if(
¡©e
->
d¡»ached
 == 0)

1012 
´obe
.
´__id
 +ğ
id
 * 
årštšg
->
¥Üt
;

1013 if(
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0) {

1014 
”ºo
 = 
´obe
.
´_”ºo
;

1015 
”r
;

1019 
¡©e
->
pbcouÁ
++;

1021 if(
¡©e
->
d¡»ached
 && s‹->
pbcouÁ
 == 1) {

1022 
¡©e
->
tı_£Á
++;

1024 if(!
¡©e
->
d¡»ached
 || (¡©e->d¡»ached && (¡©e->
tı_£Á
 =ğ¡©e->
hİs_rg‘
 || s‹->
addrs
 =ğ
NULL
))) {

1025 
	`timev®_add_s
(&
wa™_tv
, &
´obe
.
´_tx
, 1);

1026 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
wa™_tv
);

1028 
	`timev®_add_ms
(&
wa™_tv
, &
´obe
.
´_tx
, 25);

1029 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
wa™_tv
);

1034 
”r
:

1035 
	`årštšg_hªdË”rÜ
(
sk
, 19);

1038 
”r_addr
:

1039 
	`årštšg_hªdË”rÜ
(
sk
, 20);

1041 
	}
}

1044 
	$do_årštšg_hªdË_icmp
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
) {

1045 
sÿm³r_årštšg_t
 *
årštšg
 = 
	`årštšg_g‘d©a
(
sk
);

1046 
årštšg_¡©e_t
 *
¡©e
 = 
	`årštšg_g‘¡©e
(
sk
);

1047 
sÿm³r_årštšg_»¶y_t
 *
»¶y
 = 
NULL
;

1048 
sÿm³r_addr_t
 
addr
;

1049 
årštšg__»¶›s_t
 *

;

1050 
ušt8_t
 
»c
;

1052 if(!(
	`SCAMPER_ICMP_RESP_IS_TIME_REPLY
(
œ
è|| 
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(ir))) {

1056 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
addr
) != 0)

1057 
”r
;

1060 if(
¡©e
->
d¡»ached
 == 0) {

1061 

 = 
	`g‘V®ue
(
årštšg
->
_»¶›s
, 
sÿm³r_addrÿche_g‘


1062 (
addrÿche
, 
addr
.
ty³
,‡ddr.addr));

1063 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
è&& 

 && ip->
‰Ëxp
)

1067 
¡©e
->
pbs_gÙ
++;

1070 if((
»¶y
 = 
	`sÿm³r_årštšg_»¶y_®loc
()è=ğ
NULL
) {

1071 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc fprinting„eply");

1072 
”r
;

1077 
»¶y
->
addr
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
,‡ddr.
ty³
,‡ddr.addr);

1078 if(
»¶y
->
addr
 =ğ
NULL
)

1079 
”r
;

1082 
»¶y
->
»¶y_size
 = 
œ
->
œ__size
;

1083 
»¶y
->
»¶y_´Ùo
 = 
IPPROTO_ICMP
;

1084 
»¶y
->
»¶y_‰l
 = 
œ
->
œ__‰l
;

1085 
»¶y
->
os_‰l
 = 
	`two_up
Ô•ly->
»¶y_‰l
);

1087 
	`sÿm³r_icmp_»¥_´št
(
œ
);

1088 
»¶y
->
icmp_ty³
 = 
œ
->
œ_icmp_ty³
;

1089 
»¶y
->
icmp_code
 = 
œ
->
œ_icmp_code
;

1092 if(
årštšg
->
ism¶s
 && 
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
)){

1093 
»¶y
->
»¶y_q_‰l
 = 
œ
->
œ_šÃr__‰l
;

1094 
»¶y
->
»¶y_q_tos
 = 
œ
->
œ_šÃr__tos
;

1095 if(
œ
->
œ_ext
 !ğ
NULL
){

1096 
»¶y
->
is_m¶s
 = 1;

1097 if(
	`sÿm³r_icm³xt_·r£
(&
»¶y
->
»¶y_ext
,

1098 
œ
->
œ_ext
, ir->
œ_ex’
) != 0){

1099 
	`sÿm³r_årštšg_»¶y_ä“
(
»¶y
);

1100  
NULL
;

1104 
»¶y
->
is_m¶s
 = 0;

1107 
»c
 = 
	`årštšg_»cÜd
(
årštšg
, 
»¶y
);

1108 if(
¡©e
->
d¡»ached
 =ğ0 && 
	`sÿm³r_addr_cmp
(
»¶y
->
addr
, 
årštšg
->
d¡
) == 0) {

1109 if(
»c
 == 1)

1110 
	`¡©e_muÉi_addr_add
(
¡©e
, 
»¶y
->
addr
);

1111 
	`årštšg_d¡»ached
(
sk
, 1);

1112 } if(
»c
 =ğ1 && 
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
)) {

1113 
	`¡©e_muÉi_addr_add
(
¡©e
, 
»¶y
->
addr
);

1117 
”r
:

1118 if(
»¶y
 !ğ
NULL
è
	`sÿm³r_årštšg_»¶y_ä“
(reply);

1119 
	`årštšg_hªdË”rÜ
(
sk
, 
”ºo
);

1121 
	}
}

1123 
	$sÿm³r_do_årštšg_š™
() {

1124 
årštšg_funcs
.
´obe
 = 
do_årštšg_´obe
;

1125 
årštšg_funcs
.
hªdË_icmp
 = 
do_årštšg_hªdË_icmp
;

1126 
årštšg_funcs
.
hªdË_timeout
 = 
do_årštšg_hªdË_timeout
;

1127 
årštšg_funcs
.
hªdË_dl
 = 
do_årštšg_hªdË_dl
;

1128 
årštšg_funcs
.
wr™e
 = 
do_årštšg_wr™e
;

1129 
årštšg_funcs
.
sk_ä“
 = 
do_årštšg_ä“
;

1130 
årštšg_funcs
.
h®t
 = 
do_årštšg_h®t
;

1132 #iâdeà
_WIN32


1133 
pid
 = 
	`g‘pid
();

1135 
pid
 = 
	`G‘Cu¼’tProûssId
();

1139 
	}
}

	@fprinting/scamper_fprinting_do.h

24 #iâdeà
__SCAMPER_DO_FPRINTING_H


25 
	#__SCAMPER_DO_FPRINTING_H


	)

27 *
sÿm³r_do_årštšg_®loc
(*
¡r
);

29 
sÿm³r_sk_t
 *
sÿm³r_do_årštšg_®loùask
(*
d©a
);

41 
sÿm³r_do_årštšg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

43 
sÿm³r_do_årštšg_ä“
(*
d©a
);

45 cÚ¡ *
sÿm³r_do_årštšg_u§ge
();

47 
sÿm³r_do_årštšg_ş—nup
();

48 
sÿm³r_do_årštšg_š™
();

	@fprinting/scamper_fprinting_text.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r_addr.h
"

34 
	~"sÿm³r_årštšg.h
"

35 
	~"sÿm³r_fe.h
"

36 
	~"sÿm³r_årštšg_‹xt.h
"

38 
	~"uts.h
"

42 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP
(
»¶y
èĞ\

	)

43 ((
	g»¶y
)->
	gaddr
->
	gty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

44 (
»¶y
)->
»¶y_´Ùo
 == 1) || \

45 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

46 (
»¶y
)->
»¶y_´Ùo
 == 58))

48 
	#SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
èĞ\

	)

49 ((
»¶y
)->
»¶y_´Ùo
 == 6))

51 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
èĞ\

	)

52 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

53 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 0) || \

54 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

55 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 129))

57 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
èĞ\

	)

58 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

59 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ11 && (»¶y)->
icmp_code
 == 0) || \

60 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

61 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 3))

63 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TIMEF_EXP
(
»¶y
èĞ\

	)

64 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

65 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ11 && (»¶y)->
icmp_code
 == 1) || \

66 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

67 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 3))

69 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
èĞ\

	)

70 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

71 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ3 && (»¶y)->
icmp_code
 == 3) || \

72 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

73 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 == 1))

75 
	#SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
èĞ\

	)

76 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

77 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 14))

80 *
	$‹xt_mode
(
ušt8_t
 
m
) {

81 
t
[4][10] = {"TCP SYN", "ICMP ECHO", "UDP", "UNKNOWN"};

82 if(
m
 =ğ
SCAMPER_DO_FPRINTING_PBTCP
)

83  
t
[0];

84 if(
m
 =ğ
SCAMPER_DO_FPRINTING_PBECHO
)

85  
t
[1];

86 if(
m
 =ğ
SCAMPER_DO_FPRINTING_PBUDP
)

87  
t
[2];

89  
t
[3];

90 
	}
}

92 *
	$de¡s_muÉi
(
sÿm³r_årštšg_t
 *
årštšg
, *
d¡
) {

93 
»t
[] = "SEVERAL IP'S";

94 if(
årštšg
->
ismuÉi
 == 0)

95  
	`sÿm³r_addr_to¡r
(
årštšg
->
d¡
, dst, 64);

96  
»t
;

97 
	}
}

100 *
	$årštšg_h—d”
(
sÿm³r_årštšg_t
 *
årštšg
) {

101 
h—d”
[192], 
¤c
[64], 
d¡
[64];

103 
	`¢´štf
(
h—d”
, (header), "FPRINTING FROM %s TO %s MODE %s (Finding…rotocol: %s, #Find: %d, #Probe: %d)\n",

104 
	`sÿm³r_addr_to¡r
(
årštšg
->
¤c
, src, (src)),

105 
	`de¡s_muÉi
(
årštšg
, 
d¡
),

106 (
årštšg
->
i¥šg
 ? "PING" : "TRACEROUTE"),

107 
	`‹xt_mode
(
årštšg
->
pbmode
), f´štšg->
nfšd
, f´štšg->
Årobe
);

109  
	`¡rdup
(
h—d”
);

110 
	}
}

113 *
	$df£t
(
ušt8_t
 
df
) {

114 
Çmes
[2][13] = {"[df set]", "[df‚ot set]"};

115 if(
df
) {

116  
Çmes
[0];

118  
Çmes
[1];

119 
	}
}

122 *
	$årštšg_»¶y
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

123 cÚ¡ 
sÿm³r_årštšg_»¶y_t
 *
»¶y
) {

124 
buf
[512], 
a
[64];

125 
ušt8_t
 
i
;

126 
size_t
 
off
 = 0;

127 
sÿm³r_icm³xt_t
 *
›
;

128 
ušt32_t
 
u32
 = 0;

130 
	`sÿm³r_addr_to¡r
(
»¶y
->
addr
, 
a
, (a));

132 if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
)) {

133 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

135 
»¶y
->
»¶y_size
, 
a
,„•ly->
»¶y_‰l
,‡,„•ly->
os_‰l
,„•ly->
is_m¶s
) ;

136 if(
»¶y
->
is_m¶s
){

137 
›
 = 
»¶y
->
»¶y_ext
;

138 if(
	`SCAMPER_ICMPEXT_IS_MPLS
(
›
)){

139 
i
=0; i<
	`SCAMPER_ICMPEXT_MPLS_COUNT
(
›
); i++)

141 
u32
 = 
	`SCAMPER_ICMPEXT_MPLS_LABEL
(
›
, 
i
);

142 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%9stl: %d, s: %d,ƒxp: %d,†abel: %d\n",

143 (
i
 == 0) ? "mplsƒxt" : "",

144 
	`SCAMPER_ICMPEXT_MPLS_TTL
(
›
, 
i
),

145 
	`SCAMPER_ICMPEXT_MPLS_S
(
›
, 
i
),

146 
	`SCAMPER_ICMPEXT_MPLS_EXP
(
›
, 
i
), 
u32
);

151 } if(
	`SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
)) {

152 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

154 
»¶y
->
»¶y_size
, 
a
,„•ly->
»¶y_‰l
,„•ly->
»¶y_tos
,

155 
a
, 
»¶y
->
os_‰l
,„•ly->
»¶y_tı_wš
,„•ly->
»¶y_tı_mss
);

156 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
)) {

157 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

159 
»¶y
->
»¶y_size
, 
a
,„•ly->
»¶y_‰l
,‡,„•ly->
os_‰l
);

160 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
)) {

161 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

163 
»¶y
->
»¶y_size
, 
a
,„•ly->
»¶y_‰l
,‡,„•ly->
os_‰l
);

164 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
)){

165 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

167 
»¶y
->
»¶y_size
, 
a
,„•ly->
»¶y_‰l
,‡,„•ly->
os_‰l
);

170  
	`¡rdup
(
buf
);

171 
	}
}

174 *
	$årštšg_¡©s
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
) {

175 
sÿm³r_årštšg_¡©s_t
 
¡©s
;

176 
size_t
 
off
 = 0;

177 
¡r
[64];

178 
buf
[1024];

179 
½
 = 0;

181 if(
	`sÿm³r_årštšg_¡©s
(
årštšg
, &
¡©s
) != 0) {

182  
NULL
;

185 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "--- FPRINTING QUICK STATS (BASED ON RECEIVED ANSWERS)---\n");

186 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

188 
¡©s
.
Átim“xcŸp
[1], stats.nttltimeexciap[2], stats.nttltimeexciap[3], stats.nttltimeexciap[4], stats.nttltimeexciap[0]);

189 if(
årštšg
->
i¡ı
)

190 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

192 
¡©s
.
ÁsynŸp
[1], stats.nttlsyniap[2], stats.nttlsyniap[3], stats.nttlsyniap[4], stats.nttlsyniap[0]);

193 if(
årštšg
->
i£chÙ
)

194 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

196 
¡©s
.
Áecho
[1], stats.nttlecho[2], stats.nttlecho[3], stats.nttlecho[4], stats.nttlecho[0]);

197 if(
årštšg
->
isicm±im‘
)

198 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

200 
¡©s
.
Áicm±ime
[1], stats.nttlicmptime[2], stats.nttlicmptime[3], stats.nttlicmptime[4], stats.nttlicmptime[0]);

201 if(
årštšg
->
isud±
)

202 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

204 
¡©s
.
Áudp
[1], stats.nttludp[2], stats.nttludp[3], stats.nttludp[4], stats.nttludp[0]);

205 if(
årštšg
->
isdf
) {

206 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%d IP_DF s‘ (%à%%)\n", 
¡©s
.
ndf
, 100.0à* ()¡©s.ndf/()¡©s.
Áı
);

208 if(
årštšg
->
i¡os
) {

209 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%d IP_TOS‚Ù‚uÎ (%à%%)\n", 
¡©s
.
Áos
, 100.0à* ()¡©s.Áos/()¡©s.
Áı
);

211 if(
årštšg
->
isicmpdËn
) {

212 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "icm°time-ex°·ck‘‡vg†’: %àby‹s\n", 
¡©s
.
tim“xc_avgËn
);

215  
	`¡rdup
(
buf
);

216 
	}
}

219 
	$sÿm³r_fe_‹xt_årštšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

220 cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
) {

221 
sÿm³r_årštšg_»¶y_t
 *
»¶y
;

222 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

223 
off_t
 
off
 = 0;

224 
ušt32_t
 
»¶y_couÁ
 = 
	`sÿm³r_årštšg_»¶y_couÁ
(
årštšg
);

225 *
h—d”
 = 
NULL
;

226 
size_t
 
h—d”_Ën
 = 0;

227 **
»¶›s
 = 
NULL
;

228 
size_t
 *
»¶y_Ëns
 = 
NULL
;

229 *
¡©s
 = 
NULL
;

230 
size_t
 
¡©s_Ën
 = 0;

231 *
¡r
 = 
NULL
;

232 
size_t
 
Ën
 = 0;

233 
size_t
 
wc
 = 0;

234 
»t
 = -1;

235 
ušt32_t
 
i
;

238 if(
fd
 !ğ1 && (
off
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1) {

243 if((
h—d”
 = 
	`årštšg_h—d”
(
årštšg
)è=ğ
NULL
) {

244 
ş—nup
;

246 
Ën
 = (
h—d”_Ën
 = 
	`¡¾’
(
h—d”
));

249 if(
»¶y_couÁ
 > 0) {

250 if((
»¶›s
 = 
	`m®loc_z”o
((*è* 
»¶y_couÁ
)è=ğ
NULL
 ||

251 (
»¶y_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
»¶y_couÁ
)è=ğ
NULL
) {

252 
ş—nup
;

255 
i
 = 0;

256 
»¶y
 = 
årštšg
->
årštšg_»¶›s
;

257 
»¶y
 !ğ
NULL
) {

258 if((
»¶›s
[
i
] = 
	`årštšg_»¶y
(
årštšg
, 
»¶y
)è=ğ
NULL
) {

259 
ş—nup
;

261 
Ën
 +ğ(
»¶y_Ëns
[
i
] = 
	`¡¾’
(
»¶›s
[i]));

262 
»¶y
 =„•ly->
Ãxt
;

263 
i
++;

268 
¡©s
 = 
	`årštšg_¡©s
(
årštšg
);

269 if(
¡©s
 !ğ
NULL
) {

270 
Ën
 +ğ(
¡©s_Ën
 = 
	`¡¾’
(
¡©s
));

274 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
) {

275 
ş—nup
;

279 
	`memıy
(
¡r
 + 
wc
, 
h—d”
, 
h—d”_Ën
); wc += header_len;

280 
i
 = 0; i < 
»¶y_couÁ
; i++) {

281 
	`memıy
(
¡r
 + 
wc
, 
»¶›s
[
i
], 
»¶y_Ëns
[i]);

282 
wc
 +ğ
»¶y_Ëns
[
i
];

285 if(
¡©s
 !ğ
NULL
) {

286 
	`memıy
(
¡r
 + 
wc
, 
¡©s
, 
¡©s_Ën
);

287 
wc
 +ğ
¡©s_Ën
;

294 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
Ën
) != 0) {

295 if(
fd
 != 1) {

296 if(
	`árunÿ‹
(
fd
, 
off
) != 0) {

297 
ş—nup
;

300 
ş—nup
;

303 
»t
 = 0;

305 
ş—nup
:

306 if(
¡r
 !ğ
NULL
) {

307 
	`ä“
(
¡r
);

309 if(
h—d”
 !ğ
NULL
) {

310 
	`ä“
(
h—d”
);

312 if(
¡©s
 !ğ
NULL
) {

313 
	`ä“
(
¡©s
);

315 if(
»¶y_Ëns
 !ğ
NULL
) {

316 
	`ä“
(
»¶y_Ëns
);

318 if(
»¶›s
 !ğ
NULL
) {

319 
i
 = 0; i < 
»¶y_couÁ
; i++)

320 if(
»¶›s
[
i
] !ğ
NULL
) {

321 
	`ä“
(
»¶›s
[
i
]);

323 
	`ä“
(
»¶›s
);

326  
»t
;

327 
	}
}

	@fprinting/scamper_fprinting_text.h

23 #iâdeà
__SCAMPER_FRPINTING_TEXT_H


24 
	#__SCAMPER_FRPINTING_TEXT_H


	)

26 
sÿm³r_fe_‹xt_årštšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
);

	@fprinting/scamper_fprinting_warts.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_icm³xt.h
"

37 
	~"sÿm³r_årštšg.h
"

38 
	~"sÿm³r_fe.h
"

39 
	~"sÿm³r_fe_w¬ts.h
"

40 
	~"sÿm³r_årštšg_w¬ts.h
"

42 
	~"mjl_¥ÏyŒ“.h
"

43 
	~"uts.h
"

45 
	#TCP_REP
 0

	)

46 
	#ECHO_REP
 1

	)

47 
	#TIME_REP
 2

	)

48 
	#TTLEXP_REP
 3

	)

49 
	#PTUN_REP
 4

	)

54 
	#WARTS_FPRINTING_ADDR_SRC
 1

	)

55 
	#WARTS_FPRINTING_ADDR_DST
 2

	)

56 
	#WARTS_FPRINTING_START
 3

	)

57 
	#WARTS_FPRINTING_STOP_R
 4

	)

58 
	#WARTS_FPRINTING_STOP_D
 5

	)

59 
	#WARTS_FPRINTING_IS_ECHOTTL
 6

	)

60 
	#WARTS_FPRINTING_IS_ICMPDL
 7

	)

61 
	#WARTS_FPRINTING_IS_IPDF
 8

	)

62 
	#WARTS_FPRINTING_IS_TOS
 9

	)

63 
	#WARTS_FPRINTING_IS_UDPTTL
 10

	)

64 
	#WARTS_FPRINTING_PING
 11

	)

65 
	#WARTS_FPRINTING_ITTL
 12

	)

66 
	#WARTS_FPRINTING_SPORT
 13

	)

67 
	#WARTS_FPRINTING_DPORT
 14

	)

68 
	#WARTS_FPRINTING_REPC
 15

	)

69 
	#WARTS_FPRINTING_ISICMPTIMETTL
 16

	)

70 
	#WARTS_FPRINTING_PBMODE
 17

	)

71 
	#WARTS_FPRINTING_NFIND
 18

	)

72 
	#WARTS_FPRINTING_IS_MPLS
 19

	)

73 
	#WARTS_FPRINTING_ISMULTI
 20

	)

74 
	#WARTS_FPRINTING_NPROBE
 21

	)

75 
	#WARTS_FPRINTING_TABLE_BAD
 22

	)

76 
	#WARTS_FPRINTING_ADF
 23

	)

78 cÚ¡ 
w¬ts_v¬_t
 
	gårštšg_v¬s
[] = {

79 { 
WARTS_FPRINTING_ADDR_SRC
, -1, -1},

80 { 
WARTS_FPRINTING_ADDR_DST
, -1, -1},

81 { 
WARTS_FPRINTING_START
, 8, -1},

82 { 
WARTS_FPRINTING_STOP_R
, 1, -1},

83 { 
WARTS_FPRINTING_STOP_D
, 1, -1},

84 { 
WARTS_FPRINTING_IS_ECHOTTL
, 1, -1},

85 { 
WARTS_FPRINTING_IS_ICMPDL
, 1, -1},

86 { 
WARTS_FPRINTING_IS_IPDF
, 1, -1},

87 { 
WARTS_FPRINTING_IS_TOS
, 1, -1},

88 { 
WARTS_FPRINTING_IS_UDPTTL
, 1, -1},

89 { 
WARTS_FPRINTING_PING
, 1, -1},

90 { 
WARTS_FPRINTING_ITTL
, 1, -1},

91 { 
WARTS_FPRINTING_SPORT
, 2, -1},

92 { 
WARTS_FPRINTING_DPORT
, 2, -1},

93 { 
WARTS_FPRINTING_REPC
, 4, -1},

94 { 
WARTS_FPRINTING_ISICMPTIMETTL
, 1, -1},

95 { 
WARTS_FPRINTING_PBMODE
, 1, -1},

96 { 
WARTS_FPRINTING_NFIND
, 1, -1},

97 { 
WARTS_FPRINTING_IS_MPLS
, 1, -1},

98 { 
WARTS_FPRINTING_ISMULTI
, 1, -1},

99 { 
WARTS_FPRINTING_NPROBE
, 1, -1},

100 { 
WARTS_FPRINTING_TABLE_BAD
, -1, -1},

101 { 
WARTS_FPRINTING_ADF
, 1, -1},

103 
	#årštšg_v¬s_mfb
 
	`WARTS_VAR_MFB
(
årštšg_v¬s
)

	)

105 
	#WARTS_FPRINTING_REPLY_FROM
 1

	)

106 
	#WARTS_FPRINTING_REPLY_PROTO
 2

	)

107 
	#WARTS_FPRINTING_REPLY_REPLY_TTL
 3

	)

108 
	#WARTS_FPRINTING_REPLY_OS_TTL
 4

	)

109 
	#WARTS_FPRINTING_REPLY_REPLY_TOS
 5

	)

110 
	#WARTS_FPRINTING_REPLY_REPLY_DF
 6

	)

111 
	#WARTS_FPRINTING_REPLY_REPLY_SIZE
 7

	)

112 
	#WARTS_FPRINTING_REPLY_ICMP_T
 8

	)

113 
	#WARTS_FPRINTING_REPLY_ICMP_C
 9

	)

114 
	#WARTS_FPRINTING_REPLY_TCP_F
 10

	)

115 
	#WARTS_FPRINTING_REPLY_ICMP_EXT
 11

	)

116 
	#WARTS_FPRINTING_REPLY_Q_TTL
 12

	)

117 
	#WARTS_FPRINTING_REPLY_Q_TOS
 13

	)

118 
	#WARTS_FPRINTING_REPLY_TCP_WIN
 14

	)

119 
	#WARTS_FPRINTING_REPLY_TCP_MSS
 15

	)

121 cÚ¡ 
w¬ts_v¬_t
 
	gårštšg_»¶y_v¬s
[] = {

122 { 
WARTS_FPRINTING_REPLY_FROM
, -1, -1},

123 { 
WARTS_FPRINTING_REPLY_PROTO
, 1, -1},

124 { 
WARTS_FPRINTING_REPLY_REPLY_TTL
, 1, -1},

125 { 
WARTS_FPRINTING_REPLY_OS_TTL
, 1, -1},

126 { 
WARTS_FPRINTING_REPLY_REPLY_TOS
, 1, -1},

127 { 
WARTS_FPRINTING_REPLY_REPLY_DF
, 1, -1},

128 { 
WARTS_FPRINTING_REPLY_REPLY_SIZE
, 2, -1},

129 { 
WARTS_FPRINTING_REPLY_ICMP_T
, 1, -1},

130 { 
WARTS_FPRINTING_REPLY_ICMP_C
, 1, -1},

131 { 
WARTS_FPRINTING_REPLY_TCP_F
, 1, -1},

132 { 
WARTS_FPRINTING_REPLY_ICMP_EXT
, -1, -1},

133 { 
WARTS_FPRINTING_REPLY_Q_TTL
, 1, -1},

134 { 
WARTS_FPRINTING_REPLY_Q_TOS
, 1, -1},

135 { 
WARTS_FPRINTING_REPLY_TCP_WIN
, 2, -1},

136 { 
WARTS_FPRINTING_REPLY_TCP_MSS
, 2, -1},

138 
	#årštšg_»¶y_v¬s_mfb
 
	`WARTS_VAR_MFB
(
årštšg_»¶y_v¬s
)

	)

140 
	sw¬ts_årštšg_»¶y
 {

141 
sÿm³r_årštšg_»¶y_t
 *
	m»¶y
;

142 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
årštšg_»¶y_v¬s
)];

143 
ušt16_t
 
	mæags_Ën
;

144 
ušt16_t
 
	m·¿ms_Ën
;

145 } 
	tw¬ts_årštšg_»¶y_t
;

148 
	$w¬ts_årštšg_»¶y_·¿ms
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

149 cÚ¡ 
sÿm³r_årštšg_»¶y_t
 *
»¶y
,

150 
w¬ts_add¹abË_t
 *
bË
,

151 
ušt8_t
 *
æags
, 
ušt16_t
 *
æags_Ën
,

152 
ušt16_t
 *
·¿ms_Ën
) {

153 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

154 
i
, 
j
, 
max_id
 = 0;

155 
sÿm³r_icm³xt_t
 *
›
;

158 
	`mem£t
(
æags
, 0, 
årštšg_»¶y_v¬s_mfb
);

159 *
·¿ms_Ën
 = 0;

161 
i
 = 0; i < (
årštšg_»¶y_v¬s
è/ (
w¬ts_v¬_t
); i++) {

162 
v¬
 = &
årštšg_»¶y_v¬s
[
i
];

163 
v¬
->
id
) {

164 
WARTS_FPRINTING_REPLY_FROM
:

165 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

166 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
addr
);

168 
WARTS_FPRINTING_REPLY_PROTO
:

169 
WARTS_FPRINTING_REPLY_REPLY_TTL
:

170 
WARTS_FPRINTING_REPLY_OS_TTL
:

171 
WARTS_FPRINTING_REPLY_REPLY_TOS
:

172 
WARTS_FPRINTING_REPLY_REPLY_DF
:

173 
WARTS_FPRINTING_REPLY_REPLY_SIZE
:

174 
WARTS_FPRINTING_REPLY_ICMP_T
:

175 
WARTS_FPRINTING_REPLY_ICMP_C
:

176 
WARTS_FPRINTING_REPLY_TCP_F
:

177 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

178 
	`as£¹
(
v¬
->
size
 >= 0);

179 *
·¿ms_Ën
 +ğ
v¬
->
size
;

181 
WARTS_FPRINTING_REPLY_ICMP_EXT
:

183 if(
»¶y
->
»¶y_ext
 !ğ
NULL
)

185 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

186 *
·¿ms_Ën
 += 2;

187 
›
 = 
»¶y
->
»¶y_ext
; i!ğ
NULL
; iğ›->
›_Ãxt
)

189 *
·¿ms_Ën
 +ğ(2 + 1 + 1 + 
›
->
›_dl
);

194 
WARTS_FPRINTING_REPLY_Q_TTL
:

195 
WARTS_FPRINTING_REPLY_TCP_MSS
:

197 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

198 
	`as£¹
(
v¬
->
size
 >= 0);

199 *
·¿ms_Ën
 +ğ
v¬
->
size
;

204 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

206 
	}
}

208 
	$w¬ts_årštšg_»¶y_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

209 cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

210 
sÿm³r_årštšg_»¶y_t
 *
»¶y
,

211 
w¬ts_årštšg_»¶y_t
 *
¡©e
,

212 
w¬ts_add¹abË_t
 *
bË
,

213 
ušt32_t
 *
Ën
) {

214 
	`w¬ts_årštšg_»¶y_·¿ms
(
årštšg
, 
»¶y
, 
bË
, 
¡©e
->
æags
,

215 &
¡©e
->
æags_Ën
, &¡©e->
·¿ms_Ën
);

217 
¡©e
->
»¶y
 =„eply;

219 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

220 if(
¡©e
->
·¿ms_Ën
 != 0) {

221 *
Ën
 += 2;

225 
	}
}

228 
	$w¬ts_årštšg_·¿ms
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

229 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

230 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
) {

231 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

232 
DUAL
 *
–s
;

233 
i
, 
max_id
 = 0;

234 
size_t
 
j
, 
l
;

235 
årštšg__»¶›s_t
 *

;

238 
	`mem£t
(
æags
, 0, 
årštšg_v¬s_mfb
);

239 *
·¿ms_Ën
 = 0;

241 
i
 = 0; i < (
årštšg_v¬s
è/ (
w¬ts_v¬_t
); i++) {

242 
v¬
 = &
årštšg_v¬s
[
i
];

243 
v¬
->
id
) {

244 
WARTS_FPRINTING_ADDR_SRC
:

245 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

246 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
årštšg
->
¤c
);

248 
WARTS_FPRINTING_ADDR_DST
:

249 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

250 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
årštšg
->
d¡
);

252 
WARTS_FPRINTING_TABLE_BAD
:

253 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

254 *
·¿ms_Ën
 += 2;

255 
j
 = 
	`g‘Size
(
årštšg
->
_»¶›s
);

256 
–s
 = 
	`g‘EËm’ts
(
årštšg
->
_»¶›s
);

257 
l
 = 0;† < 
j
;†++) {

258 if(
–s
[
l
].
¥ec
 !ğ
NONE
 &&ƒls[l].¥eø!ğ
DELETED
) {

259 

 = (
årštšg__»¶›s_t
 *)
–s
[
l
].
v®ue
;

260 if(

->
tı
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

261 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
) + 1;

262 if(

->
echo
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

263 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
) + 1;

264 if(

->
‰Ëxp
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

265 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
) + 1;

266 if(

->
time
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

267 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
) + 1;

268 if(

->
±uÄ—ch
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

269 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
) + 1;

273 
WARTS_FPRINTING_START
:

274 
WARTS_FPRINTING_STOP_R
:

275 
WARTS_FPRINTING_STOP_D
:

276 
WARTS_FPRINTING_IS_ECHOTTL
:

277 
WARTS_FPRINTING_IS_ICMPDL
:

278 
WARTS_FPRINTING_IS_IPDF
:

279 
WARTS_FPRINTING_IS_TOS
:

280 
WARTS_FPRINTING_IS_UDPTTL
:

281 
WARTS_FPRINTING_PING
:

282 
WARTS_FPRINTING_ITTL
:

283 
WARTS_FPRINTING_SPORT
:

284 
WARTS_FPRINTING_DPORT
:

285 
WARTS_FPRINTING_REPC
:

286 
WARTS_FPRINTING_ISICMPTIMETTL
:

287 
WARTS_FPRINTING_PBMODE
:

288 
WARTS_FPRINTING_NFIND
:

289 
WARTS_FPRINTING_IS_MPLS
:

290 
WARTS_FPRINTING_ISMULTI
:

291 
WARTS_FPRINTING_NPROBE
:

292 
WARTS_FPRINTING_ADF
:

293 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

294 
	`as£¹
(
v¬
->
size
 >= 0);

295 *
·¿ms_Ën
 +ğ
v¬
->
size
;

298 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

299 
	`as£¹
(
v¬
->
size
 >= 0);

300 *
·¿ms_Ën
 +ğ
v¬
->
size
;

305 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

308 
	}
}

310 
	$š£¹_årštšg_bË
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

311 cÚ¡ 
ušt32_t
 
Ën
,

312 cÚ¡ 
HASHTABLE
 *
h
, *
·¿m
) {

313 
ušt16_t
 
i
 = 0;

314 
size_t
 
j
, 
l
;

315 
DUAL
 *
–s
;

316 
årštšg__»¶›s_t
 *

;

318 
j
 = 
	`g‘Size
(
h
);

319 
–s
 = 
	`g‘EËm’ts
(
h
);

320 
l
 = 0;† < 
j
;†++) {

321 if(
–s
[
l
].
¥ec
 !ğ
NONE
 &&ƒls[l].¥eø!ğ
DELETED
) {

322 

 = (
årštšg__»¶›s_t
 *)
–s
[
l
].
v®ue
;

323 if(

->
tı
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

324 
i
++;

325 if(

->
echo
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

326 
i
++;

327 if(

->
‰Ëxp
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

328 
i
++;

329 if(

->
time
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

330 
i
++;

331 if(

->
±uÄ—ch
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1)

332 
i
++;

337 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
i
, 
NULL
);

339 
l
 = 0;† < 
j
;†++) {

340 if(
–s
[
l
].
¥ec
 !ğ
NONE
 &&ƒls[l].¥eø!ğ
DELETED
) {

341 

 = (
årštšg__»¶›s_t
 *)
–s
[
l
].
v®ue
;

342 if(

->
tı
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

343 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
, 
·¿m
);

344 
buf
[(*
off
)++] = 
TCP_REP
;

346 if(

->
echo
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

347 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
, 
·¿m
);

348 
buf
[(*
off
)++] = 
ECHO_REP
;

350 if(

->
‰Ëxp
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

351 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
, 
·¿m
);

352 
buf
[(*
off
)++] = 
TTLEXP_REP
;

354 if(

->
time
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

355 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
, 
·¿m
);

356 
buf
[(*
off
)++] = 
TIME_REP
;

358 if(

->
±uÄ—ch
 =ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

359 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, (
sÿm³r_addr_t
 *)
–s
[
l
].
key
, 
·¿m
);

360 
buf
[(*
off
)++] = 
PTUN_REP
;

365 
	}
}

367 
	$exŒaù_årštšg_bË
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

368 cÚ¡ 
ušt32_t
 
Ën
,

369 
HASHTABLE
 *
out
, *
·¿m
) {

370 
sÿm³r_addr_t
 *
addr
;

371 
årštšg__»¶›s_t
 *
t
;

372 
ušt16_t
 
i
, 
c
;

375 if(
Ën
 - *
off
 < 2)

378 
	`exŒaù_ušt16
(
buf
, 
off
, 
Ën
, &
c
, 
NULL
);

380 
i
=0; i<
c
; i++) {

381 if(
	`exŒaù_addr
(
buf
, 
off
, 
Ën
, &
addr
, 
·¿m
) != 0)

383 
t
 = 
	`g‘V®ue
(
out
, 
addr
);

384 if(
t
 =ğ
NULL
) {

385 
t
 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

387 
buf
[(*
off
)++]) {

388 
TCP_REP
:

389 
t
->
tı
 = (
sÿm³r_årštšg_»¶y_t
 *)-1;

391 
ECHO_REP
:

392 
t
->
echo
 = (
sÿm³r_årštšg_»¶y_t
 *)-1;

394 
TIME_REP
:

395 
t
->
time
 = (
sÿm³r_årštšg_»¶y_t
 *)-1;

397 
TTLEXP_REP
:

398 
t
->
‰Ëxp
 = (
sÿm³r_årštšg_»¶y_t
 *)-1;

400 
PTUN_REP
:

401 
t
->
±uÄ—ch
 = (
sÿm³r_årštšg_»¶y_t
 *)-1;

404 
	`š£¹EËm’t
(
out
, 
addr
, 
t
);

408 
	}
}

410 
	$exŒaù_årštšg_»¶y_icmp_ext
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

411 
ušt32_t
 
Ën
,

412 
sÿm³r_årštšg_»¶y_t
 *
»¶y
,

413 *
·¿m
)

415  
	`w¬ts_icm³xt_»ad
(
buf
, 
off
, 
Ën
, &
»¶y
->
»¶y_ext
);

416 
	}
}

418 
	$š£¹_årštšg_»¶y_icmp_ext
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

419 cÚ¡ 
ušt32_t
 
Ën
,

420 cÚ¡ 
sÿm³r_årštšg_»¶y_t
 *
»¶y
,

421 *
·¿m
)

423 
	`w¬ts_icm³xt_wr™e
(
buf
, 
off
, 
Ën
, 
»¶y
->
»¶y_ext
);

425 
	}
}

433 
	$w¬ts_årštšg_»¶y_»ad
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

434 
sÿm³r_årštšg_»¶y_t
 *
»¶y
,

435 
w¬ts_¡©e_t
 *
¡©e
,

436 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

437 
ušt32_t
 *
off
, ušt32_ˆ
Ën
) {

438 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

439 {&
»¶y
->
addr
, (
w´_t
)
exŒaù_addr
, 
bË
},

440 {&
»¶y
->
»¶y_´Ùo
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

441 {&
»¶y
->
»¶y_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

442 {&
»¶y
->
os_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

443 {&
»¶y
->
»¶y_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

444 {&
»¶y
->
»¶y_df
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

445 {&
»¶y
->
»¶y_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

446 {&
»¶y
->
icmp_ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

447 {&
»¶y
->
icmp_code
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

448 {&
»¶y
->
tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

449 {
»¶y
, (
w´_t
)
exŒaù_årštšg_»¶y_icmp_ext
, 
NULL
},

450 {&
»¶y
->
»¶y_q_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

451 {&
»¶y
->
»¶y_q_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

452 {&
»¶y
->
»¶y_tı_wš
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

453 {&
»¶y
->
»¶y_tı_mss
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

455 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_»ad”_t
);

456 
ušt32_t
 
o
 = *
off
;

457 
i
;

459 if((
i
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0) {

460  
i
;

464 
	}
}

466 
	$w¬ts_årštšg_»¶y_wr™e
(cÚ¡ 
w¬ts_årštšg_»¶y_t
 *
¡©e
,

467 
w¬ts_add¹abË_t
 *
bË
,

468 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
) {

469 
sÿm³r_årštšg_»¶y_t
 *
»¶y
 = 
¡©e
->reply;

471 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

472 {
»¶y
->
addr
, (
wpw_t
)
š£¹_addr
, 
bË
},

473 {&
»¶y
->
»¶y_´Ùo
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

474 {&
»¶y
->
»¶y_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

475 {&
»¶y
->
os_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

476 {&
»¶y
->
»¶y_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

477 {&
»¶y
->
»¶y_df
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

478 {&
»¶y
->
»¶y_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

479 {&
»¶y
->
icmp_ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

480 {&
»¶y
->
icmp_code
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

481 {&
»¶y
->
tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

482 {
»¶y
, (
wpw_t
)
š£¹_årštšg_»¶y_icmp_ext
, 
NULL
},

483 {&
»¶y
->
»¶y_q_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

484 {&
»¶y
->
»¶y_q_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

485 {&
»¶y
->
»¶y_tı_wš
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

486 {&
»¶y
->
»¶y_tı_mss
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

488 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_wr™”_t
);

490 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

491 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

493 
	}
}

495 
	$w¬ts_årštšg_·¿ms_»ad
(
sÿm³r_årštšg_t
 *
årštšg
, 
w¬ts_¡©e_t
 *
¡©e
,

496 
w¬ts_add¹abË_t
 *
bË
,

497 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
) {

498 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

499 {&
årštšg
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

500 {&
årštšg
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

501 {&
årštšg
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

502 {&
årštšg
->
¡İ_»asÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

503 {&
årštšg
->
¡İ_d©a
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

504 {&
årštšg
->
i£chÙ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

505 {&
årštšg
->
isicmpdËn
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

506 {&
årštšg
->
isdf
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

507 {&
årštšg
->
i¡os
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

508 {&
årštšg
->
isud±
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

509 {&
årštšg
->
i¥šg
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

510 {&
årštšg
->
™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

511 {&
årštšg
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

512 {&
årštšg
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

513 {&
årštšg
->
»¶yc
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

514 {&
årštšg
->
isicm±im‘
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

515 {&
årštšg
->
ism¶s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

516 {&
årštšg
->
pbmode
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

517 {&
årštšg
->
nfšd
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

518 {&
årštšg
->
ismuÉi
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

519 {&
årštšg
->
Årobe
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

520 {
årštšg
->
_»¶›s
, (
w´_t
)
exŒaù_årštšg_bË
, 
bË
},

521 {&
årštšg
->
i§df
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

523 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_»ad”_t
);

524 
ušt32_t
 
o
 = *
off
;

525 
rc
;

527 if((
rc
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0) {

528  
rc
;

532 
	}
}

534 
	$w¬ts_årštšg_·¿ms_wr™e
(cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
,

535 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

536 
w¬ts_add¹abË_t
 *
bË
,

537 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

538 cÚ¡ 
ušt32_t
 
Ën
,

539 cÚ¡ 
ušt8_t
 *
æags
,

540 cÚ¡ 
ušt16_t
 
æags_Ën
,

541 cÚ¡ 
ušt16_t
 
·¿ms_Ën
) {

543 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

544 {
årštšg
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

545 {
årštšg
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

546 {&
årštšg
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

547 {&
årštšg
->
¡İ_»asÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

548 {&
årštšg
->
¡İ_d©a
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

549 {&
årštšg
->
i£chÙ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

550 {&
årštšg
->
isicmpdËn
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

551 {&
årštšg
->
isdf
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

552 {&
årštšg
->
i¡os
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

553 {&
årštšg
->
isud±
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

554 {&
årštšg
->
i¥šg
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

555 {&
årštšg
->
™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

556 {&
årštšg
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

557 {&
årštšg
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

558 {&
årštšg
->
»¶yc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

559 {&
årštšg
->
isicm±im‘
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

560 {&
årštšg
->
ism¶s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

561 {&
årštšg
->
pbmode
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

562 {&
årštšg
->
nfšd
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

563 {&
årštšg
->
ismuÉi
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

564 {&
årštšg
->
Årobe
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

565 {
årštšg
->
_»¶›s
, (
wpw_t
)
š£¹_årštšg_bË
, 
bË
},

566 {&
årštšg
->
i§df
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

569 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_wr™”_t
);

571 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

572 
hªdËr_út
);

574 
	}
}

582 
	$sÿm³r_fe_w¬ts_årštšg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

583 
sÿm³r_årštšg_t
 **
årštšg_out
) {

584 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

585 
sÿm³r_årštšg_t
 *
årštšg
 = 
NULL
;

586 
ušt8_t
 *
buf
 = 
NULL
;

587 
ušt32_t
 
off
 = 0;

588 
ušt16_t
 
i
;

589 
sÿm³r_årštšg_»¶y_t
 *
»¶y
;

590 
årštšg__»¶›s_t
 *
t
;

591 
ušt16_t
 
»¶y_couÁ
;

592 
w¬ts_add¹abË_t
 
bË
;

594 
	`mem£t
(&
bË
, 0, (table));

596 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0) {

597 
”r
;

599 if(
buf
 =ğ
NULL
) {

600 *
årštšg_out
 = 
NULL
;

604 if((
årštšg
 = 
	`sÿm³r_årštšg_®loc
()è=ğ
NULL
) {

605 
”r
;

608 if(
	`w¬ts_årštšg_·¿ms_»ad
(
årštšg
, 
¡©e
, &
bË
, 
buf
, &
off
, 
hdr
->
Ën
) != 0) {

609 
”r
;

613 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
»¶y_couÁ
, 
NULL
) != 0) {

614 
”r
;

618 if(
»¶y_couÁ
 == 0) {

619 
dÚe
;

623 
i
 = 0; i < 
»¶y_couÁ
; i++) {

624 if((
»¶y
 = 
	`sÿm³r_årštšg_»¶y_®loc
()è=ğ
NULL
) {

625 
”r
;

628 if(
	`w¬ts_årštšg_»¶y_»ad
(
årštšg
, 
»¶y
, 
¡©e
, &
bË
, 
buf
, &
off
, 
hdr
->
Ën
) != 0) {

629 
”r
;

632 
	`sÿm³r_årštšg_»¶y_­³nd
(
årštšg
, 
»¶y
);

637 
»¶y
 = 
årštšg
->
årštšg_»¶›s
;

638 
»¶y
 !ğ
NULL
) {

639 
t
 = 
	`g‘V®ue
(
årštšg
->
_»¶›s
, 
»¶y
->
addr
);

640 if(
t
 =ğ
NULL
) {

641 
t
 = 
	`ÿÎoc
(1, (
årštšg__»¶›s_t
));

643 if(
	`SCAMPER_FPRINTING_REPLY_IS_TCP
(
»¶y
è&& 
t
->
tı
 !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

644 
t
->
tı
 = 
»¶y
;

645 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
è&& 
t
->
‰Ëxp
 !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

646 
t
->
‰Ëxp
 = 
»¶y
;

647 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_UNREACH
(
»¶y
è&& 
t
->
±uÄ—ch
 !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

648 
t
->
±uÄ—ch
 = 
»¶y
;

649 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_TSREPLY
(
»¶y
è&& 
t
->
time
 !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

650 
t
->
time
 = 
»¶y
;

651 } if(
	`SCAMPER_FPRINTING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
è&& 
t
->
echo
 !ğ(
sÿm³r_årštšg_»¶y_t
 *)-1) {

652 
t
->
echo
 = 
»¶y
;

654 
	`š£¹EËm’t
(
årštšg
->
_»¶›s
, 
»¶y
->
addr
, 
t
);

655 
»¶y
 =„•ly->
Ãxt
;

658 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

660 
dÚe
:

661 
	`w¬ts_add¹abË_ş—n
(&
bË
);

662 *
årštšg_out
 = 
årštšg
;

663 
	`ä“
(
buf
);

666 
”r
:

667 
	`w¬ts_add¹abË_ş—n
(&
bË
);

668 if(
buf
 !ğ
NULL
) {

669 
	`ä“
(
buf
);

671 if(
årštšg
 !ğ
NULL
) {

672 
	`sÿm³r_årštšg_ä“
(
årštšg
);

675 
	}
}

677 
	$sÿm³r_fe_w¬ts_årštšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

678 cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
) {

679 
w¬ts_add¹abË_t
 
bË
;

680 
w¬ts_årštšg_»¶y_t
 *
»¶y_¡©e
 = 
NULL
;

681 
sÿm³r_årštšg_»¶y_t
 *
»¶y
;

682 
ušt8_t
 *
buf
 = 
NULL
;

683 
ušt8_t
 
æags
[
årštšg_v¬s_mfb
];

684 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

685 
ušt32_t
 
Ën
, 
off
 = 0;

686 
ušt16_t
 
»¶y_couÁ
;

687 
size_t
 
size
;

688 
i
, 
j
;

690 
	`mem£t
(&
bË
, 0, (table));

693 
	`w¬ts_årštšg_·¿ms
(
årštšg
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

696 
Ën
 = 8 + 
æags_Ën
 + 2 + 
·¿ms_Ën
 + 2;

698 if((
»¶y_couÁ
 = 
	`sÿm³r_årštšg_»¶y_couÁ
(
årštšg
)) > 0) {

699 
size
 = 
»¶y_couÁ
 * (
w¬ts_årštšg_»¶y_t
);

700 if((
»¶y_¡©e
 = (
w¬ts_årštšg_»¶y_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
) {

701 
”r
;

704 
j
 = 0;

705 
»¶y
 = 
årštšg
->
årštšg_»¶›s
;„•ly !ğ
NULL
;„•ly =„•ly->
Ãxt
) {

706 if(
	`w¬ts_årštšg_»¶y_¡©e
(
sf
, 
årštšg
, 
»¶y
, &
»¶y_¡©e
[
j
++],

707 &
bË
, &
Ën
) == -1) {

708 
”r
;

714 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
) {

715 
	`sy¡em
("echo \"mallocƒrror fileoo big\" > ~/scamper_error.txt");

716 
”r
;

719 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_FPRINTING
);

721 if(
	`w¬ts_årštšg_·¿ms_wr™e
(
årštšg
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

722 
æags
, 
æags_Ën
, 
·¿ms_Ën
) == -1) {

723 
”r
;

727 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
»¶y_couÁ
, 
NULL
);

730 
i
 = 0; i < 
»¶y_couÁ
; i++) {

731 
	`w¬ts_årštšg_»¶y_wr™e
(&
»¶y_¡©e
[
i
], &
bË
, 
buf
, &
off
, 
Ën
);

733 if(
»¶y_¡©e
 !ğ
NULL
) {

734 
	`ä“
(
»¶y_¡©e
);

735 
»¶y_¡©e
 = 
NULL
;

738 
	`as£¹
(
off
 =ğ
Ën
);

740 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1) {

741 
”r
;

744 
	`w¬ts_add¹abË_ş—n
(&
bË
);

745 
	`ä“
(
buf
);

748 
”r
:

749 
	`w¬ts_add¹abË_ş—n
(&
bË
);

750 if(
»¶y_¡©e
 !ğ
NULL
) {

751 
	`ä“
(
»¶y_¡©e
);

753 if(
buf
 !ğ
NULL
) {

754 
	`ä“
(
buf
);

757 
	}
}

	@fprinting/scamper_fprinting_warts.h

23 #iâdeà
__SCAMPER_FILE_WARTS_FPRINTING_H


24 
	#__SCAMPER_FILE_WARTS_FPRINTING_H


	)

26 
sÿm³r_fe_w¬ts_årštšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_årštšg_t
 *
årštšg
);

28 
sÿm³r_fe_w¬ts_årštšg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

29 
sÿm³r_årštšg_t
 **
årštšg_out
);

	@neighbourdisc/scamper_neighbourdisc.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r_li¡.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_Ãighbourdisc.h
"

37 
	~"uts.h
"

39 
sÿm³r_addr_t
 *
	$sÿm³r_Ãighbourdisc_addr
(cÚ¡ *
va
)

41 cÚ¡ 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
va
;

42  
nd
->
d¡_
;

43 
	}
}

45 
sÿm³r_Ãighbourdisc_»¶y_t
 *
	$sÿm³r_Ãighbourdisc_»¶y_®loc
()

47  
	`m®loc_z”o
((
sÿm³r_Ãighbourdisc_»¶y_t
));

48 
	}
}

50 
	$sÿm³r_Ãighbourdisc_»¶y_ä“
(
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
)

52 if(
»¶y
->
mac
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(reply->mac);

53 
	`ä“
(
»¶y
);

55 
	}
}

57 
	$sÿm³r_Ãighbourdisc_»¶y_add
(
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
,

58 
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
)

60 
size_t
 
Ën
 = (
sÿm³r_Ãighbourdisc_»¶y_t
 *è* (
´obe
->
rxc
+1);

61 if(
	`»®loc_w¿p
((**)&
´obe
->
rxs
, 
Ën
) != 0)

63 
´obe
->
rxs
[´obe->
rxc
++] = 
»¶y
;

65 
	}
}

67 
	$sÿm³r_Ãighbourdisc_»¶›s_®loc
(
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
,

68 
ušt16_t
 
c
)

70 
size_t
 
Ën
 = (
sÿm³r_Ãighbourdisc_»¶y_t
 *è* 
c
;

71 if((
´obe
->
rxs
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

74 
	}
}

76 
sÿm³r_Ãighbourdisc_´obe_t
 *
	$sÿm³r_Ãighbourdisc_´obe_®loc
()

78  
	`m®loc_z”o
((
sÿm³r_Ãighbourdisc_´obe_t
));

79 
	}
}

81 
	$sÿm³r_Ãighbourdisc_´obe_ä“
(
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
)

83 
ušt16_t
 
i
;

85 if(
´obe
 =ğ
NULL
)

88 if(
´obe
->
rxs
 !ğ
NULL
)

90 
i
=0; i<
´obe
->
rxc
; i++)

91 
	`sÿm³r_Ãighbourdisc_»¶y_ä“
(
´obe
->
rxs
[
i
]);

92 
	`ä“
(
´obe
->
rxs
);

94 
	`ä“
(
´obe
);

96 
	}
}

98 
	$sÿm³r_Ãighbourdisc_´obe_add
(
sÿm³r_Ãighbourdisc_t
 *
nd
,

99 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
)

101 
size_t
 
Ën
 = (
sÿm³r_Ãighbourdisc_´obe_t
 *è* (
nd
->
´obec
+1);

102 if(
	`»®loc_w¿p
((**)&
nd
->
´obes
, 
Ën
) != 0)

104 
nd
->
´obes
[nd->
´obec
++] = 
´obe
;

106 
	}
}

108 
	$sÿm³r_Ãighbourdisc_´obes_®loc
(
sÿm³r_Ãighbourdisc_t
 *
nd
, 
ušt16_t
 
c
)

110 
size_t
 
Ën
 = (
sÿm³r_Ãighbourdisc_´obe_t
 *è* 
c
;

111 if((
nd
->
´obes
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

114 
	}
}

116 
sÿm³r_Ãighbourdisc_t
 *
	$sÿm³r_Ãighbourdisc_®loc
()

118 
size_t
 
Ën
 = (
sÿm³r_Ãighbourdisc_t
);

119  (
sÿm³r_Ãighbourdisc_t
 *)
	`m®loc_z”o
(
Ën
);

120 
	}
}

122 
	$sÿm³r_Ãighbourdisc_iâame_£t
(
sÿm³r_Ãighbourdisc_t
 *
nd
, *
iâame
)

124 if(
nd
->
iâame
 !ğ
NULL
)

125 
	`ä“
(
nd
->
iâame
);

127 if((
nd
->
iâame
 = 
	`¡rdup
(iâame)è=ğ
NULL
)

131 
	}
}

133 
	$sÿm³r_Ãighbourdisc_ä“
(
sÿm³r_Ãighbourdisc_t
 *
nd
)

135 
ušt16_t
 
i
;

137 if(
nd
 =ğ
NULL
)

140 if(
nd
->
´obes
 !ğ
NULL
)

142 
i
=0; i<
nd
->
´obec
; i++)

143 
	`sÿm³r_Ãighbourdisc_´obe_ä“
(
nd
->
´obes
[
i
]);

144 
	`ä“
(
nd
->
´obes
);

147 if(
nd
->
iâame
 !ğ
NULL
è
	`ä“
(nd->ifname);

148 if(
nd
->
d¡_mac
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(nd->dst_mac);

149 if(
nd
->
d¡_
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(nd->dst_ip);

150 if(
nd
->
¤c_mac
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(nd->src_mac);

151 if(
nd
->
¤c_
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(nd->src_ip);

152 if(
nd
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(nd->cycle);

153 if(
nd
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(nd->list);

155 
	`ä“
(
nd
);

157 
	}
}

	@neighbourdisc/scamper_neighbourdisc.h

23 #iâdeà
__SCAMPER_NEIGHBOURDISC_H


24 
	#__SCAMPER_NEIGHBOURDISC_H


	)

26 
	#SCAMPER_NEIGHBOURDISC_METHOD_ARP
 0x01

	)

27 
	#SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
 0x02

	)

29 
	#SCAMPER_NEIGHBOURDISC_FLAG_ALLATTEMPTS
 0x01

	)

30 
	#SCAMPER_NEIGHBOURDISC_FLAG_FIRSTRESPONSE
 0x02

	)

32 
	ssÿm³r_Ãighbourdisc_»¶y


34 
timev®
 
	mrx
;

35 
sÿm³r_addr_t
 *
	mmac
;

36 } 
	tsÿm³r_Ãighbourdisc_»¶y_t
;

38 
	ssÿm³r_Ãighbourdisc_´obe


40 
timev®
 
	mtx
;

41 
sÿm³r_Ãighbourdisc_»¶y_t
 **
	mrxs
;

42 
ušt16_t
 
	mrxc
;

43 } 
	tsÿm³r_Ãighbourdisc_´obe_t
;

45 
	ssÿm³r_Ãighbourdisc


47 
sÿm³r_li¡_t
 *
	mli¡
;

48 
sÿm³r_cyşe_t
 *
	mcyşe
;

49 
ušt32_t
 
	mu£rid
;

50 
timev®
 
	m¡¬t
;

51 *
	miâame
;

52 
ušt8_t
 
	mm‘hod
;

53 
ušt8_t
 
	mæags
;

54 
ušt16_t
 
	mwa™
;

55 
ušt16_t
 
	m©‹m±s
;

56 
ušt16_t
 
	m»¶yc
;

57 
sÿm³r_addr_t
 *
	m¤c_
;

58 
sÿm³r_addr_t
 *
	m¤c_mac
;

59 
sÿm³r_addr_t
 *
	md¡_
;

60 
sÿm³r_addr_t
 *
	md¡_mac
;

61 
sÿm³r_Ãighbourdisc_´obe_t
 **
	m´obes
;

62 
ušt16_t
 
	m´obec
;

63 } 
	tsÿm³r_Ãighbourdisc_t
;

65 
sÿm³r_Ãighbourdisc_t
 *
sÿm³r_Ãighbourdisc_®loc
();

66 
sÿm³r_Ãighbourdisc_ä“
(
sÿm³r_Ãighbourdisc_t
 *);

67 
sÿm³r_addr_t
 *
sÿm³r_Ãighbourdisc_addr
(cÚ¡ *
va
);

69 
sÿm³r_Ãighbourdisc_´obe_t
 *
sÿm³r_Ãighbourdisc_´obe_®loc
();

70 
sÿm³r_Ãighbourdisc_´obe_ä“
(
sÿm³r_Ãighbourdisc_´obe_t
 *);

71 
sÿm³r_Ãighbourdisc_´obe_add
(
sÿm³r_Ãighbourdisc_t
 *,

72 
sÿm³r_Ãighbourdisc_´obe_t
 *);

73 
sÿm³r_Ãighbourdisc_´obes_®loc
(
sÿm³r_Ãighbourdisc_t
 *, 
ušt16_t
);

75 
sÿm³r_Ãighbourdisc_iâame_£t
(
sÿm³r_Ãighbourdisc_t
 *, *);

77 
sÿm³r_Ãighbourdisc_»¶y_t
 *
sÿm³r_Ãighbourdisc_»¶y_®loc
();

78 
sÿm³r_Ãighbourdisc_»¶y_ä“
(
sÿm³r_Ãighbourdisc_»¶y_t
 *);

79 
sÿm³r_Ãighbourdisc_»¶y_add
(
sÿm³r_Ãighbourdisc_´obe_t
 *,

80 
sÿm³r_Ãighbourdisc_»¶y_t
 *);

81 
sÿm³r_Ãighbourdisc_»¶›s_®loc
(
sÿm³r_Ãighbourdisc_´obe_t
 *,

82 
ušt16_t
);

	@neighbourdisc/scamper_neighbourdisc_do.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_Ãighbourdisc.h
"

37 
	~"sÿm³r_dl.h
"

38 
	~"sÿm³r_fds.h
"

39 
	~"sÿm³r_´obe.h
"

40 
	~"sÿm³r_sk.h
"

41 
	~"sÿm³r_İtiÚs.h
"

42 
	~"sÿm³r_if.h
"

43 
	~"sÿm³r_g‘¤c.h
"

44 
	~"sÿm³r_queue.h
"

45 
	~"sÿm³r_fe.h
"

46 
	~"sÿm³r_debug.h
"

47 
	~"sÿm³r_Ãighbourdisc_do.h
"

48 
	~"mjl_li¡.h
"

49 
	~"uts.h
"

51 
sÿm³r_sk_funcs_t
 
	gnd_funcs
;

52 
sÿm³r_addrÿche_t
 *
addrÿche
;

53 
ušt8_t
 *
	gpktbuf
;

54 
size_t
 
	gpktbuf_Ën
;

56 
	snd_¡©e


58 
sÿm³r_fd_t
 *
	mfd
;

59 
	mifšdex
;

60 
	m»¶yc
;

61 
dli¡_t
 *
	mcbs
;

62 } 
	tnd_¡©e_t
;

64 
	ssÿm³r_Ãighbourdisc_do


66 
sÿm³r_sk_t
 *
	msk
;

67 *
	m·¿m
;

68 (*
	mcb
)(*, 
	msÿm³r_addr_t
 *, scamper_addr_t *);

69 
dli¡_node_t
 *
	mnode
;

72 
	#ND_OPT_FIRSTRESPONSE
 1

	)

73 
	#ND_OPT_IFNAME
 2

	)

74 
	#ND_OPT_REPLYC
 3

	)

75 
	#ND_OPT_ATTEMPTS
 4

	)

76 
	#ND_OPT_ALLATTEMPTS
 5

	)

77 
	#ND_OPT_WAIT
 6

	)

78 
	#ND_OPT_SRCADDR
 7

	)

80 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

81 {'F', 
NULL
, 
ND_OPT_FIRSTRESPONSE
, 
SCAMPER_OPTION_TYPE_NULL
},

82 {'i', 
NULL
, 
ND_OPT_IFNAME
, 
SCAMPER_OPTION_TYPE_STR
},

83 {'o', 
NULL
, 
ND_OPT_REPLYC
, 
SCAMPER_OPTION_TYPE_NUM
},

84 {'q', 
NULL
, 
ND_OPT_ATTEMPTS
, 
SCAMPER_OPTION_TYPE_NUM
},

85 {'Q', 
NULL
, 
ND_OPT_ALLATTEMPTS
, 
SCAMPER_OPTION_TYPE_NULL
},

86 {'S', 
NULL
, 
ND_OPT_SRCADDR
, 
SCAMPER_OPTION_TYPE_STR
},

87 {'w', 
NULL
, 
ND_OPT_WAIT
, 
SCAMPER_OPTION_TYPE_NUM
},

89 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

91 cÚ¡ *
	$sÿm³r_do_Ãighbourdisc_u§ge
()

94 
	}
}

96 
sÿm³r_Ãighbourdisc_t
 *
	$nd_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

98  
	`sÿm³r_sk_g‘d©a
(
sk
);

99 
	}
}

101 
nd_¡©e_t
 *
	$nd_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

103  
	`sÿm³r_sk_g‘¡©e
(
sk
);

104 
	}
}

106 
	$nd_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

108 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

110 
	}
}

112 
	$nd_dÚe
(
sÿm³r_sk_t
 *
sk
)

114 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

116 
	}
}

118 
	$nd_¡©e_ä“
(
nd_¡©e_t
 *
¡©e
)

120 if(
¡©e
->
fd
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->fd);

121 
	`ä“
(
¡©e
);

123 
	}
}

125 
	$nd_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

127 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

128 
sÿm³r_dl_t
 *
dl
;

129 
nd_¡©e_t
 *
¡©e
;

130 
ušt8_t
 
¤c
[6];

131 
i
;

133 
	`as£¹
(
nd
 !ğ
NULL
);

135 
	`g‘timeofday_w¿p
(&
nd
->
¡¬t
);

137 if((
¡©e
 = 
	`m®loc_z”o
((
nd_¡©e_t
))è=ğ
NULL
)

139 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

140 
”r
;

143 if(
	`sÿm³r_if_g‘ifšdex
(
nd
->
iâame
, &
¡©e
->
ifšdex
) != 0)

145 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

146 "could‚Ù g‘ ifšdex fÜ %s", 
nd
->
iâame
);

147 
”r
;

150 if(
nd
->
¤c_
 =ğ
NULL
 &&

151 (
nd
->
¤c_
 = 
	`sÿm³r_g‘¤c
Òd->
d¡_
, 
¡©e
->
ifšdex
)è=ğ
NULL
)

153 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get src ip");

154 
”r
;

157 if(
	`sÿm³r_if_g‘mac
(
¡©e
->
ifšdex
, 
¤c
) != 0)

159 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get src mac");

160 
”r
;

163 if((
nd
->
¤c_mac
 = 
	`sÿm³r_addrÿche_g‘_‘h”Ãt
(
addrÿche
, 
¤c
)è=ğ
NULL
)

165 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get src mac");

166 
”r
;

169 if((
¡©e
->
fd
 = 
	`sÿm³r_fd_dl
(¡©e->
ifšdex
)è=ğ
NULL
)

171 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get fd");

172 
”r
;

175 if((
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
fd
)è=ğ
NULL
)

177 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get dl");

178 
”r
;

181 if((
i
 = 
	`sÿm³r_dl_tx_ty³
(
dl
)è!ğ
SCAMPER_DL_TX_ETHERNET
)

183 
	`sÿm³r_debug
(
__func__
, "dÈty³ %d‚Ùƒth”Ãt", 
i
);

184 
”r
;

187 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

190 
”r
:

191 if(
¡©e
 !ğ
NULL
è
	`nd_¡©e_ä“
(state);

193 
	}
}

195 
	$do_nd_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

197 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

198 
nd_¡©e_t
 *
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

200 if(((
nd
->
æags
 & 
SCAMPER_NEIGHBOURDISC_FLAG_ALLATTEMPTS
) == 0 &&

201 
nd
->
d¡_mac
 !ğ
NULL
è||‚d->
´obec
 =ğnd->
©‹m±s
 ||

202 (
¡©e
->
»¶yc
 >ğ
nd
->replyc &&‚d->replyc != 0))

204 
	`nd_dÚe
(
sk
);

209 
	}
}

211 
	$do_nd_´obe_¬p
(
sÿm³r_sk_t
 *
sk
)

213 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

214 
size_t
 
off
;

233 
	`mem£t
(
pktbuf
, 0xff, 6); 
off
 = 6;

235 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
¤c_mac
->
addr
, 6, &
off
, 
pktbuf_Ën
);

236 
	`by‹s_htÚs
(
pktbuf
+
off
, 
ETHERTYPE_ARP
); off += 2;

237 
	`by‹s_htÚs
(
pktbuf
+
off
, 0x0001); off += 2;

238 
	`by‹s_htÚs
(
pktbuf
+
off
, 
ETHERTYPE_IP
); off += 2;

239 
pktbuf
[
off
++] = 6;

240 
pktbuf
[
off
++] = 4;

241 
	`by‹s_htÚs
(
pktbuf
+
off
, 0x0001); off += 2;

242 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
¤c_mac
->
addr
, 6, &
off
, 
pktbuf_Ën
);

243 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
¤c_
->
addr
, 4, &
off
, 
pktbuf_Ën
);

244 
	`mem£t
(
pktbuf
+
off
, 0, 6); off += 6;

245 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
d¡_
->
addr
, 4, &
off
, 
pktbuf_Ën
);

248 
	}
}

250 
	$do_nd_´obe_nsŞ
(
sÿm³r_sk_t
 *
sk
)

252 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

253 
6_hdr
 *
6
;

254 
icmp6_hdr
 *
icmp6
;

255 
ušt16_t
 
u16
, *
w
;

256 
ušt8_t
 
6_d¡
[16];

257 
ušt8_t
 
sŞ
[4];

258 
size_t
 
off
 = 0;

259 
i
, 
sum
 = 0;

262 
	`memıy
(
sŞ
, ((
ušt8_t
 *)
nd
->
d¡_
->
addr
)+12, 4);

263 
sŞ
[0] = 0xff;

266 
6_d¡
[0] = 0xff;

267 
6_d¡
[1] = 0x02;

268 
	`mem£t
(
6_d¡
+2, 0, 9);

269 
6_d¡
[11] = 0x01;

270 
	`memıy
(
6_d¡
+12, 
sŞ
, 4);

273 
pktbuf
[
off
++] = 0x33;

274 
pktbuf
[
off
++] = 0x33;

275 
	`mem_cÚÿt
(
pktbuf
, 
sŞ
, 4, &
off
, 
pktbuf_Ën
);

276 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
¤c_mac
->
addr
, 6, &
off
, 
pktbuf_Ën
);

277 
	`by‹s_htÚs
(
pktbuf
+
off
, 
ETHERTYPE_IPV6
); off += 2;

280 
6
 = (
6_hdr
 *)(
pktbuf
+
off
); off += (ip6_hdr);

281 
	`mem£t
(
6
, 0, (
6_hdr
));

282 
6
->
6_vfc
 = 0x60;

283 
6
->
6_¶’
 = 
	`htÚs
(32);

284 
6
->
6_nxt
 = 
IPPROTO_ICMPV6
;

285 
6
->
6_hlim
 = 255;

286 
	`memıy
(&
6
->
6_¤c
, 
nd
->
¤c_
->
addr
, 16);

287 
	`memıy
(&
6
->
6_d¡
, ip6_dst, 16);

290 
icmp6
 = (
icmp6_hdr
 *)(
pktbuf
+
off
); off += (icmp6_hdr);

291 
icmp6
->
icmp6_ty³
 = 
ND_NEIGHBOR_SOLICIT
;

292 
icmp6
->
icmp6_code
 = 0;

293 
icmp6
->
icmp6_d©a32
[0] = 0;

294 
icmp6
->
icmp6_cksum
 = 0;

296 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
d¡_
->
addr
, 16, &
off
, 
pktbuf_Ën
);

297 
pktbuf
[
off
++] = 0x01;

298 
pktbuf
[
off
++] = 0x01;

299 
	`mem_cÚÿt
(
pktbuf
, 
nd
->
¤c_mac
->
addr
, 6, &
off
, 
pktbuf_Ën
);

302 
w
 = (
ušt16_t
 *)&
6
->
6_¤c
;

303 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

304 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

305 
w
 = (
ušt16_t
 *)&
6
->
6_d¡
;

306 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

307 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

308 
sum
 +ğ
6
->
6_¶’
;

309 
sum
 +ğ
	`htÚs
(
IPPROTO_ICMPV6
);

310 
w
 = (
ušt16_t
 *)
icmp6
;

311 
i
 = 
	`Áohs
(
6
->
6_¶’
); i > 1; i -= 2)

312 
sum
 +ğ*
w
++;

313 if(
i
 != 0)

314 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

315 
sum
 = (sum >> 16) + (sum & 0xffff);

316 
sum
 += (sum >> 16);

317 if((
u16
 = ~
sum
) == 0)

318 
u16
 = 0xffff;

319 
icmp6
->
icmp6_cksum
 = 
u16
;

322 
	}
}

324 
	$do_nd_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

326 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

327 
nd_¡©e_t
 *
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

328 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
;

329 
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
;

330 
ušt16_t
 
İt_off
;

331 
ušt8_t
 *
İt
;

332 
ušt8_t
 *
mac
 = 
NULL
;

334 #ifdeà
HAVE_SCAMPER_DEBUG


335 
a
[64], 
b
[64];

338 if(
nd
->
´obec
 == 0)

340 
´obe
 = 
nd
->
´obes
[nd->
´obec
-1];

342 if(
	`SCAMPER_DL_IS_ARP
(
dl
))

344 if(
nd
->
m‘hod
 !ğ
SCAMPER_NEIGHBOURDISC_METHOD_ARP
 ||

345 
	`SCAMPER_DL_IS_ARP_OP_REPLY
(
dl
) == 0 ||

346 
	`SCAMPER_DL_IS_ARP_HRD_ETHERNET
(
dl
) == 0 ||

347 
	`SCAMPER_DL_IS_ARP_PRO_IPV4
(
dl
) == 0)

352 
mac
 = 
dl
->
dl_¬p_sha
;

354 if(
	`SCAMPER_DL_IS_ICMPV6
(
dl
))

356 if(
nd
->
m‘hod
 !ğ
SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
 ||

357 
	`SCAMPER_DL_IS_ICMP6_ND_NADV
(
dl
) == 0)

366 
İt
 = 
dl
->
dl_icmp6_nd_İts
;

367 
İt_off
 = 0;

369 
İt_off
 + 8 <ğ
dl
->
dl_icmp6_nd_İts_Ën
)

371 if(
İt
[0]==2 && o±[1]==1 && 
dl
->
dl_icmp6_nd_İts_Ën
-
İt_off
 >= 8)

373 
mac
 = 
İt
+2;

376 if(
İt
[1] == 0)

378 
İt_off
 +ğ(
İt
[1] * 8);

379 
İt
 += (opt[1] * 8);

383 if(
mac
 =ğ
NULL
)

386 if((
»¶y
 = 
	`sÿm³r_Ãighbourdisc_»¶y_®loc
()è=ğ
NULL
)

388 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc„eply");

389 
”r
;

391 
	`timev®_ıy
(&
»¶y
->
rx
, &
dl
->
dl_tv
);

392 
»¶y
->
mac
 = 
	`sÿm³r_addrÿche_g‘_‘h”Ãt
(
addrÿche
, mac);

393 if(
»¶y
->
mac
 =ğ
NULL
)

395 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„eply->mac");

396 
”r
;

399 
	`sÿm³r_debug
(
__func__
, "%s is-at %s",

400 
	`sÿm³r_addr_to¡r
(
nd
->
d¡_
, 
a
, (a)),

401 
	`sÿm³r_addr_to¡r
(
»¶y
->
mac
, 
b
, (b)));

403 if(
	`sÿm³r_Ãighbourdisc_»¶y_add
(
´obe
, 
»¶y
) != 0)

405 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd„eply");

406 
”r
;

409 if(
nd
->
d¡_mac
 =ğ
NULL
)

410 
nd
->
d¡_mac
 = 
	`sÿm³r_addr_u£
(
»¶y
->
mac
);

412 if(
´obe
->
rxc
 == 1)

414 
¡©e
->
»¶yc
++;

415 if((
nd
->
æags
 & 
SCAMPER_NEIGHBOURDISC_FLAG_FIRSTRESPONSE
) != 0)

416 
	`nd_dÚe
(
sk
);

421 
”r
:

423 
	}
}

425 
	$do_nd_´obe
(
sÿm³r_sk_t
 *
sk
)

427 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
 = 
NULL
;

428 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

429 
nd_¡©e_t
 *
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

430 
sÿm³r_dl_t
 *
dl
;

431 
size_t
 
Ën
;

432 

[64], 
mac
[32];

434 if(
¡©e
 =ğ
NULL
)

436 if(
	`nd_¡©e_®loc
(
sk
) != 0)

437 
”r
;

438 
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

442 if(
nd
->
m‘hod
 =ğ
SCAMPER_NEIGHBOURDISC_METHOD_ARP
)

443 
Ën
 = 42;

444 if(
nd
->
m‘hod
 =ğ
SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
)

445 
Ën
 = 86;

446 
”r
;

449 if(
pktbuf_Ën
 < 
Ën
)

451 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
Ën
) != 0)

453 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

454 
”r
;

456 
pktbuf_Ën
 = 
Ën
;

460 if(
nd
->
m‘hod
 =ğ
SCAMPER_NEIGHBOURDISC_METHOD_ARP
)

461 
	`do_nd_´obe_¬p
(
sk
);

462 if(
nd
->
m‘hod
 =ğ
SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
)

463 
	`do_nd_´obe_nsŞ
(
sk
);

464 
”r
;

467 if((
´obe
 = 
	`sÿm³r_Ãighbourdisc_´obe_®loc
()è=ğ
NULL
)

469 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…robe");

470 
”r
;

474 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
fd
);

475 
	`g‘timeofday_w¿p
(&
´obe
->
tx
);

476 if(
	`sÿm³r_dl_tx
(
dl
, 
pktbuf
, 
Ën
) == -1)

478 
”r
;

481 
	`sÿm³r_addr_to¡r
(
nd
->
d¡_
, 

, (ip));

482 
	`sÿm³r_addr_to¡r
(
nd
->
¤c_mac
, 
mac
, (mac));

483 
	`sÿm³r_debug
(
__func__
, "who-ha % ‹Î %s", 

, 
mac
);

485 if(
	`sÿm³r_Ãighbourdisc_´obe_add
(
nd
, 
´obe
) != 0)

487 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…robe");

488 
”r
;

491 
	`sÿm³r_sk_queue_wa™
(
sk
, 
nd
->
wa™
);

494 
”r
:

495 
	`nd_hªdË”rÜ
(
sk
, 
”ºo
);

497 
	}
}

499 
	$do_nd_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

501 
	`sÿm³r_fe_wr™e_Ãighbourdisc
(
sf
, 
	`nd_g‘d©a
(
sk
));

503 
	}
}

505 
	$do_nd_h®t
(
sÿm³r_sk_t
 *
sk
)

507 
	`nd_dÚe
(
sk
);

509 
	}
}

511 
	$do_nd_ä“
(
sÿm³r_sk_t
 *
sk
)

513 
sÿm³r_Ãighbourdisc_do_t
 *
nddo
;

514 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
	`nd_g‘d©a
(
sk
);

515 
nd_¡©e_t
 *
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

516 
sÿm³r_addr_t
 *
mac
 = 
NULL
;

517 
sÿm³r_addr_t
 *

 = 
NULL
;

519 if(
¡©e
 !ğ
NULL
 && s‹->
cbs
 != NULL)

521 if(
nd
 !ğ
NULL
)

523 

 = 
nd
->
d¡_
;

524 
mac
 = 
nd
->
d¡_mac
;

526 (
nddo
 = 
	`dli¡_h—d_pİ
(
¡©e
->
cbs
)è!ğ
NULL
)

528 
nddo
->
node
 = 
NULL
;

529 if(

 !ğ
NULL
)

530 
nddo
->
	`cb
Òddo->
·¿m
, 

, 
mac
);

531 
	`ä“
(
nddo
);

533 
	`dli¡_ä“
(
¡©e
->
cbs
);

534 
¡©e
->
cbs
 = 
NULL
;

537 if(
nd
 !ğ
NULL
)

538 
	`sÿm³r_Ãighbourdisc_ä“
(
nd
);

540 if(
¡©e
 !ğ
NULL
)

541 
	`nd_¡©e_ä“
(
¡©e
);

544 
	}
}

546 
	$nd_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

548 
tmp
;

550 
İtid
)

552 
ND_OPT_IFNAME
:

553 
ND_OPT_ALLATTEMPTS
:

554 
ND_OPT_SRCADDR
:

557 
ND_OPT_ATTEMPTS
:

558 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 65535)

562 
ND_OPT_REPLYC
:

563 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0 ||mp > 65535)

567 
ND_OPT_WAIT
:

568 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 100 ||mp > 65535)

576 if(
out
 !ğ
NULL
)

577 *
out
 = 
tmp
;

580 
	}
}

582 
	$sÿm³r_do_Ãighbourdisc_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

584  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

585 
nd_¬g_·¿m_v®id©e
);

586 
	}
}

588 
sÿm³r_sk_t
 *
	$sÿm³r_do_Ãighbourdisc_®loùask
(*
d©a
,

589 
sÿm³r_li¡_t
 *
li¡
,

590 
sÿm³r_cyşe_t
 *
cyşe
)

592 
sÿm³r_Ãighbourdisc_t
 *
nd
 = (sÿm³r_Ãighbourdisc_ˆ*)
d©a
;

593 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

594 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

597 if((
sk
 = 
	`sÿm³r_sk_®loc
(
nd
, &
nd_funcs
)è=ğ
NULL
)

598 
”r
;

600 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_ND
)è=ğ
NULL
)

601 
”r
;

602 
sig
->
sig_tx_nd_
 = 
	`sÿm³r_addr_u£
(
nd
->
d¡_
);

603 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

604 
”r
;

605 
sig
 = 
NULL
;

608 
nd
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

609 
nd
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

611  
sk
;

613 
”r
:

614 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

615 if(
sk
 !ğ
NULL
)

617 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

618 
	`sÿm³r_sk_ä“
(
sk
);

620  
NULL
;

621 
	}
}

623 *
	$sÿm³r_do_Ãighbourdisc_®loc
(*
¡r
)

625 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
NULL
;

626 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

627 *
iâame
 = 
NULL
;

628 
ušt16_t
 
©‹m±s
 = 1;

629 
ušt16_t
 
»¶yc
 = 0;

630 
ušt16_t
 
wa™
 = 1000;

631 
ušt8_t
 
æags
 = 0;

632 *
d¡
 = 
NULL
;

633 *
¤c
 = 
NULL
;

634 
tmp
 = 0;

637 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
d¡
) != 0)

639 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse command");

640 
”r
;

643 if(
d¡
 =ğ
NULL
)

644 
”r
;

646 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

648 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

649 
	`nd_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

651 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

652 
”r
;

655 
İt
->
id
)

657 
ND_OPT_FIRSTRESPONSE
:

658 
æags
 |ğ
SCAMPER_NEIGHBOURDISC_FLAG_FIRSTRESPONSE
;

661 
ND_OPT_IFNAME
:

662 
iâame
 = 
İt
->
¡r
;

665 
ND_OPT_ATTEMPTS
:

666 
©‹m±s
 = (
ušt16_t
)
tmp
;

669 
ND_OPT_REPLYC
:

670 
»¶yc
 = (
ušt16_t
)
tmp
;

673 
ND_OPT_ALLATTEMPTS
:

674 
æags
 |ğ
SCAMPER_NEIGHBOURDISC_FLAG_ALLATTEMPTS
;

677 
ND_OPT_WAIT
:

678 
wa™
 = (
ušt16_t
)
tmp
;

681 
ND_OPT_SRCADDR
:

682 if(
¤c
 !ğ
NULL
)

683 
”r
;

684 
¤c
 = 
İt
->
¡r
;

688 
	`sÿm³r_debug
(
__func__
, "unhªdËd o±iÚ %d", 
İt
->
id
);

689 
”r
;

693 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

695 if(
iâame
 =ğ
NULL
)

696 
”r
;

698 if((
nd
 = 
	`sÿm³r_Ãighbourdisc_®loc
()è=ğ
NULL
)

699 
”r
;

701 if((
nd
->
d¡_
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
d¡
)è=ğ
NULL
)

702 
”r
;

704 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
nd
->
d¡_
))

705 
nd
->
m‘hod
 = 
SCAMPER_NEIGHBOURDISC_METHOD_ARP
;

706 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
nd
->
d¡_
))

707 
nd
->
m‘hod
 = 
SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
;

709 
”r
;

711 if(
¤c
 !ğ
NULL
)

713 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
nd
->
d¡_
) == 0)

714 
”r
;

715 
nd
->
¤c_
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_INET6
, 
¤c
);

716 if(
nd
->
¤c_
 =ğ
NULL
)

717 
”r
;

720 if(
	`sÿm³r_Ãighbourdisc_iâame_£t
(
nd
, 
iâame
) != 0)

721 
”r
;

727 if((
æags
 & 
SCAMPER_NEIGHBOURDISC_FLAG_FIRSTRESPONSE
) != 0 &&

728 (
»¶yc
 > 1 || (
æags
 & 
SCAMPER_NEIGHBOURDISC_FLAG_ALLATTEMPTS
) != 0))

730 
	`sÿm³r_debug
(
__func__
, "invalid combination of‡rguments");

731 
”r
;

739 if(
»¶yc
 < 
©‹m±s
 &&„eplyc != 0 &&

740 (
æags
 & 
SCAMPER_NEIGHBOURDISC_FLAG_ALLATTEMPTS
) != 0)

742 
	`sÿm³r_debug
(
__func__
, "invalid combination of‡rguments");

743 
”r
;

746 
nd
->
æags
 = flags;

747 
nd
->
©‹m±s
 =‡ttempts;

748 
nd
->
»¶yc
 =„eplyc;

749 
nd
->
wa™
 = wait;

751  
nd
;

753 
”r
:

754 if(
nd
 !ğ
NULL
è
	`sÿm³r_Ãighbourdisc_ä“
(nd);

755 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

756  
NULL
;

757 
	}
}

759 
	$sÿm³r_Ãighbourdisc_do_ä“
(
sÿm³r_Ãighbourdisc_do_t
 *
nddo
)

761 
sÿm³r_sk_t
 *
sk
;

762 
nd_¡©e_t
 *
¡©e
;

764 if(
nddo
 =ğ
NULL
)

767 if((
sk
 = 
nddo
->skè!ğ
NULL
)

769 
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

770 if(
¡©e
 !ğ
NULL
 && 
nddo
->
node
 != NULL)

771 
	`dli¡_node_pİ
(
¡©e
->
cbs
, 
nddo
->
node
);

774 
	`ä“
(
nddo
);

776 
	}
}

778 
sÿm³r_Ãighbourdisc_do_t
 *
	$sÿm³r_Ãighbourdisc_do_add
(

779 
sÿm³r_sk_t
 *
sk
, *
·¿m
,

780 (*
cb
)(*
·¿m
,
sÿm³r_addr_t
 *

,sÿm³r_addr_ˆ*
d¡
))

782 
sÿm³r_Ãighbourdisc_do_t
 *
nddo
 = 
NULL
;

783 
nd_¡©e_t
 *
¡©e
 = 
	`nd_g‘¡©e
(
sk
);

785 if(
¡©e
->
cbs
 =ğ
NULL
 && (¡©e->cb ğ
	`dli¡_®loc
()) == NULL)

787 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc state->cbs");

788  
NULL
;

790 if((
nddo
 = 
	`m®loc_z”o
((
sÿm³r_Ãighbourdisc_do_t
))è=ğ
NULL
)

792 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ddo");

793  
NULL
;

795 
nddo
->
sk
 =ask;

796 
nddo
->
cb
 = cb;

797 
nddo
->
·¿m
 =…aram;

798 if((
nddo
->
node
 = 
	`dli¡__push
(
¡©e
->
cbs
,‚ddo)è=ğ
NULL
)

800 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚ddo");

801 
	`ä“
(
nddo
);

802  
NULL
;

804  
nddo
;

805 
	}
}

807 
sÿm³r_Ãighbourdisc_do_t
 *
	$sÿm³r_do_Ãighbourdisc_do
(

808 
ifšdex
, 
sÿm³r_addr_t
 *
d¡
, *
·¿m
,

809 (*
cb
)(*
·¿m
,
sÿm³r_addr_t
 *

,sÿm³r_addr_ˆ*
d¡
))

811 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
NULL
;

812 
sÿm³r_sk_sig_t
 
sig
;

813 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

814 
ušt8_t
 
m‘hod
;

815 
iâame
[64];

817 if(
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

818 
m‘hod
 = 
SCAMPER_NEIGHBOURDISC_METHOD_ARP
;

820 
m‘hod
 = 
SCAMPER_NEIGHBOURDISC_METHOD_ND_NSOL
;

822 
	`mem£t
(&
sig
, 0, (sig));

823 
sig
.
sig_ty³
 = 
SCAMPER_TASK_SIG_TYPE_TX_ND
;

824 
sig
.
sig_tx_nd_
 = 
d¡
;

827 if((
sk
 = 
	`sÿm³r_sk_fšd
(&
sig
)è!ğ
NULL
)

828  
	`sÿm³r_Ãighbourdisc_do_add
(
sk
, 
·¿m
, 
cb
);

830 if(
	`sÿm³r_if_g‘iâame
(
iâame
, (iâame), 
ifšdex
) != 0)

831 
”r
;

833 if((
nd
 = 
	`sÿm³r_Ãighbourdisc_®loc
()è=ğ
NULL
)

835 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚d");

836 
”r
;

838 if(
	`sÿm³r_Ãighbourdisc_iâame_£t
(
nd
, 
iâame
) != 0)

840 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set ifname");

841 
”r
;

844 
nd
->
m‘hod
 = method;

845 
nd
->
d¡_
 = 
	`sÿm³r_addr_u£
(
d¡
);

846 
nd
->
æags
 |ğ
SCAMPER_NEIGHBOURDISC_FLAG_FIRSTRESPONSE
;

847 
nd
->
©‹m±s
 = 1;

848 
nd
->
wa™
 = 500;

849 
nd
->
»¶yc
 = 1;

851 if((
sk
 = 
	`sÿm³r_do_Ãighbourdisc_®loùask
(
nd
, 
NULL
, NULL)) == NULL)

852 
”r
;

853 
nd
 = 
NULL
;

854 if(
	`sÿm³r_sk_sig_š¡®l
(
sk
) != 0)

855 
”r
;

856 if(
	`nd_¡©e_®loc
(
sk
) != 0)

857 
”r
;

858 
	`do_nd_´obe
(
sk
);

859 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

860 
”r
;

861  
	`sÿm³r_Ãighbourdisc_do_add
(
sk
, 
·¿m
, 
cb
);

863 
”r
:

864 if(
nd
 !ğ
NULL
è
	`sÿm³r_Ãighbourdisc_ä“
(nd);

865  
NULL
;

866 
	}
}

868 
	$sÿm³r_do_Ãighbourdisc_ä“
(*
d©a
)

870 
	`sÿm³r_Ãighbourdisc_ä“
((
sÿm³r_Ãighbourdisc_t
 *)
d©a
);

872 
	}
}

874 
	$sÿm³r_do_Ãighbourdisc_ş—nup
()

876 if(
pktbuf
 !ğ
NULL
)

878 
	`ä“
(
pktbuf
);

879 
pktbuf
 = 
NULL
;

883 
	}
}

885 
	$sÿm³r_do_Ãighbourdisc_š™
()

887 
nd_funcs
.
´obe
 = 
do_nd_´obe
;

888 
nd_funcs
.
hªdË_timeout
 = 
do_nd_hªdË_timeout
;

889 
nd_funcs
.
wr™e
 = 
do_nd_wr™e
;

890 
nd_funcs
.
sk_ä“
 = 
do_nd_ä“
;

891 
nd_funcs
.
hªdË_dl
 = 
do_nd_hªdË_dl
;

892 
nd_funcs
.
h®t
 = 
do_nd_h®t
;

895 
	}
}

	@neighbourdisc/scamper_neighbourdisc_do.h

23 #iâdeà
__SCAMPER_DO_NEIGHBOURDISC_H


24 
	#__SCAMPER_DO_NEIGHBOURDISC_H


	)

26 
sÿm³r_Ãighbourdisc_do
 
	tsÿm³r_Ãighbourdisc_do_t
;

28 *
sÿm³r_do_Ãighbourdisc_®loc
(*
¡r
);

30 
sÿm³r_sk_t
 *
sÿm³r_do_Ãighbourdisc_®loùask
(*
d©a
,

31 
sÿm³r_li¡_t
 *
li¡
,

32 
sÿm³r_cyşe_t
 *
cyşe
);

34 
sÿm³r_do_Ãighbourdisc_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

36 
sÿm³r_do_Ãighbourdisc_ä“
(*);

38 cÚ¡ *
sÿm³r_do_Ãighbourdisc_u§ge
();

41 
sÿm³r_Ãighbourdisc_do_t
 *
sÿm³r_do_Ãighbourdisc_do
(

42 
ifšdex
, 
sÿm³r_addr_t
 *
d¡
,

43 *
·¿m
, (*
cb
)(*, 
sÿm³r_addr_t
 *

, sÿm³r_addr_ˆ*
mac
));

44 
	`sÿm³r_Ãighbourdisc_do_ä“
(
sÿm³r_Ãighbourdisc_do_t
 *
nddo
);

46 
	`sÿm³r_do_Ãighbourdisc_ş—nup
();

47 
	`sÿm³r_do_Ãighbourdisc_š™
();

	@neighbourdisc/scamper_neighbourdisc_warts.c

23 #iâdeà
lšt


24 cÚ¡ 
	grcsid
[] =

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

31 
	~"š‹º®.h
"

33 
	~"sÿm³r_addr.h
"

34 
	~"sÿm³r_li¡.h
"

35 
	~"sÿm³r_icm³xt.h
"

36 
	~"sÿm³r_Ãighbourdisc.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_fe_w¬ts.h
"

39 
	~"sÿm³r_Ãighbourdisc_w¬ts.h
"

41 
	~"mjl_¥ÏyŒ“.h
"

42 
	~"uts.h
"

44 
	#WARTS_NEIGHBOURDISC_LIST
 1

	)

45 
	#WARTS_NEIGHBOURDISC_CYCLE
 2

	)

46 
	#WARTS_NEIGHBOURDISC_USERID
 3

	)

47 
	#WARTS_NEIGHBOURDISC_IFNAME
 4

	)

48 
	#WARTS_NEIGHBOURDISC_START
 5

	)

49 
	#WARTS_NEIGHBOURDISC_METHOD
 6

	)

50 
	#WARTS_NEIGHBOURDISC_WAIT
 7

	)

51 
	#WARTS_NEIGHBOURDISC_FLAGS
 8

	)

52 
	#WARTS_NEIGHBOURDISC_ATTEMPTS
 9

	)

53 
	#WARTS_NEIGHBOURDISC_REPLYC
 10

	)

54 
	#WARTS_NEIGHBOURDISC_SRC_IP
 11

	)

55 
	#WARTS_NEIGHBOURDISC_SRC_MAC
 12

	)

56 
	#WARTS_NEIGHBOURDISC_DST_IP
 13

	)

57 
	#WARTS_NEIGHBOURDISC_DST_MAC
 14

	)

58 
	#WARTS_NEIGHBOURDISC_PROBEC
 15

	)

60 cÚ¡ 
w¬ts_v¬_t
 
	gÃighbourdisc_v¬s
[] =

62 {
WARTS_NEIGHBOURDISC_LIST
, 4, -1},

63 {
WARTS_NEIGHBOURDISC_CYCLE
, 4, -1},

64 {
WARTS_NEIGHBOURDISC_USERID
, 4, -1},

65 {
WARTS_NEIGHBOURDISC_IFNAME
, -1, -1},

66 {
WARTS_NEIGHBOURDISC_START
, 8, -1},

67 {
WARTS_NEIGHBOURDISC_METHOD
, 1, -1},

68 {
WARTS_NEIGHBOURDISC_WAIT
, 2, -1},

69 {
WARTS_NEIGHBOURDISC_FLAGS
, 1, -1},

70 {
WARTS_NEIGHBOURDISC_ATTEMPTS
, 2, -1},

71 {
WARTS_NEIGHBOURDISC_REPLYC
, 2, -1},

72 {
WARTS_NEIGHBOURDISC_SRC_IP
, -1, -1},

73 {
WARTS_NEIGHBOURDISC_SRC_MAC
, -1, -1},

74 {
WARTS_NEIGHBOURDISC_DST_IP
, -1, -1},

75 {
WARTS_NEIGHBOURDISC_DST_MAC
, -1, -1},

76 {
WARTS_NEIGHBOURDISC_PROBEC
, 2, -1},

78 
	#Ãighbourdisc_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Ãighbourdisc_v¬s
)

	)

80 
	#WARTS_NEIGHBOURDISC_PROBE_TX
 1

	)

81 
	#WARTS_NEIGHBOURDISC_PROBE_RXC
 2

	)

82 cÚ¡ 
w¬ts_v¬_t
 
	gÃighbourdisc_´obe_v¬s
[] =

84 {
WARTS_NEIGHBOURDISC_PROBE_TX
, 8, -1},

85 {
WARTS_NEIGHBOURDISC_PROBE_RXC
, 4, -1},

87 
	#Ãighbourdisc_´obe_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Ãighbourdisc_´obe_v¬s
)

	)

89 
	#WARTS_NEIGHBOURDISC_REPLY_RX
 1

	)

90 
	#WARTS_NEIGHBOURDISC_REPLY_MAC
 2

	)

91 cÚ¡ 
w¬ts_v¬_t
 
	gÃighbourdisc_»¶y_v¬s
[] =

93 {
WARTS_NEIGHBOURDISC_REPLY_RX
, 8, -1},

94 {
WARTS_NEIGHBOURDISC_REPLY_MAC
, -1, -1},

96 
	#Ãighbourdisc_»¶y_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Ãighbourdisc_»¶y_v¬s
)

	)

99 
	sw¬ts_Ãighbourdisc_»¶y


101 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Ãighbourdisc_»¶y_v¬s
)];

102 
ušt16_t
 
	mæags_Ën
;

103 
ušt16_t
 
	m·¿ms_Ën
;

104 } 
	tw¬ts_Ãighbourdisc_»¶y_t
;

106 
	sw¬ts_Ãighbourdisc_´obe


108 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Ãighbourdisc_´obe_v¬s
)];

109 
ušt16_t
 
	mæags_Ën
;

110 
ušt16_t
 
	m·¿ms_Ën
;

111 
w¬ts_Ãighbourdisc_»¶y_t
 *
	mrxs
;

112 } 
	tw¬ts_Ãighbourdisc_´obe_t
;

115 
	$w¬ts_Ãighbourdisc_»¶y_¡©e
(
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
,

116 
w¬ts_Ãighbourdisc_»¶y_t
 *
¡©e
,

117 
w¬ts_add¹abË_t
 *
bË
,

118 
ušt32_t
 *
Ën
)

120 
i
 = 0;

122 
	`mem£t
(
¡©e
->
æags
, 0, 
Ãighbourdisc_»¶y_v¬s_mfb
);

123 
¡©e
->
·¿ms_Ën
 = 0;

125 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_NEIGHBOURDISC_REPLY_RX
, &
i
);

126 
¡©e
->
·¿ms_Ën
 += 8;

127 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_NEIGHBOURDISC_REPLY_MAC
, &
i
);

128 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
mac
);

130 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
i
);

132 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

133 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

136 
	}
}

138 
	$w¬ts_Ãighbourdisc_»¶y_wr™e
(cÚ¡ 
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
,

139 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

140 
w¬ts_add¹abË_t
 *
bË
,

141 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

142 cÚ¡ 
ušt32_t
 
Ën
,

143 
w¬ts_Ãighbourdisc_»¶y_t
 *
¡©e
)

145 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

146 {&
»¶y
->
rx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

147 {
»¶y
->
mac
, (
wpw_t
)
š£¹_addr
, 
bË
},

149 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

151 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

152 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

153 
hªdËrs
, 
hªdËr_út
);

155 
	}
}

157 
	$w¬ts_Ãighbourdisc_»¶y_»ad
(
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
,

158 
w¬ts_¡©e_t
 *
¡©e
,

159 
w¬ts_add¹abË_t
 *
bË
,

160 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

161 
ušt32_t
 
Ën
)

163 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

164 {&
»¶y
->
rx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

165 {&
»¶y
->
mac
, (
w´_t
)
exŒaù_addr
, 
bË
},

167 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

168  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

169 
	}
}

171 
	$w¬ts_Ãighbourdisc_´obe_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

172 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
,

173 
w¬ts_Ãighbourdisc_´obe_t
 *
¡©e
,

174 
w¬ts_add¹abË_t
 *
bË
,

175 
ušt32_t
 *
Ën
)

177 
i
 = 0;

178 
size_t
 
size
;

180 
	`mem£t
(
¡©e
->
æags
, 0, 
Ãighbourdisc_´obe_v¬s_mfb
);

181 
¡©e
->
·¿ms_Ën
 = 0;

183 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_NEIGHBOURDISC_PROBE_TX
, &
i
);

184 
¡©e
->
·¿ms_Ën
 += 8;

185 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_NEIGHBOURDISC_PROBE_RXC
, &
i
);

186 
¡©e
->
·¿ms_Ën
 += 2;

188 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
i
);

189 
¡©e
->
rxs
 = 
NULL
;

191 if(
´obe
->
rxc
 > 0)

193 
size
 = (
w¬ts_Ãighbourdisc_»¶y_t
è* 
´obe
->
rxc
;

194 if((
¡©e
->
rxs
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

197 
i
=0; i<
´obe
->
rxc
; i++)

199 if(
	`w¬ts_Ãighbourdisc_»¶y_¡©e
(
´obe
->
rxs
[
i
], &
¡©e
->rxs[i],

200 
bË
, 
Ën
) != 0)

202 
	`ä“
(
¡©e
->
rxs
);

203 
¡©e
->
rxs
 = 
NULL
;

210 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

211 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

214 
	}
}

216 
	$w¬ts_Ãighbourdisc_´obe_wr™e
(cÚ¡ 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
,

217 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

218 
w¬ts_add¹abË_t
 *
bË
,

219 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

220 cÚ¡ 
ušt32_t
 
Ën
,

221 
w¬ts_Ãighbourdisc_´obe_t
 *
¡©e
)

223 
ušt16_t
 
i
;

224 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

225 {&
´obe
->
tx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

226 {&
´obe
->
rxc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

228 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

230 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

231 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

232 
hªdËrs
, 
hªdËr_út
);

234 
i
=0; i<
´obe
->
rxc
; i++)

236 
	`w¬ts_Ãighbourdisc_»¶y_wr™e
(
´obe
->
rxs
[
i
], 
sf
, 
bË
, 
buf
, 
off
, 
Ën
,

237 &
¡©e
->
rxs
[
i
]);

241 
	}
}

243 
	$w¬ts_Ãighbourdisc_´obe_»ad
(
sÿm³r_Ãighbourdisc_´obe_t
 *
´
,

244 
w¬ts_¡©e_t
 *
¡©e
,

245 
w¬ts_add¹abË_t
 *
bË
,

246 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

247 
ušt32_t
 
Ën
)

249 
sÿm³r_Ãighbourdisc_»¶y_t
 *
»¶y
;

250 
ušt16_t
 
i
;

251 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

252 {&
´
->
tx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

253 {&
´
->
rxc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

255 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

257 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

260 if(
´
->
rxc
 == 0)

263 if(
	`sÿm³r_Ãighbourdisc_»¶›s_®loc
(
´
,…r->
rxc
) != 0)

266 
i
=0; i<
´
->
rxc
; i++)

268 if((
»¶y
 = 
	`sÿm³r_Ãighbourdisc_»¶y_®loc
()è=ğ
NULL
)

270 
´
->
rxs
[
i
] = 
»¶y
;

272 if(
	`w¬ts_Ãighbourdisc_»¶y_»ad
(
»¶y
,
¡©e
,
bË
,
buf
,
off
,
Ën
) != 0)

277 
	}
}

279 
	$w¬ts_Ãighbourdisc_·¿ms
(cÚ¡ 
sÿm³r_Ãighbourdisc_t
 *
nd
,

280 
w¬ts_add¹abË_t
 *
bË
,

281 
ušt8_t
 *
æags
, 
ušt16_t
 *
æags_Ën
,

282 
ušt16_t
 *
·¿ms_Ën
)

284 
i
, 
max_id
 = 0;

285 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

287 
	`mem£t
(
æags
, 0, 
Ãighbourdisc_v¬s_mfb
);

288 *
·¿ms_Ën
 = 0;

290 
i
=0; i<(
Ãighbourdisc_v¬s
)/(
w¬ts_v¬_t
); i++)

292 
v¬
 = &
Ãighbourdisc_v¬s
[
i
];

294 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_LIST
 && 
nd
->
li¡
 =ğ
NULL
)

296 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_CYCLE
 && 
nd
->
cyşe
 =ğ
NULL
)

298 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_USERID
 && 
nd
->
u£rid
 == 0)

300 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_IFNAME
 && 
nd
->
iâame
 =ğ
NULL
)

302 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_SRC_IP
 && 
nd
->
¤c_
 =ğ
NULL
)

304 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_SRC_MAC
 && 
nd
->
¤c_mac
 =ğ
NULL
)

306 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_DST_IP
 && 
nd
->
d¡_
 =ğ
NULL
)

308 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_DST_MAC
 && 
nd
->
d¡_mac
 =ğ
NULL
)

310 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_PROBEC
 && 
nd
->
´obec
 == 0)

313 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

315 if(
v¬
->
size
 < 0)

317 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_SRC_IP
)

318 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
nd
->
¤c_
);

319 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_SRC_MAC
)

320 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
nd
->
¤c_mac
);

321 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_DST_IP
)

322 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
nd
->
d¡_
);

323 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_DST_MAC
)

324 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
nd
->
d¡_mac
);

325 if(
v¬
->
id
 =ğ
WARTS_NEIGHBOURDISC_IFNAME
)

326 *
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
nd
->
iâame
);

330 
	`as£¹
(
v¬
->
size
 >= 0);

331 *
·¿ms_Ën
 +ğ
v¬
->
size
;

334 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

336 
	}
}

338 
	$w¬ts_Ãighbourdisc_·¿ms_wr™e
(cÚ¡ 
sÿm³r_Ãighbourdisc_t
 *
nd
,

339 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

340 
w¬ts_add¹abË_t
 *
bË
,

341 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

342 cÚ¡ 
ušt32_t
 
Ën
,

343 cÚ¡ 
ušt8_t
 *
æags
,

344 cÚ¡ 
ušt16_t
 
æags_Ën
,

345 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

347 
ušt32_t
 
li¡_id
, 
cyşe_id
;

348 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

349 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

350 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

351 {&
nd
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

352 {
nd
->
iâame
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

353 {&
nd
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

354 {&
nd
->
m‘hod
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

355 {&
nd
->
wa™
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

356 {&
nd
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

357 {&
nd
->
©‹m±s
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

358 {&
nd
->
»¶yc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

359 {
nd
->
¤c_
, (
wpw_t
)
š£¹_addr
, 
bË
},

360 {
nd
->
¤c_mac
, (
wpw_t
)
š£¹_addr
, 
bË
},

361 {
nd
->
d¡_
, (
wpw_t
)
š£¹_addr
, 
bË
},

362 {
nd
->
d¡_mac
, (
wpw_t
)
š£¹_addr
, 
bË
},

363 {&
nd
->
´obec
, (
wpw_t
)
š£¹_ušt16
, 
bË
},

365 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

367 if(
	`w¬ts_li¡_g‘id
(
sf
, 
nd
->
li¡
, &
li¡_id
) == -1)  -1;

368 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
nd
->
cyşe
, &
cyşe_id
) == -1)  -1;

370 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
,

371 
hªdËrs
, 
hªdËr_út
);

374 
	}
}

376 
	$w¬ts_Ãighbourdisc_·¿ms_»ad
(
sÿm³r_Ãighbourdisc_t
 *
nd
,

377 
w¬ts_add¹abË_t
 *
bË
,

378 
w¬ts_¡©e_t
 *
¡©e
,

379 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

380 
ušt32_t
 
Ën
)

382 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

383 {&
nd
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

384 {&
nd
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

385 {&
nd
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

386 {&
nd
->
iâame
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

387 {&
nd
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

388 {&
nd
->
m‘hod
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

389 {&
nd
->
wa™
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

390 {&
nd
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

391 {&
nd
->
©‹m±s
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

392 {&
nd
->
»¶yc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

393 {&
nd
->
¤c_
, (
w´_t
)
exŒaù_addr
, 
bË
},

394 {&
nd
->
¤c_mac
, (
w´_t
)
exŒaù_addr
, 
bË
},

395 {&
nd
->
d¡_
, (
w´_t
)
exŒaù_addr
, 
bË
},

396 {&
nd
->
d¡_mac
, (
w´_t
)
exŒaù_addr
, 
bË
},

397 {&
nd
->
´obec
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

399 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

400  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

401 
	}
}

403 
	$w¬ts_Ãighbourdisc_´obes_ä“
(
w¬ts_Ãighbourdisc_´obe_t
 *
ps
,

404 
ušt32_t
 
út
)

406 
ušt16_t
 
i
;

408 if(
ps
 !ğ
NULL
)

410 
i
=0; i<
út
; i++)

412 
	`ä“
(
ps
[
i
].
rxs
);

414 
	`ä“
(
ps
);

418 
	}
}

420 
	$sÿm³r_fe_w¬ts_Ãighbourdisc_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

421 cÚ¡ 
sÿm³r_Ãighbourdisc_t
 *
nd
)

423 
w¬ts_add¹abË_t
 
bË
;

424 
w¬ts_Ãighbourdisc_´obe_t
 *
´obes
 = 
NULL
;

425 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
;

426 
ušt8_t
 *
buf
 = 
NULL
;

427 
ušt8_t
 
æags
[
Ãighbourdisc_v¬s_mfb
];

428 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

429 
ušt32_t
 
Ën
, 
Ën2
, 
off
 = 0;

430 
size_t
 
size
;

431 
i
;

433 
	`mem£t
(&
bË
, 0, (table));

436 
	`w¬ts_Ãighbourdisc_·¿ms
(
nd
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

437 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

439 if(
nd
->
´obec
 > 0)

441 
size
 = 
nd
->
´obec
 * (
w¬ts_Ãighbourdisc_´obe_t
);

442 if((
´obes
 = (
w¬ts_Ãighbourdisc_´obe_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

443 
”r
;

445 
i
=0; i<
nd
->
´obec
; i++)

447 
´obe
 = 
nd
->
´obes
[
i
];

448 
Ën2
 = 
Ën
;

449 if(
	`w¬ts_Ãighbourdisc_´obe_¡©e
(
sf
, 
´obe
, &
´obes
[
i
], &
bË
,

450 &
Ën2
) != 0)

451 
”r
;

452 if(
Ën2
 < 
Ën
)

453 
”r
;

454 
Ën
 = 
Ën2
;

458 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

459 
”r
;

460 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_NEIGHBOURDISC
);

462 if(
	`w¬ts_Ãighbourdisc_·¿ms_wr™e
(
nd
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

463 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

465 
”r
;

468 if(
nd
->
´obec
 > 0)

470 
i
=0; i<
nd
->
´obec
; i++)

472 
´obe
 = 
nd
->
´obes
[
i
];

473 
	`w¬ts_Ãighbourdisc_´obe_wr™e
(
´obe
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

474 &
´obes
[
i
]);

478 
	`w¬ts_Ãighbourdisc_´obes_ä“
(
´obes
, 
nd
->
´obec
);

479 
´obes
 = 
NULL
;

481 
	`as£¹
(
off
 =ğ
Ën
);

483 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

485 
”r
;

488 
	`w¬ts_add¹abË_ş—n
(&
bË
);

489 
	`ä“
(
buf
);

492 
”r
:

493 
	`w¬ts_add¹abË_ş—n
(&
bË
);

494 if(
´obes
 !ğ
NULL
è
	`w¬ts_Ãighbourdisc_´obes_ä“
Õrobes, 
nd
->
´obec
);

495 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

497 
	}
}

499 
	$sÿm³r_fe_w¬ts_Ãighbourdisc_»ad
(
sÿm³r_fe_t
 *
sf
,

500 cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

501 
sÿm³r_Ãighbourdisc_t
 **
nd_out
)

503 
sÿm³r_Ãighbourdisc_t
 *
nd
 = 
NULL
;

504 
sÿm³r_Ãighbourdisc_´obe_t
 *
´obe
;

505 
w¬ts_add¹abË_t
 
bË
;

506 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

507 
ušt8_t
 *
buf
 = 
NULL
;

508 
ušt32_t
 
off
 = 0;

509 
ušt16_t
 
i
;

511 
	`mem£t
(&
bË
, 0, (table));

513 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

515 
”r
;

517 if(
buf
 =ğ
NULL
)

519 *
nd_out
 = 
NULL
;

523 if((
nd
 = 
	`sÿm³r_Ãighbourdisc_®loc
()è=ğ
NULL
)

525 
”r
;

528 if(
	`w¬ts_Ãighbourdisc_·¿ms_»ad
(
nd
,&
bË
,
¡©e
,
buf
,&
off
,
hdr
->
Ën
) != 0)

530 
”r
;

533 if(
nd
->
´obec
 == 0)

534 
dÚe
;

536 if(
	`sÿm³r_Ãighbourdisc_´obes_®loc
(
nd
,‚d->
´obec
) != 0)

538 
”r
;

541 
i
=0; i<
nd
->
´obec
; i++)

543 if((
´obe
 = 
	`sÿm³r_Ãighbourdisc_´obe_®loc
()è=ğ
NULL
)

545 
”r
;

547 
nd
->
´obes
[
i
] = 
´obe
;

549 if(
	`w¬ts_Ãighbourdisc_´obe_»ad
(
´obe
, 
¡©e
, &
bË
,

550 
buf
, &
off
, 
hdr
->
Ën
) != 0)

552 
”r
;

556 
dÚe
:

557 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

558 
	`w¬ts_add¹abË_ş—n
(&
bË
);

559 *
nd_out
 = 
nd
;

560 
	`ä“
(
buf
);

563 
”r
:

564 
	`w¬ts_add¹abË_ş—n
(&
bË
);

565 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

566 if(
nd
 !ğ
NULL
è
	`sÿm³r_Ãighbourdisc_ä“
(nd);

568 
	}
}

	@neighbourdisc/scamper_neighbourdisc_warts.h

23 #iâdeà
__SCAMPER_NEIGHBOURDISC_WARTS_H


24 
	#__SCAMPER_NEIGHBOURDISC_WARTS_H


	)

26 
sÿm³r_fe_w¬ts_Ãighbourdisc_»ad
(
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

28 
sÿm³r_Ãighbourdisc_t
 **
nd_out
);

30 
sÿm³r_fe_w¬ts_Ãighbourdisc_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

31 cÚ¡ 
sÿm³r_Ãighbourdisc_t
 *
nd
);

	@ping/scamper_ping.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_pšg.h
"

40 
	~"uts.h
"

42 *
	$sÿm³r_pšg_m‘hod2¡r
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
, *
buf
, 
size_t
 
Ën
)

44 *
m
[] = {

53 if(
pšg
->
´obe_m‘hod
 > (
m
) / (*))

55 
	`¢´štf
(
buf
, 
Ën
, "%d", 
pšg
->
´obe_m‘hod
);

56  
buf
;

59  
m
[
pšg
->
´obe_m‘hod
];

60 
	}
}

62 
	$sÿm³r_pšg_¡©s
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
, 
sÿm³r_pšg_¡©s_t
 *
¡©s
)

64 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

65 
ušt16_t
 
i
;

66 
ušt32_t
 
us
;

67 
d
, 
sum
 = 0, 
diff
 = 0, 
¹t
;

68 
fœ¡
 = 1;

69 
ušt32_t
 
n
;

71 
	`mem£t
(
¡©s
, 0, (
sÿm³r_pšg_¡©s_t
));

73 
i
=0; i<
pšg
->
pšg_£Á
; i++)

75 if((
»¶y
 = 
pšg
->
pšg_»¶›s
[
i
]è=ğ
NULL
)

77 
¡©s
->
Æoss
++;

81 
¡©s
->
Ä•l›s
++;

84 if(
fœ¡
 == 0)

86 if(
	`timev®_cmp
(&
»¶y
->
¹t
, &
¡©s
->
mš_¹t
) < 0)

87 
	`timev®_ıy
(&
¡©s
->
mš_¹t
, &
»¶y
->
¹t
);

88 if(
	`timev®_cmp
(&
»¶y
->
¹t
, &
¡©s
->
max_¹t
) > 0)

89 
	`timev®_ıy
(&
¡©s
->
max_¹t
, &
»¶y
->
¹t
);

93 
	`timev®_ıy
(&
¡©s
->
mš_¹t
, &
»¶y
->
¹t
);

94 
	`timev®_ıy
(&
¡©s
->
max_¹t
, &
»¶y
->
¹t
);

95 
fœ¡
 = 0;

98 
sum
 +ğ((
»¶y
->
¹t
.
tv_£c
 * 1000000è+„•ly->¹t.
tv_u£c
);

100 if(
»¶y
->
Ãxt
 !ğ
NULL
)

102 
»¶y
 =„•ly->
Ãxt
;

103 
¡©s
->
ndups
++;

109 
n
 = 
¡©s
->
Ä•l›s
 + sts->
ndups
;

111 if(
n
 > 0)

114 
us
 = (
sum
 / 
n
);

115 
¡©s
->
avg_¹t
.
tv_£c
 = 
us
 / 1000000;

116 
¡©s
->
avg_¹t
.
tv_u£c
 = 
us
 % 1000000;

119 
d
 = (
sum
 / 
n
);

120 
sum
 = 0;

121 
i
=0; i<
pšg
->
pšg_£Á
; i++)

123 
»¶y
=
pšg
->
pšg_»¶›s
[
i
];„•ly !ğ
NULL
;„•ly =„•ly->
Ãxt
)

125 
¹t
 = ((
»¶y
->¹t.
tv_£c
 * 1000000è+„•ly->¹t.
tv_u£c
);

126 
diff
 = 
¹t
 - 
d
;

127 
sum
 +ğ(
diff
 * diff);

131 
us
 = 
	`sq¹
(
sum
/
n
);

132 
¡©s
->
¡ddev_¹t
.
tv_£c
 = 
us
 / 1000000;

133 
¡©s
->
¡ddev_¹t
.
tv_u£c
 = 
us
 % 1000000;

137 
	}
}

139 
	$sÿm³r_pšg_£td©a
(
sÿm³r_pšg_t
 *
pšg
, 
ušt8_t
 *
by‹s
, 
ušt16_t
 
Ën
)

141 
ušt8_t
 *
dup
;

144 if(
by‹s
 !ğ
NULL
 && 
Ën
 > 0)

146 if((
dup
 = 
	`memdup
(
by‹s
, 
Ën
)è=ğ
NULL
)

153 
dup
 = 
NULL
;

154 
Ën
 = 0;

158 if(
pšg
->
´obe_d©a
 !ğ
NULL
)

160 
	`ä“
(
pšg
->
´obe_d©a
);

164 
pšg
->
´obe_d©a
 = 
dup
;

165 
pšg
->
´obe_d©®’
 = 
Ën
;

168 
	}
}

170 
sÿm³r_addr_t
 *
	$sÿm³r_pšg_addr
(cÚ¡ *
va
)

172  ((cÚ¡ 
sÿm³r_pšg_t
 *)
va
)->
d¡
;

173 
	}
}

175 
sÿm³r_pšg_»¶y_t¤•ly_t
 *
	$sÿm³r_pšg_»¶y_t¤•ly_®loc
()

177  
	`m®loc_z”o
((
sÿm³r_pšg_»¶y_t¤•ly_t
));

178 
	}
}

180 
	$sÿm³r_pšg_»¶y_t¤•ly_ä“
(
sÿm³r_pšg_»¶y_t¤•ly_t
 *
t¤
)

182 
	`ä“
(
t¤
);

184 
	}
}

186 
	$sÿm³r_pšg_v4ts_ä“
(
sÿm³r_pšg_v4ts_t
 *
ts
)

188 
ušt8_t
 
i
;

190 if(
ts
 =ğ
NULL
)

193 if(
ts
->
s
 !ğ
NULL
)

195 
i
=0; i<
ts
->
c
; i++)

196 if(
ts
->
s
[
i
] !ğ
NULL
)

197 
	`sÿm³r_addr_ä“
(
ts
->
s
[
i
]);

198 
	`ä“
(
ts
->
s
);

201 
	`ä“
(
ts
);

203 
	}
}

205 
sÿm³r_pšg_v4ts_t
 *
	$sÿm³r_pšg_v4ts_®loc
(
ušt8_t
 
c
)

207 
sÿm³r_pšg_v4ts_t
 *
ts
 = 
NULL
;

209 if(
c
 == 0)

210 
”r
;

212 if((
ts
 = 
	`m®loc_z”o
((
sÿm³r_pšg_»¶y_v4ts_t
))è=ğ
NULL
)

213 
”r
;

214 
ts
->
c
 = ipc;

216 if((
ts
->
s
 = 
	`m®loc_z”o
((
sÿm³r_addr_t
 *è* 
c
)è=ğ
NULL
)

217 
”r
;

219  
ts
;

221 
”r
:

222 
	`sÿm³r_pšg_v4ts_ä“
(
ts
);

223  
NULL
;

224 
	}
}

226 
sÿm³r_pšg_t
 *
	$sÿm³r_pšg_®loc
()

228  (
sÿm³r_pšg_t
 *)
	`m®loc_z”o
((scamper_ping_t));

229 
	}
}

231 
	$sÿm³r_pšg_ä“
(
sÿm³r_pšg_t
 *
pšg
)

233 
sÿm³r_pšg_»¶y_t
 *
»¶y
, *
»¶y_Ãxt
;

234 
ušt16_t
 
i
;

236 if(
pšg
 =ğ
NULL
) ;

238 if(
pšg
->
pšg_»¶›s
 !ğ
NULL
)

240 
i
=0; i<
pšg
->
pšg_£Á
; i++)

242 
»¶y
 = 
pšg
->
pšg_»¶›s
[
i
];

243 
»¶y
 !ğ
NULL
)

245 
»¶y_Ãxt
 = 
»¶y
->
Ãxt
;

246 
	`sÿm³r_pšg_»¶y_ä“
(
»¶y
);

247 
»¶y
 = 
»¶y_Ãxt
;

250 
	`ä“
(
pšg
->
pšg_»¶›s
);

253 if(
pšg
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(ping->dst);

254 if(
pšg
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(ping->src);

256 if(
pšg
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(ping->cycle);

257 if(
pšg
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(ping->list);

259 if(
pšg
->
´obe_t¥s
 !ğ
NULL
è
	`sÿm³r_pšg_v4ts_ä“
(ping->probe_tsps);

261 
	`ä“
(
pšg
);

263 
	}
}

265 
ušt32_t
 
	$sÿm³r_pšg_»¶y_couÁ
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

267 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

268 
ušt16_t
 
i
;

269 
ušt32_t
 
couÁ
;

271 
i
=0, 
couÁ
=0; i<
pšg
->
pšg_£Á
; i++)

273 
»¶y
 = 
pšg
->
pšg_»¶›s
[
i
];

275 
»¶y
 !ğ
NULL
)

277 
couÁ
++;

278 
»¶y
 =„•ly->
Ãxt
;

282  
couÁ
;

283 
	}
}

285 
	$sÿm³r_pšg_»¶y_­³nd
(
sÿm³r_pšg_t
 *
p
, 
sÿm³r_pšg_»¶y_t
 *
»¶y
)

287 
sÿm³r_pšg_»¶y_t
 *
»¶›s
;

289 if(
p
 =ğ
NULL
 || 
»¶y
 =ğNULL ||„•ly->
´obe_id
 >ğp->
pšg_£Á
)

294 if((
»¶›s
 = 
p
->
pšg_»¶›s
[
»¶y
->
´obe_id
]è=ğ
NULL
)

296 
p
->
pšg_»¶›s
[
»¶y
->
´obe_id
] =„eply;

300 
»¶›s
->
Ãxt
 !ğ
NULL
)

302 
»¶›s
 =„•l›s->
Ãxt
;

305 
»¶›s
->
Ãxt
 = 
»¶y
;

309 
	}
}

311 
	$sÿm³r_pšg_»¶›s_®loc
(
sÿm³r_pšg_t
 *
pšg
, 
couÁ
)

313 
size_t
 
size
;

315 
size
 = (
sÿm³r_pšg_»¶y_t
 *è* 
couÁ
;

316 if((
pšg
->
pšg_»¶›s
 = (
sÿm³r_pšg_»¶y_t
 **)
	`m®loc_z”o
(
size
)è!ğ
NULL
)

322 
	}
}

324 
	$sÿm³r_pšg_»¶y_v4ts_ä“
(
sÿm³r_pšg_»¶y_v4ts_t
 *
ts
)

326 
ušt8_t
 
i
;

328 if(
ts
 =ğ
NULL
)

331 if(
ts
->
tss
 !ğ
NULL
)

332 
	`ä“
(
ts
->
tss
);

334 if(
ts
->
s
 !ğ
NULL
)

336 
i
=0; i<
ts
->
tsc
; i++)

337 if(
ts
->
s
[
i
] !ğ
NULL
)

338 
	`sÿm³r_addr_ä“
(
ts
->
s
[
i
]);

339 
	`ä“
(
ts
->
s
);

342 
	`ä“
(
ts
);

344 
	}
}

346 
sÿm³r_pšg_»¶y_v4ts_t
 *
	$sÿm³r_pšg_»¶y_v4ts_®loc
(
ušt8_t
 
tsc
, 

)

348 
sÿm³r_pšg_»¶y_v4ts_t
 *
ts
 = 
NULL
;

350 if((
ts
 = 
	`m®loc_z”o
((
sÿm³r_pšg_»¶y_v4ts_t
))è=ğ
NULL
)

351 
”r
;

352 
ts
->
tsc
 =sc;

354 if(
tsc
 > 0)

356 if((
ts
->
tss
 = 
	`m®loc_z”o
((
ušt32_t
è* 
tsc
)è=ğ
NULL
)

357 
”r
;

358 if(

 != 0 &&

359 (
ts
->
s
 = 
	`m®loc_z”o
((
sÿm³r_addr_t
 *è* 
tsc
)è=ğ
NULL
)

360 
”r
;

363  
ts
;

365 
”r
:

366 
	`sÿm³r_pšg_»¶y_v4ts_ä“
(
ts
);

367  
NULL
;

368 
	}
}

370 
	$sÿm³r_pšg_»¶y_v4¼_ä“
(
sÿm³r_pšg_»¶y_v4¼_t
 *
¼
)

372 
ušt8_t
 
i
;

374 if(
¼
 =ğ
NULL
)

377 if(
¼
->¼ !ğ
NULL
)

379 
i
=0; i<
¼
->
¼c
; i++)

380 if(
¼
->¼[
i
] !ğ
NULL
)

381 
	`sÿm³r_addr_ä“
(
¼
->¼[
i
]);

382 
	`ä“
(
¼
->rr);

385 
	`ä“
(
¼
);

387 
	}
}

389 
sÿm³r_pšg_»¶y_v4¼_t
 *
	$sÿm³r_pšg_»¶y_v4¼_®loc
(
ušt8_t
 
¼c
)

391 
sÿm³r_pšg_»¶y_v4¼_t
 *
¼
 = 
NULL
;

393 if(
¼c
 == 0)

394 
”r
;

396 if((
¼
 = 
	`m®loc_z”o
((
sÿm³r_pšg_»¶y_v4¼_t
))è=ğ
NULL
)

397 
”r
;

398 
¼
->
¼c
 =„rc;

400 if((
¼
->¼ = 
	`m®loc_z”o
((
sÿm³r_addr_t
 *è* 
¼c
)è=ğ
NULL
)

401 
”r
;

403  
¼
;

405 
”r
:

406 
	`sÿm³r_pšg_»¶y_v4¼_ä“
(
¼
);

407  
NULL
;

408 
	}
}

410 
sÿm³r_pšg_»¶y_t
 *
	$sÿm³r_pšg_»¶y_®loc
()

412  (
sÿm³r_pšg_»¶y_t
 *)
	`m®loc_z”o
((scamper_ping_reply_t));

413 
	}
}

415 
	$sÿm³r_pšg_»¶y_ä“
(
sÿm³r_pšg_»¶y_t
 *
»¶y
)

417 if(
»¶y
 =ğ
NULL
) ;

419 if(
»¶y
->
addr
 !ğ
NULL
)

420 
	`sÿm³r_addr_ä“
(
»¶y
->
addr
);

422 if(
»¶y
->
v4¼
 !ğ
NULL
)

423 
	`sÿm³r_pšg_»¶y_v4¼_ä“
(
»¶y
->
v4¼
);

425 if(
»¶y
->
v4ts
 !ğ
NULL
)

426 
	`sÿm³r_pšg_»¶y_v4ts_ä“
(
»¶y
->
v4ts
);

428 if(
»¶y
->
t¤•ly
 !ğ
NULL
)

429 
	`sÿm³r_pšg_»¶y_t¤•ly_ä“
(
»¶y
->
t¤•ly
);

431 
	`ä“
(
»¶y
);

433 
	}
}

	@ping/scamper_ping.h

26 #iâdeà
__SCAMPER_PING_H


27 
	#__SCAMPER_PING_H


	)

29 
	#SCAMPER_PING_REPLY_IS_ICMP
(
»¶y
) ( \

30 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

31 (
»¶y
)->
»¶y_´Ùo
 == 1) || \

32 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

33 (
»¶y
)->
»¶y_´Ùo
 =ğ58))

	)

35 
	#SCAMPER_PING_REPLY_IS_TCP
(
»¶y
) ( \

36 ((
»¶y
)->
»¶y_´Ùo
 =ğ6))

	)

38 
	#SCAMPER_PING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
) ( \

39 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

40 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 0) || \

41 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

42 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ129))

	)

44 
	#SCAMPER_PING_REPLY_IS_ICMP_UNREACH
(
»¶y
) ( \

45 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

46 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 3) || \

47 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

48 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ1))

	)

50 
	#SCAMPER_PING_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
) ( \

51 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

52 (
»¶y
)->
»¶y_´Ùo
 == 1 && \

53 (
»¶y
)->
icmp_ty³
 =ğ3 && (»¶y)->
icmp_code
 == 3) || \

54 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

55 (
»¶y
)->
»¶y_´Ùo
 == 58 && \

56 (
»¶y
)->
icmp_ty³
 =ğ1 && (»¶y)->
icmp_code
 =ğ4))

	)

58 
	#SCAMPER_PING_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ( \

59 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

60 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 == 11) || \

61 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

62 (
»¶y
)->
»¶y_´Ùo
 =ğ58 && (»¶y)->
icmp_ty³
 =ğ3))

	)

64 
	#SCAMPER_PING_REPLY_IS_ICMP_TSREPLY
(
»¶y
) ( \

65 ((
»¶y
)->
addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

66 (
»¶y
)->
»¶y_´Ùo
 =ğ1 && (»¶y)->
icmp_ty³
 =ğ14))

	)

68 
	#SCAMPER_PING_METHOD_IS_ICMP
(
pšg
) (\

69 ((
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_ICMP_ECHO
) || \

70 (
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_ICMP_TIME
)

	)

72 
	#SCAMPER_PING_METHOD_IS_TCP
(
pšg
) ( \

73 ((
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK
 || \

74 (
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK_SPORT
))

	)

76 
	#SCAMPER_PING_METHOD_IS_UDP
(
pšg
) ( \

77 ((
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP
 || \

78 (
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP_DPORT
))

	)

80 
	#SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
) (\

81 ((
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_ICMP_TIME
))

	)

83 
	#SCAMPER_PING_METHOD_IS_ICMP_ECHO
(
pšg
) (\

84 ((
pšg
)->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_ICMP_ECHO
))

	)

86 
	#SCAMPER_PING_REPLY_FROM_TARGET
(
pšg
, 
»¶y
) ( \

87 (
	`SCAMPER_PING_METHOD_IS_ICMP_ECHO
(
pšg
) && \

88 
	`SCAMPER_PING_REPLY_IS_ICMP_ECHO_REPLY
(
»¶y
)) || \

89 (
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
) && \

90 
	`SCAMPER_PING_REPLY_IS_ICMP_TSREPLY
(
»¶y
)) || \

91 (
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
) && \

92 
	`SCAMPER_PING_REPLY_IS_TCP
(
»¶y
)) || \

93 (
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
) && \

94 
	`SCAMPER_PING_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
)))

	)

96 
	#SCAMPER_PING_STOP_NONE
 0x00

	)

97 
	#SCAMPER_PING_STOP_COMPLETED
 0x01

	)

98 
	#SCAMPER_PING_STOP_ERROR
 0x02

	)

99 
	#SCAMPER_PING_STOP_HALTED
 0x03

	)

101 
	#SCAMPER_PING_REPLY_FLAG_REPLY_TTL
 0x01

	)

102 
	#SCAMPER_PING_REPLY_FLAG_REPLY_IPID
 0x02

	)

103 
	#SCAMPER_PING_REPLY_FLAG_PROBE_IPID
 0x04

	)

105 
	#SCAMPER_PING_METHOD_ICMP_ECHO
 0x00

	)

106 
	#SCAMPER_PING_METHOD_TCP_ACK
 0x01

	)

107 
	#SCAMPER_PING_METHOD_TCP_ACK_SPORT
 0x02

	)

108 
	#SCAMPER_PING_METHOD_UDP
 0x03

	)

109 
	#SCAMPER_PING_METHOD_UDP_DPORT
 0x04

	)

110 
	#SCAMPER_PING_METHOD_ICMP_TIME
 0x05

	)

112 
	#SCAMPER_PING_FLAG_V4RR
 0x01

	)

113 
	#SCAMPER_PING_FLAG_SPOOF
 0x02

	)

114 
	#SCAMPER_PING_FLAG_PAYLOAD
 0x04

	)

115 
	#SCAMPER_PING_FLAG_TSONLY
 0x08

	)

116 
	#SCAMPER_PING_FLAG_TSANDADDR
 0x10

	)

117 
	#SCAMPER_PING_FLAG_ICMPSUM
 0x20

	)

118 
	#SCAMPER_PING_FLAG_DL
 0x40

	)

126 
	ssÿm³r_pšg_»¶y_v4¼


128 
sÿm³r_addr_t
 **
	m¼
;

129 
ušt8_t
 
	m¼c
;

130 } 
	tsÿm³r_pšg_»¶y_v4¼_t
;

141 
	ssÿm³r_pšg_»¶y_v4ts


143 
sÿm³r_addr_t
 **
	ms
;

144 
ušt32_t
 *
	mtss
;

145 
ušt8_t
 
	mtsc
;

146 } 
	tsÿm³r_pšg_»¶y_v4ts_t
;

154 
	ssÿm³r_pšg_»¶y_t¤•ly


156 
ušt32_t
 
	mtso
;

157 
ušt32_t
 
	mt¤
;

158 
ušt32_t
 
	mt¡
;

159 } 
	tsÿm³r_pšg_»¶y_t¤•ly_t
;

167 
	ssÿm³r_pšg_v4ts


169 
sÿm³r_addr_t
 **
	ms
;

170 
ušt8_t
 
	mc
;

171 } 
	tsÿm³r_pšg_v4ts_t
;

183 
	ssÿm³r_pšg_»¶y


186 
sÿm³r_addr_t
 *
	maddr
;

189 
ušt16_t
 
	m´obe_id
;

190 
ušt16_t
 
	m´obe_id
;

191 
ušt8_t
 
	m»¶y_´Ùo
;

192 
ušt8_t
 
	m»¶y_‰l
;

193 
ušt16_t
 
	m»¶y_size
;

194 
ušt16_t
 
	m»¶y_id
;

195 
ušt32_t
 
	m»¶y_id32
;

198 
ušt8_t
 
	mæags
;

201 
ušt8_t
 
	micmp_ty³
;

202 
ušt8_t
 
	micmp_code
;

205 
ušt8_t
 
	mtı_æags
;

208 
timev®
 
	mtx
;

209 
timev®
 
	m¹t
;

212 
sÿm³r_pšg_»¶y_v4¼_t
 *
	mv4¼
;

213 
sÿm³r_pšg_»¶y_v4ts_t
 *
	mv4ts
;

214 
sÿm³r_pšg_»¶y_t¤•ly_t
 *
	mt¤•ly
;

217 
sÿm³r_pšg_»¶y
 *
	mÃxt
;

219 } 
	tsÿm³r_pšg_»¶y_t
;

228 
	ssÿm³r_pšg


231 
sÿm³r_li¡_t
 *
	mli¡
;

232 
sÿm³r_cyşe_t
 *
	mcyşe
;

233 
ušt32_t
 
	mu£rid
;

236 
sÿm³r_addr_t
 *
	m¤c
;

237 
sÿm³r_addr_t
 *
	md¡
;

240 
timev®
 
	m¡¬t
;

243 
ušt8_t
 
	m¡İ_»asÚ
;

244 
ušt8_t
 
	m¡İ_d©a
;

247 
ušt8_t
 *
	m´obe_d©a
;

248 
ušt16_t
 
	m´obe_d©®’
;

251 
ušt16_t
 
	m´obe_couÁ
;

252 
ušt16_t
 
	m´obe_size
;

253 
ušt8_t
 
	m´obe_m‘hod
;

254 
ušt8_t
 
	m´obe_wa™
;

255 
ušt8_t
 
	m´obe_‰l
;

256 
ušt8_t
 
	m´obe_tos
;

257 
ušt8_t
 
	m´obe_timeout
;

258 
ušt16_t
 
	m´obe_¥Üt
;

259 
ušt16_t
 
	m´obe_dpÜt
;

260 
ušt16_t
 
	m´obe_icmpsum
;

261 
ušt16_t
 
	m»¶y_couÁ
;

262 
ušt16_t
 
	m»¶y_pmtu
;

263 
sÿm³r_pšg_v4ts_t
 *
	m´obe_t¥s
;

264 
ušt8_t
 
	mæags
;

267 
sÿm³r_pšg_»¶y_t
 **
	mpšg_»¶›s
;

268 
ušt16_t
 
	mpšg_£Á
;

269 } 
	tsÿm³r_pšg_t
;

272 
sÿm³r_pšg_t
 *
sÿm³r_pšg_®loc
();

273 
sÿm³r_pšg_ä“
(
sÿm³r_pšg_t
 *
pšg
);

274 
sÿm³r_addr_t
 *
sÿm³r_pšg_addr
(cÚ¡ *
va
);

275 
sÿm³r_pšg_£td©a
(
sÿm³r_pšg_t
 *
pšg
, 
ušt8_t
 *
by‹s
, 
ušt16_t
 
Ën
);

278 
sÿm³r_pšg_»¶›s_®loc
(
sÿm³r_pšg_t
 *
pšg
, 
couÁ
);

281 
sÿm³r_pšg_»¶y_t
 *
sÿm³r_pšg_»¶y_®loc
();

282 
sÿm³r_pšg_»¶y_ä“
(
sÿm³r_pšg_»¶y_t
 *
»¶y
);

283 
sÿm³r_pšg_»¶y_­³nd
(
sÿm³r_pšg_t
 *
p
, 
sÿm³r_pšg_»¶y_t
 *
»¶y
);

284 
ušt32_t
 
sÿm³r_pšg_»¶y_couÁ
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
);

286 
sÿm³r_pšg_»¶y_t¤•ly_t
 *
sÿm³r_pšg_»¶y_t¤•ly_®loc
();

287 
sÿm³r_pšg_»¶y_t¤•ly_ä“
(
sÿm³r_pšg_»¶y_t¤•ly_t
 *
t¤
);

289 
sÿm³r_pšg_»¶y_v4¼_t
 *
sÿm³r_pšg_»¶y_v4¼_®loc
(
ušt8_t
 
¼c
);

290 
sÿm³r_pšg_»¶y_v4¼_ä“
(
sÿm³r_pšg_»¶y_v4¼_t
 *
¼
);

292 
sÿm³r_pšg_»¶y_v4ts_t
 *
sÿm³r_pšg_»¶y_v4ts_®loc
(
ušt8_t
 
tsc
, 

);

293 
sÿm³r_pšg_»¶y_v4ts_ä“
(
sÿm³r_pšg_»¶y_v4ts_t
 *
ts
);

295 
sÿm³r_pšg_v4ts_t
 *
sÿm³r_pšg_v4ts_®loc
(
ušt8_t
 
c
);

296 
sÿm³r_pšg_v4ts_ä“
(
sÿm³r_pšg_v4ts_t
 *
ts
);

298 
	ssÿm³r_pšg_¡©s


300 
ušt32_t
 
	mÄ•l›s
;

301 
ušt32_t
 
	mndups
;

302 
ušt16_t
 
	mÆoss
;

303 
timev®
 
	mmš_¹t
;

304 
timev®
 
	mmax_¹t
;

305 
timev®
 
	mavg_¹t
;

306 
timev®
 
	m¡ddev_¹t
;

307 } 
	tsÿm³r_pšg_¡©s_t
;

310 
sÿm³r_pšg_¡©s
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,
sÿm³r_pšg_¡©s_t
 *
¡©s
);

312 *
sÿm³r_pšg_m‘hod2¡r
(cÚ¡ 
sÿm³r_pšg_t
 *, *, 
size_t
);

	@ping/scamper_ping_do.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_li¡.h
"

39 
	~"sÿm³r_pšg.h
"

40 
	~"sÿm³r_g‘¤c.h
"

41 
	~"sÿm³r_icmp_»¥.h
"

42 
	~"sÿm³r_fds.h
"

43 
	~"sÿm³r_¹sock.h
"

44 
	~"sÿm³r_sk.h
"

45 
	~"sÿm³r_dl.h
"

46 
	~"sÿm³r_dlhdr.h
"

47 
	~"sÿm³r_´obe.h
"

48 
	~"sÿm³r_queue.h
"

49 
	~"sÿm³r_fe.h
"

50 
	~"sÿm³r_debug.h
"

51 
	~"sÿm³r_pšg_do.h
"

52 
	~"sÿm³r_İtiÚs.h
"

53 
	~"sÿm³r_icmp4.h
"

54 
	~"sÿm³r_icmp6.h
"

55 
	~"uts.h
"

57 
	#SCAMPER_DO_PING_PROBECOUNT_MIN
 1

	)

58 
	#SCAMPER_DO_PING_PROBECOUNT_DEF
 4

	)

59 
	#SCAMPER_DO_PING_PROBECOUNT_MAX
 65535

	)

61 
	#SCAMPER_DO_PING_PROBEWAIT_MIN
 1

	)

62 
	#SCAMPER_DO_PING_PROBEWAIT_DEF
 1

	)

63 
	#SCAMPER_DO_PING_PROBEWAIT_MAX
 20

	)

65 
	#SCAMPER_DO_PING_PROBETTL_MIN
 1

	)

66 
	#SCAMPER_DO_PING_PROBETTL_DEF
 64

	)

67 
	#SCAMPER_DO_PING_PROBETTL_MAX
 255

	)

69 
	#SCAMPER_DO_PING_PROBETOS_MIN
 0

	)

70 
	#SCAMPER_DO_PING_PROBETOS_DEF
 0

	)

71 
	#SCAMPER_DO_PING_PROBETOS_MAX
 255

	)

73 
	#SCAMPER_DO_PING_PROBEMETHOD_MIN
 0

	)

74 
	#SCAMPER_DO_PING_PROBEMETHOD_DEF
 0

	)

75 
	#SCAMPER_DO_PING_PROBEMETHOD_MAX
 4

	)

77 
	#SCAMPER_DO_PING_PROBEDPORT_MIN
 0

	)

78 
	#SCAMPER_DO_PING_PROBEDPORT_MAX
 65535

	)

80 
	#SCAMPER_DO_PING_PROBESPORT_MIN
 0

	)

81 
	#SCAMPER_DO_PING_PROBESPORT_MAX
 65535

	)

83 
	#SCAMPER_DO_PING_REPLYCOUNT_MIN
 0

	)

84 
	#SCAMPER_DO_PING_REPLYCOUNT_DEF
 0

	)

85 
	#SCAMPER_DO_PING_REPLYCOUNT_MAX
 65535

	)

87 
	#SCAMPER_DO_PING_REPLYPMTU_MIN
 0

	)

88 
	#SCAMPER_DO_PING_REPLYPMTU_DEF
 0

	)

89 
	#SCAMPER_DO_PING_REPLYPMTU_MAX
 65535

	)

91 
	#SCAMPER_DO_PING_PATTERN_MIN
 1

	)

92 
	#SCAMPER_DO_PING_PATTERN_DEF
 0

	)

93 
	#SCAMPER_DO_PING_PATTERN_MAX
 32

	)

95 
	#SCAMPER_DO_PING_PROBETIMEOUT_MIN
 1

	)

96 
	#SCAMPER_DO_PING_PROBETIMEOUT_MAX
 255

	)

99 
sÿm³r_sk_funcs_t
 
	gpšg_funcs
;

102 #iâdeà
_WIN32


103 
pid_t
 
	gpid
;

105 
DWORD
 
	gpid
;

109 
sÿm³r_addrÿche_t
 *
addrÿche
;

111 
	spšg_´obe


113 
timev®
 
	mtx
;

114 
ušt16_t
 
	mid
;

115 } 
	tpšg_´obe_t
;

117 
	spšg_¡©e


119 
pšg_´obe_t
 **
	m´obes
;

120 
ušt16_t
 
	m»¶›s
;

121 
ušt16_t
 
	m£q
;

122 
ušt8_t
 *
	m·ylßd
;

123 
ušt16_t
 
	m·ylßd_Ën
;

124 
š_addr
 
	mt¥s_s
[4];

125 
ušt8_t
 
	mt¥s_c
;

126 
ušt32_t
 
	mtı_£q
;

127 
ušt32_t
 
	mtı_ack
;

128 
ušt8_t
 
	mmode
;

129 
ušt8_t
 *
	mquÙe
;

130 
ušt16_t
 
	mquÙe_Ën
;

131 } 
	tpšg_¡©e_t
;

133 
	#PING_OPT_PAYLOAD
 1

	)

134 
	#PING_OPT_PROBECOUNT
 2

	)

135 
	#PING_OPT_PROBEICMPSUM
 3

	)

136 
	#PING_OPT_PROBESPORT
 4

	)

137 
	#PING_OPT_PROBEDPORT
 5

	)

138 
	#PING_OPT_PROBEWAIT
 6

	)

139 
	#PING_OPT_PROBETTL
 7

	)

140 
	#PING_OPT_REPLYCOUNT
 8

	)

141 
	#PING_OPT_OPTION
 9

	)

142 
	#PING_OPT_PATTERN
 10

	)

143 
	#PING_OPT_PROBEMETHOD
 11

	)

144 
	#PING_OPT_RECORDROUTE
 12

	)

145 
	#PING_OPT_USERID
 13

	)

146 
	#PING_OPT_PROBESIZE
 14

	)

147 
	#PING_OPT_SRCADDR
 15

	)

148 
	#PING_OPT_TIMESTAMP
 16

	)

149 
	#PING_OPT_PROBETOS
 17

	)

150 
	#PING_OPT_REPLYPMTU
 18

	)

151 
	#PING_OPT_PROBETIMEOUT
 19

	)

153 
	#PING_MODE_PROBE
 0

	)

154 
	#PING_MODE_PTB
 1

	)

156 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

157 {'B', 
NULL
, 
PING_OPT_PAYLOAD
, 
SCAMPER_OPTION_TYPE_STR
},

158 {'c', 
NULL
, 
PING_OPT_PROBECOUNT
, 
SCAMPER_OPTION_TYPE_NUM
},

159 {'C', 
NULL
, 
PING_OPT_PROBEICMPSUM
, 
SCAMPER_OPTION_TYPE_STR
},

160 {'d', 
NULL
, 
PING_OPT_PROBEDPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

161 {'F', 
NULL
, 
PING_OPT_PROBESPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

162 {'i', 
NULL
, 
PING_OPT_PROBEWAIT
, 
SCAMPER_OPTION_TYPE_NUM
},

163 {'m', 
NULL
, 
PING_OPT_PROBETTL
, 
SCAMPER_OPTION_TYPE_NUM
},

164 {'M', 
NULL
, 
PING_OPT_REPLYPMTU
, 
SCAMPER_OPTION_TYPE_NUM
},

165 {'o', 
NULL
, 
PING_OPT_REPLYCOUNT
, 
SCAMPER_OPTION_TYPE_NUM
},

166 {'O', 
NULL
, 
PING_OPT_OPTION
, 
SCAMPER_OPTION_TYPE_STR
},

167 {'p', 
NULL
, 
PING_OPT_PATTERN
, 
SCAMPER_OPTION_TYPE_STR
},

168 {'P', 
NULL
, 
PING_OPT_PROBEMETHOD
, 
SCAMPER_OPTION_TYPE_STR
},

169 {'R', 
NULL
, 
PING_OPT_RECORDROUTE
, 
SCAMPER_OPTION_TYPE_NULL
},

170 {'U', 
NULL
, 
PING_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

171 {'s', 
NULL
, 
PING_OPT_PROBESIZE
, 
SCAMPER_OPTION_TYPE_NUM
},

172 {'S', 
NULL
, 
PING_OPT_SRCADDR
, 
SCAMPER_OPTION_TYPE_STR
},

173 {'T', 
NULL
, 
PING_OPT_TIMESTAMP
, 
SCAMPER_OPTION_TYPE_STR
},

174 {'W', 
NULL
, 
PING_OPT_PROBETIMEOUT
, 
SCAMPER_OPTION_TYPE_NUM
},

175 {'z', 
NULL
, 
PING_OPT_PROBETOS
, 
SCAMPER_OPTION_TYPE_NUM
},

178 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

180 cÚ¡ *
	$sÿm³r_do_pšg_u§ge
()

187 
	}
}

189 
sÿm³r_pšg_t
 *
	$pšg_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

191  
	`sÿm³r_sk_g‘d©a
(
sk
);

192 
	}
}

194 
pšg_¡©e_t
 *
	$pšg_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

196  
	`sÿm³r_sk_g‘¡©e
(
sk
);

197 
	}
}

199 
	$pšg_¡İ
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
»asÚ
, ušt8_ˆ
d©a
)

201 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

202 
pšg
->
¡İ_»asÚ
 = 
»asÚ
;

203 
pšg
->
¡İ_d©a
 = 
d©a
;

204 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

206 
	}
}

208 
	$pšg_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

210 
	`pšg_¡İ
(
sk
, 
SCAMPER_PING_STOP_ERROR
, 
”rÜ
);

212 
	}
}

214 
ušt16_t
 
	$m©ch_id
(
sÿm³r_sk_t
 *
sk
, 
ušt16_t
 
id
)

216 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

217 
pšg_¡©e_t
 *
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

218 
ušt16_t
 
£q
;

220 
	`as£¹
(
¡©e
->
£q
 > 0);

222 
£q
 = 
¡©e
->£q-1; s‹->
´obes
[£q]->
id
 != ipid; seq--)

224 if(
£q
 =ğ0 || 
pšg
->
pšg_£Á
 - 5 == seq)

226 
£q
 = 
¡©e
->seq - 1;

231  
£q
;

232 
	}
}

234 
	$do_pšg_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

236 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

237 
pšg_¡©e_t
 *
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

238 
sÿm³r_pšg_»¶y_t
 *
»¶y
 = 
NULL
;

239 
pšg_´obe_t
 *
´obe
;

240 
ušt16_t
 
u16
;

241 
£q
 = -1;

243 if(
¡©e
->
£q
 == 0)

246 if(
dl
->
dl__off
 != 0)

249 if(
	`SCAMPER_DL_IS_ICMP
(
dl
))

251 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
) == 0 ||

252 (
pšg
->
»¶y_pmtu
 =ğ0 && (pšg->
æags
 & 
SCAMPER_PING_FLAG_DL
) == 0))

255 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
) ||

256 
	`SCAMPER_DL_IS_ICMP_TIME_REPLY
(
dl
))

258 if(
dl
->
dl_icmp_id
 !ğ
pšg
->
´obe_¥Üt
)

260 
£q
 = 
dl
->
dl_icmp_£q
;

266 if(
pšg
->
»¶y_pmtu
 !ğ0 &&…šg->»¶y_pmtu < 
dl
->
dl__size
 &&

267 
¡©e
->
quÙe
 =ğ
NULL
)

269 if(
dl
->
dl_af
 =ğ
AF_INET
)

270 
u16
 = 
dl
->
dl__hl
 + 8;

271 if(
dl
->
dl__size
 >= 1280-40-8)

272 
u16
 = 1280 - 40 - 8;

274 
u16
 = 
dl
->
dl__size
;

276 if((
¡©e
->
quÙe
 = 
	`memdup
(
dl
->
dl_Ãt_¿w
, 
u16
)è!ğ
NULL
)

278 
¡©e
->
quÙe_Ën
 = 
u16
;

279 
¡©e
->
mode
 = 
PING_MODE_PTB
;

280 
	`sÿm³r_sk_queue_´obe
(
sk
);

284 if(
	`SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO_REQ
(
dl
) ||

285 
	`SCAMPER_DL_IS_ICMP_Q_ICMP_TIME_REQ
(
dl
))

287 if(
dl
->
dl_icmp_icmp_id
 !ğ
pšg
->
´obe_¥Üt
)

289 
£q
 = 
dl
->
dl_icmp_icmp_£q
;

292 if(
£q
 < 
pšg
->
´obe_dpÜt
)

293 
£q
 = seq + 0x10000;

294 
£q
 = seq - 
pšg
->
´obe_dpÜt
;

296 if(
	`SCAMPER_DL_IS_TCP
(
dl
))

298 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
) == 0 ||

299 
dl
->
dl_tı_¥Üt
 !ğ
pšg
->
´obe_dpÜt
)

302 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK
)

305 if(
dl
->
dl_tı_dpÜt
 !ğ
pšg
->
´obe_¥Üt
)

313 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

314 
£q
 = 
	`m©ch_id
(
sk
, 
dl
->
dl__id
);

316 
£q
 = 
¡©e
->seq - 1;

318 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK_SPORT
)

320 
£q
 = 
dl
->
dl_tı_dpÜt
;

321 if(
dl
->
dl_tı_dpÜt
 < 
pšg
->
´obe_¥Üt
)

322 
£q
 = seq + 0x10000;

323 
£q
 = seq - 
pšg
->
´obe_¥Üt
;

327 if(
£q
 < 0 || seq >ğ
¡©e
->seq)

331 
´obe
 = 
¡©e
->
´obes
[
£q
];

332 
	`as£¹
(
´obe
 !ğ
NULL
);

335 if((
»¶y
 = 
	`sÿm³r_pšg_»¶y_®loc
()è=ğ
NULL
)

337 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…ing„eply");

338 
”r
;

342 if((
»¶y
->
addr
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
pšg
->
d¡
->
ty³
,

343 
dl
->
dl__¤c
)è=ğ
NULL
)

345 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„eply‡ddr");

346 
”r
;

350 
	`timev®_ıy
(&
»¶y
->
tx
, &
´obe
->tx);

351 
	`timev®_diff_tv
(&
»¶y
->
¹t
, &
´obe
->
tx
, &
dl
->
dl_tv
);

352 
»¶y
->
»¶y_size
 = 
dl
->
dl__size
;

353 
»¶y
->
»¶y_´Ùo
 = 
dl
->
dl__´Ùo
;

354 
»¶y
->
´obe_id
 = 
£q
;

355 
»¶y
->
»¶y_‰l
 = 
dl
->
dl__‰l
;

356 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_REPLY_TTL
;

358 if(
	`SCAMPER_DL_IS_TCP
(
dl
))

360 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

361 
»¶y
->
tı_æags
 = 
dl
->
dl_tı_æags
;

365 
	`sÿm³r_dl_»c_icmp_´št
(
dl
);

366 
»¶y
->
icmp_ty³
 = 
dl
->
dl_icmp_ty³
;

367 
»¶y
->
icmp_code
 = 
dl
->
dl_icmp_code
;

370 if(
dl
->
dl_af
 =ğ
AF_INET
)

372 
»¶y
->
»¶y_id
 = 
dl
->
dl__id
;

373 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_REPLY_IPID
;

374 
»¶y
->
´obe_id
 = 
´obe
->
id
;

375 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_PROBE_IPID
;

377 if(
dl
->
dl_af
 =ğ
AF_INET6
 && 
	`SCAMPER_DL_IS_IP_FRAG
(dl))

379 
»¶y
->
»¶y_id32
 = 
dl
->
dl_6_id
;

380 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_REPLY_IPID
;

387 if(
pšg
->
pšg_»¶›s
[
£q
] =ğ
NULL
)

388 
¡©e
->
»¶›s
++;

391 
	`sÿm³r_pšg_»¶y_­³nd
(
pšg
, 
»¶y
);

397 if(
pšg
->
»¶y_couÁ
 !ğ0 && 
¡©e
->
»¶›s
 >=…ing->reply_count)

398 
	`pšg_¡İ
(
sk
, 
SCAMPER_PING_STOP_COMPLETED
, 0);

402 
”r
:

403 
	`pšg_hªdË”rÜ
(
sk
, 
”ºo
);

405 
	}
}

407 
	$do_pšg_hªdË_icmp
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
)

409 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

410 
pšg_¡©e_t
 *
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

411 
sÿm³r_pšg_»¶y_t
 *
»¶y
 = 
NULL
;

412 
pšg_´obe_t
 *
´obe
;

413 
£q
;

414 
sÿm³r_addr_t
 
addr
;

415 
ušt8_t
 
i
, 
¼c
 = 0, 
tsc
 = 0;

416 
š_addr
 *
¼s
 = 
NULL
, *
tss
 = NULL;

417 
ušt32_t
 *
t¡ss
 = 
NULL
;

418 
sÿm³r_pšg_»¶y_v4¼_t
 *
v4¼
;

419 
sÿm³r_pšg_»¶y_v4ts_t
 *
v4ts
;

422 if(
¡©e
->
£q
 == 0)

425 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_DL
) != 0)

428 
	`sÿm³r_icmp_»¥_´št
(
œ
);

431 if(
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
è|| 
	`SCAMPER_ICMP_RESP_IS_TIME_REPLY
(ir))

434 if(((
	`SCAMPER_PING_METHOD_IS_ICMP_ECHO
(
pšg
) &&

435 
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
)) ||

436 (
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
) &&

437 
	`SCAMPER_ICMP_RESP_IS_TIME_REPLY
(
œ
))) == 0)

439 if(
œ
->
œ_icmp_id
 !ğ
pšg
->
´obe_¥Üt
)

442 
£q
 = 
œ
->
œ_icmp_£q
;

443 if(
£q
 < 
pšg
->
´obe_dpÜt
)

444 
£q
 = seq + 0x10000;

445 
£q
 = seq - 
pšg
->
´obe_dpÜt
;

447 if(
œ
->
œ_af
 =ğ
AF_INET
)

449 if(
œ
->
œ_İt_¼c
 > 0)

451 
¼c
 = 
œ
->
œ_İt_¼c
;

452 
¼s
 = 
œ
->
œ_İt_¼s
;

454 if(
œ
->
œ_İt_tsc
 > 0)

456 
tsc
 = 
œ
->
œ_İt_tsc
;

457 
t¡ss
 = 
œ
->
œ_İt_t¡ss
;

458 
tss
 = 
œ
->
œ_İt_tss
;

462 if(
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
))

464 if(
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) == 0 &&

465 
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) == 0 &&

466 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
) == 0)

471 if(
œ
->
œ_šÃr__off
 != 0)

474 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

476 if(
œ
->
œ_šÃr_icmp_id
 !ğ
pšg
->
´obe_¥Üt
)

479 if((
	`SCAMPER_PING_METHOD_IS_ICMP_ECHO
(
pšg
) &&

480 
	`SCAMPER_ICMP_RESP_INNER_IS_ICMP_ECHO_REQ
(
œ
) == 0) ||

481 (
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
) &&

482 
	`SCAMPER_ICMP_RESP_INNER_IS_ICMP_TIME_REQ
(
œ
) == 0))

485 
£q
 = 
œ
->
œ_šÃr_icmp_£q
;

486 if(
£q
 < 
pšg
->
´obe_dpÜt
)

487 
£q
 = seq + 0x10000;

488 
£q
 = seq - 
pšg
->
´obe_dpÜt
;

490 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
))

492 if(
	`SCAMPER_ICMP_RESP_INNER_IS_TCP
(
œ
) == 0 ||

493 
œ
->
œ_šÃr_tı_dpÜt
 !ğ
pšg
->
´obe_dpÜt
)

496 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK
)

498 if(
œ
->
œ_šÃr_tı_¥Üt
 !ğ
pšg
->
´obe_¥Üt
)

500 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

501 
£q
 = 
	`m©ch_id
(
sk
, 
œ
->
œ_šÃr__id
);

503 
£q
 = 
¡©e
->seq - 1;

507 if(
œ
->
œ_šÃr_tı_¥Üt
 > 
pšg
->
´obe_¥Üt
 + 
¡©e
->
£q
 ||

508 
œ
->
œ_šÃr_tı_¥Üt
 < 
pšg
->
´obe_¥Üt
)

510 
£q
 = 
œ
->
œ_šÃr_tı_¥Üt
 - 
pšg
->
´obe_¥Üt
;

513 if(
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
))

515 if(
	`SCAMPER_ICMP_RESP_INNER_IS_UDP
(
œ
) == 0 ||

516 
œ
->
œ_šÃr_udp_¥Üt
 !ğ
pšg
->
´obe_¥Üt
)

521 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP
)

523 if(
œ
->
œ_šÃr_udp_dpÜt
 !ğ
pšg
->
´obe_dpÜt
)

525 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

526 
£q
 = 
	`m©ch_id
(
sk
, 
œ
->
œ_šÃr__id
);

528 
£q
 = 
¡©e
->seq - 1;

530 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP_DPORT
)

532 if(
œ
->
œ_šÃr_udp_dpÜt
 > 
pšg
->
´obe_dpÜt
 + 
¡©e
->
£q
 ||

533 
œ
->
œ_šÃr_udp_dpÜt
 < 
pšg
->
´obe_dpÜt
)

535 
£q
 = 
œ
->
œ_šÃr_udp_dpÜt
 - 
pšg
->
´obe_dpÜt
;

547 if(
œ
->
œ_af
 =ğ
AF_INET
)

549 if(
œ
->
œ_šÃr_İt_¼c
 > 0)

551 
¼c
 = 
œ
->
œ_šÃr_İt_¼c
;

552 
¼s
 = 
œ
->
œ_šÃr_İt_¼s
;

554 if(
œ
->
œ_šÃr_İt_tsc
 > 0)

556 
tsc
 = 
œ
->
œ_šÃr_İt_tsc
;

557 
t¡ss
 = 
œ
->
œ_šÃr_İt_t¡ss
;

558 
tss
 = 
œ
->
œ_šÃr_İt_tss
;

564 if(
£q
 >ğ
¡©e
->seq)

567 
´obe
 = 
¡©e
->
´obes
[
£q
];

568 
	`as£¹
(
´obe
 !ğ
NULL
);

571 if((
»¶y
 = 
	`sÿm³r_pšg_»¶y_®loc
()è=ğ
NULL
)

573 
”r
;

577 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
addr
) != 0)

578 
”r
;

579 
»¶y
->
addr
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
,‡ddr.
ty³
,‡ddr.addr);

580 if(
»¶y
->
addr
 =ğ
NULL
)

581 
”r
;

584 
	`timev®_ıy
(&
»¶y
->
tx
, &
´obe
->tx);

585 
	`timev®_diff_tv
(&
»¶y
->
¹t
, &
´obe
->
tx
, &
œ
->
œ_rx
);

586 
»¶y
->
»¶y_size
 = 
œ
->
œ__size
;

587 
»¶y
->
´obe_id
 = 
£q
;

588 
»¶y
->
icmp_ty³
 = 
œ
->
œ_icmp_ty³
;

589 
»¶y
->
icmp_code
 = 
œ
->
œ_icmp_code
;

591 if(
	`SCAMPER_ICMP_RESP_IS_TIME_REPLY
(
œ
))

593 if((
»¶y
->
t¤•ly
 = 
	`sÿm³r_pšg_»¶y_t¤•ly_®loc
()è=ğ
NULL
)

594 
”r
;

595 
»¶y
->
t¤•ly
->
tso
 = 
œ
->
œ_icmp_tso
;

596 
»¶y
->
t¤•ly
->
t¤
 = 
œ
->
œ_icmp_t¤
;

597 
»¶y
->
t¤•ly
->
t¡
 = 
œ
->
œ_icmp_t¡
;

600 if(
œ
->
œ_af
 =ğ
AF_INET
)

602 
»¶y
->
»¶y_id
 = 
œ
->
œ__id
;

603 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_REPLY_IPID
;

605 
»¶y
->
´obe_id
 = 
´obe
->
id
;

606 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_PROBE_IPID
;

608 
»¶y
->
»¶y_´Ùo
 = 
IPPROTO_ICMP
;

610 if(
¼s
 !ğ
NULL
 && 
¼c
 > 0)

612 if((
v4¼
 = 
	`sÿm³r_pšg_»¶y_v4¼_®loc
(
¼c
)è=ğ
NULL
)

613 
”r
;

614 
»¶y
->
v4¼
 = v4rr;

616 
i
=0; i<
¼c
; i++)

618 
v4¼
->
¼
[
i
] = 
	`sÿm³r_addrÿche_g‘_v4
(
addrÿche
, &
¼s
[i]);

619 if(
v4¼
->
¼
[
i
] =ğ
NULL
)

620 
”r
;

624 if((
œ
->
œ_æags
 & 
SCAMPER_ICMP_RESP_FLAG_IPOPT_TS
) ||

625 (
œ
->
œ_æags
 & 
SCAMPER_ICMP_RESP_FLAG_INNER_IPOPT_TS
))

627 
v4ts
 = 
	`sÿm³r_pšg_»¶y_v4ts_®loc
(
tsc
, 
tss
 !ğ
NULL
 ? 1 : 0);

628 if(
v4ts
 =ğ
NULL
)

629 
”r
;

630 
»¶y
->
v4ts
 = v4ts;

632 if(
tsc
 > 0 && 
t¡ss
 !ğ
NULL
)

634 
v4ts
->
tsc
 =sc;

635 
i
=0; i<
tsc
; i++)

637 if(
tss
 !ğ
NULL
)

639 
v4ts
->
s
[
i
]=
	`sÿm³r_addrÿche_g‘_v4
(
addrÿche
,&
tss
[i]);

640 if(
v4ts
->
s
[
i
] =ğ
NULL
)

641 
”r
;

643 
v4ts
->
tss
[
i
] = 
t¡ss
[i];

648 if(
œ
->
œ_af
 =ğ
AF_INET6
)

650 
»¶y
->
»¶y_´Ùo
 = 
IPPROTO_ICMPV6
;

653 if(
œ
->
œ__‰l
 != -1)

655 
»¶y
->
»¶y_‰l
 = (
ušt8_t
)
œ
->
œ__‰l
;

656 
»¶y
->
æags
 |ğ
SCAMPER_PING_REPLY_FLAG_REPLY_TTL
;

663 if(
pšg
->
pšg_»¶›s
[
£q
] =ğ
NULL
)

664 
¡©e
->
»¶›s
++;

667 
	`sÿm³r_pšg_»¶y_­³nd
(
pšg
, 
»¶y
);

673 if(
pšg
->
»¶y_couÁ
 !ğ0 && 
¡©e
->
»¶›s
 >=…ing->reply_count)

674 
	`pšg_¡İ
(
sk
, 
SCAMPER_PING_STOP_COMPLETED
, 0);

678 
”r
:

679 if(
»¶y
 !ğ
NULL
è
	`sÿm³r_pšg_»¶y_ä“
(reply);

680 
	`pšg_hªdË”rÜ
(
sk
, 
”ºo
);

682 
	}
}

691 
	$do_pšg_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

693 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

694 
pšg_¡©e_t
 *
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

696 if(
¡©e
->
£q
 =ğ
pšg
->
´obe_couÁ
)

697 
	`pšg_¡İ
(
sk
, 
SCAMPER_PING_STOP_COMPLETED
, 0);

700 
	}
}

702 
	$pšg_¡©e_·ylßd
(
sÿm³r_pšg_t
 *
pšg
, 
pšg_¡©e_t
 *
¡©e
)

704 
sÿm³r_addr_t
 *
¤c
;

705 
off
 = 0, 
®
, 
hdr
;

708 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

710 
®
 = 4;

711 
hdr
 = 20;

712 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_V4RR
) != 0)

713 
hdr
 += 40;

714 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_TSONLY
) != 0)

715 
hdr
 += 40;

716 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_TSANDADDR
) != 0)

717 
hdr
 += 36;

718 if(
¡©e
->
t¥s_c
 > 0)

719 
hdr
 +ğ(
¡©e
->
t¥s_c
 * 4 * 2) + 4;

721 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

723 
®
 = 16;

724 
hdr
 = 40;

731 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

733 
¡©e
->
·ylßd_Ën
 = 
pšg
->
´obe_size
 - 
hdr
 - 8;

734 if(
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
))

735 
¡©e
->
·ylßd_Ën
 -= 12;

737 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
))

738 
¡©e
->
·ylßd_Ën
 = 
pšg
->
´obe_size
 - 
hdr
 - 20;

739 if(
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
))

740 
¡©e
->
·ylßd_Ën
 = 
pšg
->
´obe_size
 - 
hdr
 - 8;

744 if(
¡©e
->
·ylßd_Ën
 == 0)

747 if((
¡©e
->
·ylßd
 = 
	`m®loc
(¡©e->
·ylßd_Ën
)è=ğ
NULL
)

750 if(
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
))

752 
	`as£¹
(
¡©e
->
·ylßd_Ën
 > 12);

753 
	`mem£t
(
¡©e
->
·ylßd
, 0, 12);

754 
off
 += 12;

757 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_SPOOF
) != 0)

760 
	`as£¹
(
¡©e
->
·ylßd_Ën
 >ğ
®
);

761 if((
¤c
 = 
	`sÿm³r_g‘¤c
(
pšg
->
d¡
, 0)è=ğ
NULL
)

763 
	`memıy
(
¡©e
->
·ylßd
+
off
, 
¤c
->
addr
, 
®
);

764 
off
 +ğ
®
;

765 
	`sÿm³r_addr_ä“
(
¤c
);

769 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
) != 0)

771 
	`as£¹
(
¡©e
->
·ylßd_Ën
 >ğ
off
 + 2);

772 
¡©e
->
·ylßd
[
off
++] = 0;

773 
¡©e
->
·ylßd
[
off
++] = 0;

776 if(
pšg
->
´obe_d©a
 !ğ
NULL
)

778 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_PAYLOAD
) != 0)

780 
	`as£¹
(
¡©e
->
·ylßd_Ën
 >ğ
off
 + 
pšg
->
´obe_d©®’
);

781 
	`memıy
(
¡©e
->
·ylßd
+
off
, 
pšg
->
´obe_d©a
,…šg->
´obe_d©®’
);

782 
off
 +ğ
pšg
->
´obe_d©®’
;

786 (
size_t
)(
off
 + 
pšg
->
´obe_d©®’
è< 
¡©e
->
·ylßd_Ën
)

788 
	`memıy
(
¡©e
->
·ylßd
+
off
,
pšg
->
´obe_d©a
,pšg->
´obe_d©®’
);

789 
off
 +ğ
pšg
->
´obe_d©®’
;

791 
	`memıy
(
¡©e
->
·ylßd
+
off
,
pšg
->
´obe_d©a
,¡©e->
·ylßd_Ën
-off);

792 
off
 = 
¡©e
->
·ylßd_Ën
;

796 if(
¡©e
->
·ylßd_Ën
 > 
off
)

797 
	`mem£t
(
¡©e
->
·ylßd
+
off
, 0, s‹->
·ylßd_Ën
-off);

800 
	}
}

802 
	$pšg_¡©e_ä“
(
pšg_¡©e_t
 *
¡©e
)

804 
i
;

806 if(
¡©e
->
´obes
 !ğ
NULL
)

808 
i
=0; i<
¡©e
->
£q
; i++)

809 if(
¡©e
->
´obes
[
i
] !ğ
NULL
)

810 
	`ä“
(
¡©e
->
´obes
[
i
]);

811 
	`ä“
(
¡©e
->
´obes
);

814 if(
¡©e
->
·ylßd
 !ğ
NULL
)

815 
	`ä“
(
¡©e
->
·ylßd
);

817 
	`ä“
(
¡©e
);

819 
	}
}

821 
	$pšg_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

823 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

824 
pšg_¡©e_t
 *
¡©e
 = 
NULL
;

825 
size_t
 
size
;

826 
i
;

828 if(
	`sÿm³r_pšg_»¶›s_®loc
(
pšg
,…šg->
´obe_couÁ
) != 0)

830 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc„eplies");

831 
”r
;

834 if((
¡©e
 = 
	`m®loc_z”o
((
pšg_¡©e_t
))è=ğ
NULL
)

836 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

837 
”r
;

839 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

841 
size
 = 
pšg
->
´obe_couÁ
 * (
pšg_´obe_t
 *);

842 if((
¡©e
->
´obes
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

844 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state->probes");

845 
”r
;

849 if(
	`pšg_¡©e_·ylßd
(
pšg
, 
¡©e
) != 0)

850 
”r
;

852 if(
pšg
->
´obe_t¥s
 !ğ
NULL
)

853 
i
=0; i<
pšg
->
´obe_t¥s
->
c
; i++)

854 
	`memıy
(&
¡©e
->
t¥s_s
[
i
], 
pšg
->
´obe_t¥s
->
s
[i]->
addr
, 4);

856 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
))

858 if(
	`¿ndom_u32
(&
¡©e
->
tı_£q
è!ğ0 ||„ªdom_u32(&¡©e->
tı_ack
) != 0)

864 
”r
:

866 
	}
}

874 
	$do_pšg_´obe
(
sÿm³r_sk_t
 *
sk
)

876 
sÿm³r_´obe_İt_t
 
İt
;

877 
timev®
 
wa™_tv
;

878 
sÿm³r_pšg_t
 *
pšg
 = 
	`pšg_g‘d©a
(
sk
);

879 
pšg_¡©e_t
 *
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

880 
pšg_´obe_t
 *
µ
 = 
NULL
;

881 
sÿm³r_´obe_t
 
´obe
;

882 
i
;

883 
ušt16_t
 
id
 = 0;

884 
ušt16_t
 
u16
;

885 
timev®
 
tv
;

887 if(
¡©e
 =ğ
NULL
)

889 if(
	`pšg_¡©e_®loc
(
sk
) != 0)

890 
”r
;

891 
¡©e
 = 
	`pšg_g‘¡©e
(
sk
);

894 
	`g‘timeofday_w¿p
(&
pšg
->
¡¬t
);

897 
	`mem£t
(&
´obe
, 0, (probe));

898 
´obe
.
´__¤c
 = 
pšg
->
¤c
;

899 
´obe
.
´__d¡
 = 
pšg
->
d¡
;

901 if(
pšg
->
æags
 & 
SCAMPER_PING_FLAG_DL
)

902 
´obe
.
´_æags
 |ğ
SCAMPER_PROBE_FLAG_DL
;

904 if(
¡©e
->
mode
 =ğ
PING_MODE_PROBE
)

906 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

909 
i
=0; i<3; i++)

911 if(
	`¿ndom_u16
(&
id
) != 0)

913 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„and ipid");

914 
”r
;

916 if(
id
 != 0)

921 
´obe
.
´_æags
 |ğ
SCAMPER_PROBE_FLAG_IPID
;

922 
´obe
.
´__tos
 = 
pšg
->
´obe_tos
;

923 
´obe
.
´__‰l
 = 
pšg
->
´obe_‰l
;

924 
´obe
.
´__id
 = 
id
;

925 
´obe
.
´_d©a
 = 
¡©e
->
·ylßd
;

926 
´obe
.
´_Ën
 = 
¡©e
->
·ylßd_Ën
;

928 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

929 
´obe
.
´__off
 = 
IP_DF
;

931 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_SPOOF
) != 0)

932 
´obe
.
´_æags
 |ğ
SCAMPER_PROBE_FLAG_SPOOF
;

934 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_V4RR
) != 0)

936 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4RR
;

937 
´obe
.
´_İts
 = &
İt
;

938 
´obe
.
´_İtc
 = 1;

940 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_TSONLY
) != 0)

942 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4TSO
;

943 
´obe
.
´_İts
 = &
İt
;

944 
´obe
.
´_İtc
 = 1;

946 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_TSANDADDR
) != 0)

948 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4TSAA
;

949 
´obe
.
´_İts
 = &
İt
;

950 
´obe
.
´_İtc
 = 1;

952 if(
pšg
->
´obe_t¥s
 !ğ
NULL
)

954 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4TSPS
;

955 
İt
.
İt_v4t¥s_c
 = 
pšg
->
´obe_t¥s
->
c
;

956 
	`memıy
(&
İt
.
İt_v4t¥s_s
, &
¡©e
->
t¥s_s
,

957 (
İt
.
İt_v4t¥s_s
));

958 
´obe
.
´_İts
 = &
İt
;

959 
´obe
.
´_İtc
 = 1;

962 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

964 
i
 = 0;

965 if(
	`SCAMPER_PING_METHOD_IS_ICMP_ECHO
(
pšg
))

967 
	`SCAMPER_PROBE_ICMP_ECHO
(&
´obe
, 
pšg
->
´obe_¥Üt
,

968 
pšg
->
´obe_dpÜt
 + 
¡©e
->
£q
);

970 if(
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
))

972 
	`SCAMPER_PROBE_ICMP_TIME
(&
´obe
, 
pšg
->
´obe_¥Üt
,

973 
pšg
->
´obe_dpÜt
 + 
¡©e
->
£q
);

974 
	`g‘timeofday_w¿p
(&
tv
);

975 
	`by‹s_htÚl
(
¡©e
->
·ylßd
,

976 ((
tv
.
tv_£c
 % 86400è* 1000è+ (tv.
tv_u£c
 / 1000));

977 
i
 += 12;

980 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
) != 0)

982 
´obe
.
´_icmp_sum
 = 
u16
 = 
	`htÚs
(
pšg
->
´obe_icmpsum
);

983 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_SPOOF
) != 0)

984 
i
 += 4;

985 
	`memıy
(
¡©e
->
·ylßd
+
i
, &
u16
, 2);

986 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
pšg
->
d¡
))

987 
u16
 = 
	`sÿm³r_icmp4_cksum
(&
´obe
);

989 
u16
 = 
	`sÿm³r_icmp6_cksum
(&
´obe
);

990 
	`memıy
(
¡©e
->
·ylßd
+
i
, &
u16
, 2);

993 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
))

995 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

996 
´obe
.
´_tı_dpÜt
 = 
pšg
->
´obe_dpÜt
;

997 
´obe
.
´_tı_æags
 = 
TH_ACK
;

999 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK
)

1001 
´obe
.
´_tı_¥Üt
 = 
pšg
->
´obe_¥Üt
;

1002 
´obe
.
´_tı_£q
 = 
¡©e
->
tı_£q
;

1003 
´obe
.
´_tı_ack
 = 
¡©e
->
tı_ack
;

1005 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_TCP_ACK_SPORT
)

1007 
´obe
.
´_tı_¥Üt
 = 
pšg
->
´obe_¥Üt
 + 
¡©e
->
£q
;

1008 if(
	`¿ndom_u32
(&
´obe
.
´_tı_£q
) != 0 ||

1009 
	`¿ndom_u32
(&
´obe
.
´_tı_ack
) != 0)

1010 
”r
;

1013 if(
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
))

1015 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

1016 
´obe
.
´_udp_¥Üt
 = 
pšg
->
´obe_¥Üt
;

1018 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP
)

1019 
´obe
.
´_udp_dpÜt
 = 
pšg
->
´obe_dpÜt
;

1020 if(
pšg
->
´obe_m‘hod
 =ğ
SCAMPER_PING_METHOD_UDP_DPORT
)

1021 
´obe
.
´_udp_dpÜt
 = 
pšg
->
´obe_dpÜt
 + 
¡©e
->
£q
;

1025 
	`sÿm³r_debug
(
__func__
,"unknowÀpšg m‘hod %d", 
pšg
->
´obe_m‘hod
);

1026 
”r
;

1034 if((
µ
 = 
	`m®loc
((
pšg_´obe_t
))è=ğ
NULL
)

1035 
”r
;

1037 if(
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0)

1039 
”ºo
 = 
´obe
.
´_”ºo
;

1040 
”r
;

1044 
	`timev®_ıy
(&
µ
->
tx
, &
´obe
.
´_tx
);

1045 
µ
->
id
 = ipid;

1046 
¡©e
->
´obes
[¡©e->
£q
] = 
µ
;

1047 
¡©e
->
£q
++;

1048 
pšg
->
pšg_£Á
++;

1050 if(
pšg
->
pšg_£Á
 <…šg->
´obe_couÁ
)

1051 
	`timev®_add_s
(&
wa™_tv
, &
´obe
.
´_tx
, 
pšg
->
´obe_wa™
);

1053 
	`timev®_add_s
(&
wa™_tv
, &
´obe
.
´_tx
, 
pšg
->
´obe_timeout
);

1055 if(
¡©e
->
mode
 =ğ
PING_MODE_PTB
)

1057 
	`SCAMPER_PROBE_ICMP_PTB
(&
´obe
, 
pšg
->
»¶y_pmtu
);

1058 
´obe
.
´__‰l
 = 255;

1059 
´obe
.
´_d©a
 = 
¡©e
->
quÙe
;

1060 
´obe
.
´_Ën
 = 
¡©e
->
quÙe_Ën
;

1062 if(
	`sÿm³r_´obe_sk
(&
´obe
, 
sk
) != 0)

1064 
”ºo
 = 
´obe
.
´_”ºo
;

1065 
”r
;

1069 
	`ä“
(
¡©e
->
quÙe
); s‹->quÙğ
NULL
;

1070 
¡©e
->
quÙe_Ën
 = 0;

1071 
¡©e
->
mode
 = 
PING_MODE_PROBE
;

1075 
	`sÿm³r_debug
(
__func__
, "unknowÀpšg mod%d", 
¡©e
->
mode
);

1076 
”r
;

1079 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
wa™_tv
);

1082 
”r
:

1083 if(
µ
 !ğ
NULL
è
	`ä“
(pp);

1084 
	`pšg_hªdË”rÜ
(
sk
, 
”ºo
);

1086 
	}
}

1088 
	$do_pšg_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

1090 
	`sÿm³r_fe_wr™e_pšg
(
sf
, 
	`pšg_g‘d©a
(
sk
));

1092 
	}
}

1094 
	$pšg_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

1096 
tmp
 = 0;

1097 
i
;

1099 
İtid
)

1101 
PING_OPT_PAYLOAD
:

1102 
i
=0; 
·¿m
[i] != '\0'; i++)

1103 if(
	`ishex
(
·¿m
[
i
]) == 0)

1104 
”r
;

1105 if(
i
 == 0 || (i % 2) != 0)

1106 
”r
;

1107 
tmp
 = 
i
 / 2;

1108 if(
tmp
 > 1000)

1109 
”r
;

1112 
PING_OPT_PROBECOUNT
:

1113 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1114 
tmp
 < 
SCAMPER_DO_PING_PROBECOUNT_MIN
 ||

1115 
tmp
 > 
SCAMPER_DO_PING_PROBECOUNT_MAX
)

1117 
”r
;

1121 
PING_OPT_PROBEICMPSUM
:

1122 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||mp < 0 ||mp > 65535)

1123 
”r
;

1126 
PING_OPT_PROBEDPORT
:

1127 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1128 
tmp
 < 
SCAMPER_DO_PING_PROBEDPORT_MIN
 ||

1129 
tmp
 > 
SCAMPER_DO_PING_PROBEDPORT_MAX
)

1131 
”r
;

1135 
PING_OPT_PROBESPORT
:

1136 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1137 
tmp
 < 
SCAMPER_DO_PING_PROBESPORT_MIN
 ||

1138 
tmp
 > 
SCAMPER_DO_PING_PROBESPORT_MAX
)

1140 
”r
;

1144 
PING_OPT_PROBEMETHOD
:

1145 if(
	`¡rÿ£cmp
(
·¿m
, "icmp-echo") == 0)

1146 
tmp
 = 
SCAMPER_PING_METHOD_ICMP_ECHO
;

1147 if(
	`¡rÿ£cmp
(
·¿m
, "tcp-ack") == 0)

1148 
tmp
 = 
SCAMPER_PING_METHOD_TCP_ACK
;

1149 if(
	`¡rÿ£cmp
(
·¿m
, "tcp-ack-sport") == 0)

1150 
tmp
 = 
SCAMPER_PING_METHOD_TCP_ACK_SPORT
;

1151 if(
	`¡rÿ£cmp
(
·¿m
, "udp") == 0)

1152 
tmp
 = 
SCAMPER_PING_METHOD_UDP
;

1153 if(
	`¡rÿ£cmp
(
·¿m
, "udp-dport") == 0)

1154 
tmp
 = 
SCAMPER_PING_METHOD_UDP_DPORT
;

1155 if(
	`¡rÿ£cmp
(
·¿m
, "icmp-time") == 0)

1156 
tmp
 = 
SCAMPER_PING_METHOD_ICMP_TIME
;

1158 
”r
;

1162 
PING_OPT_PROBEWAIT
:

1163 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1164 
tmp
 < 
SCAMPER_DO_PING_PROBEWAIT_MIN
 ||

1165 
tmp
 > 
SCAMPER_DO_PING_PROBEWAIT_MAX
)

1167 
”r
;

1172 
PING_OPT_PROBETTL
:

1173 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1174 
tmp
 < 
SCAMPER_DO_PING_PROBETTL_MIN
 ||

1175 
tmp
 > 
SCAMPER_DO_PING_PROBETTL_MAX
)

1177 
”r
;

1182 
PING_OPT_REPLYCOUNT
:

1183 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1184 
tmp
 < 
SCAMPER_DO_PING_REPLYCOUNT_MIN
 ||

1185 
tmp
 > 
SCAMPER_DO_PING_REPLYCOUNT_MAX
)

1187 
”r
;

1191 
PING_OPT_REPLYPMTU
:

1192 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

1193 
tmp
 < 
SCAMPER_DO_PING_REPLYPMTU_MIN
 ||

1194 
tmp
 > 
SCAMPER_DO_PING_REPLYPMTU_MAX
)

1196 
”r
;

1200 
PING_OPT_OPTION
:

1201 if(
	`¡rÿ£cmp
(
·¿m
, "spoof") != 0 && strcasecmp(param, "dl") != 0)

1202 
”r
;

1205 
PING_OPT_PATTERN
:

1210 
i
=0; i<
SCAMPER_DO_PING_PATTERN_MAX
; i++)

1212 if(
·¿m
[
i
] == '\0') ;

1213 if(
	`ishex
(
·¿m
[
i
]è=ğ0è
”r
;

1215 if(
i
 =ğ
SCAMPER_DO_PING_PATTERN_MAX
è
”r
;

1219 
PING_OPT_PROBESIZE
:

1220 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||mp < 0 ||mp > 65535)

1222 
”r
;

1226 
PING_OPT_USERID
:

1227 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

1228 
”r
;

1231 
PING_OPT_SRCADDR
:

1232 
PING_OPT_TIMESTAMP
:

1236 
PING_OPT_PROBETOS
:

1237 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

1238 
tmp
 < 
SCAMPER_DO_PING_PROBETOS_MIN
 ||

1239 
tmp
 > 
SCAMPER_DO_PING_PROBETOS_MAX
)

1241 
”r
;

1245 
PING_OPT_PROBETIMEOUT
:

1246 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

1247 
tmp
 < 
SCAMPER_DO_PING_PROBETIMEOUT_MIN
 ||

1248 
tmp
 > 
SCAMPER_DO_PING_PROBETIMEOUT_MAX
)

1249 
”r
;

1257 if(
out
 !ğ
NULL
)

1258 *
out
 = 
tmp
;

1261 
”r
:

1263 
	}
}

1270 
	$sÿm³r_do_pšg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

1272  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

1273 
pšg_¬g_·¿m_v®id©e
);

1274 
	}
}

1276 
	$pšg_tsİt
(
sÿm³r_pšg_t
 *
pšg
, 
ušt8_t
 *
æags
, *
tsİt
)

1278 
sÿm³r_pšg_v4ts_t
 *
ts
 = 
NULL
;

1279 *
s
[4], *
±r
 = 
tsİt
;

1280 
i
 = 0;

1282 *
±r
 != '=' && *ptr != '\0')

1283 
±r
++;

1285 if(
	`¡ºÿ£cmp
(
tsİt
, "t¥»¥ec", 9è=ğ0 && *
±r
 == '=')

1287 
±r
++;

1290 if(
i
 == 4)

1293 
s
[
i
++] = 
±r
;

1295 
	`isdig™
(()*
±r
) || *ptr == '.')

1296 
±r
++;

1298 if(*
±r
 == '\0')

1300 if(*
±r
 != ',')

1303 *
±r
 = '\0';

1304 
±r
++;

1307 if((
ts
 = 
	`sÿm³r_pšg_v4ts_®loc
(
i
)è=ğ
NULL
)

1310 
i
--;

1311 
i
>=0)

1313 
ts
->
s
[
i
] = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
AF_INET
, ips[i]);

1314 if(
ts
->
s
[
i
] =ğ
NULL
)

1316 
	`sÿm³r_pšg_v4ts_ä“
(
ts
);

1319 
i
--;

1322 
pšg
->
´obe_t¥s
 = 
ts
;

1324 if(*
±r
 =ğ'\0' && 
	`¡rÿ£cmp
(
tsİt
, "tsonly") == 0)

1326 *
æags
 |ğ
SCAMPER_PING_FLAG_TSONLY
;

1328 if(*
±r
 =ğ'\0' && 
	`¡rÿ£cmp
(
tsİt
, "tsandaddr") == 0)

1330 *
æags
 |ğ
SCAMPER_PING_FLAG_TSANDADDR
;

1338 
	}
}

1347 *
	$sÿm³r_do_pšg_®loc
(*
¡r
)

1349 
ušt16_t
 
´obe_couÁ
 = 
SCAMPER_DO_PING_PROBECOUNT_DEF
;

1350 
ušt8_t
 
´obe_wa™
 = 
SCAMPER_DO_PING_PROBEWAIT_DEF
;

1351 
ušt8_t
 
´obe_‰l
 = 
SCAMPER_DO_PING_PROBETTL_DEF
;

1352 
ušt8_t
 
´obe_tos
 = 
SCAMPER_DO_PING_PROBETOS_DEF
;

1353 
ušt8_t
 
´obe_m‘hod
 = 
SCAMPER_DO_PING_PROBEMETHOD_DEF
;

1354 
´obe_timeout
 = -1;

1355 
´obe_¥Üt
 = -1;

1356 
´obe_dpÜt
 = -1;

1357 
ušt16_t
 
»¶y_couÁ
 = 
SCAMPER_DO_PING_REPLYCOUNT_DEF
;

1358 
ušt16_t
 
»¶y_pmtu
 = 
SCAMPER_DO_PING_REPLYPMTU_DEF
;

1359 
ušt16_t
 
´obe_size
 = 0;

1360 
ušt16_t
 
·‰”n_Ën
 = 0;

1361 
ušt16_t
 
´obe_icmpsum
 = 0;

1362 
ušt8_t
 
·‰”n
[
SCAMPER_DO_PING_PATTERN_MAX
/2];

1363 
ušt16_t
 
·ylßd_Ën
 = 0;

1364 
ušt8_t
 *
·ylßd
 = 
NULL
;

1365 
ušt32_t
 
u£rid
 = 0;

1366 
ušt8_t
 
æags
 = 0;

1367 *
¤c
 = 
NULL
;

1368 *
tsİt
 = 
NULL
;

1369 
af
;

1371 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

1372 
sÿm³r_pšg_t
 *
pšg
 = 
NULL
;

1373 
ušt16_t
 
cmps
 = 0;

1374 *
addr
;

1375 
size_t
 
size
;

1376 
tmp
 = 0;

1377 
i
;

1380 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

1382 
”r
;

1386 if(
addr
 =ğ
NULL
)

1388 
”r
;

1392 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

1394 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

1395 
	`pšg_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

1397 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

1398 
”r
;

1401 
İt
->
id
)

1403 
PING_OPT_PAYLOAD
:

1404 
·ylßd_Ën
 = (
ušt16_t
)
tmp
;

1405 if(
·ylßd_Ën
 =ğ0 || (
·ylßd
 = 
	`m®loc
Õaylßd_Ën)è=ğ
NULL
)

1406 
”r
;

1407 
i
=0; i<
·ylßd_Ën
; i++)

1408 
·ylßd
[
i
] = 
	`hex2by‹
(
İt
->
¡r
[i*2], opt->str[(i*2)+1]);

1409 
æags
 |ğ
SCAMPER_PING_FLAG_PAYLOAD
;

1412 
PING_OPT_PROBECOUNT
:

1413 
´obe_couÁ
 = (
ušt16_t
)
tmp
;

1416 
PING_OPT_PROBEDPORT
:

1417 
´obe_dpÜt
 = (
ušt16_t
)
tmp
;

1420 
PING_OPT_PROBESPORT
:

1421 
´obe_¥Üt
 = ()
tmp
;

1424 
PING_OPT_PROBEMETHOD
:

1425 
´obe_m‘hod
 = (
ušt8_t
)
tmp
;

1429 
PING_OPT_PROBEWAIT
:

1430 
´obe_wa™
 = (
ušt8_t
)
tmp
;

1434 
PING_OPT_PROBETTL
:

1435 
´obe_‰l
 = (
ušt8_t
)
tmp
;

1438 
PING_OPT_PROBEICMPSUM
:

1439 
´obe_icmpsum
 = (
ušt16_t
)
tmp
;

1440 
æags
 |ğ
SCAMPER_PING_FLAG_ICMPSUM
;

1444 
PING_OPT_REPLYCOUNT
:

1445 
»¶y_couÁ
 = (
ušt16_t
)
tmp
;

1448 
PING_OPT_REPLYPMTU
:

1449 
»¶y_pmtu
 = (
ušt16_t
)
tmp
;

1450 
æags
 |ğ
SCAMPER_PING_FLAG_DL
;

1453 
PING_OPT_OPTION
:

1454 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "spoof") == 0)

1455 
æags
 |ğ
SCAMPER_PING_FLAG_SPOOF
;

1456 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "dl") == 0)

1457 
æags
 |ğ
SCAMPER_PING_FLAG_DL
;

1460 
	`sÿm³r_debug
(
__func__
, "unknowÀİtiÚ %s", 
İt
->
¡r
);

1461 
”r
;

1466 
PING_OPT_PATTERN
:

1467 
size
 = 
	`¡¾’
(
İt
->
¡r
);

1468 if((
size
 % 2) == 0)

1470 
·‰”n_Ën
 = 
size
/2;

1471 
i
=0; i<
·‰”n_Ën
; i++)

1472 
·‰”n
[
i
] = 
	`hex2by‹
(
İt
->
¡r
[i*2], opt->str[(i*2)+1]);

1476 
·‰”n_Ën
 = (
size
/2) + 1;

1477 
·‰”n
[0] = 
	`hex2by‹
('0', 
İt
->
¡r
[0]);

1478 
i
=1; i<
·‰”n_Ën
; i++)

1479 
·‰”n
[
i
] = 
	`hex2by‹
(
İt
->
¡r
[(i*2)-1], opt->str[i*2]);

1484 
PING_OPT_PROBESIZE
:

1485 
´obe_size
 = (
ušt16_t
)
tmp
;

1488 
PING_OPT_USERID
:

1489 
u£rid
 = (
ušt32_t
)
tmp
;

1492 
PING_OPT_RECORDROUTE
:

1493 
æags
 |ğ
SCAMPER_PING_FLAG_V4RR
;

1496 
PING_OPT_SRCADDR
:

1497 if(
¤c
 !ğ
NULL
)

1498 
”r
;

1499 
¤c
 = 
İt
->
¡r
;

1502 
PING_OPT_TIMESTAMP
:

1503 if(
tsİt
 !ğ
NULL
)

1504 
”r
;

1505 
tsİt
 = 
İt
->
¡r
;

1509 
PING_OPT_PROBETOS
:

1510 
´obe_tos
 = (
ušt8_t
)
tmp
;

1513 
PING_OPT_PROBETIMEOUT
:

1514 
´obe_timeout
 = (
ušt8_t
)
tmp
;

1518 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

1521 if((
pšg
 = 
	`sÿm³r_pšg_®loc
()è=ğ
NULL
)

1523 
”r
;

1525 if((
pšg
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
)è=ğ
NULL
)

1527 
”r
;

1529 
pšg
->
´obe_m‘hod
 =…robe_method;

1532 if(
·‰”n_Ën
 !ğ0 && 
·ylßd_Ën
 != 0)

1533 
”r
;

1539 if(
tsİt
 !ğ
NULL
)

1541 if(
pšg
->
d¡
->
ty³
 !ğ
SCAMPER_ADDR_TYPE_IPV4
)

1542 
”r
;

1544 if((
æags
 & 
SCAMPER_PING_FLAG_V4RR
) != 0)

1545 
”r
;

1547 if(
	`pšg_tsİt
(
pšg
, &
æags
, 
tsİt
) != 0)

1548 
”r
;

1552 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

1554 
cmps
 = 20;

1556 if(
æags
 & 
SCAMPER_PING_FLAG_V4RR
)

1557 
cmps
 += 40;

1558 if(
pšg
->
´obe_t¥s
 !ğ
NULL
)

1559 
cmps
 +ğ(8 * 
pšg
->
´obe_t¥s
->
c
) + 4;

1560 if(
æags
 & 
SCAMPER_PING_FLAG_TSONLY
)

1561 
cmps
 += 40;

1562 if(
æags
 & 
SCAMPER_PING_FLAG_TSANDADDR
)

1563 
cmps
 += 36;

1566 if(
æags
 & 
SCAMPER_PING_FLAG_SPOOF
)

1567 
cmps
 += 4;

1569 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

1571 
cmps
 = 40;

1572 if(
æags
 & 
SCAMPER_PING_FLAG_SPOOF
)

1573 
cmps
 += 16;

1575 
”r
;

1577 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

1579 
cmps
 += 8;

1580 if(
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
)

1581 
cmps
 += 2;

1582 if(
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
))

1583 
cmps
 += 12;

1584 if(
·ylßd_Ën
 != 0)

1585 
cmps
 +ğ
·ylßd_Ën
;

1587 if(
´obe_size
 == 0)

1589 
´obe_size
 = 
cmps
;

1590 if(
·ylßd_Ën
 == 0)

1592 if(
	`SCAMPER_PING_METHOD_IS_ICMP_TIME
(
pšg
))

1593 
´obe_size
 += 44;

1595 
´obe_size
 += 56;

1599 if(
	`SCAMPER_PING_METHOD_IS_TCP
(
pšg
))

1601 
cmps
 += 20;

1603 if(
·ylßd_Ën
 != 0)

1604 
cmps
 +ğ
·ylßd_Ën
;

1606 if(
´obe_size
 == 0)

1607 
´obe_size
 = 
cmps
;

1609 if(
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
))

1611 
cmps
 += 8;

1613 if(
·ylßd_Ën
 != 0)

1614 
cmps
 +ğ
·ylßd_Ën
;

1616 if(
´obe_size
 == 0)

1618 
´obe_size
 = 
cmps
;

1619 if(
·ylßd_Ën
 == 0)

1620 
´obe_size
 += 12;

1623 
”r
;

1625 if(
´obe_size
 < 
cmps
)

1626 
”r
;

1628 if((
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
) != 0 &&

1629 
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
) == 0)

1631 
”r
;

1634 if(
¤c
 !ğ
NULL
)

1636 
af
 = 
	`sÿm³r_addr_af
(
pšg
->
d¡
);

1637 if(
af
 !ğ
AF_INET
 &&‡à!ğ
AF_INET6
)

1638 
”r
;

1640 if((
pšg
->
¤c
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, src)è=ğ
NULL
)

1641 
”r
;

1645 if(
·‰”n_Ën
 != 0)

1647 if(
	`sÿm³r_pšg_£td©a
(
pšg
, 
·‰”n
, 
·‰”n_Ën
) != 0)

1648 
”r
;

1650 if(
·ylßd_Ën
 != 0)

1652 if(
	`sÿm³r_pšg_£td©a
(
pšg
, 
·ylßd
, 
·ylßd_Ën
) != 0)

1653 
”r
;

1656 if(
´obe_¥Üt
 == -1)

1658 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

1659 
´obe_¥Üt
 = 
pid
 & 0xffff;

1661 
´obe_¥Üt
 = (
pid
 & 0xffff) | 0x8000;

1664 if(
´obe_dpÜt
 == -1)

1666 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
))

1667 
´obe_dpÜt
 = 0;

1669 
´obe_dpÜt
 = 33435;

1672 if(
´obe_timeout
 == -1)

1673 
´obe_timeout
 = 
´obe_wa™
;

1675 
pšg
->
´obe_couÁ
 =…robe_count;

1676 
pšg
->
´obe_size
 =…robe_size;

1677 
pšg
->
´obe_wa™
 =…robe_wait;

1678 
pšg
->
´obe_timeout
 =…robe_timeout;

1679 
pšg
->
´obe_‰l
 =…robe_ttl;

1680 
pšg
->
´obe_tos
 =…robe_tos;

1681 
pšg
->
´obe_¥Üt
 =…robe_sport;

1682 
pšg
->
´obe_dpÜt
 =…robe_dport;

1683 
pšg
->
´obe_icmpsum
 =…robe_icmpsum;

1684 
pšg
->
»¶y_couÁ
 =„eply_count;

1685 
pšg
->
»¶y_pmtu
 =„eply_pmtu;

1686 
pšg
->
u£rid
 = userid;

1687 
pšg
->
æags
 = flags;

1689  
pšg
;

1691 
”r
:

1692 if(
pšg
 !ğ
NULL
è
	`sÿm³r_pšg_ä“
(ping);

1693 if(
·ylßd
 !ğ
NULL
è
	`ä“
(payload);

1694 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

1695  
NULL
;

1696 
	}
}

1698 
	$do_pšg_h®t
(
sÿm³r_sk_t
 *
sk
)

1700 
	`pšg_¡İ
(
sk
, 
SCAMPER_PING_STOP_HALTED
, 0);

1702 
	}
}

1704 
	$do_pšg_ä“
(
sÿm³r_sk_t
 *
sk
)

1706 
sÿm³r_pšg_t
 *
pšg
;

1707 
pšg_¡©e_t
 *
¡©e
;

1709 if((
pšg
 = 
	`pšg_g‘d©a
(
sk
)è!ğ
NULL
)

1710 
	`sÿm³r_pšg_ä“
(
pšg
);

1712 if((
¡©e
 = 
	`pšg_g‘¡©e
(
sk
)è!ğ
NULL
)

1713 
	`pšg_¡©e_ä“
(
¡©e
);

1716 
	}
}

1718 
sÿm³r_sk_t
 *
	$sÿm³r_do_pšg_®loùask
(*
d©a
, 
sÿm³r_li¡_t
 *
li¡
,

1719 
sÿm³r_cyşe_t
 *
cyşe
)

1721 
sÿm³r_pšg_t
 *
pšg
 = (sÿm³r_pšg_ˆ*)
d©a
;

1722 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

1723 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

1726 if((
sk
 = 
	`sÿm³r_sk_®loc
(
pšg
, &
pšg_funcs
)è=ğ
NULL
)

1727 
”r
;

1730 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

1731 
”r
;

1732 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
pšg
->
d¡
);

1733 if(
pšg
->
¤c
 =ğ
NULL
 && (pšg->¤øğ
	`sÿm³r_g‘¤c
Õšg->
d¡
, 0)) == NULL)

1734 
”r
;

1735 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_SPOOF
) == 0)

1736 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
pšg
->
¤c
);

1737 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

1738 
”r
;

1739 
sig
 = 
NULL
;

1742 
pšg
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

1743 
pšg
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

1745  
sk
;

1747 
”r
:

1748 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

1749 if(
sk
 !ğ
NULL
)

1751 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

1752 
	`sÿm³r_sk_ä“
(
sk
);

1754  
NULL
;

1755 
	}
}

1757 
	$sÿm³r_do_pšg_ä“
(*
d©a
)

1759 
	`sÿm³r_pšg_ä“
((
sÿm³r_pšg_t
 *)
d©a
);

1761 
	}
}

1763 
	$sÿm³r_do_pšg_ş—nup
()

1766 
	}
}

1768 
	$sÿm³r_do_pšg_š™
()

1770 
pšg_funcs
.
´obe
 = 
do_pšg_´obe
;

1771 
pšg_funcs
.
hªdË_icmp
 = 
do_pšg_hªdË_icmp
;

1772 
pšg_funcs
.
hªdË_timeout
 = 
do_pšg_hªdË_timeout
;

1773 
pšg_funcs
.
hªdË_dl
 = 
do_pšg_hªdË_dl
;

1774 
pšg_funcs
.
wr™e
 = 
do_pšg_wr™e
;

1775 
pšg_funcs
.
sk_ä“
 = 
do_pšg_ä“
;

1776 
pšg_funcs
.
h®t
 = 
do_pšg_h®t
;

1778 #iâdeà
_WIN32


1779 
pid
 = 
	`g‘pid
();

1781 
pid
 = 
	`G‘Cu¼’tProûssId
();

1785 
	}
}

	@ping/scamper_ping_do.h

25 #iâdeà
__SCAMPER_DO_PING_H


26 
	#__SCAMPER_DO_PING_H


	)

28 *
sÿm³r_do_pšg_®loc
(*
¡r
);

30 
sÿm³r_sk_t
 *
sÿm³r_do_pšg_®loùask
(*
d©a
,

31 
sÿm³r_li¡_t
 *
li¡
,

32 
sÿm³r_cyşe_t
 *
cyşe
);

34 
sÿm³r_do_pšg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

36 
sÿm³r_do_pšg_ä“
(*
d©a
);

38 cÚ¡ *
sÿm³r_do_pšg_u§ge
();

40 
sÿm³r_do_pšg_ş—nup
();

41 
sÿm³r_do_pšg_š™
();

	@ping/scamper_ping_json.c

28 #iâdeà
lšt


29 cÚ¡ 
	grcsid
[] =

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

36 
	~"š‹º®.h
"

38 
	~"sÿm³r_addr.h
"

39 
	~"sÿm³r_li¡.h
"

40 
	~"sÿm³r_pšg.h
"

41 
	~"sÿm³r_fe.h
"

42 
	~"sÿm³r_pšg_jsÚ.h
"

44 
	~"uts.h
"

46 *
	$pšg_h—d”
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

48 
buf
[512], 
tmp
[64];

49 
size_t
 
off
 = 0;

50 
ušt8_t
 
u8
;

52 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

54 
	`sÿm³r_pšg_m‘hod2¡r
(
pšg
, 
tmp
, (tmp)));

55 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"src\":\"%s\"",

56 
	`sÿm³r_addr_to¡r
(
pšg
->
¤c
, 
tmp
, (tmp)));

57 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"dst\":\"%s\"",

58 
	`sÿm³r_addr_to¡r
(
pšg
->
d¡
, 
tmp
, (tmp)));

59 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

62 
pšg
->
pšg_£Á
,…šg->
´obe_size
,

63 
pšg
->
u£rid
,…šg->
´obe_wa™
,…šg->
´obe_‰l
);

65 if(
	`SCAMPER_PING_METHOD_IS_UDP
(
pšg
è|| 
	`SCAMPER_PING_METHOD_IS_TCP
(ping))

66 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"sport\":%u, \"dport\":%u",

67 
pšg
->
´obe_¥Üt
,…šg->
´obe_dpÜt
);

69 if(
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
) &&

70 (
pšg
->
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
) != 0)

71 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

72 ", \"icmp_csum\": %u",
pšg
->
´obe_icmpsum
);

74 if(
pšg
->
´obe_t¥s
 !ğ
NULL
)

76 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"probe_tsps\":[");

77 
u8
=0; u8<
pšg
->
´obe_t¥s
->
c
; u8++)

79 if(
u8
 > 0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",");

80 
	`sÿm³r_addr_to¡r
(
pšg
->
´obe_t¥s
->
s
[
u8
], 
tmp
, (tmp));

81 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "\"%s\"", 
tmp
);

83 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "]");

86  
	`¡rdup
(
buf
);

87 
	}
}

89 *
	$pšg_»¶y
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

90 cÚ¡ 
sÿm³r_pšg_»¶y_t
 *
»¶y
)

92 
sÿm³r_pšg_»¶y_v4¼_t
 *
v4¼
;

93 
sÿm³r_pšg_»¶y_v4ts_t
 *
v4ts
;

94 
timev®
 
tv
;

95 
buf
[512], 
tmp
[64];

96 
ušt8_t
 
i
;

97 
size_t
 
off
 = 0;

99 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "{\"from\":\"%s\", \"seq\":%u",

100 
	`sÿm³r_addr_to¡r
(
»¶y
->
addr
, 
tmp
, (tmp)),

101 
»¶y
->
´obe_id
);

102 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,", \"reply_size\":%u, \"reply_ttl\":%u",

103 
»¶y
->
»¶y_size
,„•ly->
»¶y_‰l
);

104 if(
»¶y
->
tx
.
tv_£c
 != 0)

106 
	`timev®_add_tv3
(&
tv
, &
»¶y
->
tx
, &»¶y->
¹t
);

107 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

109 
»¶y
->
tx
.
tv_£c
,„•ly->tx.
tv_u£c
);

110 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

112 
tv
.
tv_£c
,v.
tv_u£c
);

114 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"rtt\":%s",

115 
	`timev®_to¡r
(&
»¶y
->
¹t
, 
tmp
, (tmp)));

117 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
»¶y
->
addr
))

119 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

121 
»¶y
->
´obe_id
,„•ly->
»¶y_id
);

124 if(
	`SCAMPER_PING_REPLY_IS_ICMP
(
»¶y
))

126 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

128 
»¶y
->
icmp_ty³
,„•ly->
icmp_code
);

130 if(
	`SCAMPER_PING_REPLY_IS_TCP
(
»¶y
))

132 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"tcp_flags\":%u",

133 
»¶y
->
tı_æags
);

136 if((
v4¼
 = 
»¶y
->v4¼è!ğ
NULL
)

138 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"RR\":[");

139 
i
=0; i<
v4¼
->
¼c
; i++)

141 if(
i
 > 0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",");

142 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "\"%s\"",

143 
	`sÿm³r_addr_to¡r
(
v4¼
->
¼
[
i
], 
tmp
, (tmp)));

145 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "]");

148 if((
v4ts
 = 
»¶y
->v4tsè!ğ
NULL
)

150 if((
pšg
->
æags
 & 
SCAMPER_PING_FLAG_TSONLY
) == 0)

152 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"tsandaddr\":[");

153 
i
=0; i<
v4ts
->
tsc
; i++)

155 if(
i
 > 0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",");

156 
	`¡ršg_cÚÿt
(
buf
,(buf),&
off
, "{\"ip\":\"%s\",\"ts\":%u}",

157 
	`sÿm³r_addr_to¡r
(
v4ts
->
s
[
i
], 
tmp
, (tmp)),

158 
v4ts
->
tss
[
i
]);

160 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "]");

164 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"tsonly\":[");

165 
i
=0; i<
v4ts
->
tsc
; i++)

167 if(
i
 > 0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",");

168 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%u", 
v4ts
->
tss
[
i
]);

170 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "]");

174 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "}");

176  
	`¡rdup
(
buf
);

177 
	}
}

179 *
	$pšg_¡©s
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

181 
sÿm³r_pšg_¡©s_t
 
¡©s
;

182 
buf
[512], 
¡r
[64];

183 
size_t
 
off
 = 0;

185 if(
	`sÿm³r_pšg_¡©s
(
pšg
, &
¡©s
) != 0)

186  
NULL
;

188 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "\"statistics\":{\"replies\":%d",

189 
¡©s
.
Ä•l›s
);

191 if(
pšg
->
pšg_£Á
 != 0)

193 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"loss\":");

195 if(
¡©s
.
Ä•l›s
 == 0)

196 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "1");

197 if(
¡©s
.
Ä•l›s
 =ğ
pšg
->
pšg_£Á
)

198 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "0");

200 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%.2f",

201 ()(
pšg
->
pšg_£Á
 - 
¡©s
.
Ä•l›s
)

202 / 
pšg
->
pšg_£Á
);

204 if(
¡©s
.
Ä•l›s
 > 0)

206 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"min\":%s",

207 
	`timev®_to¡r
(&
¡©s
.
mš_¹t
, 
¡r
, (str)));

208 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"max\":%s",

209 
	`timev®_to¡r
(&
¡©s
.
max_¹t
, 
¡r
, (str)));

210 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"avg\":%s",

211 
	`timev®_to¡r
(&
¡©s
.
avg_¹t
, 
¡r
, (str)));

212 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"stddev\":%s",

213 
	`timev®_to¡r
(&
¡©s
.
¡ddev_¹t
, 
¡r
, (str)));

215 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "}");

217  
	`¡rdup
(
buf
);

218 
	}
}

220 
	$sÿm³r_fe_jsÚ_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

221 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

223 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

224 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

225 
off_t
 
off
 = 0;

226 
ušt32_t
 
»¶y_couÁ
 = 
	`sÿm³r_pšg_»¶y_couÁ
(
pšg
);

227 *
h—d”
 = 
NULL
;

228 
size_t
 
h—d”_Ën
 = 0;

229 **
»¶›s
 = 
NULL
;

230 
size_t
 *
»¶y_Ëns
 = 
NULL
;

231 *
¡©s
 = 
NULL
;

232 
size_t
 
¡©s_Ën
 = 0;

233 *
¡r
 = 
NULL
;

234 
size_t
 
Ën
 = 0;

235 
size_t
 
wc
 = 0;

236 
»t
 = -1;

237 
ušt32_t
 
i
,
j
;

240 if(
fd
 !ğ1 && (
off
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1)

244 if((
h—d”
 = 
	`pšg_h—d”
(
pšg
)è=ğ
NULL
)

245 
ş—nup
;

246 
Ën
 = (
h—d”_Ën
 = 
	`¡¾’
(
h—d”
));

249 
Ën
 += 15;

250 if(
»¶y_couÁ
 > 0)

252 if((
»¶›s
 = 
	`m®loc_z”o
((*è* 
»¶y_couÁ
)è=ğ
NULL
 ||

253 (
»¶y_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
»¶y_couÁ
)è=ğ
NULL
)

255 
ş—nup
;

258 
i
=0, 
j
=0; i<
pšg
->
pšg_£Á
; i++)

260 
»¶y
 = 
pšg
->
pšg_»¶›s
[
i
];

261 
»¶y
 !ğ
NULL
)

264 if((
»¶›s
[
j
] = 
	`pšg_»¶y
(
pšg
, 
»¶y
)è=ğ
NULL
)

265 
ş—nup
;

266 
Ën
 +ğ(
»¶y_Ëns
[
j
] = 
	`¡¾’
(
»¶›s
[j]));

267 if(
j
 > 0è
Ën
++;

268 
»¶y
 =„•ly->
Ãxt
;

269 
j
++;

273 
Ën
 += 2;

274 if((
¡©s
 = 
	`pšg_¡©s
(
pšg
)è!ğ
NULL
)

275 
Ën
 +ğ(
¡©s_Ën
 = 
	`¡¾’
(
¡©s
));

276 
Ën
 += 2;

278 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

279 
ş—nup
;

280 
	`memıy
(
¡r
+
wc
, 
h—d”
, 
h—d”_Ën
); wc += header_len;

281 
	`memıy
(
¡r
+
wc
, ", \"responses\":[", 15); wc += 15;

282 
i
=0; i<
»¶y_couÁ
; i++)

284 if(
i
 > 0)

286 
	`memıy
(
¡r
+
wc
, ",", 1);

287 
wc
++;

289 
	`memıy
(
¡r
+
wc
, 
»¶›s
[
i
], 
»¶y_Ëns
[i]);

290 
wc
 +ğ
»¶y_Ëns
[
i
];

292 
	`memıy
(
¡r
+
wc
, "],", 2); wc += 2;

293 if(
¡©s
 !ğ
NULL
)

295 
	`memıy
(
¡r
+
wc
, 
¡©s
, 
¡©s_Ën
);

296 
wc
 +ğ
¡©s_Ën
;

298 
	`memıy
(
¡r
+
wc
, "}\n", 2); wc += 2;

304 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
Ën
) != 0)

306 if(
fd
 != 1)

308 if(
	`árunÿ‹
(
fd
, 
off
) != 0)

309 
ş—nup
;

311 
ş—nup
;

313 
»t
 = 0;

315 
ş—nup
:

316 if(
¡r
 !ğ
NULL
è
	`ä“
(str);

317 if(
h—d”
 !ğ
NULL
è
	`ä“
(header);

318 if(
¡©s
 !ğ
NULL
è
	`ä“
(stats);

319 if(
»¶y_Ëns
 !ğ
NULL
è
	`ä“
(reply_lens);

320 if(
»¶›s
 !ğ
NULL
)

322 
i
=0; i<
»¶y_couÁ
; i++)

323 if(
»¶›s
[
i
] !ğ
NULL
)

324 
	`ä“
(
»¶›s
[
i
]);

325 
	`ä“
(
»¶›s
);

328  
»t
;

329 
	}
}

	@ping/scamper_ping_json.h

23 #iâdeà
__SCAMPER_PING_JSON_H


24 
	#__SCAMPER_PING_JSON_H


	)

26 
sÿm³r_fe_jsÚ_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
);

	@ping/scamper_ping_text.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_li¡.h
"

38 
	~"sÿm³r_pšg.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_pšg_‹xt.h
"

42 
	~"uts.h
"

44 *
	$pšg_h—d”
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

46 
h—d”
[192], 
¤c
[64], 
d¡
[64];

48 
	`¢´štf
(
h—d”
, (header), "ping %so %s: %d byte…ackets\n",

49 
	`sÿm³r_addr_to¡r
(
pšg
->
¤c
, src, (src)),

50 
	`sÿm³r_addr_to¡r
(
pšg
->
d¡
, dst, (dst)),

51 
pšg
->
´obe_size
);

53  
	`¡rdup
(
h—d”
);

54 
	}
}

56 *
	$t¤•ly_to¡r
(*
buf
, 
size_t
 
Ën
, 
ušt32_t
 
v®
)

58 
ušt32_t
 
hh
, 
mm
, 
ss
, 
ms
;

59 
ms
 = 
v®
 % 1000;

60 
ss
 = 
v®
 / 1000;

61 
hh
 = 
ss
 / 3600; ss -= (hh * 3600);

62 
mm
 = 
ss
 / 60; ss -= (mm * 60);

63 
	`¢´štf
(
buf
, 
Ën
, "%02d:%02d:%02d.%03d", 
hh
, 
mm
, 
ss
, 
ms
);

64  
buf
;

65 
	}
}

67 *
	$pšg_»¶y
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

68 cÚ¡ 
sÿm³r_pšg_»¶y_t
 *
»¶y
)

70 
sÿm³r_pšg_»¶y_v4¼_t
 *
v4¼
;

71 
sÿm³r_pšg_»¶y_v4ts_t
 *
v4ts
;

72 
buf
[256], 
a
[64], 
¹t
[32], *
tı
, 
æags
[16], 
tso
[16], 
t¤
[16], 
t¡
[16];

73 
ušt8_t
 
i
;

74 
size_t
 
off
 = 0;

76 
	`sÿm³r_addr_to¡r
(
»¶y
->
addr
, 
a
, (a));

77 
	`timev®_to¡r
(&
»¶y
->
¹t
,„tt, (rtt));

79 if(
	`SCAMPER_PING_REPLY_IS_ICMP
(
»¶y
))

81 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

83 
»¶y
->
»¶y_size
, 
a
,„•ly->
´obe_id
,

84 
»¶y
->
»¶y_‰l
, 
¹t
);

85 if(
»¶y
->
t¤•ly
 !ğ
NULL
)

86 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

88 
	`t¤•ly_to¡r
(
tso
,Ñso),
»¶y
->
t¤•ly
->tso),

89 
	`t¤•ly_to¡r
(
t¤
,Ñ¤),
»¶y
->
t¤•ly
->tsr),

90 
	`t¤•ly_to¡r
(
t¡
,Ñ¡),
»¶y
->
t¤•ly
->tst));

91 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "\n");

93 if(
	`SCAMPER_PING_REPLY_IS_TCP
(
»¶y
))

95 if((
»¶y
->
tı_æags
 & 
TH_RST
) != 0)

97 
tı
 = "closed";

99 if((
»¶y
->
tı_æags
 & (
TH_SYN
|
TH_ACK
)) == (TH_SYN|TH_ACK))

101 if((
»¶y
->
tı_æags
 & 
TH_ECE
) != 0)

102 
tı
 = "open,ecn";

104 
tı
 = "open";

108 
	`¢´štf
(
æags
, (æags), "%0x02x", 
»¶y
->
tı_æags
);

109 
tı
 = 
æags
;

112 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

114 
»¶y
->
»¶y_size
, 
a
,„•ly->
´obe_id
, 
tı
,

115 
»¶y
->
»¶y_‰l
, 
¹t
);

119  
NULL
;

122 if((
v4¼
 = 
»¶y
->v4¼è!ğ
NULL
)

124 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " RR: %s\n",

125 
	`sÿm³r_addr_to¡r
(
v4¼
->
¼
[0], 
a
, (a)));

126 
i
=1; i<
v4¼
->
¼c
; i++)

127 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %s\n",

128 
	`sÿm³r_addr_to¡r
(
v4¼
->
¼
[
i
], 
a
, (a)));

131 if((
v4ts
 = 
»¶y
->v4tsè!ğ
NULL
 && v4ts->
tsc
 > 0)

133 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " TS: ");

134 if(
v4ts
->
s
 !ğ
NULL
)

135 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%-15s ",

136 
	`sÿm³r_addr_to¡r
(
v4ts
->
s
[0], 
a
, (a)));

137 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%d\n", 
v4ts
->
tss
[0]);

139 
i
=1; i<
v4ts
->
tsc
; i++)

141 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " ");

142 if(
v4ts
->
s
 !ğ
NULL
)

143 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%-15s ",

144 
	`sÿm³r_addr_to¡r
(
v4ts
->
s
[
i
], 
a
, (a)));

145 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%d\n", 
v4ts
->
tss
[
i
]);

149  
	`¡rdup
(
buf
);

150 
	}
}

152 *
	$pšg_¡©s
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

154 
sÿm³r_pšg_¡©s_t
 
¡©s
;

155 
size_t
 
off
 = 0;

156 
¡r
[64];

157 
buf
[512];

158 
½
 = 0;

160 if(
	`sÿm³r_pšg_¡©s
(
pšg
, &
¡©s
) != 0)

161  
NULL
;

163 if(
pšg
->
pšg_£Á
 != 0)

164 
½
 = ((
pšg
->
pšg_£Á
 - 
¡©s
.
Ä•l›s
) * 100) /…ing->ping_sent;

166 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "--- %s…ing statistics ---\n",

167 
	`sÿm³r_addr_to¡r
(
pšg
->
d¡
, 
¡r
, (str)));

168 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

170 
pšg
->
pšg_£Á
, 
¡©s
.
Ä•l›s
);

171 if(
¡©s
.
ndups
 > 0)

172 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "+%d du¶iÿ‹s, ", 
¡©s
.
ndups
);

173 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%d%%…ack‘†oss\n", 
½
);

174 if(
¡©s
.
Ä•l›s
 > 0)

176 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "round-trip min/avg/max/stddev =");

177 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %s",

178 
	`timev®_to¡r
(&
¡©s
.
mš_¹t
, 
¡r
, (str)));

179 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "/%s",

180 
	`timev®_to¡r
(&
¡©s
.
avg_¹t
, 
¡r
, (str)));

181 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "/%s",

182 
	`timev®_to¡r
(&
¡©s
.
max_¹t
, 
¡r
, (str)));

183 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "/%s ms\n",

184 
	`timev®_to¡r
(&
¡©s
.
¡ddev_¹t
, 
¡r
, (str)));

187  
	`¡rdup
(
buf
);

188 
	}
}

190 
	$sÿm³r_fe_‹xt_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

191 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

193 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

194 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

195 
off_t
 
off
 = 0;

196 
ušt32_t
 
»¶y_couÁ
 = 
	`sÿm³r_pšg_»¶y_couÁ
(
pšg
);

197 *
h—d”
 = 
NULL
;

198 
size_t
 
h—d”_Ën
 = 0;

199 **
»¶›s
 = 
NULL
;

200 
size_t
 *
»¶y_Ëns
 = 
NULL
;

201 *
¡©s
 = 
NULL
;

202 
size_t
 
¡©s_Ën
 = 0;

203 *
¡r
 = 
NULL
;

204 
size_t
 
Ën
 = 0;

205 
size_t
 
wc
 = 0;

206 
»t
 = -1;

207 
ušt32_t
 
i
,
j
;

210 if(
fd
 !ğ1 && (
off
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1)

214 if((
h—d”
 = 
	`pšg_h—d”
(
pšg
)è=ğ
NULL
)

215 
ş—nup
;

216 
Ën
 = (
h—d”_Ën
 = 
	`¡¾’
(
h—d”
));

219 if(
»¶y_couÁ
 > 0)

221 if((
»¶›s
 = 
	`m®loc_z”o
((*è* 
»¶y_couÁ
)è=ğ
NULL
 ||

222 (
»¶y_Ëns
 = 
	`m®loc_z”o
((
size_t
è* 
»¶y_couÁ
)è=ğ
NULL
)

223 
ş—nup
;

225 
i
=0, 
j
=0; i<
pšg
->
pšg_£Á
; i++)

227 
»¶y
 = 
pšg
->
pšg_»¶›s
[
i
];

228 
»¶y
 !ğ
NULL
)

231 if((
»¶›s
[
j
] = 
	`pšg_»¶y
(
pšg
, 
»¶y
)è=ğ
NULL
)

233 
ş—nup
;

235 
Ën
 +ğ(
»¶y_Ëns
[
j
] = 
	`¡¾’
(
»¶›s
[j]));

236 
»¶y
 =„•ly->
Ãxt
;

237 
j
++;

243 
¡©s
 = 
	`pšg_¡©s
(
pšg
);

244 if(
¡©s
 !ğ
NULL
)

245 
Ën
 +ğ(
¡©s_Ën
 = 
	`¡¾’
(
¡©s
));

248 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

249 
ş—nup
;

252 
	`memıy
(
¡r
+
wc
, 
h—d”
, 
h—d”_Ën
); wc += header_len;

253 
i
=0; i<
»¶y_couÁ
; i++)

255 
	`memıy
(
¡r
+
wc
, 
»¶›s
[
i
], 
»¶y_Ëns
[i]);

256 
wc
 +ğ
»¶y_Ëns
[
i
];

259 if(
¡©s
 !ğ
NULL
)

261 
	`memıy
(
¡r
+
wc
, 
¡©s
, 
¡©s_Ën
);

262 
wc
 +ğ
¡©s_Ën
;

269 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
Ën
) != 0)

271 if(
fd
 != 1)

273 if(
	`árunÿ‹
(
fd
, 
off
) != 0)

274 
ş—nup
;

276 
ş—nup
;

279 
»t
 = 0;

281 
ş—nup
:

282 if(
¡r
 !ğ
NULL
è
	`ä“
(str);

283 if(
h—d”
 !ğ
NULL
è
	`ä“
(header);

284 if(
¡©s
 !ğ
NULL
è
	`ä“
(stats);

285 if(
»¶y_Ëns
 !ğ
NULL
è
	`ä“
(reply_lens);

286 if(
»¶›s
 !ğ
NULL
)

288 
i
=0; i<
»¶y_couÁ
; i++)

289 if(
»¶›s
[
i
] !ğ
NULL
)

290 
	`ä“
(
»¶›s
[
i
]);

291 
	`ä“
(
»¶›s
);

294  
»t
;

295 
	}
}

	@ping/scamper_ping_text.h

25 #iâdeà
__SCAMPER_PING_TEXT_H


26 
	#__SCAMPER_PING_TEXT_H


	)

28 
sÿm³r_fe_‹xt_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

29 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
);

	@ping/scamper_ping_warts.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_li¡.h
"

38 
	~"sÿm³r_icm³xt.h
"

39 
	~"sÿm³r_pšg.h
"

40 
	~"sÿm³r_fe.h
"

41 
	~"sÿm³r_fe_w¬ts.h
"

42 
	~"sÿm³r_pšg_w¬ts.h
"

44 
	~"mjl_¥ÏyŒ“.h
"

45 
	~"uts.h
"

50 
	#WARTS_PING_LIST_ID
 1

	)

51 
	#WARTS_PING_CYCLE_ID
 2

	)

52 
	#WARTS_PING_ADDR_SRC_GID
 3

	)

53 
	#WARTS_PING_ADDR_DST_GID
 4

	)

54 
	#WARTS_PING_START
 5

	)

55 
	#WARTS_PING_STOP_R
 6

	)

56 
	#WARTS_PING_STOP_D
 7

	)

57 
	#WARTS_PING_DATA_LEN
 8

	)

58 
	#WARTS_PING_DATA_BYTES
 9

	)

59 
	#WARTS_PING_PROBE_COUNT
 10

	)

60 
	#WARTS_PING_PROBE_SIZE
 11

	)

61 
	#WARTS_PING_PROBE_WAIT
 12

	)

62 
	#WARTS_PING_PROBE_TTL
 13

	)

63 
	#WARTS_PING_REPLY_COUNT
 14

	)

64 
	#WARTS_PING_PING_SENT
 15

	)

65 
	#WARTS_PING_PROBE_METHOD
 16

	)

66 
	#WARTS_PING_PROBE_SPORT
 17

	)

67 
	#WARTS_PING_PROBE_DPORT
 18

	)

68 
	#WARTS_PING_USERID
 19

	)

69 
	#WARTS_PING_ADDR_SRC
 20

	)

70 
	#WARTS_PING_ADDR_DST
 21

	)

71 
	#WARTS_PING_FLAGS
 22

	)

72 
	#WARTS_PING_PROBE_TOS
 23

	)

73 
	#WARTS_PING_PROBE_TSPS
 24

	)

74 
	#WARTS_PING_PROBE_ICMPSUM
 25

	)

75 
	#WARTS_PING_REPLY_PMTU
 26

	)

76 
	#WARTS_PING_PROBE_TIMEOUT
 27

	)

78 cÚ¡ 
w¬ts_v¬_t
 
	gpšg_v¬s
[] =

80 {
WARTS_PING_LIST_ID
, 4, -1},

81 {
WARTS_PING_CYCLE_ID
, 4, -1},

82 {
WARTS_PING_ADDR_SRC_GID
, 4, -1},

83 {
WARTS_PING_ADDR_DST_GID
, 4, -1},

84 {
WARTS_PING_START
, 8, -1},

85 {
WARTS_PING_STOP_R
, 1, -1},

86 {
WARTS_PING_STOP_D
, 1, -1},

87 {
WARTS_PING_DATA_LEN
, 2, -1},

88 {
WARTS_PING_DATA_BYTES
, -1, -1},

89 {
WARTS_PING_PROBE_COUNT
, 2, -1},

90 {
WARTS_PING_PROBE_SIZE
, 2, -1},

91 {
WARTS_PING_PROBE_WAIT
, 1, -1},

92 {
WARTS_PING_PROBE_TTL
, 1, -1},

93 {
WARTS_PING_REPLY_COUNT
, 2, -1},

94 {
WARTS_PING_PING_SENT
, 2, -1},

95 {
WARTS_PING_PROBE_METHOD
, 1, -1},

96 {
WARTS_PING_PROBE_SPORT
, 2, -1},

97 {
WARTS_PING_PROBE_DPORT
, 2, -1},

98 {
WARTS_PING_USERID
, 4, -1},

99 {
WARTS_PING_ADDR_SRC
, -1, -1},

100 {
WARTS_PING_ADDR_DST
, -1, -1},

101 {
WARTS_PING_FLAGS
, 1, -1},

102 {
WARTS_PING_PROBE_TOS
, 1, -1},

103 {
WARTS_PING_PROBE_TSPS
, -1, -1},

104 {
WARTS_PING_PROBE_ICMPSUM
, 2, -1},

105 {
WARTS_PING_REPLY_PMTU
, 2, -1},

106 {
WARTS_PING_PROBE_TIMEOUT
, 1, -1},

108 
	#pšg_v¬s_mfb
 
	`WARTS_VAR_MFB
(
pšg_v¬s
)

	)

110 
	#WARTS_PING_REPLY_ADDR_GID
 1

	)

111 
	#WARTS_PING_REPLY_FLAGS
 2

	)

112 
	#WARTS_PING_REPLY_REPLY_TTL
 3

	)

113 
	#WARTS_PING_REPLY_REPLY_SIZE
 4

	)

114 
	#WARTS_PING_REPLY_ICMP_TC
 5

	)

115 
	#WARTS_PING_REPLY_RTT
 6

	)

116 
	#WARTS_PING_REPLY_PROBE_ID
 7

	)

117 
	#WARTS_PING_REPLY_REPLY_IPID
 8

	)

118 
	#WARTS_PING_REPLY_PROBE_IPID
 9

	)

119 
	#WARTS_PING_REPLY_REPLY_PROTO
 10

	)

120 
	#WARTS_PING_REPLY_TCP_FLAGS
 11

	)

121 
	#WARTS_PING_REPLY_ADDR
 12

	)

122 
	#WARTS_PING_REPLY_V4RR
 13

	)

123 
	#WARTS_PING_REPLY_V4TS
 14

	)

124 
	#WARTS_PING_REPLY_REPLY_IPID32
 15

	)

125 
	#WARTS_PING_REPLY_TX
 16

	)

126 
	#WARTS_PING_REPLY_TSREPLY
 17

	)

128 cÚ¡ 
w¬ts_v¬_t
 
	gpšg_»¶y_v¬s
[] =

130 {
WARTS_PING_REPLY_ADDR_GID
, 4, -1},

131 {
WARTS_PING_REPLY_FLAGS
, 1, -1},

132 {
WARTS_PING_REPLY_REPLY_TTL
, 1, -1},

133 {
WARTS_PING_REPLY_REPLY_SIZE
, 2, -1},

134 {
WARTS_PING_REPLY_ICMP_TC
, 2, -1},

135 {
WARTS_PING_REPLY_RTT
, 4, -1},

136 {
WARTS_PING_REPLY_PROBE_ID
, 2, -1},

137 {
WARTS_PING_REPLY_REPLY_IPID
, 2, -1},

138 {
WARTS_PING_REPLY_PROBE_IPID
, 2, -1},

139 {
WARTS_PING_REPLY_REPLY_PROTO
, 1, -1},

140 {
WARTS_PING_REPLY_TCP_FLAGS
, 1, -1},

141 {
WARTS_PING_REPLY_ADDR
, -1, -1},

142 {
WARTS_PING_REPLY_V4RR
, -1, -1},

143 {
WARTS_PING_REPLY_V4TS
, -1, -1},

144 {
WARTS_PING_REPLY_REPLY_IPID32
, 4, -1},

145 {
WARTS_PING_REPLY_TX
, 8, -1},

146 {
WARTS_PING_REPLY_TSREPLY
, 12, -1},

148 
	#pšg_»¶y_v¬s_mfb
 
	`WARTS_VAR_MFB
(
pšg_»¶y_v¬s
)

	)

150 
	sw¬ts_pšg_»¶y


152 
sÿm³r_pšg_»¶y_t
 *
	m»¶y
;

153 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
pšg_»¶y_v¬s
)];

154 
ušt16_t
 
	mæags_Ën
;

155 
ušt16_t
 
	m·¿ms_Ën
;

156 } 
	tw¬ts_pšg_»¶y_t
;

158 
	$š£¹_pšg_»¶y_v4¼
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

159 cÚ¡ 
ušt32_t
 
Ën
,

160 cÚ¡ 
sÿm³r_pšg_»¶y_v4¼_t
 *
¼
,

161 *
·¿m
)

163 
ušt8_t
 
i
;

165 
	`as£¹
(
Ën
 - *
off
 >= 1);

166 
buf
[(*
off
)++] = 
¼
->
¼c
;

167 
i
=0; i<
¼
->
¼c
; i++)

168 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, 
¼
->¼[
i
], 
·¿m
);

171 
	}
}

173 
	$exŒaù_pšg_»¶y_v4¼
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

174 cÚ¡ 
ušt32_t
 
Ën
,

175 
sÿm³r_pšg_»¶y_v4¼_t
 **
out
,

176 *
·¿m
)

178 
sÿm³r_addr_t
 *
addr
;

179 
ušt8_t
 
i
, 
¼c
;

181 if(
Ën
 - *
off
 < 1)

184 
¼c
 = 
buf
[(*
off
)++];

186 if((*
out
 = 
	`sÿm³r_pšg_»¶y_v4¼_®loc
(
¼c
)è=ğ
NULL
)

189 
i
=0; i<
¼c
; i++)

191 if(
	`exŒaù_addr
(
buf
, 
off
, 
Ën
, &
addr
, 
·¿m
) != 0)

193 (*
out
)->
¼
[
i
] = 
addr
;

197 
	}
}

199 
	$š£¹_pšg_»¶y_v4ts
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

200 cÚ¡ 
ušt32_t
 
Ën
,

201 cÚ¡ 
sÿm³r_pšg_»¶y_v4ts_t
 *
ts
,

202 *
·¿m
)

204 
ušt8_t
 
i
, 
c
;

206 
c
 = (
ts
->
s
 !ğ
NULL
 ?s->
tsc
 : 0);

208 
	`as£¹
(
Ën
 - *
off
 >= 2);

209 
buf
[(*
off
)++] = 
ts
->
tsc
;

210 
buf
[(*
off
)++] = 
c
;

212 
i
=0; i<
ts
->
tsc
; i++)

213 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
ts
->
tss
[
i
], 
NULL
);

215 
i
=0; i<
c
; i++)

216 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, 
ts
->
s
[
i
], 
·¿m
);

219 
	}
}

221 
	$exŒaù_pšg_»¶y_v4ts
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

222 cÚ¡ 
ušt32_t
 
Ën
,

223 
sÿm³r_pšg_»¶y_v4ts_t
 **
out
,

224 *
·¿m
)

226 
sÿm³r_addr_t
 *
addr
;

227 
ušt8_t
 
i
, 
tsc
, 
c
;

228 
ušt32_t
 
u32
;

230 if(
Ën
 - *
off
 < 2)

233 
tsc
 = 
buf
[(*
off
)++];

234 
c
 = 
buf
[(*
off
)++];

236 if((*
out
 = 
	`sÿm³r_pšg_»¶y_v4ts_®loc
(
tsc
, 
c
)è=ğ
NULL
)

239 
i
=0; i<
tsc
; i++)

241 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
u32
, 
NULL
) != 0)

243 (*
out
)->
tss
[
i
] = 
u32
;

246 
i
=0; i<
c
; i++)

248 if(
	`exŒaù_addr
(
buf
, 
off
, 
Ën
, &
addr
, 
·¿m
) != 0)

250 (*
out
)->
s
[
i
] = 
addr
;

254 
	}
}

256 
	$š£¹_pšg_»¶y_t¤•ly
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

257 cÚ¡ 
ušt32_t
 
Ën
,

258 cÚ¡ 
sÿm³r_pšg_»¶y_t¤•ly_t
 *
ts
,

259 *
·¿m
)

261 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
ts
->
tso
, 
NULL
);

262 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
ts
->
t¤
, 
NULL
);

263 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
ts
->
t¡
, 
NULL
);

265 
	}
}

267 
	$exŒaù_pšg_»¶y_t¤•ly
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

268 cÚ¡ 
ušt32_t
 
Ën
,

269 
sÿm³r_pšg_»¶y_t¤•ly_t
 **
out
,

270 *
·¿m
)

272 
sÿm³r_pšg_»¶y_t¤•ly_t
 *
t¤•ly
;

273 if(
Ën
 - *
off
 < 12)

275 if((
t¤•ly
 = 
	`sÿm³r_pšg_»¶y_t¤•ly_®loc
()è=ğ
NULL
)

277 
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t¤•ly
->
tso
, 
NULL
);

278 
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t¤•ly
->
t¤
, 
NULL
);

279 
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t¤•ly
->
t¡
, 
NULL
);

280 *
out
 = 
t¤•ly
;

282 
	}
}

284 
	$w¬ts_pšg_»¶y_·¿ms
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

285 cÚ¡ 
sÿm³r_pšg_»¶y_t
 *
»¶y
,

286 
w¬ts_add¹abË_t
 *
bË
,

287 
ušt8_t
 *
æags
, 
ušt16_t
 *
æags_Ën
,

288 
ušt16_t
 *
·¿ms_Ën
)

290 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

291 
i
, 
j
, 
max_id
 = 0;

294 
	`mem£t
(
æags
, 0, 
pšg_»¶y_v¬s_mfb
);

295 *
·¿ms_Ën
 = 0;

297 
i
=0; i<(
pšg_»¶y_v¬s
)/(
w¬ts_v¬_t
); i++)

299 
v¬
 = &
pšg_»¶y_v¬s
[
i
];

301 if(
v¬
->
id
 =ğ
WARTS_PING_REPLY_ADDR_GID
 ||

302 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_ADDR
 && 
»¶y
->
addr
 =ğ
NULL
) ||

303 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_FLAGS
 && 
»¶y
->
æags
 == 0) ||

304 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_REPLY_PROTO
 &&

305 
	`SCAMPER_PING_METHOD_IS_ICMP
(
pšg
)) ||

306 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_REPLY_TTL
 &&

307 (
»¶y
->
æags
 & 
SCAMPER_PING_REPLY_FLAG_REPLY_TTL
) == 0) ||

308 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_REPLY_IPID
 &&

309 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
pšg
->
d¡
) &&

310 (
»¶y
->
æags
 & 
SCAMPER_PING_REPLY_FLAG_REPLY_IPID
) == 0) ||

311 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_REPLY_IPID32
 &&

312 
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
pšg
->
d¡
) &&

313 (
»¶y
->
æags
 & 
SCAMPER_PING_REPLY_FLAG_REPLY_IPID
) == 0) ||

314 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_PROBE_IPID
 &&

315 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
pšg
->
d¡
) &&

316 (
»¶y
->
æags
 & 
SCAMPER_PING_REPLY_FLAG_PROBE_IPID
) == 0) ||

317 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_ICMP_TC
 &&

318 
	`SCAMPER_PING_REPLY_IS_ICMP
(
»¶y
) == 0) ||

319 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_TCP_FLAGS
 &&

320 
	`SCAMPER_PING_REPLY_IS_TCP
(
»¶y
) == 0) ||

321 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_V4RR
 && 
»¶y
->
v4¼
 =ğ
NULL
) ||

322 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_V4TS
 && 
»¶y
->
v4ts
 =ğ
NULL
) ||

323 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_TX
 && 
»¶y
->
tx
.
tv_£c
 == 0) ||

324 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_TSREPLY
 && 
»¶y
->
t¤•ly
 =ğ
NULL
))

329 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

331 if(
v¬
->
id
 =ğ
WARTS_PING_REPLY_ADDR
)

333 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
addr
);

335 if(
v¬
->
id
 =ğ
WARTS_PING_REPLY_V4RR
)

337 *
·¿ms_Ën
 += 1;

338 
j
=0; j<
»¶y
->
v4¼
->
¼c
; j++)

339 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
v4¼
->
¼
[
j
]);

341 if(
v¬
->
id
 =ğ
WARTS_PING_REPLY_V4TS
)

343 
	`as£¹
(
»¶y
->
v4ts
 !ğ
NULL
);

344 *
·¿ms_Ën
 += 2;

345 *
·¿ms_Ën
 +ğ(
»¶y
->
v4ts
->
tsc
 * 4);

346 if(
»¶y
->
v4ts
->
s
 !ğ
NULL
)

347 
j
=0; j<
»¶y
->
v4ts
->
tsc
; j++)

348 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
v4ts
->
s
[
j
]);

352 
	`as£¹
(
v¬
->
size
 >= 0);

353 *
·¿ms_Ën
 +ğ
v¬
->
size
;

357 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

360 
	}
}

362 
	$w¬ts_pšg_»¶y_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

363 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

364 
sÿm³r_pšg_»¶y_t
 *
»¶y
,

365 
w¬ts_pšg_»¶y_t
 *
¡©e
,

366 
w¬ts_add¹abË_t
 *
bË
,

367 
ušt32_t
 *
Ën
)

369 
	`w¬ts_pšg_»¶y_·¿ms
(
pšg
, 
»¶y
, 
bË
, 
¡©e
->
æags
,

370 &
¡©e
->
æags_Ën
, &¡©e->
·¿ms_Ën
);

372 
¡©e
->
»¶y
 =„eply;

374 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

375 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

378 
	}
}

380 
	$exŒaù_pšg_»¶y_icm±c
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

381 
ušt32_t
 
Ën
, 
sÿm³r_pšg_»¶y_t
 *
»¶y
,

382 *
·¿m
)

384 if(
Ën
 - *
off
 < 2)

387 
»¶y
->
icmp_ty³
 = 
buf
[(*
off
)++];

388 
»¶y
->
icmp_code
 = 
buf
[(*
off
)++];

390 
	}
}

392 
	$š£¹_pšg_»¶y_icm±c
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

393 cÚ¡ 
ušt32_t
 
Ën
,

394 cÚ¡ 
sÿm³r_pšg_»¶y_t
 *
»¶y
,

395 *
·¿m
)

397 
	`as£¹
(
Ën
 - *
off
 >= 2);

399 
buf
[(*
off
)++] = 
»¶y
->
icmp_ty³
;

400 
buf
[(*
off
)++] = 
»¶y
->
icmp_code
;

403 
	}
}

405 
	$w¬ts_pšg_»¶y_»ad
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

406 
sÿm³r_pšg_»¶y_t
 *
»¶y
,

407 
w¬ts_¡©e_t
 *
¡©e
,

408 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

409 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

411 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

412 {&
»¶y
->
addr
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

413 {&
»¶y
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

414 {&
»¶y
->
»¶y_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

415 {&
»¶y
->
»¶y_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

416 {
»¶y
, (
w´_t
)
exŒaù_pšg_»¶y_icm±c
, 
NULL
},

417 {&
»¶y
->
¹t
, (
w´_t
)
exŒaù_¹t
, 
NULL
},

418 {&
»¶y
->
´obe_id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

419 {&
»¶y
->
»¶y_id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

420 {&
»¶y
->
´obe_id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

421 {&
»¶y
->
»¶y_´Ùo
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

422 {&
»¶y
->
tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

423 {&
»¶y
->
addr
, (
w´_t
)
exŒaù_addr
, 
bË
},

424 {&
»¶y
->
v4¼
, (
w´_t
)
exŒaù_pšg_»¶y_v4¼
, 
bË
},

425 {&
»¶y
->
v4ts
, (
w´_t
)
exŒaù_pšg_»¶y_v4ts
, 
bË
},

426 {&
»¶y
->
»¶y_id32
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

427 {&
»¶y
->
tx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

428 {&
»¶y
->
t¤•ly
, (
w´_t
)
exŒaù_pšg_»¶y_t¤•ly
, 
NULL
},

430 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_»ad”_t
);

431 
ušt32_t
 
o
 = *
off
;

432 
i
;

434 if((
i
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0)

435  
i
;

441 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_PING_REPLY_REPLY_PROTO
) == 0)

443 if(
pšg
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

444 
»¶y
->
»¶y_´Ùo
 = 
IPPROTO_ICMP
;

446 
»¶y
->
»¶y_´Ùo
 = 
IPPROTO_ICMPV6
;

450 
	}
}

452 
	$w¬ts_pšg_»¶y_wr™e
(cÚ¡ 
w¬ts_pšg_»¶y_t
 *
¡©e
,

453 
w¬ts_add¹abË_t
 *
bË
,

454 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

456 
sÿm³r_pšg_»¶y_t
 *
»¶y
 = 
¡©e
->reply;

458 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

459 {
NULL
, NULL, NULL},

460 {&
»¶y
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

461 {&
»¶y
->
»¶y_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

462 {&
»¶y
->
»¶y_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

463 {
»¶y
, (
wpw_t
)
š£¹_pšg_»¶y_icm±c
, 
NULL
},

464 {&
»¶y
->
¹t
, (
wpw_t
)
š£¹_¹t
, 
NULL
},

465 {&
»¶y
->
´obe_id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

466 {&
»¶y
->
»¶y_id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

467 {&
»¶y
->
´obe_id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

468 {&
»¶y
->
»¶y_´Ùo
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

469 {&
»¶y
->
tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

470 {
»¶y
->
addr
, (
wpw_t
)
š£¹_addr
, 
bË
},

471 {
»¶y
->
v4¼
, (
wpw_t
)
š£¹_pšg_»¶y_v4¼
, 
bË
},

472 {
»¶y
->
v4ts
, (
wpw_t
)
š£¹_pšg_»¶y_v4ts
, 
bË
},

473 {&
»¶y
->
»¶y_id32
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

474 {&
»¶y
->
tx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

475 {
»¶y
->
t¤•ly
, (
wpw_t
)
š£¹_pšg_»¶y_t¤•ly
, 
NULL
},

477 cÚ¡ 
hªdËr_út
 = (
hªdËrs
è/ (
w¬ts_·¿m_wr™”_t
);

479 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

480 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

482 
	}
}

484 
	$w¬ts_pšg_·¿ms
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

485 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

486 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

488 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

489 
i
, 
j
, 
max_id
 = 0;

492 
	`mem£t
(
æags
, 0, 
pšg_v¬s_mfb
);

493 *
·¿ms_Ën
 = 0;

495 
i
=0; i<(
pšg_v¬s
)/(
w¬ts_v¬_t
); i++)

497 
v¬
 = &
pšg_v¬s
[
i
];

499 if(
v¬
->
id
 =ğ
WARTS_PING_ADDR_SRC_GID
 ||

500 
v¬
->
id
 =ğ
WARTS_PING_ADDR_DST_GID
 ||

501 (
v¬
->
id
 =ğ
WARTS_PING_ADDR_SRC
 && 
pšg
->
¤c
 =ğ
NULL
) ||

502 (
v¬
->
id
 =ğ
WARTS_PING_ADDR_DST
 && 
pšg
->
d¡
 =ğ
NULL
) ||

503 (
v¬
->
id
 =ğ
WARTS_PING_LIST_ID
 && 
pšg
->
li¡
 =ğ
NULL
) ||

504 (
v¬
->
id
 =ğ
WARTS_PING_CYCLE_ID
 && 
pšg
->
cyşe
 =ğ
NULL
) ||

505 (
v¬
->
id
 =ğ
WARTS_PING_USERID
 && 
pšg
->
u£rid
 == 0) ||

506 (
v¬
->
id
 =ğ
WARTS_PING_DATA_LEN
 && 
pšg
->
´obe_d©®’
 == 0) ||

507 (
v¬
->
id
 =ğ
WARTS_PING_PROBE_METHOD
 && 
pšg
->
´obe_m‘hod
 == 0) ||

508 (
v¬
->
id
 =ğ
WARTS_PING_PROBE_TOS
 && 
pšg
->
´obe_tos
 == 0) ||

509 (
v¬
->
id
 =ğ
WARTS_PING_PROBE_SPORT
 && 
pšg
->
´obe_¥Üt
 == 0) ||

510 (
v¬
->
id
 =ğ
WARTS_PING_PROBE_DPORT
 && 
pšg
->
´obe_dpÜt
 == 0) ||

511 (
v¬
->
id
 =ğ
WARTS_PING_FLAGS
 && 
pšg
->
æags
 == 0) ||

512 (
v¬
->
id
 =ğ
WARTS_PING_REPLY_PMTU
 && 
pšg
->
»¶y_pmtu
 == 0) ||

513 (
v¬
->
id
 =ğ
WARTS_PING_PROBE_TIMEOUT
 && 
pšg
->
´obe_timeout
 =ğpšg->
´obe_wa™
))

518 if(
v¬
->
id
 =ğ
WARTS_PING_PROBE_ICMPSUM
)

520 if(
pšg
->
´obe_icmpsum
 == 0 ||

521 (
pšg
->
æags
 & 
SCAMPER_PING_FLAG_ICMPSUM
) == 0)

525 if(
v¬
->
id
 =ğ
WARTS_PING_DATA_BYTES
)

527 if(
pšg
->
´obe_d©®’
 != 0)

529 
	`æag_£t
(
æags
, 
WARTS_PING_DATA_BYTES
, &
max_id
);

530 *
·¿ms_Ën
 +ğ
pšg
->
´obe_d©®’
;

535 if(
v¬
->
id
 =ğ
WARTS_PING_PROBE_TSPS
)

537 if(
pšg
->
´obe_t¥s
 !ğ
NULL
)

539 
	`æag_£t
(
æags
, 
WARTS_PING_PROBE_TSPS
, &
max_id
);

540 *
·¿ms_Ën
 += 1;

541 
j
=0; j<
pšg
->
´obe_t¥s
->
c
; j++)

542 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
,
pšg
->
´obe_t¥s
->
s
[
j
]);

547 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

549 if(
v¬
->
id
 =ğ
WARTS_PING_ADDR_SRC
)

551 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
pšg
->
¤c
);

554 if(
v¬
->
id
 =ğ
WARTS_PING_ADDR_DST
)

556 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
pšg
->
d¡
);

560 
	`as£¹
(
v¬
->
size
 >= 0);

561 *
·¿ms_Ën
 +ğ
v¬
->
size
;

564 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

567 
	}
}

569 
	$š£¹_pšg_´obe_t¥s
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

570 cÚ¡ 
ušt32_t
 
Ën
,

571 cÚ¡ 
sÿm³r_pšg_v4ts_t
 *
ts
, *
·¿m
)

573 
ušt8_t
 
i
;

575 
	`as£¹
(
Ën
 - *
off
 >= 1);

576 
buf
[(*
off
)++] = 
ts
->
c
;

577 
i
=0; i<
ts
->
c
; i++)

578 
	`š£¹_addr
(
buf
, 
off
, 
Ën
, 
ts
->
s
[
i
], 
·¿m
);

581 
	}
}

583 
	$exŒaù_pšg_´obe_t¥s
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

584 cÚ¡ 
ušt32_t
 
Ën
,

585 
sÿm³r_pšg_v4ts_t
 **
out
, *
·¿m
)

587 
sÿm³r_addr_t
 *
addr
;

588 
ušt8_t
 
i
, 
c
;

591 if(
Ën
 - *
off
 < 1)

594 
c
 = 
buf
[(*
off
)++];

596 if((*
out
 = 
	`sÿm³r_pšg_v4ts_®loc
(
c
)è=ğ
NULL
)

599 
i
=0; i<
c
; i++)

601 if(
	`exŒaù_addr
(
buf
, 
off
, 
Ën
, &
addr
, 
·¿m
) != 0)

603 (*
out
)->
s
[
i
] = 
addr
;

607 
	}
}

609 
	$w¬ts_pšg_·¿ms_»ad
(
sÿm³r_pšg_t
 *
pšg
, 
w¬ts_¡©e_t
 *
¡©e
,

610 
w¬ts_add¹abË_t
 *
bË
,

611 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

613 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

614 {&
pšg
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

615 {&
pšg
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

616 {&
pšg
->
¤c
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

617 {&
pšg
->
d¡
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

618 {&
pšg
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

619 {&
pšg
->
¡İ_»asÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

620 {&
pšg
->
¡İ_d©a
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

621 {&
pšg
->
´obe_d©®’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

622 {&
pšg
->
´obe_d©a
, (
w´_t
)
exŒaù_by‹s_®loc
, &pšg->
´obe_d©®’
},

623 {&
pšg
->
´obe_couÁ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

624 {&
pšg
->
´obe_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

625 {&
pšg
->
´obe_wa™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

626 {&
pšg
->
´obe_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

627 {&
pšg
->
»¶y_couÁ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

628 {&
pšg
->
pšg_£Á
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

629 {&
pšg
->
´obe_m‘hod
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

630 {&
pšg
->
´obe_¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

631 {&
pšg
->
´obe_dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

632 {&
pšg
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

633 {&
pšg
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

634 {&
pšg
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

635 {&
pšg
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

636 {&
pšg
->
´obe_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

637 {&
pšg
->
´obe_t¥s
, (
w´_t
)
exŒaù_pšg_´obe_t¥s
, 
bË
},

638 {&
pšg
->
´obe_icmpsum
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

639 {&
pšg
->
»¶y_pmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

640 {&
pšg
->
´obe_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

642 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

643 
ušt32_t
 
o
 = *
off
;

644 
rc
;

646 if((
rc
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0)

647  
rc
;

648 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_PING_PROBE_TIMEOUT
) == 0)

649 
pšg
->
´obe_timeout
 =…šg->
´obe_wa™
;

651 
	}
}

653 
	$w¬ts_pšg_·¿ms_wr™e
(cÚ¡ 
sÿm³r_pšg_t
 *
pšg
,

654 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

655 
w¬ts_add¹abË_t
 *
bË
,

656 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

657 cÚ¡ 
ušt32_t
 
Ën
,

658 cÚ¡ 
ušt8_t
 *
æags
,

659 cÚ¡ 
ušt16_t
 
æags_Ën
,

660 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

662 
ušt32_t
 
li¡_id
, 
cyşe_id
;

663 
ušt16_t
 
·d_Ën
 = 
pšg
->
´obe_d©®’
;

664 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

665 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

666 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

667 {
NULL
, NULL, NULL},

668 {
NULL
, NULL, NULL},

669 {&
pšg
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

670 {&
pšg
->
¡İ_»asÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

671 {&
pšg
->
¡İ_d©a
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

672 {&
pšg
->
´obe_d©®’
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

673 {
pšg
->
´obe_d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
·d_Ën
},

674 {&
pšg
->
´obe_couÁ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

675 {&
pšg
->
´obe_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

676 {&
pšg
->
´obe_wa™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

677 {&
pšg
->
´obe_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

678 {&
pšg
->
»¶y_couÁ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

679 {&
pšg
->
pšg_£Á
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

680 {&
pšg
->
´obe_m‘hod
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

681 {&
pšg
->
´obe_¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

682 {&
pšg
->
´obe_dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

683 {&
pšg
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

684 {
pšg
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

685 {
pšg
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

686 {&
pšg
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

687 {&
pšg
->
´obe_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

688 {
pšg
->
´obe_t¥s
, (
wpw_t
)
š£¹_pšg_´obe_t¥s
, 
bË
},

689 {&
pšg
->
´obe_icmpsum
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

690 {&
pšg
->
»¶y_pmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

691 {&
pšg
->
´obe_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

694 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

696 if(
	`w¬ts_li¡_g‘id
(
sf
, 
pšg
->
li¡
, &
li¡_id
) == -1)  -1;

697 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
pšg
->
cyşe
, &
cyşe_id
) == -1)  -1;

699 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

700 
hªdËr_út
);

702 
	}
}

704 
	$sÿm³r_fe_w¬ts_pšg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

705 
sÿm³r_pšg_t
 **
pšg_out
)

707 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

708 
sÿm³r_pšg_t
 *
pšg
 = 
NULL
;

709 
ušt8_t
 *
buf
 = 
NULL
;

710 
ušt32_t
 
off
 = 0;

711 
ušt16_t
 
i
;

712 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

713 
ušt16_t
 
»¶y_couÁ
;

714 
w¬ts_add¹abË_t
 
bË
;

716 
	`mem£t
(&
bË
, 0, (table));

718 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

720 
”r
;

722 if(
buf
 =ğ
NULL
)

724 *
pšg_out
 = 
NULL
;

728 if((
pšg
 = 
	`sÿm³r_pšg_®loc
()è=ğ
NULL
)

730 
”r
;

733 if(
	`w¬ts_pšg_·¿ms_»ad
(
pšg
, 
¡©e
, &
bË
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

735 
”r
;

739 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
»¶y_couÁ
, 
NULL
) != 0)

741 
”r
;

745 if(
	`sÿm³r_pšg_»¶›s_®loc
(
pšg
,…šg->
pšg_£Á
) != 0)

747 
”r
;

751 if(
»¶y_couÁ
 == 0)

753 
dÚe
;

757 
i
=0; i<
»¶y_couÁ
; i++)

759 if((
»¶y
 = 
	`sÿm³r_pšg_»¶y_®loc
()è=ğ
NULL
)

761 
”r
;

764 if(
	`w¬ts_pšg_»¶y_»ad
(
pšg
,
»¶y
,
¡©e
,&
bË
,
buf
,&
off
,
hdr
->
Ën
) != 0)

766 
”r
;

769 if(
	`sÿm³r_pšg_»¶y_­³nd
(
pšg
, 
»¶y
) != 0)

771 
”r
;

775 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

777 
dÚe
:

778 
	`w¬ts_add¹abË_ş—n
(&
bË
);

779 *
pšg_out
 = 
pšg
;

780 
	`ä“
(
buf
);

783 
”r
:

784 
	`w¬ts_add¹abË_ş—n
(&
bË
);

785 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

786 if(
pšg
 !ğ
NULL
è
	`sÿm³r_pšg_ä“
(ping);

788 
	}
}

790 
	$sÿm³r_fe_w¬ts_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

791 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
)

793 
w¬ts_add¹abË_t
 
bË
;

794 
w¬ts_pšg_»¶y_t
 *
»¶y_¡©e
 = 
NULL
;

795 
sÿm³r_pšg_»¶y_t
 *
»¶y
;

796 
ušt8_t
 *
buf
 = 
NULL
;

797 
ušt8_t
 
æags
[
pšg_v¬s_mfb
];

798 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

799 
ušt32_t
 
Ën
, 
off
 = 0;

800 
ušt16_t
 
»¶y_couÁ
;

801 
size_t
 
size
;

802 
i
, 
j
;

804 
	`mem£t
(&
bË
, 0, (table));

807 
	`w¬ts_pšg_·¿ms
(
pšg
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

810 
Ën
 = 8 + 
æags_Ën
 + 2 + 
·¿ms_Ën
 + 2;

812 if((
»¶y_couÁ
 = 
	`sÿm³r_pšg_»¶y_couÁ
(
pšg
)) > 0)

814 
size
 = 
»¶y_couÁ
 * (
w¬ts_pšg_»¶y_t
);

815 if((
»¶y_¡©e
 = (
w¬ts_pšg_»¶y_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

817 
”r
;

820 
i
=0, 
j
=0; i<
pšg
->
pšg_£Á
; i++)

822 
»¶y
=
pšg
->
pšg_»¶›s
[
i
];„•ly !ğ
NULL
;„•ly =„•ly->
Ãxt
)

824 if(
	`w¬ts_pšg_»¶y_¡©e
(
sf
, 
pšg
, 
»¶y
, &
»¶y_¡©e
[
j
++],

825 &
bË
, &
Ën
) == -1)

827 
”r
;

833 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

835 
”r
;

838 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_PING
);

840 if(
	`w¬ts_pšg_·¿ms_wr™e
(
pšg
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

841 
æags
, 
æags_Ën
, 
·¿ms_Ën
) == -1)

843 
”r
;

847 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
»¶y_couÁ
, 
NULL
);

850 
i
=0; i<
»¶y_couÁ
; i++)

852 
	`w¬ts_pšg_»¶y_wr™e
(&
»¶y_¡©e
[
i
], &
bË
, 
buf
, &
off
, 
Ën
);

854 if(
»¶y_¡©e
 !ğ
NULL
)

856 
	`ä“
(
»¶y_¡©e
);

857 
»¶y_¡©e
 = 
NULL
;

860 
	`as£¹
(
off
 =ğ
Ën
);

862 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

864 
”r
;

867 
	`w¬ts_add¹abË_ş—n
(&
bË
);

868 
	`ä“
(
buf
);

871 
”r
:

872 
	`w¬ts_add¹abË_ş—n
(&
bË
);

873 if(
»¶y_¡©e
 !ğ
NULL
è
	`ä“
(reply_state);

874 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

876 
	}
}

	@ping/scamper_ping_warts.h

25 #iâdeà
__SCAMPER_FILE_WARTS_PING_H


26 
	#__SCAMPER_FILE_WARTS_PING_H


	)

28 
sÿm³r_fe_w¬ts_pšg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

29 cÚ¡ 
sÿm³r_pšg_t
 *
pšg
);

30 
sÿm³r_fe_w¬ts_pšg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

31 
sÿm³r_pšg_t
 **
pšg_out
);

	@scamper.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r.h
"

40 
	~"sÿm³r_debug.h
"

41 
	~"sÿm³r_addr.h
"

42 
	~"sÿm³r_li¡.h
"

43 
	~"sÿm³r_fe.h
"

44 
	~"sÿm³r_outfes.h
"

45 
	~"sÿm³r_fds.h
"

46 
	~"sÿm³r_sk.h
"

47 
	~"sÿm³r_sourûs.h
"

48 
	~"sÿm³r_sourû_cmdlše.h
"

49 
	~"sÿm³r_sourû_fe.h
"

50 
	~"sÿm³r_sourû_t¥s.h
"

51 
	~"sÿm³r_queue.h
"

52 
	~"sÿm³r_g‘¤c.h
"

53 
	~"sÿm³r_addr2mac.h
"

54 
	~"sÿm³r_icmp4.h
"

55 
	~"sÿm³r_icmp6.h
"

56 
	~"sÿm³r_udp4.h
"

57 
	~"sÿm³r_udp6.h
"

58 
	~"sÿm³r_tı4.h
"

59 
	~"sÿm³r_¹sock.h
"

60 
	~"sÿm³r_dl.h
"

61 
	~"sÿm³r_fœew®l.h
"

62 
	~"sÿm³r_´obe.h
"

63 
	~"sÿm³r_´iv£p.h
"

64 
	~"sÿm³r_cÚŒŞ.h
"

65 
	~"sÿm³r_osšfo.h
"

66 
	~"Œaû/sÿm³r_Œaû_do.h
"

67 
	~"pšg/sÿm³r_pšg_do.h
"

68 
	~"Œaûlb/sÿm³r_Œaûlb_do.h
"

69 
	~"d—lŸs/sÿm³r_d—lŸs_do.h
"

70 
	~"¡šg/sÿm³r_¡šg_do.h
"

71 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc_do.h
"

72 
	~"tb™/sÿm³r_tb™_do.h
"

73 
	~"Œaûbox/sÿm³r_Œaûbox_do.h
"

74 
	~"¢iff/sÿm³r_¢iff_do.h
"

75 
	~"årštšg/sÿm³r_årštšg_do.h
"

77 
	~"uts.h
"

79 
	#OPT_PPS
 0x00000001

	)

80 
	#OPT_OUTFILE
 0x00000002

	)

81 
	#OPT_OPTION
 0x00000004

	)

82 
	#OPT_NOINITNDC
 0x00000008

	)

83 
	#OPT_PIDFILE
 0x00000010

	)

84 
	#OPT_VERSION
 0x00000020

	)

85 
	#OPT_OUTCOPY
 0x00000040

	)

86 
	#OPT_SELECT
 0x00000080

	)

87 
	#OPT_KQUEUE
 0x00000100

	)

88 
	#OPT_DAEMON
 0x00000200

	)

89 
	#OPT_IP
 0x00000400

	)

90 
	#OPT_PLANETLAB
 0x00000800

	)

91 
	#OPT_DL
 0x00001000

	)

92 
	#OPT_MONITORNAME
 0x00002000

	)

93 
	#OPT_COMMAND
 0x00004000

	)

94 
	#OPT_HELP
 0x00008000

	)

95 
	#OPT_WINDOW
 0x00010000

	)

96 
	#OPT_DEBUGFILE
 0x00020000

	)

97 
	#OPT_LISTNAME
 0x00040000

	)

98 
	#OPT_LISTID
 0x00080000

	)

99 
	#OPT_CYCLEID
 0x00100000

	)

100 
	#OPT_FIREWALL
 0x00200000

	)

101 
	#OPT_CMDLIST
 0x00400000

	)

102 
	#OPT_INFILE
 0x00800000

	)

103 
	#OPT_CTRL_PORT
 0x01000000

	)

104 
	#OPT_CTRL_UNIX
 0x02000000

	)

105 
	#OPT_EPOLL
 0x04000000

	)

106 
	#OPT_RAWTCP
 0x08000000

	)

107 
	#OPT_DEBUGFILEAPPEND
 0x10000000

	)

131 
ušt32_t
 
	gİtiÚs
 = 0;

132 *
	gcommªd
 = 
NULL
;

133 
	gµs
 = 
SCAMPER_PPS_DEF
;

134 
	gwšdow
 = 
SCAMPER_WINDOW_DEF
;

135 *
	goutfe
 = "-";

136 *
	gou‰y³
 = "text";

137 *
	gšty³
 = 
NULL
;

138 
	gù¾_pÜt
 = 0;

139 *
	gù¾_unix
 = 
NULL
;

140 *
	gmÚ™ÜÇme
 = 
NULL
;

141 *
	gli¡Çme
 = 
NULL
;

142 
	gli¡id
 = -1;

143 
	gcyşeid
 = -1;

144 **
	g¬gli¡
 = 
NULL
;

145 
	g¬gli¡_Ën
 = 0;

146 *
	gdebugfe
 = 
NULL
;

147 *
	gfœew®l
 = 
NULL
;

148 *
	gpidfe
 = 
NULL
;

157 
	gwa™_b‘w“n
 = 1000000 / 
SCAMPER_PPS_DEF
;

158 
	g´obe_wšdow
 = 250000;

159 
	gex™_wh’_dÚe
 = 1;

162 
sÿm³r_addrÿche_t
 *
	gaddrÿche
 = 
NULL
;

165 
ušt16_t
 
	gdeçuÉ_¥Üt
 = 0;

167 
	ssÿm³r_muÉiÿÎ


169 *
	m¬gv0
;

170 *
	mcmd
;

171 (*
	mv®id©e
)(, **, *);

172 cÚ¡ *(*
	mu§ge
)();

173 } 
	tsÿm³r_muÉiÿÎ_t
;

175 
	$u§ge_¡r
(
c
, *
¡r
)

177 
	`årštf
(
¡d”r
, " -%ø%s\n", 
c
, 
¡r
);

179 
	}
}

181 
	$v”siÚ
()

183 
	`årštf
(
¡d”r
, "sÿm³¸v”siÚ %s\n", 
SCAMPER_VERSION
);

185 
	}
}

187 
	$u§ge
(
ušt32_t
 
İt_mask
)

189 
buf
[256];

190 
size_t
 
off
;

192 
	`årštf
(
¡d”r
,

196 #iâdeà
WITHOUT_DEBUGFILE


201 if(
İt_mask
 == 0) ;

203 
	`årštf
(
¡d”r
, "\n");

205 if((
İt_mask
 & 
OPT_HELP
) != 0)

206 
	`u§ge_¡r
('?', "give‡n overview ofhe usage of scamper");

208 if((
İt_mask
 & 
OPT_COMMAND
) != 0)

210 ()
	`¢´štf
(
buf
, (buf),

211 "commªd sŒšg (deçuÉ: %s)", 
SCAMPER_COMMAND_DEF
);

212 
	`u§ge_¡r
('c', 
buf
);

215 if((
İt_mask
 & 
OPT_CYCLEID
) != 0)

216 
	`u§ge_¡r
('C', "cycle id");

218 if((
İt_mask
 & 
OPT_DEBUGFILE
) != 0)

219 
	`u§ge_¡r
('d', "write debugging informationohe specified file");

221 if((
İt_mask
 & 
OPT_DAEMON
) != 0)

222 
	`u§ge_¡r
('D', "start‡s‡ daemon†istening for commands on‡…ort");

224 if((
İt_mask
 & 
OPT_PIDFILE
) != 0)

225 
	`u§ge_¡r
('e', "write…rocess IDo specified file");

227 if((
İt_mask
 & 
OPT_INFILE
) != 0)

228 
	`u§ge_¡r
('f', "list of files…rovided onhe command†ine");

230 if((
İt_mask
 & 
OPT_FIREWALL
) != 0)

231 
	`u§ge_¡r
('F', "usehe system firewallo install„ules‡s‚ecessary");

233 if((
İt_mask
 & 
OPT_IP
) != 0)

234 
	`u§ge_¡r
('i', "list of IP‡ddresses…rovided onhe command†ine");

236 if((
İt_mask
 & 
OPT_CMDLIST
) != 0)

237 
	`u§ge_¡r
('I', "list of scamper commands…rovided onhe command†ine");

239 if((
İt_mask
 & 
OPT_LISTID
) != 0)

240 
	`u§ge_¡r
('l', "nameo‡ssigno default†ist");

242 if((
İt_mask
 & 
OPT_LISTNAME
) != 0)

243 
	`u§ge_¡r
('L', "list id for default†ist");

245 if((
İt_mask
 & 
OPT_MONITORNAME
) != 0)

246 
	`u§ge_¡r
('M', "specifyhe canonical‚ame ofhe monitor");

248 if((
İt_mask
 & 
OPT_OUTFILE
) != 0)

249 
	`u§ge_¡r
('o', "specifyhe fileo write outputo");

251 if((
İt_mask
 & 
OPT_OPTION
) != 0)

253 
off
 = 0;

254 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "specify options [warts |ext | json");

255 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " | outcopy |sps | dlts");

256 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " |„awtcp");

257 #iâdeà
WITHOUT_DEBUGFILE


258 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " | debugfileappend");

260 #iâdeà
_WIN32


261 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " | select");

263 #ifdeà
HAVE_KQUEUE


264 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " | kqueue");

266 #ifdeà
HAVE_EPOLL


267 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " |ƒpoll");

269 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " |…lanetlab]");

271 
	`u§ge_¡r
('O', 
buf
);

274 if((
İt_mask
 & 
OPT_PPS
) != 0)

276 
off
 = 0;

277 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

279 
SCAMPER_PPS_MIN
, 
SCAMPER_PPS_MAX
);

280 
	`u§ge_¡r
('p', 
buf
);

283 if((
İt_mask
 & 
OPT_CTRL_PORT
) != 0)

284 
	`u§ge_¡r
('P', "port for control socket onhe†oopback interface");

286 if((
İt_mask
 & 
OPT_CTRL_UNIX
) != 0)

287 
	`u§ge_¡r
('U', "name of control socket inhe file system");

289 if((
İt_mask
 & 
OPT_VERSION
) != 0)

290 
	`u§ge_¡r
('v', "outputhe version of scamperhis binary is");

292 if((
İt_mask
 & 
OPT_WINDOW
) != 0)

293 
	`u§ge_¡r
('w', "limithe window of‡ctively…robingasks");

296 
	}
}

298 
	$£t_İt
(
ušt32_t
 
İt
, *
¡r
, (*
£tfunc
)())

300 
l
 = 0;

302 if(
	`¡ršg_i¢umb”
(
¡r
è=ğ0 || 
	`¡ršg_tŞÚg
(¡r, &
l
) == -1)

304 
	`u§ge
(
İt
);

308  
	`£tfunc
(
l
);

309 
	}
}

311 
	$muÉiÿÎ_do
(cÚ¡ 
sÿm³r_muÉiÿÎ_t
 *
mc
, 
¬gc
, *
¬gv
[])

313 *
¡r
;

314 
size_t
 
off
, 
Ën
, 
tmp
;

315 
i
, 
¡İ
;

317 if(
¬gc
 =ğ1 || 
mc
->
	`v®id©e
×rgc, 
¬gv
, &
¡İ
) != 0 || stop ==‡rgc)

319 if(
mc
->
u§ge
 !ğ
NULL
)

321 
	`´štf
("u§ge: sÿm³r-% <†i¡>\n", 
mc
->
	`u§ge
());

327 
Ën
 = 
	`¡¾’
(
mc
->
cmd
) + 1;

328 
i
=1; i<
¡İ
; i++)

330 
Ën
 +ğ
	`¡¾’
(
¬gv
[
i
]) + 1;

332 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

334 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

335 "could‚Ù‡s£mbË % commªd", 
mc
->
cmd
);

338 
off
 = 
	`¡¾’
(
mc
->
cmd
);

339 
	`memıy
(
¡r
, 
mc
->
cmd
, 
off
);

340 
¡r
[
off
++] = ' ';

341 
i
=1; i<
¡İ
; i++)

343 
tmp
 = 
	`¡¾’
(
¬gv
[
i
]);

344 
	`memıy
(
¡r
+
off
, 
¬gv
[
i
], 
tmp
);

345 
off
 +ğ
tmp
;

346 
¡r
[
off
++] = ' ';

348 
¡r
[
off
] = '\0';

351 
	`sÿm³r_commªd_£t
(
¡r
);

352 
	`ä“
(
¡r
);

354 
İtiÚs
 |ğ
OPT_IP
;

356 
¬gli¡
 = 
¬gv
 + 
¡İ
;

357 
¬gli¡_Ën
 = 
¬gc
 - 
¡İ
;

360 
	}
}

362 
	$cyşeid_£t
(cÚ¡ 
cid
)

364 if(
cid
 > 0 && cid <= 0x7fffffff)

366 
cyşeid
 = 
cid
;

370 
	}
}

372 
	$li¡id_£t
(cÚ¡ 
lid
)

374 if(
lid
 > 0 &&†id <= 0x7fffffff)

376 
li¡id
 = 
lid
;

380 
	}
}

382 
	$µswšdow_£t
(
p
, 
w
)

384 if(
p
 =ğ0 && 
w
 == 0)

387 if(
p
 !ğ
µs
)

389 if(
p
 !ğ0 && (°< 
SCAMPER_PPS_MIN
 ||… > 
SCAMPER_PPS_MAX
))

396 
µs
 = 
p
;

397 if(
p
 != 0)

398 
wa™_b‘w“n
 = 1000000 / 
µs
;

400 
wa™_b‘w“n
 = 0;

401 
´obe_wšdow
 = 250000;

402 if(
wa™_b‘w“n
 > 250000)

403 
´obe_wšdow
 +ğ
wa™_b‘w“n
;

406 if(
w
 !ğ
wšdow
)

408 if(
w
 !ğ0 && (w < 
SCAMPER_WINDOW_MIN
 || w > 
SCAMPER_WINDOW_MAX
))

410 
wšdow
 = 
w
;

414 
	}
}

416 
	$check_İtiÚs
(
¬gc
, *
¬gv
[])

418 cÚ¡ 
sÿm³r_muÉiÿÎ_t
 
muÉiÿÎ
[] = {

420 
sÿm³r_do_Œaû_¬g_v®id©e
, 
sÿm³r_do_Œaû_u§ge
},

422 
sÿm³r_do_pšg_¬g_v®id©e
, 
sÿm³r_do_pšg_u§ge
},

424 
sÿm³r_do_Œaûlb_¬g_v®id©e
, 
sÿm³r_do_Œaûlb_u§ge
},

426 
sÿm³r_do_d—lŸs_¬g_v®id©e
, 
sÿm³r_do_d—lŸs_u§ge
},

428 
sÿm³r_do_¡šg_¬g_v®id©e
, 
sÿm³r_do_¡šg_u§ge
},

430 
sÿm³r_do_Ãighbourdisc_¬g_v®id©e
, 
sÿm³r_do_Ãighbourdisc_u§ge
},

432 
sÿm³r_do_tb™_¬g_v®id©e
, 
sÿm³r_do_tb™_u§ge
},

434 
sÿm³r_do_Œaûbox_¬g_v®id©e
, 
sÿm³r_do_Œaûbox_u§ge
},

436 
sÿm³r_do_¢iff_¬g_v®id©e
, 
sÿm³r_do_¢iff_u§ge
},

438 
sÿm³r_do_årštšg_¬g_v®id©e
, 
sÿm³r_do_årštšg_u§ge
}

440 
i
;

441 
lo
, 
lo_w
 = 
wšdow
, 
lo_p
 = 
µs
;

442 
İts
[64];

443 *
İt_cyşeid
 = 
NULL
, *
İt_li¡id
 = NULL, *
İt_li¡Çme
 = NULL;

444 *
İt_ù¾_pÜt
 = 
NULL
, *
İt_ù¾_unix
 = NULL, *
İt_mÚ™ÜÇme
 = NULL;

445 *
İt_µs
 = 
NULL
, *
İt_commªd
 = NULL, *
İt_wšdow
 = NULL;

446 *
İt_debugfe
 = 
NULL
, *
İt_fœew®l
 = NULL, *
İt_pidfe
 = NULL;

447 
size_t
 
¬gv0
 = 
	`¡¾’
(
¬gv
[0]);

448 
size_t
 
m
, 
Ën
;

449 
size_t
 
off
;

450 
ušt32_t
 
o
;

452 
m
=0; m<(
muÉiÿÎ
)/(
sÿm³r_muÉiÿÎ_t
); m++)

454 
Ën
 = 
	`¡¾’
(
muÉiÿÎ
[
m
].
¬gv0
);

455 if(
¬gv0
 >ğ
Ën
 && 
	`¡rcmp
(
¬gv
[0]+¬gv0-Ën, 
muÉiÿÎ
[
m
].argv0) == 0)

457  
	`muÉiÿÎ_do
(&
muÉiÿÎ
[
m
], 
¬gc
, 
¬gv
);

461 
off
 = 0;

462 
	`¡ršg_cÚÿt
(
İts
, (İts), &
off
, "c:C:d:e:fF:iIl:L:M:o:O:p:P:vw:?");

463 #ià!
	`defšed
(
__sun__
è&& !defšed(
_WIN32
)

464 
	`¡ršg_cÚÿt
(
İts
, (İts), &
off
, "D");

466 #ià
	`defšed
(
AF_UNIX
)

467 
	`¡ršg_cÚÿt
(
İts
, (İts), &
off
, "U:");

470 (
i
 = 
	`g‘İt
(
¬gc
, 
¬gv
, 
İts
)) != -1)

472 
i
)

475 
İtiÚs
 |ğ
OPT_COMMAND
;

476 
İt_commªd
 = 
İrg
;

480 
İtiÚs
 |ğ
OPT_CYCLEID
;

481 
İt_cyşeid
 = 
İrg
;

485 
İtiÚs
 |ğ
OPT_DEBUGFILE
;

486 
İt_debugfe
 = 
İrg
;

490 
İtiÚs
 |ğ
OPT_DAEMON
;

494 
İtiÚs
 |ğ
OPT_PIDFILE
;

495 
İt_pidfe
 = 
İrg
;

499 
İtiÚs
 |ğ
OPT_INFILE
;

503 
İtiÚs
 |ğ
OPT_FIREWALL
;

504 
İt_fœew®l
 = 
İrg
;

508 
İtiÚs
 |ğ
OPT_IP
;

512 
İtiÚs
 |ğ
OPT_CMDLIST
;

516 
İtiÚs
 |ğ
OPT_LISTNAME
;

517 
İt_li¡Çme
 = 
İrg
;

521 
İtiÚs
 |ğ
OPT_LISTID
;

522 
İt_li¡id
 = 
İrg
;

526 
İtiÚs
 |ğ
OPT_MONITORNAME
;

527 
İt_mÚ™ÜÇme
 = 
İrg
;

531 
İtiÚs
 |ğ
OPT_OUTFILE
;

532 
outfe
 = 
İrg
;

536 if(
	`¡rÿ£cmp
(
İrg
, "text") == 0)

537 
ou‰y³
 = 
İrg
;

538 if(
	`¡rÿ£cmp
(
İrg
, "warts") == 0)

539 
ou‰y³
 = 
İrg
;

540 if(
	`¡rÿ£cmp
(
İrg
, "json") == 0)

541 
ou‰y³
 = 
İrg
;

542 if(
	`¡rÿ£cmp
(
İrg
, "tsps") == 0)

543 
šty³
 = 
İrg
;

544 if(
	`¡rÿ£cmp
(
İrg
, "cmdfile") == 0)

545 
šty³
 = 
İrg
;

546 if(
	`¡rÿ£cmp
(
İrg
, "dlts") == 0)

547 
İtiÚs
 |ğ
OPT_DL
;

548 if(
	`¡rÿ£cmp
(
İrg
, "planetlab") == 0)

549 
İtiÚs
 |ğ
OPT_PLANETLAB
;

550 if(
	`¡rÿ£cmp
(
İrg
, "noinitndc") == 0)

551 
İtiÚs
 |ğ
OPT_NOINITNDC
;

552 if(
	`¡rÿ£cmp
(
İrg
, "outcopy") == 0)

553 
İtiÚs
 |ğ
OPT_OUTCOPY
;

554 if(
	`¡rÿ£cmp
(
İrg
, "select") == 0)

555 
İtiÚs
 |ğ
OPT_SELECT
;

556 if(
	`¡rÿ£cmp
(
İrg
, "rawtcp") == 0)

557 
İtiÚs
 |ğ
OPT_RAWTCP
;

558 #ifdeà
HAVE_KQUEUE


559 if(
	`¡rÿ£cmp
(
İrg
, "kqueue") == 0)

560 
İtiÚs
 |ğ
OPT_KQUEUE
;

562 #ifdeà
HAVE_EPOLL


563 if(
	`¡rÿ£cmp
(
İrg
, "epoll") == 0)

564 
İtiÚs
 |ğ
OPT_EPOLL
;

566 #iâdeà
WITHOUT_DEBUGFILE


567 if(
	`¡rÿ£cmp
(
İrg
, "debugfileappend") == 0)

568 
İtiÚs
 |ğ
OPT_DEBUGFILEAPPEND
;

572 
	`u§ge
(
OPT_OPTION
);

578 
İtiÚs
 |ğ
OPT_PPS
;

579 
İt_µs
 = 
İrg
;

583 
İtiÚs
 |ğ
OPT_CTRL_PORT
;

584 
İt_ù¾_pÜt
 = 
İrg
;

588 
İtiÚs
 |ğ
OPT_CTRL_UNIX
;

589 
İt_ù¾_unix
 = 
İrg
;

593 
İtiÚs
 |ğ
OPT_VERSION
;

597 
İtiÚs
 |ğ
OPT_WINDOW
;

598 
İt_wšdow
 = 
İrg
;

602 
İtiÚs
 |ğ
OPT_HELP
;

603 
	`u§ge
(0xffffffff);

607 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

613 if(
İtiÚs
 & 
OPT_VERSION
)

615 
	`v”siÚ
();

623 if((
İtiÚs
 & (
OPT_IP
|
OPT_CTRL_PORT
|
OPT_CTRL_UNIX
|
OPT_CMDLIST
)) == 0)

625 
İtiÚs
 |ğ
OPT_INFILE
;

628 if(
İtiÚs
 & (
OPT_PPS
|
OPT_WINDOW
))

630 if(
İt_wšdow
 !ğ
NULL
 && 
	`¡ršg_tŞÚg
(İt_wšdow, &
lo_w
) != 0)

632 
	`u§ge
(
OPT_WINDOW
);

635 if(
İt_µs
 !ğ
NULL
 && 
	`¡ršg_tŞÚg
(İt_µs, &
lo_p
) != 0)

637 
	`u§ge
(
OPT_PPS
);

640 if(
	`µswšdow_£t
(
lo_p
, 
lo_w
) != 0)

642 
	`u§ge
(
OPT_PPS
|
OPT_WINDOW
);

647 if(
İtiÚs
 & 
OPT_FIREWALL
 && (
fœew®l
 = 
	`¡rdup
(
İt_fœew®l
)è=ğ
NULL
)

649 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup firewall");

653 if(
İtiÚs
 & 
OPT_MONITORNAME
 &&

654 (
mÚ™ÜÇme
 = 
	`¡rdup
(
İt_mÚ™ÜÇme
)è=ğ
NULL
)

656 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup monitorname");

660 if(
İtiÚs
 & 
OPT_LISTNAME
 && (
li¡Çme
 = 
	`¡rdup
(
İt_li¡Çme
)è=ğ
NULL
)

662 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup†istname");

666 if(
İtiÚs
 & 
OPT_LISTID
 && 
	`£t_İt
(OPT_LISTID, 
İt_li¡id
, 
li¡id_£t
) != 0)

668 
	`u§ge
(
OPT_LISTID
);

672 if(
İtiÚs
 & 
OPT_CYCLEID
 &&

673 
	`£t_İt
(
OPT_CYCLEID
, 
İt_cyşeid
, 
cyşeid_£t
) != 0)

675 
	`u§ge
(
OPT_CYCLEID
);

679 if(
İtiÚs
 & 
OPT_DEBUGFILE
 && (
debugfe
 = 
	`¡rdup
(
İt_debugfe
)è=ğ
NULL
)

681 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup debugfile");

685 if(
İtiÚs
 & 
OPT_PIDFILE
 && (
pidfe
 = 
	`¡rdup
(
İt_pidfe
)è=ğ
NULL
)

687 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup…idfile");

692 
o
 = 
İtiÚs
 & (
OPT_IP
|
OPT_CTRL_PORT
|
OPT_CTRL_UNIX
|
OPT_CMDLIST
|
OPT_INFILE
);

693 if(((
o
 & 
OPT_IP
) != 0 && (o & ~OPT_IP) != 0) ||

694 ((
o
 & 
OPT_CTRL_PORT
) != 0 && (o & ~OPT_CTRL_PORT) != 0) ||

695 ((
o
 & 
OPT_CTRL_UNIX
) != 0 && (o & ~OPT_CTRL_UNIX) != 0) ||

696 ((
o
 & 
OPT_CMDLIST
) != 0 && (o & ~OPT_CMDLIST) != 0) ||

697 ((
o
 & 
OPT_INFILE
) != 0 && (o & ~OPT_INFILE) != 0))

699 
	`u§ge
(
o
);

704 
¬gli¡
 = 
¬gv
 + 
İtšd
;

705 
¬gli¡_Ën
 = 
¬gc
 - 
İtšd
;

708 if((
İtiÚs
 & (
OPT_CTRL_PORT
 | 
OPT_CTRL_UNIX
 | 
OPT_IP
 | 
OPT_INFILE
)) != 0 &&

709 
	`sÿm³r_commªd_£t
((
İtiÚs
 & 
OPT_COMMAND
) ?

710 
İt_commªd
 : 
SCAMPER_COMMAND_DEF
) == -1)

715 if((
İtiÚs
 & 
OPT_DAEMON
è&& (İtiÚ & (
OPT_CTRL_PORT
|
OPT_CTRL_UNIX
)) == 0)

717 
	`u§ge
(
OPT_DAEMON
 | 
OPT_CTRL_PORT
 | 
OPT_CTRL_UNIX
);

721 if(
İtiÚs
 & 
OPT_CTRL_PORT
)

724 if(
	`¡ršg_i¢umb”
(
İt_ù¾_pÜt
) == 0 ||

725 
	`¡ršg_tŞÚg
(
İt_ù¾_pÜt
, &
lo
) == -1 ||†o < 1 ||†o > 65535)

727 
	`u§ge
(
OPT_CTRL_PORT
);

730 
ù¾_pÜt
 = 
lo
;

733 if(
¬gli¡_Ën
 != 0)

735 
	`u§ge
(
OPT_CTRL_PORT
);

739 if(
İtiÚs
 & 
OPT_CTRL_UNIX
)

741 
ù¾_unix
 = 
İt_ù¾_unix
;

744 if(
¬gli¡_Ën
 != 0)

746 
	`u§ge
(
OPT_CTRL_UNIX
);

750 if(
İtiÚs
 & (
OPT_IP
 | 
OPT_CMDLIST
))

756 if(
¬gli¡_Ën
 < 1)

758 if(
İtiÚs
 & 
OPT_IP
)

759 
	`u§ge
(
OPT_IP
);

760 if(
İtiÚs
 & 
OPT_CMDLIST
)

761 
	`u§ge
(
OPT_CMDLIST
);

771 if(
¬gli¡_Ën
 != 1)

773 
	`u§ge
(0);

779 
	}
}

781 cÚ¡ *
	$sÿm³r_commªd_g‘
()

783 
	`as£¹
(
commªd
 !ğ
NULL
);

784  
commªd
;

785 
	}
}

787 
	$sÿm³r_commªd_£t
(cÚ¡ *
commªd_š
)

789 *
d
;

791 if(
commªd_š
 =ğ
NULL
)

796 if((
d
 = 
	`¡rdup
(
commªd_š
)è=ğ
NULL
)

798 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup command");

802 if(
commªd
 !ğ
NULL
)

803 
	`ä“
(
commªd
);

805 
commªd
 = 
d
;

807 
	}
}

809 
	$sÿm³r_ex™wh’dÚe
(
Ú
)

811 if(
Ú
 == 1 || on == 0)

813 
ex™_wh’_dÚe
 = 
Ú
;

816 
	}
}

818 
	$sÿm³r_µs_g‘
()

820  
µs
;

821 
	}
}

823 
	$sÿm³r_µs_£t
(cÚ¡ 
p
)

825  
	`µswšdow_£t
(
p
, 
wšdow
);

826 
	}
}

828 
	$sÿm³r_wšdow_g‘
()

830  
wšdow
;

831 
	}
}

833 
	$sÿm³r_wšdow_£t
(cÚ¡ 
w
)

835  
	`µswšdow_£t
(
µs
, 
w
);

836 
	}
}

838 cÚ¡ *
	$sÿm³r_mÚ™ÜÇme_g‘
()

840  
mÚ™ÜÇme
;

841 
	}
}

843 
	$sÿm³r_mÚ™ÜÇme_£t
(cÚ¡ *
mn
)

845 *
tmp
;

851 if(
mn
 !ğ
NULL
)

853 if((
tmp
 = 
	`¡rdup
(
mn
)è=ğ
NULL
)

860 
tmp
 = 
NULL
;

863 if(
mÚ™ÜÇme
 !ğ
NULL
)

865 
	`ä“
(
mÚ™ÜÇme
);

868 
mÚ™ÜÇme
 = 
tmp
;

870 
	}
}

872 
	$sÿm³r_İtiÚ_dl
()

874 if(
İtiÚs
 & 
OPT_DL
)  1;

876 
	}
}

878 
	$sÿm³r_İtiÚ_¶ª‘Ïb
()

880 if(
İtiÚs
 & 
OPT_PLANETLAB
)  1;

882 
	}
}

884 
	$sÿm³r_İtiÚ_£Ëù
()

886 if(
İtiÚs
 & 
OPT_SELECT
)  1;

888 
	}
}

890 
	$sÿm³r_İtiÚ_kqueue
()

892 if(
İtiÚs
 & 
OPT_KQUEUE
)  1;

894 
	}
}

896 
	$sÿm³r_İtiÚ_•Şl
()

898 if(
İtiÚs
 & 
OPT_EPOLL
)  1;

900 
	}
}

902 
	$sÿm³r_İtiÚ_noš™ndc
()

904 if(
İtiÚs
 & 
OPT_NOINITNDC
)  1;

906 
	}
}

908 
	$sÿm³r_İtiÚ_¿wtı
()

910 if(
İtiÚs
 & 
OPT_RAWTCP
)  1;

912 
	}
}

914 
	$sÿm³r_İtiÚ_debugf—µ’d
()

916 if(
İtiÚs
 & 
OPT_DEBUGFILEAPPEND
)  1;

918 
	}
}

920 
	$sÿm³r_pidfe
()

922 
buf
[32];

923 
mode_t
 
mode
;

924 
size_t
 
Ën
;

925 
fd
, 
æags
 = 
O_WRONLY
 | 
O_TRUNC
 | 
O_CREAT
;

927 #iâdeà
_WIN32


928 
pid_t
 
pid
 = 
	`g‘pid
();

929 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

931 
DWORD
 
pid
 = 
	`G‘Cu¼’tProûssId
();

932 
mode
 = 
_S_IREAD
 | 
_S_IWRITE
;

935 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

936 
fd
 = 
	`İ’
(
pidfe
, 
æags
, 
mode
);

938 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
pidfe
, 
æags
, 
mode
);

941 if(
fd
 == -1)

943 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù o³À%s", 
pidfe
);

944 
”r
;

947 
	`¢´štf
(
buf
, (buf), "%ld\n", ()
pid
);

948 
Ën
 = 
	`¡¾’
(
buf
);

949 if(
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
) != 0)

951 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot write…id");

952 
”r
;

954 
	`şo£
(
fd
);

958 
”r
:

959 if(
fd
 !ğ-1è
	`şo£
(fd);

961 
	}
}

963 #iâdeà
_WIN32


964 
	$sÿm³r_chld
(
sig
)

966 
¡©us
;

968 if(
sig
 !ğ
SIGCHLD
)

973 if(
	`wa™pid
(-1, &
¡©us
, 
WNOHANG
) == -1)

980 
	}
}

983 
	$sÿm³r_¥Üt_š™
()

985 #iâdeà
_WIN32


986 
pid_t
 
pid
 = 
	`g‘pid
();

988 
DWORD
 
pid
 = 
	`G‘Cu¼’tProûssId
();

990 
deçuÉ_¥Üt
 = (
pid
 & 0x7fff) + 0x8000;

992 
	}
}

994 
ušt16_t
 
	$sÿm³r_¥Üt_deçuÉ
()

996  
deçuÉ_¥Üt
;

997 
	}
}

1004 
	$sÿm³r
(
¬gc
, *
¬gv
[])

1006 
timev®
 
tv
;

1007 
timev®
 
Ï¡´obe
;

1008 
timev®
 
Ãxrobe
;

1009 
timev®
 *
timeout
;

1010 cÚ¡ *
soâame
;

1011 
sÿm³r_sourû_·¿ms_t
 
s¥
;

1012 
sÿm³r_sourû_t
 *
sourû
 = 
NULL
;

1013 
sÿm³r_sk_t
 *
sk
;

1014 
sÿm³r_outfe_t
 *
sof
, *
sof2
;

1015 
sÿm³r_fe_t
 *
fe
;

1017 if(
	`check_İtiÚs
(
¬gc
, 
¬gv
) == -1)

1022 #ifdeà
HAVE_DAEMON


1023 if((
İtiÚs
 & 
OPT_DAEMON
è!ğ0 && 
	`d«mÚ
(1, 0) != 0)

1025 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot daemon");

1034 if((
İtiÚs
 & 
OPT_PIDFILE
è!ğ0 && 
	`sÿm³r_pidfe
() != 0)

1037 if(
	`sÿm³r_osšfo_š™
() != 0)

1045 if(
	`sÿm³r_dl_š™
() == -1)

1050 #iâdeà
WITHOUT_PRIVSEP


1052 if(
	`sÿm³r_´iv£p_š™
() == -1)

1058 if(
fœew®l
 !ğ
NULL
)

1060 if(
	`sÿm³r_fœew®l_š™
(
fœew®l
) != 0)

1064 
	`ä“
(
fœew®l
);

1065 
fœew®l
 = 
NULL
;

1068 #iâdeà
WITHOUT_DEBUGFILE


1073 if(
debugfe
 !ğ
NULL
 && 
	`sÿm³r_debug_İ’
(debugfile) != 0)

1080 
	`sÿm³r_¥Üt_š™
();

1083 if((
addrÿche
 = 
	`sÿm³r_addrÿche_®loc
()è=ğ
NULL
)

1089 if(
	`sÿm³r_´obe_š™
() != 0)

1093 if(
	`sÿm³r_fds_š™
() == -1)

1099 if(
İtiÚs
 & 
OPT_CTRL_PORT
)

1101 if(
	`sÿm³r_cÚŒŞ_š™_pÜt
(
ù¾_pÜt
) != 0)

1105 
ex™_wh’_dÚe
 = 0;

1108 if(
İtiÚs
 & 
OPT_CTRL_UNIX
)

1110 if(
	`sÿm³r_cÚŒŞ_š™_unix
(
ù¾_unix
) != 0)

1114 
ex™_wh’_dÚe
 = 0;

1118 if(
	`sÿm³r_g‘¤c_š™
() == -1)

1124 if(
	`sÿm³r_addr2mac_š™
() == -1)

1129 if(
	`sÿm³r_¹sock_š™
() == -1)

1135 if(
	`sÿm³r_sourûs_š™
() == -1)

1144 if(
	`sÿm³r_sk_š™
() == -1)

1150 if(
	`sÿm³r_queue_š™
() == -1)

1159 if(
	`sÿm³r_outfes_š™
(
outfe
, 
ou‰y³
) == -1)

1165 if(
	`sÿm³r_do_Œaû_š™
() != 0 ||

1166 
	`sÿm³r_do_pšg_š™
() != 0 ||

1167 
	`sÿm³r_do_Œaûlb_š™
() != 0 ||

1168 
	`sÿm³r_do_d—lŸs_š™
() != 0 ||

1169 
	`sÿm³r_do_¡šg_š™
() != 0 ||

1170 
	`sÿm³r_do_Ãighbourdisc_š™
() != 0 ||

1171 
	`sÿm³r_do_tb™_š™
() != 0 ||

1172 
	`sÿm³r_do_Œaûbox_š™
() != 0 ||

1173 
	`sÿm³r_do_¢iff_š™
() != 0 ||

1174 
	`sÿm³r_do_årštšg_š™
() != 0)

1180 
	`mem£t
(&
s¥
, 0, (ssp));

1181 
s¥
.
Çme
 = "default";

1182 
s¥
.
desü
 = "default";

1183 
s¥
.
´iÜ™y
 = 1;

1184 
s¥
.
sof
 = 
	`sÿm³r_outfes_g‘
(
NULL
);

1185 if(
İtiÚs
 & 
OPT_LISTNAME
)

1186 
s¥
.
Çme
 = 
li¡Çme
;

1187 if(
İtiÚs
 & 
OPT_LISTID
)

1188 
s¥
.
li¡_id
 = 
li¡id
;

1189 if(
İtiÚs
 & 
OPT_CYCLEID
)

1190 
s¥
.
cyşe_id
 = 
cyşeid
;

1196 if(
İtiÚs
 & (
OPT_IP
|
OPT_CMDLIST
))

1198 if((
sourû
 = 
	`sÿm³r_sourû_cmdlše_®loc
(&
s¥
, 
commªd
,

1199 
¬gli¡
, 
¬gli¡_Ën
)è=ğ
NULL
)

1204 if((
İtiÚs
 & (
OPT_CTRL_PORT
|
OPT_CTRL_UNIX
)) == 0)

1206 if(
šty³
 =ğ
NULL
)

1207 
sourû
 = 
	`sÿm³r_sourû_fe_®loc
(&
s¥
, 
¬gli¡
[0], 
commªd
, 1, 0);

1208 if(
	`¡rÿ£cmp
(
šty³
, "tsps") == 0)

1209 
sourû
 = 
	`sÿm³r_sourû_t¥s_®loc
(&
s¥
, 
¬gli¡
[0]);

1210 if(
	`¡rÿ£cmp
(
šty³
, "cmdfile") == 0)

1211 
sourû
 = 
	`sÿm³r_sourû_fe_®loc
(&
s¥
, 
¬gli¡
[0], 
NULL
, 1, 0);

1212 if(
sourû
 =ğ
NULL
)

1216 if(
sourû
 !ğ
NULL
)

1218 
	`sÿm³r_sourûs_add
(
sourû
);

1219 
	`sÿm³r_sourû_ä“
(
sourû
);

1222 
	`g‘timeofday_w¿p
(&
Ï¡´obe
);

1224 #iâdeà
_WIN32


1225 
	`¤ªdom
(
Ï¡´obe
.
tv_u£c
);

1230 if(
	`sÿm³r_queue_»adycouÁ
() > 0 ||

1231 ((
wšdow
 =ğ0 || 
	`sÿm³r_queue_wšdowcouÁ
() < window) &&

1232 
	`sÿm³r_sourûs_i¤—dy
() != 0))

1238 
	`timev®_add_us
(&
Ãxrobe
, &
Ï¡´obe
, 
wa™_b‘w“n
);

1239 
timeout
 = &
tv
;

1241 if(
	`sÿm³r_queue_couÁ
() > 0)

1248 
	`sÿm³r_queue_wa™time
(&
Ãxrobe
);

1249 
timeout
 = &
tv
;

1257 
timeout
 = 
NULL
;

1260 if(
timeout
 !ğ
NULL
)

1266 
	`g‘timeofday_w¿p
(&
tv
);

1267 if(
	`timev®_cmp
(&
Ãxrobe
, &
tv
) <= 0)

1268 
	`mem£t
(&
tv
, 0, (tv));

1270 
	`timev®_diff_tv
(&
tv
, &tv, &
Ãxrobe
);

1274 if(
ex™_wh’_dÚe
 !ğ0 && 
	`sÿm³r_sourûs_i£m±y
() == 1)

1278 
timeout
 = 
NULL
;

1282 if(
	`sÿm³r_fds_pŞl
(
timeout
) == -1)

1288 
	`g‘timeofday_w¿p
(&
tv
);

1291 (
sk
 = 
	`sÿm³r_queue_g‘dÚe
(&
tv
)è!ğ
NULL
)

1294 if((
sourû
 = 
	`sÿm³r_sk_g‘sourû
(
sk
)è!ğ
NULL
 &&

1295 (
soâame
 = 
	`sÿm³r_sourû_g‘outfe
(
sourû
)è!ğ
NULL
 &&

1296 (
sof
 = 
	`sÿm³r_outfes_g‘
(
soâame
)è!ğ
NULL
)

1298 
fe
 = 
	`sÿm³r_outfe_g‘fe
(
sof
);

1299 
	`sÿm³r_sk_wr™e
(
sk
, 
fe
);

1305 if((
İtiÚs
 & 
OPT_OUTCOPY
) != 0 &&

1306 (
sof2
 = 
	`sÿm³r_outfes_g‘
(
NULL
)è!ğNULL && 
sof
 != sof2)

1308 
fe
 = 
	`sÿm³r_outfe_g‘fe
(
sof2
);

1309 
	`sÿm³r_sk_wr™e
(
sk
, 
fe
);

1314 
	`sÿm³r_sk_ä“
(
sk
);

1321 if(
	`sÿm³r_queue_»adycouÁ
(è> 0 || 
	`sÿm³r_sourûs_i¤—dy
() == 1)

1330 if(
	`timev®_š¿nge_us
(&
tv
, &
Ï¡´obe
, 
´obe_wšdow
) == 0)

1332 
	`timev®_sub_us
(&
Ï¡´obe
, &
tv
, 
wa™_b‘w“n
);

1344 
	`timev®_add_us
(&
Ãxrobe
, &
Ï¡´obe
, 
wa™_b‘w“n
);

1347 if(
	`timev®_cmp
(&
Ãxrobe
, &
tv
) > 0)

1358 if((
sk
 = 
	`sÿm³r_queue_£Ëù
()è=ğ
NULL
)

1364 if(
wšdow
 !ğ0 && 
	`sÿm³r_queue_wšdowcouÁ
() >= window)

1373 if(
	`sÿm³r_sourûs_g‘sk
(&
sk
è!ğ0 ||ask =ğ
NULL
)

1379 
	`sÿm³r_sk_´obe
(
sk
);

1380 
	`timev®_ıy
(&
Ï¡´obe
, &
Ãxrobe
);

1386 
	}
}

1393 
	$ş—nup
()

1395 
	`sÿm³r_fœew®l_ş—nup
();

1396 
	`sÿm³r_g‘¤c_ş—nup
();

1397 
	`sÿm³r_¹sock_ş—nup
();

1399 
	`sÿm³r_icmp4_ş—nup
();

1400 
	`sÿm³r_icmp6_ş—nup
();

1401 
	`sÿm³r_udp4_ş—nup
();

1402 
	`sÿm³r_tı4_ş—nup
();

1404 
	`sÿm³r_addr2mac_ş—nup
();

1406 
	`sÿm³r_do_Œaû_ş—nup
();

1407 
	`sÿm³r_do_pšg_ş—nup
();

1408 
	`sÿm³r_do_Œaûlb_ş—nup
();

1409 
	`sÿm³r_do_d—lŸs_ş—nup
();

1410 
	`sÿm³r_do_¡šg_ş—nup
();

1411 
	`sÿm³r_do_Ãighbourdisc_ş—nup
();

1412 
	`sÿm³r_do_tb™_ş—nup
();

1413 
	`sÿm³r_do_Œaûbox_ş—nup
();

1414 
	`sÿm³r_do_¢iff_ş—nup
();

1415 
	`sÿm³r_do_årštšg_ş—nup
();

1417 
	`sÿm³r_sourûs_ş—nup
();

1419 
	`sÿm³r_dl_ş—nup
();

1421 if(
İtiÚs
 & (
OPT_CTRL_PORT
|
OPT_CTRL_UNIX
))

1422 
	`sÿm³r_cÚŒŞ_ş—nup
();

1424 
	`sÿm³r_outfes_ş—nup
();

1425 
	`sÿm³r_fds_ş—nup
();

1427 #iâdeà
WITHOUT_PRIVSEP


1428 
	`sÿm³r_´iv£p_ş—nup
();

1432 if(
addrÿche
 !ğ
NULL
)

1434 
	`sÿm³r_addrÿche_ä“
(
addrÿche
);

1435 
addrÿche
 = 
NULL
;

1438 if(
mÚ™ÜÇme
 !ğ
NULL
)

1440 
	`ä“
(
mÚ™ÜÇme
);

1441 
mÚ™ÜÇme
 = 
NULL
;

1444 if(
commªd
 !ğ
NULL
)

1446 
	`ä“
(
commªd
);

1447 
commªd
 = 
NULL
;

1449 
	`sÿm³r_queue_ş—nup
();

1450 
	`sÿm³r_sk_ş—nup
();

1451 
	`sÿm³r_´obe_ş—nup
();

1453 #iâdeà
WITHOUT_DEBUGFILE


1454 if(
İtiÚs
 & 
OPT_DEBUGFILE
)

1456 
	`sÿm³r_debug_şo£
();

1460 
	`sÿm³r_osšfo_ş—nup
();

1462 if(
debugfe
 !ğ
NULL
)

1464 
	`ä“
(
debugfe
);

1465 
debugfe
 = 
NULL
;

1468 if(
pidfe
 !ğ
NULL
)

1470 
	`ä“
(
pidfe
);

1471 
pidfe
 = 
NULL
;

1475 
	}
}

1477 
	$maš
(
¬gc
, *
¬gv
[])

1479 
i
;

1481 #iâdeà
_WIN32


1482 
sigaùiÚ
 
si_§
;

1485 #ifdeà
_WIN32


1486 
WSADATA
 
w§D©a
;

1497 #ià
	`defšed
(
DMALLOC
)

1498 
	`ä“
(
	`m®loc
(1));

1499 #–ià!
	`defšed
 (
NDEBUG
è&& defšed(
__F»eBSD__
è&& 
__F»eBSD_v”siÚ
 >= 500000

1500 
_m®loc_İtiÚs
 = "AJ";

1503 #ifdeà
_WIN32


1504 
	`WSAS¹up
(
	`MAKEWORD
(2,2), &
w§D©a
);

1507 #iâdeà
_WIN32


1508 if(
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
è=ğ
SIG_ERR
)

1510 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot ignore SIGPIPE");

1514 
	`sigem±y£t
(&
si_§
.
§_mask
);

1515 
si_§
.
§_æags
 = 0;

1516 
si_§
.
§_hªdËr
 = 
sÿm³r_chld
;

1517 if(
	`sigaùiÚ
(
SIGCHLD
, &
si_§
, 0) == -1)

1519 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1525 
i
 = 
	`sÿm³r
(
¬gc
, 
¬gv
);

1527 
	`ş—nup
();

1529 #ifdeà
_WIN32


1530 
	`WSACËªup
();

1533  
i
;

1534 
	}
}

	@scamper.h

25 #iâdeà
__SCAMPER_H


26 
	#__SCAMPER_H


	)

28 
	#SCAMPER_PPS_MIN
 1

	)

29 
	#SCAMPER_PPS_DEF
 20

	)

30 
	#SCAMPER_PPS_MAX
 1000

	)

31 
sÿm³r_µs_g‘
();

32 
sÿm³r_µs_£t
(cÚ¡ 
µs
);

34 
	#SCAMPER_WINDOW_MIN
 0

	)

35 
	#SCAMPER_WINDOW_DEF
 0

	)

36 
	#SCAMPER_WINDOW_MAX
 65535

	)

37 
sÿm³r_wšdow_g‘
();

38 
sÿm³r_wšdow_£t
(cÚ¡ 
wšdow
);

40 
	#SCAMPER_COMMAND_DEF
 "Œaû"

	)

41 cÚ¡ *
sÿm³r_commªd_g‘
();

42 
sÿm³r_commªd_£t
(cÚ¡ *
commªd
);

44 cÚ¡ *
sÿm³r_mÚ™ÜÇme_g‘
();

45 
sÿm³r_mÚ™ÜÇme_£t
(cÚ¡ *
mÚ™ÜÇme
);

47 
sÿm³r_İtiÚ_dl
();

48 
sÿm³r_İtiÚ_¶ª‘Ïb
();

49 
sÿm³r_İtiÚ_noš™ndc
();

50 
sÿm³r_İtiÚ_£Ëù
();

51 
sÿm³r_İtiÚ_kqueue
();

52 
sÿm³r_İtiÚ_•Şl
();

53 
sÿm³r_İtiÚ_¿wtı
();

54 
sÿm³r_İtiÚ_debugf—µ’d
();

56 
sÿm³r_ex™wh’dÚe
(
Ú
);

58 
ušt16_t
 
sÿm³r_¥Üt_deçuÉ
();

60 
	#SCAMPER_VERSION
 "20130824"

	)

	@scamper_addr.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"mjl_¥ÏyŒ“.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"uts.h
"

44 cÚ¡ 
ušt32_t
 
	gušt32_Ãtmask
[] = {

55 cÚ¡ 
ušt32_t
 
	gušt32_ho¡mask
[] = {

66 #ifdeà
_WIN32


67 cÚ¡ 
ušt16_t
 
	gušt16_mask
[] = {

75 
v4_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

76 
v4_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

77 
v6_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

78 
v6_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

79 
‘h”Ãt_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

80 
fœewœe_cmp
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

82 
v4_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *, *, cÚ¡ 
size_t
);

83 
v6_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *, *, cÚ¡ 
size_t
);

84 
‘h”Ãt_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *, *, cÚ¡ 
size_t
);

85 
fœewœe_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *, *, cÚ¡ 
size_t
);

87 
v4_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *, cÚ¡ *, 
Ën
);

88 
v6_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *, cÚ¡ *, 
Ën
);

90 
v4_´efix
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

91 
v4_´efixho¡s
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

92 
v6_´efix
(cÚ¡ 
sÿm³r_addr_t
 *, const scamper_addr_t *);

94 
v4_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *);

95 
v6_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *);

97 
v4_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *, *, );

98 
v6_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *, *, );

100 
v4_i¤e£rved
(cÚ¡ 
sÿm³r_addr_t
 *);

102 
v6_isuniÿ¡
(cÚ¡ 
sÿm³r_addr_t
 *);

104 
	shªdËr


106 
	mty³
;

107 
size_t
 
	msize
;

108 (*
	mcmp
)(cÚ¡ 
sÿm³r_addr_t
 *
	m§
, cÚ¡ sÿm³r_addr_ˆ*
	msb
);

109 (*
	mhumª_cmp
)(cÚ¡ 
sÿm³r_addr_t
 *
	m§
, cÚ¡ sÿm³r_addr_ˆ*
	msb
);

110 (*
	mto¡r
)(cÚ¡ 
sÿm³r_addr_t
 *
	maddr
, *
	mbuf
, cÚ¡ 
size_t
 
	mËn
);

111 (*
	mš´efix
)(cÚ¡ 
sÿm³r_addr_t
 *
	maddr
, cÚ¡ *
	m´efix
, 
	mËn
);

112 (*
	m´efix
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
, cÚ¡ sÿm³r_addr_ˆ*
	mb
);

113 (*
	m´efixho¡s
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
, cÚ¡ sÿm³r_addr_ˆ*
	mb
);

114 (*
	mi¦škloÿl
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
);

115 (*
	mÃddr
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
, *
	mÃt
, 
	mÃ’
);

116 (*
	misuniÿ¡
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
);

117 (*
	mi¤e£rved
)(cÚ¡ 
sÿm³r_addr_t
 *
	ma
);

120 cÚ¡ 
hªdËr
 
	ghªdËrs
[] = {

122 
SCAMPER_ADDR_TYPE_IPV4
,

124 
v4_cmp
,

125 
v4_humª_cmp
,

126 
v4_to¡r
,

127 
v4_š´efix
,

128 
v4_´efix
,

129 
v4_´efixho¡s
,

130 
v4_i¦škloÿl
,

131 
v4_Ãddr
,

132 
NULL
,

133 
v4_i¤e£rved
,

136 
SCAMPER_ADDR_TYPE_IPV6
,

138 
v6_cmp
,

139 
v6_humª_cmp
,

140 
v6_to¡r
,

141 
v6_š´efix
,

142 
v6_´efix
,

143 
NULL
,

144 
v6_i¦škloÿl
,

145 
v6_Ãddr
,

146 
v6_isuniÿ¡
,

147 
NULL
,

150 
SCAMPER_ADDR_TYPE_ETHERNET
,

152 
‘h”Ãt_cmp
,

153 
‘h”Ãt_cmp
,

154 
‘h”Ãt_to¡r
,

155 
NULL
,

156 
NULL
,

157 
NULL
,

158 
NULL
,

159 
NULL
,

160 
NULL
,

161 
NULL
,

164 
SCAMPER_ADDR_TYPE_FIREWIRE
,

166 
fœewœe_cmp
,

167 
fœewœe_cmp
,

168 
fœewœe_to¡r
,

169 
NULL
,

170 
NULL
,

171 
NULL
,

172 
NULL
,

173 
NULL
,

174 
NULL
,

175 
NULL
,

179 
	ssÿm³r_addrÿche


181 
¥ÏyŒ“_t
 *
	mŒ“
[(
hªdËrs
)/(
hªdËr
)];

184 #iâdeà
NDEBUG


186 
	$sÿm³r_addr_debug
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

188 
buf
[128];

189 
	`årštf
(
¡d”r
, "scamper_addr_t: %s %d\n",

190 
	`sÿm³r_addr_to¡r
(
§
,
buf
,(buf)), sa->
»fút
);

192 
	}
}

195 
	#sÿm³r_addr_debug
(
§
è(()0)

	)

197 
	$v4_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

199 
š_addr
 *
a
, *
b
;

201 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
);

202 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
);

204 
a
 = (
š_addr
 *)
§
->
addr
;

205 
b
 = (
š_addr
 *)
sb
->
addr
;

207 if(
a
->
s_addr
 < 
b
->s_addr)  -1;

208 if(
a
->
s_addr
 > 
b
->s_addr)  1;

211 
	}
}

213 
	$v4_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

215 
ušt32_t
 
a
, 
b
;

217 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
);

218 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
);

220 
a
 = 
	`Áohl
(((
š_addr
 *)
§
->
addr
)->
s_addr
);

221 
b
 = 
	`Áohl
(((
š_addr
 *)
sb
->
addr
)->
s_addr
);

223 if(
a
 < 
b
)  -1;

224 if(
a
 > 
b
)  1;

227 
	}
}

229 
	$v4_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
addr
, *
buf
, cÚ¡ 
size_t
 
Ën
)

231 
	`addr_to¡r
(
AF_INET
, 
addr
->addr, 
buf
, 
Ën
);

233 
	}
}

235 
	$v4_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ *
p
, 
Ën
)

237 cÚ¡ 
š_addr
 *
addr
 = 
§
->addr;

238 cÚ¡ 
š_addr
 *
´efix
 = 
p
;

240 if(
Ën
 == 0)

243 if(
Ën
 > 32)

246 if(((
addr
->
s_addr
 ^ 
´efix
->s_addrè& 
	`htÚl
(
ušt32_Ãtmask
[
Ën
-1])) == 0)

250 
	}
}

252 
	$v4_´efix
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

254 cÚ¡ 
š_addr
 *
a
 = 
§
->
addr
;

255 cÚ¡ 
š_addr
 *
b
 = 
sb
->
addr
;

256 
i
;

258 
i
=32; i>0; i--)

260 if(((
a
->
s_addr
 ^ 
b
->s_addrè& 
	`htÚl
(
ušt32_Ãtmask
[
i
-1])) == 0)

264  
i
;

265 
	}
}

267 
	$v4_´efixho¡s
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

269 cÚ¡ 
š_addr
 *
a
 = 
§
->
addr
;

270 cÚ¡ 
š_addr
 *
b
 = 
sb
->
addr
;

271 
š_addr
 
c
;

272 
i
;

274 
i
=32; i>0; i--)

276 if(((
a
->
s_addr
 ^ 
b
->s_addrè& 
	`htÚl
(
ušt32_Ãtmask
[
i
-1])) == 0)

279 if(
i
 >= 31)

280  
i
;

282 
i
>0)

284 
c
.
s_addr
 = 
	`Áohl
(
a
->s_addrè& 
ušt32_ho¡mask
[
i
];

285 if(
c
.
s_addr
 =ğ0 || c.s_add¸=ğ
ušt32_ho¡mask
[
i
])

287 
i
--;

291 
c
.
s_addr
 = 
	`Áohl
(
b
->s_addrè& 
ušt32_ho¡mask
[
i
];

292 if(
c
.
s_addr
 =ğ0 || c.s_add¸=ğ
ušt32_ho¡mask
[
i
])

294 
i
--;

301  
i
;

302 
	}
}

309 
	$v4_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

311 cÚ¡ 
š_addr
 *
a
 = 
§
->
addr
;

312 if((
	`Áohl
(
a
->
s_addr
) & 0xffff0000) == 0xa9fe0000)

315 
	}
}

317 
	$v4_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *
§
, *
Ãt
, 
Ã’
)

319 cÚ¡ 
š_addr
 *
a
 = 
§
->
addr
;

320 
š_addr
 
p
;

321 if(
Ã’
 <ğ0 ||‚‘ËÀ> 32 || 
§
 =ğ
NULL
 || 
Ãt
 == NULL)

323 
p
.
s_addr
 = 
	`htÚl
(
	`Áohl
(
a
->s_addrè& 
ušt32_Ãtmask
[
Ã’
-1]);

324 
	`memıy
(
Ãt
, &
p
, (p));

326 
	}
}

328 
	$v4_i¤e£rved
(cÚ¡ 
sÿm³r_addr_t
 *
a
)

330 cÚ¡ 
ušt32_t
 
´efs
[][2] = {

347 cÚ¡ 
´efc
 = 15;

348 
ušt32_t
 
addr
 = 
	`Áohl
(((cÚ¡ 
š_addr
 *)
a
->addr)->
s_addr
);

349 
i
;

350 
i
=0; i<
´efc
; i++)

351 if((
addr
 & 
´efs
[
i
][1]) ==…refs[i][0])

354 
	}
}

356 
	$v6_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

358 
š6_addr
 *
a
, *
b
;

359 
i
;

361 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
);

362 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
);

364 
a
 = (
š6_addr
 *)
§
->
addr
;

365 
b
 = (
š6_addr
 *)
sb
->
addr
;

367 #iâdeà
_WIN32


368 
i
=0; i<4; i++)

370 if(
a
->
s6_addr32
[
i
] < 
b
->s6_addr32[i])  -1;

371 if(
a
->
s6_addr32
[
i
] > 
b
->s6_addr32[i])  1;

374 
i
=0; i<8; i++)

376 if(
a
->
u
.
WÜd
[
i
] < 
b
->u.Word[i])  -1;

377 if(
a
->
u
.
WÜd
[
i
] > 
b
->u.Word[i])  1;

382 
	}
}

384 
	$v6_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

386 
š6_addr
 *
a
, *
b
;

387 
i
;

389 #iâdeà
_WIN32


390 
ušt32_t
 
as
, 
bs
;

392 
ušt16_t
 
as
, 
bs
;

395 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
);

396 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
);

398 
a
 = (
š6_addr
 *)
§
->
addr
;

399 
b
 = (
š6_addr
 *)
sb
->
addr
;

401 #iâdeà
_WIN32


402 
i
=0; i<4; i++)

404 
as
 = 
	`Áohl
(
a
->
s6_addr32
[
i
]);

405 
bs
 = 
	`Áohl
(
b
->
s6_addr32
[
i
]);

407 if(
as
 < 
bs
)  -1;

408 if(
as
 > 
bs
)  1;

411 
i
=0; i<8; i++)

413 
as
 = 
	`Áohs
(
a
->
u
.
WÜd
[
i
]);

414 
bs
 = 
	`Áohs
(
b
->
u
.
WÜd
[
i
]);

416 if(
as
 < 
bs
)  -1;

417 if(
as
 > 
bs
)  1;

422 
	}
}

424 
	$v6_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
addr
, *
buf
, cÚ¡ 
size_t
 
Ën
)

426 
	`addr_to¡r
(
AF_INET6
, 
addr
->addr, 
buf
, 
Ën
);

428 
	}
}

430 
	$v6_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ *
p
, 
Ën
)

432 cÚ¡ 
š6_addr
 *
addr
 = 
§
->addr;

433 cÚ¡ 
š6_addr
 *
´efix
 = 
p
;

434 
i
;

436 #iâdeà
_WIN32


437 
ušt32_t
 
mask
;

439 
ušt16_t
 
mask
;

442 if(
Ën
 == 0)

445 if(
Ën
 > 128)

448 #iâdeà
_WIN32


449 
i
=0; i<4; i++)

455 if(
Ën
 > 32)

456 
mask
 = 
ušt32_Ãtmask
[31];

458 
mask
 = 
	`htÚl
(
ušt32_Ãtmask
[
Ën
-1]);

460 if(((
addr
->
s6_addr32
[
i
] ^ 
´efix
->s6_addr32[i]è& 
mask
) != 0)

463 if(
Ën
 <= 32)

466 
Ën
 -= 32;

469 
i
=0; i<8; i++)

471 if(
Ën
 > 16)

472 
mask
 = 
ušt16_mask
[15];

474 
mask
 = 
	`htÚs
(
ušt16_mask
[
Ën
-1]);

476 if(((
addr
->
u
.
WÜd
[
i
] ^ 
´efix
->u.WÜd[i]è& 
mask
) != 0)

479 if(
Ën
 <= 16)

482 
Ën
 -= 16;

488 
	}
}

490 
	$v6_´efix
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

492 cÚ¡ 
š6_addr
 *
a
 = 
§
->
addr
;

493 cÚ¡ 
š6_addr
 *
b
 = 
sb
->
addr
;

494 
ušt32_t
 
ua
, 
ub
;

495 
i
, 
j
, 
x
 = 0;

497 
i
=0; i<4; i++)

499 
ua
 = 
a
->
s6_addr32
[
i
];

500 
ub
 = 
b
->
s6_addr32
[
i
];

502 if(
ua
 =ğ
ub
)

504 
x
 += 32;

508 
j
=0; j<32; j++)

510 if(((
ua
 ^ 
ub
è& 
	`htÚl
(
ušt32_Ãtmask
[
j
])) != 0)

511  
x
;

512 
x
++;

516  
x
;

517 
	}
}

524 
	$v6_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

526 cÚ¡ 
š6_addr
 *
a
 = 
§
->
addr
;

527 if(
a
->
s6_addr
[0] == 0xfe && (a->s6_addr[1] & 0xc0) == 0x80)

530 
	}
}

532 
	$v6_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *
§
, *
Ãt
, 
Æ
)

534 cÚ¡ 
š6_addr
 *
a
 = 
§
->
addr
;

535 
š6_addr
 
p
;

536 
i
;

538 if(
Æ
 <ğ0 ||‚È> 128 || 
§
 =ğ
NULL
 || 
Ãt
 == NULL)

540 
	`mem£t
(&
p
, 0, (p));

542 
i
=0; i<4; i++)

544 if(
Æ
 >= 32)

545 
p
.
s6_addr32
[
i
] = 
a
->s6_addr32[i];

547 
p
.
s6_addr32
[
i
] = 
	`htÚl
(
	`Áohl
(
a
->s6_addr32[i]è& 
ušt32_Ãtmask
[
Æ
-1]);

549 if(
Æ
 <= 32)

551 
Æ
 -= 32;

554 
	`memıy
(
Ãt
, &
p
, (p));

556 
	}
}

558 
	$v6_isuniÿ¡
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

560 cÚ¡ 
š6_addr
 *
a
 = 
§
->
addr
;

561 if((
a
->
s6_addr
[0] & 0xe0) == 0x20)

564 
	}
}

566 
	$‘h”Ãt_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

568 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_ETHERNET
);

569 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_ETHERNET
);

571  
	`memcmp
(
§
->
addr
, 
sb
->addr, 6);

572 
	}
}

574 
	$‘h”Ãt_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
addr
,

575 *
buf
, cÚ¡ 
size_t
 
Ën
)

577 
ušt8_t
 *
mac
 = (ušt8_ˆ*)
addr
->addr;

579 
	`¢´štf
(
buf
, 
Ën
, "%02x:%02x:%02x:%02x:%02x:%02x",

580 
mac
[0], mac[1], mac[2], mac[3], mac[4], mac[5]);

583 
	}
}

585 
	$fœewœe_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ sÿm³r_addr_ˆ*
sb
)

587 
	`as£¹
(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_FIREWIRE
);

588 
	`as£¹
(
sb
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_FIREWIRE
);

590  
	`memcmp
(
§
->
addr
, 
sb
->addr, 8);

591 
	}
}

593 
	$fœewœe_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
addr
,

594 *
buf
, cÚ¡ 
size_t
 
Ën
)

596 
ušt8_t
 *
Îa
 = (ušt8_ˆ*)
addr
->addr;

598 
	`¢´štf
(
buf
, 
Ën
, "%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x",

599 
Îa
[0],†la[1],†la[2],†la[3],†la[4],†la[5],†la[6],†la[7]);

602 
	}
}

604 
size_t
 
	$sÿm³r_addr_size
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

606  
hªdËrs
[
§
->
ty³
-1].
size
;

607 
	}
}

609 cÚ¡ *
	$sÿm³r_addr_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
§
,

610 *
d¡
, cÚ¡ 
size_t
 
size
)

612 
hªdËrs
[
§
->
ty³
-1].
	`to¡r
(§, 
d¡
, 
size
);

613  
d¡
;

614 
	}
}

616 
sÿm³r_addr_t
 *
	$sÿm³r_addr_®loc
(cÚ¡ 
ty³
, cÚ¡ *
addr
)

618 
sÿm³r_addr_t
 *
§
;

620 
	`as£¹
(
addr
 !ğ
NULL
);

621 
	`as£¹
(
ty³
-1 >= 0);

622 
	`as£¹
((
size_t
)(
ty³
-1è< (
hªdËrs
)/(
hªdËr
));

624 if((
§
 = 
	`m®loc
((
sÿm³r_addr_t
))è!ğ
NULL
)

626 if((
§
->
addr
 = 
	`memdup
×ddr, 
hªdËrs
[
ty³
-1].
size
)è=ğ
NULL
)

628 
	`ä“
(
§
);

629  
NULL
;

632 
§
->
ty³
 =ype;

633 
§
->
»fút
 = 1;

634 
§
->
š‹º®
 = 
NULL
;

637  
§
;

638 
	}
}

647 
sÿm³r_addr_t
 *
	$sÿm³r_addr_»sŞve
(cÚ¡ 
af
, cÚ¡ *
addr
)

649 
addršfo
 
hšts
, *
»s
, *
»s0
;

650 
sÿm³r_addr_t
 *
§
 = 
NULL
;

651 *
va
;

653 
	`mem£t
(&
hšts
, 0, (
addršfo
));

654 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

655 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

656 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_UDP
;

657 
hšts
.
ai_çmy
 = 
af
;

659 if(
	`g‘addršfo
(
addr
, 
NULL
, &
hšts
, &
»s0
) != 0 ||„es0 == NULL)

661  
NULL
;

664 
»s
 = 
»s0
;„e !ğ
NULL
;„e ğ»s->
ai_Ãxt
)

666 if(
»s
->
ai_çmy
 =ğ
PF_INET
)

668 
va
 = &((
sockaddr_š
 *)
»s
->
ai_addr
)->
sš_addr
;

669 
§
 = 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
, 
va
);

672 if(
»s
->
ai_çmy
 =ğ
PF_INET6
)

674 
va
 = &((
sockaddr_š6
 *)
»s
->
ai_addr
)->
sš6_addr
;

675 
§
 = 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
, 
va
);

680 
	`ä“addršfo
(
»s0
);

681  
§
;

682 
	}
}

684 
	$sÿm³r_addr_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *
addr
, cÚ¡ *
p
, 
Ën
)

686 if(
hªdËrs
[
addr
->
ty³
-1].
š´efix
 !ğ
NULL
)

687  
hªdËrs
[
addr
->
ty³
-1].
	`š´efix
×ddr, 
p
, 
Ën
);

689 
	}
}

691 
	$sÿm³r_addr_´efix
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
)

693 if(
a
->
ty³
 !ğ
b
->ty³ || 
hªdËrs
[a->ty³-1].
´efix
 =ğ
NULL
)

696  
hªdËrs
[
a
->
ty³
-1].
	`´efix
×, 
b
);

697 
	}
}

699 
	$sÿm³r_addr_´efixho¡s
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
)

701 if(
a
->
ty³
 !ğ
b
->ty³ || 
hªdËrs
[a->ty³-1].
´efixho¡s
 =ğ
NULL
)

704  
hªdËrs
[
a
->
ty³
-1].
	`´efixho¡s
×, 
b
);

705 
	}
}

707 
	$sÿm³r_addr_af
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

709 if(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

710  
AF_INET
;

711 if(
§
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

712  
AF_INET6
;

715 
	}
}

717 
	$sÿm³r_addr_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *
a
)

719 if(
hªdËrs
[
a
->
ty³
-1].
i¦škloÿl
 =ğ
NULL
)

721  
hªdËrs
[
a
->
ty³
-1].
	`i¦škloÿl
(a);

722 
	}
}

724 
	$sÿm³r_addr_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *
a
, *
Ãt
, 
Ã’
)

726 if(
hªdËrs
[
a
->
ty³
-1].
Ãddr
 =ğ
NULL
)

728  
hªdËrs
[
a
->
ty³
-1].
	`Ãddr
×, 
Ãt
, 
Ã’
);

729 
	}
}

731 
	$sÿm³r_addr_i¤fc1918
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

733 
ušt32_t
 
x
;

735 if(
§
->
ty³
 !ğ
SCAMPER_ADDR_TYPE_IPV4
)

738 
x
 = 
	`Áohl
(((cÚ¡ 
š_addr
 *)
§
->
addr
)->
s_addr
);

739 if((
x
 & 0xff000000) == 0x0a000000 ||

740 (
x
 & 0xfff00000) == 0xac100000 ||

741 (
x
 & 0xffff0000) == 0xc0a80000)

746 
	}
}

748 
	$sÿm³r_addr_is6to4
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

750 cÚ¡ 
š6_addr
 *
a
;

752 if(
§
->
ty³
 !ğ
SCAMPER_ADDR_TYPE_IPV6
)

755 
a
 = 
§
->
addr
;

756 #iâdeà
_WIN32


757 if(
a
->
s6_addr
[0] == 0x20 &&‡->s6_addr[1] == 0x02)

760 if(
a
->
u
.
WÜd
[0] =ğ
	`htÚs
(0x2002))

765 
	}
}

767 
	$sÿm³r_addr_isuniÿ¡
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

769 if(
hªdËrs
[
§
->
ty³
-1].
isuniÿ¡
 =ğ
NULL
)

771  
hªdËrs
[
§
->
ty³
-1].
	`isuniÿ¡
(sa);

772 
	}
}

774 
	$sÿm³r_addr_i¤e£rved
(cÚ¡ 
sÿm³r_addr_t
 *
§
)

776 if(
hªdËrs
[
§
->
ty³
-1].
i¤e£rved
 =ğ
NULL
)

778  
hªdËrs
[
§
->
ty³
-1].
	`i¤e£rved
(sa);

779 
	}
}

781 
sÿm³r_addr_t
 *
	$sÿm³r_addrÿche_g‘
(
sÿm³r_addrÿche_t
 *
ac
,

782 cÚ¡ 
ty³
, cÚ¡ *
addr
)

784 
sÿm³r_addr_t
 *
§
, 
fšdme
;

786 
fšdme
.
ty³
 =ype;

787 
fšdme
.
addr
 = (*)addr;

789 if((
§
 = 
	`¥ÏyŒ“_fšd
(
ac
->
Œ“
[
ty³
-1], &
fšdme
)è!ğ
NULL
)

791 
	`as£¹
(
§
->
š‹º®
 =ğ
ac
);

792 
§
->
»fút
++;

793 
	`sÿm³r_addr_debug
(
§
);

794  
§
;

797 if((
§
 = 
	`sÿm³r_addr_®loc
(
ty³
, 
addr
)è!ğ
NULL
)

799 if(
	`¥ÏyŒ“_š£¹
(
ac
->
Œ“
[
ty³
-1], 
§
è=ğ
NULL
)

801 
”r
;

803 
§
->
š‹º®
 = 
ac
;

806 
	`sÿm³r_addr_debug
(
§
);

808  
§
;

810 
”r
:

811 
	`sÿm³r_addr_ä“
(
§
);

812  
NULL
;

813 
	}
}

822 
sÿm³r_addr_t
 *
	$sÿm³r_addrÿche_»sŞve
(
sÿm³r_addrÿche_t
 *
addrÿche
,

823 cÚ¡ 
af
, cÚ¡ *
addr
)

825 
addršfo
 
hšts
, *
»s
, *
»s0
;

826 
sÿm³r_addr_t
 *
§
 = 
NULL
;

827 *
va
;

829 
	`mem£t
(&
hšts
, 0, (
addršfo
));

830 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

831 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

832 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_UDP
;

833 
hšts
.
ai_çmy
 = 
af
;

835 if(
	`g‘addršfo
(
addr
, 
NULL
, &
hšts
, &
»s0
) != 0 ||„es0 == NULL)

837  
NULL
;

840 
»s
 = 
»s0
;„e !ğ
NULL
;„e ğ»s->
ai_Ãxt
)

842 if(
»s
->
ai_çmy
 =ğ
PF_INET
)

844 
va
 = &((
sockaddr_š
 *)
»s
->
ai_addr
)->
sš_addr
;

845 
§
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_IPV4
, 
va
);

848 if(
»s
->
ai_çmy
 =ğ
PF_INET6
)

850 
va
 = &((
sockaddr_š6
 *)
»s
->
ai_addr
)->
sš6_addr
;

851 
§
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_IPV6
, 
va
);

856 
	`ä“addršfo
(
»s0
);

857  
§
;

858 
	}
}

860 
sÿm³r_addr_t
 *
	$sÿm³r_addr_u£
(
sÿm³r_addr_t
 *
§
)

862 if(
§
 !ğ
NULL
)

864 
§
->
»fút
++;

865 
	`sÿm³r_addr_debug
(
§
);

867  
§
;

868 
	}
}

870 
	$sÿm³r_addr_ä“
(
sÿm³r_addr_t
 *
§
)

872 
sÿm³r_addrÿche_t
 *
ac
;

874 if(
§
 =ğ
NULL
)

879 
	`as£¹
(
§
->
»fút
 > 0);

881 if(--
§
->
»fút
 > 0)

883 
	`sÿm³r_addr_debug
(
§
);

887 if((
ac
 = 
§
->
š‹º®
è!ğ
NULL
)

889 
	`¥ÏyŒ“_»move_™em
(
ac
->
Œ“
[
§
->
ty³
-1], sa);

892 
	`sÿm³r_addr_debug
(
§
);

894 
	`ä“
(
§
->
addr
);

895 
	`ä“
(
§
);

897 
	}
}

899 
	$sÿm³r_addr_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
)

901 
	`as£¹
(
a
->
ty³
 > 0 &&‡->ty³ <ğ(
hªdËrs
)/(
hªdËr
));

902 
	`as£¹
(
b
->
ty³
 > 0 && b->ty³ <ğ(
hªdËrs
)/(
hªdËr
));

908 if(
a
 =ğ
b
)

917 if(
a
->
ty³
 =ğ
b
->type)

919  
hªdËrs
[
a
->
ty³
-1].
	`cmp
×, 
b
);

923 if(
a
->
ty³
 < 
b
->type)

931 
	}
}

933 
	$sÿm³r_addr_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
)

935 
	`as£¹
(
a
->
ty³
 > 0 &&‡->ty³ <ğ(
hªdËrs
)/(
hªdËr
));

936 
	`as£¹
(
b
->
ty³
 > 0 && b->ty³ <ğ(
hªdËrs
)/(
hªdËr
));

942 if(
a
 =ğ
b
)

951 if(
a
->
ty³
 =ğ
b
->type)

953  
hªdËrs
[
a
->
ty³
-1].
	`humª_cmp
×, 
b
);

957 if(
a
->
ty³
 < 
b
->type)

965 
	}
}

967 
	$sÿm³r_addr_¿w_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ *
¿w
)

969  
	`memcmp
(
a
->
addr
, 
¿w
, 
hªdËrs
[a->
ty³
-1].
size
);

970 
	}
}

972 
	$ä“_cb
(*
node
)

974 ((
sÿm³r_addr_t
 *)
node
)->
š‹º®
 = 
NULL
;

976 
	}
}

978 
	$sÿm³r_addrÿche_ä“
(
sÿm³r_addrÿche_t
 *
ac
)

980 
i
;

982 
i
=((
hªdËrs
)/(
hªdËr
))-1; i>=0; i--)

984 if(
ac
->
Œ“
[
i
] !ğ
NULL
è
	`¥ÏyŒ“_ä“
×c->Œ“[i], 
ä“_cb
);

986 
	`ä“
(
ac
);

989 
	}
}

991 
sÿm³r_addrÿche_t
 *
	$sÿm³r_addrÿche_®loc
()

993 
sÿm³r_addrÿche_t
 *
ac
;

994 
i
;

996 if((
ac
 = 
	`m®loc
((
sÿm³r_addrÿche_t
))è=ğ
NULL
)

998  
NULL
;

1000 
	`mem£t
(
ac
, 0, (
sÿm³r_addrÿche_t
));

1002 
i
=((
hªdËrs
)/(
hªdËr
))-1; i>=0; i--)

1004 
ac
->
Œ“
[
i
] = 
	`¥ÏyŒ“_®loc
((
¥ÏyŒ“_cmp_t
)
hªdËrs
[i].
cmp
);

1005 if(
ac
->
Œ“
[
i
] =ğ
NULL
è
”r
;

1008  
ac
;

1010 
”r
:

1011 
	`sÿm³r_addrÿche_ä“
(
ac
);

1012  
NULL
;

1013 
	}
}

	@scamper_addr.h

26 #iâdeà
__SCAMPER_ADDR_H


27 
	#__SCAMPER_ADDR_H


	)

46 
	#SCAMPER_ADDR_TYPE_IPV4
 0x01

	)

47 
	#SCAMPER_ADDR_TYPE_IPV6
 0x02

	)

48 
	#SCAMPER_ADDR_TYPE_ETHERNET
 0x03

	)

49 
	#SCAMPER_ADDR_TYPE_FIREWIRE
 0x04

	)

51 
	#SCAMPER_ADDR_TYPE_MAX
 
SCAMPER_ADDR_TYPE_FIREWIRE


	)

53 
	#SCAMPER_ADDR_TYPE_IS_IPV4
(
a
è(×)->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

	)

54 
	#SCAMPER_ADDR_TYPE_IS_IPV6
(
a
è(×)->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

	)

56 
	#SCAMPER_ADDR_TYPE_IS_IP
(
a
è(×)->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 || \

57 (
a
)->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

	)

67 
	ssÿm³r_addr


69 
	mty³
;

70 *
	maddr
;

71 
	m»fút
;

72 *
	mš‹º®
;

73 } 
	tsÿm³r_addr_t
;

106 
sÿm³r_addr_t
 *
sÿm³r_addr_®loc
(cÚ¡ 
ty³
, cÚ¡ *
addr
);

107 
sÿm³r_addr_t
 *
sÿm³r_addr_u£
(sÿm³r_addr_ˆ*
§
);

108 
sÿm³r_addr_ä“
(
sÿm³r_addr_t
 *
§
);

109 
sÿm³r_addr_t
 *
sÿm³r_addr_»sŞve
(cÚ¡ 
af
, cÚ¡ *
¡r
);

110 
sÿm³r_addr_af
(cÚ¡ 
sÿm³r_addr_t
 *
§
);

111 
sÿm³r_addr_š´efix
(cÚ¡ 
sÿm³r_addr_t
 *
§
, cÚ¡ *
p
, 
Ën
);

112 
sÿm³r_addr_´efix
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
);

113 
sÿm³r_addr_´efixho¡s
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
);

114 
sÿm³r_addr_Ãddr
(cÚ¡ 
sÿm³r_addr_t
 *
a
, *
Ãt
, 
Ã’
);

122 
	#sÿm³r_addr_®loc_v4
(
addr
) \

123 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
, 
addr
)

	)

125 
	#sÿm³r_addr_®loc_v6
(
addr
) \

126 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
, 
addr
)

	)

128 
	#sÿm³r_addr_®loc_‘h”Ãt
(
addr
) \

129 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_ETHERNET
, 
addr
)

	)

131 
	#sÿm³r_addr_®loc_fœewœe
(
addr
) \

132 
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_FIREWIRE
, 
addr
)

	)

138 
sÿm³r_addr_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
);

139 
sÿm³r_addr_humª_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ sÿm³r_addr_ˆ*
b
);

140 
sÿm³r_addr_¿w_cmp
(cÚ¡ 
sÿm³r_addr_t
 *
a
, cÚ¡ *
¿w
);

147 cÚ¡ *
sÿm³r_addr_to¡r
(cÚ¡ 
sÿm³r_addr_t
 *
§
,

148 *
d¡
, cÚ¡ 
size_t
 
size
);

155 
size_t
 
sÿm³r_addr_size
(cÚ¡ 
sÿm³r_addr_t
 *
§
);

169 
sÿm³r_addrÿche
 
	tsÿm³r_addrÿche_t
;

170 
sÿm³r_addrÿche_t
 *
sÿm³r_addrÿche_®loc
();

171 
sÿm³r_addrÿche_ä“
(
sÿm³r_addrÿche_t
 *
ac
);

178 
sÿm³r_addr_t
 *
sÿm³r_addrÿche_g‘
(
sÿm³r_addrÿche_t
 *
ac
,

179 cÚ¡ 
ty³
, cÚ¡ *
addr
);

181 
sÿm³r_addr_t
 *
sÿm³r_addrÿche_»sŞve
(
sÿm³r_addrÿche_t
 *
ac
,

182 cÚ¡ 
af
, cÚ¡ *
addr
);

191 
sÿm³r_addr_i¦škloÿl
(cÚ¡ 
sÿm³r_addr_t
 *
a
);

192 
sÿm³r_addr_i¤fc1918
(cÚ¡ 
sÿm³r_addr_t
 *
a
);

193 
sÿm³r_addr_isuniÿ¡
(cÚ¡ 
sÿm³r_addr_t
 *
a
);

194 
sÿm³r_addr_is6to4
(cÚ¡ 
sÿm³r_addr_t
 *
a
);

195 
sÿm³r_addr_i¤e£rved
(cÚ¡ 
sÿm³r_addr_t
 *
a
);

203 
	#sÿm³r_addrÿche_g‘_v4
(
addrÿche
, 
addr
) \

204 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_IPV4
, 
addr
)

	)

206 
	#sÿm³r_addrÿche_g‘_v6
(
addrÿche
, 
addr
) \

207 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_IPV6
, 
addr
)

	)

209 
	#sÿm³r_addrÿche_g‘_‘h”Ãt
(
addrÿche
, 
addr
) \

210 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_ETHERNET
, 
addr
)

	)

212 
	#sÿm³r_addrÿche_g‘_fœewœe
(
addrÿche
, 
addr
) \

213 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
SCAMPER_ADDR_TYPE_FIREWIRE
, 
addr
)

	)

	@scamper_addr2mac.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 #ià
defšed
(
__APPLE__
)

37 
	#HAVE_BSD_ARPCACHE


	)

40 #ià
defšed
(
__F»eBSD__
)

41 
	#HAVE_BSD_ARPCACHE


	)

44 #ià
defšed
(
__N‘BSD__
)

45 
	#HAVE_BSD_ARPCACHE


	)

48 #ià
defšed
(
__O³nBSD__
)

49 
	#HAVE_BSD_ARPCACHE


	)

52 #ià
defšed
(
__D¿gÚFly__
)

53 
	#HAVE_BSD_ARPCACHE


	)

56 #ià
defšed
(
__lšux__
)

57 
	sndmsg


59 
	mndm_çmy
;

60 
	mndm_·d1
;

61 
	mndm_·d2
;

62 
	mndm_ifšdex
;

63 
ušt16_t
 
	mndm_¡©e
;

64 
ušt8_t
 
	mndm_æags
;

65 
ušt8_t
 
	mndm_ty³
;

68 
	ssockaddr_Æ


70 
§_çmy_t
 
	mÆ_çmy
;

71 
	mÆ_·d
;

72 
ušt32_t
 
	mÆ_pid
;

73 
ušt32_t
 
	mÆ_groups
;

76 
	sÆmsghdr


78 
ušt32_t
 
	mÆmsg_Ën
;

79 
ušt16_t
 
	mÆmsg_ty³
;

80 
ušt16_t
 
	mÆmsg_æags
;

81 
ušt32_t
 
	mÆmsg_£q
;

82 
ušt32_t
 
	mÆmsg_pid
;

85 
	s¹©Œ


87 
	m¹a_Ën
;

88 
	m¹a_ty³
;

91 
	#NLMSG_ERROR
 0x2

	)

92 
	#NLMSG_DONE
 0x3

	)

93 
	#NLMSG_ALIGNTO
 4

	)

94 
	#NLMSG_ALIGN
(
Ën
è((Ö’)+
NLMSG_ALIGNTO
-1è& ~(NLMSG_ALIGNTO-1))

	)

95 
	#NLMSG_LENGTH
(
Ën
è(Ö’)+
	`NLMSG_ALIGN
((
Æmsghdr
)))

	)

96 
	#NLMSG_DATA
(
Æh
è((*)(((*êlhè+ 
	`NLMSG_LENGTH
(0)))

	)

97 
	#NLMSG_NEXT
(
Æh
,
Ën
è(Ö’è-ğ
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
), \

98 (
Æmsghdr
*)(((*)(
Æh
)è+ 
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
)))

	)

99 
	#NLMSG_OK
(
Æh
,
Ën
è(Ö’è> 0 && (Æh)->
Æmsg_Ën
 >ğ(
Æmsghdr
) && \

100 (
Æh
)->
Æmsg_Ën
 <ğ(
Ën
))

	)

102 
	#RTA_ALIGNTO
 4

	)

103 
	#RTA_ALIGN
(
Ën
è((Ö’)+
RTA_ALIGNTO
-1è& ~(RTA_ALIGNTO-1))

	)

104 
	#RTA_LENGTH
(
Ën
è(
	`RTA_ALIGN
((
¹©Œ
)è+ (Ën))

	)

105 
	#RTA_DATA
(
¹a
è((*)(((*)Ô)è+ 
	`RTA_LENGTH
(0)))

	)

106 
	#RTA_OK
(
¹a
,
Ën
è(Ö’è> 0 && (¹a)->
¹a_Ën
 >ğ(
¹©Œ
) && \

107 (
¹a
)->
¹a_Ën
 <ğ(
Ën
))

	)

108 
	#RTA_NEXT
(
¹a
,
©ŒËn
è(×‰¾’è-ğ
	`RTA_ALIGN
(Ô)->
¹a_Ën
), \

109 (
¹©Œ
*)(((*)(
¹a
)è+ 
	`RTA_ALIGN
(Ô)->
¹a_Ën
)))

	)

110 
	#RTA_PAYLOAD
(
¹a
è(()(Ô)->
¹a_Ën
è- 
	`RTA_LENGTH
(0))

	)

112 
	#NDA_DST
 1

	)

113 
	#NDA_LLADDR
 2

	)

114 
	#NDA_MAX
 (
NDA_LLADDR
+1)

	)

115 
	#NDA_RTA
(
r
è((
¹©Œ
*)(((*)Ô)è+ 
	`NLMSG_ALIGN
((
ndmsg
))))

	)

117 
	#RTM_BASE
 0x10

	)

118 
	#RTM_NEWNEIGH
 (
RTM_BASE
+12)

	)

119 
	#RTM_GETNEIGH
 (
RTM_BASE
+14)

	)

120 
	#NLM_F_REQUEST
 1

	)

121 
	#NLM_F_ROOT
 0x100

	)

122 
	#NLM_F_MATCH
 0x200

	)

123 
	#NETLINK_ROUTE
 0

	)

124 
	#NUD_REACHABLE
 0x02

	)

128 
	~"sÿm³r.h
"

129 
	~"sÿm³r_addr.h
"

130 
	~"sÿm³r_addr2mac.h
"

131 
	~"sÿm³r_¹sock.h
"

132 
	~"sÿm³r_debug.h
"

133 
	~"uts.h
"

134 
	~"mjl_¥ÏyŒ“.h
"

136 
	saddr2mac


138 
	mifšdex
;

139 
sÿm³r_addr_t
 *
	m
;

140 
sÿm³r_addr_t
 *
	mmac
;

141 
time_t
 
	mexpœe
;

142 } 
	taddr2mac_t
;

144 
¥ÏyŒ“_t
 *
	gŒ“
 = 
NULL
;

145 
sÿm³r_addrÿche_t
 *
addrÿche
;

147 
	$addr2mac_cmp
(cÚ¡ 
addr2mac_t
 *
a
, cÚ¡‡ddr2mac_ˆ*
b
)

149 if(
a
->
ifšdex
 < 
b
->ifindex)  -1;

150 if(
a
->
ifšdex
 > 
b
->ifindex)  1;

151  
	`sÿm³r_addr_cmp
(
a
->

, 
b
->ip);

152 
	}
}

154 
	$addr2mac_ä“
(
addr2mac_t
 *
addr2mac
)

156 if(
addr2mac
->

 !ğ
NULL
è
	`sÿm³r_addr_ä“
(addr2mac->ip);

157 if(
addr2mac
->
mac
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(addr2mac->mac);

158 
	`ä“
(
addr2mac
);

160 
	}
}

162 
addr2mac_t
 *
	$addr2mac_®loc
(cÚ¡ 
ifšdex
, 
sÿm³r_addr_t
 *

,

163 
sÿm³r_addr_t
 *
mac
, 
time_t
 
expœe
)

165 
addr2mac_t
 *
addr2mac
;

167 if((
addr2mac
 = 
	`m®loc_z”o
((
addr2mac_t
))è=ğ
NULL
)

169 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc‡ddr2mac");

170  
NULL
;

173 
addr2mac
->
ifšdex
 = ifindex;

174 
addr2mac
->

 = i°!ğ
NULL
 ? 
	`sÿm³r_addr_u£
(ip) : NULL;

175 
addr2mac
->
mac
 = maø!ğ
NULL
 ? 
	`sÿm³r_addr_u£
(mac) : NULL;

176 
addr2mac
->
expœe
 =ƒxpire;

177  
addr2mac
;

178 
	}
}

180 
	$addr2mac_add
(cÚ¡ 
ifšdex
, cÚ¡ 
ty³
, cÚ¡ *
¿w
,

181 cÚ¡ *
maüaw
, cÚ¡ 
time_t
 
expœe
)

183 cÚ¡ 
mt
 = 
SCAMPER_ADDR_TYPE_ETHERNET
;

184 
sÿm³r_addr_t
 *
mac
 = 
NULL
;

185 
sÿm³r_addr_t
 *

 = 
NULL
;

186 
addr2mac_t
 *
addr2mac
 = 
NULL
;

187 
¡r
[128], 
mac¡r
[128];

189 if((

 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
ty³
, 
¿w
)è=ğ
NULL
)

191 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ip");

192 
”r
;

195 if((
mac
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
mt
, 
maüaw
)è=ğ
NULL
)

197 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get mac");

198 
”r
;

201 if((
addr2mac
 = 
	`addr2mac_®loc
(
ifšdex
, 

, 
mac
, 
expœe
)è=ğ
NULL
)

203 
”r
;

206 
	`sÿm³r_addr_ä“
(

); i°ğ
NULL
;

207 
	`sÿm³r_addr_ä“
(
mac
); maøğ
NULL
;

209 if(
	`¥ÏyŒ“_š£¹
(
Œ“
, 
addr2mac
è=ğ
NULL
)

211 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd %s:%soree",

212 
	`sÿm³r_addr_to¡r
(
addr2mac
->

, 
¡r
, (ipstr)),

213 
	`sÿm³r_addr_to¡r
(
addr2mac
->
mac
, 
mac¡r
, (macstr)));

214 
”r
;

217 
	`sÿm³r_debug
(
__func__
, "ifšdex %d i°% maø% expœ%d", 
ifšdex
,

218 
	`sÿm³r_addr_to¡r
(
addr2mac
->

, 
¡r
, (ipstr)),

219 
	`sÿm³r_addr_to¡r
(
addr2mac
->
mac
, 
mac¡r
, (macstr)),

220 
expœe
);

223 
”r
:

224 if(
addr2mac
 !ğ
NULL
è
	`addr2mac_ä“
(addr2mac);

225 if(
mac
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(mac);

226 if(

 !ğ
NULL
è
	`sÿm³r_addr_ä“
(ip);

228 
	}
}

230 
	$sÿm³r_addr2mac_add
(
ifšdex
, 
sÿm³r_addr_t
 *

, sÿm³r_addr_ˆ*
mac
)

232 
addr2mac_t
 *
a2m
 = 
NULL
;

233 
¡r
[128], 
mac¡r
[128];

235 if(
	`sÿm³r_addr2mac_whohas
(
ifšdex
, 

è!ğ
NULL
)

238 if((
a2m
 = 
	`addr2mac_®loc
(
ifšdex
, 

, 
mac
, 0)è=ğ
NULL
)

241 if(
	`¥ÏyŒ“_š£¹
(
Œ“
, 
a2m
è=ğ
NULL
)

243 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd %s:%soree",

244 
	`sÿm³r_addr_to¡r
(
a2m
->

, 
¡r
, (ipstr)),

245 
	`sÿm³r_addr_to¡r
(
a2m
->
mac
, 
mac¡r
, (macstr)));

246 
	`addr2mac_ä“
(
a2m
);

250 
	`sÿm³r_debug
(
__func__
, "ifšdex %d i°% maø%s", 
ifšdex
,

251 
	`sÿm³r_addr_to¡r
(
a2m
->

, 
¡r
, (ipstr)),

252 
	`sÿm³r_addr_to¡r
(
a2m
->
mac
, 
mac¡r
, (macstr)));

254 
	}
}

261 
sÿm³r_addr_t
 *
	$sÿm³r_addr2mac_whohas
(cÚ¡ 
ifšdex
, 
sÿm³r_addr_t
 *
d¡
)

263 
addr2mac_t
 
fšdme
, *
addr2mac
;

265 
fšdme
.
ifšdex
 = ifindex;

266 
fšdme
.

 = 
d¡
;

269 if((
addr2mac
 = 
	`¥ÏyŒ“_fšd
(
Œ“
, &
fšdme
)è!ğ
NULL
)

271  
addr2mac
->
mac
;

274  
NULL
;

275 
	}
}

277 #ià
defšed
(
__lšux__
)

278 
	$addr2mac_š™_lšux
()

280 
Æmsghdr
 *
Æmsg
;

281 
ndmsg
 *ndmsg;

282 
¹©Œ
 *
¹a
, *
tb
[
NDA_MAX
];

283 
sockaddr_Æ
 
¢l
;

284 
msghdr
 
msg
;

285 
iovec
 
iov
;

286 
timev®
 
tv
;

287 
pid_t
 
pid
;

288 
ušt8_t
 
buf
[16384];

289 
ssize_t
 
ssize
;

290 
ssize_t
 
Ën
;

291 
¾’
;

292 
fd
 = -1;

293 *

, *
mac
;

294 
ty³
;

296 
pid
 = 
	`g‘pid
();

298 
	`mem£t
(
buf
, 0, (buf));

299 
Æmsg
 = (
Æmsghdr
 *)
buf
;

300 
Æmsg
->
Æmsg_Ën
 = 
	`NLMSG_LENGTH
((
ndmsg
));

301 
Æmsg
->
Æmsg_ty³
 = 
RTM_GETNEIGH
;

302 
Æmsg
->
Æmsg_æags
 = 
NLM_F_REQUEST
 | 
NLM_F_ROOT
 | 
NLM_F_MATCH
;

303 
Æmsg
->
Æmsg_£q
 = 0;

304 
Æmsg
->
Æmsg_pid
 = 
pid
;

306 
ndmsg
 = 
	`NLMSG_DATA
(
Æmsg
);

307 
ndmsg
->
ndm_çmy
 = 
AF_UNSPEC
;

309 if((
fd
 = 
	`sock‘
(
PF_NETLINK
, 
SOCK_DGRAM
, 
NETLINK_ROUTE
)) == -1)

311 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open‚etlink");

312 
”r
;

315 
Ën
 = 
Æmsg
->
Æmsg_Ën
;

316 if((
ssize
 = 
	`£nd
(
fd
, 
buf
, 
Ën
, 0)) <†en)

318 if(
ssize
 == -1)

320 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send‚etlink");

322 
”r
;

327 
iov
.
iov_ba£
 = 
buf
;

328 
iov
.
iov_Ën
 = (
buf
);

330 
msg
.
msg_Çme
 = &
¢l
;

331 
msg
.
msg_Çm–’
 = (
¢l
);

332 
msg
.
msg_iov
 = &
iov
;

333 
msg
.
msg_iovËn
 = 1;

334 
msg
.
msg_cÚŒŞ
 = 
NULL
;

335 
msg
.
msg_cÚŒŞËn
 = 0;

336 
msg
.
msg_æags
 = 0;

338 if((
Ën
 = 
	`»cvmsg
(
fd
, &
msg
, 0)) == -1)

340 if(
”ºo
 =ğ
EINTR
) ;

341 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecvmsg");

342 
”r
;

345 
	`g‘timeofday_w¿p
(&
tv
);

347 
Æmsg
 = (
Æmsghdr
 *)
buf
;

348 
	`NLMSG_OK
(
Æmsg
, 
Ën
))

350 if(
Æmsg
->
Æmsg_pid
 !ğ
pid
 ||‚lmsg->
Æmsg_£q
 != 0)

352 
sk
;

355 if(
Æmsg
->
Æmsg_ty³
 =ğ
NLMSG_DONE
)

357 
dÚe
;

360 if(
Æmsg
->
Æmsg_ty³
 =ğ
NLMSG_ERROR
)

362 
	`sÿm³r_debug
(
__func__
, "nlmsgƒrror");

363 
”r
;

367 if(
Æmsg
->
Æmsg_ty³
 !ğ
RTM_NEWNEIGH
)

369 
sk
;

373 
ndmsg
 = 
	`NLMSG_DATA
(
Æmsg
);

374 if((
ndmsg
->
ndm_¡©e
 & 
NUD_REACHABLE
) == 0)

376 
sk
;

380 
ndmsg
->
ndm_çmy
)

382 
AF_INET
:

383 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

386 
AF_INET6
:

387 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

391 
sk
;

395 
	`mem£t
(
tb
, 0, (tb));

396 
¾’
 = 
Æmsg
->
Æmsg_Ën
 - 
	`NLMSG_LENGTH
((
ndmsg
));

397 
¹a
 = 
	`NDA_RTA
(
ndmsg
); 
	`RTA_OK
Ô,
¾’
);„ = 
	`RTA_NEXT
(rta,rlen))

399 if(
¹a
->
¹a_ty³
 >ğ
NDA_MAX
)

401 
tb
[
¹a
->
¹a_ty³
] =„ta;

408 if(
tb
[
NDA_DST
] =ğ
NULL
 ||

409 
tb
[
NDA_LLADDR
] =ğ
NULL
 || 
	`RTA_PAYLOAD
(tb[NDA_LLADDR]) != 6)

411 
sk
;

414 

 = 
	`RTA_DATA
(
tb
[
NDA_DST
]);

415 
mac
 = 
	`RTA_DATA
(
tb
[
NDA_LLADDR
]);

417 
	`addr2mac_add
(
ndmsg
->
ndm_ifšdex
, 
ty³
, 

, 
mac
, 
tv
.
tv_£c
+600);

419 
sk
:

420 
Æmsg
 = 
	`NLMSG_NEXT
Òlmsg, 
Ën
);

424 
dÚe
:

425 
	`şo£
(
fd
);

428 
”r
:

429 
	`şo£
(
fd
);

431 
	}
}

434 #ià
defšed
(
HAVE_BSD_ARPCACHE
)

435 
	$addr2mac_mib_make
(*
mib
, 
af
)

437 
mib
[0] = 
CTL_NET
;

438 
mib
[1] = 
PF_ROUTE
;

439 
mib
[2] = 0;

440 
mib
[3] = 
af
;

441 
mib
[4] = 
NET_RT_FLAGS
;

442 #ià
	`defšed
(
RTF_LLINFO
)

443 
mib
[5] = 
RTF_LLINFO
;

445 
mib
[5] = 0;

448 
	}
}

450 
	$addr2mac_š™_bsd
()

452 
¹_msghdr
 *
¹m
;

453 
sockaddr_š¬p
 *
sš
;

454 
sockaddr_š6
 *
sš6
;

455 
sockaddr_dl
 *
sdl
;

456 
ty³
;

457 *

, *
mac
;

458 
mib
[6];

459 *
vbuf
 = 
NULL
;

460 
ušt8_t
 *
buf
;

461 
size_t
 
i
, 
j
, 
size
;

468 
	`addr2mac_mib_make
(
mib
, 
AF_INET
);

469 if(
	`sysùl_w¿p
(
mib
, 6, &
vbuf
, &
size
) == -1)

471 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "sysctl‡rp cache");

472 
”r
;

475 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

476 
buf
 = (
ušt8_t
 *)
vbuf
;

477 
i
=0; i<
size
; i +ğ
¹m
->
¹m_msgËn
)

479 
j
 = 
i
;

480 
¹m
 = (
¹_msghdr
 *)(
buf
 + 
j
); j += (rt_msghdr);

481 
sš
 = (
sockaddr_š¬p
 *)(
buf
 + 
j
);

482 
j
 +ğ
	`sÿm³r_¹sock_roundup
(
sš
->
sš_Ën
);

483 
sdl
 = (
sockaddr_dl
 *)(
buf
 + 
j
);

486 if(
sdl
->
sdl_ty³
 !ğ
IFT_ETHER
 ||

487 
sdl
->
sdl_®’
 !ğ
ETHER_ADDR_LEN
)

492 

 = &
sš
->
sš_addr
;

493 
mac
 = 
sdl
->
sdl_d©a
 + sdl->
sdl_Æ’
;

495 
	`addr2mac_add
(
sdl
->
sdl_šdex
, 
ty³
, 

, 
mac
,

496 (
time_t
)
¹m
->
¹m_rmx
.
rmx_expœe
);

498 if(
vbuf
 !ğ
NULL
)

500 
	`ä“
(
vbuf
);

501 
vbuf
 = 
NULL
;

505 
	`addr2mac_mib_make
(
mib
, 
AF_INET6
);

506 if(
	`sysùl_w¿p
(
mib
, 6, &
vbuf
, &
size
) == -1)

512 if(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
EAFNOSUPPORT
)

515 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "sysctl‚dp cache");

516 
”r
;

519 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

520 
buf
 = (
ušt8_t
 *)
vbuf
;

521 
i
=0; i<
size
; i +ğ
¹m
->
¹m_msgËn
)

523 
j
 = 
i
;

524 
¹m
 = (
¹_msghdr
 *)(
buf
 + 
j
); j += (rt_msghdr);

525 
sš6
 = (
sockaddr_š6
 *)(
buf
 + 
j
);

526 
j
 +ğ
	`sÿm³r_¹sock_roundup
(
sš6
->
sš6_Ën
);

527 
sdl
 = (
sockaddr_dl
 *)(
buf
 + 
j
);

529 if(
sdl
->
sdl_çmy
 !ğ
AF_LINK
 ||

530 
sdl
->
sdl_ty³
 !ğ
IFT_ETHER
 ||

531 
sdl
->
sdl_®’
 !ğ
ETHER_ADDR_LEN
 ||

532 (
¹m
->
¹m_æags
 & 
RTF_HOST
) == 0)

538 if(
	`IN6_IS_ADDR_LINKLOCAL
(&
sš6
->
sš6_addr
))

540 
sš6
->
sš6_addr
.
s6_addr
[2] = 0;

541 
sš6
->
sš6_addr
.
s6_addr
[3] = 0;

544 

 = &
sš6
->
sš6_addr
;

545 
mac
 = 
sdl
->
sdl_d©a
 + sdl->
sdl_Æ’
;

547 
	`addr2mac_add
(
sdl
->
sdl_šdex
, 
ty³
, 

, 
mac
,

548 (
time_t
)
¹m
->
¹m_rmx
.
rmx_expœe
);

550 if(
vbuf
 !ğ
NULL
)

552 
	`ä“
(
vbuf
);

553 
vbuf
 = 
NULL
;

558 
”r
:

559 if(
vbuf
 !ğ
NULL
è
	`ä“
(vbuf);

561 
	}
}

564 #ifdeà
_WIN32


565 
	$G‘IpN‘TabË_w¿p
(
MIB_IPNETTABLE
 **
bË
, 
ULONG
 *
size
)

567 
rc
;

569 *
bË
 = 
NULL
;

570 *
size
 = 0;

574 if(*
size
 > 0 && (*
bË
 = 
	`m®loc
(*size)è=ğ
NULL
)

577 if((
rc
 = 
	`G‘IpN‘TabË
(*
bË
, 
size
, 
FALSE
)è=ğ
NO_ERROR
)

580 
	`ä“
(*
bË
);

581 *
bË
 = 
NULL
;

583 if(
rc
 !ğ
ERROR_INSUFFICIENT_BUFFER
)

588 
	}
}

590 
	$addr2mac_š™_wš32
()

592 
MIB_IPNETTABLE
 *
bË
;

593 
ULONG
 
size
;

594 
DWORD
 
dw
;

595 
ty³
;

597 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

598 if(
	`G‘IpN‘TabË_w¿p
(&
bË
, &
size
è=ğ0 &&abË !ğ
NULL
)

600 
dw
=0; dw<
bË
->
dwNumEÁr›s
; dw++)

602 
	`addr2mac_add
(
bË
->bË[
dw
].
dwIndex
, 
ty³
,

603 &
bË
->bË[
dw
].
dwAddr
,

604 
bË
->bË[
dw
].
bPhysAddr
, 0);

606 
	`ä“
(
bË
);

610 
	}
}

613 
	$sÿm³r_addr2mac_š™
()

615 if((
Œ“
 = 
	`¥ÏyŒ“_®loc
((
¥ÏyŒ“_cmp_t
)
addr2mac_cmp
)è=ğ
NULL
)

617 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocree");

621 if(
	`sÿm³r_İtiÚ_noš™ndc
() != 0)

624 #ifdeà
HAVE_BSD_ARPCACHE


625 if(
	`addr2mac_š™_bsd
() != 0)

631 #ifdeà
__lšux__


632 if(
	`addr2mac_š™_lšux
() != 0)

638 #ifdeà
_WIN32


639 if(
	`addr2mac_š™_wš32
() != 0)

646 
	}
}

648 
	$sÿm³r_addr2mac_ş—nup
()

650 
	`¥ÏyŒ“_ä“
(
Œ“
, (
¥ÏyŒ“_ä“_t
)
addr2mac_ä“
);

652 
	}
}

	@scamper_addr2mac.h

25 #iâdeà
__SCAMPER_ADDR2MAC_H


26 
	#__SCAMPER_ADDR2MAC_H


	)

28 
sÿm³r_addr_t
 *
sÿm³r_addr2mac_whohas
(cÚ¡ 
ifšdex
,sÿm³r_addr_ˆ*
d¡
);

29 
sÿm³r_addr2mac_add
(
ifšdex
, 
sÿm³r_addr_t
 *

, sÿm³r_addr_ˆ*
mac
);

30 
sÿm³r_addr2mac_š™
();

31 
sÿm³r_addr2mac_ş—nup
();

	@scamper_control.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r.h
"

37 
	~"sÿm³r_cÚŒŞ.h
"

38 
	~"sÿm³r_debug.h
"

39 
	~"sÿm³r_fds.h
"

40 
	~"sÿm³r_lš•Şl.h
"

41 
	~"sÿm³r_wr™ebuf.h
"

42 
	~"sÿm³r_fe.h
"

43 
	~"sÿm³r_outfes.h
"

44 
	~"sÿm³r_sk.h
"

45 
	~"sÿm³r_queue.h
"

46 
	~"sÿm³r_sourûs.h
"

47 
	~"sÿm³r_sourû_fe.h
"

48 
	~"sÿm³r_sourû_cÚŒŞ.h
"

49 
	~"sÿm³r_sourû_t¥s.h
"

50 
	~"sÿm³r_´iv£p.h
"

51 
	~"mjl_li¡.h
"

52 
	~"uts.h
"

55 
	~"sÿm³r_li¡.h
"

56 
	~"Œaû/sÿm³r_Œaû_do.h
"

62 
	sş›Á_obj


64 *
	md©a
;

65 
size_t
 
	mËn
;

66 } 
	tş›Á_obj_t
;

73 
	sş›Á_txt


75 *
	m¡r
;

76 
size_t
 
	mËn
;

77 } 
	tş›Á_txt_t
;

85 
	sş›Á


88 
sockaddr
 *
	m§
;

91 
dli¡_node_t
 *
	mnode
;

98 
sÿm³r_fd_t
 *
	mfdn
;

99 
sÿm³r_lš•Şl_t
 *
	mÍ
;

100 
sÿm³r_wr™ebuf_t
 *
	mwb
;

103 *
	mob£rve
;

106 
	mmode
;

119 
sÿm³r_sourû_t
 *
	msourû
;

120 
sÿm³r_outfe_t
 *
	msof
;

121 
¦i¡_t
 *
	msof_txt
;

122 
¦i¡_t
 *
	msof_objs
;

123 
ş›Á_obj_t
 *
	msof_obj
;

124 
size_t
 
	msof_off
;

125 } 
	tş›Á_t
;

127 
	#CLIENT_MODE_INTERACTIVE
 0

	)

128 
	#CLIENT_MODE_ATTACHED
 1

	)

129 
	#CLIENT_MODE_FLUSH
 2

	)

131 
	scommªd


133 *
	mwÜd
;

134 (*
	mhªdËr
)(
ş›Á_t
 *
	mş›Á
, *
	m·¿m
);

135 } 
	tcommªd_t
;

137 
	s·¿m


139 *
	mwÜd
;

140 **
	mv¬
;

141 } 
	t·¿m_t
;

147 
dli¡_t
 *
	gş›Á_li¡
 = 
NULL
;

148 
sÿm³r_fd_t
 *
	gfdn
 = 
NULL
;

150 #ià
defšed
(
AF_UNIX
è&& !defšed(
_WIN32
)

151 *
	gù¾_unix_Çme
 = 
NULL
;

152 
	gù¾_unix_num
 = 0;

155 
	$commªd_hªdËr
(
commªd_t
 *
hªdËr
, 
út
, 
ş›Á_t
 *
ş›Á
,

156 *
wÜd
, *
·¿m
, *
»tv®
)

158 
i
;

160 
i
=0; i<
út
; i++)

162 if(
	`¡rÿ£cmp
(
hªdËr
[
i
].
wÜd
, word) == 0)

164 *
»tv®
 = 
hªdËr
[
i
].
	`hªdËr
(
ş›Á
, 
·¿m
);

170 
	}
}

178 
	$·¿ms_g‘
(*
lše
, **
wÜds
, *
couÁ
)

180 
i
, 
w
;

182 
i
 = 0;

183 
w
 = 0;

186 if(
lše
 =ğ
NULL
)

188 *
couÁ
 = 0;

192 
lše
[
i
] !ğ'\0' && 
w
 < *
couÁ
)

194 if(
lše
[
i
] == '"')

197 
wÜds
[
w
++] = &
lše
[++
i
];

200 
lše
[
i
] != '"' &&†ine[i] != '\0') i++;

203 if(
lše
[
i
] == '\0')  -1;

208 
wÜds
[
w
++] = &
lše
[
i
++];

211 
lše
[
i
] != ' ' &&†ine[i] != '\0') i++;

213 if(
lše
[
i
] == '\0') ;

218 
lše
[
i
++] = '\0';

221 
lše
[
i
] == ' ' &&†ine[i] != '\0') i++;

224 if(
lše
[
i
] == '\0')

226 *
couÁ
 = 
w
;

231 
	}
}

233 *
	$sw™ch_to¡r
(*
buf
, 
size_t
 
Ën
, 
v®
)

235 if(
v®
 == 0)

237 
	`¡ºıy
(
buf
, "off", 
Ën
);

241 
	`¡ºıy
(
buf
, "Ú", 
Ën
);

244  
buf
;

245 
	}
}

247 
	$ş›Á_obj_ä“
(
ş›Á_obj_t
 *
obj
)

249 if(
obj
 =ğ
NULL
)

251 if(
obj
->
d©a
 !ğ
NULL
)

252 
	`ä“
(
obj
->
d©a
);

253 
	`ä“
(
obj
);

255 
	}
}

257 
	$ş›Á_txt_ä“
(
ş›Á_txt_t
 *
txt
)

259 if(
txt
 =ğ
NULL
)

261 if(
txt
->
¡r
 !ğ
NULL
)

262 
	`ä“
(
txt
->
¡r
);

263 
	`ä“
(
txt
);

265 
	}
}

267 *
	$ş›Á_sockaddr_to¡r
(
ş›Á_t
 *
ş›Á
, *
buf
, 
size_t
 
Ën
)

273 #ià
	`defšed
(
AF_UNIX
è&& !defšed(
_WIN32
)

274 if(
ş›Á
->
§
->
§_çmy
 =ğ
AF_UNIX
)

276 if(
ù¾_unix_Çme
 =ğ
NULL
)

277  
NULL
;

278 
	`¢´štf
(
buf
, 
Ën
, "%s:%d", 
ù¾_unix_Çme
, 
ù¾_unix_num
++);

279  
buf
;

287 if(
	`sockaddr_to¡r
(
ş›Á
->
§
, 
buf
, 
Ën
è=ğ
NULL
)

289 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
, "could‚ot decipher client sockaddr");

290  
NULL
;

293  
buf
;

294 
	}
}

301 
	$ş›Á_ä“
(
ş›Á_t
 *
ş›Á
)

303 
ş›Á_obj_t
 *
obj
;

304 
ş›Á_txt_t
 *
txt
;

305 
fd
;

307 if(
ş›Á
 =ğ
NULL
) ;

309 if(
ş›Á
->
wb
 !ğ
NULL
)

310 
	`sÿm³r_wr™ebuf_d‘ach
(
ş›Á
->
wb
);

313 if(
ş›Á
->
fdn
 !ğ
NULL
)

315 
fd
 = 
	`sÿm³r_fd_fd_g‘
(
ş›Á
->
fdn
);

316 
	`sÿm³r_fd_ä“
(
ş›Á
->
fdn
);

317 
ş›Á
->
fdn
 = 
NULL
;

319 
	`shutdown
(
fd
, 
SHUT_RDWR
);

320 
	`şo£
(
fd
);

324 if(
ş›Á
->
Í
 !ğ
NULL
è
	`sÿm³r_lš•Şl_ä“
(client->lp, 0);

325 
ş›Á
->
Í
 = 
NULL
;

328 if(
ş›Á
->
wb
 !ğ
NULL
è
	`sÿm³r_wr™ebuf_ä“
(client->wb);

329 
ş›Á
->
wb
 = 
NULL
;

332 if(
ş›Á
->
node
 !ğ
NULL
è
	`dli¡_node_pİ
(
ş›Á_li¡
, client->node);

333 
ş›Á
->
node
 = 
NULL
;

336 if(
ş›Á
->
§
 !ğ
NULL
è
	`ä“
(client->sa);

337 
ş›Á
->
§
 = 
NULL
;

340 if(
ş›Á
->
ob£rve
 !ğ
NULL
è
	`sÿm³r_sourûs_unob£rve
(client->observe);

341 
ş›Á
->
ob£rve
 = 
NULL
;

344 if(
ş›Á
->
sourû
 !ğ
NULL
)

346 
	`sÿm³r_sourû_abªdÚ
(
ş›Á
->
sourû
);

347 
	`sÿm³r_sourû_ä“
(
ş›Á
->
sourû
);

348 
ş›Á
->
sourû
 = 
NULL
;

352 if(
ş›Á
->
sof
 !ğ
NULL
è
	`sÿm³r_outfe_ä“
(client->sof);

353 
ş›Á
->
sof
 = 
NULL
;

355 if(
ş›Á
->
sof_objs
 !ğ
NULL
)

357 (
obj
 = 
	`¦i¡_h—d_pİ
(
ş›Á
->
sof_objs
)è!ğ
NULL
)

358 
	`ş›Á_obj_ä“
(
obj
);

359 
	`¦i¡_ä“
(
ş›Á
->
sof_objs
);

360 
ş›Á
->
sof_objs
 = 
NULL
;

363 if(
ş›Á
->
sof_txt
 !ğ
NULL
)

365 (
txt
 = 
	`¦i¡_h—d_pİ
(
ş›Á
->
sof_txt
)è!ğ
NULL
)

366 
	`ş›Á_txt_ä“
(
txt
);

367 
	`¦i¡_ä“
(
ş›Á
->
sof_txt
);

368 
ş›Á
->
sof_txt
 = 
NULL
;

371 
	`ä“
(
ş›Á
);

373 
	}
}

383 
	$ş›Á_d©a_cÚsume
(*
·¿m
)

385 
ş›Á_t
 *
ş›Á
 = 
·¿m
;

386 
ş›Á_txt_t
 *
t
 = 
NULL
;

387 
ş›Á_obj_t
 *
o
;

388 
ušt8_t
 
d©a
[8192];

389 
¡r
[64];

390 
size_t
 
Ën
;

391 
rc
;

393 if(
ş›Á
->
sof_off
 == 0)

395 (
t
 = 
	`¦i¡_h—d_pİ
(
ş›Á
->
sof_txt
)è!ğ
NULL
)

397 
rc
 = 
	`sÿm³r_wr™ebuf_£nd
(
ş›Á
->
wb
, 
t
->
¡r
,->
Ën
);

398 
	`ş›Á_txt_ä“
(
t
); = 
NULL
;

399 if(
rc
 < 0)

400 
”r
;

404 if((
o
 = 
	`¦i¡_h—d_pİ
(
ş›Á
->
sof_objs
)è!ğ
NULL
)

406 
ş›Á
->
sof_obj
 = 
o
;

407 
Ën
 = 
	`¢´štf
(
¡r
, (str), "DATA %d\n",

408 ()
	`uu’code_Ën
(
o
->
Ën
, 
NULL
, NULL));

409 if(
	`sÿm³r_wr™ebuf_£nd
(
ş›Á
->
wb
, 
¡r
, 
Ën
) < 0)

411 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
,"could‚ot send DATA header");

412 
”r
;

418 
o
 = 
ş›Á
->
sof_obj
;

421 if(
o
 !ğ
NULL
)

423 
Ën
 = 
	`uu’code_by‹s
(
o
->
d©a
,o->Ën,&
ş›Á
->
sof_off
,data,(data));

424 if(
ş›Á
->
sof_off
 =ğ
o
->
Ën
)

426 
	`ş›Á_obj_ä“
(
o
);

427 
ş›Á
->
sof_obj
 = 
NULL
;

428 
ş›Á
->
sof_off
 = 0;

431 if(
	`sÿm³r_wr™ebuf_£nd
(
ş›Á
->
wb
, 
d©a
, 
Ën
) != 0)

433 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù s’d %d by‹s", 
Ën
);

434 
”r
;

440 
”r
:

443 
	}
}

445 
	$ş›Á_£nd
(
ş›Á_t
 *
ş›Á
, *
fs
, ...)

447 
msg
[512], *
¡r
 = 
NULL
;

448 
ş›Á_txt_t
 *
t
 = 
NULL
;

449 
size_t
 
Ën
, 
size
 = (
msg
) - 1;

450 
va_li¡
 
­
;

451 
»t
;

453 
	`va_¡¬t
(
­
, 
fs
);

454 
»t
 = 
Ën
 = 
	`v¢´štf
(
msg
, (msg), 
fs
, 
­
);

455 if(
Ën
 < 
size
)

457 
	`va_’d
(
­
);

458 
¡r
 = 
msg
;

462 if((
¡r
 = 
	`m®loc
((
size_t
)(
Ën
+1))è=ğ
NULL
)

464 
	`va_’d
(
­
);

465 
”r
;

467 
	`v¢´štf
(
¡r
, 
Ën
+1, 
fs
, 
­
);

468 
	`va_’d
(
­
);

470 
¡r
[
Ën
++] = '\n';

472 if(
ş›Á
->
mode
 =ğ
CLIENT_MODE_ATTACHED
)

474 if(
¡r
 =ğ
msg
 && (¡¸ğ
	`memdup
(msg, 
Ën
)è=ğ
NULL
)

475 
”r
;

476 if((
t
 = 
	`m®loc_z”o
((
ş›Á_txt_t
))è=ğ
NULL
)

477 
”r
;

478 if(
	`¦i¡__push
(
ş›Á
->
sof_txt
, 
t
è=ğ
NULL
)

479 
”r
;

480 
t
->
¡r
 = str;

481 
t
->
Ën
 =†en;

482 
	`sÿm³r_wr™ebuf_cÚsume
(
ş›Á
->
wb
, cl›Á, 
ş›Á_d©a_cÚsume
);

486 
»t
 = 
	`sÿm³r_wr™ebuf_£nd
(
ş›Á
->
wb
, 
¡r
, 
Ën
);

487 if(
¡r
 !ğ
msg
)

488 
	`ä“
(
¡r
);

491  
»t
;

493 
”r
:

494 if(
¡r
 !ğ
NULL
 && sŒ !ğ
msg
)

495 
	`ä“
(
¡r
);

497 
	}
}

503 
	$·¿m_hªdËr
(
·¿m_t
 *
hªdËr
, 
út
, 
ş›Á_t
 *
ş›Á
,

504 *
·¿m
, *
Ãxt
)

506 
i
;

508 
i
=0; i<
út
; i++)

511 if(
	`¡rÿ£cmp
(
hªdËr
[
i
].
wÜd
, 
·¿m
) != 0)

517 if(*
hªdËr
[
i
].
v¬
 !ğ
NULL
)

519 
	`sÿm³r_debug
(
__func__
, "·¿m‘” '%s'‡Ì—dy s³cif›d", 
·¿m
);

524 if(
Ãxt
 =ğ
NULL
)

526 
	`sÿm³r_debug
(
__func__
, "·¿m‘” '%s'„equœe ¬gum’t", 
·¿m
);

531 *
hªdËr
[
i
].
v¬
 = 
Ãxt
;

536 
	}
}

538 
	$£t_lÚg
(
ş›Á_t
 *
ş›Á
, *
buf
, *
Çme
,

539 (*
£tfunc
)(), 
mš
, 
max
)

541 
l
;

542 *
”r
;

544 if(
buf
 =ğ
NULL
)

546 
	`ş›Á_£nd
(
ş›Á
, "ERR s‘ % »quœe ¬gum’t", 
Çme
);

547 
	`sÿm³r_debug
(
__func__
, "£ˆ% »quœed‡rgum’t", 
Çme
);

555 
	`¡ršg_ÃxtwÜd
(
buf
);

558 if(
	`¡ršg_i¢umb”
(
buf
) == 0)

560 
	`ş›Á_£nd
(
ş›Á
, "ERR s‘ % ¬gum’ˆi nÙ‡Àš‹g”", 
Çme
);

561 
	`sÿm³r_debug
(
__func__
, "£ˆ% ¬gum’ˆi nÙ‡Àš‹g”", 
Çme
);

566 if(
	`¡ršg_tŞÚg
(
buf
, &
l
) != 0)

568 
”r
 = 
	`¡»¼Ü
(
”ºo
);

569 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚Ù cÚv”ˆ% tØlÚg: %s", 
buf
, 
”r
);

570 
	`sÿm³r_debug
(
__func__
, "could‚Ù cÚv”ˆ% tØlÚg: %s", 
buf
, 
”r
);

574 if(
	`£tfunc
(
l
) == -1)

576 
	`ş›Á_£nd
(
ş›Á
, "ERR %s: %d ouˆoà¿ng(%d, %d)", 
Çme
,
l
,
mš
,
max
);

577 
	`sÿm³r_debug
(
__func__
, "%s: %d ouˆoà¿ng(%d, %d)", 
Çme
,
l
,
mš
,
max
);

581 
	`ş›Á_£nd
(
ş›Á
, "OK % %d", 
Çme
, 
l
);

583 
	}
}

585 
	$g‘_sw™ch
(
ş›Á_t
 *
ş›Á
, *
Çme
, *
buf
, *
l
)

587 if(
	`¡rÿ£cmp
(
buf
, "on") == 0)

589 *
l
 = 1;

591 if(
	`¡rÿ£cmp
(
buf
, "off") == 0)

593 *
l
 = 0;

597 
	`ş›Á_£nd
(
ş›Á
, "ERR % <Ú|off>", 
Çme
);

602 
	}
}

604 *
	$sourû_to¡r
(*
¡r
, cÚ¡ 
size_t
 
Ën
,

605 cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

607 
desü
[256], 
outfe
[256], 
ty³
[512], 
sw1
[4];

608 
i
;

611 (
i
 = 
	`sÿm³r_sourû_g‘ty³
(
sourû
)))

613 
SCAMPER_SOURCE_TYPE_FILE
:

614 
	`¢´štf
(
ty³
, (type),

616 
	`sÿm³r_sourû_fe_g‘f’ame
(
sourû
),

617 
	`sÿm³r_sourû_fe_g‘cyşes
(
sourû
),

618 
	`sw™ch_to¡r
(
sw1
, (sw1),

619 
	`sÿm³r_sourû_fe_g‘autÜ–ßd
(
sourû
)));

622 
SCAMPER_SOURCE_TYPE_CMDLINE
:

623 
	`¢´štf
(
ty³
, (type), "type 'cmdline'");

626 
SCAMPER_SOURCE_TYPE_CONTROL
:

627 
	`¢´štf
(
ty³
, (type), "type 'control'");

630 
SCAMPER_SOURCE_TYPE_TSPS
:

631 
	`¢´štf
(
ty³
, (type), "type 'tsps' file '%s'",

632 
	`sÿm³r_sourû_t¥s_g‘f’ame
(
sourû
));

636 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
, "unknowÀsourûy³ %d", 
i
);

637  
NULL
;

641 if(
	`sÿm³r_sourû_g‘desü
(
sourû
è!ğ
NULL
)

643 
	`¢´štf
(
desü
, (descr),

644 " desü '%s'", 
	`sÿm³r_sourû_g‘desü
(
sourû
));

646 
desü
[0] = '\0';

649 if(
	`sÿm³r_sourû_g‘outfe
(
sourû
è!ğ
NULL
)

651 
	`¢´štf
(
outfe
, (outfile), " outfile '%s'",

652 
	`sÿm³r_sourû_g‘outfe
(
sourû
));

654 
outfe
[0] = '\0';

656 
	`¢´štf
(
¡r
, 
Ën
,

658 
	`sÿm³r_sourû_g‘Çme
(
sourû
),

659 
desü
,

660 
	`sÿm³r_sourû_g‘li¡id
(
sourû
),

661 
	`sÿm³r_sourû_g‘cyşeid
(
sourû
),

662 
	`sÿm³r_sourû_g‘´iÜ™y
(
sourû
),

663 
outfe
,

664 
ty³
);

666  
¡r
;

667 
	}
}

674 
	$ş›Á_d©a_£nd
(*
·¿m
, cÚ¡ *
vd©a
, 
size_t
 
Ën
)

676 
ş›Á_t
 *
ş›Á
 = 
·¿m
;

677 
ş›Á_obj_t
 *
obj
 = 
NULL
;

678 cÚ¡ 
ušt8_t
 *
d©a
 = 
vd©a
;

680 
	`as£¹
(
Ën
 >= 8);

682 if(
ş›Á
->
wb
 =ğ
NULL
 || cl›Á->
sof_objs
 == NULL)

685 if(
d©a
[0] != 0x12 || data[1] != 0x05)

687 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
,

689 
d©a
[0], data[1], data[2], data[3], data[4], data[5],

690 
d©a
[6], data[7]);

691 
”r
;

695 if(
d©a
[2] == 0 && data[3] == 0x04)

696 
ş›Á
->
mode
 = 
CLIENT_MODE_FLUSH
;

698 if((
obj
 = 
	`m®loc_z”o
((
ş›Á_obj_t
))è=ğ
NULL
)

700 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc obj");

701 
”r
;

704 if((
obj
->
d©a
 = 
	`memdup
(
vd©a
, 
Ën
)è=ğ
NULL
)

706 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot memdup");

707 
”r
;

709 
obj
->
Ën
 =†en;

711 if(
	`¦i¡__push
(
ş›Á
->
sof_objs
, 
obj
è=ğ
NULL
)

713 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…ush obj onto†ist");

714 
”r
;

716 
obj
 = 
NULL
;

718 
	`sÿm³r_wr™ebuf_cÚsume
(
ş›Á
->
wb
, cl›Á, 
ş›Á_d©a_cÚsume
);

721 
”r
:

722 
	`ş›Á_obj_ä“
(
obj
);

724 
	}
}

726 
	$ş›Á_sigÇlmÜe
(*
·¿m
)

728 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
·¿m
;

729 
	`ş›Á_£nd
(
ş›Á
, "MORE");

731 
	}
}

733 *
	$ş›Á_to¡r
(*
·¿m
, *
buf
, 
size_t
 
Ën
)

735 
ş›Á_t
 *
ş›Á
 = 
·¿m
;

736 
size_t
 
off
 = 0;

738 
buf
[0] = '\0';

739 if(
ş›Á
->
fdn
 !ğ
NULL
)

740 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "fd %d", 
	`sÿm³r_fd_fd_g‘
(
ş›Á
->
fdn
));

742  
buf
;

743 
	}
}

752 #iâdeà
_WIN32


753 
	$commªd_©ch
(
ş›Á_t
 *
ş›Á
, *
buf
)

755 
sÿm³r_sourû_·¿ms_t
 
s¥
;

756 
sÿm³r_fe_t
 *
sf
;

757 
§b
[128];

758 
´iÜ™y
 = 1;

759 *
´iÜ™y_¡r
 = 
NULL
, *
·¿ms
[2], *
Ãxt
;

760 
i
, 
út
 = (
·¿ms
) / (*);

761 
·¿m_t
 
hªdËrs
[] = {

762 {"´iÜ™y", &
´iÜ™y_¡r
},

764 
hªdËr_út
 = (
hªdËrs
è/ (
·¿m_t
);

766 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) != 0)

768 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot…arams_get");

771 
i
=0; i<
út
; i+=2)

773 if(
i
+1 !ğ
út
è
Ãxt
 = 
·¿ms
[i+1];

774 
Ãxt
 = 
NULL
;

775 if(
	`·¿m_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
·¿ms
[
i
], 
Ãxt
) == -1)

777 
	`ş›Á_£nd
(
ş›Á
,"ERR commªd‡‰ach…¬am '%s' faed",
·¿ms
[
i
]);

782 if(
´iÜ™y_¡r
 !ğ
NULL
 && (
	`¡ršg_tŞÚg
ÕriÜ™y_¡r, &
´iÜ™y
) != 0 ||

783 
´iÜ™y
 < 1 ||…riority > 100000))

785 
	`ş›Á_£nd
(
ş›Á
, "ERR invalid…riority");

789 
	`ş›Á_sockaddr_to¡r
(
ş›Á
, 
§b
, (sab));

791 if((
ş›Á
->
sof_objs
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

793 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc objs†ist");

794 
”r
;

796 if((
ş›Á
->
sof_txt
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

798 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocxt†ist");

799 
”r
;

802 if((
ş›Á
->
sof
 = 
	`sÿm³r_outfe_İ’nuÎ
(
§b
)è=ğ
NULL
)

804 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc outfile");

805 
”r
;

807 
sf
 = 
	`sÿm³r_outfe_g‘fe
(
ş›Á
->
sof
);

808 
	`sÿm³r_fe_£twr™efunc
(
sf
, 
ş›Á
, 
ş›Á_d©a_£nd
);

811 
	`mem£t
(&
s¥
, 0, (ssp));

812 
s¥
.
li¡_id
 = 0;

813 
s¥
.
cyşe_id
 = 1;

814 
s¥
.
´iÜ™y
 =…riority;

815 
s¥
.
Çme
 = 
§b
;

816 
s¥
.
sof
 = 
ş›Á
->sof;

817 if((
ş›Á
->
sourû
 = 
	`sÿm³r_sourû_cÚŒŞ_®loc
(&
s¥
, 
ş›Á_sigÇlmÜe
,

818 
ş›Á_to¡r
,

819 
ş›Á
)è=ğ
NULL
)

821 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

822 "could‚Ù‡Îoÿ‹ sourû '%s'", 
§b
);

823 
”r
;

827 if(
	`sÿm³r_sourûs_add
(
ş›Á
->
sourû
) != 0)

829 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

830 "could‚Ù‡dd sourû '%s'ØrÙ©iÚ", 
§b
);

831 
”r
;

834 
ş›Á
->
mode
 = 
CLIENT_MODE_ATTACHED
;

835 
	`ş›Á_£nd
(
ş›Á
, "OK");

838 
”r
:

839 
	`ş›Á_£nd
(
ş›Á
, "ERR internalƒrror");

840 
	`ş›Á_ä“
(
ş›Á
);

842 
	}
}

845 
	$commªd_lss_ş—r
(
ş›Á_t
 *
ş›Á
, *
buf
)

847 if(
buf
 =ğ
NULL
)

849 
	`ş›Á_£nd
(
ş›Á
, "ERR usage:†ss-clear [lss-name]");

852 
	`¡ršg_ÃxtwÜd
(
buf
);

854 if(
	`sÿm³r_do_Œaû_dŒ“_lss_ş—r
(
buf
) != 0)

856  
	`ş›Á_£nd
(
ş›Á
, "ERR†ss-ş—¸% çed", 
buf
);

859  
	`ş›Á_£nd
(
ş›Á
, "OK†ss-ş—¸%s", 
buf
);

860 
	}
}

862 
	$commªd_ex™
(
ş›Á_t
 *
ş›Á
, *
buf
)

864 
	`ş›Á_ä“
(
ş›Á
);

866 
	}
}

868 
	$commªd_g‘_commªd
(
ş›Á_t
 *
ş›Á
, *
buf
)

870 cÚ¡ *
commªd
 = 
	`sÿm³r_commªd_g‘
();

871 if(
commªd
 =ğ
NULL
)

873  
	`ş›Á_£nd
(
ş›Á
, "OK‚ull command");

875  
	`ş›Á_£nd
(
ş›Á
, "OK commªd %s", 
commªd
);

876 
	}
}

878 
	$commªd_g‘_mÚ™ÜÇme
(
ş›Á_t
 *
ş›Á
, *
buf
)

880 cÚ¡ *
mÚ™ÜÇme
 = 
	`sÿm³r_mÚ™ÜÇme_g‘
();

881 if(
mÚ™ÜÇme
 =ğ
NULL
)

883  
	`ş›Á_£nd
(
ş›Á
, "OK‚ull monitorname");

885  
	`ş›Á_£nd
(
ş›Á
, "OK mÚ™ÜÇm%s", 
mÚ™ÜÇme
);

886 
	}
}

888 
	$commªd_g‘_pid
(
ş›Á_t
 *
ş›Á
, *
buf
)

890 #iâdeà
_WIN32


891 
pid_t
 
pid
 = 
	`g‘pid
();

893 
DWORD
 
pid
 = 
	`G‘Cu¼’tProûssId
();

895  
	`ş›Á_£nd
(
ş›Á
, "OK…id %d", 
pid
);

896 
	}
}

898 
	$commªd_g‘_µs
(
ş›Á_t
 *
ş›Á
, *
buf
)

900 
µs
 = 
	`sÿm³r_µs_g‘
();

901  
	`ş›Á_£nd
(
ş›Á
, "OK…p %d", 
µs
);

902 
	}
}

904 
	$commªd_g‘_v”siÚ
(
ş›Á_t
 *
ş›Á
, *
buf
)

906  
	`ş›Á_£nd
(
ş›Á
, "OK v”siÚ " 
SCAMPER_VERSION
);

907 
	}
}

909 
	$commªd_g‘_wšdow
(
ş›Á_t
 *
ş›Á
, *
buf
)

911  
	`ş›Á_£nd
(
ş›Á
, "OK window %d/%d",

912 
	`sÿm³r_queue_wšdowcouÁ
(), 
	`sÿm³r_wšdow_g‘
());

913 
	}
}

915 
	$commªd_g‘
(
ş›Á_t
 *
ş›Á
, *
buf
)

917 
commªd_t
 
hªdËrs
[] = {

918 {"commªd", 
commªd_g‘_commªd
},

919 {"mÚ™ÜÇme", 
commªd_g‘_mÚ™ÜÇme
},

920 {"pid", 
commªd_g‘_pid
},

921 {"µs", 
commªd_g‘_µs
},

922 {"v”siÚ", 
commªd_g‘_v”siÚ
},

923 {"wšdow", 
commªd_g‘_wšdow
},

925 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

926 
»t
;

928 if(
buf
 =ğ
NULL
)

930 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: get "

935 if(
	`commªd_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
buf
, 
NULL
, &
»t
) == -1)

937 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd g‘ commªd '%s'", 
buf
);

942 
	}
}

944 
	$commªd_h–p
(
ş›Á_t
 *
ş›Á
, *
buf
)

946 
	`ş›Á_£nd
(
ş›Á
, "ERR XXX:odo");

948 
	}
}

950 
	$ob£rve_sourû_ev’t_add
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

951 *
buf
, cÚ¡ 
size_t
 
Ën
)

953 
buf
[0] = 'a'; buf[1] = 'd'; buf[2] = 'd'; buf[3] = ' ';

954 
	`sourû_to¡r
(
buf
+4, 
Ën
-4, 
s£
->
sourû
);

956 
	}
}

958 
	$ob£rve_sourû_ev’t_upd©e
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

959 *
buf
, cÚ¡ 
size_t
 
Ën
)

961 
autÜ–ßd
[16];

962 
cyşes
[16];

963 
´iÜ™y
[24];

966 if(
s£
->
s£_upd©e_æags
 & 0x01)

967 
	`¢´štf
(
autÜ–ßd
, (autoreload),

968 "‡utÜ–ßd %d", 
s£
->
s£_upd©e_autÜ–ßd
);

969 
autÜ–ßd
[0] = '\0';

972 if(
s£
->
s£_upd©e_æags
 & 0x02)

973 
	`¢´štf
(
cyşes
, (cycles),

974 " cyşe %d", 
s£
->
s£_upd©e_cyşes
);

975 
cyşes
[0] = '\0';

978 if(
s£
->
s£_upd©e_æags
 & 0x04)

979 
	`¢´štf
(
´iÜ™y
, (priority),

980 "…riÜ™y %d", 
s£
->
s£_upd©e_´iÜ™y
);

981 
´iÜ™y
[0] = '\0';

983 
	`¢´štf
(
buf
, 
Ën
, "update '%s'%s%s%s",

984 
	`sÿm³r_sourû_g‘Çme
(
s£
->
sourû
),

985 
autÜ–ßd
, 
cyşes
, 
´iÜ™y
);

987 
	}
}

989 
	$ob£rve_sourû_ev’t_cyşe
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

990 *
buf
, cÚ¡ 
size_t
 
Ën
)

992 
	`¢´štf
(
buf
, 
Ën
, "cycle '%s' id %d",

993 
	`sÿm³r_sourû_g‘Çme
(
s£
->
sourû
),

994 
s£
->
s£_cyşe_cyşe_id
);

996 
	}
}

998 
	$ob£rve_sourû_ev’t_d–‘e
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

999 *
buf
, cÚ¡ 
size_t
 
Ën
)

1001 
	`¢´štf
(
buf
, 
Ën
, "delete '%s'",

1002 
	`sÿm³r_sourû_g‘Çme
(
s£
->
sourû
));

1004 
	}
}

1006 
	$ob£rve_sourû_ev’t_fšish
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

1007 *
buf
, cÚ¡ 
size_t
 
Ën
)

1009 
	`¢´štf
(
buf
, 
Ën
, "finish '%s'",

1010 
	`sÿm³r_sourû_g‘Çme
(
s£
->
sourû
));

1012 
	}
}

1020 
	$commªd_ob£rve_sourû_cb
(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *
s£
,

1021 *
·¿m
)

1023 (* cÚ¡ 
func
[])(cÚ¡ 
sÿm³r_sourû_ev’t_t
 *,

1024 *, cÚ¡ 
size_t
) =

1026 
ob£rve_sourû_ev’t_add
,

1027 
ob£rve_sourû_ev’t_upd©e
,

1028 
ob£rve_sourû_ev’t_cyşe
,

1029 
ob£rve_sourû_ev’t_d–‘e
,

1030 
ob£rve_sourû_ev’t_fšish
,

1032 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
·¿m
;

1033 
buf
[512];

1034 
size_t
 
Ën
;

1036 if(
s£
->
ev’t
 < 0x01 || sse->event > 0x05)

1041 
	`¢´štf
(
buf
, (buf), "EVENT %u sourû ", (
ušt32_t
)
s£
->
£c
);

1042 
Ën
 = 
	`¡¾’
(
buf
);

1044 
func
[
s£
->
ev’t
-1](s£, 
buf
 + 
Ën
, (buf)-len);

1045 
	`ş›Á_£nd
(
ş›Á
, "%s", 
buf
);

1048 
	}
}

1050 
	$commªd_ob£rve
(
ş›Á_t
 *
ş›Á
, *
buf
)

1052 if(
buf
 =ğ
NULL
)

1054 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: observe [sources]");

1057 
	`¡ršg_ÃxtwÜd
(
buf
);

1059 if(
	`¡rÿ£cmp
(
buf
, "sources") != 0)

1061 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: observe [sources]");

1065 
ş›Á
->
ob£rve
 = 
	`sÿm³r_sourûs_ob£rve
(
commªd_ob£rve_sourû_cb
, client);

1066 if(
ş›Á
->
ob£rve
 =ğ
NULL
)

1068 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot observe sources");

1069 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot observe");

1073 
	`ş›Á_£nd
(
ş›Á
, "OK");

1075 
	}
}

1082 
	$commªd_outfe_şo£
(
ş›Á_t
 *
ş›Á
, *
buf
)

1084 
sÿm³r_outfe_t
 *
sof
;

1086 if(
buf
 =ğ
NULL
)

1088 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: outfile close <alias>");

1091 
	`¡ršg_ÃxtwÜd
(
buf
);

1093 if((
sof
 = 
	`sÿm³r_outfes_g‘
(
buf
)è=ğ
NULL
)

1095 
	`ş›Á_£nd
(
ş›Á
, "ERR unknowÀoutf'%s'", 
buf
);

1099 if(
	`sÿm³r_outfe_şo£
(
sof
) == -1)

1101 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot drop outfile:„efcnt %d",

1102 
	`sÿm³r_outfe_g‘»fút
(
sof
));

1106 
	`ş›Á_£nd
(
ş›Á
, "OK");

1108 
	}
}

1110 
	$outfe_fÜ—ch
(*
·¿m
, 
sÿm³r_outfe_t
 *
sof
)

1112 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
·¿m
;

1113 
sÿm³r_fe_t
 *
sf
 = 
	`sÿm³r_outfe_g‘fe
(
sof
);

1114 *
f’ame
 = 
	`sÿm³r_fe_g‘f’ame
(
sf
);

1116 if(
f’ame
 =ğ
NULL
) filename = "(null)";

1118 
	`ş›Á_£nd
(
ş›Á
, "INFO '%s' file '%s'„efcnt %d",

1119 
	`sÿm³r_outfe_g‘Çme
(
sof
),

1120 
f’ame
,

1121 
	`sÿm³r_outfe_g‘»fút
(
sof
));

1123 
	}
}

1130 
	$commªd_outfe_li¡
(
ş›Á_t
 *
ş›Á
, *
buf
)

1132 
	`sÿm³r_outfes_fÜ—ch
(
ş›Á
, 
outfe_fÜ—ch
);

1133 
	`ş›Á_£nd
(
ş›Á
, "OK");

1135 
	}
}

1142 
	$commªd_outfe_İ’
(
ş›Á_t
 *
ş›Á
, *
buf
)

1144 *
·¿ms
[24];

1145 
i
, 
út
 = (
·¿ms
) / (*);

1146 *
fe
 = 
NULL
, *
mode
 = NULL, *
Çme
 = NULL;

1147 *
Ãxt
;

1148 
·¿m_t
 
hªdËrs
[] = {

1149 {"fe", &
fe
},

1150 {"mode", &
mode
},

1151 {"Çme", &
Çme
},

1153 
hªdËr_út
 = (
hªdËrs
è/ (
·¿m_t
);

1155 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1157 
	`ş›Á_£nd
(
ş›Á
, "ERR…arams_get failed");

1161 
i
=0; i<
út
; i += 2)

1163 if(
i
+1 !ğ
út
è
Ãxt
 = 
·¿ms
[i+1];

1164 
Ãxt
 = 
NULL
;

1166 if(
	`·¿m_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
·¿ms
[
i
], 
Ãxt
) == -1)

1168 
	`ş›Á_£nd
(
ş›Á
, "ERR…¬am '%s' faed", 
·¿ms
[
i
]);

1173 if(
Çme
 =ğ
NULL
 || 
fe
 =ğNULL || 
mode
 == NULL)

1175 
	`ş›Á_£nd
(
ş›Á
,

1181 if(
	`¡rÿ£cmp
(
mode
, "truncate") != 0 && strcasecmp(mode, "append") != 0)

1183 
	`ş›Á_£nd
(
ş›Á
, "ERR mode must beruncate or‡ppend");

1187 if(
	`sÿm³r_outfe_İ’
(
Çme
, 
fe
, 
mode
è=ğ
NULL
)

1189 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot‡dd outfile");

1193 
	`ş›Á_£nd
(
ş›Á
, "OK");

1195 
	}
}

1202 
	$commªd_outfe_sock‘
(
ş›Á_t
 *
ş›Á
, *
buf
)

1204 *
·¿ms
[4], *
Ãxt
;

1205 
i
, 
fd
;

1206 
út
 = (
·¿ms
) / (*);

1207 *
Çme
 = 
NULL
, *
ty³
 = NULL;

1208 
·¿m_t
 
hªdËrs
[] = {

1209 {"Çme", &
Çme
},

1210 {"ty³", &
ty³
},

1212 
hªdËr_út
 = (
hªdËrs
è/ (
·¿m_t
);

1214 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1216 
	`ş›Á_£nd
(
ş›Á
, "ERR source‡dd…arams_get failed");

1220 
i
=0; i<
út
; i += 2)

1222 if(
i
+1 !ğ
út
è
Ãxt
 = 
·¿ms
[i+1];

1223 
Ãxt
 = 
NULL
;

1225 if(
	`·¿m_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
·¿ms
[
i
], 
Ãxt
) == -1)

1227 
	`ş›Á_£nd
(
ş›Á
, "ERR sourû‡dd…¬am '%s' faed", 
·¿ms
[
i
]);

1232 if(
Çme
 =ğ
NULL
 || 
ty³
 == NULL)

1234 
	`ş›Á_£nd
(
ş›Á
, "ERR usage outfile socket‚ame <alias>ype <type>");

1238 if(
	`sÿm³r_outfes_g‘
(
Çme
è!ğ
NULL
)

1240 
	`ş›Á_£nd
(
ş›Á
, "ERR outf'%s'‡Ì—dyƒxi¡s", 
Çme
);

1244 
fd
 = 
	`sÿm³r_fd_fd_g‘
(
ş›Á
->
fdn
);

1245 if(
	`sÿm³r_outfe_İ’fd
(
Çme
, 
fd
, 
ty³
è=ğ
NULL
)

1247 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚oturn socket into outfile");

1251 
	`ş›Á_£nd
(
ş›Á
, "OK");

1253 
	}
}

1260 
	$commªd_outfe_sw­
(
ş›Á_t
 *
ş›Á
, *
buf
)

1262 
sÿm³r_outfe_t
 *
a
, *
b
;

1263 *
fes
[2];

1264 
út
 = 2;

1266 if(
	`·¿ms_g‘
(
buf
, 
fes
, &
út
) == -1)

1268 
	`ş›Á_£nd
(
ş›Á
, "ERR…arams_get failed");

1272 if(
út
 != 2)

1274 
	`ş›Á_£nd
(
ş›Á
, "ERR usage outfile swap <alias 1> <alias 2>");

1278 if((
a
 = 
	`sÿm³r_outfes_g‘
(
fes
[0])è=ğ
NULL
)

1280 
	`ş›Á_£nd
(
ş›Á
, "ERR unknowÀoutf'%s'", 
a
);

1284 if((
b
 = 
	`sÿm³r_outfes_g‘
(
fes
[1])è=ğ
NULL
)

1286 
	`ş›Á_£nd
(
ş›Á
, "ERR unknowÀoutf'%s'", 
b
);

1290 
	`sÿm³r_outfes_sw­
(
a
, 
b
);

1291 
	`ş›Á_£nd
(
ş›Á
, "OK");

1294 
	}
}

1296 
	$commªd_outfe
(
ş›Á_t
 *
ş›Á
, *
buf
)

1298 
commªd_t
 
hªdËrs
[] = {

1299 {"şo£", 
commªd_outfe_şo£
},

1300 {"li¡", 
commªd_outfe_li¡
},

1301 {"İ’", 
commªd_outfe_İ’
},

1302 {"sock‘", 
commªd_outfe_sock‘
},

1303 {"sw­", 
commªd_outfe_sw­
},

1305 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

1306 *
Ãxt
;

1307 
»t
;

1309 if(
buf
 =ğ
NULL
)

1311 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: outfile [close |†ist | open | swap]");

1314 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(
buf
);

1316 if(
	`commªd_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
buf
, 
Ãxt
, &
»t
) == -1)

1318 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd outfcommªd '%s'", 
buf
);

1322 
	}
}

1324 
	$commªd_£t_commªd
(
ş›Á_t
 *
ş›Á
, *
buf
)

1326 if(
	`sÿm³r_commªd_£t
(
buf
) == -1)

1328 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot set command");

1332 
	`ş›Á_£nd
(
ş›Á
, "OK");

1334 
	}
}

1336 
	$commªd_£t_mÚ™ÜÇme
(
ş›Á_t
 *
ş›Á
, *
buf
)

1338 if(
	`sÿm³r_mÚ™ÜÇme_£t
(
buf
) == -1)

1340 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot set monitorname");

1344 
	`ş›Á_£nd
(
ş›Á
, "OK");

1346 
	}
}

1348 
	$commªd_£t_µs
(
ş›Á_t
 *
ş›Á
, *
buf
)

1350  
	`£t_lÚg
(
ş›Á
, 
buf
, "µs", 
sÿm³r_µs_£t
,

1351 
SCAMPER_PPS_MIN
, 
SCAMPER_PPS_MAX
);

1352 
	}
}

1354 
	$commªd_£t_wšdow
(
ş›Á_t
 *
ş›Á
, *
buf
)

1356  
	`£t_lÚg
(
ş›Á
, 
buf
, "wšdow", 
sÿm³r_wšdow_£t
,

1357 
SCAMPER_WINDOW_MIN
, 
SCAMPER_WINDOW_MAX
);

1358 
	}
}

1360 
	$commªd_£t
(
ş›Á_t
 *
ş›Á
, *
buf
)

1362 
commªd_t
 
hªdËrs
[] = {

1363 {"commªd", 
commªd_£t_commªd
},

1364 {"mÚ™ÜÇme", 
commªd_£t_mÚ™ÜÇme
},

1365 {"µs", 
commªd_£t_µs
},

1366 {"wšdow", 
commªd_£t_wšdow
},

1368 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

1369 *
Ãxt
;

1370 
»t
;

1372 if(
buf
 =ğ
NULL
)

1374 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: "

1378 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(
buf
);

1380 if(
	`commªd_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
buf
, 
Ãxt
, &
»t
) == -1)

1382 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd s‘ commªd '%s'", 
buf
);

1385 
	}
}

1398 
	$commªd_sourû_add
(
ş›Á_t
 *
ş›Á
, *
buf
)

1400 
sÿm³r_sourû_·¿ms_t
 
s¥
;

1401 
sÿm³r_sourû_t
 *
sourû
;

1402 *
·¿ms
[24];

1403 
i
, 
út
 = (
·¿ms
) / (*);

1404 *
fe
 = 
NULL
, *
Çme
 = NULL, *
´iÜ™y
 = NULL;

1405 *
desü
 = 
NULL
, *
li¡_id
 = NULL, *
cyşes
 = NULL, *
autÜ–ßd
 = NULL;

1406 *
outfe
 = 
NULL
, *
commªd
 = NULL, *
cyşe_id
 = NULL;

1407 
l
;

1408 
i_cyşes
, 
i_autÜ–ßd
;

1409 *
Ãxt
;

1410 
·¿m_t
 
hªdËrs
[] = {

1411 {"autÜ–ßd", &
autÜ–ßd
},

1412 {"commªd", &
commªd
},

1413 {"cyşe_id", &
cyşe_id
},

1414 {"cyşes", &
cyşes
},

1415 {"desü", &
desü
},

1416 {"fe", &
fe
},

1417 {"li¡_id", &
li¡_id
},

1418 {"Çme", &
Çme
},

1419 {"outfe", &
outfe
},

1420 {"´iÜ™y", &
´iÜ™y
},

1422 
hªdËr_út
 = (
hªdËrs
è/ (
·¿m_t
);

1424 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1426 
	`ş›Á_£nd
(
ş›Á
, "ERR source‡dd…arams_get failed");

1430 
i
=0; i<
út
; i += 2)

1432 if(
i
+1 !ğ
út
è
Ãxt
 = 
·¿ms
[i+1];

1433 
Ãxt
 = 
NULL
;

1435 if(
	`·¿m_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
·¿ms
[
i
], 
Ãxt
) == -1)

1437 
	`ş›Á_£nd
(
ş›Á
, "ERR sourû‡dd…¬am '%s' faed", 
·¿ms
[
i
]);

1442 if(
Çme
 =ğ
NULL
)

1444 
	`ş›Á_£nd
(
ş›Á
, "ERR„equired…arameter 'name' missing");

1448 if(
	`sÿm³r_sourûs_g‘
(
Çme
è!ğ
NULL
)

1450 
	`ş›Á_£nd
(
ş›Á
, "ERR sourû '%s'‡Ì—dyƒxi¡s", 
Çme
);

1454 if(
fe
 =ğ
NULL
)

1456 
	`ş›Á_£nd
(
ş›Á
, "ERR„equired…arameter 'file' missing");

1460 if(
outfe
 =ğ
NULL
)

1462 
	`ş›Á_£nd
(
ş›Á
, "ERR„equired…arameter 'outfile' missing");

1470 
	`mem£t
(&
s¥
, 0, (ssp));

1471 
s¥
.
li¡_id
 = 0;

1472 
s¥
.
cyşe_id
 = 1;

1473 
s¥
.
´iÜ™y
 = 1;

1474 
s¥
.
Çme
 =‚ame;

1475 
s¥
.
desü
 = descr;

1478 if((
s¥
.
sof
 = 
	`sÿm³r_outfes_g‘
(
outfe
)è=ğ
NULL
)

1480 
	`ş›Á_£nd
(
ş›Á
, "ERR unknowÀoutf'%s'", 
outfe
);

1485 if(
li¡_id
 !ğ
NULL
)

1487 if(
	`¡ršg_tŞÚg
(
li¡_id
, &
l
) == -1 ||† < 0 ||† > 0x7fffffffL)

1489 
	`ş›Á_£nd
(
ş›Á
, "ERR†ist_id <number gte 0>");

1492 
s¥
.
li¡_id
 = 
l
;

1496 if(
cyşe_id
 !ğ
NULL
)

1498 if(
	`¡ršg_tŞÚg
(
cyşe_id
, &
l
) == -1 ||† < 0 ||† > 0x7fffffffL)

1500 
	`ş›Á_£nd
(
ş›Á
, "ERR cycle_id <number gte 0>");

1503 
s¥
.
cyşe_id
 = 
l
;

1507 if(
´iÜ™y
 !ğ
NULL
)

1509 if(
	`¡ršg_tŞÚg
(
´iÜ™y
, &
l
) == -1 ||† < 0 ||† > 0x7fffffff)

1511 
	`ş›Á_£nd
(
ş›Á
, "ERR…riority <number gte 0>");

1514 
s¥
.
´iÜ™y
 = 
l
;

1518 if(
autÜ–ßd
 !ğ
NULL
)

1520 if(
	`g‘_sw™ch
(
ş›Á
, "autÜ–ßd", 
autÜ–ßd
, &
l
) != 0)

1524 
i_autÜ–ßd
 = 
l
;

1526 
i_autÜ–ßd
 = 0;

1529 if(
cyşes
 !ğ
NULL
)

1531 if(
	`¡ršg_tŞÚg
(
cyşes
, &
l
) == -1 ||† < 0)

1533 
	`ş›Á_£nd
(
ş›Á
, "ERR cycle <number gte 0>");

1536 
i_cyşes
 = 
l
;

1538 
i_cyşes
 = 1;

1540 if(
commªd
 =ğ
NULL
)

1541 
commªd
 = (*)
	`sÿm³r_commªd_g‘
();

1543 if((
sourû
 = 
	`sÿm³r_sourû_fe_®loc
(&
s¥
, 
fe
, 
commªd
,

1544 
i_cyşes
, 
i_autÜ–ßd
)è=ğ
NULL
)

1546 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot‡lloc source");

1550 if(
	`sÿm³r_sourûs_add
(
sourû
) != 0)

1552 
	`sÿm³r_sourû_ä“
(
sourû
);

1553 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚ot‡dd source");

1557 
	`sÿm³r_sourû_ä“
(
sourû
);

1558 
	`ş›Á_£nd
(
ş›Á
, "OK source‡dded");

1560 
	}
}

1567 
	$commªd_sourû_cyşe
(
ş›Á_t
 *
ş›Á
, *
buf
)

1569 
sÿm³r_sourû_t
 *
sourû
;

1570 *
·¿ms
[1];

1571 *
Çme
;

1572 
út
 = (
·¿ms
) / (*);

1574 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1576 
	`ş›Á_£nd
(
ş›Á
, "ERR source cycle…arams_get failed");

1580 if(
út
 != 1)

1582 
	`ş›Á_£nd
(
ş›Á
, "ERR missing„equired…arameter for source cycle");

1586 
Çme
 = 
·¿ms
[0];

1587 if((
sourû
 = 
	`sÿm³r_sourûs_g‘
(
Çme
)è=ğ
NULL
)

1589 
	`ş›Á_£nd
(
ş›Á
, "ERR‚Øsourû '%s'", 
Çme
);

1593 if(
	`sÿm³r_sourû_cyşe
(
sourû
) == -1)

1595 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚Ù cyşsourû '%s'", 
Çme
);

1599 
	`ş›Á_£nd
(
ş›Á
, "OK");

1602 
	}
}

1609 
	$commªd_sourû_d–‘e
(
ş›Á_t
 *
ş›Á
, *
buf
)

1611 
sÿm³r_sourû_t
 *
sourû
;

1612 *
Çme
;

1613 *
·¿ms
[1];

1614 
út
 = (
·¿ms
) / (*);

1616 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1618 
	`ş›Á_£nd
(
ş›Á
, "ERR source delete…arams_get failed");

1622 if(
út
 != 1)

1624 
	`ş›Á_£nd
(
ş›Á
, "ERR missing„equired…arameter for source delete");

1628 
Çme
 = 
·¿ms
[0];

1630 if((
sourû
 = 
	`sÿm³r_sourûs_g‘
(
Çme
)è=ğ
NULL
)

1632 
	`ş›Á_£nd
(
ş›Á
, "ERR unknowÀsourû '%s'", 
·¿ms
[0]);

1636 if(
	`sÿm³r_sourûs_d–
(
sourû
) == -1)

1638 
	`ş›Á_£nd
(
ş›Á
, "ERR could‚Ù d–‘sourû '%s'", 
Çme
);

1642 
	`ş›Á_£nd
(
ş›Á
, "OK sourû '%s' d–‘ed", 
Çme
);

1645 
	}
}

1647 
	$sourû_fÜ—ch
(*
·¿m
, 
sÿm³r_sourû_t
 *
sourû
)

1649 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
·¿m
;

1650 
¡r
[1024];

1652 if(
	`sourû_to¡r
(
¡r
, (¡r), 
sourû
è!ğ
NULL
)

1654 
	`ş›Á_£nd
(
ş›Á
, "INFO %s", 
¡r
);

1658 
	}
}

1666 
	$commªd_sourû_li¡
(
ş›Á_t
 *
ş›Á
, *
buf
)

1668 
sÿm³r_sourû_t
 *
sourû
;

1669 *
·¿ms
[1], 
¡r
[1024];

1670 *
Çme
;

1671 
út
 = (
·¿ms
) / (*);

1674 if(
buf
 =ğ
NULL
)

1676 
	`sÿm³r_sourûs_fÜ—ch
(
ş›Á
, 
sourû_fÜ—ch
);

1677 
	`ş›Á_£nd
(
ş›Á
, "OK");

1682 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1 || cnt != 1)

1684 
	`ş›Á_£nd
(
ş›Á
, "ERR source check…arams_get failed");

1687 
Çme
 = 
·¿ms
[0];

1688 if((
sourû
 = 
	`sÿm³r_sourûs_g‘
(
Çme
)è=ğ
NULL
)

1690 
	`ş›Á_£nd
(
ş›Á
, "ERR‚Øsourû '%s'", 
Çme
);

1693 
	`ş›Á_£nd
(
ş›Á
, "INFO %s", 
	`sourû_to¡r
(
¡r
, (¡r), 
sourû
));

1694 
	`ş›Á_£nd
(
ş›Á
, "OK");

1697 
	}
}

1706 
	$commªd_sourû_upd©e
(
ş›Á_t
 *
ş›Á
, *
buf
)

1708 
sÿm³r_sourû_t
 *
sourû
;

1709 *
autÜ–ßd
 = 
NULL
, *
cyşes
 = NULL, *
´iÜ™y
 = NULL;

1710 
i_autÜ–ßd
, 
i_cyşes
;

1711 
l
;

1712 
i
, 
út
, 
hªdËr_út
;

1713 *
·¿ms
[10], *
Ãxt
;

1714 
·¿m_t
 
hªdËrs
[] = {

1715 {"autÜ–ßd", &
autÜ–ßd
},

1716 {"cyşes", &
cyşes
},

1717 {"´iÜ™y", &
´iÜ™y
},

1720 if(
buf
 =ğ
NULL
)

1722 
	`ş›Á_£nd
(
ş›Á
, "ERR missing‚ame…arameter");

1726 
út
 = (
·¿ms
) / (*);

1727 if(
	`·¿ms_g‘
(
buf
, 
·¿ms
, &
út
) == -1)

1729 
	`ş›Á_£nd
(
ş›Á
, "ERR source update…arams_get failed");

1734 if(
út
 < 1)

1736 
	`ş›Á_£nd
(
ş›Á
, "ERR missing‚ame…arameter");

1741 if((
sourû
 = 
	`sÿm³r_sourûs_g‘
(
·¿ms
[0])è=ğ
NULL
)

1743 
	`ş›Á_£nd
(
ş›Á
, "ERR‚Øsuch sourû '%s'", 
·¿ms
[0]);

1748 
i
=1; i<
út
; i += 2)

1750 if(
i
+1 !ğ
út
è
Ãxt
 = 
·¿ms
[i+1];

1751 
Ãxt
 = 
NULL
;

1753 
hªdËr_út
 = (
hªdËrs
è/ (
·¿m_t
);

1754 if(
	`·¿m_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
·¿ms
[
i
], 
Ãxt
) == -1)

1756 
	`ş›Á_£nd
(
ş›Á
, "ERR sourû upd©·¿m '%s' faed",
·¿ms
[
i
]);

1762 if(
	`sÿm³r_sourû_g‘ty³
(
sourû
è!ğ
SCAMPER_SOURCE_TYPE_FILE
)

1764 if(
autÜ–ßd
 !ğ
NULL
 || 
cyşes
 != NULL)

1766 
	`ş›Á_£nd
(
ş›Á
,

1768 
	`sÿm³r_sourû_ty³_to¡r
(
sourû
));

1774 if(
autÜ–ßd
 !ğ
NULL
)

1776 if(
	`g‘_sw™ch
(
ş›Á
, "autÜ–ßd", 
autÜ–ßd
, &
l
) == -1)

1778 
	`ş›Á_£nd
(
ş›Á
, "ERR‡utoreload <on|off>");

1781 
i_autÜ–ßd
 = 
l
;

1784 if(
cyşes
 !ğ
NULL
)

1786 if(
	`¡ršg_tŞÚg
(
cyşes
, &
l
) == -1 ||† < 0)

1788 
	`ş›Á_£nd
(
ş›Á
, "ERR cycles <number gte 0>");

1791 
i_cyşes
 = 
l
;

1795 if(
´iÜ™y
 !ğ
NULL
)

1797 if(
	`¡ršg_tŞÚg
(
´iÜ™y
, &
l
) == -1 ||† < 0)

1799 
	`ş›Á_£nd
(
ş›Á
, "ERR…riority <number gte 0>");

1802 
	`sÿm³r_sourû_£riÜ™y
(
sourû
, (
ušt32_t
)
l
);

1805 if(
autÜ–ßd
 !ğ
NULL
 || 
cyşes
 != NULL)

1807 
	`sÿm³r_sourû_fe_upd©e
(
sourû
,

1808 (
autÜ–ßd
 !ğ
NULL
 ? &
i_autÜ–ßd
 : NULL),

1809 (
cyşes
 !ğ
NULL
 ? &
i_cyşes
 : NULL));

1812 
	`ş›Á_£nd
(
ş›Á
, "OK");

1814 
	}
}

1816 
	$commªd_sourû
(
ş›Á_t
 *
ş›Á
, *
buf
)

1818 
commªd_t
 
hªdËrs
[] = {

1819 {"add", 
commªd_sourû_add
},

1820 {"cyşe", 
commªd_sourû_cyşe
},

1821 {"d–‘e", 
commªd_sourû_d–‘e
},

1822 {"li¡", 
commªd_sourû_li¡
},

1823 {"upd©e", 
commªd_sourû_upd©e
},

1825 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

1826 *
Ãxt
;

1827 
»t
;

1829 if(
buf
 =ğ
NULL
)

1831 
	`ş›Á_£nd
(
ş›Á
,

1836 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(
buf
);

1837 if(
	`commªd_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
buf
, 
Ãxt
, &
»t
) == -1)

1839 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd commªd '%s'", 
buf
);

1844 
	}
}

1846 
	$commªd_shutdown_ÿnûl
(
ş›Á_t
 *
ş›Á
, *
buf
)

1848 
	`sÿm³r_ex™wh’dÚe
(0);

1849 
	`ş›Á_£nd
(
ş›Á
, "OK");

1851 
	}
}

1853 
	$commªd_shutdown_dÚe
(
ş›Á_t
 *
ş›Á
, *
buf
)

1855 
	`sÿm³r_ex™wh’dÚe
(1);

1856 
	`ş›Á_£nd
(
ş›Á
, "OK");

1858 
	}
}

1860 
	$commªd_shutdown_æush
(
ş›Á_t
 *
ş›Á
, *
buf
)

1863 
	`sÿm³r_sourûs_em±y
();

1866 
	`sÿm³r_ex™wh’dÚe
(1);

1868 
	`ş›Á_£nd
(
ş›Á
, "OK");

1870 
	}
}

1872 
	$commªd_shutdown_now
(
ş›Á_t
 *
ş›Á
, *
buf
)

1875 
	`sÿm³r_queue_em±y
();

1878 
	`sÿm³r_sourûs_em±y
();

1881 
	`sÿm³r_ex™wh’dÚe
(1);

1883 
	`ş›Á_£nd
(
ş›Á
, "OK");

1886 
	}
}

1888 
	$commªd_shutdown
(
ş›Á_t
 *
ş›Á
, *
buf
)

1890 
commªd_t
 
hªdËrs
[] = {

1891 {"ÿnûl", 
commªd_shutdown_ÿnûl
},

1892 {"dÚe", 
commªd_shutdown_dÚe
},

1893 {"æush", 
commªd_shutdown_æush
},

1894 {"now", 
commªd_shutdown_now
},

1896 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

1897 *
Ãxt
;

1898 
»t
;

1900 if(
buf
 =ğ
NULL
)

1902 
	`ş›Á_£nd
(
ş›Á
, "ERR usage: [cancel | done | flush |‚ow]");

1906 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(
buf
);

1907 if(
	`commªd_hªdËr
(
hªdËrs
, 
hªdËr_út
, 
ş›Á
, 
buf
, 
Ãxt
, &
»t
) == -1)

1909 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd commªd '%s'", 
buf
);

1914 
	}
}

1916 
	$ş›Á_isdÚe
(
ş›Á_t
 *
ş›Á
)

1918 
size_t
 
Ën
;

1919 
c
;

1921 
	`as£¹
(
ş›Á
->
wb
 !ğ
NULL
);

1923 if((
Ën
 = 
	`sÿm³r_wr™ebuf_Ën
(
ş›Á
->
wb
)) != 0)

1925 
	`sÿm³r_debug
(
__func__
, "ş›Á wr™ebuàËÀ%d", 
Ën
);

1929 if(
ş›Á
->
sourû
 !ğ
NULL
 && 
	`sÿm³r_sourû_isfšished
(client->source) == 0)

1931 
	`sÿm³r_debug
(
__func__
, "source‚ot finished");

1935 if(
ş›Á
->
sof_obj
 !ğ
NULL
)

1937 
	`sÿm³r_debug
(
__func__
, "object…artially written");

1941 if(
ş›Á
->
sof_objs
 !ğ
NULL
 && (
c
 = 
	`¦i¡_couÁ
(client->sof_objs)) != 0)

1943 
	`sÿm³r_debug
(
__func__
, "objeù out¡ªdšg %d", 
c
);

1948 
	}
}

1950 
	$ş›Á_”rÜ
(*
±r
, 
”r
, 
sÿm³r_wr™ebuf_t
 *
wb
)

1952 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
±r
;

1953 
	`´š‹¼Ü
(
”r
, 
¡»¼Ü
, 
__func__
, "fd %d", 
	`sÿm³r_fd_fd_g‘
(
ş›Á
->
fdn
));

1954 
	`ş›Á_ä“
(
ş›Á
);

1956 
	}
}

1965 
	$ş›Á_d¿šed
(*
±r
, 
sÿm³r_wr™ebuf_t
 *
wb
)

1967 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
±r
;

1969 if(
ş›Á
->
mode
 !ğ
CLIENT_MODE_FLUSH
)

1972 if(
	`ş›Á_isdÚe
(
ş›Á
) == 0)

1975 
	`ş›Á_ä“
(
ş›Á
);

1977 
	}
}

1986 
	$ş›Á_©ched_cb
(
ş›Á_t
 *
ş›Á
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

1988 *
¡r
;

1989 
l
;

1990 
ušt32_t
 
id
;

1992 
	`as£¹
(
ş›Á
->
sourû
 !ğ
NULL
);

1995 if(
Ën
 =ğ4 && 
	`¡rÿ£cmp
((*)
buf
, "done") == 0)

1997 
	`ş›Á_£nd
(
ş›Á
, "OK");

1998 
	`sÿm³r_sourû_cÚŒŞ_fšish
(
ş›Á
->
sourû
);

2002 if(
Ën
 >ğ5 && 
	`¡ºÿ£cmp
((*)
buf
, "halt ", 5) == 0)

2004 
¡r
 = 
	`¡ršg_ÃxtwÜd
((*)
buf
);

2005 if(
	`¡ršg_i¢umb”
(
¡r
) == 0)

2006  
	`ş›Á_£nd
(
ş›Á
, "ERR usage: halt [id]");

2007 if(
	`¡ršg_tŞÚg
(
¡r
, &
l
) != 0 ||† <= 0 ||† > 0xffffffffUL)

2008  
	`ş›Á_£nd
(
ş›Á
, "ERR halt‚umber invalid");

2009 
id
 = 
l
;

2010 if(
	`sÿm³r_sourû_h®‰ask
(
ş›Á
->
sourû
, 
id
) != 0)

2011  
	`ş›Á_£nd
(
ş›Á
, "ERR‚Øsk id-%d", 
id
);

2012  
	`ş›Á_£nd
(
ş›Á
, "OK h®‹d %ld", 
id
);

2016 if(
	`sÿm³r_sourû_commªd2
(
ş›Á
->
sourû
, (*)
buf
, &
id
) != 0)

2017  
	`ş›Á_£nd
(
ş›Á
, "ERR command‚ot‡ccepted");

2019  
	`ş›Á_£nd
(
ş›Á
, "OK id-%d", 
id
);

2020 
	}
}

2022 
	$ş›Á_š‹¿ùive_cb
(
ş›Á_t
 *
ş›Á
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

2024 
commªd_t
 
hªdËrs
[] = {

2025 #iâdeà
_WIN32


2026 {"©ch", 
commªd_©ch
},

2028 {"ex™", 
commªd_ex™
},

2029 {"g‘", 
commªd_g‘
},

2030 {"h–p", 
commªd_h–p
},

2031 {"lss-ş—r", 
commªd_lss_ş—r
},

2032 {"ob£rve", 
commªd_ob£rve
},

2033 {"outfe", 
commªd_outfe
},

2034 {"£t", 
commªd_£t
},

2035 {"shutdown", 
commªd_shutdown
},

2036 {"sourû", 
commªd_sourû
},

2038 
hªdËr_út
 = (
hªdËrs
è/ (
commªd_t
);

2039 *
Ãxt
;

2040 
»t
;

2043 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
((*)
buf
);

2045 if(
	`commªd_hªdËr
(
hªdËrs
,
hªdËr_út
,
ş›Á
,(*)
buf
,
Ãxt
,&
»t
) == -1)

2047 
	`ş›Á_£nd
(
ş›Á
, "ERR unhªdËd commªd '%s'", 
buf
);

2052 
	}
}

2061 
	$ş›Á_»ad_lše
(*
·¿m
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

2063 (*cÚ¡ 
func
[])(
ş›Á_t
 *, 
ušt8_t
 *, 
size_t
) = {

2064 
ş›Á_š‹¿ùive_cb
,

2065 
ş›Á_©ched_cb
,

2066 
NULL
,

2068 
ş›Á_t
 *
ş›Á
 = (ş›Á_ˆ*)
·¿m
;

2071 if(
	`¡ršg_i¥ršt
((*)
buf
, 
Ën
) == 0)

2073 
	`ş›Á_£nd
(
ş›Á
, "ERR invalid character in†ine");

2074 
ş›Á
->
mode
 = 
CLIENT_MODE_FLUSH
;

2078 if(
func
[
ş›Á
->
mode
] !ğ
NULL
)

2079  
func
[
ş›Á
->
mode
](ş›Á, 
buf
, 
Ën
);

2081 
	}
}

2083 
	$ş›Á_»ad
(cÚ¡ 
fd
, *
·¿m
)

2085 
ş›Á_t
 *
ş›Á
;

2086 
ssize_t
 
rc
;

2087 
ušt8_t
 
buf
[256];

2089 
ş›Á
 = (
ş›Á_t
 *)
·¿m
;

2090 
	`as£¹
(
	`sÿm³r_fd_fd_g‘
(
ş›Á
->
fdn
è=ğ
fd
);

2093 if((
rc
 = 
	`»ad
(
fd
, 
buf
, (buf))) < 0)

2095 if(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

2097 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "read failed");

2101 
	`ş›Á_ä“
(
ş›Á
);

2106 if(
rc
 > 0)

2108 
	`sÿm³r_lš•Şl_hªdË
(
ş›Á
->
Í
, 
buf
, (
size_t
)
rc
);

2113 
	`sÿm³r_fd_»ad_·u£
(
ş›Á
->
fdn
);

2115 if(
ş›Á
->
sourû
 !ğ
NULL
)

2117 
	`sÿm³r_sourû_cÚŒŞ_fšish
(
ş›Á
->
sourû
);

2118 
	`sÿm³r_sourû_abªdÚ
(
ş›Á
->
sourû
);

2121 if(
	`ş›Á_isdÚe
(
ş›Á
) != 0)

2123 
	`ş›Á_ä“
(
ş›Á
);

2126 
ş›Á
->
mode
 = 
CLIENT_MODE_FLUSH
;

2129 
	}
}

2136 
ş›Á_t
 *
	$ş›Á_®loc
(
sockaddr
 *
§
, 
sockËn_t
 
¦’
, 
fd
)

2138 
ş›Á_t
 *
ş›Á
;

2141 #iâdeà
_WIN32


2142 if(
	`fú_£t
(
fd
, 
O_NONBLOCK
) == -1)

2144  
NULL
;

2149 if((
ş›Á
 = 
	`m®loc_z”o
((ş›Á))è=ğ
NULL
)

2151  
NULL
;

2155 if((
ş›Á
->
node
 = 
	`dli¡__push
(
ş›Á_li¡
, cl›Á)è=ğ
NULL
)

2157 
ş—nup
;

2161 if((
ş›Á
->
§
 = 
	`memdup
(§, 
¦’
)è=ğ
NULL
)

2163 
ş—nup
;

2167 if((
ş›Á
->
fdn
=
	`sÿm³r_fd_´iv©e
(
fd
,
ş›Á_»ad
,ş›Á,
NULL
,NULL)) == NULL)

2169 
ş—nup
;

2173 if((
ş›Á
->
Í
 = 
	`sÿm³r_lš•Şl_®loc
(
ş›Á_»ad_lše
, cl›Á)è=ğ
NULL
)

2175 
ş—nup
;

2178 if((
ş›Á
->
wb
 = 
	`sÿm³r_wr™ebuf_®loc
()è=ğ
NULL
)

2180 
ş—nup
;

2182 
	`sÿm³r_wr™ebuf_©ch
(
ş›Á
->
wb
, cl›Á->
fdn
, client,

2183 
ş›Á_”rÜ
, 
ş›Á_d¿šed
);

2185 
ş›Á
->
mode
 = 
CLIENT_MODE_INTERACTIVE
;

2187  
ş›Á
;

2189 
ş—nup
:

2190 if(
ş›Á
->
wb
 !ğ
NULL
è
	`sÿm³r_wr™ebuf_ä“
(client->wb);

2191 if(
ş›Á
->
Í
 !ğ
NULL
è
	`sÿm³r_lš•Şl_ä“
(client->lp, 0);

2192 if(
ş›Á
->
node
 !ğ
NULL
è
	`dli¡_node_pİ
(
ş›Á_li¡
, client->node);

2193 if(
ş›Á
->
§
 !ğ
NULL
è
	`ä“
(client->sa);

2194 
	`ä“
(
ş›Á
);

2196  
NULL
;

2197 
	}
}

2199 
	$cÚŒŞ_acû±
(cÚ¡ 
fd
, *
·¿m
)

2201 
sockaddr_¡Üage
 
ss
;

2202 
sockËn_t
 
sockËn
;

2203 
s
;

2206 
sockËn
 = (
ss
);

2207 if((
s
 = 
	`acû±
(
fd
, (
sockaddr
 *)&
ss
, &
sockËn
)) == -1)

2212 
	`sÿm³r_debug
(
__func__
, "fd %d", 
s
);

2215 if(
	`ş›Á_®loc
((
sockaddr
 *)&
ss
, 
sockËn
, 
s
è=ğ
NULL
)

2217 
	`shutdown
(
s
, 
SHUT_RDWR
);

2218 
	`şo£
(
s
);

2222 
	}
}

2224 
	$cÚŒŞ_š™
(
fd
)

2226 if((
ş›Á_li¡
 = 
	`dli¡_®loc
()è=ğ
NULL
)

2228 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc client_list");

2232 if((
fdn
 = 
	`sÿm³r_fd_´iv©e
(
fd
, 
cÚŒŞ_acû±
, 
NULL
, NULL, NULL)) == NULL)

2234 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd fd");

2239 
	}
}

2241 
	$sÿm³r_cÚŒŞ_š™_unix
(cÚ¡ *
fe
)

2243 #ià
	`defšed
(
AF_UNIX
è&& !defšed(
_WIN32
)

2244 
fd
 = -1;

2246 #ifdeà
WITHOUT_PRIVSEP


2247 
sockaddr_un
 
¢
;

2248 
uid_t
 
uid
;

2250 if(
	`sockaddr_compo£_un
((
sockaddr
 *)&
¢
, 
fe
) != 0)

2252 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot compose socket");

2253 
”r
;

2256 if((
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) == -1)

2258 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create socket");

2259 
”r
;

2262 if(
	`bšd
(
fd
, (
sockaddr
 *)&
¢
, (sn)) != 0)

2264 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind");

2265 
”r
;

2268 if((
uid
 = 
	`g‘uid
()è!ğ
	`g‘euid
(è&& 
	`chown
(
fe
, uid, -1) != 0)

2270 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot chown");

2271 
”r
;

2274 if(
	`li¡’
(
fd
, -1) != 0)

2276 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot†isten");

2277 
”r
;

2281 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_unix
(
fe
)) == -1)

2283 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open unix socket");

2284 
”r
;

2288 if(
	`cÚŒŞ_š™
(
fd
) != 0)

2289 
”r
;

2291 if((
ù¾_unix_Çme
 = 
	`¡rdup
(
fe
)è=ğ
NULL
)

2293 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup file");

2294 
”r
;

2299 
”r
:

2300 if(
fd
 !ğ-1 && 
fdn
 =ğ
NULL
)

2301 
	`şo£
(
fd
);

2305 
	}
}

2307 
	$sÿm³r_cÚŒŞ_š™_pÜt
(
pÜt
)

2309 
sockaddr_š
 
sš
;

2310 
š_addr
 
š
;

2311 
fd
 = -1, 
İt
;

2314 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) == -1)

2316 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create socket");

2317 
”r
;

2320 
İt
 = 1;

2321 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
İt
, (opt)) != 0)

2323 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_REUSEADDR");

2324 
”r
;

2327 
İt
 = 1;

2328 if(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
İt
, (opt)) != 0)

2330 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set TCP_NODELAY");

2331 
”r
;

2335 
š
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

2336 
	`sockaddr_compo£
((
sockaddr
 *)&
sš
, 
AF_INET
, &
š
, 
pÜt
);

2337 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš
, (sin)) == -1)

2339 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù bšdØpÜˆ%d", 
pÜt
);

2340 
”r
;

2344 if(
	`li¡’
(
fd
, -1) == -1)

2346 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot†isten");

2347 
”r
;

2350 if(
	`cÚŒŞ_š™
(
fd
) != 0)

2351 
”r
;

2355 
”r
:

2356 if(
fd
 !ğ-1 && 
fdn
 =ğ
NULL
)

2357 
	`şo£
(
fd
);

2359 
	}
}

2368 
	$sÿm³r_cÚŒŞ_ş—nup
()

2370 
ş›Á_t
 *
ş›Á
;

2371 
fd
;

2373 if(
ş›Á_li¡
 !ğ
NULL
)

2375 (
ş›Á
 = 
	`dli¡_h—d_pİ
(
ş›Á_li¡
)è!ğ
NULL
)

2377 
ş›Á
->
node
 = 
NULL
;

2378 
	`sÿm³r_wr™ebuf_æush
(
ş›Á
->
wb
);

2379 
	`ş›Á_ä“
(
ş›Á
);

2382 
	`dli¡_ä“
(
ş›Á_li¡
);

2383 
ş›Á_li¡
 = 
NULL
;

2387 if(
fdn
 !ğ
NULL
)

2389 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
fdn
)) != -1)

2391 
	`şo£
(
fd
);

2393 #ià
	`defšed
(
AF_UNIX
è&& !defšed(
_WIN32
)

2394 if(
ù¾_unix_Çme
 !ğ
NULL
)

2395 #iâdeà
WITHOUT_PRIVSEP


2396 
	`sÿm³r_´iv£p_uÆšk
(
ù¾_unix_Çme
);

2398 
	`uÆšk
(
ù¾_unix_Çme
);

2403 
	`sÿm³r_fd_ä“
(
fdn
);

2404 
fdn
 = 
NULL
;

2407 #ià
	`defšed
(
AF_UNIX
è&& !defšed(
_WIN32
)

2408 if(
ù¾_unix_Çme
 !ğ
NULL
)

2410 
	`ä“
(
ù¾_unix_Çme
);

2411 
ù¾_unix_Çme
 = 
NULL
;

2416 
	}
}

	@scamper_control.h

25 #iâdeà
__SCAMPER_CONTROL_H


26 
	#__SCAMPER_CONTROL_H


	)

28 
sÿm³r_cÚŒŞ_š™_pÜt
(
pÜt
);

29 
sÿm³r_cÚŒŞ_š™_unix
(cÚ¡ *
Çme
);

30 
sÿm³r_cÚŒŞ_ş—nup
();

	@scamper_cyclemon.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_outfes.h
"

37 
	~"sÿm³r_sk.h
"

38 
	~"sÿm³r_sourûs.h
"

39 
	~"sÿm³r_cyşemÚ.h
"

40 
	~"uts.h
"

42 
	ssÿm³r_cyşemÚ


44 
sÿm³r_cyşe
 *
	mcyşe
;

45 
sÿm³r_cyşemÚ_fšish_t
 
	mfšish
;

46 
sÿm³r_sourû_t
 *
	msourû
;

47 
sÿm³r_outfe_t
 *
	moutfe
;

48 
	m»fút
;

51 
sÿm³r_cyşe_t
 *
	$sÿm³r_cyşemÚ_cyşe
(cÚ¡ 
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

53 if(
cyşemÚ
 !ğ
NULL
)

55  
cyşemÚ
->
cyşe
;

57  
NULL
;

58 
	}
}

60 
	$sÿm³r_cyşemÚ_sourû_d‘ach
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

62 
cyşemÚ
->
sourû
 = 
NULL
;

64 
	}
}

70 
	$sÿm³r_cyşemÚ_ä“
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

72 if(
cyşemÚ
 =ğ
NULL
)

77 if(
cyşemÚ
->
cyşe
 !ğ
NULL
)

79 
	`sÿm³r_cyşe_ä“
(
cyşemÚ
->
cyşe
);

82 if(
cyşemÚ
->
outfe
 !ğ
NULL
)

84 
	`sÿm³r_outfe_ä“
(
cyşemÚ
->
outfe
);

87 
	`ä“
(
cyşemÚ
);

89 
	}
}

91 
	$sÿm³r_cyşemÚ_unu£
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

93 if(
cyşemÚ
 =ğ
NULL
)

98 
cyşemÚ
->
»fút
--;

104 if(
cyşemÚ
->
»fút
 > 0)

109 
cyşemÚ
->
	`fšish
(cyşemÚ->
cyşe
, cyşemÚ->
sourû
, cyşemÚ->
outfe
);

111 
	`sÿm³r_cyşemÚ_ä“
(
cyşemÚ
);

113 
	}
}

115 
sÿm³r_cyşemÚ_t
 *
	$sÿm³r_cyşemÚ_u£
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

117 if(
cyşemÚ
 !ğ
NULL
ècyşemÚ->
»fút
++;

118  
cyşemÚ
;

119 
	}
}

121 
	$sÿm³r_cyşemÚ_»fút
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
)

123  
cyşemÚ
->
»fút
;

124 
	}
}

126 
sÿm³r_cyşemÚ_t
 *
	$sÿm³r_cyşemÚ_®loc
(
sÿm³r_cyşe_t
 *
cyşe
,

127 
sÿm³r_cyşemÚ_fšish_t
 
fšish
,

128 
sÿm³r_sourû_t
 *
sourû
,

129 
sÿm³r_outfe_t
 *
outfe
)

131 
sÿm³r_cyşemÚ_t
 *
cyşemÚ
;

133 if((
cyşemÚ
 = 
	`m®loc_z”o
((
sÿm³r_cyşemÚ_t
))è!ğ
NULL
)

135 
cyşemÚ
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

136 
cyşemÚ
->
outfe
 = 
	`sÿm³r_outfe_u£
(outfile);

137 
cyşemÚ
->
fšish
 = finish;

138 
cyşemÚ
->
sourû
 = source;

139 
cyşemÚ
->
»fút
 = 1;

142  
cyşemÚ
;

143 
	}
}

	@scamper_cyclemon.h

25 #iâdeà
__SCAMPER_CYCLEMON_H


26 
	#__SCAMPER_CYCLEMON_H


	)

28 
	gsÿm³r_sourû
;

29 
	gsÿm³r_outfe
;

31 (*
	tsÿm³r_cyşemÚ_fšish_t
)(
	tsÿm³r_cyşe_t
 *
	tcyşe
,

32 
	tsÿm³r_sourû
 *
	tsourû
,

33 
	tsÿm³r_outfe
 *
	toutfe
);

36 
sÿm³r_cyşemÚ
 
	tsÿm³r_cyşemÚ_t
;

39 
sÿm³r_cyşemÚ_t
 *
	`sÿm³r_cyşemÚ_®loc
(
sÿm³r_cyşe_t
 *
cyşe
,

40 
sÿm³r_cyşemÚ_fšish_t
 
fšish
,

41 
sÿm³r_sourû
 *
sourû
,

42 
sÿm³r_outfe
 *
outfe
);

44 
sÿm³r_cyşe_t
 *
	`sÿm³r_cyşemÚ_cyşe
(cÚ¡ 
sÿm³r_cyşemÚ_t
 *
cyşemÚ
);

46 
	`sÿm³r_cyşemÚ_sourû_d‘ach
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
);

49 
sÿm³r_cyşemÚ_t
 *
	`sÿm³r_cyşemÚ_u£
(sÿm³r_cyşemÚ_ˆ*
cyşemÚ
);

50 
	`sÿm³r_cyşemÚ_unu£
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
);

52 
	`sÿm³r_cyşemÚ_»fút
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
);

55 
	`sÿm³r_cyşemÚ_ä“
(
sÿm³r_cyşemÚ_t
 *
cyşemÚ
);

	@scamper_debug.c

28 #iâdeà
lšt


29 cÚ¡ 
	grcsid
[] =

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

36 
	~"š‹º®.h
"

38 
	~"sÿm³r.h
"

39 
	~"sÿm³r_debug.h
"

40 
	~"sÿm³r_´iv£p.h
"

41 
	~"uts.h
"

43 #iâdeà
WITHOUT_DEBUGFILE


44 
FILE
 *
	gdebugfe
 = 
NULL
;

47 *
	$time¡amp_¡r
(*
buf
, cÚ¡ 
size_t
 
Ën
)

49 
timev®
 
tv
;

50 
tm
 *tm;

51 
ms
;

52 
time_t
 
t
;

54 
buf
[0] = '\0';

55 
	`g‘timeofday_w¿p
(&
tv
);

56 
t
 = 
tv
.
tv_£c
;

57 if((
tm
 = 
	`loÿÉime
(&
t
)è=ğ
NULL
è 
buf
;

59 
ms
 = 
tv
.
tv_u£c
 / 1000;

60 
	`¢´štf
(
buf
, 
Ën
, "[%02d:%02d:%02d:%03d] ",

61 
tm
->
tm_hour
,m->
tm_mš
,m->
tm_£c
, 
ms
);

63  
buf
;

64 
	}
}

66 #iâdeà
NDEBUG


67 
	$__sÿm³r_as£¹
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
func
,

68 cÚ¡ *
ex´
, *
d©a
)

70 
ts
[16];

72 
	`time¡amp_¡r
(
ts
, (ts));

74 
	`årštf
(
¡d”r
, "%s‡ssertion failed: %s:%d %s `%s'\n",

75 
ts
, 
fe
, 
lše
, 
func
, 
ex´
);

76 
	`fæush
(
¡d”r
);

78 #iâdeà
WITHOUT_DEBUGFILE


79 if(
debugfe
 !ğ
NULL
)

81 
	`årštf
(
debugfe
, "%s‡ssertion failed: %s:%d %s `%s'\n",

82 
ts
, 
fe
, 
lše
, 
func
, 
ex´
);

83 
	`fæush
(
debugfe
);

87 
	`abÜt
();

89 
	}
}

92 *
	$”rÜ_¡r
(
e
, *(*
”rÜ_™ß
)(), *
buf
, 
size_t
 
Ën
)

94 *
¡r
;

96 if(
”rÜ_™ß
 =ğ
NULL
 || (
¡r
 = 
	`”rÜ_™ß
(
e
)) == NULL)

98 
buf
[0] = '\0';

99  
buf
;

102 
	`¢´štf
(
buf
, 
Ën
, ": %s", 
¡r
);

103  
buf
;

104 
	}
}

112 
	$´š‹¼Ü
(cÚ¡ 
ecode
, *(*
”rÜ_™ß
)(),

113 cÚ¡ *
func
, cÚ¡ *
fÜm©
, ...)

115 
mes§ge
[512];

116 
”r
[128];

117 
ts
[16];

118 
fs
[64];

119 
va_li¡
 
­
;

121 
	`va_¡¬t
(
­
, 
fÜm©
);

122 
	`v¢´štf
(
mes§ge
, (mes§ge), 
fÜm©
, 
­
);

123 
	`va_’d
(
­
);

125 
	`”rÜ_¡r
(
ecode
, 
”rÜ_™ß
, 
”r
, (err));

126 
	`time¡amp_¡r
(
ts
, (ts));

128 if(
func
 !ğ
NULL
è
	`¢´štf
(
fs
, (fs), "%s: ", func);

129 
fs
[0] = '\0';

131 
	`årštf
(
¡d”r
, "%s%s%s%s\n", 
ts
, 
fs
, 
mes§ge
, 
”r
);

132 
	`fæush
(
¡d”r
);

134 #iâdeà
WITHOUT_DEBUGFILE


135 if(
debugfe
 !ğ
NULL
)

137 
	`årštf
(
debugfe
, "%s%s%s%s\n", 
ts
, 
fs
, 
mes§ge
, 
”r
);

138 
	`fæush
(
debugfe
);

143 
	}
}

145 #ifdeà
HAVE_SCAMPER_DEBUG


146 
	$sÿm³r_debug
(cÚ¡ *
func
, cÚ¡ *
fÜm©
, ...)

148 
mes§ge
[512];

149 
va_li¡
 
­
;

150 
ts
[16];

151 
fs
[64];

153 #ià!
	`defšed
(
WITHOUT_DEBUGFILE
è&& defšed(
NDEBUG
)

154 if(
debugfe
 =ğ
NULL
)

158 
	`as£¹
(
fÜm©
 !ğ
NULL
);

160 
	`va_¡¬t
(
­
, 
fÜm©
);

161 
	`v¢´štf
(
mes§ge
, (mes§ge), 
fÜm©
, 
­
);

162 
	`va_’d
(
­
);

164 
	`time¡amp_¡r
(
ts
, (ts));

166 if(
func
 !ğ
NULL
è
	`¢´štf
(
fs
, (fs), "%s: ", func);

167 
fs
[0] = '\0';

169 #iâdeà
NDEBUG


170 
	`årštf
(
¡d”r
, "%s%s%s\n", 
ts
, 
fs
, 
mes§ge
);

171 
	`fæush
(
¡d”r
);

174 #iâdeà
WITHOUT_DEBUGFILE


175 if(
debugfe
 !ğ
NULL
)

177 
	`årštf
(
debugfe
, "%s%s%s\n", 
ts
, 
fs
, 
mes§ge
);

178 
	`fæush
(
debugfe
);

183 
	}
}

186 #iâdeà
WITHOUT_DEBUGFILE


187 
	$sÿm³r_debug_İ’
(cÚ¡ *
fe
)

189 
mode_t
 
mode
;

190 
æags
, 
fd
;

192 #ià
	`defšed
(
WITHOUT_PRIVSEP
è&& !defšed(
_WIN32
)

193 
uid_t
 
uid
 = 
	`g‘uid
();

196 #iâdeà
_WIN32


197 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

199 
mode
 = 
_S_IREAD
 | 
_S_IWRITE
;

202 if(
	`sÿm³r_İtiÚ_debugf—µ’d
() == 0)

203 
æags
 = 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
;

205 
æags
 = 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
;

207 #iâdeà
WITHOUT_PRIVSEP


208 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
fe
, 
æags
, 
mode
);

210 
fd
 = 
	`İ’
(
fe
, 
æags
, 
mode
);

213 if(
fd
 == -1)

215 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

216 "could‚Ù o³Àdebugf%s", 
fe
);

220 if((
debugfe
 = 
	`fdİ’
(
fd
, "a")è=ğ
NULL
)

222 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

223 "could‚Ù fdİ’ debugf%s", 
fe
);

227 #ià
	`defšed
(
WITHOUT_PRIVSEP
è&& !defšed(
_WIN32
)

228 if(
uid
 !ğ
	`g‘euid
(è&& 
	`fchown
(
fd
, uid, -1) != 0)

230 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot fchown");

235 
	}
}

237 
	$sÿm³r_debug_şo£
()

239 if(
debugfe
 !ğ
NULL
)

241 
	`fşo£
(
debugfe
);

242 
debugfe
 = 
NULL
;

245 
	}
}

	@scamper_debug.h

25 #iâdeà
__SCAMPER_DEBUG_H


26 
	#__SCAMPER_DEBUG_H


	)

28 
´š‹¼Ü
(cÚ¡ 
ecode
, *(*
”rÜ_™ß
)(),

29 cÚ¡ *
func
, cÚ¡ *
fÜm©
, ...);

31 #ifdeà
NDEBUG


32 
	#sÿm³r_as£¹
(
ex´
, 
sk
è(()0)

	)

34 
	#sÿm³r_as£¹
(
ex´
, 
sk
) ((expr) ? ()0 : \

35 
	`__sÿm³r_as£¹
(
__FILE__
,
__LINE__
,
__FUNC__
, #ex´, 
sk
))

	)

36 
__sÿm³r_as£¹
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
func
,

37 cÚ¡ *
ex´
, *
sk
);

41 #ià
defšed
(
NDEBUG
è&& defšed(
WITHOUT_DEBUGFILE
)

42 
	#sÿm³r_debug
(
func
, 
fÜm©
, ...è(()0)

	)

44 
	#HAVE_SCAMPER_DEBUG


	)

45 
sÿm³r_debug
(cÚ¡ *
func
, cÚ¡ *
fÜm©
, ...);

48 #iâdeà
WITHOUT_DEBUGFILE


49 
sÿm³r_debug_İ’
(cÚ¡ *
debugfe
);

50 
sÿm³r_debug_şo£
();

	@scamper_dl.c

35 #iâdeà
lšt


36 cÚ¡ 
	grcsid
[] =

40 #ifdeà
HAVE_CONFIG_H


41 
	~"cÚfig.h
"

43 
	~"š‹º®.h
"

45 #ià
defšed
(
HAVE_BPF
è|| defšed(
__lšux__
)

46 
	#HAVE_BPF_FILTER


	)

49 
	~"sÿm³r.h
"

50 
	~"sÿm³r_debug.h
"

51 
	~"sÿm³r_addr.h
"

52 
	~"sÿm³r_fds.h
"

53 
	~"sÿm³r_dl.h
"

54 
	~"sÿm³r_´iv£p.h
"

55 
	~"sÿm³r_sk.h
"

56 
	~"sÿm³r_if.h
"

57 
	~"sÿm³r_osšfo.h
"

58 
	~"uts.h
"

60 #ià
defšed
(
HAVE_BPF
è&& defšed(
DLT_APPLE_IP_OVER_IEEE1394
)

61 
	#HAVE_FIREWIRE


	)

62 #–ià
defšed
(
__lšux__
è&& defšed(
ARPHRD_IEEE1394
)

63 
	#HAVE_FIREWIRE


	)

66 
	ssÿm³r_dl


69 
sÿm³r_fd_t
 *
	mfdn
;

72 (*
	mdÉ_cb
)(
sÿm³r_dl_»c_t
 *
	mdl
, 
ušt8_t
 *
	mpkt
, 
size_t
 
	mËn
);

75 
	mty³
;

78 
	mtx_ty³
;

81 #ià
defšed
(
HAVE_BPF
)

82 
u_št
 
	m»adbuf_Ën
;

87 
ušt8_t
 *
	g»adbuf
 = 
NULL
;

88 
size_t
 
	g»adbuf_Ën
 = 0;

90 #ià
defšed
(
HAVE_BPF
)

91 cÚ¡ 
sÿm³r_osšfo_t
 *
	gosšfo
 = 
NULL
;

100 
	$dl_·r£_
(
sÿm³r_dl_»c_t
 *
dl
, 
ušt8_t
 *
pktbuf
, 
size_t
 
pk’
)

102 

 *
4
;

103 
6_hdr
 *
6
;

104 
6_ext
 *
6_exthdr
;

105 
6_äag
 *
6_äaghdr
;

106 
icmp
 *
icmp4
;

107 
icmp6_hdr
 *
icmp6
;

108 
tıhdr
 *
tı
;

109 
udphdr
 *
udp
;

110 
size_t
 
Ën
;

111 
size_t
 
ex’
;

112 
ušt8_t
 *
pkt
 = 
pktbuf
;

113 
size_t
 
Ën
 = 
pk’
;

114 
size_t
 
off
;

115 
ušt8_t
 *
tmp
;

116 
ušt16_t
 
u16
;

117 
i
;

119 if((
pkt
[0] >> 4) == 4)

121 
4
 = (

 *)
pkt
;

123 #iâdeà
_WIN32


124 
Ën
 = (
4
->
_hl
 << 2);

126 
Ën
 = ((
4
->
_vhl
) & 0xf) << 2;

133 if(
Ën
 > 
Ën
)

137 
u16
 = 
	`Áohs
(
4
->
_off
);

138 
dl
->
dl__off
 = (
u16
 & 
IP_OFFMASK
) * 8;

139 if(
dl
->
dl__off
 !ğ0 || (
u16
 & 
IP_MF
) != 0)

140 
dl
->
dl__æags
 |ğ
SCAMPER_DL_IP_FLAG_FRAG
;

141 if((
u16
 & 
IP_DF
) != 0)

142 
dl
->
dl__æags
 |ğ
SCAMPER_DL_IP_FLAG_DF
;

143 if((
u16
 & 
IP_MF
) != 0)

144 
dl
->
dl__æags
 |ğ
SCAMPER_DL_IP_FLAG_MF
;

146 
dl
->
dl_af
 = 
AF_INET
;

147 
dl
->
dl__hl
 = 
Ën
;

148 
dl
->
dl__´Ùo
 = 
4
->
_p
;

149 
dl
->
dl__size
 = 
	`Áohs
(
4
->
_Ën
);

150 
dl
->
dl__id
 = 
	`Áohs
(
4
->
_id
);

151 
dl
->
dl__tos
 = 
4
->
_tos
;

152 
dl
->
dl__‰l
 = 
4
->
_‰l
;

153 
dl
->
dl__¤c
 = (
ušt8_t
 *)&
4
->
_¤c
;

154 
dl
->
dl__d¡
 = (
ušt8_t
 *)&
4
->
_d¡
;

156 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_NET
;

157 
dl
->
dl_Ãt_ty³
 = 
SCAMPER_DL_REC_NET_TYPE_IP
;

159 
pkt
 +ğ
Ën
;

160 
Ën
 -ğ
Ën
;

162 if((
pkt
[0] >> 4) == 6)

164 
6
 = (
6_hdr
 *)
pkt
;

166 if((
Ën
 = (
6_hdr
)è> 
Ën
)

169 
dl
->
dl_af
 = 
AF_INET6
;

170 
dl
->
dl__hl
 = 
Ën
;

171 
dl
->
dl__æow
 = 
	`Áohl
(
6
->
6_æow
) & 0xfffff;

172 
dl
->
dl__´Ùo
 = 
6
->
6_nxt
;

173 
dl
->
dl__size
 = 
	`Áohs
(
6
->
6_¶’
è+ (
6_hdr
);

174 
dl
->
dl__hlim
 = 
6
->
6_hlim
;

175 
dl
->
dl__¤c
 = (
ušt8_t
 *)&
6
->
6_¤c
;

176 
dl
->
dl__d¡
 = (
ušt8_t
 *)&
6
->
6_d¡
;

177 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_NET
;

178 
dl
->
dl_Ãt_ty³
 = 
SCAMPER_DL_REC_NET_TYPE_IP
;

180 
pkt
 +ğ
Ën
;

181 
Ën
 -ğ
Ën
;

186 
dl
->
dl__´Ùo
)

188 
IPPROTO_HOPOPTS
:

189 
IPPROTO_DSTOPTS
:

190 
IPPROTO_ROUTING
:

191 if((
6_ext
è> 
Ën
)

193 
6_exthdr
 = (
6_ext
 *)
pkt
;

194 if((
ex’
 = (
6_exthdr
->
6e_Ën
 * 8è+ 8è> 
Ën
)

196 
dl
->
dl__´Ùo
 = 
6_exthdr
->
6e_nxt
;

199 
IPPROTO_FRAGMENT
:

200 if((
ex’
 = (
6_äag
)è> 
Ën
)

202 
6_äaghdr
 = (
6_äag
 *)
pkt
;

203 
dl
->
dl_6_id
 = 
	`Áohl
(
6_äaghdr
->
6f_id’t
);

204 
dl
->
dl__off
 = 
	`Áohs
(
6_äaghdr
->
6f_ofæg
) & 0xfff8;

205 
dl
->
dl__´Ùo
 = 
6_äaghdr
->
6f_nxt
;

206 
dl
->
dl__æags
 |ğ
SCAMPER_DL_IP_FLAG_FRAG
;

207 if(
	`Áohs
(
6_äaghdr
->
6f_ofæg
) & 0x1)

208 
dl
->
dl__æags
 |ğ
SCAMPER_DL_IP_FLAG_MF
;

212 
ex’
 = 0;

216 if(
ex’
 == 0)

219 
dl
->
dl__hl
 +ğ
ex’
;

220 
pkt
 +ğ
ex’
;

221 
Ën
 -ğ
ex’
;

229 
dl
->
dl__d©a
 = 
pkt
;

230 
dl
->
dl__d©®’
 = 
Ën
;

236 if(
dl
->
dl__off
 != 0)

239 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_UDP
)

241 if(()(
udphdr
è> 
Ën
)

246 
udp
 = (
udphdr
 *)
pkt
;

247 
dl
->
dl_udp_dpÜt
 = 
	`Áohs
(
udp
->
uh_dpÜt
);

248 
dl
->
dl_udp_¥Üt
 = 
	`Áohs
(
udp
->
uh_¥Üt
);

249 
dl
->
dl_udp_sum
 = 
udp
->
uh_sum
;

250 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TRANS
;

252 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_TCP
)

254 if(()(
tıhdr
è> 
Ën
)

259 
tı
 = (
tıhdr
 *)
pkt
;

260 
dl
->
dl_tı_dpÜt
 = 
	`Áohs
(
tı
->
th_dpÜt
);

261 
dl
->
dl_tı_¥Üt
 = 
	`Áohs
(
tı
->
th_¥Üt
);

262 
dl
->
dl_tı_£q
 = 
	`Áohl
(
tı
->
th_£q
);

263 
dl
->
dl_tı_ack
 = 
	`Áohl
(
tı
->
th_ack
);

264 #iâdeà
_WIN32


265 
dl
->
dl_tı_hl
 = 
tı
->
th_off
 * 4;

267 
dl
->
dl_tı_hl
 = (
tı
->
th_offx2
 >> 4) * 4;

269 
dl
->
dl_tı_æags
 = 
tı
->
th_æags
;

270 
dl
->
dl_tı_wš
 = 
	`Áohs
(
tı
->
th_wš
);

271 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TRANS
;

273 if(
dl
->
dl_tı_hl
 >ğ20 && 
Ën
 >= dl->dl_tcp_hl)

275 
off
 = 20;

276 
off
 < 
dl
->
dl_tı_hl
)

278 
tmp
 = 
pkt
 + 
off
;

280 if(
tmp
[0] == 0)

283 if(
tmp
[0] == 1)

285 
off
++;

289 if(
tmp
[1] == 0)

293 if(
off
 + 
tmp
[1] > 
dl
->
dl_tı_hl
)

296 if(
tmp
[0] == 2 &&mp[1] == 4)

297 
dl
->
dl_tı_mss
 = 
	`by‹s_Áohs
(
tmp
+2);

299 if(
tmp
[0] == 4 &&mp[1] == 2)

300 
dl
->
dl_tı_İts
 |ğ
SCAMPER_DL_TCP_OPT_SACKP
;

302 if(
tmp
[0] == 8 &&mp[1] == 10)

304 
dl
->
dl_tı_İts
 |ğ
SCAMPER_DL_TCP_OPT_TS
;

305 
dl
->
dl_tı_tsv®
 = 
	`by‹s_Áohl
(
tmp
+2);

306 
dl
->
dl_tı_t£ü
 = 
	`by‹s_Áohl
(
tmp
+6);

309 if(
tmp
[0] == 5)

311 if(
tmp
[1]==10 ||mp[1]==18 ||mp[1]==26 ||mp[1]==34)

313 
dl
->
dl_tı_§ck_edgec
 = (
tmp
[1]-2) / 4;

314 
i
=0; i<(
tmp
[1]-2)/4; i++)

315 
dl
->
dl_tı_§ck_edges
[
i
] = 
	`by‹s_Áohl
(
tmp
+2 + (i*4));

319 
dl
->
dl_tı_§ck_edgec
 = -1;

323 
off
 +ğ
tmp
[1];

326 
dl
->
dl_tı_d©®’
 = dl->
dl__size
 - dl->
dl__hl
 - dl->
dl_tı_hl
;

327 if(
dl
->
dl_tı_d©®’
 > 0)

328 
dl
->
dl_tı_d©a
 = 
pkt
 + dl->
dl_tı_hl
;

331 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_ICMP
)

334 if(
ICMP_MINLEN
 > 
Ën
)

339 
icmp4
 = (
icmp
 *)
pkt
;

340 
dl
->
dl_icmp_ty³
 = 
icmp4
->
icmp_ty³
;

341 
dl
->
dl_icmp_code
 = 
icmp4
->
icmp_code
;

343 
dl
->
dl_icmp_ty³
)

345 
ICMP_UNREACH
:

346 
ICMP_TIMXCEED
:

347 if(
ICMP_MINLEN
 + ()(

è> 
Ën
)

352 if(
dl
->
dl_icmp_ty³
 =ğ
ICMP_UNREACH
 &&

353 
dl
->
dl_icmp_code
 =ğ
ICMP_UNREACH_NEEDFRAG
)

355 
dl
->
dl_icmp_nhmtu
 = 
	`Áohs
(
icmp4
->
icmp_Ãxtmtu
);

358 
4
 = &
icmp4
->
icmp_
;

360 
dl
->
dl_icmp__´Ùo
 = 
4
->
_p
;

361 
dl
->
dl_icmp__size
 = 
	`Áohs
(
4
->
_Ën
);

362 
dl
->
dl_icmp__id
 = 
	`Áohs
(
4
->
_id
);

363 
dl
->
dl_icmp__tos
 = 
4
->
_tos
;

364 
dl
->
dl_icmp__‰l
 = 
4
->
_‰l
;

365 
dl
->
dl_icmp__¤c
 = (
ušt8_t
 *)&
4
->
_¤c
;

366 
dl
->
dl_icmp__d¡
 = (
ušt8_t
 *)&
4
->
_d¡
;

372 #iâdeà
_WIN32


373 if((
size_t
)(
ICMP_MINLEN
 + (
4
->
_hl
 << 2è+ 8è> 
Ën
)

375 if((
size_t
)(
ICMP_MINLEN
 + ((
4
->
_vhl
 & 0xfè<< 2è+ 8è> 
Ën
)

381 
pkt
 = (
ušt8_t
 *)
4
;

383 #iâdeà
_WIN32


384 
Ën
 = (
4
->
_hl
 << 2);

386 
Ën
 = ((
4
->
_vhl
 & 0xf) << 2);

389 
pkt
 +ğ
Ën
;

391 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_UDP
)

393 
udp
 = (
udphdr
 *)
pkt
;

394 
dl
->
dl_icmp_udp_¥Üt
 = 
	`Áohs
(
udp
->
uh_¥Üt
);

395 
dl
->
dl_icmp_udp_dpÜt
 = 
	`Áohs
(
udp
->
uh_dpÜt
);

396 
dl
->
dl_icmp_udp_sum
 = 
udp
->
uh_sum
;

398 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_ICMP
)

400 
icmp4
 = (
icmp
 *)
pkt
;

401 
dl
->
dl_icmp_icmp_ty³
 = 
icmp4
->
icmp_ty³
;

402 
dl
->
dl_icmp_icmp_code
 = 
icmp4
->
icmp_code
;

403 
dl
->
dl_icmp_icmp_id
 = 
	`Áohs
(
icmp4
->
icmp_id
);

404 
dl
->
dl_icmp_icmp_£q
 = 
	`Áohs
(
icmp4
->
icmp_£q
);

406 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_TCP
)

408 
tı
 = (
tıhdr
 *)
pkt
;

409 
dl
->
dl_icmp_tı_¥Üt
 = 
	`Áohs
(
tı
->
th_¥Üt
);

410 
dl
->
dl_icmp_tı_dpÜt
 = 
	`Áohs
(
tı
->
th_dpÜt
);

411 
dl
->
dl_icmp_tı_£q
 = 
	`Áohl
(
tı
->
th_£q
);

415 
ICMP_ECHOREPLY
:

416 
ICMP_ECHO
:

417 
ICMP_TSTAMPREPLY
:

418 
ICMP_TSTAMP
:

419 
dl
->
dl_icmp_id
 = 
	`Áohs
(
icmp4
->
icmp_id
);

420 
dl
->
dl_icmp_£q
 = 
	`Áohs
(
icmp4
->
icmp_£q
);

427 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TRANS
;

429 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_ICMPV6
)

432 if(()(
icmp6_hdr
è> 
Ën
)

437 
icmp6
 = (
icmp6_hdr
 *)
pkt
;

438 
dl
->
dl_icmp_ty³
 = 
icmp6
->
icmp6_ty³
;

439 
dl
->
dl_icmp_code
 = 
icmp6
->
icmp6_code
;

440 
pkt
 +ğ(
icmp6_hdr
);

441 
Ën
 -ğ(
icmp6_hdr
);

443 
dl
->
dl_icmp_ty³
)

445 
ICMP6_TIME_EXCEEDED
:

446 
ICMP6_DST_UNREACH
:

447 
ICMP6_PACKET_TOO_BIG
:

448 if(()(
6_hdr
è+ 8 > 
Ën
)

453 if(
dl
->
dl_icmp_ty³
 =ğ
ICMP6_PACKET_TOO_BIG
)

455 #iâdeà
_WIN32


456 
dl
->
dl_icmp_nhmtu
 = (
	`Áohl
(
icmp6
->
icmp6_mtu
) % 0xffff);

458 
dl
->
dl_icmp_nhmtu
 = 
	`Áohs
(
icmp6
->
icmp6_£q
);

462 
6
 = (
6_hdr
 *)
pkt
;

463 
pkt
 +ğ(
6_hdr
);

465 
dl
->
dl_icmp__´Ùo
 = 
6
->
6_nxt
;

466 
dl
->
dl_icmp__size
 = 
	`Áohs
(
6
->
6_¶’
è+ (
6_hdr
);

467 
dl
->
dl_icmp__hlim
 = 
6
->
6_hlim
;

468 
dl
->
dl_icmp__æow
 = 
	`Áohl
(
6
->
6_æow
) & 0xfffff;

469 
dl
->
dl_icmp__¤c
 = (
ušt8_t
 *)&
6
->
6_¤c
;

470 
dl
->
dl_icmp__d¡
 = (
ušt8_t
 *)&
6
->
6_d¡
;

472 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_UDP
)

474 
udp
 = (
udphdr
 *)
pkt
;

475 
dl
->
dl_icmp_udp_¥Üt
 = 
	`Áohs
(
udp
->
uh_¥Üt
);

476 
dl
->
dl_icmp_udp_dpÜt
 = 
	`Áohs
(
udp
->
uh_dpÜt
);

477 
dl
->
dl_icmp_udp_sum
 = 
udp
->
uh_sum
;

479 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_ICMPV6
)

481 
icmp6
 = (
icmp6_hdr
 *)
pkt
;

482 
dl
->
dl_icmp_icmp_ty³
 = 
icmp6
->
icmp6_ty³
;

483 
dl
->
dl_icmp_icmp_code
 = 
icmp6
->
icmp6_code
;

484 
dl
->
dl_icmp_icmp_id
 = 
	`Áohs
(
icmp6
->
icmp6_id
);

485 
dl
->
dl_icmp_icmp_£q
 = 
	`Áohs
(
icmp6
->
icmp6_£q
);

487 if(
dl
->
dl_icmp__´Ùo
 =ğ
IPPROTO_TCP
)

489 
tı
 = (
tıhdr
 *)
pkt
;

490 
dl
->
dl_icmp_tı_¥Üt
 = 
	`Áohs
(
tı
->
th_¥Üt
);

491 
dl
->
dl_icmp_tı_dpÜt
 = 
	`Áohs
(
tı
->
th_dpÜt
);

492 
dl
->
dl_icmp_tı_£q
 = 
	`Áohl
(
tı
->
th_£q
);

496 
ICMP6_ECHO_REPLY
:

497 
ICMP6_ECHO_REQUEST
:

498 
dl
->
dl_icmp_id
 = 
	`Áohs
(
icmp6
->
icmp6_id
);

499 
dl
->
dl_icmp_£q
 = 
	`Áohs
(
icmp6
->
icmp6_£q
);

502 
ND_NEIGHBOR_ADVERT
:

503 
dl
->
dl_icmp6_nd_rg‘
 = 
pkt
;

504 
dl
->
dl_icmp6_nd_İts
 = 
pkt
 + 16;

505 
dl
->
dl_icmp6_nd_İts_Ën
 = 
Ën
 - 16;

512 
dl
->
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TRANS
;

520 
	}
}

530 
	$dÉ_¿w_cb
(
sÿm³r_dl_»c_t
 *
dl
, 
ušt8_t
 *
pkt
, 
size_t
 
Ën
)

532 
»t
;

534 if((
»t
 = 
	`dl_·r£_
(
dl
, 
pkt
, 
Ën
)) != 0)

537 
dl
->
dl_ty³
 = 
SCAMPER_DL_TYPE_RAW
;

538 
dl
->
dl_Ãt_¿w
 = 
pkt
;

539 
dl
->
dl_Ãt_¿wËn
 = 
Ën
;

542  
»t
;

543 
	}
}

552 #ifdeà
HAVE_BPF


553 
	$dÉ_nuÎ_cb
(
sÿm³r_dl_»c_t
 *
dl
, 
ušt8_t
 *
pkt
, 
size_t
 
Ën
)

555 
ušt32_t
 
pf
;

556 
»t
;

559 if(
Ën
 <= 4)

564 
	`memıy
(&
pf
, 
pkt
, 4);

565 if(
pf
 =ğ
PF_INET
 ||…à=ğ
PF_INET6
)

567 if((
»t
 = 
	`dl_·r£_
(
dl
, 
pkt
+4, 
Ën
-4)) != 0)

569 
dl
->
dl_ty³
 = 
SCAMPER_DL_TYPE_NULL
;

570 
dl
->
dl_Ãt_¿w
 = 
pkt
+4;

571 
dl
->
dl_Ãt_¿wËn
 = 
Ën
-4;

575  
»t
;

579 
	}
}

593 
	$dÉ_’10mb_cb
(
sÿm³r_dl_»c_t
 *
dl
, 
ušt8_t
 *
pkt
, 
size_t
 
Ën
)

595 
ušt16_t
 
u16
;

596 
size_t
 
off
;

599 if(
Ën
 <= 14)

602 
u16
 = 
	`by‹s_Áohs
(
pkt
+12);

603 if(
u16
 =ğ
ETHERTYPE_IP
 || u16 =ğ
ETHERTYPE_IPV6
)

605 if(
	`dl_·r£_
(
dl
, 
pkt
+14, 
Ën
-14) == 0)

608 if(
u16
 =ğ
ETHERTYPE_ARP
)

611 if(14 + 8 >ğ
Ën
)

614 
off
 = 14;

615 
dl
->
dl_¬p_hrd
 = 
	`by‹s_Áohs
(
pkt
+
off
); off += 2;

616 
dl
->
dl_¬p_´o
 = 
	`by‹s_Áohs
(
pkt
+
off
); off += 2;

617 
dl
->
dl_¬p_hÊ
 = 
pkt
[
off
++];

618 
dl
->
dl_¬p_¶n
 = 
pkt
[
off
++];

619 
dl
->
dl_¬p_İ
 = 
	`by‹s_Áohs
(
pkt
+
off
); off += 2;

622 if(14 + 8 + (
dl
->
dl_¬p_hÊ
*2è+ (dl->
dl_¬p_¶n
*2è> 
Ën
)

625 
dl
->
dl_¬p_sha
 = 
pkt
+
off
; ofà+ğdl->
dl_¬p_hÊ
;

626 
dl
->
dl_¬p_¥a
 = 
pkt
+
off
; ofà+ğdl->
dl_¬p_¶n
;

627 
dl
->
dl_¬p_tha
 = 
pkt
+
off
; ofà+ğdl->
dl_¬p_hÊ
;

628 
dl
->
dl_¬p_a
 = 
pkt
+
off
;

631 
dl
->
dl_Ãt_ty³
 = 
SCAMPER_DL_REC_NET_TYPE_ARP
;

635 
dl
->
dl_ty³
 = 
SCAMPER_DL_TYPE_ETHERNET
;

636 
dl
->
dl_Îaddr_d¡
 = 
pkt
;

637 
dl
->
dl_Îaddr_¤c
 = 
pkt
+6;

638 
dl
->
dl_Ãt_¿w
 = 
pkt
+14;

639 
dl
->
dl_Ãt_¿wËn
 = 
Ën
-14;

642 
	}
}

651 #ifdeà
HAVE_FIREWIRE


652 
	$dÉ_fœewœe_cb
(
sÿm³r_dl_»c_t
 *
dl
, 
ušt8_t
 *
pkt
, 
size_t
 
Ën
)

654 
»t
;

655 
ušt16_t
 
ty³
;

658 if(
Ën
 <= 18)

663 
	`memıy
(&
ty³
, 
pkt
+16, 2);y³ = 
	`Áohs
(type);

664 if(
ty³
 =ğ
ETHERTYPE_IP
 ||y³ =ğ
ETHERTYPE_IPV6
)

666 if((
»t
 = 
	`dl_·r£_
(
dl
, 
pkt
+18, 
Ën
-18)) != 0)

668 
dl
->
dl_ty³
 = 
SCAMPER_DL_TYPE_FIREWIRE
;

669 
dl
->
dl_Îaddr_d¡
 = 
pkt
;

670 
dl
->
dl_Îaddr_¤c
 = 
pkt
 + 8;

671 
dl
->
dl_Ãt_¿w
 = 
pkt
 + 18;

672 
dl
->
dl_Ãt_¿wËn
 = 
Ën
 - 18;

675  
»t
;

679 
	}
}

682 #ià
defšed
(
HAVE_BPF
)

683 
	$dl_bpf_İ’_dev
(*
dev
, cÚ¡ 
size_t
 
Ën
)

685 
i
=0, 
fd
;

689 
	`¢´štf
(
dev
, 
Ën
, "/dev/bpf%d", 
i
);

690 if((
fd
 = 
	`İ’
(
dev
, 
O_RDWR
)) == -1)

692 if(
”ºo
 =ğ
EBUSY
)

698 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù o³À%s", 
dev
);

704 ++
i
 < 32768);

706  
fd
;

707 
	}
}

709 
	$dl_bpf_İ’
(cÚ¡ 
ifšdex
)

711 
iäeq
 ifreq;

712 
dev
[16];

713 
u_št
 
bËn
;

714 
fd
 = -1;

717 
	`mem£t
(&
iäeq
, 0, (ifreq));

718 if(
	`if_šdextÚame
(()
ifšdex
, 
iäeq
.
iä_Çme
è=ğ
NULL
)

720 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "if_indextoname failed");

721 
”r
;

724 if((
fd
 = 
	`dl_bpf_İ’_dev
(
dev
, (dev))) == -1)

726 
”r
;

730 if(
	`ioùl
(
fd
, 
BIOCGBLEN
, &
bËn
) == -1)

732 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "BIOCGBLEN %s", 
iäeq
.
iä_Çme
);

733 
”r
;

740 if(
bËn
 < 65536)

742 
bËn
 = 65536;

743 if(
	`ioùl
(
fd
, 
BIOCSBLEN
, &
bËn
) == -1)

745 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "BIOCSBLEN %s: %d",

746 
iäeq
.
iä_Çme
, 
bËn
);

747 
”r
;

752 if(
	`ioùl
(
fd
, 
BIOCSETIF
, &
iäeq
) == -1)

754 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "%s BIOCSETIF %s failed",

755 
dev
, 
iäeq
.
iä_Çme
);

756 
”r
;

759  
fd
;

761 
”r
:

762 if(
fd
 !ğ-1è
	`şo£
(fd);

764 
	}
}

766 
	$dl_bpf_node_š™
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_dl_t
 *
node
)

768 
iâame
[
IFNAMSIZ
];

769 
u_št
 
tmp
;

770 
ifšdex
, 
fd
;

771 
ušt8_t
 *
buf
;

774 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
fdn
)) < 0)

776 
”r
;

780 if(
	`sÿm³r_fd_ifšdex
(
fdn
, &
ifšdex
) != 0)

782 
”r
;

786 if(
	`if_šdextÚame
(()
ifšdex
, 
iâame
è=ğ
NULL
)

788 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,"if_šdextÚam%d faed",
ifšdex
);

789 
”r
;

793 if(
	`ioùl
(
fd
, 
BIOCGBLEN
, &
node
->
»adbuf_Ën
) == -1)

795 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "bpàBIOCGBLEN % çed", 
iâame
);

796 
”r
;

800 if(
	`ioùl
(
fd
, 
BIOCGDLT
, &
tmp
) == -1)

802 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "bpàBIOCGDLT % çed", 
iâame
);

803 
”r
;

805 
node
->
ty³
 = 
tmp
;

807 
node
->
ty³
)

809 
DLT_NULL
:

810 
node
->
dÉ_cb
 = 
dÉ_nuÎ_cb
;

811 if(
osšfo
->
os_id
 =ğ
SCAMPER_OSINFO_OS_FREEBSD
 &&

812 
osšfo
->
os_»l
[0] >= 6)

814 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_NULL
;

818 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

822 
DLT_EN10MB
:

823 
node
->
dÉ_cb
 = 
dÉ_’10mb_cb
;

824 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_ETHERNET
;

827 
DLT_RAW
:

828 
node
->
dÉ_cb
 = 
dÉ_¿w_cb
;

829 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

832 #ià
	`defšed
(
DLT_APPLE_IP_OVER_IEEE1394
)

833 
DLT_APPLE_IP_OVER_IEEE1394
:

834 
node
->
dÉ_cb
 = 
dÉ_fœewœe_cb
;

835 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

840 
	`sÿm³r_debug
(
__func__
, "% unhªdËd d©®šk %d", 
iâame
, 
node
->
ty³
);

841 
”r
;

844 
	`sÿm³r_debug
(
__func__
, "bpf if %s index %d buflen %d datalink %d",

845 
iâame
, 
ifšdex
, 
node
->
»adbuf_Ën
,‚ode->
ty³
);

847 
tmp
 = 1;

848 if(
	`ioùl
(
fd
, 
BIOCIMMEDIATE
, &
tmp
) == -1)

850 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "bpf BIOCIMMEDIATE failed");

851 
”r
;

854 if(
»adbuf_Ën
 < 
node
->readbuf_len)

856 if((
buf
 = 
	`»®loc
(
»adbuf
, 
node
->
»adbuf_Ën
)è=ğ
NULL
)

858 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

861 
»adbuf
 = 
buf
;

862 
»adbuf_Ën
 = 
node
->readbuf_len;

867 
”r
:

869 
	}
}

871 
	$dl_bpf_š™
()

873 
bpf_v”siÚ
 
bv
;

874 
fd
;

875 
buf
[16];

876 
”r
;

878 if((
fd
 = 
	`dl_bpf_İ’_dev
(
buf
, (buf))) == -1)

880 if(
”ºo
 =ğ
ENXIO
)

887 
”r
 = 
	`ioùl
(
fd
, 
BIOCVERSION
, &
bv
);

888 
	`şo£
(
fd
);

889 if(
”r
 == -1)

891 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "BIOCVERSION failed");

895 
	`sÿm³r_debug
(
__func__
, "bpàv”siÚ %d.%d", 
bv
.
bv_majÜ
, bv.
bv_mšÜ
);

896 if(
bv
.
bv_majÜ
 !ğ
BPF_MAJOR_VERSION
 || bv.
bv_mšÜ
 < 
BPF_MINOR_VERSION
)

898 
	`årštf
(
¡d”r
,

900 
bv
.
bv_majÜ
, bv.
bv_mšÜ
, 
BPF_MAJOR_VERSION
, 
BPF_MINOR_VERSION
);

904 
osšfo
 = 
	`sÿm³r_osšfo_g‘
();

905 if(
osšfo
->
os_id
 =ğ
SCAMPER_OSINFO_OS_FREEBSD
 &&

906 
osšfo
->
os_»l
[0] == 4 &&

907 (
osšfo
->
os_»l
[1] == 3 || osinfo->os_rel[1] == 4))

909 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
,

916 
	}
}

918 
	$dl_bpf_»ad
(cÚ¡ 
fd
, 
sÿm³r_dl_t
 *
node
)

920 
bpf_hdr
 *bpf_hdr;

921 
sÿm³r_dl_»c_t
 
dl
;

922 
ssize_t
 
Ën
;

923 
ušt8_t
 *
buf
 = 
»adbuf
;

925 (
Ën
 = 
	`»ad
(
fd
, 
buf
, 
node
->
»adbuf_Ën
)) == -1)

927 if(
”ºo
 =ğ
EINTR
) ;

928 if(
”ºo
 =ğ
EWOULDBLOCK
)  0;

929 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "read %d bytes from fd %d failed",

930 
node
->
»adbuf_Ën
, 
fd
);

935 if(
	`sÿm³r_fd_ifšdex
(
node
->
fdn
, &
dl
.
dl_ifšdex
) != 0)

940 
buf
 < 
»adbuf
 + 
Ën
)

942 
bpf_hdr
 = (bpf_hd¸*)
buf
;

945 
	`mem£t
(&
dl
, 0, (dl));

947 if(
node
->
	`dÉ_cb
(&
dl
, 
buf
 + 
bpf_hdr
->
bh_hd¾’
, bpf_hdr->
bh_ÿ¶’
))

950 
dl
.
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TIMESTAMP
;

952 
dl
.
dl_tv
.
tv_£c
 = 
bpf_hdr
->
bh_t¡amp
.tv_sec;

953 
dl
.
dl_tv
.
tv_u£c
 = 
bpf_hdr
->
bh_t¡amp
.tv_usec;

955 
	`sÿm³r_sk_hªdËdl
(&
dl
);

958 
buf
 +ğ
	`BPF_WORDALIGN
(
bpf_hdr
->
bh_ÿ¶’
 + bpf_hdr->
bh_hd¾’
);

962 
	}
}

964 
	$dl_bpf_tx
(cÚ¡ 
sÿm³r_dl_t
 *
node
,

965 cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
size_t
 
Ën
)

967 
ssize_t
 
wb
;

969 if((
wb
 = 
	`wr™e
(
	`sÿm³r_fd_fd_g‘
(
node
->
fdn
), 
pkt
, 
Ën
)è< (
ssize_t
)len)

971 if(
wb
 == -1)

973 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "%d by‹ çed", 
Ën
);

977 
	`sÿm³r_debug
(
__func__
, "%d by‹ £Á oà%dÙ®", 
wb
, 
Ën
);

984 
	}
}

986 
	$dl_bpf_f‹r
(
sÿm³r_dl_t
 *
node
, 
bpf_š¢
 *
š¢s
, 
Ën
)

988 
bpf_´og¿m
 
´og
;

990 
´og
.
bf_Ën
 = 
Ën
;

991 
´og
.
bf_š¢s
 = 
š¢s
;

993 if(
	`ioùl
(
	`sÿm³r_fd_fd_g‘
(
node
->
fdn
), 
BIOCSETF
, (
ÿddr_t
)&
´og
) == -1)

995 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "BIOCSETF failed");

1000 
	}
}

1002 #–ià
defšed
(
__lšux__
)

1004 
	$dl_lšux_İ’
(cÚ¡ 
ifšdex
)

1006 
sockaddr_Î
 
¦l
;

1007 
fd
;

1010 if((
fd
 = 
	`sock‘
(
PF_PACKET
, 
SOCK_RAW
, 
	`htÚs
(
ETH_P_ALL
))) == -1)

1012 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open PF_PACKET");

1017 
	`mem£t
(&
¦l
, 0, (sll));

1018 
¦l
.
¦l_çmy
 = 
AF_PACKET
;

1019 
¦l
.
¦l_ifšdex
 = 
ifšdex
;

1020 
¦l
.
¦l_´ÙocŞ
 = 
	`htÚs
(
ETH_P_ALL
);

1021 if(
	`bšd
(
fd
, (
sockaddr
 *)&
¦l
, (sll)) == -1)

1023 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù bšdØ%d", 
ifšdex
);

1024 
	`şo£
(
fd
);

1028  
fd
;

1029 
	}
}

1031 
	$dl_lšux_node_š™
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_dl_t
 *
node
)

1033 
iäeq
 ifreq;

1034 
iâame
[
IFNAMSIZ
];

1035 
fd
, 
ifšdex
;

1037 if(
	`sÿm³r_fd_ifšdex
(
fdn
, &
ifšdex
) != 0)

1039 
”r
;

1042 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
fdn
)) < 0)

1044 
”r
;

1047 if(
	`if_šdextÚame
(
ifšdex
, 
iâame
è=ğ
NULL
)

1049 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,"if_šdextÚam%d faed",
ifšdex
);

1050 
”r
;

1054 
	`memıy
(
iäeq
.
iä_Çme
, 
iâame
, (ifreq.ifr_name));

1055 if(
	`ioùl
(
fd
, 
SIOCGIFHWADDR
, &
iäeq
) == -1)

1057 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "% SIOCGIFHWADDR faed", 
iâame
);

1058 
”r
;

1061 
node
->
ty³
 = 
iäeq
.
iä_hwaddr
.
§_çmy
;

1064 
node
->
ty³
)

1066 
ARPHRD_ETHER
:

1067 
node
->
dÉ_cb
 = 
dÉ_’10mb_cb
;

1068 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_ETHERNET
;

1071 
ARPHRD_LOOPBACK
:

1072 
node
->
dÉ_cb
 = 
dÉ_’10mb_cb
;

1073 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_ETHLOOP
;

1076 #ià
	`defšed
(
ARPHRD_SIT
)

1077 
ARPHRD_SIT
:

1078 
node
->
dÉ_cb
 = 
dÉ_¿w_cb
;

1079 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_RAW
;

1083 #ià
	`defšed
(
ARPHRD_IEEE1394
)

1084 
ARPHRD_IEEE1394
:

1085 
node
->
dÉ_cb
 = 
dÉ_fœewœe_cb
;

1086 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

1090 #ià
	`defšed
(
ARPHRD_VOID
)

1091 
ARPHRD_VOID
:

1092 
node
->
dÉ_cb
 = 
dÉ_¿w_cb
;

1093 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

1098 
	`sÿm³r_debug
(
__func__
, "% unhªdËd d©®šk %d", 
iâame
, 
node
->
ty³
);

1099 
”r
;

1104 
”r
:

1106 
	}
}

1108 
	$dl_lšux_»ad
(cÚ¡ 
fd
, 
sÿm³r_dl_t
 *
node
)

1110 
sÿm³r_dl_»c_t
 
dl
;

1111 
ssize_t
 
Ën
;

1112 
sockaddr_Î
 
äom
;

1113 
sockËn_t
 
äomËn
;

1115 
äomËn
 = (
äom
);

1116 (
Ën
 = 
	`»cväom
(
fd
, 
»adbuf
, 
»adbuf_Ën
, 
MSG_TRUNC
,

1117 (
sockaddr
 *)&
äom
, &
äomËn
)) == -1)

1119 if(
”ºo
 =ğ
EINTR
)

1121 
äomËn
 = (
äom
);

1124 if(
”ºo
 =ğ
EAGAIN
)

1129 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "read %d bytes from fd %d failed",

1130 
»adbuf_Ën
, 
fd
);

1136 if(
Ën
 > 
»adbuf_Ën
)†en =„eadbuf_len;

1139 
dl
.
dl_æags
 = 0;

1142 if(
	`sÿm³r_fd_ifšdex
(
node
->
fdn
, &
dl
.
dl_ifšdex
) != 0)

1148 if(
node
->
	`dÉ_cb
(&
dl
, 
»adbuf
, 
Ën
))

1151 if(
	`ioùl
(
fd
, 
SIOCGSTAMP
, &
dl
.
dl_tv
) == 0)

1153 
dl
.
dl_æags
 |ğ
SCAMPER_DL_REC_FLAG_TIMESTAMP
;

1157 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1158 "could‚Ù SIOCGSTAMP oÀfd %d", 
fd
);

1161 
	`sÿm³r_sk_hªdËdl
(&
dl
);

1165 
	}
}

1167 
	$dl_lšux_tx
(cÚ¡ 
sÿm³r_dl_t
 *
node
,

1168 cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
size_t
 
Ën
)

1170 
sockaddr_Î
 
¦l
;

1171 
sockaddr
 *
§
 = (sockadd¸*)&
¦l
;

1172 
ssize_t
 
wb
;

1173 
fd
, 
ifšdex
;

1175 if(
	`sÿm³r_fd_ifšdex
(
node
->
fdn
, &
ifšdex
) != 0)

1180 
	`mem£t
(&
¦l
, 0, (sll));

1181 
¦l
.
¦l_çmy
 = 
AF_PACKET
;

1182 
¦l
.
¦l_ifšdex
 = 
ifšdex
;

1184 if(
node
->
ty³
 =ğ
ARPHRD_SIT
)

1186 
¦l
.
¦l_´ÙocŞ
 = 
	`htÚs
(
ETH_P_IPV6
);

1190 
¦l
.
¦l_´ÙocŞ
 = 
	`htÚs
(
ETH_P_ALL
);

1193 
fd
 = 
	`sÿm³r_fd_fd_g‘
(
node
->
fdn
);

1195 if((
wb
 = 
	`£ndto
(
fd
, 
pkt
, 
Ën
, 0, 
§
, (
¦l
))è< (
ssize_t
)len)

1197 if(
wb
 == -1)

1199 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "%d by‹ çed", 
Ën
);

1203 
	`sÿm³r_debug
(
__func__
, "%d by‹ £Á oà%dÙ®", 
wb
, 
Ën
);

1210 
	}
}

1212 
	$dl_lšux_f‹r
(
sÿm³r_dl_t
 *
node
,

1213 
sock_f‹r
 *
š¢s
, 
Ën
)

1215 
sock_årog
 
´og
;

1216 
i
;

1218 
i
=0; i<
Ën
; i++)

1220 if(
š¢s
[
i
].
code
 =ğ(
BPF_RET
+
BPF_K
è&& in¢s[i].
k
 > 0)

1222 
š¢s
[
i
].
k
 = 65535;

1226 
´og
.
Ën
 =†en;

1227 
´og
.
f‹r
 = 
š¢s
;

1229 if(
	`£tsockİt
(
	`sÿm³r_fd_fd_g‘
(
node
->
fdn
), 
SOL_SOCKET
, 
SO_ATTACH_FILTER
,

1230 (
ÿddr_t
)&
´og
, (prog)) == -1)

1232 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "SO_ATTACH_FILTER failed");

1237 
	}
}

1239 #–ià
defšed
(
HAVE_DLPI
)

1241 
	$dl_dÍi_İ’
(cÚ¡ 
ifšdex
)

1243 
iâame
[5+
IFNAMSIZ
];

1244 
fd
;

1246 
	`¡ºıy
(
iâame
, "/dev/", (ifname));

1247 if(
	`if_šdextÚame
(
ifšdex
, 
iâame
+5è=ğ
NULL
)

1249 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,"if_šdextÚam%d faed",
ifšdex
);

1253 if((
fd
 = 
	`İ’
(
iâame
, 
O_RDWR
)) == -1)

1255 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù o³À%s", 
iâame
);

1259  
fd
;

1260 
	}
}

1262 
	$dl_dÍi_»q
(cÚ¡ 
fd
, *
»q
, 
size_t
 
Ën
)

1264 
DL_´im™ives
 *
dÍ
;

1265 
¡rbuf
 
ùl
;

1267 
ùl
.
maxËn
 = 0;

1268 
ùl
.
Ën
 =†en;

1269 
ùl
.
buf
 = (*)
»q
;

1271 if(
	`putmsg
(
fd
, &
ùl
, 
NULL
, 0) == -1)

1273 
dÍ
 = 
»q
;

1274 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1275 "could‚Ù…utmsg %d", 
dÍ
->
dl_´im™ive
);

1280 
	}
}

1282 
	$dl_dÍi_ack
(cÚ¡ 
fd
, *
ack
, 
´im™ive
)

1284 
DL_´im™ives
 *
dÍ
;

1285 
¡rbuf
 
ùl
;

1286 
æags
;

1288 
æags
 = 0;

1289 
ùl
.
maxËn
 = 
MAXDLBUF
;

1290 
ùl
.
Ën
 = 0;

1291 
ùl
.
buf
 = (*)
ack
;

1292 if(
	`g‘msg
(
fd
, &
ùl
, 
NULL
, &
æags
) == -1)

1294 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù g‘msg %d", 
´im™ive
);

1298 
dÍ
 = 
ack
;

1299 if(
dÍ
->
dl_´im™ive
 !ğ
´im™ive
)

1301 
	`sÿm³r_debug
(
__func__
,

1302 "ex³ùed %d, gÙ %d", 
´im™ive
, 
dÍ
->
dl_´im™ive
);

1307 
	}
}

1309 
	$dl_dÍi_´omisc
(cÚ¡ 
fd
, cÚ¡ 
Ëv–
)

1311 
dl_´omiscÚ_»q_t
 
´omiscÚ_»q
;

1312 
ušt32_t
 
buf
[
MAXDLBUF
];

1314 
´omiscÚ_»q
.
dl_´im™ive
 = 
DL_PROMISCON_REQ
;

1315 
´omiscÚ_»q
.
dl_Ëv–
 = 
Ëv–
;

1316 if(
	`dl_dÍi_»q
(
fd
, &
´omiscÚ_»q
, (promiscon_req)) == -1)

1322 if(
	`dl_dÍi_ack
(
fd
, 
buf
, 
DL_OK_ACK
) == -1)

1328 
	}
}

1330 
	$¡rioùl
(
fd
, 
cmd
, *
dp
, 
Ën
)

1332 
¡rioùl
 
¡r
;

1334 
¡r
.
ic_cmd
 = 
cmd
;

1335 
¡r
.
ic_timout
 = -1;

1336 
¡r
.
ic_Ën
 = 
Ën
;

1337 
¡r
.
ic_dp
 = (*)
dp
;

1338 if(
	`ioùl
(
fd
, 
I_STR
, &
¡r
) == -1)

1343  
¡r
.
ic_Ën
;

1344 
	}
}

1346 
	$dl_dÍi_node_š™
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_dl_t
 *
node
)

1348 
ušt32_t
 
buf
[
MAXDLBUF
];

1349 
timev®
 
tv
;

1350 
dl_šfo_»q_t
 
šfo_»q
;

1351 
dl_šfo_ack_t
 *
šfo_ack
;

1352 
dl_©ch_»q_t
 
©ch_»q
;

1353 
dl_bšd_»q_t
 
bšd_»q
;

1354 
i
, 
fd
;

1356 #iâdeà
NDEBUG


1357 
iâame
[
IFNAMSIZ
];

1358 
ifšdex
;

1361 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
fdn
)) < 0)

1370 
šfo_»q
.
dl_´im™ive
 = 
DL_INFO_REQ
;

1371 if(
	`dl_dÍi_»q
(
fd
, &
šfo_»q
, (info_req)) == -1)

1380 if(
	`dl_dÍi_ack
(
fd
, 
buf
, 
DL_INFO_ACK
) == -1)

1384 
šfo_ack
 = (
dl_šfo_ack_t
 *)
buf
;

1387 
node
->
ty³
 = 
šfo_ack
->
dl_mac_ty³
;

1390 
node
->
ty³
)

1392 
DL_CSMACD
:

1393 
DL_ETHER
:

1394 
node
->
dÉ_cb
 = 
dÉ_’10mb_cb
;

1395 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_ETHERNET
;

1399 
node
->
tx_ty³
 = 
SCAMPER_DL_TX_UNSUPPORTED
;

1400 
	`sÿm³r_debug
(
__func__
, "unhªdËd d©®šk %d", 
node
->
ty³
);

1405 if(
šfo_ack
->
dl_´ovid”_¡yË
 =ğ
DL_STYLE2
)

1407 
©ch_»q
.
dl_´im™ive
 = 
DL_ATTACH_REQ
;

1408 
©ch_»q
.
dl_µa
 = 0;

1409 if(
	`dl_dÍi_»q
(
fd
, &
©ch_»q
, (attach_req)) == -1)

1415 if(
	`dl_dÍi_ack
(
fd
, 
buf
, 
DL_OK_ACK
) == -1)

1422 
	`mem£t
(&
bšd_»q
, 0, (bind_req));

1423 
bšd_»q
.
dl_´im™ive
 = 
DL_BIND_REQ
;

1424 
bšd_»q
.
dl_£rviû_mode
 = 
DL_CLDLS
;

1425 if(
	`dl_dÍi_»q
(
fd
, &
bšd_»q
, (bind_req)) == -1)

1431 if(
	`dl_dÍi_ack
(
fd
, 
buf
, 
DL_BIND_ACK
) == -1)

1440 if(
	`dl_dÍi_´omisc
(
fd
, 
DL_PROMISC_PHYS
) == -1 ||

1441 
	`dl_dÍi_´omisc
(
fd
, 
DL_PROMISC_SAP
) == -1)

1447 if(
	`¡rioùl
(
fd
, 
DLIOCRAW
, 
NULL
, 0) == -1)

1449 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot DLIOCRAW");

1454 if(
	`ioùl
(
fd
, 
I_PUSH
, "bufmod") == -1)

1456 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…ush bufmod");

1461 
i
 = 1500;

1462 if(
	`¡rioùl
(
fd
, 
SBIOCSSNAP
, &
i
, (i)) == -1)

1464 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù SBIOCSSNAP %d", 
i
);

1469 
tv
.
tv_£c
 = 0;

1470 
tv
.
tv_u£c
 = 50000;

1471 if(
	`¡rioùl
(
fd
, 
SBIOCSTIME
, &
tv
, (tv)) == -1)

1473 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1474 "could‚Ù SBIOCSTIME %d.%06d", 
tv
.
tv_£c
,v.
tv_u£c
);

1479 
i
 = 65535;

1480 if(
	`¡rioùl
(
fd
, 
SBIOCSCHUNK
, &
i
, (i)) == -1)

1482 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù SBIOCSCHUNK %d", 
i
);

1486 if(
	`ioùl
(
fd
, 
I_FLUSH
, 
FLUSHR
) == -1)

1488 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot flushr");

1492 #iâdeà
NDEBUG


1493 if(
	`sÿm³r_fd_ifšdex
(
fdn
, &
ifšdex
) != 0 ||

1494 
	`if_šdextÚame
(
ifšdex
, 
iâame
è=ğ
NULL
)

1496 
	`¡ºıy
(
iâame
, "<null>", (ifname)-1);

1497 
iâame
[(ifname)-1] = '\0';

1499 
	`sÿm³r_debug
(
__func__
, "dlpi if %s index %d datalink %d",

1500 
iâame
, 
ifšdex
, 
node
->
ty³
);

1504 
	}
}

1506 
	$dl_dÍi_»ad
(cÚ¡ 
fd
, 
sÿm³r_dl_t
 *
node
)

1508 
sÿm³r_dl_»c_t
 
dl
;

1509 
¡rbuf
 
d©a
;

1510 
sb_hdr
 *
sbh
;

1511 
ušt8_t
 *
buf
 = 
»adbuf
;

1512 
æags
;

1514 
æags
 = 0;

1515 
d©a
.
buf
 = (*)
»adbuf
;

1516 
d©a
.
maxËn
 = 
»adbuf_Ën
;

1517 
d©a
.
Ën
 = 0;

1519 if(
	`g‘msg
(
fd
, 
NULL
, &
d©a
, &
æags
) == -1)

1521 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot getmsg");

1525 
buf
 < 
»adbuf
 + 
d©a
.
Ën
)

1527 
sbh
 = (
sb_hdr
 *)
buf
;

1529 
dl
.
dl_æags
 = 
SCAMPER_DL_REC_FLAG_TIMESTAMP
;

1531 if(
node
->
	`dÉ_cb
(&
dl
, 
buf
 + (
sb_hdr
), 
sbh
->
sbh_msgËn
))

1533 
dl
.
dl_tv
.
tv_£c
 = 
sbh
->
sbh_time¡amp
.tv_sec;

1534 
dl
.
dl_tv
.
tv_u£c
 = 
sbh
->
sbh_time¡amp
.tv_usec;

1535 
	`sÿm³r_sk_hªdËdl
(&
dl
);

1538 
buf
 +ğ
sbh
->
sbh_tÙËn
;

1542 
	}
}

1544 
	$dl_dÍi_tx
(cÚ¡ 
sÿm³r_dl_t
 *
node
,

1545 cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
size_t
 
Ën
)

1547 
¡rbuf
 
d©a
;

1548 
fd
;

1550 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
node
->
fdn
)) < 0)

1553 
	`mem£t
(&
d©a
, 0, (data));

1554 
d©a
.
buf
 = (*)
pkt
;

1555 
d©a
.
Ën
 =†en;

1557 if(
	`putmsg
(
fd
, 
NULL
, &
d©a
, 0) != 0)

1559 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…utmsg");

1564 
	}
}

1568 #ià
defšed
(
HAVE_BPF_FILTER
)

1570 #ià
defšed
(
HAVE_BPF
)

1571 
	$bpf_¡mt
(
bpf_š¢
 *
š¢
, 
ušt16_t
 
code
, 
ušt32_t
 
k
)

1573 
	$bpf_¡mt
(
sock_f‹r
 *
š¢
, 
ušt16_t
 
code
, 
ušt32_t
 
k
)

1576 
š¢
->
code
 = code;

1577 
š¢
->
jt
 = 0;

1578 
š¢
->
jf
 = 0;

1579 
š¢
->
k
 = k;

1581 
	}
}

1583 
	$dl_f‹r
(
sÿm³r_dl_t
 *
node
)

1585 #ià
	`defšed
(
HAVE_BPF
)

1586 
bpf_š¢
 
š¢s
[1];

1588 
sock_f‹r
 
š¢s
[1];

1591 
	`bpf_¡mt
(&
š¢s
[0], 
BPF_RET
+
BPF_K
, 65535);

1593 #ià
	`defšed
(
HAVE_BPF
)

1594 if(
	`dl_bpf_f‹r
(
node
, 
š¢s
, 1) == -1)

1595 #–ià
	`defšed
(
__lšux__
)

1596 if(
	`dl_lšux_f‹r
(
node
, 
š¢s
, 1) == -1)

1603 
	}
}

1606 
	$sÿm³r_dl_»c_¤c
(
sÿm³r_dl_»c_t
 *
dl
, 
sÿm³r_addr_t
 *
addr
)

1608 if(
dl
->
dl_af
 =ğ
AF_INET
)

1609 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

1610 if(
dl
->
dl_af
 =ğ
AF_INET6
)

1611 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

1615 
addr
->add¸ğ
dl
->
dl__¤c
;

1617 
	}
}

1619 
	$sÿm³r_dl_»c_icmp__d¡
(
sÿm³r_dl_»c_t
 *
dl
, 
sÿm³r_addr_t
 *
addr
)

1621 if(
dl
->
dl_af
 =ğ
AF_INET
)

1622 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

1623 if(
dl
->
dl_af
 =ğ
AF_INET6
)

1624 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

1628 
addr
->add¸ğ
dl
->
dl_icmp__d¡
;

1630 
	}
}

1632 #ià!
defšed
(
NDEBUG
è&& !defšed(
WITHOUT_DEBUGFILE
)

1633 
	$sÿm³r_dl_»c_äag_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
)

1635 
addr
[64];

1636 
ušt32_t
 
id
;

1638 
	`as£¹
(
dl
->
dl_af
 =ğ
AF_INET
 || dl->dl_aà=ğ
AF_INET6
);

1640 if(
dl
->
dl_af
 =ğ
AF_INET
)

1641 
id
 = 
dl
->
dl__id
;

1643 
id
 = 
dl
->
dl_6_id
;

1645 
	`sÿm³r_debug
(
NULL
, "from %s†en %d ipid %u off %u",

1646 
	`addr_to¡r
(
dl
->
dl_af
, dl->
dl__¤c
, 
addr
, (addr)),

1647 
dl
->
dl__size
, 
id
, dl->
dl__off
);

1650 
	}
}

1652 
	$sÿm³r_dl_»c_tı_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
)

1654 cÚ¡ *
tıæags
[] = {

1664 
ušt8_t
 
u8
;

1665 
size_t
 
off
;

1666 
addr
[64];

1667 
fbuf
[32], *
æags
;

1668 
pos
[32];

1669 
id
[16];

1670 
i
;

1672 
	`as£¹
(
dl
->
dl_af
 =ğ
AF_INET
 || dl->dl_aà=ğ
AF_INET6
);

1673 
	`as£¹
(
dl
->
dl__´Ùo
 =ğ
IPPROTO_TCP
);

1675 if((
u8
 = 
dl
->
dl_tı_æags
) != 0)

1677 
æags
 = 
fbuf
;

1678 
i
=0; i<8; i++)

1680 if((
dl
->
dl_tı_æags
 & (1<<
i
)) != 0)

1682 
	`memıy
(
æags
, 
tıæags
[
i
], 3); flags += 3;

1683 
u8
 &ğ~(1<<
i
);

1684 if(
u8
 != 0)

1686 *
æags
 = '-';

1687 
æags
++;

1692 *
æags
 = '\0';

1693 
æags
 = 
fbuf
;

1697 
æags
 = "nil";

1700 
off
 = 0;

1701 
	`¡ršg_cÚÿt
(
pos
, Õos), &
off
, "%u", 
dl
->
dl_tı_£q
);

1702 if(
dl
->
dl_tı_æags
 & 
TH_ACK
)

1703 
	`¡ršg_cÚÿt
(
pos
, Õos), &
off
, ":%u", 
dl
->
dl_tı_ack
);

1705 if(
dl
->
dl_af
 =ğ
AF_INET
)

1706 
	`¢´štf
(
id
, (id), "id 0x%04x ", 
dl
->
dl__id
);

1708 
id
[0] = '\0';

1710 
	`sÿm³r_debug
(
NULL
, "from %s %stcp %d:%d %s %s†en %d",

1711 
	`addr_to¡r
(
dl
->
dl_af
, dl->
dl__¤c
, 
addr
, (addr)),

1712 
id
, 
dl
->
dl_tı_¥Üt
, dl->
dl_tı_dpÜt
, 
æags
, 
pos
,

1713 
dl
->
dl__size
);

1716 
	}
}

1718 
	$sÿm³r_dl_»c_icmp_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
)

1720 *
t
 = 
NULL
, 
tbuf
[64];

1721 *
c
 = 
NULL
, 
cbuf
[64];

1722 
addr
[64];

1723 

[256];

1724 
icmp
[256];

1725 
šÃr_
[256];

1726 
šÃr_Œª¥Üt
[256];

1727 
size_t
 
off
;

1729 
	`as£¹
(
dl
->
dl_af
 =ğ
AF_INET
 || dl->dl_aà=ğ
AF_INET6
);

1731 if(
dl
->
dl_af
 =ğ
AF_INET
)

1733 
	`addr_to¡r
(
AF_INET
, 
dl
->
dl__¤c
, 
addr
, (addr));

1734 
	`¢´štf
(

, (ip), "from %s size %dtl %dos 0x%02x ipid 0x%04x",

1735 
addr
, 
dl
->
dl__size
, dl->
dl__‰l
, dl->
dl__tos
,

1736 
dl
->
dl__id
);

1738 
dl
->
dl_icmp_ty³
)

1740 
ICMP_UNREACH
:

1741 
t
 = "unreach";

1742 
dl
->
dl_icmp_code
)

1744 
ICMP_UNREACH_NET
: 
c
 = "net"; ;

1745 
ICMP_UNREACH_HOST
: 
c
 = "host"; ;

1746 
ICMP_UNREACH_PROTOCOL
: 
c
 = "protocol"; ;

1747 
ICMP_UNREACH_PORT
: 
c
 = "port"; ;

1748 
ICMP_UNREACH_SRCFAIL
: 
c
 = "src-rt failed"; ;

1749 
ICMP_UNREACH_NET_UNKNOWN
: 
c
 = "net unknown"; ;

1750 
ICMP_UNREACH_HOST_UNKNOWN
: 
c
 = "host unknown"; ;

1751 
ICMP_UNREACH_ISOLATED
: 
c
 = "isolated"; ;

1752 
ICMP_UNREACH_NET_PROHIB
: 
c
 = "net…rohib"; ;

1753 
ICMP_UNREACH_HOST_PROHIB
: 
c
 = "host…rohib"; ;

1754 
ICMP_UNREACH_TOSNET
: 
c
 = "tos‚et"; ;

1755 
ICMP_UNREACH_TOSHOST
: 
c
 = "tos host"; ;

1756 
ICMP_UNREACH_FILTER_PROHIB
: 
c
 = "admin…rohib"; ;

1757 
ICMP_UNREACH_NEEDFRAG
:

1762 
	`¢´štf
(
tbuf
, Ñbuf), "Ãed f¿g %d", 
dl
->
dl_icmp_nhmtu
);

1763 
t
 = 
tbuf
;

1767 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
dl
->
dl_icmp_code
);

1768 
c
 = 
cbuf
;

1773 
ICMP_TIMXCEED
:

1774 
t
 = "timeƒxceeded";

1775 
dl
->
dl_icmp_code
)

1777 
ICMP_TIMXCEED_INTRANS
: 
c
 = "inrans"; ;

1778 
ICMP_TIMXCEED_REASS
: 
c
 = "in„eass"; ;

1780 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
dl
->
dl_icmp_code
);

1781 
c
 = 
cbuf
;

1786 
ICMP_ECHOREPLY
:

1787 
t
 = "echo„eply";

1788 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

1789 
dl
->
dl_icmp_id
, dl->
dl_icmp_£q
);

1790 
c
 = 
cbuf
;

1793 
ICMP_TSTAMPREPLY
:

1794 
t
 = "time„eply";

1795 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

1796 
dl
->
dl_icmp_id
, dl->
dl_icmp_£q
);

1797 
c
 = 
cbuf
;

1803 
	`addr_to¡r
(
AF_INET6
, 
dl
->
dl__¤c
, 
addr
, (addr));

1804 
off
 = 0;

1805 
	`¡ršg_cÚÿt
(

, (), &
off
, "äom % siz%d hlim %d", 
addr
,

1806 
dl
->
dl__size
, dl->
dl__hlim
);

1807 if(
dl
->
dl__æags
 & 
SCAMPER_DL_IP_FLAG_FRAG
)

1808 
	`¡ršg_cÚÿt
(

, (), &
off
, " ipid 0x%08x", 
dl
->
dl_6_id
);

1810 
dl
->
dl_icmp_ty³
)

1812 
ICMP6_DST_UNREACH
:

1813 
t
 = "unreach";

1814 
dl
->
dl_icmp_code
)

1816 
ICMP6_DST_UNREACH_NOROUTE
: 
c
 = "no„oute"; ;

1817 
ICMP6_DST_UNREACH_ADMIN
: 
c
 = "admin…rohib"; ;

1818 
ICMP6_DST_UNREACH_BEYONDSCOPE
: 
c
 = "beyond scope"; ;

1819 
ICMP6_DST_UNREACH_ADDR
: 
c
 = "addr"; ;

1820 
ICMP6_DST_UNREACH_NOPORT
: 
c
 = "port"; ;

1823 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
dl
->
dl_icmp_code
);

1824 
c
 = 
cbuf
;

1829 
ICMP6_TIME_EXCEEDED
:

1830 
t
 = "timeƒxceeded";

1831 
dl
->
dl_icmp_code
)

1833 
ICMP6_TIME_EXCEED_TRANSIT
: 
c
 = "inrans"; ;

1834 
ICMP6_TIME_EXCEED_REASSEMBLY
: 
c
 = "in„eass"; ;

1837 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
dl
->
dl_icmp_code
);

1838 
c
 = 
cbuf
;

1843 
ICMP6_PACKET_TOO_BIG
:

1844 
	`¢´štf
(
tbuf
, Ñbuf), "Ãed f¿g %d", 
dl
->
dl_icmp_nhmtu
);

1845 
t
 = 
tbuf
;

1848 
ICMP6_ECHO_REPLY
:

1849 
t
 = "echo„eply";

1850 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

1851 
dl
->
dl_icmp_id
, dl->
dl_icmp_£q
);

1852 
c
 = 
cbuf
;

1857 if(
t
 =ğ
NULL
)

1859 
	`¢´štf
(
icmp
, (icmp), "icmp %d code %d",

1860 
dl
->
dl_icmp_ty³
, dl->
dl_icmp_code
);

1862 if(
c
 =ğ
NULL
)

1864 
	`¢´štf
(
icmp
, (icmp), "icm°%s", 
t
);

1868 
	`¢´štf
(
icmp
, (icmp), "icm°% %s", 
t
, 
c
);

1871 if(
dl
->
dl_icmp__d¡
 !ğ
NULL
)

1873 if(
dl
->
dl_af
 =ğ
AF_INET
)

1875 
	`addr_to¡r
(
AF_INET
, 
dl
->
dl_icmp__d¡
, 
addr
, (addr));

1876 
	`¢´štf
(
šÃr_
, (inner_ip),

1878 
addr
, 
dl
->
dl_icmp__size
, dl->
dl_icmp__‰l
,

1879 
dl
->
dl_icmp__tos
, dl->
dl_icmp__id
);

1883 
	`addr_to¡r
(
AF_INET6
, 
dl
->
dl_icmp__d¡
, 
addr
, (addr));

1884 
	`¢´štf
(
šÃr_
, (inner_ip),

1885 "Ø% siz%d hlim %d flow 0x%05x", 
addr
,

1886 
dl
->
dl_icmp__size
, dl->
dl_icmp__hlim
,

1887 
dl
->
dl_icmp__æow
);

1890 
dl
->
dl_icmp__´Ùo
)

1892 
IPPROTO_UDP
:

1893 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

1895 
dl
->
dl_icmp_udp_¥Üt
, dl->
dl_icmp_udp_dpÜt
,

1896 
	`Áohs
(
dl
->
dl_icmp_udp_sum
));

1899 
IPPROTO_ICMP
:

1900 
IPPROTO_ICMPV6
:

1901 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

1903 
dl
->
dl_icmp_icmp_ty³
, dl->
dl_icmp_icmp_code
,

1904 
dl
->
dl_icmp_icmp_id
, dl->
dl_icmp_icmp_£q
);

1907 
IPPROTO_TCP
:

1908 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

1910 
dl
->
dl_icmp_tı_¥Üt
, dl->
dl_icmp_tı_dpÜt
,

1911 
dl
->
dl_icmp_tı_£q
);

1915 
šÃr_Œª¥Üt
[0] = '\0';

1921 
šÃr_
[0] = '\0';

1922 
šÃr_Œª¥Üt
[0] = '\0';

1925 
	`sÿm³r_debug
(
NULL
, "% %s%s%s", 

, 
icmp
, 
šÃr_
, 
šÃr_Œª¥Üt
);

1927 
	}
}

1936 
	$sÿm³r_dl_»ad_cb
(cÚ¡ 
fd
, *
·¿m
)

1938 
	`as£¹
(
·¿m
 !ğ
NULL
);

1940 #ià
	`defšed
(
HAVE_BPF
)

1941 
	`dl_bpf_»ad
(
fd
, (
sÿm³r_dl_t
 *)
·¿m
);

1942 #–ià
	`defšed
(
__lšux__
)

1943 
	`dl_lšux_»ad
(
fd
, (
sÿm³r_dl_t
 *)
·¿m
);

1944 #–ià
	`defšed
(
HAVE_DLPI
)

1945 
	`dl_dÍi_»ad
(
fd
, (
sÿm³r_dl_t
 *)
·¿m
);

1949 
	}
}

1951 
	$sÿm³r_dl_¡©e_ä“
(
sÿm³r_dl_t
 *
dl
)

1953 
	`as£¹
(
dl
 !ğ
NULL
);

1954 
	`ä“
(
dl
);

1956 
	}
}

1965 
sÿm³r_dl_t
 *
	$sÿm³r_dl_¡©e_®loc
(
sÿm³r_fd_t
 *
fdn
)

1967 
sÿm³r_dl_t
 *
dl
 = 
NULL
;

1969 if((
dl
 = 
	`m®loc_z”o
((
sÿm³r_dl_t
))è=ğ
NULL
)

1971 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "malloc‚ode failed");

1972 
”r
;

1974 
dl
->
fdn
 = fdn;

1976 #ià
	`defšed
(
HAVE_BPF
)

1977 if(
	`dl_bpf_node_š™
(
fdn
, 
dl
) == -1)

1978 #–ià
	`defšed
(
__lšux__
)

1979 if(
	`dl_lšux_node_š™
(
fdn
, 
dl
) == -1)

1980 #–ià
	`defšed
(
HAVE_DLPI
)

1981 if(
	`dl_dÍi_node_š™
(
fdn
, 
dl
) == -1)

1984 
”r
;

1987 #ià
	`defšed
(
HAVE_BPF_FILTER
)

1988 
	`dl_f‹r
(
dl
);

1991  
dl
;

1993 
”r
:

1994 
	`sÿm³r_dl_¡©e_ä“
(
dl
);

1995  
NULL
;

1996 
	}
}

1998 
	$sÿm³r_dl_tx
(cÚ¡ 
sÿm³r_dl_t
 *
node
,

1999 cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
size_t
 
Ën
)

2001 #ià
	`defšed
(
HAVE_BPF
)

2002 if(
	`dl_bpf_tx
(
node
, 
pkt
, 
Ën
) == -1)

2003 #–ià
	`defšed
(
__lšux__
)

2004 if(
	`dl_lšux_tx
(
node
, 
pkt
, 
Ën
) == -1)

2005 #–ià
	`defšed
(
HAVE_DLPI
)

2006 if(
	`dl_dÍi_tx
(
node
, 
pkt
, 
Ën
) == -1)

2013 
	}
}

2015 
	$sÿm³r_dl_tx_ty³
(
sÿm³r_dl_t
 *
dl
)

2017  
dl
->
tx_ty³
;

2018 
	}
}

2020 
	$sÿm³r_dl_şo£
(
fd
)

2022 #iâdeà
_WIN32


2023 
	`şo£
(
fd
);

2026 
	}
}

2034 
	$sÿm³r_dl_İ’_fd
(cÚ¡ 
ifšdex
)

2036 #ià
	`defšed
(
HAVE_BPF
)

2037  
	`dl_bpf_İ’
(
ifšdex
);

2038 #–ià
	`defšed
(
__lšux__
)

2039  
	`dl_lšux_İ’
(
ifšdex
);

2040 #–ià
	`defšed
(
HAVE_DLPI
)

2041  
	`dl_dÍi_İ’
(
ifšdex
);

2042 #–ià
	`defšed
(
_WIN32
)

2045 
	}
}

2053 
	$sÿm³r_dl_İ’
(cÚ¡ 
ifšdex
)

2055 
fd
;

2057 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

2058 if((
fd
 = 
	`sÿm³r_dl_İ’_fd
(
ifšdex
)) == -1)

2060 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_d©®šk
(
ifšdex
)) == -1)

2063 
	`sÿm³r_debug
(
__func__
, "could‚Ù o³Àifšdex %d", 
ifšdex
);

2067  
fd
;

2068 
	}
}

2070 
	$sÿm³r_dl_ş—nup
()

2072 if(
»adbuf
 !ğ
NULL
)

2074 
	`ä“
(
»adbuf
);

2075 
»adbuf
 = 
NULL
;

2079 
	}
}

2081 
	$sÿm³r_dl_š™
()

2083 #ià
	`defšed
(
HAVE_BPF
)

2084 if(
	`dl_bpf_š™
() == -1)

2088 #–ià
	`defšed
(
__lšux__
)

2089 
»adbuf_Ën
 = 256;

2090 if((
»adbuf
 = 
	`m®loc
(
»adbuf_Ën
)è=ğ
NULL
)

2092 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc„eadbuf");

2093 
»adbuf_Ën
 = 0;

2096 #–ià
	`defšed
(
HAVE_DLPI
)

2097 
»adbuf_Ën
 = 65536;

2098 if((
»adbuf
 = 
	`m®loc
(
»adbuf_Ën
)è=ğ
NULL
)

2100 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc„eadbuf");

2101 
»adbuf_Ën
 = 0;

2107 
	}
}

	@scamper_dl.h

27 #iâdeà
__SCAMPER_DL_H


28 
	#__SCAMPER_DL_H


	)

43 
	#SCAMPER_DL_REC_FLAG_TIMESTAMP
 0x01

	)

44 
	#SCAMPER_DL_REC_FLAG_NET
 0x02

	)

45 
	#SCAMPER_DL_REC_FLAG_TRANS
 0x04

	)

47 
	#SCAMPER_DL_REC_NET_TYPE_IP
 0x01

	)

48 
	#SCAMPER_DL_REC_NET_TYPE_ARP
 0x02

	)

58 
	#SCAMPER_DL_TYPE_RAW
 0x01

	)

59 
	#SCAMPER_DL_TYPE_NULL
 0x02

	)

60 
	#SCAMPER_DL_TYPE_ETHERNET
 0x03

	)

61 
	#SCAMPER_DL_TYPE_FIREWIRE
 0x04

	)

63 
	#SCAMPER_DL_IP_FLAG_DF
 0x01

	)

64 
	#SCAMPER_DL_IP_FLAG_MF
 0x02

	)

65 
	#SCAMPER_DL_IP_FLAG_FRAG
 0x04

	)

66 
	#SCAMPER_DL_IP_FLAG_REASS
 0x08

	)

68 
	#SCAMPER_DL_TCP_OPT_SACKP
 0x01

	)

69 
	#SCAMPER_DL_TCP_OPT_TS
 0x02

	)

71 
	#SCAMPER_DL_IS_IP
(
dl
) ( \

72 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
)

	)

74 
	#SCAMPER_DL_IS_IPV4
(
dl
) ( \

75 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

76 (
dl
)->
dl_af
 =ğ
AF_INET
)

	)

78 
	#SCAMPER_DL_IS_IPV6
(
dl
) ( \

79 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

80 (
dl
)->
dl_af
 =ğ
AF_INET6
)

	)

82 
	#SCAMPER_DL_IS_ICMP
(
dl
) ( \

83 ((
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
) && \

84 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1) || \

85 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 =ğ58)))

	)

87 
	#SCAMPER_DL_IS_UDP
(
dl
) ( \

88 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

89 (
dl
)->
dl__´Ùo
 =ğ17)

	)

91 
	#SCAMPER_DL_IS_TCP
(
dl
) ( \

92 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

93 (
dl
)->
dl__´Ùo
 =ğ6)

	)

95 
	#SCAMPER_DL_IS_TCP_SYNACK
(
dl
) ( \

96 
	`SCAMPER_DL_IS_TCP
(
dl
) && \

97 ((
dl
)->
dl_tı_æags
 & (
TH_SYN
|
TH_ACK
)è=ğ(TH_SYN|TH_ACK))

	)

99 
	#SCAMPER_DL_IS_ICMPV4
(
dl
) ( \

100 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

101 (
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 =ğ1)

	)

103 
	#SCAMPER_DL_IS_ICMPV6
(
dl
) ( \

104 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

105 (
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 =ğ58)

	)

107 
	#SCAMPER_DL_IS_ICMP_Q_ICMP
(
dl
) ( \

108 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

109 ((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

110 (
dl
)->
dl_icmp__´Ùo
 == 1) || \

111 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

112 (
dl
)->
dl_icmp__´Ùo
 =ğ58)))

	)

114 
	#SCAMPER_DL_IS_ICMP_Q_UDP
(
dl
) ( \

115 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

116 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1) || \

117 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58)) && \

118 (
dl
)->
dl_icmp__´Ùo
 =ğ17))

	)

120 
	#SCAMPER_DL_IS_ICMP_Q_TCP
(
dl
) ( \

121 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

122 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1) || \

123 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58)) && \

124 (
dl
)->
dl_icmp__´Ùo
 =ğ6))

	)

126 
	#SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO_REQ
(
dl
) ( \

127 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

128 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

129 (
dl
)->
dl_icmp__´Ùo
 =ğ1 && (dl)->
dl_icmp_icmp_ty³
 == 8) || \

130 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

131 (
dl
)->
dl_icmp__´Ùo
 =ğ58 && (dl)->
dl_icmp_icmp_ty³
 =ğ128)))

	)

133 
	#SCAMPER_DL_IS_ICMP_Q_ICMP_TIME_REQ
(
dl
) ( \

134 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

135 (
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

136 (
dl
)->
dl_icmp__´Ùo
 =ğ1 && (dl)->
dl_icmp_icmp_ty³
 =ğ13)

	)

138 
	#SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO
(
dl
) ( \

139 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

140 (((
dl
)->
dl_af
 =ğ
AF_INET
 && \

141 (
dl
)->
dl__´Ùo
 =ğ1 && (dl)->
dl_icmp__´Ùo
 == 1 && \

142 ((
dl
)->
dl_icmp_icmp_ty³
 == 8 || (dl)->dl_icmp_icmp_type == 0)) || \

143 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && \

144 (
dl
)->
dl__´Ùo
 =ğ58 && (dl)->
dl_icmp__´Ùo
 == 58 && \

145 ((
dl
)->
dl_icmp_icmp_ty³
 =ğ128 || (dl)->dl_icmp_icmp_ty³ =ğ129))))

	)

147 
	#SCAMPER_DL_IS_ICMP_ECHO_REQUEST
(
dl
) ( \

148 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

149 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

150 (
dl
)->
dl_icmp_ty³
 == 8) || \

151 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

152 (
dl
)->
dl_icmp_ty³
 =ğ128)))

	)

154 
	#SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
) ( \

155 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

156 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

157 (
dl
)->
dl_icmp_ty³
 == 0) || \

158 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

159 (
dl
)->
dl_icmp_ty³
 =ğ129)))

	)

161 
	#SCAMPER_DL_IS_ICMP_ECHO
(
dl
) ( \

162 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

163 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

164 ((
dl
)->
dl_icmp_ty³
 == 0 || (dl)->dl_icmp_type == 8)) || \

165 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

166 ((
dl
)->
dl_icmp_ty³
 =ğ128 || (dl)->dl_icmp_ty³ =ğ129))))

	)

168 
	#SCAMPER_DL_IS_ICMP_TIME_REPLY
(
dl
) ( \

169 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

170 (
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

171 (
dl
)->
dl_icmp_icmp_ty³
 =ğ14)

	)

173 
	#SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
) ( \

174 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

175 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

176 (
dl
)->
dl_icmp_ty³
 == 11) || \

177 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

178 (
dl
)->
dl_icmp_ty³
 =ğ3)))

	)

180 
	#SCAMPER_DL_IS_ICMP_UNREACH
(
dl
) ( \

181 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

182 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

183 (
dl
)->
dl_icmp_ty³
 == 3) || \

184 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

185 (
dl
)->
dl_icmp_ty³
 =ğ1)))

	)

187 
	#SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
) ( \

188 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

189 (((
dl
)->
dl_af
 =ğ
AF_INET
 && (dl)->
dl__´Ùo
 == 1 && \

190 (
dl
)->
dl_icmp_ty³
 =ğ3 && (dl)->
dl_icmp_code
 == 4) || \

191 ((
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

192 (
dl
)->
dl_icmp_ty³
 =ğ2)))

	)

194 
	#SCAMPER_DL_IS_ICMP6_ND_NADV
(
dl
) ( \

195 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

196 (
dl
)->
dl_af
 =ğ
AF_INET6
 && (dl)->
dl__´Ùo
 == 58 && \

197 (
dl
)->
dl_icmp_ty³
 =ğ136)

	)

199 
	#SCAMPER_DL_IS_ARP
(
dl
) ( \

200 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_ARP
)

	)

202 
	#SCAMPER_DL_IS_ARP_OP_REQ
(
dl
) ( \

203 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_ARP
 && \

204 (
dl
)->
dl_¬p_İ
 =ğ1)

	)

206 
	#SCAMPER_DL_IS_ARP_OP_REPLY
(
dl
) ( \

207 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_ARP
 && \

208 (
dl
)->
dl_¬p_İ
 =ğ2)

	)

210 
	#SCAMPER_DL_IS_ARP_HRD_ETHERNET
(
dl
) ( \

211 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_ARP
 && \

212 (
dl
)->
dl_¬p_hrd
 =ğ1)

	)

214 
	#SCAMPER_DL_IS_ARP_PRO_IPV4
(
dl
) ( \

215 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_ARP
 && \

216 (
dl
)->
dl_¬p_´o
 =ğ0x0800)

	)

218 
	#SCAMPER_DL_IS_IP_DF
(
dl
) ( \

219 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

220 (
dl
)->
dl_af
 =ğ
AF_INET
 && ((dl)->
dl__æags
 & 
SCAMPER_DL_IP_FLAG_DF
è!ğ0)

	)

222 
	#SCAMPER_DL_IS_IP_MF
(
dl
) ( \

223 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

224 ((
dl
)->
dl__æags
 & 
SCAMPER_DL_IP_FLAG_MF
è!ğ0)

	)

226 
	#SCAMPER_DL_IS_IP_FRAG
(
dl
) ( \

227 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

228 ((
dl
)->
dl__æags
 & 
SCAMPER_DL_IP_FLAG_FRAG
è!ğ0)

	)

230 
	#SCAMPER_DL_IS_IP_REASS
(
dl
) ( \

231 (
dl
)->
dl_Ãt_ty³
 =ğ
SCAMPER_DL_REC_NET_TYPE_IP
 && \

232 ((
dl
)->
dl__æags
 & 
SCAMPER_DL_IP_FLAG_REASS
è!ğ0)

	)

240 
	ssÿm³r_dl_»c


243 
ušt32_t
 
	mdl_æags
;

246 
ušt32_t
 
	mdl_ty³
;

249 
timev®
 
	mdl_tv
;

255 
	mdl_ifšdex
;

263 
ušt8_t
 *
	mdl_Îaddr_¤c
;

264 
ušt8_t
 *
	mdl_Îaddr_d¡
;

272 
ušt8_t
 
	mdl_Ãt_ty³
;

273 
ušt8_t
 *
	mdl_Ãt_¿w
;

274 
size_t
 
	mdl_Ãt_¿wËn
;

278 
	sdl_


280 
	maf
;

281 
ušt8_t
 
	mhl
;

282 
ušt8_t
 *
	m¤c
;

283 
ušt8_t
 *
	md¡
;

284 
ušt16_t
 
	msize
;

285 
ušt16_t
 
	moff
;

286 
ušt16_t
 
	mid
;

287 
ušt32_t
 
	mid
;

288 
ušt32_t
 
	mæow
;

289 
ušt8_t
 
	mtos
;

290 
ušt8_t
 
	m‰l
;

291 
ušt8_t
 
	m´Ùo
;

292 
ušt8_t
 
	mæags
;

293 
ušt8_t
 *
	md©a
;

294 
ušt16_t
 
	mËn
;

295 } 
	mÃt_
;

297 
	sdl_¬p


299 
ušt16_t
 
	mhrd
;

300 
ušt16_t
 
	m´o
;

301 
ušt8_t
 
	mhÊ
;

302 
ušt8_t
 
	m¶n
;

303 
ušt16_t
 
	mİ
;

304 
ušt8_t
 *
	msha
;

305 
ušt8_t
 *
	m¥a
;

306 
ušt8_t
 *
	mtha
;

307 
ušt8_t
 *
	ma
;

308 } 
	mÃt_¬p
;

310 } 
	mdl_Ãt_un
;

320 
	sdl_udp


322 
ušt16_t
 
	m¥Üt
;

323 
ušt16_t
 
	mdpÜt
;

324 
ušt16_t
 
	msum
;

325 } 
	mudp
;

327 
	sdl_tı


329 
ušt16_t
 
	m¥Üt
;

330 
ušt16_t
 
	mdpÜt
;

331 
ušt32_t
 
	m£q
;

332 
ušt32_t
 
	mack
;

333 
ušt8_t
 
	mhl
;

334 
ušt8_t
 
	mæags
;

335 
ušt16_t
 
	mwš
;

336 
ušt16_t
 
	mmss
;

337 
ušt8_t
 
	mİts
;

338 
št8_t
 
	m§ck_edgec
;

339 
ušt32_t
 
	m§ck_edges
[8];

340 
ušt32_t
 
	mtsv®
;

341 
ušt32_t
 
	mt£ü
;

342 
ušt8_t
 *
	md©a
;

343 
ušt16_t
 
	md©®’
;

344 } 
	mtı
;

346 
	sdl_icmp


348 
ušt8_t
 
	mty³
;

349 
ušt8_t
 
	mcode
;

353 
	sdl_icmp6_nd


355 
ušt8_t
 *
	mrg‘
;

356 
ušt8_t
 *
	mİts
;

357 
ušt16_t
 
	mİts_Ën
;

358 } 
	mnd
;

360 
	sdl_icmp_echo


362 
ušt16_t
 
	mid
;

363 
ušt16_t
 
	m£q
;

364 } 
	mecho
;

366 
	sdl_icmp_”r


368 
ušt16_t
 
	mnhmtu
;

369 
ušt8_t
 *
	m_¤c
;

370 
ušt8_t
 *
	m_d¡
;

371 
ušt16_t
 
	m_size
;

372 
ušt16_t
 
	m_id
;

373 
ušt32_t
 
	m_æow
;

374 
ušt8_t
 
	m_tos
;

375 
ušt8_t
 
	m_‰l
;

376 
ušt8_t
 
	m_´Ùo
;

380 
	sicmp_udp


382 
ušt16_t
 
	m¥Üt
;

383 
ušt16_t
 
	mdpÜt
;

384 
ušt16_t
 
	msum
;

385 } 
	mudp
;

387 
	sicmp_tı


389 
ušt16_t
 
	m¥Üt
;

390 
ušt16_t
 
	mdpÜt
;

391 
ušt32_t
 
	m£q
;

392 } 
	mtı
;

394 
	sicmp_icmp


396 
ušt8_t
 
	mty³
;

397 
ušt8_t
 
	mcode
;

398 
ušt16_t
 
	mid
;

399 
ušt16_t
 
	m£q
;

400 } 
	micmp
;

401 } 
	mŒªs
;

402 } 
	m”r
;

403 } 
	mun
;

404 } 
	micmp
;

405 } 
	mdl_Œªs_un
;

407 } 
	tsÿm³r_dl_»c_t
;

409 
	#dl_æags
 
dl_æags


	)

410 
	#dl_ifšdex
 
dl_ifšdex


	)

411 
	#dl_Îaddr_¤c
 
dl_Îaddr_¤c


	)

412 
	#dl_Îaddr_d¡
 
dl_Îaddr_d¡


	)

413 
	#dl_Ãt_ty³
 
dl_Ãt_ty³


	)

414 
	#dl_Ãt_¿w
 
dl_Ãt_¿w


	)

415 
	#dl_Ãt_¿wËn
 
dl_Ãt_¿wËn


	)

416 
	#dl_¬p_hrd
 
dl_Ãt_un
.
Ãt_¬p
.
hrd


	)

417 
	#dl_¬p_´o
 
dl_Ãt_un
.
Ãt_¬p
.
´o


	)

418 
	#dl_¬p_hÊ
 
dl_Ãt_un
.
Ãt_¬p
.
hÊ


	)

419 
	#dl_¬p_¶n
 
dl_Ãt_un
.
Ãt_¬p
.
¶n


	)

420 
	#dl_¬p_İ
 
dl_Ãt_un
.
Ãt_¬p
.
İ


	)

421 
	#dl_¬p_sha
 
dl_Ãt_un
.
Ãt_¬p
.
sha


	)

422 
	#dl_¬p_¥a
 
dl_Ãt_un
.
Ãt_¬p
.
¥a


	)

423 
	#dl_¬p_tha
 
dl_Ãt_un
.
Ãt_¬p
.
tha


	)

424 
	#dl_¬p_a
 
dl_Ãt_un
.
Ãt_¬p
.
a


	)

425 
	#dl_af
 
dl_Ãt_un
.
Ãt_
.
af


	)

426 
	#dl__hl
 
dl_Ãt_un
.
Ãt_
.
hl


	)

427 
	#dl__¤c
 
dl_Ãt_un
.
Ãt_
.
¤c


	)

428 
	#dl__d¡
 
dl_Ãt_un
.
Ãt_
.
d¡


	)

429 
	#dl__size
 
dl_Ãt_un
.
Ãt_
.
size


	)

430 
	#dl__id
 
dl_Ãt_un
.
Ãt_
.
id


	)

431 
	#dl_6_id
 
dl_Ãt_un
.
Ãt_
.
id


	)

432 
	#dl__off
 
dl_Ãt_un
.
Ãt_
.
off


	)

433 
	#dl__tos
 
dl_Ãt_un
.
Ãt_
.
tos


	)

434 
	#dl__‰l
 
dl_Ãt_un
.
Ãt_
.
‰l


	)

435 
	#dl__hlim
 
dl_Ãt_un
.
Ãt_
.
‰l


	)

436 
	#dl__´Ùo
 
dl_Ãt_un
.
Ãt_
.
´Ùo


	)

437 
	#dl__æow
 
dl_Ãt_un
.
Ãt_
.
æow


	)

438 
	#dl__æags
 
dl_Ãt_un
.
Ãt_
.
æags


	)

439 
	#dl__d©a
 
dl_Ãt_un
.
Ãt_
.
d©a


	)

440 
	#dl__d©®’
 
dl_Ãt_un
.
Ãt_
.
Ën


	)

441 
	#dl_udp_¥Üt
 
dl_Œªs_un
.
udp
.
¥Üt


	)

442 
	#dl_udp_dpÜt
 
dl_Œªs_un
.
udp
.
dpÜt


	)

443 
	#dl_udp_sum
 
dl_Œªs_un
.
udp
.
sum


	)

444 
	#dl_tı_¥Üt
 
dl_Œªs_un
.
tı
.
¥Üt


	)

445 
	#dl_tı_dpÜt
 
dl_Œªs_un
.
tı
.
dpÜt


	)

446 
	#dl_tı_£q
 
dl_Œªs_un
.
tı
.
£q


	)

447 
	#dl_tı_ack
 
dl_Œªs_un
.
tı
.
ack


	)

448 
	#dl_tı_hl
 
dl_Œªs_un
.
tı
.
hl


	)

449 
	#dl_tı_æags
 
dl_Œªs_un
.
tı
.
æags


	)

450 
	#dl_tı_wš
 
dl_Œªs_un
.
tı
.
wš


	)

451 
	#dl_tı_mss
 
dl_Œªs_un
.
tı
.
mss


	)

452 
	#dl_tı_İts
 
dl_Œªs_un
.
tı
.
İts


	)

453 
	#dl_tı_§ck_edges
 
dl_Œªs_un
.
tı
.
§ck_edges


	)

454 
	#dl_tı_§ck_edgec
 
dl_Œªs_un
.
tı
.
§ck_edgec


	)

455 
	#dl_tı_tsv®
 
dl_Œªs_un
.
tı
.
tsv®


	)

456 
	#dl_tı_t£ü
 
dl_Œªs_un
.
tı
.
t£ü


	)

457 
	#dl_tı_d©a
 
dl_Œªs_un
.
tı
.
d©a


	)

458 
	#dl_tı_d©®’
 
dl_Œªs_un
.
tı
.
d©®’


	)

459 
	#dl_icmp_ty³
 
dl_Œªs_un
.
icmp
.
ty³


	)

460 
	#dl_icmp_code
 
dl_Œªs_un
.
icmp
.
code


	)

461 
	#dl_icmp_id
 
dl_Œªs_un
.
icmp
.
un
.
echo
.
id


	)

462 
	#dl_icmp_£q
 
dl_Œªs_un
.
icmp
.
un
.
echo
.
£q


	)

463 
	#dl_icmp_nhmtu
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
nhmtu


	)

464 
	#dl_icmp__¤c
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_¤c


	)

465 
	#dl_icmp__d¡
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_d¡


	)

466 
	#dl_icmp__size
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_size


	)

467 
	#dl_icmp__id
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_id


	)

468 
	#dl_icmp__æow
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_æow


	)

469 
	#dl_icmp__tos
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_tos


	)

470 
	#dl_icmp__‰l
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_‰l


	)

471 
	#dl_icmp__hlim
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_‰l


	)

472 
	#dl_icmp__´Ùo
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
_´Ùo


	)

473 
	#dl_icmp_udp_¥Üt
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
udp
.
¥Üt


	)

474 
	#dl_icmp_udp_dpÜt
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
udp
.
dpÜt


	)

475 
	#dl_icmp_udp_sum
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
udp
.
sum


	)

476 
	#dl_icmp_tı_¥Üt
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
tı
.
¥Üt


	)

477 
	#dl_icmp_tı_dpÜt
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
tı
.
dpÜt


	)

478 
	#dl_icmp_tı_£q
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.
tı
.
£q


	)

479 
	#dl_icmp_icmp_ty³
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.icmp.
ty³


	)

480 
	#dl_icmp_icmp_code
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.icmp.
code


	)

481 
	#dl_icmp_icmp_id
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.icmp.
id


	)

482 
	#dl_icmp_icmp_£q
 
dl_Œªs_un
.
icmp
.
un
.
”r
.
Œªs
.icmp.
£q


	)

483 
	#dl_icmp6_nd_rg‘
 
dl_Œªs_un
.
icmp
.
un
.
nd
.
rg‘


	)

484 
	#dl_icmp6_nd_İts
 
dl_Œªs_un
.
icmp
.
un
.
nd
.
İts


	)

485 
	#dl_icmp6_nd_İts_Ën
 
dl_Œªs_un
.
icmp
.
un
.
nd
.
İts_Ën


	)

487 
	#SCAMPER_DL_TX_UNSUPPORTED
 0x00

	)

488 
	#SCAMPER_DL_TX_ETHERNET
 0x01

	)

489 
	#SCAMPER_DL_TX_NULL
 0x02

	)

490 
	#SCAMPER_DL_TX_RAW
 0x03

	)

491 
	#SCAMPER_DL_TX_ETHLOOP
 0x04

	)

493 
sÿm³r_dl
 
	tsÿm³r_dl_t
;

499 
sÿm³r_dl_š™
();

500 
sÿm³r_dl_ş—nup
();

502 
sÿm³r_dl_tx_ty³
(
sÿm³r_dl_t
 *);

508 
sÿm³r_dl_İ’
(cÚ¡ 
ifšdex
);

509 
sÿm³r_dl_İ’_fd
(cÚ¡ 
ifšdex
);

510 
sÿm³r_dl_şo£
(
fd
);

516 #ifdeà
__SCAMPER_FD_H


517 
sÿm³r_dl_t
 *
sÿm³r_dl_¡©e_®loc
(
sÿm³r_fd_t
 *
fdn
);

518 
sÿm³r_dl_¡©e_ä“
(
sÿm³r_dl_t
 *
dl
);

524 
sÿm³r_dl_»ad_cb
(cÚ¡ 
fd
, *
·¿m
);

531 
sÿm³r_dl_tx
(cÚ¡ 
sÿm³r_dl_t
 *
dl
,

532 cÚ¡ 
ušt8_t
 *
pkt
, cÚ¡ 
size_t
 
Ën
);

534 #ifdeà
__SCAMPER_ADDR_H


535 
sÿm³r_dl_»c_¤c
(
sÿm³r_dl_»c_t
 *
dl
, 
sÿm³r_addr_t
 *
addr
);

536 
sÿm³r_dl_»c_icmp__d¡
(
sÿm³r_dl_»c_t
 *
dl
, 
sÿm³r_addr_t
 *
addr
);

539 #ià!
defšed
(
NDEBUG
è&& !defšed(
WITHOUT_DEBUGFILE
)

540 
sÿm³r_dl_»c_tı_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
);

541 
sÿm³r_dl_»c_äag_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
);

542 
sÿm³r_dl_»c_icmp_´št
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
);

544 
	#sÿm³r_dl_»c_tı_´št
(
dl
è(()0)

	)

545 
	#sÿm³r_dl_»c_äag_´št
(
dl
è(()0)

	)

546 
	#sÿm³r_dl_»c_icmp_´št
(
dl
è(()0)

	)

	@scamper_dlhdr.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_debug.h
"

36 
	~"sÿm³r_fds.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_addr2mac.h
"

39 
	~"sÿm³r_sk.h
"

40 
	~"sÿm³r_dl.h
"

41 
	~"sÿm³r_dlhdr.h
"

42 
	~"sÿm³r_if.h
"

43 
	~"sÿm³r_li¡.h
"

44 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc_do.h
"

45 
	~"uts.h
"

47 
	$dlhdr_‘hmake
(
sÿm³r_dlhdr_t
 *
dlhdr
, 
sÿm³r_addr_t
 *
mac
)

49 if((
dlhdr
->
buf
 = 
	`m®loc
(14)è=ğ
NULL
)

51 
dlhdr
->
”rÜ
 = 
”ºo
;

54 
dlhdr
->
Ën
 = 14;

57 
	`memıy
(
dlhdr
->
buf
, 
mac
->
addr
, 6);

60 if(
	`sÿm³r_if_g‘mac
(
dlhdr
->
ifšdex
, dlhdr->
buf
+6) != 0)

62 
dlhdr
->
”rÜ
 = 
”ºo
;

63 
	`sÿm³r_debug
(
__func__
, "could‚ot get source mac");

68 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
dlhdr
->
d¡
))

70 
dlhdr
->
buf
[12] = 0x08;

71 
dlhdr
->
buf
[13] = 0x00;

73 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
dlhdr
->
d¡
))

75 
dlhdr
->
buf
[12] = 0x86;

76 
dlhdr
->
buf
[13] = 0xDD;

80 
dlhdr
->
”rÜ
 = 
EINVAL
;

81 
	`sÿm³r_debug
(
__func__
, "unhªdËd ip->ty³ %d", 
dlhdr
->
d¡
->
ty³
);

84 
	}
}

91 
	$dlhdr_‘hcb
(*
·¿m
, 
sÿm³r_addr_t
 *

, sÿm³r_addr_ˆ*
mac
)

93 
sÿm³r_dlhdr_t
 *
dlhdr
 = 
·¿m
;

94 
dlhdr
->
š‹º®
 = 
NULL
;

95 if(
mac
 !ğ
NULL
)

97 
	`sÿm³r_addr2mac_add
(
dlhdr
->
ifšdex
, 

, 
mac
);

98 
	`dlhdr_‘hmake
(
dlhdr
, 
mac
);

102 
dlhdr
->
”rÜ
 = 
ENOENT
;

104 
dlhdr
->
	`cb
(dlhdr);

106 
	}
}

115 
	$dlhdr_‘h”Ãt
(
sÿm³r_dlhdr_t
 *
dlhdr
)

117 
sÿm³r_Ãighbourdisc_do_t
 *
nd
 = 
NULL
;

118 
sÿm³r_addr_t
 *

 = 
NULL
;

119 
sÿm³r_addr_t
 *
mac
 = 
NULL
;

120 
ifšdex
 = 
dlhdr
->ifindex;

123 if(
dlhdr
->
gw
 =ğ
NULL
)

124 

 = 
dlhdr
->
d¡
;

125 if(
dlhdr
->
gw
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_ETHERNET
)

126 
mac
 = 
dlhdr
->
gw
;

128 

 = 
dlhdr
->
gw
;

131 if(
mac
 =ğ
NULL
 && (maøğ
	`sÿm³r_addr2mac_whohas
(
ifšdex
, 

)) == NULL)

133 
nd
 = 
	`sÿm³r_do_Ãighbourdisc_do
(
ifšdex
, 

, 
dlhdr
, 
dlhdr_‘hcb
);

134 if(
nd
 =ğ
NULL
)

136 
dlhdr
->
”rÜ
 = 
”ºo
;

137 
dÚe
;

139 
dlhdr
->
š‹º®
 = 
nd
;

144 
	`dlhdr_‘hmake
(
dlhdr
, 
mac
);

146 
dÚe
:

147 
dlhdr
->
	`cb
(dlhdr);

149 
	}
}

151 
	$dlhdr_‘hloİ
(
sÿm³r_dlhdr_t
 *
dlhdr
)

153 if((
dlhdr
->
buf
 = 
	`m®loc_z”o
(14)è=ğ
NULL
)

155 
dlhdr
->
”rÜ
 = 
”ºo
;

156 
dÚe
;

158 
dlhdr
->
Ën
 = 14;

160 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
dlhdr
->
d¡
))

162 
dlhdr
->
buf
[12] = 0x08;

163 
dlhdr
->
buf
[13] = 0x00;

165 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
dlhdr
->
d¡
))

167 
dlhdr
->
buf
[12] = 0x86;

168 
dlhdr
->
buf
[13] = 0xDD;

172 
dlhdr
->
”rÜ
 = 
EINVAL
;

173 
dÚe
;

176 
dÚe
:

177 
dlhdr
->
	`cb
(dlhdr);

179 
	}
}

181 
	$dlhdr_nuÎ
(
sÿm³r_dlhdr_t
 *
dlhdr
)

183 
af
;

185 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
dlhdr
->
d¡
))

186 
af
 = 
AF_INET
;

187 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
dlhdr
->
d¡
))

188 
af
 = 
AF_INET6
;

191 
dlhdr
->
”rÜ
 = 
EINVAL
;

192 
dÚe
;

195 if((
dlhdr
->
buf
 = 
	`memdup
(&
af
, ×f))è=ğ
NULL
)

197 
dlhdr
->
”rÜ
 = 
”ºo
;

198 
dÚe
;

200 
dlhdr
->
Ën
 = (
af
);

202 
dÚe
:

203 
dlhdr
->
	`cb
(dlhdr);

205 
	}
}

207 
	$dlhdr_¿w
(
sÿm³r_dlhdr_t
 *
dlhdr
)

209 
dlhdr
->
	`cb
(dlhdr);

211 
	}
}

213 
	$dlhdr_unsuµ
(
sÿm³r_dlhdr_t
 *
dlhdr
)

216 
	}
}

223 
	$sÿm³r_dlhdr_g‘
(
sÿm³r_dlhdr_t
 *
dlhdr
)

225 (*cÚ¡ 
func
[])(
sÿm³r_dlhdr_t
 *
dlhdr
) = {

226 
dlhdr_unsuµ
,

227 
dlhdr_‘h”Ãt
,

228 
dlhdr_nuÎ
,

229 
dlhdr_¿w
,

230 
dlhdr_‘hloİ
,

233 if(
dlhdr
->
txty³
 < 0 || dlhdr->txtype > 4)

235 
dlhdr
->
”rÜ
 = 
EINVAL
;

239  
func
[
dlhdr
->
txty³
](dlhdr);

240 
	}
}

242 
sÿm³r_dlhdr_t
 *
	$sÿm³r_dlhdr_®loc
()

244  (
sÿm³r_dlhdr_t
 *)
	`m®loc_z”o
((scamper_dlhdr_t));

245 
	}
}

247 
	$sÿm³r_dlhdr_ä“
(
sÿm³r_dlhdr_t
 *
dlhdr
)

249 if(
dlhdr
 =ğ
NULL
)

251 if(
dlhdr
->
gw
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(dlhdr->gw);

252 if(
dlhdr
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(dlhdr->dst);

253 if(
dlhdr
->
buf
 !ğ
NULL
è
	`ä“
(dlhdr->buf);

254 if(
dlhdr
->
š‹º®
 !ğ
NULL
è
	`sÿm³r_Ãighbourdisc_do_ä“
(dlhdr->internal);

255 
	`ä“
(
dlhdr
);

257 
	}
}

	@scamper_dlhdr.h

25 #iâdeà
__SCAMPER_DLHDR_H


26 
	#__SCAMPER_DLHDR_H


	)

28 
sÿm³r_dlhdr_š™
();

29 
sÿm³r_dlhdr_ş—nup
();

31 
sÿm³r_dlhdr
 
	tsÿm³r_dlhdr_t
;

33 
sÿm³r_dlhdr_t
 *
sÿm³r_dlhdr_®loc
();

34 
sÿm³r_dlhdr_ä“
(
sÿm³r_dlhdr_t
 *
dlhdr
);

36 
sÿm³r_dlhdr_g‘
(
sÿm³r_dlhdr_t
 *
dlhdr
);

38 #ià
defšed
(
__SCAMPER_ADDR_H
)

45 
	ssÿm³r_dlhdr


56 
sÿm³r_addr_t
 *
	md¡
;

57 
sÿm³r_addr_t
 *
	mgw
;

58 
	mifšdex
;

59 
	mtxty³
;

60 (*
	mcb
)(
	msÿm³r_dlhdr_t
 *);

61 *
	m·¿m
;

68 
	m”rÜ
;

69 
ušt8_t
 *
	mbuf
;

70 
ušt16_t
 
	mËn
;

73 *
	mš‹º®
;

	@scamper_fds.c

34 #iâdeà
lšt


35 cÚ¡ 
	grcsid
[] =

39 #ifdeà
HAVE_CONFIG_H


40 
	~"cÚfig.h
"

42 
	~"š‹º®.h
"

44 
	~"sÿm³r.h
"

45 
	~"sÿm³r_fds.h
"

46 
	~"sÿm³r_debug.h
"

47 
	~"sÿm³r_icmp4.h
"

48 
	~"sÿm³r_icmp6.h
"

49 
	~"sÿm³r_udp4.h
"

50 
	~"sÿm³r_udp6.h
"

51 
	~"sÿm³r_tı4.h
"

52 
	~"sÿm³r_tı6.h
"

53 
	~"sÿm³r_4.h
"

54 
	~"sÿm³r_dl.h
"

55 #iâdeà
_WIN32


56 
	~"sÿm³r_¹sock.h
"

58 
	~"uts.h
"

59 
	~"mjl_li¡.h
"

60 
	~"mjl_¥ÏyŒ“.h
"

67 
	ssÿm³r_fd_pŞl


69 
sÿm³r_fd_t
 *
	mfdn
;

70 
sÿm³r_fd_cb_t
 
	mcb
;

71 *
	m·¿m
;

72 
dli¡_t
 *
	mli¡
;

73 
dli¡_node_t
 *
	mnode
;

74 
ušt8_t
 
	mæags
;

75 } 
	tsÿm³r_fd_pŞl_t
;

83 
	ssÿm³r_fd


85 
	mfd
;

86 
sÿm³r_fd_t
 *
	m¶
;

87 
	mty³
;

88 
	m»fút
;

89 
sÿm³r_fd_pŞl_t
 
	m»ad
;

90 
sÿm³r_fd_pŞl_t
 
	mwr™e
;

92 
¥ÏyŒ“_node_t
 *
	mfd_Œ“_node
;

93 
dli¡_node_t
 *
	mfd_li¡_node
;

95 
timev®
 
	mtv
;

96 
dli¡_node_t
 *
	mrc0
;

100 
	sfd_t_tı


102 *
	maddr
;

103 
ušt16_t
 
	m¥Üt
;

104 } 
	mfd_t_tı
;

106 
	sfd_t_udp


108 *
	maddr
;

109 
ušt16_t
 
	m¥Üt
;

110 } 
	mfd_t_udp
;

112 
	sfd_t_icmp


114 *
	maddr
;

115 } 
	mfd_t_icmp
;

117 
	sfd_t_dl


119 
	mifšdex
;

120 
sÿm³r_dl_t
 *
	mdl
;

121 } 
	mfd_t_dl
;

123 } 
	mfd_t_un
;

126 
	#SCAMPER_FD_TYPE_PRIVATE
 0x00

	)

127 
	#SCAMPER_FD_TYPE_ICMP4
 0x01

	)

128 
	#SCAMPER_FD_TYPE_ICMP6
 0x02

	)

129 
	#SCAMPER_FD_TYPE_UDP4
 0x03

	)

130 
	#SCAMPER_FD_TYPE_UDP4DG
 0x04

	)

131 
	#SCAMPER_FD_TYPE_UDP6
 0x05

	)

132 
	#SCAMPER_FD_TYPE_TCP4
 0x06

	)

133 
	#SCAMPER_FD_TYPE_TCP6
 0x07

	)

134 
	#SCAMPER_FD_TYPE_DL
 0x08

	)

135 
	#SCAMPER_FD_TYPE_IP4
 0x09

	)

137 #iâdeà
_WIN32


138 
	#SCAMPER_FD_TYPE_RTSOCK
 0x0a

	)

139 
	#SCAMPER_FD_TYPE_IFSOCK
 0x0b

	)

142 
	#SCAMPER_FD_TYPE_IS_UDP
(
fd
) ( \

143 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
 || \

144 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4DG
 || \

145 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP6
)

	)

147 
	#SCAMPER_FD_TYPE_IS_ICMP
(
fd
) ( \

148 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
 || \

149 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP6
)

	)

151 
	#SCAMPER_FD_TYPE_IS_TCP
(
fd
) ( \

152 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
 || \

153 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_TCP6
)

	)

155 
	#SCAMPER_FD_TYPE_IS_IPV4
(
fd
) ( \

156 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
 || \

157 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
 || \

158 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4DG
 || \

159 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
)

	)

161 
	#SCAMPER_FD_TYPE_IS_IPV6
(
fd
) ( \

162 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP6
 || \

163 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_UDP6
 || \

164 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_TCP6
)

	)

166 
	#SCAMPER_FD_TYPE_IS_DL
(
fd
) ( \

167 (
fd
)->
ty³
 =ğ
SCAMPER_FD_TYPE_DL
)

	)

169 
	#SCAMPER_FD_POLL_FLAG_INACTIVE
 0x01

	)

171 
	#fd_tı_¥Üt
 
fd_t_un
.
fd_t_tı
.
¥Üt


	)

172 
	#fd_tı_addr
 
fd_t_un
.
fd_t_tı
.
addr


	)

173 
	#fd_udp_¥Üt
 
fd_t_un
.
fd_t_udp
.
¥Üt


	)

174 
	#fd_udp_addr
 
fd_t_un
.
fd_t_udp
.
addr


	)

175 
	#fd_icmp_addr
 
fd_t_un
.
fd_t_icmp
.
addr


	)

176 
	#fd_dl_ifšdex
 
fd_t_un
.
fd_t_dl
.
ifšdex


	)

177 
	#fd_dl_dl
 
fd_t_un
.
fd_t_dl
.
dl


	)

179 
sÿm³r_fd_t
 **
	gfd_¬¿y
 = 
NULL
;

180 
	gfd_¬¿y_s
 = 0;

181 
¥ÏyŒ“_t
 *
	gfd_Œ“
 = 
NULL
;

182 
dli¡_t
 *
	gfd_li¡
 = 
NULL
;

183 
dli¡_t
 *
	g»ad_fds
 = 
NULL
;

184 
dli¡_t
 *
	gwr™e_fds
 = 
NULL
;

185 
dli¡_t
 *
	g»ad_queue
 = 
NULL
;

186 
dli¡_t
 *
	gwr™e_queue
 = 
NULL
;

187 
dli¡_t
 *
	g»fút_0
 = 
NULL
;

188 
	g¶ª‘Ïb
 = 0;

189 (*
pŞlfunc
)(
timev®
 *
timeout
èğ
NULL
;

191 #ifdeà
HAVE_SCAMPER_DEBUG


193 *
	$fd_addr_to¡r
(*
buf
, 
size_t
 
Ën
, 
af
, *
addr
)

195 
tmp
[128];

197 if(
addr
 =ğ
NULL
 || 
	`addr_to¡r
(
af
,‡ddr, 
tmp
, (tmp)) == NULL)

200 
	`¢´štf
(
buf
, 
Ën
, " %s", 
tmp
);

201  
buf
;

202 
	}
}

204 *
	$fd_to¡r
(
sÿm³r_fd_t
 *
fdn
)

206 
buf
[144];

207 
addr
[128];

209 
fdn
->
ty³
)

211 
SCAMPER_FD_TYPE_PRIVATE
:

214 
SCAMPER_FD_TYPE_IP4
:

217 
SCAMPER_FD_TYPE_ICMP4
:

218 
	`¢´štf
(
buf
, (buf), "icmp4%s",

219 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET
, 
fdn
->
fd_icmp_addr
));

220  
buf
;

222 
SCAMPER_FD_TYPE_ICMP6
:

223 
	`¢´štf
(
buf
, (buf), "icmp6%s",

224 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET6
, 
fdn
->
fd_icmp_addr
));

225  
buf
;

227 
SCAMPER_FD_TYPE_UDP4
:

228 
	`¢´štf
(
buf
, (buf), "udp4%s",

229 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET
, 
fdn
->
fd_udp_addr
));

230  
buf
;

232 
SCAMPER_FD_TYPE_UDP4DG
:

233 
	`¢´štf
(
buf
, (buf), "udp4dg%s %d",

234 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET
, 
fdn
->
fd_udp_addr
),

235 
fdn
->
fd_udp_¥Üt
);

236  
buf
;

238 
SCAMPER_FD_TYPE_UDP6
:

239 
	`¢´štf
(
buf
, (buf), "udp6%s %d",

240 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET6
, 
fdn
->
fd_udp_addr
),

241 
fdn
->
fd_udp_¥Üt
);

242  
buf
;

244 
SCAMPER_FD_TYPE_TCP4
:

245 
	`¢´štf
(
buf
, (buf), "tcp4%s %d",

246 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET
, 
fdn
->
fd_tı_addr
),

247 
fdn
->
fd_tı_¥Üt
);

248  
buf
;

250 
SCAMPER_FD_TYPE_TCP6
:

251 
	`¢´štf
(
buf
, (buf), "tcp6%s %d",

252 
	`fd_addr_to¡r
(
addr
, ×ddr), 
AF_INET6
, 
fdn
->
fd_tı_addr
),

253 
fdn
->
fd_tı_¥Üt
);

254  
buf
;

256 
SCAMPER_FD_TYPE_DL
:

257 
	`¢´štf
(
buf
, (buf), "dÈ%d", 
fdn
->
fd_dl_ifšdex
);

258  
buf
;

260 #ifdeà
SCAMPER_FD_TYPE_RTSOCK


261 
SCAMPER_FD_TYPE_RTSOCK
:

265 #ifdeà
SCAMPER_FD_TYPE_IFSOCK


266 
SCAMPER_FD_TYPE_IFSOCK
:

272 
	}
}

275 
	$fd_şo£
(
sÿm³r_fd_t
 *
fdn
)

277 
fdn
->
ty³
)

279 
SCAMPER_FD_TYPE_PRIVATE
:

282 
SCAMPER_FD_TYPE_ICMP4
:

283 
	`sÿm³r_icmp4_şo£
(
fdn
->
fd
);

286 
SCAMPER_FD_TYPE_ICMP6
:

287 
	`sÿm³r_icmp6_şo£
(
fdn
->
fd
);

290 
SCAMPER_FD_TYPE_UDP4
:

291 
SCAMPER_FD_TYPE_UDP4DG
:

292 
	`sÿm³r_udp4_şo£
(
fdn
->
fd
);

295 
SCAMPER_FD_TYPE_UDP6
:

296 
	`sÿm³r_udp6_şo£
(
fdn
->
fd
);

299 
SCAMPER_FD_TYPE_TCP4
:

300 
	`sÿm³r_tı4_şo£
(
fdn
->
fd
);

303 
SCAMPER_FD_TYPE_TCP6
:

304 
	`sÿm³r_tı6_şo£
(
fdn
->
fd
);

307 
SCAMPER_FD_TYPE_DL
:

308 
	`sÿm³r_dl_şo£
(
fdn
->
fd
);

311 #ifdeà
SCAMPER_FD_TYPE_RTSOCK


312 
SCAMPER_FD_TYPE_RTSOCK
:

313 
	`sÿm³r_¹sock_şo£
(
fdn
->
fd
);

317 #ifdeà
SCAMPER_FD_TYPE_IFSOCK


318 
SCAMPER_FD_TYPE_IFSOCK
:

319 
	`şo£
(
fdn
->
fd
);

325 
	}
}

332 
	$fd_ä“
(
sÿm³r_fd_t
 *
fdn
)

334 
	`sÿm³r_debug
(
__func__
, "fd %dy³ %s", 
fdn
->
fd
, 
	`fd_to¡r
(fdn));

336 if(
fdn
->
fd
 >ğ0 && fdn->fd < 
fd_¬¿y_s
 && 
fd_¬¿y
 !ğ
NULL
)

337 
fd_¬¿y
[
fdn
->
fd
] = 
NULL
;

339 if(
fdn
->
»ad
.
node
 !ğ
NULL
)

340 
	`dli¡_node_pİ
(
fdn
->
»ad
.
li¡
, fdn->»ad.
node
);

342 if(
fdn
->
wr™e
.
node
 !ğ
NULL
)

343 
	`dli¡_node_pİ
(
fdn
->
wr™e
.
li¡
, fdn->wr™e.
node
);

345 if(
fdn
->
rc0
 !ğ
NULL
)

346 
	`dli¡_node_pİ
(
»fút_0
, 
fdn
->
rc0
);

348 if(
fdn
->
fd_Œ“_node
 !ğ
NULL
)

349 
	`¥ÏyŒ“_»move_node
(
fd_Œ“
, 
fdn
->
fd_Œ“_node
);

351 if(
fdn
->
fd_li¡_node
 !ğ
NULL
)

352 
	`dli¡_node_pİ
(
fd_li¡
, 
fdn
->
fd_li¡_node
);

354 if(
	`SCAMPER_FD_TYPE_IS_ICMP
(
fdn
))

356 if(
fdn
->
fd_icmp_addr
 !ğ
NULL
)

357 
	`ä“
(
fdn
->
fd_icmp_addr
);

359 if(
	`SCAMPER_FD_TYPE_IS_UDP
(
fdn
))

361 if(
fdn
->
fd_udp_addr
 !ğ
NULL
)

362 
	`ä“
(
fdn
->
fd_udp_addr
);

364 if(
	`SCAMPER_FD_TYPE_IS_TCP
(
fdn
))

366 if(
fdn
->
fd_tı_addr
 !ğ
NULL
)

367 
	`ä“
(
fdn
->
fd_tı_addr
);

369 if(
	`SCAMPER_FD_TYPE_IS_DL
(
fdn
))

371 if(
fdn
->
fd_dl_dl
 !ğ
NULL
)

372 
	`sÿm³r_dl_¡©e_ä“
(
fdn
->
fd_dl_dl
);

375 
	`ä“
(
fdn
);

378 
	}
}

386 
	$fd_»fút_0
(
sÿm³r_fd_t
 *
fdn
)

392 if(
	`dli¡_i¦ocked
(
fd_li¡
) != 0 ||

393 (
fdn
->
»ad
.
li¡
 !ğ
NULL
 && 
	`dli¡_i¦ocked
(fdn->read.list) != 0) ||

394 (
fdn
->
wr™e
.
li¡
 !ğ
NULL
 && 
	`dli¡_i¦ocked
(fdn->write.list) != 0))

403 if(
fdn
->
ty³
 =ğ
SCAMPER_FD_TYPE_PRIVATE
)

405 
	`fd_ä“
(
fdn
);

410 if((
fdn
->
rc0
 = 
	`dli¡__push
(
»fút_0
, fdn)è=ğ
NULL
)

412 
	`fd_şo£
(
fdn
);

413 
	`fd_ä“
(
fdn
);

421 
	`g‘timeofday_w¿p
(&
fdn
->
tv
);

422 
fdn
->
tv
.
tv_£c
 += 10;

425 
	}
}

427 
	$fd_pŞl_£i¡
(*
™em
, *
·¿m
)

429 ((
sÿm³r_fd_pŞl_t
 *)
™em
)->
li¡
 = (
dli¡_t
 *)
·¿m
;

431 
	}
}

439 
fd_£t
 *
	$fds_£Ëù_as£mbË
(
dli¡_t
 *
fds
, 
fd_£t
 *
fd£t
, *
nfds
)

441 
sÿm³r_fd_pŞl_t
 *
fdp
;

442 
dli¡_node_t
 *
node
;

443 
couÁ
 = 0;

445 
	`FD_ZERO
(
fd£t
);

447 
node
 = 
	`dli¡_h—d_node
(
fds
);

448 
node
 !ğ
NULL
)

451 
fdp
 = (
sÿm³r_fd_pŞl_t
 *)
	`dli¡_node_™em
(
node
);

454 
node
 = 
	`dli¡_node_Ãxt
(node);

457 if(
fdp
->
fdn
->
»fút
 =ğ0 && fdp->fdn->
rc0
 =ğ
NULL
)

459 
	`fd_»fút_0
(
fdp
->
fdn
);

464 if((
fdp
->
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) != 0)

466 
	`dli¡_node_ejeù
(
fds
, 
fdp
->
node
);

467 
fdp
->
li¡
 = 
NULL
;

472 
	`FD_SET
(
fdp
->
fdn
->
fd
, 
fd£t
);

473 
couÁ
++;

476 if(*
nfds
 < 
fdp
->
fdn
->
fd
)

478 *
nfds
 = 
fdp
->
fdn
->
fd
;

486 if(
couÁ
 == 0)

488  
NULL
;

491  
fd£t
;

492 
	}
}

501 
	$fds_£Ëù_check
(
fd_£t
 *
fd£t
, 
dli¡_t
 *
fds
, *
couÁ
)

503 
sÿm³r_fd_pŞl_t
 *
fdp
;

504 
dli¡_node_t
 *
node
;

507 if(
fd£t
 =ğ
NULL
 || *
couÁ
 == 0)

513 
	`dli¡_lock
(
fds
);

516 
node
 = 
	`dli¡_h—d_node
(
fds
);

517 
node
 !ğ
NULL
 && *
couÁ
 > 0)

519 
fdp
 = (
sÿm³r_fd_pŞl_t
 *)
	`dli¡_node_™em
(
node
);

520 
node
 = 
	`dli¡_node_Ãxt
(node);

522 if(
	`FD_ISSET
(
fdp
->
fdn
->
fd
, 
fd£t
))

524 
fdp
->
	`cb
(fdp->
fdn
->
fd
, fdp->
·¿m
);

525 (*
couÁ
)--;

530 
	`dli¡_uÆock
(
fds
);

533 
	}
}

535 
	$fds_£Ëù
(
timev®
 *
timeout
)

537 
fd_£t
 
rfds
, *
rfd¥
;

538 
fd_£t
 
wfds
, *
wfd¥
;

539 
couÁ
, 
nfds
 = -1;

542 
	`dli¡_fÜ—ch
(
»ad_queue
, 
fd_pŞl_£i¡
, 
»ad_fds
);

543 
	`dli¡_cÚÿt
(
»ad_fds
, 
»ad_queue
);

544 
	`dli¡_fÜ—ch
(
wr™e_queue
, 
fd_pŞl_£i¡
, 
wr™e_fds
);

545 
	`dli¡_cÚÿt
(
wr™e_fds
, 
wr™e_queue
);

548 
rfd¥
 = 
	`fds_£Ëù_as£mbË
(
»ad_fds
, &
rfds
, &
nfds
);

549 
wfd¥
 = 
	`fds_£Ëù_as£mbË
(
wr™e_fds
, &
wfds
, &
nfds
);

552 #ifdeà
_WIN32


553 if(
nfds
 == -1)

555 if(
timeout
 !ğ
NULL
 &&imeout->
tv_£c
 >ğ0 &&imeout->
tv_u£c
 >= 0)

556 
	`SË•
((
timeout
->
tv_£c
 * 1000è+ (timeout->
tv_u£c
 / 1000));

557 
couÁ
 = 0;

561 if((
couÁ
 = 
	`£Ëù
(
nfds
+1, 
rfd¥
, 
wfd¥
, 
NULL
, 
timeout
)) < 0)

563 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "select failed");

568 if(
couÁ
 > 0)

570 
	`fds_£Ëù_check
(
rfd¥
, 
»ad_fds
, &
couÁ
);

571 
	`fds_£Ëù_check
(
wfd¥
, 
wr™e_fds
, &
couÁ
);

575 
	}
}

577 #ifdeà
HAVE_POLL


578 
pŞlfd
 *
	gpŞl_fds
 = 
NULL
;

579 
	gpŞl_fdc
 = 0;

581 
	$fds_pŞl_check
(
ev’t
, 
rc
, 
couÁ
)

583 
sÿm³r_fd_t
 *
fd
;

584 
i
;

586 
i
=0; i<
couÁ
; i++)

589 if((
pŞl_fds
[
i
].
ev’ts
 & 
ev’t
) == 0)

593 if((
pŞl_fds
[
i
].
»v’ts
 & (
ev’t
|
POLLHUP
|
POLLERR
)) == 0)

600 if(
pŞl_fds
[
i
].
fd
 >ğ0 &&…Şl_fds[i].fd < 
fd_¬¿y_s
 &&

601 (
fd
 = 
fd_¬¿y
[
pŞl_fds
[
i
].fd]è!ğ
NULL
)

603 if(
ev’t
 =ğ
POLLIN
)

604 
fd
->
»ad
.
	`cb
(fd->fd, fd->»ad.
·¿m
);

606 
fd
->
wr™e
.
	`cb
(fd->fd, fd->wr™e.
·¿m
);

609 if(--
rc
 == 0)

614 
	}
}

616 
	$fds_pŞl
(
timev®
 *
tv
)

618 
sÿm³r_fd_t
 *
fd
;

619 
dli¡_node_t
 *
n
;

620 
timeout
;

621 
rc
, 
couÁ
 = 0, 
š
 = 0, 
out
 = 0;

622 
size_t
 
size
;

624 
n
 = 
	`dli¡_h—d_node
(
fd_li¡
);

625 
n
 !ğ
NULL
)

627 
fd
 = 
	`dli¡_node_™em
(
n
);

628 
n
 = 
	`dli¡_node_Ãxt
(n);

631 if(
fd
->
»fút
 =ğ0 && fd->
rc0
 =ğ
NULL
)

633 
	`fd_»fút_0
(
fd
);

638 if((
fd
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) != 0 &&

639 (
fd
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) != 0)

642 if(
couÁ
 + 1 > 
pŞl_fdc
)

644 
size
 = (
couÁ
+1è* (
pŞlfd
);

645 if(
	`»®loc_w¿p
((**)&
pŞl_fds
, 
size
) != 0)

647 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
,"could‚ot„ealloc…oll_fds");

650 
pŞl_fdc
 = 
couÁ
 + 1;

653 
pŞl_fds
[
couÁ
].
fd
 = fd->fd;

654 
pŞl_fds
[
couÁ
].
ev’ts
 = 0;

655 
pŞl_fds
[
couÁ
].
»v’ts
 = 0;

657 if((
fd
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

659 
pŞl_fds
[
couÁ
].
ev’ts
 |ğ
POLLIN
;

660 
š
++;

662 if((
fd
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

664 
pŞl_fds
[
couÁ
].
ev’ts
 |ğ
POLLOUT
;

665 
out
++;

668 
couÁ
++;

671 if(
tv
 !ğ
NULL
)

673 
timeout
 = (
tv
->
tv_£c
 * 1000è+ (tv->
tv_u£c
 / 1000);

674 if(
timeout
 =ğ0 && 
tv
->
tv_u£c
 != 0)

675 
timeout
++;

679 
timeout
 = -1;

682 if((
rc
 = 
	`pŞl
(
pŞl_fds
, 
couÁ
, 
timeout
)) < 0)

684 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…oll");

688 if(
rc
 > 0)

690 if(
š
 != 0)

691 
	`fds_pŞl_check
(
POLLIN
, 
rc
 < 
š
 ?„ø: in, 
couÁ
);

692 if(
out
 != 0)

693 
	`fds_pŞl_check
(
POLLOUT
, 
rc
 < 
out
 ?„ø: out, 
couÁ
);

697 
	}
}

700 #ifdeà
HAVE_KQUEUE


701 
kev’t
 *
	gkevli¡
 = 
NULL
;

702 
	gkevli¡Ën
 = 0;

703 
	gkq
 = -1;

705 
	$fds_kqueue_š™
()

707 if((
kq
 = 
	`kqueue
()) == -1)

709 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create kqueue");

712 
	`sÿm³r_debug
(
__func__
, "fd %d", 
kq
);

714 
	}
}

716 
	$fds_kqueue_£t
(
sÿm³r_fd_t
 *
fd
, 
f‹r
, 
u_shÜt
 
æags
)

718 
kev’t
 
kev
;

719 
	`EV_SET
(&
kev
, 
fd
->fd, 
f‹r
, 
æags
, 0, 0, fd);

720 if(
	`kev’t
(
kq
, &
kev
, 1, 
NULL
, 0, NULL) != 0)

722 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "fd %d % %s", 
fd
->fd,

723 
f‹r
 =ğ
EVFILT_READ
 ? "EVFILT_READ" : "EVFILT_WRITE",

724 
æags
 =ğ
EV_ADD
 ? "EV_ADD" : "EV_DELETE");

727 
	}
}

729 
	$fds_kqueue
(
timev®
 *
tv
)

731 
sÿm³r_fd_t
 *
fdp
;

732 
time¥ec
 
ts
, *
t¥
 = 
NULL
;

733 
kev’t
 *
kev
;

734 
fd
, 
i
, 
c
;

736 if((
c
 = 
	`dli¡_couÁ
(
»ad_fds
è+ dli¡_couÁ(
wr™e_fds
)è>ğ
kevli¡Ën
)

738 
c
 += 8;

739 if(
	`»®loc_w¿p
((**)&
kevli¡
, (
kev’t
è* 
c
) != 0)

741 if(
kevli¡Ën
 == 0)

743 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc kevlist");

749 
kevli¡Ën
 = 
c
;

753 if(
tv
 !ğ
NULL
)

755 
ts
.
tv_£c
 = 
tv
->tv_sec;

756 
ts
.
tv_n£c
 = 
tv
->
tv_u£c
 * 1000;

757 
t¥
 = &
ts
;

760 if((
c
 = 
	`kev’t
(
kq
, 
NULL
, 0, 
kevli¡
, 
kevli¡Ën
, 
t¥
)) == -1)

762 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "kevent failed");

766 
i
=0; i<
c
; i++)

768 
kev
 = &
kevli¡
[
i
];

769 
fd
 = 
kev
->
id’t
;

771 if(
fd
 < 0 || fd >ğ
fd_¬¿y_s
)

773 if((
fdp
 = 
fd_¬¿y
[
fd
]è=ğ
NULL
)

775 if(
kev
->
f‹r
 =ğ
EVFILT_READ
)

776 
fdp
->
»ad
.
	`cb
(
fd
, fdp->»ad.
·¿m
);

777 if(
kev
->
f‹r
 =ğ
EVFILT_WRITE
)

778 
fdp
->
wr™e
.
	`cb
(
fd
, fdp->wr™e.
·¿m
);

782 
	}
}

785 #ifdeà
HAVE_EPOLL


786 
•Şl_ev’t
 *
	g•_ev’ts
 = 
NULL
;

787 
	g•_ev’t_c
 = 0;

788 
	g•
 = -1;

789 
	g•_fdc
 = 0;

791 
	$fds_•Şl_š™
()

793 if((
•
 = 
	`•Şl_ü—‹
(10)) == -1)

795 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚otƒpoll_create");

798 
	`sÿm³r_debug
(
__func__
, "fd %d", 
•
);

800 
	}
}

802 
	$fds_•Şl_ùl
(
sÿm³r_fd_t
 *
fd
, 
ušt32_t
 
ev
, 
İ
)

804 
•Şl_ev’t
 
•ev
;

806 if(
İ
 =ğ
EPOLL_CTL_ADD
 &&

807 ((
ev
 =ğ
EPOLLIN
 &&

808 (
fd
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0) ||

809 (
ev
 =ğ
EPOLLOUT
 &&

810 (
fd
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)))

812 
İ
 = 
EPOLL_CTL_MOD
;

813 
ev
 = 
EPOLLIN
 | 
EPOLLOUT
;

815 if(
İ
 =ğ
EPOLL_CTL_DEL
 && 
ev
 =ğ
EPOLLIN
 &&

816 (
fd
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

818 
İ
 = 
EPOLL_CTL_MOD
;

819 
ev
 = 
EPOLLOUT
;

821 if(
İ
 =ğ
EPOLL_CTL_DEL
 && 
ev
 =ğ
EPOLLOUT
 &&

822 (
fd
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

824 
İ
 = 
EPOLL_CTL_MOD
;

825 
ev
 = 
EPOLLIN
;

828 if(
İ
 =ğ
EPOLL_CTL_ADD
)

829 
•_fdc
++;

830 if(
İ
 =ğ
EPOLL_CTL_DEL
)

831 
•_fdc
--;

833 
•ev
.
d©a
.
±r
 = 
fd
;

834 
•ev
.
d©a
.
fd
 = fd->fd;

835 
•ev
.
ev’ts
 = 
ev
;

837 if(
	`•Şl_ùl
(
•
, 
İ
, 
fd
->fd, &
•ev
) != 0)

838 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "fd %d o°%dƒv %u", 
fd
->fd, 
İ
, 
ev
);

841 
	}
}

843 
	$fds_•Şl
(
timev®
 *
tv
)

845 
i
, 
fd
, 
rc
, 
timeout
;

846 
sÿm³r_fd_t
 *
fdp
;

847 
size_t
 
size
;

849 if(
•_fdc
 >ğ
•_ev’t_c
)

851 
rc
 = 
•_fdc
 + 8;

852 
size
 = (
•Şl_ev’t
è* 
rc
;

853 if(
	`»®loc_w¿p
((**)&
•_ev’ts
, 
size
) != 0)

855 if(
•_ev’t_c
 == 0)

857 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocƒvents");

863 
•_ev’t_c
 = 
rc
;

867 if(
tv
 !ğ
NULL
)

869 
timeout
 = (
tv
->
tv_£c
 * 1000è+ (tv->
tv_u£c
 / 1000);

870 if(
timeout
 =ğ0 && 
tv
->
tv_u£c
 != 0)

871 
timeout
++;

875 
timeout
 = -1;

878 if((
rc
 = 
	`•Şl_wa™
(
•
, 
•_ev’ts
, 
•_ev’t_c
, 
timeout
)) == -1)

880 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚otƒpoll_wait");

884 
i
=0; i<
rc
; i++)

886 
fd
 = 
•_ev’ts
[
i
].
d©a
.fd;

887 if(
fd
 < 0 || fd >ğ
fd_¬¿y_s
)

890 if(
•_ev’ts
[
i
].
ev’ts
 & 
EPOLLIN
)

892 if((
fdp
 = 
fd_¬¿y
[
fd
]è=ğ
NULL
)

894 
fdp
->
»ad
.
	`cb
(
fd
, fdp->»ad.
·¿m
);

897 if(
•_ev’ts
[
i
].
ev’ts
 & 
EPOLLOUT
)

899 if((
fdp
 = 
fd_¬¿y
[
fd
]è=ğ
NULL
)

901 
fdp
->
wr™e
.
	`cb
(
fd
, fdp->wr™e.
·¿m
);

906 
	}
}

909 
	$fd_addr_cmp
(
ty³
, *
a
, *
b
)

911 
	`as£¹
(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
 ||y³ =ğ
SCAMPER_FD_TYPE_TCP6
 ||

912 
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
 ||y³ =ğ
SCAMPER_FD_TYPE_UDP6
 ||

913 
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4DG
 ||

914 
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
 ||y³ =ğ
SCAMPER_FD_TYPE_ICMP6
);

916 if(
a
 =ğ
NULL
 && 
b
 != NULL)  -1;

917 if(
a
 !ğ
NULL
 && 
b
 == NULL)  1;

918 if(
a
 =ğ
NULL
 && 
b
 == NULL)  0;

920 if(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
 ||

921 
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
 ||

922 
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4DG
 ||

923 
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
)

924  
	`addr4_cmp
(
a
, 
b
);

926  
	`addr6_cmp
(
a
, 
b
);

927 
	}
}

936 
	$fd_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

938 cÚ¡ 
sÿm³r_fd_t
 *
a
 = (cÚ¡ sÿm³r_fd_ˆ*)
va
;

939 cÚ¡ 
sÿm³r_fd_t
 *
b
 = (cÚ¡ sÿm³r_fd_ˆ*)
vb
;

941 if(
a
->
ty³
 < 
b
->type)  -1;

942 if(
a
->
ty³
 > 
b
->type)  1;

944 
a
->
ty³
)

946 
SCAMPER_FD_TYPE_TCP4
:

947 
SCAMPER_FD_TYPE_TCP6
:

948 if(
a
->
fd_tı_¥Üt
 < 
b
->fd_tcp_sport)  -1;

949 if(
a
->
fd_tı_¥Üt
 > 
b
->fd_tcp_sport)  1;

950  
	`fd_addr_cmp
(
a
->
ty³
,‡->
fd_tı_addr
, 
b
->fd_tcp_addr);

952 
SCAMPER_FD_TYPE_UDP4
:

953  
	`fd_addr_cmp
(
a
->
ty³
,‡->
fd_udp_addr
, 
b
->fd_udp_addr);

955 
SCAMPER_FD_TYPE_UDP4DG
:

956 
SCAMPER_FD_TYPE_UDP6
:

957 if(
a
->
fd_udp_¥Üt
 < 
b
->fd_udp_sport)  -1;

958 if(
a
->
fd_udp_¥Üt
 > 
b
->fd_udp_sport)  1;

959  
	`fd_addr_cmp
(
a
->
ty³
,‡->
fd_udp_addr
, 
b
->fd_udp_addr);

961 
SCAMPER_FD_TYPE_DL
:

962 if(
a
->
fd_dl_ifšdex
 < 
b
->fd_dl_ifindex)  -1;

963 if(
a
->
fd_dl_ifšdex
 > 
b
->fd_dl_ifindex)  1;

966 
SCAMPER_FD_TYPE_ICMP4
:

967 
SCAMPER_FD_TYPE_ICMP6
:

968  
	`fd_addr_cmp
(
a
->
ty³
,‡->
fd_icmp_addr
, 
b
->fd_icmp_addr);

972 
	}
}

979 #iâdeà
DMALLOC


980 
sÿm³r_fd_t
 *
	$fd_®loc
(
ty³
, 
fd
)

982 
	#fd_®loc
(
ty³
, 
fd
è
	`fd_®loc_dm
(Ñy³), (fd), 
__FILE__
, 
__LINE__
)

	)

983 
sÿm³r_fd_t
 *
	$fd_®loc_dm
(
ty³
, 
fd
, cÚ¡ *
fe
,

984 cÚ¡ 
lše
)

987 
sÿm³r_fd_t
 *
fdn
 = 
NULL
;

988 
size_t
 
size
;

989 
i
;

991 #iâdeà
DMALLOC


992 if((
fdn
 = 
	`m®loc_z”o
((
sÿm³r_fd_t
))è=ğ
NULL
)

994 if((
fdn
 = 
	`m®loc_z”o_dm
((
sÿm³r_fd_t
), 
fe
, 
lše
)è=ğ
NULL
)

997 
”r
;

999 
fdn
->
ty³
 =ype;

1000 
fdn
->
fd
 = fd;

1001 
fdn
->
»fút
 = 1;

1004 if((
fdn
->
»ad
.
node
 = 
	`dli¡_node_®loc
(&fdn->»ad)è=ğ
NULL
)

1006 
”r
;

1008 
fdn
->
»ad
.fdn = fdn;

1009 
fdn
->
»ad
.
æags
 = 
SCAMPER_FD_POLL_FLAG_INACTIVE
;

1012 if((
fdn
->
wr™e
.
node
 = 
	`dli¡_node_®loc
(&fdn->wr™e)è=ğ
NULL
)

1014 
”r
;

1016 
fdn
->
wr™e
.fdn = fdn;

1017 
fdn
->
wr™e
.
æags
 = 
SCAMPER_FD_POLL_FLAG_INACTIVE
;

1020 if(
fd
+1 > 
fd_¬¿y_s
)

1022 
size
 = (
sÿm³r_fd_t
 *è* (
fd
+1);

1023 if(
	`»®loc_w¿p
((**)&
fd_¬¿y
, 
size
) != 0)

1024 
”r
;

1025 
i
=
fd_¬¿y_s
; i<
fd
+1; i++)

1026 
fd_¬¿y
[
i
] = 
NULL
;

1027 
fd_¬¿y_s
 = 
fd
+1;

1029 
fd_¬¿y
[
fd
] = 
fdn
;

1031  
fdn
;

1033 
”r
:

1034 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1035  
NULL
;

1036 
	}
}

1044 
sÿm³r_fd_t
 *
	$fd_fšd
(
sÿm³r_fd_t
 *
fšdme
)

1046 
sÿm³r_fd_t
 *
fdn
;

1048 if((
fdn
 = 
	`¥ÏyŒ“_fšd
(
fd_Œ“
, 
fšdme
)è!ğ
NULL
)

1050 if(
fdn
->
»fút
 =ğ0 && fdn->
rc0
 !ğ
NULL
)

1052 
	`dli¡_node_pİ
(
»fút_0
, 
fdn
->
rc0
);

1053 
fdn
->
rc0
 = 
NULL
;

1056 
fdn
->
»fút
++;

1059  
fdn
;

1060 
	}
}

1067 #iâdeà
_WIN32


1068 
sÿm³r_fd_t
 *
	$fd_nuÎ
(
ty³
)

1070 
sÿm³r_fd_t
 *
fdn
 = 
NULL
, 
fšdme
;

1071 
fd
 = -1;

1074 
fšdme
.
ty³
 =ype;

1075 if((
fdn
 = 
	`fd_fšd
(&
fšdme
)è!ğ
NULL
)

1077  
fdn
;

1080 if(
ty³
 =ğ
SCAMPER_FD_TYPE_RTSOCK
è
fd
 = 
	`sÿm³r_¹sock_İ’
();

1081 if(
ty³
 =ğ
SCAMPER_FD_TYPE_IFSOCK
è
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

1082 if(
ty³
 =ğ
SCAMPER_FD_TYPE_IP4
è
fd
 = 
	`sÿm³r_4_İ’¿w
();

1084 if(
fd
 =ğ-1 || (
fdn
 = 
	`fd_®loc
(
ty³
, fd)è=ğ
NULL
 ||

1085 (
fdn
->
fd_Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
fd_Œ“
, fdn)è=ğ
NULL
 ||

1086 (
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
)

1088 
”r
;

1091  
fdn
;

1093 
”r
:

1094 if(
fd
 != -1)

1096 if(
ty³
 =ğ
SCAMPER_FD_TYPE_RTSOCK
)

1097 
	`sÿm³r_¹sock_şo£
(
fd
);

1098 if(
ty³
 =ğ
SCAMPER_FD_TYPE_IFSOCK
)

1099 
	`şo£
(
fd
);

1100 if(
ty³
 =ğ
SCAMPER_FD_TYPE_IP4
)

1101 
	`sÿm³r_4_şo£
(
fd
);

1103 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1104  
NULL
;

1105 
	}
}

1108 
sÿm³r_fd_t
 *
	$fd_icmp
(
ty³
, *
addr
)

1110 
sÿm³r_fd_t
 *
fdn
 = 
NULL
, 
fšdme
;

1111 
size_t
 
Ën
 = 0;

1112 
fd
 = -1;

1114 
fšdme
.
ty³
 =ype;

1115 
fšdme
.
fd_icmp_addr
 = 
addr
;

1117 if((
fdn
 = 
	`fd_fšd
(&
fšdme
)è!ğ
NULL
)

1119  
fdn
;

1122 if(
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
)

1124 
fd
 = 
	`sÿm³r_icmp4_İ’
(
addr
);

1125 
Ën
 = (
š_addr
);

1127 if(
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP6
)

1129 
fd
 = 
	`sÿm³r_icmp6_İ’
(
addr
);

1130 
Ën
 = (
š6_addr
);

1133 if(
fd
 =ğ-1 || (
fdn
 = 
	`fd_®loc
(
ty³
, fd)è=ğ
NULL
 ||

1134 (
addr
 !ğ
NULL
 && (
fdn
->
fd_icmp_addr
 = 
	`memdup
×ddr, 
Ën
)) == NULL) ||

1135 (
fdn
->
fd_Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
fd_Œ“
, fdn)è=ğ
NULL
 ||

1136 (
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
)

1138 
”r
;

1141  
fdn
;

1143 
”r
:

1144 if(
fd
 != -1)

1146 if(
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP4
)

1147 
	`sÿm³r_icmp4_şo£
(
fd
);

1148 if(
ty³
 =ğ
SCAMPER_FD_TYPE_ICMP6
)

1149 
	`sÿm³r_icmp6_şo£
(
fd
);

1151 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1152  
NULL
;

1153 
	}
}

1155 
sÿm³r_fd_t
 *
	$fd_tı
(
ty³
, *
addr
, 
ušt16_t
 
¥Üt
)

1157 
sÿm³r_fd_t
 *
fdn
, 
fšdme
;

1158 
size_t
 
Ën
 = 0;

1159 
fd
 = -1;

1161 
fšdme
.
ty³
 =ype;

1162 
fšdme
.
fd_tı_addr
 = 
addr
;

1163 
fšdme
.
fd_tı_¥Üt
 = 
¥Üt
;

1165 if((
fdn
 = 
	`fd_fšd
(&
fšdme
)è!ğ
NULL
)

1167  
fdn
;

1170 if(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
)

1172 
fd
 = 
	`sÿm³r_tı4_İ’
(
addr
, 
¥Üt
);

1173 
Ën
 = (
š_addr
);

1175 if(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP6
)

1177 
fd
 = 
	`sÿm³r_tı6_İ’
(
addr
, 
¥Üt
);

1178 
Ën
 = (
š6_addr
);

1181 if(
fd
 =ğ-1 || (
fdn
 = 
	`fd_®loc
(
ty³
, fd)è=ğ
NULL
 ||

1182 (
addr
 !ğ
NULL
 && (
fdn
->
fd_tı_addr
 = 
	`memdup
×ddr, 
Ën
)) == NULL))

1184 
”r
;

1186 
fdn
->
fd_tı_¥Üt
 = 
¥Üt
;

1188 if((
fdn
->
fd_Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
fd_Œ“
, fdn)è=ğ
NULL
 ||

1189 (
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
)

1191 
”r
;

1194  
fdn
;

1196 
”r
:

1197 if(
fd
 != -1)

1199 if(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP4
)

1200 
	`sÿm³r_tı4_şo£
(
fd
);

1201 if(
ty³
 =ğ
SCAMPER_FD_TYPE_TCP6
)

1202 
	`sÿm³r_tı6_şo£
(
fd
);

1204 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1205  
NULL
;

1206 
	}
}

1208 
sÿm³r_fd_t
 *
	$fd_udp
(
ty³
, *
addr
, 
ušt16_t
 
¥Üt
)

1210 
sÿm³r_fd_t
 *
fdn
, 
fšdme
;

1211 
size_t
 
Ën
 = 0;

1212 
fd
 = -1;

1214 
fšdme
.
ty³
 =ype;

1215 
fšdme
.
fd_udp_addr
 = 
addr
;

1216 
fšdme
.
fd_udp_¥Üt
 = 
¥Üt
;

1218 if((
fdn
 = 
	`fd_fšd
(&
fšdme
)è!ğ
NULL
)

1219  
fdn
;

1221 if(
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
)

1223 
fd
 = 
	`sÿm³r_udp4_İ’¿w
(
addr
);

1224 
Ën
 = (
š_addr
);

1226 if(
ty³
 =ğ
SCAMPER_FD_TYPE_UDP6
)

1228 
fd
 = 
	`sÿm³r_udp6_İ’
(
addr
, 
¥Üt
);

1229 
Ën
 = (
š6_addr
);

1231 if(
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4DG
)

1233 
fd
 = 
	`sÿm³r_udp4_İ’dg¿m
(
addr
, 
¥Üt
);

1234 
Ën
 = (
š_addr
);

1237 if(
fd
 =ğ-1 || (
fdn
 = 
	`fd_®loc
(
ty³
, fd)è=ğ
NULL
 ||

1238 (
addr
 !ğ
NULL
 && (
fdn
->
fd_udp_addr
 = 
	`memdup
×ddr, 
Ën
)) == NULL))

1240 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

1241 
”r
;

1243 
fdn
->
fd_udp_¥Üt
 = 
¥Üt
;

1245 if((
fdn
->
fd_Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
fd_Œ“
, fdn)è=ğ
NULL
)

1247 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd socketoree");

1248 
”r
;

1250 if((
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
)

1252 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd socketo†ist");

1253 
”r
;

1256  
fdn
;

1258 
”r
:

1259 if(
fd
 != -1)

1261 if(
ty³
 =ğ
SCAMPER_FD_TYPE_UDP4
 ||y³ =ğ
SCAMPER_FD_TYPE_UDP4DG
)

1262 
	`sÿm³r_udp4_şo£
(
fd
);

1263 if(
ty³
 =ğ
SCAMPER_FD_TYPE_UDP6
)

1264 
	`sÿm³r_udp6_şo£
(
fd
);

1266 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1267  
NULL
;

1268 
	}
}

1277 
	$sÿm³r_fds_pŞl
(
timev®
 *
timeout
)

1279 
sÿm³r_fd_t
 *
fdn
;

1280 
timev®
 
tv
;

1286 if(
	`dli¡_couÁ
(
»fút_0
) > 0)

1288 
	`g‘timeofday_w¿p
(&
tv
);

1290 (
fdn
 = (
sÿm³r_fd_t
 *)
	`dli¡_h—d_g‘
(
»fút_0
)è!ğ
NULL
)

1292 
	`as£¹
(
fdn
->
»fút
 == 0);

1294 if(
	`timev®_cmp
(&
fdn
->
tv
, &tv) > 0)

1297 
	`fd_şo£
(
fdn
);

1298 
	`fd_ä“
(
fdn
);

1301 if(
fdn
 !ğ
NULL
)

1303 
	`timev®_diff_tv
(&
tv
, &tv, &
fdn
->tv);

1304 if(
timeout
 =ğ
NULL
 || 
	`timev®_cmp
(&
tv
,imeout) < 0)

1305 
timeout
 = &
tv
;

1309  
	`pŞlfunc
(
timeout
);

1310 
	}
}

1317 
	$sÿm³r_fd_fd_g‘
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
)

1319 if(
fdn
->
¶
 =ğ
NULL
)

1320  
fdn
->
fd
;

1321  
fdn
->
¶
->
fd
;

1322 
	}
}

1329 
	$sÿm³r_fd_fd_£t
(
sÿm³r_fd_t
 *
fdn
, 
fd
)

1331 
fdn
->
fd
 = fd;

1333 
	}
}

1340 
	$sÿm³r_fd_»ad_·u£
(
sÿm³r_fd_t
 *
fdn
)

1342 #ifdeà
HAVE_KQUEUE


1343 if(
kq
 !ğ-1 && (
fdn
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

1344 
	`fds_kqueue_£t
(
fdn
, 
EVFILT_READ
, 
EV_DELETE
);

1347 #ifdeà
HAVE_EPOLL


1348 if(
•
 !ğ-1 && (
fdn
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

1349 
	`fds_•Şl_ùl
(
fdn
, 
EPOLLIN
, 
EPOLL_CTL_DEL
);

1352 
fdn
->
»ad
.
æags
 |ğ
SCAMPER_FD_POLL_FLAG_INACTIVE
;

1354 
	}
}

1362 
	$sÿm³r_fd_»ad_uÅau£
(
sÿm³r_fd_t
 *
fdn
)

1364 
	`as£¹
(
fdn
->
»ad
.
cb
 !ğ
NULL
);

1366 if((
fdn
->
»ad
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) != 0)

1368 
fdn
->
»ad
.
æags
 &ğ~(
SCAMPER_FD_POLL_FLAG_INACTIVE
);

1370 #ifdeà
HAVE_KQUEUE


1371 if(
kq
 != -1)

1372 
	`fds_kqueue_£t
(
fdn
, 
EVFILT_READ
, 
EV_ADD
);

1375 #ifdeà
HAVE_EPOLL


1376 if(
•
 != -1)

1377 
	`fds_•Şl_ùl
(
fdn
, 
EPOLLIN
, 
EPOLL_CTL_ADD
);

1384 if(
fdn
->
»ad
.
li¡
 !ğ
»ad_fds
)

1386 
	`dli¡_node_h—d_push
(
»ad_queue
, 
fdn
->
»ad
.
node
);

1387 
fdn
->
»ad
.
li¡
 = 
»ad_queue
;

1392 
	}
}

1399 
	$sÿm³r_fd_wr™e_·u£
(
sÿm³r_fd_t
 *
fdn
)

1401 #ifdeà
HAVE_KQUEUE


1402 if(
kq
 !ğ-1 && (
fdn
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

1403 
	`fds_kqueue_£t
(
fdn
, 
EVFILT_WRITE
, 
EV_DELETE
);

1406 #ifdeà
HAVE_EPOLL


1407 if(
•
 !ğ-1 && (
fdn
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) == 0)

1408 
	`fds_•Şl_ùl
(
fdn
, 
EPOLLOUT
, 
EPOLL_CTL_DEL
);

1411 
fdn
->
wr™e
.
æags
 |ğ
SCAMPER_FD_POLL_FLAG_INACTIVE
;

1413 
	}
}

1421 
	$sÿm³r_fd_wr™e_uÅau£
(
sÿm³r_fd_t
 *
fdn
)

1423 
	`as£¹
(
fdn
->
wr™e
.
cb
 !ğ
NULL
);

1425 if((
fdn
->
wr™e
.
æags
 & 
SCAMPER_FD_POLL_FLAG_INACTIVE
) != 0)

1427 
fdn
->
wr™e
.
æags
 &ğ~(
SCAMPER_FD_POLL_FLAG_INACTIVE
);

1429 #ifdeà
HAVE_KQUEUE


1430 if(
kq
 != -1)

1431 
	`fds_kqueue_£t
(
fdn
, 
EVFILT_WRITE
, 
EV_ADD
);

1434 #ifdeà
HAVE_EPOLL


1435 if(
•
 != -1)

1436 
	`fds_•Şl_ùl
(
fdn
, 
EPOLLOUT
, 
EPOLL_CTL_ADD
);

1443 if(
fdn
->
wr™e
.
li¡
 !ğ
wr™e_fds
)

1445 
	`dli¡_node_h—d_push
(
wr™e_queue
, 
fdn
->
wr™e
.
node
);

1446 
fdn
->
wr™e
.
li¡
 = 
wr™e_queue
;

1451 
	}
}

1453 
	$sÿm³r_fd_»ad_£t
(
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_fd_cb_t
 
cb
, *
·¿m
)

1455 
	`as£¹
(
fdn
->
ty³
 =ğ
SCAMPER_FD_TYPE_PRIVATE
);

1456 
fdn
->
»ad
.
cb
 = cb;

1457 
fdn
->
»ad
.
·¿m
 =…aram;

1459 
	}
}

1461 
	$sÿm³r_fd_wr™e_£t
(
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_fd_cb_t
 
cb
, *
·¿m
)

1463 
	`as£¹
(
fdn
->
ty³
 =ğ
SCAMPER_FD_TYPE_PRIVATE
);

1464 
fdn
->
wr™e
.
cb
 = cb;

1465 
fdn
->
wr™e
.
·¿m
 =…aram;

1467 
	}
}

1469 
sÿm³r_fd_t
 *
	$sÿm³r_fd_icmp4
(*
addr
)

1471 
sÿm³r_fd_t
 *
fdn
;

1473 if((
fdn
 = 
	`fd_icmp
(
SCAMPER_FD_TYPE_ICMP4
, 
addr
)è!ğ
NULL
)

1475 
fdn
->
»ad
.
cb
 = 
sÿm³r_icmp4_»ad_cb
;

1476 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1479  
fdn
;

1480 
	}
}

1482 
sÿm³r_fd_t
 *
	$sÿm³r_fd_icmp6
(*
addr
)

1484 
sÿm³r_fd_t
 *
fdn
;

1486 if((
fdn
 = 
	`fd_icmp
(
SCAMPER_FD_TYPE_ICMP6
, 
addr
)è!ğ
NULL
)

1488 
fdn
->
»ad
.
cb
 = 
sÿm³r_icmp6_»ad_cb
;

1489 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1492  
fdn
;

1493 
	}
}

1495 #iâdeà
_WIN32


1496 
sÿm³r_fd_t
 *
	$sÿm³r_fd_¹sock
()

1498 
sÿm³r_fd_t
 *
fdn
;

1500 if((
fdn
 = 
	`fd_nuÎ
(
SCAMPER_FD_TYPE_RTSOCK
)è!ğ
NULL
)

1502 
fdn
->
»ad
.
cb
 = 
sÿm³r_¹sock_»ad_cb
;

1503 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1506  
fdn
;

1507 
	}
}

1510 
sÿm³r_fd_t
 *
	$sÿm³r_fd_tı4
(*
addr
, 
ušt16_t
 
¥Üt
)

1512  
	`fd_tı
(
SCAMPER_FD_TYPE_TCP4
, 
addr
, 
¥Üt
);

1513 
	}
}

1515 
sÿm³r_fd_t
 *
	$sÿm³r_fd_tı6
(*
addr
, 
ušt16_t
 
¥Üt
)

1517  
	`fd_tı
(
SCAMPER_FD_TYPE_TCP6
, 
addr
, 
¥Üt
);

1518 
	}
}

1520 
sÿm³r_fd_t
 *
	$sÿm³r_fd_udp4
(*
addr
, 
ušt16_t
 
¥Üt
)

1522 
sÿm³r_fd_t
 *
fd
;

1524 if(
¶ª‘Ïb
 == 0)

1525  
	`fd_udp
(
SCAMPER_FD_TYPE_UDP4
, 
addr
, 
¥Üt
);

1527 if((
fd
 = 
	`fd_udp
(
SCAMPER_FD_TYPE_UDP4DG
, 
addr
, 
¥Üt
)è=ğ
NULL
)

1528  
NULL
;

1530 if(
fd
->
¶
 =ğ
NULL
)

1532 if((
fd
->
¶
 = 
	`fd_udp
(
SCAMPER_FD_TYPE_UDP4
, 
addr
, 
¥Üt
)è=ğ
NULL
)

1534 
	`sÿm³r_fd_ä“
(
fd
);

1535  
NULL
;

1538  
fd
;

1539 
	}
}

1541 
sÿm³r_fd_t
 *
	$sÿm³r_fd_udp6
(*
addr
, 
ušt16_t
 
¥Üt
)

1543  
	`fd_udp
(
SCAMPER_FD_TYPE_UDP6
, 
addr
, 
¥Üt
);

1544 
	}
}

1546 
sÿm³r_fd_t
 *
	$sÿm³r_fd_4
()

1548  
	`fd_nuÎ
(
SCAMPER_FD_TYPE_IP4
);

1549 
	}
}

1551 #iâdeà
_WIN32


1552 
sÿm³r_fd_t
 *
	$sÿm³r_fd_ifsock
()

1554  
	`fd_nuÎ
(
SCAMPER_FD_TYPE_IFSOCK
);

1555 
	}
}

1558 
sÿm³r_fd_t
 *
	$sÿm³r_fd_dl
(
ifšdex
)

1560 
sÿm³r_fd_t
 *
fdn
 = 
NULL
, 
fšdme
;

1561 
fd
 = -1;

1563 
fšdme
.
ty³
 = 
SCAMPER_FD_TYPE_DL
;

1564 
fšdme
.
fd_dl_ifšdex
 = 
ifšdex
;

1566 if((
fdn
 = 
	`fd_fšd
(&
fšdme
)è!ğ
NULL
)

1568 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1569  
fdn
;

1576 if((
fd
 = 
	`sÿm³r_dl_İ’
(
ifšdex
)) == -1 ||

1577 (
fdn
 = 
	`fd_®loc
(
SCAMPER_FD_TYPE_DL
, 
fd
)è=ğ
NULL
)

1579 
”r
;

1586 
fdn
->
fd_dl_ifšdex
 = 
ifšdex
;

1592 if((
fdn
->
fd_Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
fd_Œ“
, fdn)è=ğ
NULL
 ||

1593 (
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
 ||

1594 (
fdn
->
fd_dl_dl
 = 
	`sÿm³r_dl_¡©e_®loc
(fdn)è=ğ
NULL
)

1596 
”r
;

1600 
fdn
->
»ad
.
cb
 = 
sÿm³r_dl_»ad_cb
;

1601 
fdn
->
»ad
.
·¿m
 = fdn->
fd_dl_dl
;

1602 
fdn
->
wr™e
.
cb
 = 
NULL
;

1603 
fdn
->
wr™e
.
·¿m
 = 
NULL
;

1604 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1606  
fdn
;

1608 
”r
:

1609 if(
fdn
 !ğ
NULL
è
	`ä“
(fdn);

1610 if(
fd
 !ğ-1è
	`sÿm³r_dl_şo£
(fd);

1611  
NULL
;

1612 
	}
}

1620 
sÿm³r_fd_t
 *
	$sÿm³r_fd_´iv©e
(
fd
,

1621 
sÿm³r_fd_cb_t
 
»ad_cb
, *
»ad_·¿m
,

1622 
sÿm³r_fd_cb_t
 
wr™e_cb
, *
wr™e_·¿m
)

1624 
sÿm³r_fd_t
 *
fdn
 = 
NULL
;

1626 if((
fdn
 = 
	`fd_®loc
(
SCAMPER_FD_TYPE_PRIVATE
, 
fd
)è=ğ
NULL
)

1628 
”r
;

1631 if((
fdn
->
fd_li¡_node
 = 
	`dli¡__push
(
fd_li¡
, fdn)è=ğ
NULL
)

1632 
”r
;

1634 if(
»ad_cb
 !ğ
NULL
)

1636 
	`sÿm³r_fd_»ad_£t
(
fdn
, 
»ad_cb
, 
»ad_·¿m
);

1637 
	`sÿm³r_fd_»ad_uÅau£
(
fdn
);

1640 if(
wr™e_cb
 !ğ
NULL
)

1642 
	`sÿm³r_fd_wr™e_£t
(
fdn
, 
wr™e_cb
, 
wr™e_·¿m
);

1643 
	`sÿm³r_fd_wr™e_uÅau£
(
fdn
);

1646  
fdn
;

1648 
”r
:

1649 if(
fdn
 !ğ
NULL
è
	`fd_ä“
(fdn);

1650  
NULL
;

1651 
	}
}

1659 
	$sÿm³r_fd_ifšdex
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, *
ifšdex
)

1661 if(
fdn
->
ty³
 =ğ
SCAMPER_FD_TYPE_DL
)

1663 *
ifšdex
 = 
fdn
->
fd_dl_ifšdex
;

1668 
	}
}

1670 
sÿm³r_dl_t
 *
	$sÿm³r_fd_dl_g‘
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
)

1672 
	`as£¹
(
fdn
 !ğ
NULL
);

1673 
	`as£¹
(
fdn
->
ty³
 =ğ
SCAMPER_FD_TYPE_DL
);

1674  
fdn
->
fd_dl_dl
;

1675 
	}
}

1683 
	$sÿm³r_fd_addr
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, *
addr
, 
size_t
 
Ën
)

1685 *
a
;

1686 
size_t
 
l
;

1688 
fdn
->
ty³
)

1690 
SCAMPER_FD_TYPE_UDP4
: 
a
 = 
fdn
->
fd_udp_addr
; 
l
 = 4; ;

1691 
SCAMPER_FD_TYPE_UDP4DG
: 
a
 = 
fdn
->
fd_udp_addr
; 
l
 = 4; ;

1692 
SCAMPER_FD_TYPE_UDP6
: 
a
 = 
fdn
->
fd_udp_addr
; 
l
 = 16; ;

1693 
SCAMPER_FD_TYPE_TCP4
: 
a
 = 
fdn
->
fd_tı_addr
; 
l
 = 4; ;

1694 
SCAMPER_FD_TYPE_TCP6
: 
a
 = 
fdn
->
fd_tı_addr
; 
l
 = 16; ;

1695 
SCAMPER_FD_TYPE_ICMP4
: 
a
 = 
fdn
->
fd_icmp_addr
; 
l
 = 4; ;

1696 
SCAMPER_FD_TYPE_ICMP6
: 
a
 = 
fdn
->
fd_icmp_addr
; 
l
 = 16; ;

1700 if(
Ën
 < 
l
)

1702 if(
a
 =ğ
NULL
)

1704 
	`memıy
(
addr
, 
a
, 
l
);

1706 
	}
}

1713 
	$sÿm³r_fd_¥Üt
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, 
ušt16_t
 *
¥Üt
)

1715 if(
	`SCAMPER_FD_TYPE_IS_UDP
(
fdn
))

1717 *
¥Üt
 = 
fdn
->
fd_udp_¥Üt
;

1720 if(
	`SCAMPER_FD_TYPE_IS_TCP
(
fdn
))

1722 *
¥Üt
 = 
fdn
->
fd_tı_¥Üt
;

1726 
	}
}

1739 
	$sÿm³r_fd_ä“
(
sÿm³r_fd_t
 *
fdn
)

1741 
	`as£¹
(
fdn
 !ğ
NULL
);

1742 
	`as£¹
(
fdn
->
»fút
 > 0);

1744 if(--
fdn
->
»fút
 == 0)

1746 if(
fdn
->
¶
 !ğ
NULL
)

1748 
	`sÿm³r_fd_ä“
(
fdn
->
¶
);

1749 
fdn
->
¶
 = 
NULL
;

1751 
	`fd_»fút_0
(
fdn
);

1755 
	}
}

1762 
dli¡_t
 *
	$®loc_li¡
(*
Çme
)

1764 
dli¡_t
 *
li¡
;

1765 if((
li¡
 = 
	`dli¡_®loc
()è=ğ
NULL
)

1766 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "®loø% çed", 
Çme
);

1767  
li¡
;

1768 
	}
}

1776 
	$sÿm³r_fds_š™
()

1778 #ifdeà
HAVE_GETDTABLESIZE


1779 
	`sÿm³r_debug
(
__func__
, "fdabË size: %d", 
	`g‘dbËsize
());

1782 #ifdeà
HAVE_POLL


1783 
pŞlfunc
 = 
fds_pŞl
;

1786 #ifdeà
HAVE_KQUEUE


1787 if(
	`sÿm³r_İtiÚ_kqueue
())

1789 
pŞlfunc
 = 
fds_kqueue
;

1790 if(
	`fds_kqueue_š™
() != 0)

1795 #ifdeà
HAVE_EPOLL


1796 if(
	`sÿm³r_İtiÚ_•Şl
())

1798 
pŞlfunc
 = 
fds_•Şl
;

1799 if(
	`fds_•Şl_š™
() != 0)

1804 if(
	`sÿm³r_İtiÚ_£Ëù
(è|| 
pŞlfunc
 =ğ
NULL
)

1805 
pŞlfunc
 = 
fds_£Ëù
;

1807 if((
fd_li¡
 = 
	`®loc_li¡
("fd_li¡")è=ğ
NULL
 ||

1808 (
»ad_fds
 = 
	`®loc_li¡
("»ad_fds")è=ğ
NULL
 ||

1809 (
»ad_queue
 = 
	`®loc_li¡
("»ad_queue")è=ğ
NULL
 ||

1810 (
wr™e_fds
 = 
	`®loc_li¡
("wr™e_fds")è=ğ
NULL
 ||

1811 (
wr™e_queue
 = 
	`®loc_li¡
("wr™e_queue")è=ğ
NULL
 ||

1812 (
»fút_0
 = 
	`®loc_li¡
("»fút_0")è=ğ
NULL
)

1817 if((
fd_Œ“
 = 
	`¥ÏyŒ“_®loc
(
fd_cmp
)è=ğ
NULL
)

1819 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "alloc fdree failed");

1823 
¶ª‘Ïb
 = 
	`sÿm³r_İtiÚ_¶ª‘Ïb
();

1825 
	}
}

1832 
	$ş—nup_li¡
(
dli¡_t
 *
li¡
)

1834 
sÿm³r_fd_pŞl_t
 *
pŞl
;

1836 if(
li¡
 =ğ
NULL
) ;

1838 (
pŞl
 = 
	`dli¡_h—d_pİ
(
li¡
)è!ğ
NULL
)

1840 
pŞl
->
li¡
 = 
NULL
;

1841 
pŞl
->
node
 = 
NULL
;

1844 
	`dli¡_ä“
(
li¡
);

1847 
	}
}

1854 
	$sÿm³r_fds_ş—nup
()

1856 
sÿm³r_fd_t
 *
fdn
;

1859 
	`ş—nup_li¡
(
»ad_fds
);„—d_fd ğ
NULL
;

1860 
	`ş—nup_li¡
(
wr™e_fds
); wr™e_fd ğ
NULL
;

1861 
	`ş—nup_li¡
(
»ad_queue
);„—d_queuğ
NULL
;

1862 
	`ş—nup_li¡
(
wr™e_queue
); wr™e_queuğ
NULL
;

1865 if(
»fút_0
 !ğ
NULL
)

1867 (
fdn
 = (
sÿm³r_fd_t
 *)
	`dli¡_h—d_g‘
(
»fút_0
)è!ğ
NULL
)

1869 
	`fd_şo£
(
fdn
);

1870 
	`fd_ä“
(
fdn
);

1872 
	`dli¡_ä“
(
»fút_0
);

1873 
»fút_0
 = 
NULL
;

1877 if(
fd_Œ“
 !ğ
NULL
)

1879 
	`¥ÏyŒ“_ä“
(
fd_Œ“
, 
NULL
);

1880 
fd_Œ“
 = 
NULL
;

1884 if(
fd_li¡
 !ğ
NULL
)

1886 
	`dli¡_ä“
(
fd_li¡
);

1887 
fd_li¡
 = 
NULL
;

1891 if(
fd_¬¿y
 !ğ
NULL
)

1893 
	`ä“
(
fd_¬¿y
);

1894 
fd_¬¿y
 = 
NULL
;

1897 #ifdeà
HAVE_POLL


1898 if(
pŞl_fds
 !ğ
NULL
)

1900 
	`ä“
(
pŞl_fds
);

1901 
pŞl_fds
 = 
NULL
;

1905 #ifdeà
HAVE_KQUEUE


1906 if(
kq
 != -1)

1908 
	`şo£
(
kq
);

1909 
kq
 = -1;

1911 if(
kevli¡
 !ğ
NULL
)

1913 
	`ä“
(
kevli¡
);

1914 
kevli¡
 = 
NULL
;

1918 #ifdeà
HAVE_EPOLL


1919 if(
•
 != -1)

1921 
	`şo£
(
•
);

1922 
•
 = -1;

1924 if(
•_ev’ts
 !ğ
NULL
)

1926 
	`ä“
(
•_ev’ts
);

1927 
•_ev’ts
 = 
NULL
;

1932 
	}
}

	@scamper_fds.h

32 #iâdeà
__SCAMPER_FD_H


33 
	#__SCAMPER_FD_H


	)

36 
sÿm³r_fd
 
	tsÿm³r_fd_t
;

39 (*
	tsÿm³r_fd_cb_t
)(cÚ¡ 
	tfd
, *
	t·¿m
);

42 
sÿm³r_fd_t
 *
	`sÿm³r_fd_icmp4
(*
addr
);

43 
sÿm³r_fd_t
 *
	`sÿm³r_fd_icmp6
(*
addr
);

44 
sÿm³r_fd_t
 *
	`sÿm³r_fd_udp4
(*
addr
, 
ušt16_t
 
¥Üt
);

45 
sÿm³r_fd_t
 *
	`sÿm³r_fd_udp6
(*
addr
, 
ušt16_t
 
¥Üt
);

46 
sÿm³r_fd_t
 *
	`sÿm³r_fd_tı4
(*
addr
, 
ušt16_t
 
¥Üt
);

47 
sÿm³r_fd_t
 *
	`sÿm³r_fd_tı6
(*
addr
, 
ušt16_t
 
¥Üt
);

48 
sÿm³r_fd_t
 *
	`sÿm³r_fd_dl
(
ifšdex
);

49 
sÿm³r_fd_t
 *
	`sÿm³r_fd_4
();

51 #iâdeà
_WIN32


52 
sÿm³r_fd_t
 *
	`sÿm³r_fd_¹sock
();

53 
sÿm³r_fd_t
 *
	`sÿm³r_fd_ifsock
();

57 
	`sÿm³r_fd_ifšdex
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, *
ifšdex
);

58 
	`sÿm³r_fd_¥Üt
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, 
ušt16_t
 *
¥Üt
);

59 
	`sÿm³r_fd_addr
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
, *
addr
, 
size_t
 
Ën
);

62 
sÿm³r_fd_t
 *
	`sÿm³r_fd_´iv©e
(
fd
,

63 
sÿm³r_fd_cb_t
 
»ad_cb
, *
»ad_·¿m
,

64 
sÿm³r_fd_cb_t
 
wr™e_cb
, *
wr™e_·¿m
);

70 
	`sÿm³r_fd_ä“
(
sÿm³r_fd_t
 *
fdn
);

73 
	`sÿm³r_fd_fd_g‘
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
);

74 
	`sÿm³r_fd_fd_£t
(
sÿm³r_fd_t
 *
fdn
, 
fd
);

77 
	`sÿm³r_fd_»ad_·u£
(
sÿm³r_fd_t
 *
fdn
);

78 
	`sÿm³r_fd_»ad_uÅau£
(
sÿm³r_fd_t
 *
fdn
);

79 
	`sÿm³r_fd_wr™e_·u£
(
sÿm³r_fd_t
 *
fdn
);

80 
	`sÿm³r_fd_wr™e_uÅau£
(
sÿm³r_fd_t
 *
fdn
);

83 
	`sÿm³r_fd_»ad_£t
(
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_fd_cb_t
 
cb
, *
·¿m
);

84 
	`sÿm³r_fd_wr™e_£t
(
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_fd_cb_t
 
cb
, *
·¿m
);

86 #ifdeà
__SCAMPER_DL_H


87 
sÿm³r_dl_t
 *
	`sÿm³r_fd_dl_g‘
(cÚ¡ 
sÿm³r_fd_t
 *
fdn
);

91 
	`sÿm³r_fds_pŞl
(
timev®
 *
timeout
);

94 
	`sÿm³r_fds_š™
();

95 
	`sÿm³r_fds_ş—nup
();

	@scamper_file.c

27 #iâdeà
lšt


28 cÚ¡ 
	grcsid
[] =

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

35 
	~"š‹º®.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_li¡.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_fe_w¬ts.h
"

41 
	~"sÿm³r_fe_‹xt.h
"

42 
	~"sÿm³r_fe_¬ts.h
"

44 
	~"Œaû/sÿm³r_Œaû.h
"

45 
	~"Œaû/sÿm³r_Œaû_‹xt.h
"

46 
	~"Œaû/sÿm³r_Œaû_w¬ts.h
"

47 
	~"Œaû/sÿm³r_Œaû_jsÚ.h
"

48 
	~"pšg/sÿm³r_pšg.h
"

49 
	~"pšg/sÿm³r_pšg_‹xt.h
"

50 
	~"pšg/sÿm³r_pšg_w¬ts.h
"

51 
	~"pšg/sÿm³r_pšg_jsÚ.h
"

52 
	~"¡šg/sÿm³r_¡šg.h
"

53 
	~"¡šg/sÿm³r_¡šg_‹xt.h
"

54 
	~"¡šg/sÿm³r_¡šg_w¬ts.h
"

55 
	~"Œaûlb/sÿm³r_Œaûlb.h
"

56 
	~"Œaûlb/sÿm³r_Œaûlb_‹xt.h
"

57 
	~"Œaûlb/sÿm³r_Œaûlb_w¬ts.h
"

58 
	~"d—lŸs/sÿm³r_d—lŸs.h
"

59 
	~"d—lŸs/sÿm³r_d—lŸs_‹xt.h
"

60 
	~"d—lŸs/sÿm³r_d—lŸs_w¬ts.h
"

61 
	~"d—lŸs/sÿm³r_d—lŸs_jsÚ.h
"

62 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc.h
"

63 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc_w¬ts.h
"

64 
	~"tb™/sÿm³r_tb™.h
"

65 
	~"tb™/sÿm³r_tb™_‹xt.h
"

66 
	~"tb™/sÿm³r_tb™_w¬ts.h
"

67 
	~"Œaûbox/sÿm³r_Œaûbox.h
"

68 
	~"Œaûbox/sÿm³r_Œaûbox_‹xt.h
"

69 
	~"Œaûbox/sÿm³r_Œaûbox_w¬ts.h
"

70 
	~"¢iff/sÿm³r_¢iff.h
"

71 
	~"¢iff/sÿm³r_¢iff_w¬ts.h
"

72 
	~"årštšg/sÿm³r_årštšg.h
"

73 
	~"årštšg/sÿm³r_årštšg_w¬ts.h
"

74 
	~"årštšg/sÿm³r_årštšg_‹xt.h
"

76 
	~"uts.h
"

78 
	#SCAMPER_FILE_NONE
 (-1)

	)

79 
	#SCAMPER_FILE_TEXT
 0

	)

80 
	#SCAMPER_FILE_ARTS
 1

	)

81 
	#SCAMPER_FILE_WARTS
 2

	)

82 
	#SCAMPER_FILE_JSON
 3

	)

84 (*
	twr™e_obj_func_t
)(
	tsÿm³r_fe_t
 *
	tsf
, const *);

86 
	ssÿm³r_fe


88 *
f’ame
;

89 
fd
;

90 *
¡©e
;

91 
ty³
;

92 
”rÜ_¡r
[256];

93 
ušt32_t
 
ÿ·b™y
;

94 
eof
;

95 
sÿm³r_fe_wr™efunc_t
 
wr™efunc
;

96 *
wr™•¬am
;

97 
sÿm³r_fe_»adfunc_t
 
»adfunc
;

98 *
»ad·¿m
;

101 
	ssÿm³r_fe_f‹r


103 
ušt32_t
 *
æags
;

104 
ušt16_t
 
max
;

107 
	shªdËr


109 *
ty³
;

110 (*
d‘eù
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

112 (*
š™_»ad
)(
sÿm³r_fe_t
 *
sf
);

113 (*
š™_wr™e
)(
sÿm³r_fe_t
 *
sf
);

114 (*
š™_­³nd
)(
sÿm³r_fe_t
 *
sf
);

116 (*
»ad
)(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

117 
ušt16_t
 *
ty³
, **
d©a
);

119 (*
wr™e_Œaû
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

120 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

122 (*
wr™e_cyşe_¡¬t
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

123 
sÿm³r_cyşe_t
 *
cyşe
);

125 (*
wr™e_cyşe_¡İ
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

126 
sÿm³r_cyşe_t
 *
cyşe
);

128 (*
wr™e_pšg
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

129 cÚ¡ 
sÿm³r_pšg
 *
pšg
);

131 (*
wr™e_Œaûlb
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

132 cÚ¡ 
sÿm³r_Œaûlb
 *
Œaû
);

134 (*
wr™e_¡šg
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

135 cÚ¡ 
sÿm³r_¡šg
 *
¡šg
);

137 (*
wr™e_d—lŸs
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

138 cÚ¡ 
sÿm³r_d—lŸs
 *
d—lŸs
);

140 (*
wr™e_Ãighbourdisc
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

141 cÚ¡ 
sÿm³r_Ãighbourdisc
 *
nd
);

143 (*
wr™e_tb™
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

144 cÚ¡ 
sÿm³r_tb™
 *
tb™
);

146 (*
wr™e_Œaûbox
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

147 cÚ¡ 
sÿm³r_Œaûbox
 *
Œaûbox
);

149 (*
wr™e_¢iff
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

150 cÚ¡ 
sÿm³r_¢iff
 *
¢iff
);

152 (*
wr™e_årštšg
)(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

153 cÚ¡ 
sÿm³r_årštšg
 *
årštšg
);

155 (*
ä“_¡©e
)(
sÿm³r_fe_t
 *
sf
);

158 
hªdËr
 
hªdËrs
[] = {

160 
NULL
,

161 
NULL
,

162 
NULL
,

163 
NULL
,

164 
NULL
,

165 
sÿm³r_fe_‹xt_Œaû_wr™e
,

166 
NULL
,

167 
NULL
,

168 
sÿm³r_fe_‹xt_pšg_wr™e
,

169 
sÿm³r_fe_‹xt_Œaûlb_wr™e
,

170 
sÿm³r_fe_‹xt_¡šg_wr™e
,

171 
sÿm³r_fe_‹xt_d—lŸs_wr™e
,

172 
NULL
,

173 
sÿm³r_fe_‹xt_tb™_wr™e
,

174 
sÿm³r_fe_‹xt_Œaûbox_wr™e
,

175 
NULL
,

176 
sÿm³r_fe_‹xt_årštšg_wr™e
,

177 
NULL
,

180 
sÿm³r_fe_¬ts_is
,

181 
sÿm³r_fe_¬ts_š™_»ad
,

182 
NULL
,

183 
NULL
,

184 
sÿm³r_fe_¬ts_»ad
,

185 
NULL
,

186 
NULL
,

187 
NULL
,

188 
NULL
,

189 
NULL
,

190 
NULL
,

191 
NULL
,

192 
NULL
,

193 
NULL
,

194 
NULL
,

195 
NULL
,

196 
NULL
,

197 
sÿm³r_fe_¬ts_ä“_¡©e
,

200 
sÿm³r_fe_w¬ts_is
,

201 
sÿm³r_fe_w¬ts_š™_»ad
,

202 
sÿm³r_fe_w¬ts_š™_wr™e
,

203 
sÿm³r_fe_w¬ts_š™_­³nd
,

204 
sÿm³r_fe_w¬ts_»ad
,

205 
sÿm³r_fe_w¬ts_Œaû_wr™e
,

206 
sÿm³r_fe_w¬ts_cyşe¡¬t_wr™e
,

207 
sÿm³r_fe_w¬ts_cyşe¡İ_wr™e
,

208 
sÿm³r_fe_w¬ts_pšg_wr™e
,

209 
sÿm³r_fe_w¬ts_Œaûlb_wr™e
,

210 
sÿm³r_fe_w¬ts_¡šg_wr™e
,

211 
sÿm³r_fe_w¬ts_d—lŸs_wr™e
,

212 
sÿm³r_fe_w¬ts_Ãighbourdisc_wr™e
,

213 
sÿm³r_fe_w¬ts_tb™_wr™e
,

214 
sÿm³r_fe_w¬ts_Œaûbox_wr™e
,

215 
sÿm³r_fe_w¬ts_¢iff_wr™e
,

216 
sÿm³r_fe_w¬ts_årštšg_wr™e
,

217 
sÿm³r_fe_w¬ts_ä“_¡©e
,

220 
NULL
,

221 
NULL
,

222 
NULL
,

223 
NULL
,

224 
NULL
,

225 
sÿm³r_fe_jsÚ_Œaû_wr™e
,

226 
NULL
,

227 
NULL
,

228 
sÿm³r_fe_jsÚ_pšg_wr™e
,

229 
NULL
,

230 
NULL
,

231 
sÿm³r_fe_jsÚ_d—lŸs_wr™e
,

232 
NULL
,

233 
NULL
,

234 
NULL
,

235 
NULL
,

236 
NULL
,

237 
NULL
,

239 
	}
};

241 
	ghªdËr_út
 = (
hªdËrs
è/ (
hªdËr
);

243 
	$sÿm³r_fe_g‘fd
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

245  
sf
->
fd
;

246 
	}
}

248 *
	$sÿm³r_fe_g‘¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

250  
sf
->
¡©e
;

251 
	}
}

253 *
	$sÿm³r_fe_g‘f’ame
(
sÿm³r_fe_t
 *
sf
)

255  
sf
->
f’ame
;

256 
	}
}

258 
	$sÿm³r_fe_£t¡©e
(
sÿm³r_fe_t
 *
sf
, *
¡©e
)

260 
sf
->
¡©e
 = state;

262 
	}
}

264 
	$sÿm³r_fe_£Œ—dfunc
(
sÿm³r_fe_t
 *
sf
,

265 *
·¿m
, 
sÿm³r_fe_»adfunc_t
 
rf
)

267 
sf
->
»adfunc
 = 
rf
;

268 
sf
->
»ad·¿m
 = 
·¿m
;

270 
	}
}

272 
sÿm³r_fe_»adfunc_t
 
	$sÿm³r_fe_g‘»adfunc
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

274  
sf
->
»adfunc
;

275 
	}
}

277 *
	$sÿm³r_fe_g‘»ad·¿m
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

279  
sf
->
»ad·¿m
;

280 
	}
}

282 
	$sÿm³r_fe_£twr™efunc
(
sÿm³r_fe_t
 *
sf
,

283 *
·¿m
, 
sÿm³r_fe_wr™efunc_t
 
wf
)

285 
sf
->
wr™efunc
 = 
wf
;

286 
sf
->
wr™•¬am
 = 
·¿m
;

288 
	}
}

290 
sÿm³r_fe_wr™efunc_t
 
	$sÿm³r_fe_g‘wr™efunc
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

292  
sf
->
wr™efunc
;

293 
	}
}

295 *
	$sÿm³r_fe_g‘wr™•¬am
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

297  
sf
->
wr™•¬am
;

298 
	}
}

300 
	$sÿm³r_fe_wr™e_Œaû
(
sÿm³r_fe_t
 *
sf
,

301 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
)

303 
rc
 = -1;

305 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_Œaû
 !ğ
NULL
)

307 
rc
 = 
hªdËrs
[
sf
->
ty³
].
	`wr™e_Œaû
(sf, 
Œaû
);

310  
rc
;

311 
	}
}

313 
	$sÿm³r_fe_wr™e_pšg
(
sÿm³r_fe_t
 *
sf
,

314 cÚ¡ 
sÿm³r_pšg
 *
pšg
)

316 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_pšg
 !ğ
NULL
)

318  
hªdËrs
[
sf
->
ty³
].
	`wr™e_pšg
(sf, 
pšg
);

321 
	}
}

323 
	$sÿm³r_fe_wr™e_Œaûlb
(
sÿm³r_fe_t
 *
sf
,

324 cÚ¡ 
sÿm³r_Œaûlb
 *
Œaû
)

326 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_Œaûlb
 !ğ
NULL
)

328  
hªdËrs
[
sf
->
ty³
].
	`wr™e_Œaûlb
(sf, 
Œaû
);

331 
	}
}

333 
	$sÿm³r_fe_wr™e_¡šg
(
sÿm³r_fe_t
 *
sf
,

334 cÚ¡ 
sÿm³r_¡šg
 *
¡šg
)

336 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_¡šg
 !ğ
NULL
)

338  
hªdËrs
[
sf
->
ty³
].
	`wr™e_¡šg
(sf, 
¡šg
);

341 
	}
}

343 
	$sÿm³r_fe_wr™e_d—lŸs
(
sÿm³r_fe_t
 *
sf
,

344 cÚ¡ 
sÿm³r_d—lŸs
 *
d—lŸs
)

346 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_d—lŸs
 !ğ
NULL
)

348  
hªdËrs
[
sf
->
ty³
].
	`wr™e_d—lŸs
(sf, 
d—lŸs
);

351 
	}
}

353 
	$sÿm³r_fe_wr™e_Ãighbourdisc
(
sÿm³r_fe_t
 *
sf
,

354 cÚ¡ 
sÿm³r_Ãighbourdisc
 *
nd
)

356 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 &&

357 
hªdËrs
[
sf
->
ty³
].
wr™e_Ãighbourdisc
 !ğ
NULL
)

359  
hªdËrs
[
sf
->
ty³
].
	`wr™e_Ãighbourdisc
(sf, 
nd
);

362 
	}
}

364 
	$sÿm³r_fe_wr™e_tb™
(
sÿm³r_fe_t
 *
sf
,

365 cÚ¡ 
sÿm³r_tb™
 *
tb™
)

367 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_tb™
 !ğ
NULL
)

369  
hªdËrs
[
sf
->
ty³
].
	`wr™e_tb™
(sf, 
tb™
);

372 
	}
}

374 
	$sÿm³r_fe_wr™e_Œaûbox
(
sÿm³r_fe_t
 *
sf
,

375 cÚ¡ 
sÿm³r_Œaûbox
 *
Œaûbox
)

377 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_Œaûbox
 !ğ
NULL
)

379  
hªdËrs
[
sf
->
ty³
].
	`wr™e_Œaûbox
(sf, 
Œaûbox
);

382 
	}
}

384 
	$sÿm³r_fe_wr™e_¢iff
(
sÿm³r_fe_t
 *
sf
,

385 cÚ¡ 
sÿm³r_¢iff
 *
¢iff
)

387 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_¢iff
 !ğ
NULL
)

389  
hªdËrs
[
sf
->
ty³
].
	`wr™e_¢iff
(sf, 
¢iff
);

393 
	}
}

395 
	$sÿm³r_fe_wr™e_årštšg
(
sÿm³r_fe_t
 *
sf
,

396 cÚ¡ 
sÿm³r_årštšg
 *
årštšg
)

398 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
wr™e_årštšg
 !ğ
NULL
)

400  
hªdËrs
[
sf
->
ty³
].
	`wr™e_årštšg
(sf, 
årštšg
);

404 
	}
}

406 
	$sÿm³r_fe_wr™e_obj
(
sÿm³r_fe_t
 *
sf
, 
ušt16_t
 
ty³
, cÚ¡ *
d©a
)

408 (*cÚ¡ 
func
[])(
sÿm³r_fe_t
 *
sf
, const *) = {

409 
NULL
,

410 
NULL
,

411 
NULL
,

412 
NULL
,

413 
NULL
,

414 
NULL
,

415 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_Œaû
,

416 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_pšg
,

417 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_Œaûlb
,

418 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_d—lŸs
,

419 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_Ãighbourdisc
,

420 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_tb™
,

421 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_Œaûbox
,

422 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_¡šg
,

423 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_¢iff
,

424 (
wr™e_obj_func_t
)
sÿm³r_fe_wr™e_årštšg
,

426 if(
ty³
 > 13 || 
func
[ty³] =ğ
NULL
)

428  
func
[
ty³
](
sf
, 
d©a
);

429 
	}
}

436 
	$sÿm³r_fe_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

437 
ušt16_t
 *
ty³
, **
objeù
)

439 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
»ad
 !ğ
NULL
)

441  
hªdËrs
[
sf
->
ty³
].
	`»ad
(sf, 
f‹r
,y³, 
objeù
);

445 
	}
}

452 
	$sÿm³r_fe_f‹r_is£t
(
sÿm³r_fe_f‹r_t
 *
f‹r
, 
ušt16_t
 
ty³
)

454 if(
f‹r
 =ğ
NULL
 || 
ty³
 > f‹r->
max
)

459 if((
f‹r
->
æags
[
ty³
/32] & (0x1 << ((type%32)-1))) == 0)

465 
	}
}

473 
sÿm³r_fe_f‹r_t
 *
	$sÿm³r_fe_f‹r_®loc
(
ušt16_t
 *
ty³s
, ušt16_ˆ
num
)

475 
sÿm³r_fe_f‹r_t
 *
f‹r
 = 
NULL
;

476 
size_t
 
size
;

477 
i
, 
j
, 
k
;

480 if(
ty³s
 =ğ
NULL
 || 
num
 == 0)

482 
”r
;

486 if((
f‹r
 = 
	`m®loc_z”o
((
sÿm³r_fe_f‹r_t
))è=ğ
NULL
)

488 
”r
;

492 
i
=0; i<
num
; i++)

495 if(
ty³s
[
i
] == 0)

497 
”r
;

499 if(
ty³s
[
i
] > 
f‹r
->
max
)

501 
f‹r
->
max
 = 
ty³s
[
i
];

506 if(
f‹r
->
max
 == 0)

508 
”r
;

512 
size
 = (
ušt32_t
è* 
f‹r
->
max
 / 32;

513 if((
f‹r
->
max
 % 32è!ğ0è
size
 +ğ(
ušt32_t
);

514 if((
f‹r
->
æags
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

516 
”r
;

520 
i
=0; i<
num
; i++)

522 if(
ty³s
[
i
] % 32 == 0)

524 
j
 = ((
ty³s
[
i
]) / 32) - 1;

525 
k
 = 32;

529 
j
 = 
ty³s
[
i
] / 32;

530 
k
 = 
ty³s
[
i
] % 32;

533 
f‹r
->
æags
[
j
] |ğ(0x1 << (
k
-1));

536  
f‹r
;

538 
”r
:

539 if(
f‹r
 !ğ
NULL
)

541 if(
f‹r
->
æags
 !ğ
NULL
è
	`ä“
(filter->flags);

542 
	`ä“
(
f‹r
);

544  
NULL
;

545 
	}
}

547 
	$sÿm³r_fe_f‹r_ä“
(
sÿm³r_fe_f‹r_t
 *
f‹r
)

549 if(
f‹r
 !ğ
NULL
)

551 if(
f‹r
->
æags
 !ğ
NULL
è
	`ä“
(filter->flags);

552 
	`ä“
(
f‹r
);

556 
	}
}

558 
	$sÿm³r_fe_wr™e_cyşe_¡¬t
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
)

560 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 &&

561 
hªdËrs
[
sf
->
ty³
].
wr™e_cyşe_¡¬t
 !ğ
NULL
)

563  
hªdËrs
[
sf
->
ty³
].
	`wr™e_cyşe_¡¬t
(sf, 
cyşe
);

566 
	}
}

568 
	$sÿm³r_fe_wr™e_cyşe_¡İ
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
)

570 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 &&

571 
hªdËrs
[
sf
->
ty³
].
wr™e_cyşe_¡İ
 !ğ
NULL
)

573  
hªdËrs
[
sf
->
ty³
].
	`wr™e_cyşe_¡İ
(sf, 
cyşe
);

576 
	}
}

582 
	$sÿm³r_fe_g‘eof
(
sÿm³r_fe_t
 *
sf
)

584 if(
sf
 =ğ
NULL
 || sf->
fd
 == -1)  -1;

585  
sf
->
eof
;

586 
	}
}

592 
	$sÿm³r_fe_£‹of
(
sÿm³r_fe_t
 *
sf
)

594 if(
sf
 !ğ
NULL
 && sf->
fd
 != -1)

595 
sf
->
eof
 = 1;

597 
	}
}

603 
	$sÿm³r_fe_ä“
(
sÿm³r_fe_t
 *
sf
)

605 if(
sf
 !ğ
NULL
)

607 if(
sf
->
f’ame
è
	`ä“
(sf->filename);

608 
	`ä“
(
sf
);

611 
	}
}

617 
	$sÿm³r_fe_şo£
(
sÿm³r_fe_t
 *
sf
)

620 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
ä“_¡©e
 !ğ
NULL
)

622 
hªdËrs
[
sf
->
ty³
].
	`ä“_¡©e
(sf);

626 if(
sf
->
fd
 != -1)

628 
	`şo£
(
sf
->
fd
);

632 
	`sÿm³r_fe_ä“
(
sf
);

635 
	}
}

637 *
	$sÿm³r_fe_ty³_to¡r
(
sÿm³r_fe_t
 *
sf
, *
buf
, 
size_t
 
Ën
)

639 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].ty³ !ğ
NULL
)

641 
	`¡ºıy
(
buf
, 
hªdËrs
[
sf
->
ty³
].ty³, 
Ën
);

642  
buf
;

645  
NULL
;

646 
	}
}

648 
	$fe_ty³_g‘
(*
ty³
)

650 
i
;

651 if(
ty³
 =ğ
NULL
)

652  
SCAMPER_FILE_NONE
;

653 
i
=0; i<
hªdËr_út
; i++)

654 if(
	`¡rÿ£cmp
(
ty³
, 
hªdËrs
[
i
].type) == 0)

655  
i
;

656  
SCAMPER_FILE_NONE
;

657 
	}
}

659 
	$fe_ty³_d‘eù
(
sÿm³r_fe_t
 *
sf
)

661 
i
;

662 
i
=0; i<
hªdËr_út
; i++)

663 if(
hªdËrs
[
i
].
d‘eù
 !ğ
NULL
 && hªdËrs[i].
	`d‘eù
(
sf
) == 1)

664  
i
;

665  
SCAMPER_FILE_NONE
;

666 
	}
}

668 
	$fe_İ’_»ad
(
sÿm³r_fe_t
 *
sf
)

670 
¡©
 
sb
;

672 if(
sf
->
fd
 != -1)

674 if(
	`f¡©
(
sf
->
fd
, &
sb
) != 0)

679 if(
sb
.
¡_size
 !ğ0 && (sb.
¡_mode
 & 
S_IFIFO
) == 0 &&

680 (
sf
->
ty³
 = 
	`fe_ty³_d‘eù
(sf)è=ğ
SCAMPER_FILE_NONE
)

686 if(
hªdËrs
[
sf
->
ty³
].
š™_»ad
 =ğ
NULL
)

689  
hªdËrs
[
sf
->
ty³
].
	`š™_»ad
(sf);

690 
	}
}

692 
	$fe_İ’_wr™e
(
sÿm³r_fe_t
 *
sf
)

694 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_NONE
 && 
hªdËrs
[sf->ty³].
š™_wr™e
 !ğ
NULL
)

695  
hªdËrs
[
sf
->
ty³
].
	`š™_wr™e
(sf);

697 
	}
}

699 
	$fe_İ’_­³nd
(
sÿm³r_fe_t
 *
sf
)

701 
¡©
 
sb
;

703 if(
	`f¡©
(
sf
->
fd
, &
sb
) != 0)

706 if(
sb
.
¡_size
 == 0)

708 if(
sf
->
ty³
 =ğ
SCAMPER_FILE_WARTS
)

709  
hªdËrs
[
sf
->
ty³
].
	`š™_wr™e
(sf);

710 if(
sf
->
ty³
 =ğ
SCAMPER_FILE_TEXT
 || sf->ty³ =ğ
SCAMPER_FILE_JSON
)

716 if((
sb
.
¡_mode
 & 
S_IFIFO
) != 0)

719 
sf
->
ty³
 = 
	`fe_ty³_d‘eù
(sf);

720 if(
hªdËrs
[
sf
->
ty³
].
š™_­³nd
 !ğ
NULL
)

721  
hªdËrs
[
sf
->
ty³
].
	`š™_­³nd
(sf);

722 if(
sf
->
ty³
 !ğ
SCAMPER_FILE_TEXT
 && sf->ty³ !ğ
SCAMPER_FILE_JSON
)

726 
	}
}

728 
sÿm³r_fe_t
 *
	$fe_İ’
(
fd
, *
â
, 
mode
, 
ty³
)

730 
sÿm³r_fe_t
 *
sf
;

731 (*
İ’_func
)(
sÿm³r_fe_t
 *);

733 if(
mode
 =ğ'r'è
İ’_func
 = 
fe_İ’_»ad
;

734 if(
mode
 =ğ'w'è
İ’_func
 = 
fe_İ’_wr™e
;

735 if(
mode
 =ğ'a'è
İ’_func
 = 
fe_İ’_­³nd
;

736  
NULL
;

738 if((
sf
 = (
sÿm³r_fe_t
 *)
	`m®loc_z”o
((sÿm³r_fe_t))è=ğ
NULL
)

740  
NULL
;

743 
sf
->
ty³
 =ype;

744 
sf
->
fd
 = fd;

746 if(
â
 !ğ
NULL
 && (
sf
->
f’ame
 = 
	`¡rdup
(fn)) == NULL)

748  
NULL
;

751 if(
	`İ’_func
(
sf
) == -1)

753 
	`sÿm³r_fe_şo£
(
sf
);

754  
NULL
;

757  
sf
;

758 
	}
}

760 
sÿm³r_fe_t
 *
	$sÿm³r_fe_İ’nuÎ
(
mode
)

762  
	`fe_İ’
(-1, 
NULL
, 
mode
, 
SCAMPER_FILE_WARTS
);

763 
	}
}

765 
sÿm³r_fe_t
 *
	$sÿm³r_fe_İ’fd
(
fd
, *
â
, 
mode
, *
ty³
)

767  
	`fe_İ’
(
fd
, 
â
, 
mode
, 
	`fe_ty³_g‘
(
ty³
));

768 
	}
}

787 
sÿm³r_fe_t
 *
	$sÿm³r_fe_İ’
(*
f’ame
, 
mode
, *
ty³
)

789 
sÿm³r_fe_t
 *
sf
;

790 
mode_t
 
mo
;

791 
á
 = 
	`fe_ty³_g‘
(
ty³
);

792 
æags
 = 0;

793 
fd
 = -1;

795 #iâdeà
_WIN32


796 
mo
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

798 
mo
 = 
_S_IREAD
 | 
_S_IWRITE
;

801 if(
mode
 == 'r')

803 if(
	`¡rcmp
(
f’ame
, "-") == 0)

805 
fd
 = 
STDIN_FILENO
;

809 
æags
 = 
O_RDONLY
;

812 if(
mode
 == 'w' || mode == 'a')

815 if(
á
 =ğ
SCAMPER_FILE_NONE
 || fˆ=ğ
SCAMPER_FILE_ARTS
)

817  
NULL
;

820 if(
	`¡rcmp
(
f’ame
, "-") == 0)

822 
fd
 = 
STDIN_FILENO
;

826 if(
mode
 =ğ'w'è
æags
 = 
O_WRONLY
 | 
O_TRUNC
 | 
O_CREAT
;

827 
æags
 = 
O_RDWR
 | 
O_APPEND
 | 
O_CREAT
;

832  
NULL
;

835 #ifdeà
_WIN32


836 
æags
 |ğ
O_BINARY
;

839 if(
fd
 == -1)

841 if(
mode
 =ğ'r'è
fd
 = 
	`İ’
(
f’ame
, 
æags
);

842 
fd
 = 
	`İ’
(
f’ame
, 
æags
, 
mo
);

844 if(
fd
 == -1)

846  
NULL
;

850 
sf
 = 
	`fe_İ’
(
fd
, 
f’ame
, 
mode
, 
á
);

852  
sf
;

853 
	}
}

	@scamper_file.h

27 #iâdeà
__SCAMPER_FILE_H


28 
	#__SCAMPER_FILE_H


	)

31 
sÿm³r_fe
 
	tsÿm³r_fe_t
;

34 
sÿm³r_fe_f‹r
 
	tsÿm³r_fe_f‹r_t
;

36 (*
	tsÿm³r_fe_wr™efunc_t
)(*
	t·¿m
,

37 cÚ¡ *
	td©a
, 
	tsize_t
 
	tËn
);

39 (*
	tsÿm³r_fe_»adfunc_t
)(*
	t·¿m
,

40 
	tušt8_t
 **
	td©a
, 
	tsize_t
 
	tËn
);

43 
	#SCAMPER_FILE_OBJ_LIST
 0x01

	)

44 
	#SCAMPER_FILE_OBJ_CYCLE_START
 0x02

	)

45 
	#SCAMPER_FILE_OBJ_CYCLE_DEF
 0x03

	)

46 
	#SCAMPER_FILE_OBJ_CYCLE_STOP
 0x04

	)

47 
	#SCAMPER_FILE_OBJ_ADDR
 0x05

	)

48 
	#SCAMPER_FILE_OBJ_TRACE
 0x06

	)

49 
	#SCAMPER_FILE_OBJ_PING
 0x07

	)

50 
	#SCAMPER_FILE_OBJ_TRACELB
 0x08

	)

51 
	#SCAMPER_FILE_OBJ_DEALIAS
 0x09

	)

52 
	#SCAMPER_FILE_OBJ_NEIGHBOURDISC
 0x0a

	)

53 
	#SCAMPER_FILE_OBJ_TBIT
 0x0b

	)

54 
	#SCAMPER_FILE_OBJ_TRACEBOX
 0x0c

	)

55 
	#SCAMPER_FILE_OBJ_STING
 0x0d

	)

56 
	#SCAMPER_FILE_OBJ_SNIFF
 0x0e

	)

57 
	#SCAMPER_FILE_OBJ_FPRINTING
 0x0f

	)

60 
sÿm³r_fe_t
 *
	`sÿm³r_fe_İ’
(*
â
, 
mode
, *
ty³
);

61 
sÿm³r_fe_t
 *
	`sÿm³r_fe_İ’fd
(
fd
, *
â
, 
mode
, *
ty³
);

62 
sÿm³r_fe_t
 *
	`sÿm³r_fe_İ’nuÎ
(
mode
);

63 
	`sÿm³r_fe_şo£
(
sÿm³r_fe_t
 *
sf
);

64 
	`sÿm³r_fe_ä“
(
sÿm³r_fe_t
 *
sf
);

66 
sÿm³r_fe_f‹r_t
 *
	`sÿm³r_fe_f‹r_®loc
(
ušt16_t
 *
ty³s
,ušt16_ˆ
num
);

67 
	`sÿm³r_fe_f‹r_ä“
(
sÿm³r_fe_f‹r_t
 *
f‹r
);

68 
	`sÿm³r_fe_f‹r_is£t
(
sÿm³r_fe_f‹r_t
 *
f‹r
, 
ušt16_t
 
ty³
);

70 
	`sÿm³r_fe_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

71 
ušt16_t
 *
obj_ty³
, **
obj_d©a
);

73 
	`sÿm³r_fe_wr™e_obj
(
sÿm³r_fe_t
 *
sf
,
ušt16_t
 
ty³
,cÚ¡ *
d©a
);

75 
sÿm³r_cyşe
;

76 
	`sÿm³r_fe_wr™e_cyşe_¡¬t
(
sÿm³r_fe_t
 *
sf
,

77 
sÿm³r_cyşe
 *
cyşe
);

78 
	`sÿm³r_fe_wr™e_cyşe_¡İ
(
sÿm³r_fe_t
 *
sf
,

79 
sÿm³r_cyşe
 *
cyşe
);

81 
sÿm³r_Œaû
;

82 
	`sÿm³r_fe_wr™e_Œaû
(
sÿm³r_fe_t
 *
sf
,

83 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

85 
sÿm³r_Œaûlb
;

86 
	`sÿm³r_fe_wr™e_Œaûlb
(
sÿm³r_fe_t
 *
sf
,

87 cÚ¡ 
sÿm³r_Œaûlb
 *
Œaû
);

89 
sÿm³r_pšg
;

90 
	`sÿm³r_fe_wr™e_pšg
(
sÿm³r_fe_t
 *
sf
,

91 cÚ¡ 
sÿm³r_pšg
 *
pšg
);

93 
sÿm³r_¡šg
;

94 
	`sÿm³r_fe_wr™e_¡šg
(
sÿm³r_fe_t
 *
sf
,

95 cÚ¡ 
sÿm³r_¡šg
 *
¡šg
);

97 
sÿm³r_d—lŸs
;

98 
	`sÿm³r_fe_wr™e_d—lŸs
(
sÿm³r_fe_t
 *
sf
,

99 cÚ¡ 
sÿm³r_d—lŸs
 *
d—lŸs
);

101 
sÿm³r_Ãighbourdisc
;

102 
	`sÿm³r_fe_wr™e_Ãighbourdisc
(
sÿm³r_fe_t
 *
sf
,

103 cÚ¡ 
sÿm³r_Ãighbourdisc
 *
nd
);

105 
sÿm³r_tb™
;

106 
	`sÿm³r_fe_wr™e_tb™
(
sÿm³r_fe_t
 *
sf
,

107 cÚ¡ 
sÿm³r_tb™
 *
tb™
);

110 
sÿm³r_Œaûbox
;

111 
	`sÿm³r_fe_wr™e_Œaûbox
(
sÿm³r_fe_t
 *
sf
,

112 cÚ¡ 
sÿm³r_Œaûbox
 *
Œaûbox
);

114 
sÿm³r_¢iff
;

115 
	`sÿm³r_fe_wr™e_¢iff
(
sÿm³r_fe_t
 *
sf
,

116 cÚ¡ 
sÿm³r_¢iff
 *
¢iff
);

118 
sÿm³r_årštšg
;

119 
	`sÿm³r_fe_wr™e_årštšg
(
sÿm³r_fe_t
 *
sf
,

120 cÚ¡ 
sÿm³r_årštšg
 *
årštšg
);

122 *
	`sÿm³r_fe_ty³_to¡r
(
sÿm³r_fe_t
 *
sf
, *
buf
, 
size_t
 
Ën
);

123 *
	`sÿm³r_fe_g‘f’ame
(
sÿm³r_fe_t
 *
sf
);

125 
	`sÿm³r_fe_g‘eof
(
sÿm³r_fe_t
 *
sf
);

126 
	`sÿm³r_fe_£‹of
(
sÿm³r_fe_t
 *
sf
);

128 
	`sÿm³r_fe_£Œ—dfunc
(
sÿm³r_fe_t
 *
sf
, *
·¿m
,

129 
sÿm³r_fe_»adfunc_t
 
»adfunc
);

130 
sÿm³r_fe_»adfunc_t
 
	`sÿm³r_fe_g‘»adfunc
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

131 *
	`sÿm³r_fe_g‘»ad·¿m
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

133 
	`sÿm³r_fe_£twr™efunc
(
sÿm³r_fe_t
 *
sf
, *
·¿m
,

134 
sÿm³r_fe_wr™efunc_t
 
wr™efunc
);

135 
sÿm³r_fe_wr™efunc_t
 
	`sÿm³r_fe_g‘wr™efunc
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

136 *
	`sÿm³r_fe_g‘wr™•¬am
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

138 
	`sÿm³r_fe_g‘fd
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

139 *
	`sÿm³r_fe_g‘¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

140 
	`sÿm³r_fe_£t¡©e
(
sÿm³r_fe_t
 *
sf
, *
¡©e
);

	@scamper_file_arts.c

27 #iâdeà
lšt


28 cÚ¡ 
	grcsid
[] =

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

35 
	~"š‹º®.h
"

37 
	~"mjl_¥ÏyŒ“.h
"

38 
	~"sÿm³r_addr.h
"

39 
	~"sÿm³r_li¡.h
"

40 
	~"Œaû/sÿm³r_Œaû.h
"

41 
	~"sÿm³r_fe.h
"

42 
	~"sÿm³r_fe_¬ts.h
"

43 
	~"uts.h
"

45 
	s¬ts_¡©e


47 
	mi¥e
;

48 
¥ÏyŒ“_t
 *
	mli¡_Œ“
;

49 
¥ÏyŒ“_t
 *
	mcyşe_Œ“
;

50 } 
	t¬ts_¡©e_t
;

52 
	s¬ts_h—d”


54 
ušt8_t
 
	mv”
;

55 
ušt32_t
 
	mid
;

56 
ušt32_t
 
	mæags
;

57 
ušt32_t
 
	md©a_Ëngth
;

58 
ušt32_t
 
	mü—tiÚ
;

59 } 
	t¬ts_h—d”_t
;

61 
	#ARTS_MAGIC
 0xdfb0

	)

62 
	#ARTS_IP_PATH
 0x00003000

	)

63 
	#ARTS_IP_PATH_RTT
 0x01

	)

65 
	#ARTS_ATTR_CREATION
 2

	)

67 
	#ARTS_FORMAT_UNIXDATE
 13

	)

69 
	#ARTS_STOP_NOHALT
 0x00

	)

70 
	#ARTS_STOP_ICMPUNREACH
 0x01

	)

71 
	#ARTS_STOP_LOOP
 0x02

	)

72 
	#ARTS_STOP_GAPLIMIT
 0x03

	)

80 
	$¬ts_»ad_hdr
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
¬ts_h—d”_t
 *
ah
)

82 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

83 
ušt8_t
 
buf
[20], *
tmp
 = buf;

84 
ušt32_t
 
junk32
;

85 
ušt32_t
 
i
, 
©Œ_Ën
;

86 
ušt16_t
 
junk16
;

87 
»t
;

88 
size_t
 
rc
;

90 
	`mem£t
(
ah
, 0, (
¬ts_h—d”_t
));

93 if((
»t
 = 
	`»ad_w¿p
(
fd
, 
buf
, &
rc
, 20)) != 0)

96 if(
»t
 =ğ-2 && 
rc
 == 0)

101 
	`årštf
(
¡d”r
, "¬ts_»ad_hdr:„—d %d oà20 by‹s\n", ()
rc
);

102 
”r
;

106 
	`memıy
(&
junk16
, 
buf
, 2);

107 if((
junk16
 = 
	`Áohs
(junk16)è!ğ
ARTS_MAGIC
)

109 
	`årštf
(
¡d”r
, "arts_read_hdr:ƒxpected magic 0x%02x got 0x%02x\n",

110 
ARTS_MAGIC
, 
junk16
);

111 
”r
;

118 
	`memıy
(&
junk32
, 
buf
+2, 4);

119 
junk32
 = 
	`Áohl
(junk32);

120 
ah
->
id
 = 
junk32
 >> 4;

121 
ah
->
v”
 = 
junk32
 & 0x0f;

124 
	`memıy
(&
junk32
, 
buf
+6, 4);

125 
ah
->
æags
 = 
	`Áohl
(
junk32
);

128 
	`memıy
(&
junk32
, 
buf
+16, 4);

129 
ah
->
d©a_Ëngth
 = 
	`Áohl
(
junk32
);

132 
	`memıy
(&
junk32
, 
buf
+12, 4);

133 
©Œ_Ën
 = 
	`Áohl
(
junk32
);

136 if(
©Œ_Ën
 > (
buf
))

138 if((
tmp
 = 
	`m®loc
(
©Œ_Ën
)è=ğ
NULL
)

140 
”r
;

145 if(
©Œ_Ën
 > 0 && (
»t
 = 
	`»ad_w¿p
(
fd
, 
tmp
, &
rc
,‡ttr_len)) != 0)

147 
”r
;

151 
i
 = 0; i < 
©Œ_Ën
; i +ğ
junk32
)

154 if(
©Œ_Ën
 - 
i
 < 8)

156 
”r
;

160 
	`memıy
(&
junk32
, 
tmp
 + 
i
, 4); junk32 = 
	`Áohl
(junk32);

163 
junk32
 >> 8)

165 
ARTS_ATTR_CREATION
:

167 if((
junk32
 & 0xffè!ğ
ARTS_FORMAT_UNIXDATE
 || 
©Œ_Ën
 - 
i
 < 12)

169 
”r
;

171 
	`memıy
(&
junk32
, 
tmp
 + 
i
 + 8, 4);

172 
ah
->
ü—tiÚ
 = 
	`Áohl
(
junk32
);

177 
	`memıy
(&
junk32
, 
tmp
 + 
i
 + 4, 4);

178 
junk32
 = 
	`Áohl
(junk32);

179 if(
junk32
 < 8 || 
©Œ_Ën
 - 
i
 < junk32)

181 
”r
;

186 if(
tmp
 !ğ
buf
è
	`ä“
(tmp);

190 
”r
:

191 if(
tmp
 !ğ
NULL
 &&m°!ğ
buf
è
	`ä“
(tmp);

193 
	}
}

195 
	$¬ts_hİ_li¡_ä“
(
sÿm³r_Œaû_hİ_t
 *
h—d
)

197 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
h—d
;

199 
hİ
 !ğ
NULL
)

201 
h—d
 = 
hİ
->
hİ_Ãxt
;

202 
	`sÿm³r_Œaû_hİ_ä“
(
hİ
);

203 
hİ
 = 
h—d
;

207 
	}
}

209 
sÿm³r_Œaû_hİ_t
 *
	$¬ts_hİ_»¶y
(
sÿm³r_addr_t
 *
addr
,

210 
ušt32_t
 
¹t
, 
ušt8_t
 
di¡ªû
)

212 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
	`sÿm³r_Œaû_hİ_®loc
();

214 if(
hİ
 !ğ
NULL
)

216 
hİ
->
hİ_addr
 = 
	`sÿm³r_addr_u£
(
addr
);

217 
hİ
->
hİ_æags
 = 0;

218 
hİ
->
hİ_´obe_id
 = 0;

219 
hİ
->
hİ_´obe_‰l
 = 
di¡ªû
;

220 
hİ
->
hİ_´obe_size
 = 0;

221 
hİ
->
hİ_»¶y_‰l
 = 0;

222 
hİ
->
hİ_»¶y_size
 = 0;

223 
hİ
->
hİ_icmp_ty³
 = 
ICMP_ECHOREPLY
;

224 
hİ
->
hİ_icmp_code
 = 0;

225 
hİ
->
hİ_¹t
.
tv_£c
 = 
¹t
 / 1000000;

226 
hİ
->
hİ_¹t
.
tv_u£c
 = 
¹t
 % 1000000;

229  
hİ
;

230 
	}
}

232 
	$¬ts_hİ_»ad
(
sÿm³r_Œaû_hİ_t
 *
hİ
, cÚ¡ 
ušt8_t
 *
buf
,

233 cÚ¡ 
¬ts_h—d”_t
 *
ah
)

235 
ušt32_t
 
junk32
;

236 
i
 = 0;

239 
hİ
->
hİ_addr
 = 
NULL
;

240 
hİ
->
hİ_æags
 = 0;

241 
hİ
->
hİ_´obe_id
 = 0;

242 
hİ
->
hİ_´obe_‰l
 = 
buf
[
i
++];

243 
hİ
->
hİ_´obe_size
 = 0;

244 
hİ
->
hİ_»¶y_‰l
 = 0;

245 
hİ
->
hİ_»¶y_size
 = 0;

246 
hİ
->
hİ_icmp_ty³
 = 
ICMP_TIMXCEED
;

247 
hİ
->
hİ_icmp_code
 = 
ICMP_TIMXCEED_INTRANS
;

248 
hİ
->
hİ_¹t
.
tv_£c
 = 0;

249 
hİ
->
hİ_¹t
.
tv_u£c
 = 0;

252 
	`as£¹
(
hİ
->
hİ_´obe_‰l
 > 0);

255 if((
hİ
->
hİ_addr
 = 
	`sÿm³r_addr_®loc_v4
(
buf
+
i
)è=ğ
NULL
)

259 
i
 += 4;

262 if(
ah
->
v”
 =ğ1 || (ah->
æags
 & 
ARTS_IP_PATH_RTT
 &&‡h->ver > 1))

265 
	`memıy
(&
junk32
, 
buf
+
i
, 4); i += 4;

266 
junk32
 = 
	`Áohl
(junk32);

267 
hİ
->
hİ_¹t
.
tv_£c
 = 
junk32
 / 1000000;

268 
hİ
->
hİ_¹t
.
tv_u£c
 = 
junk32
 % 1000000;

271 
hİ
->
hİ_´obe_id
 = 
buf
[
i
++];

274  
i
;

275 
	}
}

277 
sÿm³r_Œaû_hİ_t
 *
	$¬ts_hİs_»ad
(cÚ¡ 
¬ts_h—d”_t
 *
ah
,

278 cÚ¡ 
ušt8_t
 *
buf
,

279 
couÁ
, *
off
)

281 
sÿm³r_Œaû_hİ_t
 *
h—d
 = 
NULL
, *
hİ
 = NULL;

282 
i
 = 0;

284 if(
couÁ
 == 0)

286  
NULL
;

289 
couÁ
-- > 0)

291 if(
hİ
 !ğ
NULL
)

293 
hİ
->
hİ_Ãxt
 = 
	`sÿm³r_Œaû_hİ_®loc
();

294 
hİ
 = hİ->
hİ_Ãxt
;

298 
h—d
 = 
hİ
 = 
	`sÿm³r_Œaû_hİ_®loc
();

301 if(
hİ
 =ğ
NULL
)

303 
”r
;

306 
i
 +ğ
	`¬ts_hİ_»ad
(
hİ
, 
buf
+i, 
ah
);

309 *
off
 +ğ
i
;

311  
h—d
;

313 
”r
:

314 
	`¬ts_hİ_li¡_ä“
(
h—d
);

315  
NULL
;

316 
	}
}

318 
	$¬ts_li¡_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

320 cÚ¡ 
sÿm³r_li¡_t
 *
a
 = (cÚ¡ sÿm³r_li¡_ˆ*)
va
;

321 cÚ¡ 
sÿm³r_li¡_t
 *
b
 = (cÚ¡ sÿm³r_li¡_ˆ*)
vb
;

322 if(
a
->
id
 < 
b
->id)  -1;

323 if(
a
->
id
 > 
b
->id)  1;

325 
	}
}

327 
sÿm³r_li¡_t
 *
	$¬ts_li¡_g‘
(
¬ts_¡©e_t
 *
¡©e
, 
ušt32_t
 
id
)

329 
sÿm³r_li¡_t
 
fšdme
, *
li¡
;

331 
fšdme
.
id
 = id;

332 if((
li¡
 = 
	`¥ÏyŒ“_fšd
(
¡©e
->
li¡_Œ“
, &
fšdme
)è=ğ
NULL
)

334 if((
li¡
 = 
	`sÿm³r_li¡_®loc
(
id
, 
NULL
, NULL, NULL)) == NULL)

336  
NULL
;

339 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
li¡_Œ“
, 
li¡
è=ğ
NULL
)

341 
	`sÿm³r_li¡_ä“
(
li¡
);

342  
NULL
;

346  
li¡
;

347 
	}
}

349 
	$¬ts_cyşe_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

351 cÚ¡ 
sÿm³r_cyşe_t
 *
a
 = (cÚ¡ sÿm³r_cyşe_ˆ*)
va
;

352 cÚ¡ 
sÿm³r_cyşe_t
 *
b
 = (cÚ¡ sÿm³r_cyşe_ˆ*)
vb
;

354 
i
 = 
	`¬ts_li¡_cmp
(
a
->
li¡
, 
b
->list);

356 if(
i
 != 0)  i;

357 if(
a
->
id
 < 
b
->id)  -1;

358 if(
a
->
id
 > 
b
->id)  1;

361 
	}
}

363 
sÿm³r_cyşe_t
 *
	$¬ts_cyşe_g‘
(
¬ts_¡©e_t
 *
¡©e
,

364 
sÿm³r_li¡_t
 *
li¡
, 
ušt32_t
 
id
)

366 
sÿm³r_cyşe_t
 
fšdme
, *
cyşe
;

368 
fšdme
.
li¡
 =†ist;

369 
fšdme
.
id
 = id;

370 if((
cyşe
 = 
	`¥ÏyŒ“_fšd
(
¡©e
->
cyşe_Œ“
, &
fšdme
)è=ğ
NULL
)

372 if((
cyşe
 = 
	`sÿm³r_cyşe_®loc
(
li¡
)è=ğ
NULL
)

374  
NULL
;

376 
cyşe
->
id
 = id;

378 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
cyşe_Œ“
, 
cyşe
è=ğ
NULL
)

380 
	`sÿm³r_cyşe_ä“
(
cyşe
);

381  
NULL
;

385  
cyşe
;

386 
	}
}

388 
sÿm³r_Œaû_t
 *
	$¬ts_»ad_Œaû
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

389 cÚ¡ 
¬ts_h—d”_t
 *
ah
)

391 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

392 
¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

393 
sÿm³r_Œaû_t
 *
Œaû
 = 
NULL
;

394 
ušt8_t
 *
buf
 = 
NULL
;

395 
i
;

396 
ušt32_t
 
junk32
;

397 
ušt8_t
 
junk8
;

398 
ušt8_t
 
hİ_di¡ªû
;

399 
ušt8_t
 
h®t_»asÚ
;

400 
ušt8_t
 
h®t_»asÚ_d©a
;

401 
ušt8_t
 
»¶y_‰l
 = 0;

402 
ušt32_t
 
¹t
;

403 
sÿm³r_Œaû_hİ_t
 *
hİ
, *
hİs
 = 
NULL
;

404 
ušt8_t
 
num_hİ_»cs
;

405 
ušt8_t
 
max_hİ
;

406 
ušt8_t
 
de¡š©iÚ_»¶›d
;

407 
size_t
 
rc
;

409 if((
buf
 = 
	`m®loc
(
ah
->
d©a_Ëngth
)è=ğ
NULL
)

411 
	`årštf
(
¡d”r
, "arts_read_trace: malloc %d forrace object failed\n",

412 
ah
->
d©a_Ëngth
);

413 
”r
;

416 if(
	`»ad_w¿p
(
fd
, 
buf
, &
rc
, 
ah
->
d©a_Ëngth
) != 0)

418 
	`årštf
(
¡d”r
, "¬ts_»ad_Œaû:„—d %dƒx³ùed %d\n", ()
rc
,

419 
ah
->
d©a_Ëngth
);

420 
”r
;

423 if((
Œaû
 = 
	`sÿm³r_Œaû_®loc
()è=ğ
NULL
)

425 
	`årštf
(
¡d”r
, "arts_read_trace: scamper_trace_alloc failed\n");

426 
”r
;

429 
Œaû
->
¡¬t
.
tv_£c
 = 
ah
->
ü—tiÚ
;

430 
Œaû
->
ty³
 = 
SCAMPER_TRACE_TYPE_ICMP_ECHO
;

431 
Œaû
->
´obe_size
 = 20 + 8 + 12;

433 
i
 = 0;

435 if((
Œaû
->
¤c
 = 
	`sÿm³r_addr_®loc_v4
(
buf
+
i
)è=ğ
NULL
)

437 
”r
;

439 
i
 += 4;

441 if((
Œaû
->
d¡
 = 
	`sÿm³r_addr_®loc_v4
(
buf
+
i
)è=ğ
NULL
)

443 
”r
;

445 
i
 += 4;

447 if(
ah
->
v”
 >= 3)

450 
	`memıy
(&
junk32
, 
buf
+
i
, 4); i +ğ4; junk32 = 
	`Áohl
(junk32);

451 if((
Œaû
->
li¡
 = 
	`¬ts_li¡_g‘
(
¡©e
, 
junk32
)è=ğ
NULL
)

453 
”r
;

455 
	`sÿm³r_li¡_u£
(
Œaû
->
li¡
);

458 
	`memıy
(&
junk32
, 
buf
+
i
, 4); i +ğ4; junk32 = 
	`Áohl
(junk32);

459 if((
Œaû
->
cyşe
 = 
	`¬ts_cyşe_g‘
(
¡©e
,¿û->
li¡
, 
junk32
)è=ğ
NULL
)

461 
”r
;

463 
	`sÿm³r_cyşe_u£
(
Œaû
->
cyşe
);

471 
	`memıy
(&
junk32
, 
buf
+
i
, 4); i += 4;

472 
¹t
 = 
	`Áohl
(
junk32
);

473 if(
ah
->
v”
 < 2)

475 
¹t
 *= 1000000;

476 
	`memıy
(&
junk32
, 
buf
+
i
, 4); i += 4;

477 
¹t
 +ğ
	`Áohl
(
junk32
);

484 
hİ_di¡ªû
 = 
buf
[
i
++];

491 
junk8
 = 
buf
[
i
++];

492 
de¡š©iÚ_»¶›d
 = 
junk8
 >> 7;

494 if(
de¡š©iÚ_»¶›d
 != 0)

496 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_COMPLETED
;

498 
num_hİ_»cs
 = 
junk8
 & 0x7f;

504 if(
ah
->
v”
 > 1 || (
de¡š©iÚ_»¶›d
 != 0 &&‡h->ver == 1))

506 
h®t_»asÚ
 = 
buf
[
i
++];

507 
h®t_»asÚ_d©a
 = 
buf
[
i
++];

509 
h®t_»asÚ
)

511 
ARTS_STOP_NOHALT
:

512 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_NONE
;

515 
ARTS_STOP_ICMPUNREACH
:

516 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_UNREACH
;

519 
ARTS_STOP_LOOP
:

520 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_LOOP
;

523 
ARTS_STOP_GAPLIMIT
:

524 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_GAPLIMIT
;

528 
Œaû
->
¡İ_d©a
 = 
h®t_»asÚ_d©a
;

531 if(
num_hİ_»cs
 =ğ0 && 
de¡š©iÚ_»¶›d
 == 0)

533 
	`ä“
(
buf
);

534  
Œaû
;

541 if(
ah
->
v”
 >= 2)

543 
»¶y_‰l
 = 
buf
[
i
++];

546 if(
num_hİ_»cs
 > 0 &&

547 (
hİs
 = 
	`¬ts_hİs_»ad
(
ah
, 
buf
+
i
, 
num_hİ_»cs
, &i)è=ğ
NULL
)

549 
	`årštf
(
¡d”r
, "arts_read_trace:‡rts_hops_read %d failed\n",

550 
num_hİ_»cs
);

551 
”r
;

554 if(
de¡š©iÚ_»¶›d
 != 0)

556 
max_hİ
 = 
hİ_di¡ªû
;

558 
max_hİ
 = 0;

566 if((
hİ
 = 
hİs
è!ğ
NULL
)

570 if(
max_hİ
 < 
hİ
->
hİ_´obe_‰l
)

572 
max_hİ
 = 
hİ
->
hİ_´obe_‰l
;

575 if(
hİ
->
hİ_Ãxt
 =ğ
NULL
)

577 if(
Œaû
->
¡İ_»asÚ
 =ğ
SCAMPER_TRACE_STOP_UNREACH
)

579 
hİ
->
hİ_icmp_ty³
 = 
ICMP_UNREACH
;

580 
hİ
->
hİ_icmp_code
 = 
Œaû
->
¡İ_d©a
;

586 
hİ
 = hİ->
hİ_Ãxt
;

590 
	`as£¹
((
ušt32_t
)
i
 =ğ
ah
->
d©a_Ëngth
);

591 
	`ä“
(
buf
); buàğ
NULL
;

593 if(
max_hİ
 == 0)

595  
Œaû
;

598 if(
	`sÿm³r_Œaû_hİs_®loc
(
Œaû
, 
max_hİ
) == -1)

600 
”r
;

602 
Œaû
->
hİ_couÁ
 = 
max_hİ
;

609 if(
hİs
 !ğ
NULL
)

611 
Œaû
->
hİs
[hİs->
hİ_´obe_‰l
-1] = 
hİ
 = hops;

612 
hİ
->
hİ_Ãxt
 !ğ
NULL
)

614 if(
hİ
->
hİ_´obe_‰l
 !ğhİ->
hİ_Ãxt
->hop_probe_ttl)

616 
i
 = 
hİ
->
hİ_Ãxt
->
hİ_´obe_‰l
-1;

617 
Œaû
->
hİs
[
i
] = 
hİ
->
hİ_Ãxt
;

618 
hİ
->
hİ_Ãxt
 = 
NULL
;

619 
hİ
 = 
Œaû
->
hİs
[
i
];

621 
hİ
 = hİ->
hİ_Ãxt
;

623 
hİs
 = 
NULL
;

626 if(
de¡š©iÚ_»¶›d
 != 0)

628 if((
hİ
 = 
	`¬ts_hİ_»¶y
(
Œaû
->
d¡
, 
¹t
, 
hİ_di¡ªû
)è=ğ
NULL
)

630 
”r
;

633 if(
ah
->
v”
 >= 2)

635 
hİ
->
hİ_»¶y_‰l
 = 
»¶y_‰l
;

636 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_REPLY_TTL
;

639 
hİ
->
hİ_Ãxt
 = 
Œaû
->
hİs
[hİ->
hİ_´obe_‰l
-1];

640 
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1] = hop;

643  
Œaû
;

645 
”r
:

646 if(
hİs
 !ğ
NULL
è
	`¬ts_hİ_li¡_ä“
(hops);

647 if(
Œaû
 !ğ
NULL
è
	`sÿm³r_Œaû_ä“
(trace);

648 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

649  
NULL
;

650 
	}
}

652 
	$¬ts_sk
(
sÿm³r_fe_t
 *
sf
, 
ušt32_t
 
by‹s
)

654 
¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

655 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

656 
ušt8_t
 
buf
[512];

657 
size_t
 
Ën
;

659 if(
¡©e
->
i¥e
 == 0)

661 if(
	`l£ek
(
fd
, 
by‹s
, 
SEEK_CUR
) != -1)

666 if(
”ºo
 !ğ
ESPIPE
)

671 
¡©e
->
i¥e
 = 1;

674 
by‹s
 != 0)

676 
Ën
 = ((
buf
è< 
by‹s
) ? (buf) : bytes;

677 if(
	`»ad_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
) != 0)

681 
by‹s
 -ğ
Ën
;

685 
	}
}

692 
	$sÿm³r_fe_¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

693 
ušt16_t
 *
ty³
, **
d©a
)

695 
¬ts_h—d”_t
 
ah
;

696 
tmp
;

700 if((
tmp
 = 
	`¬ts_»ad_hdr
(
sf
, &
ah
)) == 0)

703 *
d©a
 = 
NULL
;

706 if(
tmp
 == -1)

712 if(
ah
.
id
 =ğ
ARTS_IP_PATH
 &&

713 
	`sÿm³r_fe_f‹r_is£t
(
f‹r
, 
SCAMPER_FILE_OBJ_TRACE
))

715 if((*
d©a
 = 
	`¬ts_»ad_Œaû
(
sf
, &
ah
)è=ğ
NULL
)

719 *
ty³
 = 
SCAMPER_FILE_OBJ_TRACE
;

725 if(
	`¬ts_sk
(
sf
, 
ah
.
d©a_Ëngth
) != 0)

732 
	}
}

734 
	$sÿm³r_fe_¬ts_is
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

736 
ušt16_t
 
magic16
;

737 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

739 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

744 if(
	`»ad_w¿p
(
fd
, &
magic16
, 
NULL
, (magic16)) != 0)

749 if(
	`Áohs
(
magic16
è=ğ
ARTS_MAGIC
)

751 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

759 
	}
}

761 
	$¬ts_¡©e_ä“
(
¬ts_¡©e_t
 *
¡©e
)

763 if(
¡©e
 =ğ
NULL
)

768 if(
¡©e
->
li¡_Œ“
 !ğ
NULL
)

770 
	`¥ÏyŒ“_ä“
(
¡©e
->
li¡_Œ“
, (
¥ÏyŒ“_ä“_t
)
sÿm³r_li¡_ä“
);

773 if(
¡©e
->
cyşe_Œ“
 !ğ
NULL
)

775 
	`¥ÏyŒ“_ä“
(
¡©e
->
cyşe_Œ“
, (
¥ÏyŒ“_ä“_t
)
sÿm³r_cyşe_ä“
);

778 
	`ä“
(
¡©e
);

780 
	}
}

782 
	$sÿm³r_fe_¬ts_š™_»ad
(
sÿm³r_fe_t
 *
sf
)

784 
¬ts_¡©e_t
 *
¡©e
;

786 if((
¡©e
 = (
¬ts_¡©e_t
 *)
	`m®loc_z”o
(×¹s_¡©e_t))è=ğ
NULL
)

788 
”r
;

791 if((
¡©e
->
li¡_Œ“
 = 
	`¥ÏyŒ“_®loc
(
¬ts_li¡_cmp
)è=ğ
NULL
)

793 
”r
;

796 if((
¡©e
->
cyşe_Œ“
 = 
	`¥ÏyŒ“_®loc
(
¬ts_cyşe_cmp
)è=ğ
NULL
)

798 
”r
;

801 
	`sÿm³r_fe_£t¡©e
(
sf
, 
¡©e
);

804 
”r
:

805 
	`¬ts_¡©e_ä“
(
¡©e
);

807 
	}
}

809 
	$sÿm³r_fe_¬ts_ä“_¡©e
(
sÿm³r_fe_t
 *
sf
)

811 
	`¬ts_¡©e_ä“
(
	`sÿm³r_fe_g‘¡©e
(
sf
));

813 
	}
}

	@scamper_file_arts.h

27 #iâdeà
_SCAMPER_FILE_ARTS_H


28 
	#_SCAMPER_FILE_ARTS_H


	)

30 
sÿm³r_fe_¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

31 
ušt16_t
 *
ty³
, **
d©a
);

33 
sÿm³r_fe_¬ts_is
(cÚ¡ 
sÿm³r_fe_t
 *
fe
);

35 
sÿm³r_fe_¬ts_š™_»ad
(
sÿm³r_fe_t
 *
fe
);

37 
sÿm³r_fe_¬ts_ä“_¡©e
(
sÿm³r_fe_t
 *
fe
);

	@scamper_file_text.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_fe_‹xt.h
"

39 
	~"uts.h
"

41 
	$sÿm³r_fe_‹xt_is
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

43 
buf
[10];

44 
fd
;

46 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

48 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

53 if(
	`»ad_w¿p
(
fd
, 
buf
, 
NULL
, (buf)) != 0)

58 if(
	`¡ºcmp
(
buf
, "traceroute", 10) == 0)

60 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

68 
	}
}

	@scamper_file_text.h

25 #iâdeà
_SCAMPER_FILE_TEXT_H


26 
	#_SCAMPER_FILE_TEXT_H


	)

28 
	gsÿm³r_Œaû
;

29 
sÿm³r_fe_‹xt_wr™e_Œaû
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

30 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

32 
	gsÿm³r_pšg
;

33 
sÿm³r_fe_‹xt_wr™e_pšg
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

34 cÚ¡ 
sÿm³r_pšg
 *
pšg
);

36 
	gsÿm³r_Œaûlb
;

37 
sÿm³r_fe_‹xt_wr™e_Œaûlb
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

38 cÚ¡ 
sÿm³r_Œaûlb
 *
Œaû
);

40 
	gsÿm³r_¡šg
;

41 
sÿm³r_fe_‹xt_wr™e_¡šg
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

42 cÚ¡ 
sÿm³r_¡šg
 *
¡šg
);

44 
	gsÿm³r_d—lŸs
;

45 
sÿm³r_fe_‹xt_wr™e_d—lŸs
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

46 cÚ¡ 
sÿm³r_d—lŸs
 *
d—lŸs
);

48 
	gsÿm³r_tb™
;

49 
sÿm³r_fe_‹xt_wr™e_tb™
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

50 cÚ¡ 
sÿm³r_tb™
 *
tb™
);

52 
	gsÿm³r_Œaûbox
;

53 
sÿm³r_fe_‹xt_wr™e_Œaûbox
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

54 cÚ¡ 
sÿm³r_Œaûbox
 *
Œaûbox
);

56 
	gsÿm³r_årštšg
;

57 
sÿm³r_fe_‹xt_wr™e_årštšg
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

58 cÚ¡ 
sÿm³r_årštšg
 *
årštšg
);

60 
sÿm³r_fe_‹xt_is
(cÚ¡ 
sÿm³r_fe_t
 *
sf
);

	@scamper_file_warts.c

28 #iâdeà
lšt


29 cÚ¡ 
	grcsid
[] =

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

36 
	~"š‹º®.h
"

38 
	~"sÿm³r_addr.h
"

39 
	~"sÿm³r_li¡.h
"

40 
	~"sÿm³r_fe.h
"

41 
	~"sÿm³r_fe_w¬ts.h
"

42 
	~"Œaû/sÿm³r_Œaû.h
"

43 
	~"Œaû/sÿm³r_Œaû_w¬ts.h
"

44 
	~"pšg/sÿm³r_pšg.h
"

45 
	~"pšg/sÿm³r_pšg_w¬ts.h
"

46 
	~"Œaûlb/sÿm³r_Œaûlb.h
"

47 
	~"Œaûlb/sÿm³r_Œaûlb_w¬ts.h
"

48 
	~"d—lŸs/sÿm³r_d—lŸs.h
"

49 
	~"d—lŸs/sÿm³r_d—lŸs_w¬ts.h
"

50 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc.h
"

51 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc_w¬ts.h
"

52 
	~"tb™/sÿm³r_tb™.h
"

53 
	~"tb™/sÿm³r_tb™_w¬ts.h
"

54 
	~"Œaûbox/sÿm³r_Œaûbox.h
"

55 
	~"Œaûbox/sÿm³r_Œaûbox_w¬ts.h
"

56 
	~"¡šg/sÿm³r_¡šg.h
"

57 
	~"¡šg/sÿm³r_¡šg_w¬ts.h
"

58 
	~"¢iff/sÿm³r_¢iff.h
"

59 
	~"¢iff/sÿm³r_¢iff_w¬ts.h
"

60 
	~"årštšg/sÿm³r_årštšg.h
"

61 
	~"årštšg/sÿm³r_årštšg_w¬ts.h
"

63 
	~"mjl_¥ÏyŒ“.h
"

64 
	~"uts.h
"

66 
	#WARTS_MAGIC
 0x1205

	)

67 
	#WARTS_HDRLEN
 8

	)

70 
	#WARTS_ADDR_TABLEGROW
 1000

	)

71 
	#WARTS_LIST_TABLEGROW
 1

	)

72 
	#WARTS_CYCLE_TABLEGROW
 1

	)

77 
	#WARTS_LIST_DESCR
 1

	)

78 
	#WARTS_LIST_MONITOR
 2

	)

79 cÚ¡ 
w¬ts_v¬_t
 
	gli¡_v¬s
[] =

81 {
WARTS_LIST_DESCR
, -1, -1},

82 {
WARTS_LIST_MONITOR
, -1, -1},

84 
	#li¡_v¬s_mfb
 
	`WARTS_VAR_MFB
(
li¡_v¬s
)

	)

89 
	#WARTS_CYCLE_STOP_TIME
 1

	)

90 
	#WARTS_CYCLE_HOSTNAME
 2

	)

91 cÚ¡ 
w¬ts_v¬_t
 
	gcyşe_v¬s
[] =

93 {
WARTS_CYCLE_STOP_TIME
, 4, -1},

94 {
WARTS_CYCLE_HOSTNAME
, -1, -1},

96 
	#cyşe_v¬s_mfb
 
	`WARTS_VAR_MFB
(
cyşe_v¬s
)

	)

98 (*
	tw¬ts_obj_»ad_t
)(
	tsÿm³r_fe_t
 *,cÚ¡ 
	tw¬ts_hdr_t
 *,**);

100 
	$æag_ij
(cÚ¡ 
id
, *
i
, *
j
)

102 if(
id
 % 7 == 0)

104 *
i
 = (
id
 / 7) - 1;

105 *
j
 = 7;

109 *
i
 = 
id
 / 7;

110 *
j
 = 
id
 % 7;

113 
	}
}

122 
	$æag_£t
(
ušt8_t
 *
æags
, cÚ¡ 
id
, *
max_id
)

124 
i
, 
j
;

126 
	`as£¹
(
id
 > 0);

127 
	`æag_ij
(
id
, &
i
, &
j
);

128 
æags
[
i
] |ğ(0x1 << (
j
-1));

130 if(
max_id
 !ğ
NULL
 && *max_id < 
id
)

131 *
max_id
 = 
id
;

134 
	}
}

136 
	$æag_is£t
(cÚ¡ 
ušt8_t
 *
æags
, cÚ¡ 
id
)

138 
i
, 
j
;

140 
	`as£¹
(
id
 > 0);

141 
	`æag_ij
(
id
, &
i
, &
j
);

143 if((
æags
[
i
] & (0x1 << (
j
-1))) == 0)

147 
	}
}

156 
ušt16_t
 
	$fŞd_æags
(
ušt8_t
 *
æags
, cÚ¡ 
max_id
)

158 
ušt16_t
 
i
, 
j
, 
k
;

161 if(
max_id
 == 0)

167 
j
 = 
max_id
 / 7;

168 if((
max_id
 % 7è!ğ0è
j
++;

174 
	`as£¹
(
j
 > 0);

177 
k
 = 
j
-1;

178 
i
=0; i<
k
; i++)

180 
æags
[
i
] |= 0x80;

183  
j
;

184 
	}
}

186 
	$w¬ts_¡r_size
(cÚ¡ *
¡r
)

188  
	`¡¾’
(
¡r
) + 1;

189 
	}
}

191 
	$w¬ts_addr_cmp
(cÚ¡ 
w¬ts_addr_t
 *
a
, cÚ¡ w¬ts_addr_ˆ*
b
)

193  
	`sÿm³r_addr_cmp
(
a
->
addr
, 
b
->addr);

194 
	}
}

196 
ušt32_t
 
	$w¬ts_addr_size
(
w¬ts_add¹abË_t
 *
t
, 
sÿm³r_addr_t
 *
addr
)

198 
w¬ts_addr_t
 
f
, *
wa
;

200 
f
.
addr
 =‡ddr;

201 if(
	`¬¿y_fšd
((**)
t
->
addrs
,->
addrc
, &
f
,

202 (
¬¿y_cmp_t
)
w¬ts_addr_cmp
è!ğ
NULL
)

207 if((
wa
 = 
	`m®loc_z”o
((
w¬ts_addr_t
))è!ğ
NULL
)

209 
wa
->
addr
 = 
	`sÿm³r_addr_u£
(addr);

210 
wa
->
id
 = 
t
->
addrc
;

212 if(
	`¬¿y_š£¹
((***)&
t
->
addrs
, &t->
addrc
, 
wa
,

213 (
¬¿y_cmp_t
)
w¬ts_addr_cmp
) != 0)

215 
	`ä“
(
wa
);

219  1 + 1 + 
	`sÿm³r_addr_size
(
addr
);

220 
	}
}

222 
	$w¬ts_add¹abË_ş—n
(
w¬ts_add¹abË_t
 *
bË
)

224 
i
;

225 if(
bË
->
addrs
 !ğ
NULL
)

227 
i
=0; i<
bË
->
addrc
; i++)

229 
	`sÿm³r_addr_ä“
(
bË
->
addrs
[
i
]->
addr
);

230 
	`ä“
(
bË
->
addrs
[
i
]);

232 
	`ä“
(
bË
->
addrs
);

235 
	}
}

237 
	$š£¹_addr
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

238 cÚ¡ 
sÿm³r_addr_t
 *
addr
, *
·¿m
)

240 
w¬ts_add¹abË_t
 *
bË
 = 
·¿m
;

241 
w¬ts_addr_t
 *
wa
, 
f
;

242 
ušt32_t
 
id
;

243 
size_t
 
size
;

245 
	`as£¹
(
bË
 !ğ
NULL
);

246 
	`as£¹
(
Ën
 - *
off
 >= 1 + 1);

248 
f
.
addr
 = (
sÿm³r_addr_t
 *)addr;

249 
wa
 = 
	`¬¿y_fšd
((**)
bË
->
addrs
,abË->
addrc
, &
f
,

250 (
¬¿y_cmp_t
)
w¬ts_addr_cmp
);

251 
	`as£¹
(
wa
 !ğ
NULL
);

253 if(
wa
->
Údisk
 == 0)

255 
size
 = 
	`sÿm³r_addr_size
(
addr
);

256 
buf
[(*
off
)++] = (
ušt8_t
)
size
;

257 
buf
[(*
off
)++] = 
addr
->
ty³
;

258 
	`memıy
(&
buf
[*
off
], 
addr
->addr, 
size
);

261 if(
wa
 !ğ
NULL
)

262 
wa
->
Údisk
 = 1;

266 
size
 = 4;

267 
id
 = 
	`htÚl
(
wa
->id);

268 
buf
[(*
off
)++] = 0;

269 
	`memıy
(&
buf
[*
off
], &
id
, 
size
);

272 *
off
 +ğ
size
;

274 
	}
}

276 
	$š£¹_ušt16
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

277 cÚ¡ 
ušt16_t
 *
š
, *
·¿m
)

279 
ušt16_t
 
tmp
 = 
	`htÚs
(*
š
);

280 
	`as£¹
(
Ën
 - *
off
 >= 2);

281 
	`memıy
(&
buf
[*
off
], &
tmp
, 2);

282 *
off
 += 2;

284 
	}
}

286 
	$š£¹_ušt32
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

287 cÚ¡ 
ušt32_t
 *
š
, *
·¿m
)

289 
ušt32_t
 
tmp
 = 
	`htÚl
(*
š
);

290 
	`as£¹
(
Ën
 - *
off
 >= 4);

291 
	`memıy
(&
buf
[*
off
], &
tmp
, 4);

292 *
off
 += 4;

294 
	}
}

296 
	$š£¹_w¬tshdr
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

297 
ušt16_t
 
hdr_ty³
)

299 cÚ¡ 
ušt16_t
 
hdr_magic
 = 
WARTS_MAGIC
;

300 
ušt32_t
 
hdr_Ën
 = 
Ën
 - 8;

301 
	`as£¹
(
Ën
 - *
off
 >= 8);

302 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
hdr_magic
, 
NULL
);

303 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
hdr_ty³
, 
NULL
);

304 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
hdr_Ën
, 
NULL
);

306 
	}
}

308 
	$š£¹_by‹
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

309 cÚ¡ 
ušt8_t
 *
š
, *
·¿m
)

311 
	`as£¹
(
Ën
 - *
off
 >= 1);

312 
buf
[(*
off
)++] = *
š
;

314 
	}
}

316 
	$š£¹_by‹s_ušt16
(
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

317 cÚ¡ *
vš
, 
ušt16_t
 *
couÁ
)

319 
	`as£¹
(
Ën
 - *
off
 >ğ*
couÁ
);

320 
	`memıy
(
buf
 + *
off
, 
vš
, *
couÁ
);

321 *
off
 +ğ*
couÁ
;

323 
	}
}

325 
	$š£¹_¡ršg
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

326 cÚ¡ *
š
, *
·¿m
)

328 
ušt8_t
 
c
;

329 
i
 = 0;

333 
	`as£¹
(
Ën
 - *
off
 > 0);

334 
buf
[(*
off
)++] = 
c
 = 
š
[
i
++];

336 
c
 != '\0');

339 
	}
}

347 
	$š£¹_timev®
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

348 cÚ¡ 
timev®
 *
š
, *
·¿m
)

350 
ušt32_t
 
t32
;

352 
	`as£¹
(
Ën
 - *
off
 >= 8);

354 
t32
 = 
	`htÚl
(
š
->
tv_£c
);

355 
	`memıy
(
buf
 + *
off
, &
t32
, 4); *off += 4;

357 
t32
 = 
	`htÚl
(
š
->
tv_u£c
);

358 
	`memıy
(
buf
 + *
off
, &
t32
, 4); *off += 4;

361 
	}
}

363 
	$š£¹_¹t
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

364 cÚ¡ 
timev®
 *
tv
, *
·¿m
)

366 
ušt32_t
 
t32
 = (
tv
->
tv_£c
 * 1000000è+v->
tv_u£c
;

367 
	`š£¹_ušt32
(
buf
, 
off
, 
Ën
, &
t32
, 
NULL
);

369 
	}
}

371 
	$exŒaù_addr
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

372 cÚ¡ 
ušt32_t
 
Ën
, 
sÿm³r_addr_t
 **
out
, *
·¿m
)

374 
w¬ts_add¹abË_t
 *
bË
 = 
·¿m
;

375 
w¬ts_addr_t
 *
wa
;

376 
ušt32_t
 
u32
;

377 
ušt8_t
 
size
;

378 
ušt8_t
 
ty³
;

380 
	`as£¹
(
bË
 !ğ
NULL
);

383 if(
Ën
 - *
off
 < 1)

387 
size
 = 
buf
[(*
off
)++];

393 if(
size
 == 0)

395 if(
Ën
 - *
off
 < 4)

398 
	`memıy
(&
u32
, &
buf
[*
off
], 4); u32 = 
	`Áohl
(u32);

399 *
out
 = 
	`sÿm³r_addr_u£
(
bË
->
addrs
[
u32
]->
addr
);

400 *
off
 += 4;

408 
ty³
 = 
buf
[(*
off
)++];

409 if((
wa
 = 
	`m®loc_z”o
((
w¬ts_addr_t
))è=ğ
NULL
 ||

410 (
wa
->
addr
 = 
	`sÿm³r_addr_®loc
(
ty³
, &
buf
[*
off
])è=ğ
NULL
 ||

411 
	`¬¿y_š£¹
((***)&
bË
->
addrs
, &bË->
addrc
, 
wa
, 
NULL
) != 0)

413 
”r
;

416 *
out
 = 
	`sÿm³r_addr_u£
(
wa
->
addr
);

417 *
off
 +ğ
size
;

420 
”r
:

421 if(
wa
 !ğ
NULL
)

423 if(
wa
->
addr
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(wa->addr);

424 
	`ä“
(
wa
);

427 
	}
}

429 
	$exŒaù_¡ršg
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

430 cÚ¡ 
ušt32_t
 
Ën
, **
out
, *
·¿m
)

432 
ušt32_t
 
i
;

434 
i
=*
off
; i<
Ën
; i++)

437 if(
buf
[
i
] == '\0')

439 if((*
out
 = 
	`memdup
(
buf
+*
off
, (
size_t
)(
i
-*off+1))è=ğ
NULL
)

444 *
off
 = 
i
+1;

450 
	}
}

452 
	$exŒaù_ušt32
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

453 cÚ¡ 
ušt32_t
 
Ën
, ušt32_ˆ*
out
, *
·¿m
)

455 if(
Ën
 - *
off
 < 4)

460 
	`memıy
(
out
, 
buf
 + *
off
, 4); *off += 4;

461 *
out
 = 
	`Áohl
(*out);

463 
	}
}

465 
	$exŒaù_ušt16
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

466 cÚ¡ 
ušt32_t
 
Ën
, 
ušt16_t
 *
out
, *
·¿m
)

468 if(
Ën
 - *
off
 < 2)

473 
	`memıy
(
out
, 
buf
 + *
off
, 2); *off += 2;

474 *
out
 = 
	`Áohs
(*out);

476 
	}
}

478 
	$exŒaù_by‹
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

479 cÚ¡ 
ušt32_t
 
Ën
, 
ušt8_t
 *
out
, *
·¿m
)

481 if(
Ën
 - *
off
 < 1)

486 *
out
 = 
buf
[(*
off
)++];

488 
	}
}

490 
	$exŒaù_by‹s_±r
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

491 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 **
out
,

492 
ušt16_t
 *
»q
)

494 if(
Ën
 - *
off
 < *
»q
)

497 if(*
»q
 > 0)

498 *
out
 = 
buf
 + *
off
;

500 *
out
 = 
NULL
;

501 *
off
 +ğ*
»q
;

504 
	}
}

506 
	$exŒaù_by‹s_®loc
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

507 cÚ¡ 
ušt32_t
 
Ën
, 
ušt8_t
 **
out
,

508 
ušt16_t
 *
»q
)

510 if(
Ën
 - *
off
 < *
»q
)

515 if(*
»q
 == 0)

517 *
out
 = 
NULL
;

521 if((*
out
 = 
	`m®loc
(*
»q
)è=ğ
NULL
)

526 
	`memıy
(*
out
, 
buf
 + *
off
, *
»q
);

527 *
off
 +ğ*
»q
;

531 
	}
}

538 
	$exŒaù_by‹s
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

539 
ušt8_t
 *
out
, 
ušt16_t
 *
»q
)

541 if(
Ën
 - *
off
 < *
»q
)

544 if(
»q
 == 0)

547 
	`memıy
(
out
, 
buf
 + *
off
, *
»q
);

548 *
off
 +ğ*
»q
;

551 
	}
}

553 
	$exŒaù_addr_gid
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

554 cÚ¡ 
ušt32_t
 
Ën
,

555 
sÿm³r_addr_t
 **
addr
, 
w¬ts_¡©e_t
 *
¡©e
)

557 
ušt32_t
 
id
;

559 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
id
, 
NULL
) != 0)

564 if(
id
 >ğ
¡©e
->
addr_couÁ
)

569 *
addr
 = 
	`sÿm³r_addr_u£
(
¡©e
->
addr_bË
[
id
]);

571 
	}
}

573 
	$exŒaù_li¡
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

574 cÚ¡ 
ušt32_t
 
Ën
,

575 
sÿm³r_li¡_t
 **
li¡
, 
w¬ts_¡©e_t
 *
¡©e
)

577 
ušt32_t
 
id
;

579 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
id
, 
NULL
) != 0)

584 if(
id
 >ğ
¡©e
->
li¡_couÁ
)

589 *
li¡
 = 
	`sÿm³r_li¡_u£
(
¡©e
->
li¡_bË
[
id
]->list);

591 
	}
}

593 
	$exŒaù_cyşe
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

594 cÚ¡ 
ušt32_t
 
Ën
,

595 
sÿm³r_cyşe_t
 **
cyşe
, 
w¬ts_¡©e_t
 *
¡©e
)

597 
ušt32_t
 
id
;

599 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
id
, 
NULL
) != 0)

604 if(
id
 >ğ
¡©e
->
cyşe_couÁ
)

609 *
cyşe
 = 
	`sÿm³r_cyşe_u£
(
¡©e
->
cyşe_bË
[
id
]->cycle);

611 
	}
}

613 
	$exŒaù_timev®
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

614 cÚ¡ 
ušt32_t
 
Ën
, 
timev®
 *
tv
, *
·¿m
)

616 
ušt32_t
 
t32
;

618 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t32
, 
NULL
) != 0)

622 
tv
->
tv_£c
 = 
t32
;

624 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t32
, 
NULL
) != 0)

628 
tv
->
tv_u£c
 = 
t32
;

631 
	}
}

633 
	$exŒaù_¹t
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

634 
timev®
 *
tv
, *
·¿m
)

636 
ušt32_t
 
t32
;

638 if(
	`exŒaù_ušt32
(
buf
, 
off
, 
Ën
, &
t32
, 
NULL
) != 0)

643 
tv
->
tv_£c
 = 
t32
 / 1000000;

644 
tv
->
tv_u£c
 = 
t32
 % 1000000;

646 
	}
}

648 
	$w¬ts_·¿ms_»ad
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

649 
w¬ts_·¿m_»ad”_t
 *
hªdËrs
, 
hªdËr_út
)

651 
w¬ts_·¿m_»ad”_t
 *
hªdËr
;

652 cÚ¡ 
ušt8_t
 *
æags
 = &
buf
[*
off
];

653 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

654 
ušt32_t
 
fš®_off
;

655 
ušt16_t
 
i
, 
j
;

656 
id
;

659 if(
æags
[0] == 0)

661 (*
off
)++;

666 
æags_Ën
 = 0;

667 (
buf
[*
off
] & 0x80è!ğ0 && *ofà< 
Ën
)

669 (*
off
)++; 
æags_Ën
++;

671 
æags_Ën
++; (*
off
)++;

672 if(*
off
 > 
Ën
)

674 
”r
;

678 if(
	`exŒaù_ušt16
(
buf
, 
off
, 
Ën
, &
·¿ms_Ën
, 
NULL
) != 0)

680 
”r
;

688 
fš®_off
 = *
off
 + 
·¿ms_Ën
;

691 
i
=0; i<
æags_Ën
; i++)

694 if((
æags
[
i
] & 0x7f) == 0)

700 
j
=0; j<7; j++)

703 if((
æags
[
i
] & (0x1 << 
j
)) == 0)

712 if((
id
 = (
i
*7)+
j
è>ğ
hªdËr_út
)

714 
dÚe
;

717 
hªdËr
 = &
hªdËrs
[
id
]; 
	`as£¹
(hªdËr->
»ad
 !ğ
NULL
);

718 if(
hªdËr
->
	`»ad
(
buf
, 
off
, 
Ën
, hªdËr->
d©a
, hªdËr->
·¿m
) == -1)

720 
”r
;

725 
dÚe
:

726 *
off
 = 
fš®_off
;

729 
”r
:

731 
	}
}

733 
	$w¬ts_·¿ms_wr™e
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

734 cÚ¡ 
ušt32_t
 
Ën
,

735 cÚ¡ 
ušt8_t
 *
æags
,

736 cÚ¡ 
ušt16_t
 
æags_Ën
,

737 cÚ¡ 
ušt16_t
 
·¿ms_Ën
,

738 cÚ¡ 
w¬ts_·¿m_wr™”_t
 *
hªdËrs
,

739 cÚ¡ 
hªdËr_út
)

741 
ušt16_t
 
i
, 
j
, 
tmp
;

742 
id
;

745 
tmp
 = 
æags_Ën
;

746 
	`š£¹_by‹s_ušt16
(
buf
, 
off
, 
Ën
, 
æags
, &
tmp
);

752 if(
æags
[0] != 0)

754 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
·¿ms_Ën
, 
NULL
);

758 
	`as£¹
(
·¿ms_Ën
 == 0);

763 
i
=0; i<
æags_Ën
; i++)

766 if((
æags
[
i
] & 0x7f) == 0)

772 
j
=0; j<7; j++)

775 if((
æags
[
i
] & (0x1 << 
j
)) == 0)

781 
id
 = (
i
*7)+
j
;

787 
	`as£¹
(
id
 < 
hªdËr_út
);

788 
	`as£¹
(
hªdËrs
[
id
].
wr™e
 !ğ
NULL
);

791 
hªdËrs
[
id
].
	`wr™e
(
buf
,
off
,
Ën
,hªdËrs[id].
d©a
,hªdËrs[id].
·¿m
);

796 
	}
}

805 
	$w¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
ušt8_t
 **
buf
, 
size_t
 
Ën
)

807 
sÿm³r_fe_»adfunc_t
 
rf
 = 
	`sÿm³r_fe_g‘»adfunc
(
sf
);

808 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

809 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

810 
ušt8_t
 *
tmp
 = 
NULL
;

811 
»t
;

812 
size_t
 
rc
;

814 *
buf
 = 
NULL
;

816 if(
rf
 !ğ
NULL
)

818 if((
»t
 = 
	`rf
(
	`sÿm³r_fe_g‘»ad·¿m
(
sf
), 
buf
, 
Ën
)) == 0 ||„et == -2)

820 if(
»t
 == -2)

821 
	`sÿm³r_fe_£‹of
(
sf
);

828 if(
¡©e
->
»adbuf
 !ğ
NULL
)

830 
	`as£¹
(
¡©e
->
»adbuf_Ën
 =ğ
Ën
);

833 if((
»t
 = 
	`»ad_w¿p
(
fd
, 
¡©e
->
»adbuf
 + s‹->
»adËn
, &
rc
,

834 
Ën
 - 
¡©e
->
»adËn
)) != 0)

837 
¡©e
->
»adËn
 +ğ
rc
;

843 if((
»t
 =ğ-1 && 
”ºo
 !ğ
EAGAIN
) ||„et == -2)

845 if(
»t
 == -2)

846 
	`sÿm³r_fe_£‹of
(
sf
);

857 *
buf
 = 
¡©e
->
»adbuf
;

858 
¡©e
->
»adËn
 = 0;

859 
¡©e
->
»adbuf
 = 
NULL
;

860 
¡©e
->
»adbuf_Ën
 = 0;

861 
¡©e
->
off
 +ğ
Ën
;

866 if((
tmp
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

870 if((
»t
 = 
	`»ad_w¿p
(
fd
, 
tmp
, &
rc
, 
Ën
)) == 0)

872 *
buf
 = 
tmp
;

873 
¡©e
->
off
 +ğ
Ën
;

878 if(
rc
 != 0)

880 
¡©e
->
»adËn
 = 
rc
;

881 
¡©e
->
»adbuf
 = 
tmp
;

882 
¡©e
->
»adbuf_Ën
 = 
Ën
;

886 
	`ä“
(
tmp
);

890 if(
»t
 == -2)

893 
	`sÿm³r_fe_£‹of
(
sf
);

896 if(
rc
 != 0)

903 if(
»t
 =ğ-1 && 
”ºo
 =ğ
EAGAIN
)

907 
	}
}

917 
	$w¬ts_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, cÚ¡ *
buf
, 
size_t
 
Ën
)

919 
sÿm³r_fe_wr™efunc_t
 
wf
 = 
	`sÿm³r_fe_g‘wr™efunc
(
sf
);

920 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

921 *
·¿m
;

922 
off_t
 
off
 = 0;

923 
fd
;

925 if(
wf
 =ğ
NULL
)

927 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

929 if(
¡©e
->
i¤eg
 && (
off
 = 
	`l£ek
(
fd
, 0, 
SEEK_CUR
)è=ğ(
off_t
)-1)

932 if(
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
) != 0)

938 if(
¡©e
->
i¤eg
)

940 if(
	`árunÿ‹
(
fd
, 
off
) != 0)

948 
·¿m
 = 
	`sÿm³r_fe_g‘wr™•¬am
(
sf
);

949  
	`wf
(
·¿m
, 
buf
, 
Ën
);

953 
	}
}

959 
	$w¬ts_hdr_»ad
(
sÿm³r_fe_t
 *
sf
, 
w¬ts_hdr_t
 *
hdr
)

961 cÚ¡ 
ušt32_t
 
Ën
 = 8;

962 
ušt8_t
 *
buf
 = 
NULL
;

963 
ušt32_t
 
off
 = 0;

965 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
Ën
) != 0)

967 
”r
;

969 if(
buf
 =ğ
NULL
)

975 
	`exŒaù_ušt16
(
buf
, &
off
, 
Ën
, &
hdr
->
magic
, 
NULL
);

976 
	`exŒaù_ušt16
(
buf
, &
off
, 
Ën
, &
hdr
->
ty³
, 
NULL
);

977 
	`exŒaù_ušt32
(
buf
, &
off
, 
Ën
, &
hdr
->Ën, 
NULL
);

978 
	`ä“
(
buf
);

980 
	`as£¹
(
off
 =ğ
Ën
);

983 
”r
:

985 
	}
}

998 
	$w¬ts_addr_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

999 
sÿm³r_addr_t
 **
addr_out
)

1001 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1002 
sÿm³r_addr_t
 *
addr
 = 
NULL
, **
bË
;

1003 
ušt8_t
 *
buf
 = 
NULL
;

1004 
size_t
 
size
;

1007 
	`as£¹
(
hdr
->
Ën
 > 2);

1009 if((
¡©e
->
addr_couÁ
 % 
WARTS_ADDR_TABLEGROW
) == 0)

1011 
size
 = (
sÿm³r_addr_t
 *)*(
¡©e
->
addr_couÁ
+
WARTS_ADDR_TABLEGROW
);

1012 if((
bË
 = 
	`»®loc
(
¡©e
->
addr_bË
, 
size
)è=ğ
NULL
)

1014 
”r
;

1016 
¡©e
->
addr_bË
 = 
bË
;

1020 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1022 
”r
;

1024 if(
buf
 =ğ
NULL
)

1026 if(
addr_out
 !ğ
NULL
)

1028 *
addr_out
 = 
NULL
;

1037 if(
¡©e
->
addr_couÁ
 % 255 !ğ
buf
[0])

1039 
”r
;

1043 if((
addr
 = 
	`sÿm³r_addr_®loc
(
buf
[1], buf+2)è=ğ
NULL
)

1045 
”r
;

1048 
¡©e
->
addr_bË
[¡©e->
addr_couÁ
++] = 
addr
;

1049 
	`ä“
(
buf
);

1051 if(
addr_out
 !ğ
NULL
)

1053 *
addr_out
 = 
addr
;

1058 
”r
:

1059 if(
addr
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(addr);

1060 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1062 
	}
}

1064 
	$w¬ts_li¡_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

1066 cÚ¡ 
w¬ts_li¡_t
 *
wa
 = (cÚ¡ w¬ts_li¡_ˆ*)
va
;

1067 cÚ¡ 
w¬ts_li¡_t
 *
wb
 = (cÚ¡ w¬ts_li¡_ˆ*)
vb
;

1068  
	`sÿm³r_li¡_cmp
(
wa
->
li¡
, 
wb
->list);

1069 
	}
}

1071 
w¬ts_li¡_t
 *
	$w¬ts_li¡_®loc
(
sÿm³r_li¡_t
 *
li¡
, 
ušt32_t
 
id
)

1073 
w¬ts_li¡_t
 *
wl
;

1074 if((
wl
 = 
	`m®loc_z”o
((
w¬ts_li¡_t
))è!ğ
NULL
)

1076 
wl
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

1077 
wl
->
id
 = id;

1079  
wl
;

1080 
	}
}

1082 
	$w¬ts_li¡_ä“
(
w¬ts_li¡_t
 *
wl
)

1084 if(
wl
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(wl->list);

1085 
	`ä“
(
wl
);

1087 
	}
}

1097 
	$w¬ts_li¡_·¿ms
(cÚ¡ 
sÿm³r_li¡_t
 *
li¡
, 
ušt8_t
 *
æags
,

1098 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

1100 
max_id
 = 0;

1103 
	`mem£t
(
æags
, 0, 
li¡_v¬s_mfb
);

1104 *
·¿ms_Ën
 = 0;

1106 if(
li¡
->
desü
 !ğ
NULL
)

1108 
	`æag_£t
(
æags
, 
WARTS_LIST_DESCR
, &
max_id
);

1109 *
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
li¡
->
desü
);

1112 if(
li¡
->
mÚ™Ü
 !ğ
NULL
)

1114 
	`æag_£t
(
æags
, 
WARTS_LIST_MONITOR
, &
max_id
);

1115 *
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
li¡
->
mÚ™Ü
);

1118 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

1121 
	}
}

1127 
	$w¬ts_li¡_·¿ms_»ad
(
sÿm³r_li¡_t
 *
li¡
,

1128 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1130 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1131 {&
li¡
->
desü
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

1132 {&
li¡
->
mÚ™Ü
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

1134 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1136  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

1137 
	}
}

1139 
	$w¬ts_li¡_·¿ms_wr™e
(cÚ¡ 
sÿm³r_li¡_t
 *
li¡
,

1140 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1141 cÚ¡ 
ušt32_t
 
Ën
,

1142 cÚ¡ 
ušt8_t
 *
æags
,

1143 cÚ¡ 
ušt16_t
 
æags_Ën
,

1144 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

1146 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1147 {
li¡
->
desü
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

1148 {
li¡
->
mÚ™Ü
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

1150 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1152 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

1153 
hªdËr_út
);

1155 
	}
}

1166 
	$w¬ts_li¡_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1167 
sÿm³r_li¡_t
 **
li¡_out
)

1169 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1170 
sÿm³r_li¡_t
 *
li¡
 = 
NULL
;

1171 
w¬ts_li¡_t
 *
wl
 = 
NULL
, **
bË
;

1172 
ušt8_t
 *
buf
 = 
NULL
;

1173 
size_t
 
size
;

1174 
ušt32_t
 
i
 = 0;

1175 
ušt32_t
 
id
;

1181 if(
hdr
->
Ën
 < 4 + 4 + 2 + 1)

1183 
”r
;

1186 if((
¡©e
->
li¡_couÁ
 % 
WARTS_LIST_TABLEGROW
) == 0)

1188 
size
 = (
w¬ts_li¡_t
 *)*(
¡©e
->
li¡_couÁ
 + 
WARTS_LIST_TABLEGROW
);

1189 if((
bË
 = 
	`»®loc
(
¡©e
->
li¡_bË
, 
size
)è=ğ
NULL
)

1191 
”r
;

1193 
¡©e
->
li¡_bË
 = 
bË
;

1197 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1199 
”r
;

1201 if(
buf
 =ğ
NULL
)

1203 if(
li¡_out
 !ğ
NULL
)

1205 *
li¡_out
 = 
NULL
;

1211 if((
li¡
 = 
	`m®loc_z”o
((
sÿm³r_li¡_t
))è=ğ
NULL
)

1213 
”r
;

1215 
li¡
->
»fút
 = 1;

1221 if(
	`exŒaù_ušt32
(
buf
, &
i
, 
hdr
->
Ën
, &
id
, 
NULL
) != 0 ||

1222 
id
 !ğ
¡©e
->
li¡_couÁ
)

1224 
”r
;

1228 if(
	`exŒaù_ušt32
(
buf
, &
i
, 
hdr
->
Ën
, &
li¡
->
id
, 
NULL
) != 0 ||

1229 
	`exŒaù_¡ršg
(
buf
, &
i
, 
hdr
->
Ën
, &
li¡
->
Çme
, 
NULL
) != 0)

1231 
”r
;

1234 if(
	`w¬ts_li¡_·¿ms_»ad
(
li¡
, 
buf
, &
i
, 
hdr
->
Ën
) != 0)

1236 
”r
;

1239 if((
wl
 = 
	`w¬ts_li¡_®loc
(
li¡
, 
¡©e
->
li¡_couÁ
)è=ğ
NULL
)

1241 
”r
;

1244 
¡©e
->
li¡_bË
[¡©e->
li¡_couÁ
++] = 
wl
;

1245 
	`sÿm³r_li¡_ä“
(
li¡
);

1246 
	`ä“
(
buf
);

1248 if(
li¡_out
 !ğ
NULL
)

1250 *
li¡_out
 = 
li¡
;

1254 
”r
:

1255 if(
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(list);

1256 if(
wl
 !ğ
NULL
è
	`w¬ts_li¡_ä“
(wl);

1257 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1259 
	}
}

1266 
	$w¬ts_li¡_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_li¡_t
 *
li¡
,

1267 
ušt32_t
 *
id
)

1269 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1270 
w¬ts_li¡_t
 *
wl
 = 
NULL
;

1271 
ušt8_t
 *
buf
 = 
NULL
;

1272 
ušt8_t
 
æags
[
li¡_v¬s_mfb
];

1273 
ušt32_t
 
off
 = 0, 
Ën
;

1274 
ušt16_t
 
Çme_Ën
, 
æags_Ën
, 
·¿ms_Ën
;

1277 if(
li¡
->
Çme
 =ğ
NULL
)

1279 
”r
;

1283 if((
wl
 = 
	`w¬ts_li¡_®loc
(
li¡
, 
¡©e
->
li¡_couÁ
)è=ğ
NULL
)

1285 
”r
;

1289 
Çme_Ën
 = 
	`¡¾’
(
li¡
->
Çme
) + 1;

1290 
	`w¬ts_li¡_·¿ms
(
li¡
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

1291 
Ën
 = 8 + 4 + 4 + 
Çme_Ën
 + 
æags_Ën
 + 
·¿ms_Ën
;

1292 if(
·¿ms_Ën
 !ğ0è
Ën
 += 2;

1295 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1297 
”r
;

1300 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_LIST
);

1303 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
wl
->
id
, 
NULL
);

1306 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
li¡
->
id
, 
NULL
);

1309 
	`š£¹_by‹s_ušt16
(
buf
, &
off
, 
Ën
, 
li¡
->
Çme
, &
Çme_Ën
);

1312 
	`w¬ts_li¡_·¿ms_wr™e
(
li¡
, 
buf
, &
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
);

1314 
	`as£¹
(
off
 =ğ
Ën
);

1316 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
li¡_Œ“
, 
wl
è=ğ
NULL
)

1318 
”r
;

1322 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

1324 
”r
;

1327 
¡©e
->
li¡_couÁ
++;

1328 *
id
 = 
wl
->id;

1329 
	`ä“
(
buf
);

1332 
”r
:

1333 if(
wl
 !ğ
NULL
)

1335 
	`¥ÏyŒ“_»move_™em
(
¡©e
->
li¡_Œ“
, 
wl
);

1336 
	`w¬ts_li¡_ä“
(
wl
);

1338 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1340 
	}
}

1348 
	$w¬ts_li¡_g‘id
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_li¡_t
 *
li¡
,

1349 
ušt32_t
 *
id
)

1351 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1352 
w¬ts_li¡_t
 
fšdme
, *
wl
;

1354 if(
li¡
 =ğ
NULL
)

1356 *
id
 = 0;

1361 
fšdme
.
li¡
 =†ist;

1362 if((
wl
 = 
	`¥ÏyŒ“_fšd
(
¡©e
->
li¡_Œ“
, &
fšdme
)è!ğ
NULL
)

1364 *
id
 = 
wl
->id;

1369 if(
	`w¬ts_li¡_wr™e
(
sf
, 
li¡
, 
id
) == 0)

1375 
	}
}

1377 
	$w¬ts_cyşe_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

1379 cÚ¡ 
w¬ts_cyşe_t
 *
a
 = (cÚ¡ w¬ts_cyşe_ˆ*)
va
;

1380 cÚ¡ 
w¬ts_cyşe_t
 *
b
 = (cÚ¡ w¬ts_cyşe_ˆ*)
vb
;

1381  
	`sÿm³r_cyşe_cmp
(
a
->
cyşe
, 
b
->cycle);

1382 
	}
}

1384 
w¬ts_cyşe_t
 *
	$w¬ts_cyşe_®loc
(
sÿm³r_cyşe_t
 *
cyşe
, 
ušt32_t
 
id
)

1386 
w¬ts_cyşe_t
 *
wc
;

1387 if((
wc
 = 
	`m®loc_z”o
((
w¬ts_cyşe_t
))è!ğ
NULL
)

1389 
wc
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

1390 
wc
->
id
 = id;

1392  
wc
;

1393 
	}
}

1395 
	$w¬ts_cyşe_ä“
(
w¬ts_cyşe_t
 *
cyşe
)

1397 if(
cyşe
->cyş!ğ
NULL
è
	`sÿm³r_cyşe_ä“
(cycle->cycle);

1398 
	`ä“
(
cyşe
);

1400 
	}
}

1402 
	$w¬ts_cyşe_·¿ms
(cÚ¡ 
sÿm³r_cyşe_t
 *
cyşe
, 
ušt8_t
 *
æags
,

1403 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

1405 
max_id
;

1408 
	`mem£t
(
æags
, 0, 
cyşe_v¬s_mfb
);

1409 
max_id
 = 0;

1411 *
·¿ms_Ën
 = 0;

1413 if(
cyşe
->
ho¡Çme
 !ğ
NULL
)

1415 
	`æag_£t
(
æags
, 
WARTS_CYCLE_HOSTNAME
, &
max_id
);

1416 *
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
cyşe
->
ho¡Çme
);

1419 if(
cyşe
->
¡İ_time
 != 0)

1421 
	`æag_£t
(
æags
, 
WARTS_CYCLE_STOP_TIME
, &
max_id
);

1422 *
·¿ms_Ën
 += 4;

1426 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

1429 
	}
}

1431 
	$w¬ts_cyşe_·¿ms_wr™e
(cÚ¡ 
sÿm³r_cyşe_t
 *
cyşe
,

1432 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

1433 cÚ¡ 
ušt32_t
 
Ën
,

1434 cÚ¡ 
ušt8_t
 *
æags
,

1435 cÚ¡ 
ušt16_t
 
æags_Ën
,

1436 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

1438 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1439 {&
cyşe
->
¡İ_time
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

1440 {
cyşe
->
ho¡Çme
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

1442 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1443 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

1444 
hªdËr_út
);

1446 
	}
}

1448 
	$w¬ts_cyşe_·¿ms_»ad
(
sÿm³r_cyşe_t
 *
cyşe
,

1449 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1451 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1452 {&
cyşe
->
¡İ_time
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

1453 {&
cyşe
->
ho¡Çme
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

1455 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1456  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

1457 
	}
}

1468 
	$w¬ts_cyşe_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1469 
sÿm³r_cyşe_t
 **
cyşe_out
)

1471 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1472 
sÿm³r_cyşe_t
 *
cyşe
 = 
NULL
;

1473 
w¬ts_cyşe_t
 *
wc
 = 
NULL
, **
bË
;

1474 
size_t
 
size
;

1475 
ušt8_t
 *
buf
 = 
NULL
;

1476 
ušt32_t
 
id
;

1477 
ušt32_t
 
off
 = 0;

1480 if(
hdr
->
Ën
 < 4 + 4 + 4 + 4 + 1)

1482 
”r
;

1485 if((
¡©e
->
cyşe_couÁ
 % 
WARTS_CYCLE_TABLEGROW
) == 0)

1487 
size
 = (
w¬ts_li¡_t
 *)*(
¡©e
->
cyşe_couÁ
+
WARTS_CYCLE_TABLEGROW
);

1488 if((
bË
 = 
	`»®loc
(
¡©e
->
cyşe_bË
, 
size
)è=ğ
NULL
)

1490 
”r
;

1492 
¡©e
->
cyşe_bË
 = 
bË
;

1496 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1498 
”r
;

1500 if(
buf
 =ğ
NULL
)

1502 if(
cyşe_out
 !ğ
NULL
)

1504 *
cyşe_out
 = 
NULL
;

1513 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
id
, 
NULL
) != 0 ||

1514 
id
 !ğ
¡©e
->
cyşe_couÁ
)

1516 
”r
;

1520 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
id
, 
NULL
) != 0 ||

1521 
id
 >ğ
¡©e
->
li¡_couÁ
)

1523 
”r
;

1526 if((
cyşe
 = 
	`sÿm³r_cyşe_®loc
(
¡©e
->
li¡_bË
[
id
]->
li¡
)è=ğ
NULL
)

1528 
”r
;

1535 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
cyşe
->
id
, 
NULL
) != 0 ||

1536 
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
cyşe
->
¡¬t_time
, 
NULL
) != 0)

1538 
”r
;

1541 if(
	`w¬ts_cyşe_·¿ms_»ad
(
cyşe
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1543 
”r
;

1546 if((
wc
 = 
	`w¬ts_cyşe_®loc
(
cyşe
, 
¡©e
->
cyşe_couÁ
)è=ğ
NULL
)

1548 
”r
;

1551 
¡©e
->
cyşe_bË
[¡©e->
cyşe_couÁ
++] = 
wc
;

1552 
	`sÿm³r_cyşe_ä“
(
cyşe
);

1553 
	`ä“
(
buf
);

1555 if(
cyşe_out
 !ğ
NULL
)

1557 *
cyşe_out
 = 
cyşe
;

1562 
”r
:

1563 if(
cyşe
 !ğ
NULL
)

1565 if(
cyşe
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(cycle->list);

1566 
	`ä“
(
cyşe
);

1568 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1570 
	}
}

1584 
	$w¬ts_cyşe_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
,

1585 cÚ¡ 
ty³
, 
ušt32_t
 *
id
)

1587 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1588 
w¬ts_cyşe_t
 *
wc
 = 
NULL
;

1589 
ušt32_t
 
w¬ts_li¡_id
;

1590 
ušt8_t
 *
buf
 = 
NULL
;

1591 
ušt8_t
 
æags
[
cyşe_v¬s_mfb
];

1592 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

1593 
ušt32_t
 
off
 = 0, 
Ën
;

1596 if(
	`w¬ts_li¡_g‘id
(
sf
, 
cyşe
->
li¡
, &
w¬ts_li¡_id
) == -1)

1598 
”r
;

1602 if((
wc
 = 
	`w¬ts_cyşe_®loc
(
cyşe
, 
¡©e
->
cyşe_couÁ
)è=ğ
NULL
)

1604 
”r
;

1608 
	`w¬ts_cyşe_·¿ms
(
cyşe
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

1611 
Ën
 = 8 + 4 + 4 + 4 + 4 + 
æags_Ën
 + 
·¿ms_Ën
;

1612 if(
·¿ms_Ën
 !ğ0è
Ën
 += 2;

1613 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1615 
”r
;

1619 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
ty³
);

1622 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
wc
->
id
, 
NULL
);

1623 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
w¬ts_li¡_id
, 
NULL
);

1626 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
cyşe
->
id
, 
NULL
);

1627 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
cyşe
->
¡¬t_time
, 
NULL
);

1630 
	`w¬ts_cyşe_·¿ms_wr™e
(
cyşe
, 
buf
,&
off
,
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
);

1632 
	`as£¹
(
off
 =ğ
Ën
);

1634 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
cyşe_Œ“
, 
wc
è=ğ
NULL
)

1636 
”r
;

1639 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

1641 
”r
;

1644 if(
id
 !ğ
NULL
è*id = 
wc
->id;

1645 
¡©e
->
cyşe_couÁ
++;

1646 
	`ä“
(
buf
);

1650 
”r
:

1651 if(
wc
 !ğ
NULL
)

1653 
	`¥ÏyŒ“_»move_™em
(
¡©e
->
cyşe_Œ“
, 
wc
);

1654 
	`w¬ts_cyşe_ä“
(
wc
);

1656 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1658 
	}
}

1666 
	$w¬ts_cyşe_¡İ_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1667 
sÿm³r_cyşe_t
 **
cyşe_out
)

1669 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1670 
sÿm³r_cyşe_t
 *
cyşe
;

1671 
ušt32_t
 
off
 = 0;

1672 
ušt32_t
 
id
;

1673 
ušt8_t
 *
buf
 = 
NULL
;

1675 if(
hdr
->
Ën
 < 4 + 4 + 1)

1677 
”r
;

1680 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1682 
”r
;

1684 if(
buf
 =ğ
NULL
)

1686 if(
cyşe_out
 !ğ
NULL
)

1688 *
cyşe_out
 = 
NULL
;

1700 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
id
, 
NULL
) != 0 ||

1701 
id
 >ğ
¡©e
->
cyşe_couÁ
 || id =ğ0 || s‹->
cyşe_bË
[id] =ğ
NULL
)

1703 
”r
;

1707 
cyşe
 = 
¡©e
->
cyşe_bË
[
id
]->cycle;

1708 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
cyşe
->
¡İ_time
, 
NULL
) != 0)

1710 
”r
;

1717 if(
cyşe_out
 !ğ
NULL
)

1719 *
cyşe_out
 = 
	`sÿm³r_cyşe_u£
(
cyşe
);

1721 
	`w¬ts_cyşe_ä“
(
¡©e
->
cyşe_bË
[
id
]);

1722 
¡©e
->
cyşe_bË
[
id
] = 
NULL
;

1724 
	`ä“
(
buf
);

1728 
”r
:

1729 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1731 
	}
}

1733 
	$w¬ts_cyşe_g‘id
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
,

1734 
ušt32_t
 *
id
)

1736 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1737 
w¬ts_cyşe_t
 
fšdme
, *
wc
;

1740 if(
cyşe
 =ğ
NULL
)

1742 *
id
 = 0;

1747 
fšdme
.
cyşe
 = cycle;

1748 if((
wc
 = 
	`¥ÏyŒ“_fšd
(
¡©e
->
cyşe_Œ“
, &
fšdme
)è!ğ
NULL
)

1750 *
id
 = 
wc
->id;

1754 if(
	`w¬ts_cyşe_wr™e
(
sf
, 
cyşe
, 
SCAMPER_FILE_OBJ_CYCLE_DEF
, 
id
) == 0)

1760 
	}
}

1772 
	$w¬ts_cyşe_¡İ_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1773 
sÿm³r_cyşe_t
 *
cyşe
)

1775 
ušt32_t
 
wc_id
;

1776 
ušt8_t
 *
buf
 = 
NULL
;

1777 
ušt32_t
 
off
 = 0, 
Ën
;

1778 
ušt8_t
 
æag
 = 0;

1780 
	`as£¹
(
cyşe
 !ğ
NULL
);

1782 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
cyşe
, &
wc_id
) != 0)

1784 
”r
;

1787 
Ën
 = 8 + 4 + 4 + 1;

1788 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1790 
”r
;

1793 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_CYCLE_STOP
);

1794 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
wc_id
, 
NULL
);

1795 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
cyşe
->
¡İ_time
, 
NULL
);

1796 
	`š£¹_by‹
(
buf
, &
off
, 
Ën
, &
æag
, 
NULL
);

1798 
	`as£¹
(
off
 =ğ
Ën
);

1800 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

1802 
”r
;

1805 
	`ä“
(
buf
);

1808 
”r
:

1809 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1811 
	}
}

1813 
	$w¬ts_icm³xt_»ad
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

1814 
sÿm³r_icm³xt_t
 **
exts
)

1816 
sÿm³r_icm³xt_t
 *
›
, *
Ãxt
 = 
NULL
;

1817 
ušt16_t
 
tmp
;

1818 
ušt16_t
 
u16
;

1819 
ušt8_t
 
ú
, 
ù
;

1822 if(
Ën
 - *
off
 < 2)

1828 
	`memıy
(&
tmp
, &
buf
[*
off
], 2);

1829 
tmp
 = 
	`Áohs
(tmp);

1831 *
off
 += 2;

1833 
	`as£¹
(
tmp
 > 0);

1836 if(
Ën
 - *
off
 < 
tmp
)

1841 
tmp
 >= 4)

1843 
	`memıy
(&
u16
, &
buf
[*
off
], 2); u16 = 
	`Áohs
(u16);

1844 if(
Ën
 - *
off
 < (
ušt32_t
)(
u16
 + 2 + 1 + 1))

1848 
ú
 = 
buf
[*
off
+2];

1849 
ù
 = 
buf
[*
off
+3];

1851 if((
›
 = 
	`sÿm³r_icm³xt_®loc
(
ú
, 
ù
, 
u16
, &
buf
[*
off
+4])è=ğ
NULL
)

1856 if(
Ãxt
 =ğ
NULL
)

1858 *
exts
 = 
›
;

1862 
Ãxt
->
›_Ãxt
 = 
›
;

1864 
Ãxt
 = 
›
;

1866 *
off
 +ğ(2 + 1 + 1 + 
u16
);

1867 
tmp
 -ğ(2 + 1 + 1 + 
u16
);

1870 
	`as£¹
(
tmp
 == 0);

1872 
	}
}

1874 
	$w¬ts_icm³xt_wr™e
(
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

1875 cÚ¡ 
sÿm³r_icm³xt_t
 *
exts
)

1877 cÚ¡ 
sÿm³r_icm³xt_t
 *
›
;

1878 
ušt16_t
 
tmp
 = 0;

1879 
ušt16_t
 
u16
;

1881 
›
=
exts
; i!ğ
NULL
; iğ›->
›_Ãxt
)

1883 
	`as£¹
(*
off
 + 
tmp
 + 1 + 1 + 2 + 
›
->
›_dl
 <ğ
Ën
);

1886 
u16
 = 
	`htÚs
(
›
->
›_dl
);

1887 
	`memıy
(&
buf
[*
off
 + 2 + 
tmp
], &
u16
, 2);mp += 2;

1890 
buf
[*
off
 + 2 + 
tmp
] = 
›
->
›_ú
;mp++;

1891 
buf
[*
off
 + 2 + 
tmp
] = 
›
->
›_ù
;mp++;

1894 if(
›
->
›_dl
 != 0)

1896 
	`memıy
(&
buf
[*
off
 + 2 + 
tmp
], 
›
->
›_d©a
, ie->
›_dl
);

1897 
tmp
 +ğ
›
->
›_dl
;

1902 
u16
 = 
	`htÚs
(
tmp
);

1903 
	`memıy
(&
buf
[*
off
], &
u16
, 2);

1904 *
off
 = *ofà+ 2 + 
tmp
;

1907 
	}
}

1913 
	$sÿm³r_fe_w¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

1914 
ušt16_t
 *
ty³
, **
d©a
)

1916 cÚ¡ 
w¬ts_obj_»ad_t
 
obj»ad
[] =

1918 
NULL
,

1919 (
w¬ts_obj_»ad_t
)
w¬ts_li¡_»ad
,

1920 (
w¬ts_obj_»ad_t
)
w¬ts_cyşe_»ad
,

1921 (
w¬ts_obj_»ad_t
)
w¬ts_cyşe_»ad
,

1922 (
w¬ts_obj_»ad_t
)
w¬ts_cyşe_¡İ_»ad
,

1923 (
w¬ts_obj_»ad_t
)
w¬ts_addr_»ad
,

1924 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_Œaû_»ad
,

1925 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_pšg_»ad
,

1926 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_Œaûlb_»ad
,

1927 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_d—lŸs_»ad
,

1928 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_Ãighbourdisc_»ad
,

1929 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_tb™_»ad
,

1930 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_Œaûbox_»ad
,

1931 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_¡šg_»ad
,

1932 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_¢iff_»ad
,

1933 (
w¬ts_obj_»ad_t
)
sÿm³r_fe_w¬ts_årštšg_»ad
,

1935 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1936 
w¬ts_hdr_t
 
hdr
;

1937 
isf‹r
;

1938 
tmp
;

1939 
ušt8_t
 *
buf
;

1940 *
±r
;

1941 
offs
[16];

1949 if(
¡©e
->
hdr
.
ty³
 == 0)

1952 if((
tmp
 = 
	`w¬ts_hdr_»ad
(
sf
, &
hdr
)) == 0)

1954 *
d©a
 = 
NULL
;

1959 if(
tmp
 =ğ-1 || 
hdr
.
magic
 !ğ
WARTS_MAGIC
 || hdr.
ty³
 == 0)

1960 
”r
;

1964 
hdr
 = 
¡©e
->hdr;

1971 if((
isf‹r
 = 
	`sÿm³r_fe_f‹r_is£t
(
f‹r
, 
hdr
.
ty³
)) == 1)

1972 *
ty³
 = 
hdr
.type;

1973 *
d©a
 = 
NULL
;

1975 if(
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_ADDR
 ||

1976 
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_LIST
 ||

1977 
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_CYCLE_DEF
 ||

1978 
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_CYCLE_START
 ||

1979 
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_CYCLE_STOP
)

1981 if(
obj»ad
[
hdr
.
ty³
](
sf
, &hdr, &
±r
) != 0)

1982 
”r
;

1984 if(
±r
 =ğ
NULL
)

1987 
¡©e
->
hdr
 = hdr;

1991 
	`mem£t
(&
¡©e
->
hdr
, 0, (state->hdr));

1993 if(
isf‹r
 != 0)

1995 
hdr
.
ty³
)

1997 
SCAMPER_FILE_OBJ_ADDR
:

1998 *
d©a
 = 
	`sÿm³r_addr_u£
((
sÿm³r_addr_t
 *)
±r
);

2000 
SCAMPER_FILE_OBJ_LIST
:

2001 *
d©a
 = 
	`sÿm³r_li¡_u£
((
sÿm³r_li¡_t
 *)
±r
);

2003 
SCAMPER_FILE_OBJ_CYCLE_DEF
:

2004 
SCAMPER_FILE_OBJ_CYCLE_START
:

2005 *
d©a
 = 
	`sÿm³r_cyşe_u£
((
sÿm³r_cyşe_t
 *)
±r
);

2007 
SCAMPER_FILE_OBJ_CYCLE_STOP
:

2008 *
d©a
 = 
±r
;

2014 if(
hdr
.
ty³
 =ğ
SCAMPER_FILE_OBJ_CYCLE_STOP
)

2015 
	`sÿm³r_cyşe_ä“
((
sÿm³r_cyşe_t
 *)
±r
);

2017 if(
isf‹r
 == 0)

2020 
buf
 = 
NULL
;

2021 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
.
Ën
) != 0)

2022 
”r
;

2023 if(
buf
 =ğ
NULL
)

2026 
¡©e
->
hdr
 = hdr;

2029 
	`ä“
(
buf
);

2030 
	`mem£t
(&
¡©e
->
hdr
, 0, (state->hdr));

2034 if(
hdr
.
ty³
 >ğ(
obj»ad
)/(
w¬ts_obj_»ad_t
) ||

2035 
obj»ad
[
hdr
.
ty³
] =ğ
NULL
 ||

2036 
obj»ad
[
hdr
.
ty³
](
sf
, &hdr, 
d©a
) != 0)

2037 
”r
;

2039 if(*
d©a
 !ğ
NULL
)

2040 
	`mem£t
(&
¡©e
->
hdr
, 0, (state->hdr));

2042 
¡©e
->
hdr
 = hdr;

2049 
”r
:

2050 
	`årštf
(
¡d”r
,

2052 
	`ofá_to¡r
(
offs
, (offs), 
¡©e
->
off
, 8, 'x'),

2053 
hdr
.
magic
, hdr.
ty³
, hdr.
Ën
);

2055 
	}
}

2057 
	$sÿm³r_fe_w¬ts_cyşe¡¬t_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

2058 
sÿm³r_cyşe_t
 *
c
)

2060  
	`w¬ts_cyşe_wr™e
(
sf
, 
c
, 
SCAMPER_FILE_OBJ_CYCLE_START
, 
NULL
);

2061 
	}
}

2063 
	$sÿm³r_fe_w¬ts_cyşe¡İ_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

2064 
sÿm³r_cyşe_t
 *
c
)

2066  
	`w¬ts_cyşe_¡İ_wr™e
(
sf
, 
c
);

2067 
	}
}

2077 
	$sÿm³r_fe_w¬ts_š™_»ad
(
sÿm³r_fe_t
 *
sf
)

2079 
w¬ts_¡©e_t
 *
¡©e
;

2080 
size_t
 
size
;

2082 if((
¡©e
 = (
w¬ts_¡©e_t
 *)
	`m®loc_z”o
((w¬ts_¡©e_t))è=ğ
NULL
)

2084 
”r
;

2087 
size
 = (
sÿm³r_addr_t
 *è* 
WARTS_ADDR_TABLEGROW
;

2088 if((
¡©e
->
addr_bË
 = 
	`m®loc
(
size
)è=ğ
NULL
)

2090 
”r
;

2092 
¡©e
->
addr_bË
[0] = 
NULL
;

2093 
¡©e
->
addr_couÁ
 = 1;

2095 
size
 = (
w¬ts_li¡_t
 *è* 
WARTS_LIST_TABLEGROW
;

2096 if((
¡©e
->
li¡_bË
 = 
	`m®loc
(
size
)è=ğ
NULL
)

2098 
”r
;

2100 
¡©e
->
li¡_bË
[0] = &¡©e->
li¡_nuÎ
;

2101 
¡©e
->
li¡_couÁ
 = 1;

2103 
size
 = (
w¬ts_cyşe_t
 *è* 
WARTS_CYCLE_TABLEGROW
;

2104 if((
¡©e
->
cyşe_bË
 = 
	`m®loc
(
size
)è=ğ
NULL
)

2106 
”r
;

2108 
¡©e
->
cyşe_bË
[0] = &¡©e->
cyşe_nuÎ
;

2109 
¡©e
->
cyşe_couÁ
 = 1;

2111 
	`sÿm³r_fe_£t¡©e
(
sf
, 
¡©e
);

2114 
”r
:

2115 if(
¡©e
 !ğ
NULL
)

2117 if(
¡©e
->
addr_bË
 !ğ
NULL
è
	`ä“
(state->addr_table);

2118 if(
¡©e
->
li¡_bË
 !ğ
NULL
è
	`ä“
(state->list_table);

2119 if(
¡©e
->
cyşe_bË
 !ğ
NULL
è
	`ä“
(state->cycle_table);

2120 
	`ä“
(
¡©e
);

2123 
	}
}

2130 
	$sÿm³r_fe_w¬ts_š™_wr™e
(
sÿm³r_fe_t
 *
sf
)

2132 
w¬ts_¡©e_t
 *
¡©e
 = 
NULL
;

2133 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

2134 
¡©
 
sb
;

2136 if((
¡©e
 = (
w¬ts_¡©e_t
 *)
	`m®loc_z”o
((w¬ts_¡©e_t))è=ğ
NULL
)

2137 
”r
;

2139 if(
fd
 != -1)

2141 if(
	`f¡©
(
fd
, &
sb
) != 0)

2142 
”r
;

2143 if(
	`S_ISREG
(
sb
.
¡_mode
))

2144 
¡©e
->
i¤eg
 = 1;

2147 if((
¡©e
->
li¡_Œ“
 = 
	`¥ÏyŒ“_®loc
(
w¬ts_li¡_cmp
)è=ğ
NULL
)

2149 
”r
;

2151 
¡©e
->
li¡_couÁ
 = 1;

2153 if((
¡©e
->
cyşe_Œ“
 = 
	`¥ÏyŒ“_®loc
(
w¬ts_cyşe_cmp
)è=ğ
NULL
)

2155 
”r
;

2157 
¡©e
->
cyşe_couÁ
 = 1;

2159 
	`sÿm³r_fe_£t¡©e
(
sf
, 
¡©e
);

2163 
”r
:

2164 if(
¡©e
 !ğ
NULL
)

2166 if(
¡©e
->
li¡_Œ“
 !ğ
NULL
è
	`¥ÏyŒ“_ä“
(state->list_tree, NULL);

2167 if(
¡©e
->
cyşe_Œ“
 !ğ
NULL
è
	`¥ÏyŒ“_ä“
(state->cycle_tree, NULL);

2168 
	`ä“
(
¡©e
);

2171 
	}
}

2178 
	$sÿm³r_fe_w¬ts_š™_­³nd
(
sÿm³r_fe_t
 *
sf
)

2180 
w¬ts_¡©e_t
 *
¡©e
;

2181 
w¬ts_hdr_t
 
hdr
;

2182 
i
, 
fd
;

2183 
ušt32_t
 
j
;

2184 
sÿm³r_addr_t
 *
addr
;

2185 
sÿm³r_li¡_t
 *
li¡
;

2186 
sÿm³r_cyşe_t
 *
cyşe
;

2189 if(
	`sÿm³r_fe_w¬ts_š™_»ad
(
sf
) == -1)

2194 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

2199 if((
i
 = 
	`w¬ts_hdr_»ad
(
sf
, &
hdr
)) == 0)

2204 if(
i
 == -1)

2210 if(
hdr
.
magic
 !ğ
WARTS_MAGIC
 || hdr.
ty³
 == 0)

2215 
hdr
.
ty³
)

2217 
SCAMPER_FILE_OBJ_ADDR
:

2218 if(
	`w¬ts_addr_»ad
(
sf
, &
hdr
, &
addr
è!ğ0 ||‡dd¸=ğ
NULL
)

2222 
SCAMPER_FILE_OBJ_LIST
:

2223 if(
	`w¬ts_li¡_»ad
(
sf
, &
hdr
, &
li¡
è!ğ0 ||†i¡ =ğ
NULL
)

2227 
SCAMPER_FILE_OBJ_CYCLE_START
:

2228 
SCAMPER_FILE_OBJ_CYCLE_DEF
:

2229 if(
	`w¬ts_cyşe_»ad
(
sf
, &
hdr
, &
cyşe
è!ğ0 || cyş=ğ
NULL
)

2233 
SCAMPER_FILE_OBJ_CYCLE_STOP
:

2234 if(
	`w¬ts_cyşe_¡İ_»ad
(
sf
, &
hdr
, &
cyşe
è!ğ0 || cyş=ğ
NULL
)

2236 
	`sÿm³r_cyşe_ä“
(
cyşe
);

2240 if(
	`l£ek
(
fd
, 
hdr
.
Ën
, 
SEEK_CUR
) == -1)

2249 
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

2255 if((
¡©e
->
li¡_Œ“
 = 
	`¥ÏyŒ“_®loc
(
w¬ts_li¡_cmp
)è=ğ
NULL
)

2259 
j
=1; j<
¡©e
->
li¡_couÁ
; j++)

2261 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
li¡_Œ“
, s‹->
li¡_bË
[
j
]è=ğ
NULL
)

2266 
	`ä“
(
¡©e
->
li¡_bË
); s‹->li¡_bË = 
NULL
;

2268 if((
¡©e
->
cyşe_Œ“
 = 
	`¥ÏyŒ“_®loc
(
w¬ts_cyşe_cmp
)è=ğ
NULL
)

2272 
j
=1; j<
¡©e
->
cyşe_couÁ
; j++)

2275 if(
¡©e
->
cyşe_bË
[
j
] =ğ
NULL
)

2280 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
cyşe_Œ“
, s‹->
cyşe_bË
[
j
]è=ğ
NULL
)

2285 
	`ä“
(
¡©e
->
cyşe_bË
); s‹->cyşe_bË = 
NULL
;

2288 
	}
}

2290 
	$sÿm³r_fe_w¬ts_is
(cÚ¡ 
sÿm³r_fe_t
 *
sf
)

2292 
ušt16_t
 
magic16
;

2293 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

2295 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

2300 if(
	`»ad_w¿p
(
fd
, &
magic16
, 
NULL
, (magic16)) != 0)

2305 if(
	`Áohs
(
magic16
è=ğ
WARTS_MAGIC
)

2307 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

2315 
	}
}

2317 
	$w¬ts_ä“_¡©e
(
¥ÏyŒ“_t
 *
Œ“
, **
bË
,

2318 
couÁ
, 
¥ÏyŒ“_ä“_t
 
ä“_cb
)

2320 
i
;

2322 if(
bË
 !ğ
NULL
)

2324 
i
=1; i<
couÁ
; i++)

2326 if(
bË
[
i
] !ğ
NULL
)

2328 
	`ä“_cb
(
bË
[
i
]);

2331 
	`ä“
(
bË
);

2333 if(
Œ“
 !ğ
NULL
)

2335 
	`¥ÏyŒ“_ä“
(
Œ“
, 
ä“_cb
);

2339 
	}
}

2341 
	$sÿm³r_fe_w¬ts_ä“_¡©e
(
sÿm³r_fe_t
 *
sf
)

2343 
w¬ts_¡©e_t
 *
¡©e
;

2344 
ušt32_t
 
i
;

2347 if((
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
)è=ğ
NULL
)

2352 if(
¡©e
->
»adbuf
 !ğ
NULL
)

2354 
	`ä“
(
¡©e
->
»adbuf
);

2357 
	`w¬ts_ä“_¡©e
(
¡©e
->
li¡_Œ“
,

2358 (**)
¡©e
->
li¡_bË
, s‹->
li¡_couÁ
,

2359 (
¥ÏyŒ“_ä“_t
)
w¬ts_li¡_ä“
);

2361 
	`w¬ts_ä“_¡©e
(
¡©e
->
cyşe_Œ“
,

2362 (**)
¡©e
->
cyşe_bË
, s‹->
cyşe_couÁ
,

2363 (
¥ÏyŒ“_ä“_t
)
w¬ts_cyşe_ä“
);

2365 if(
¡©e
->
addr_bË
 !ğ
NULL
)

2367 
i
=1; i<
¡©e
->
addr_couÁ
; i++)

2368 if(
¡©e
->
addr_bË
[
i
] !ğ
NULL
)

2369 
	`sÿm³r_addr_ä“
(
¡©e
->
addr_bË
[
i
]);

2370 
	`ä“
(
¡©e
->
addr_bË
);

2373 
	`ä“
(
¡©e
);

2376 
	}
}

	@scamper_file_warts.h

28 #iâdeà
__SCAMPER_FILE_WARTS_H


29 
	#__SCAMPER_FILE_WARTS_H


	)

31 
	~"mjl_¥ÏyŒ“.h
"

32 
	~"sÿm³r_icm³xt.h
"

47 
	sw¬ts_v¬


49 
	mid
;

50 
ssize_t
 
	msize
;

51 
	mv_id
;

52 } 
	tw¬ts_v¬_t
;

53 
	#WARTS_VAR_COUNT
(
¬¿y
è(×¼ay)/(
w¬ts_v¬_t
))

	)

54 
	#WARTS_VAR_MFB
(
¬¿y
è((
	`WARTS_VAR_COUNT
(array) / 7) + \

55 (
	`WARTS_VAR_COUNT
(
¬¿y
è% 7 =ğ0 ? 0 : 1))

	)

64 
	sw¬ts_li¡


66 
sÿm³r_li¡_t
 *
	mli¡
;

67 
ušt32_t
 
	mid
;

68 } 
	tw¬ts_li¡_t
;

69 
	sw¬ts_cyşe


71 
sÿm³r_cyşe_t
 *
	mcyşe
;

72 
ušt32_t
 
	mid
;

73 } 
	tw¬ts_cyşe_t
;

82 
	sw¬ts_addr


84 
sÿm³r_addr_t
 *
	maddr
;

85 
ušt32_t
 
	mid
;

86 
ušt8_t
 
	mÚdisk
;

87 } 
	tw¬ts_addr_t
;

88 
	sw¬ts_add¹abË


90 
w¬ts_addr_t
 **
	maddrs
;

91 
	maddrc
;

92 } 
	tw¬ts_add¹abË_t
;

103 
	sw¬ts_hdr


105 
ušt16_t
 
	mmagic
;

106 
ušt16_t
 
	mty³
;

107 
ušt32_t
 
	mËn
;

108 } 
	tw¬ts_hdr_t
;

119 
	sw¬ts_¡©e


121 
	mi¤eg
;

122 
off_t
 
	moff
;

125 
ušt8_t
 *
	m»adbuf
;

126 
size_t
 
	m»adËn
;

127 
size_t
 
	m»adbuf_Ën
;

133 
w¬ts_hdr_t
 
	mhdr
;

136 
ušt32_t
 
	mli¡_couÁ
;

137 
¥ÏyŒ“_t
 *
	mli¡_Œ“
;

138 
w¬ts_li¡_t
 **
	mli¡_bË
;

139 
w¬ts_li¡_t
 
	mli¡_nuÎ
;

142 
ušt32_t
 
	mcyşe_couÁ
;

143 
¥ÏyŒ“_t
 *
	mcyşe_Œ“
;

144 
w¬ts_cyşe_t
 **
	mcyşe_bË
;

145 
w¬ts_cyşe_t
 
	mcyşe_nuÎ
;

148 
ušt32_t
 
	maddr_couÁ
;

149 
sÿm³r_addr_t
 **
	maddr_bË
;

151 } 
	tw¬ts_¡©e_t
;

153 (*
	tw´_t
)(cÚ¡ 
	tušt8_t
 *,
	tušt32_t
 *,const uint32_t,*, *);

154 (*
	twpw_t
)(
	tušt8_t
 *,
	tušt32_t
 *,const uint32_t,const *,*);

156 
	sw¬ts_·¿m_»ad”


158 *
d©a
;

159 
w´_t
 
»ad
;

160 *
·¿m
;

161 } 
	tw¬ts_·¿m_»ad”_t
;

163 
	sw¬ts_·¿m_wr™”


165 cÚ¡ *
d©a
;

166 
wpw_t
 
wr™e
;

167 *
·¿m
;

168 } 
	tw¬ts_·¿m_wr™”_t
;

170 
	`æag_ij
(cÚ¡ 
id
, *
i
, *
j
);

171 
	`æag_£t
(
ušt8_t
 *
æags
, cÚ¡ 
id
, *
max_id
);

172 
	`æag_is£t
(cÚ¡ 
ušt8_t
 *
æags
, cÚ¡ 
id
);

173 
ušt16_t
 
	`fŞd_æags
(
ušt8_t
 *
æags
, cÚ¡ 
max_id
);

175 
	`w¬ts_¡r_size
(cÚ¡ *
¡r
);

176 
ušt32_t
 
	`w¬ts_addr_size
(
w¬ts_add¹abË_t
 *
t
, 
sÿm³r_addr_t
 *
addr
);

177 
	`w¬ts_add¹abË_ş—n
(
w¬ts_add¹abË_t
 *
bË
);

179 
	`š£¹_addr
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

180 cÚ¡ 
sÿm³r_addr_t
 *
addr
, *
·¿m
);

181 
	`š£¹_ušt16
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

182 cÚ¡ 
ušt16_t
 *
š
, *
·¿m
);

183 
	`š£¹_ušt32
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

184 cÚ¡ 
ušt32_t
 *
š
, *
·¿m
);

185 
	`š£¹_w¬tshdr
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

186 
ušt16_t
 
hdr_ty³
);

187 
	`š£¹_by‹
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

188 cÚ¡ 
ušt8_t
 *
š
, *
·¿m
);

189 
	`š£¹_by‹s_ušt16
(
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

190 cÚ¡ *
vš
, 
ušt16_t
 *
couÁ
);

191 
	`š£¹_¡ršg
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

192 cÚ¡ *
š
, *
·¿m
);

193 
	`š£¹_timev®
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

194 cÚ¡ 
timev®
 *
š
, *
·¿m
);

195 
	`š£¹_¹t
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

196 cÚ¡ 
timev®
 *
tv
, *
·¿m
);

199 
	`exŒaù_addr
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

200 cÚ¡ 
ušt32_t
 
Ën
, 
sÿm³r_addr_t
 **
out
, *
·¿m
);

201 
	`exŒaù_¡ršg
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

202 cÚ¡ 
ušt32_t
 
Ën
, **
out
, *
·¿m
);

203 
	`exŒaù_ušt32
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

204 cÚ¡ 
ušt32_t
 
Ën
, ušt32_ˆ*
out
, *
·¿m
);

205 
	`exŒaù_ušt16
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

206 cÚ¡ 
ušt32_t
 
Ën
, 
ušt16_t
 *
out
, *
·¿m
);

207 
	`exŒaù_by‹
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

208 cÚ¡ 
ušt32_t
 
Ën
, 
ušt8_t
 *
out
, *
·¿m
);

209 
	`exŒaù_by‹s_±r
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

210 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 **
out
,

211 
ušt16_t
 *
»q
);

212 
	`exŒaù_by‹s_®loc
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

213 cÚ¡ 
ušt32_t
 
Ën
, 
ušt8_t
 **
out
,

214 
ušt16_t
 *
»q
);

215 
	`exŒaù_by‹s
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

216 
ušt8_t
 *
out
, 
ušt16_t
 *
»q
);

217 
	`exŒaù_addr_gid
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

218 cÚ¡ 
ušt32_t
 
Ën
,

219 
sÿm³r_addr_t
 **
addr
, 
w¬ts_¡©e_t
 *
¡©e
);

220 
	`exŒaù_li¡
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

221 cÚ¡ 
ušt32_t
 
Ën
,

222 
sÿm³r_li¡_t
 **
li¡
, 
w¬ts_¡©e_t
 *
¡©e
);

223 
	`exŒaù_cyşe
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

224 cÚ¡ 
ušt32_t
 
Ën
,

225 
sÿm³r_cyşe_t
 **
cyşe
, 
w¬ts_¡©e_t
 *
¡©e
);

226 
	`exŒaù_timev®
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

227 cÚ¡ 
ušt32_t
 
Ën
, 
timev®
 *
tv
, *
·¿m
);

228 
	`exŒaù_¹t
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

229 
timev®
 *
tv
, *
·¿m
);

232 
	`w¬ts_·¿ms_»ad
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

233 
w¬ts_·¿m_»ad”_t
 *
hªdËrs
, 
hªdËr_út
);

234 
	`w¬ts_·¿ms_wr™e
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

235 cÚ¡ 
ušt32_t
 
Ën
,

236 cÚ¡ 
ušt8_t
 *
æags
,

237 cÚ¡ 
ušt16_t
 
æags_Ën
,

238 cÚ¡ 
ušt16_t
 
·¿ms_Ën
,

239 cÚ¡ 
w¬ts_·¿m_wr™”_t
 *
hªdËrs
,

240 cÚ¡ 
hªdËr_út
);

243 
	`w¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
ušt8_t
 **
buf
, 
size_t
 
Ën
);

244 
	`w¬ts_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, cÚ¡ *
buf
, 
size_t
 
Ën
);

248 
	`w¬ts_hdr_»ad
(
sÿm³r_fe_t
 *
sf
, 
w¬ts_hdr_t
 *
hdr
);

249 
	`w¬ts_addr_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

250 
sÿm³r_addr_t
 **
addr_out
);

251 
	`w¬ts_li¡_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
);

252 
w¬ts_li¡_t
 *
	`w¬ts_li¡_®loc
(
sÿm³r_li¡_t
 *
li¡
, 
ušt32_t
 
id
);

253 
	`w¬ts_li¡_ä“
(
w¬ts_li¡_t
 *
wl
);

254 
	`w¬ts_li¡_·¿ms
(cÚ¡ 
sÿm³r_li¡_t
 *
li¡
, 
ušt8_t
 *
æags
,

255 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
);

256 
	`w¬ts_li¡_·¿ms_»ad
(
sÿm³r_li¡_t
 *
li¡
,

257 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
);

258 
	`w¬ts_li¡_·¿ms_wr™e
(cÚ¡ 
sÿm³r_li¡_t
 *
li¡
,

259 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

260 cÚ¡ 
ušt32_t
 
Ën
,

261 cÚ¡ 
ušt8_t
 *
æags
,

262 cÚ¡ 
ušt16_t
 
æags_Ën
,

263 cÚ¡ 
ušt16_t
 
·¿ms_Ën
);

264 
	`w¬ts_li¡_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

265 
sÿm³r_li¡_t
 **
li¡_out
);

266 
	`w¬ts_li¡_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_li¡_t
 *
li¡
,

267 
ušt32_t
 *
id
);

268 
	`w¬ts_li¡_g‘id
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_li¡_t
 *
li¡
,

269 
ušt32_t
 *
id
);

270 
	`w¬ts_cyşe_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
);

271 
w¬ts_cyşe_t
 *
	`w¬ts_cyşe_®loc
(
sÿm³r_cyşe_t
 *
cyşe
, 
ušt32_t
 
id
);

272 
	`w¬ts_cyşe_ä“
(
w¬ts_cyşe_t
 *
cyşe
);

273 
	`w¬ts_cyşe_·¿ms
(cÚ¡ 
sÿm³r_cyşe_t
 *
cyşe
, 
ušt8_t
 *
æags
,

274 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
);

275 
	`w¬ts_cyşe_·¿ms_wr™e
(cÚ¡ 
sÿm³r_cyşe_t
 *
cyşe
,

276 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

277 cÚ¡ 
ušt32_t
 
Ën
,

278 cÚ¡ 
ušt8_t
 *
æags
,

279 cÚ¡ 
ušt16_t
 
æags_Ën
,

280 cÚ¡ 
ušt16_t
 
·¿ms_Ën
);

281 
	`w¬ts_cyşe_·¿ms_»ad
(
sÿm³r_cyşe_t
 *
cyşe
,

282 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
);

283 
	`w¬ts_cyşe_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

284 
sÿm³r_cyşe_t
 **
cyşe_out
);

285 
	`w¬ts_cyşe_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
,

286 cÚ¡ 
ty³
, 
ušt32_t
 *
id
);

287 
	`w¬ts_cyşe_¡İ_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

288 
sÿm³r_cyşe_t
 **
cyşe_out
);

289 
	`w¬ts_cyşe_g‘id
(cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
sÿm³r_cyşe_t
 *
cyşe
,

290 
ušt32_t
 *
id
);

291 
	`w¬ts_cyşe_¡İ_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

292 
sÿm³r_cyşe_t
 *
cyşe
);

293 
	`w¬ts_icm³xt_»ad
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

294 
sÿm³r_icm³xt_t
 **
exts
);

295 
	`w¬ts_icm³xt_wr™e
(
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

296 cÚ¡ 
sÿm³r_icm³xt_t
 *
exts
);

298 
	`sÿm³r_fe_w¬ts_»ad
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_fe_f‹r_t
 *
f‹r
,

299 
ušt16_t
 *
ty³
, **
d©a
);

301 
	`sÿm³r_fe_w¬ts_cyşe¡¬t_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

302 
sÿm³r_cyşe_t
 *
c
);

303 
	`sÿm³r_fe_w¬ts_cyşe¡İ_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

304 
sÿm³r_cyşe_t
 *
c
);

306 
	`sÿm³r_fe_w¬ts_is
(cÚ¡ 
sÿm³r_fe_t
 *
fe
);

307 
	`sÿm³r_fe_w¬ts_š™_­³nd
(
sÿm³r_fe_t
 *
fe
);

308 
	`sÿm³r_fe_w¬ts_š™_»ad
(
sÿm³r_fe_t
 *
fe
);

309 
	`sÿm³r_fe_w¬ts_š™_wr™e
(
sÿm³r_fe_t
 *
fe
);

311 
	`sÿm³r_fe_w¬ts_ä“_¡©e
(
sÿm³r_fe_t
 *
fe
);

	@scamper_firewall.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_debug.h
"

36 
	~"sÿm³r_fœew®l.h
"

37 
	~"sÿm³r_´iv£p.h
"

38 
	~"sÿm³r_osšfo.h
"

39 
	~"mjl_h—p.h
"

40 
	~"mjl_¥ÏyŒ“.h
"

41 
	~"uts.h
"

43 
	ssÿm³r_fœew®l_’Œy


45 
	m¦Ù
;

46 
	m»fút
;

47 
¥ÏyŒ“_node_t
 *
	mnode
;

48 
sÿm³r_fœew®l_ruË_t
 *
	mruË
;

51 
¥ÏyŒ“_t
 *
	g’Œ›s
 = 
NULL
;

53 
	$fœew®l_ruË_cmp
(cÚ¡ 
sÿm³r_fœew®l_ruË_t
 *
a
,

54 cÚ¡ 
sÿm³r_fœew®l_ruË_t
 *
b
)

56 
i
;

58 
	`as£¹
(
a
->
ty³
 =ğ
SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
);

59 
	`as£¹
(
b
->
ty³
 =ğ
SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
);

61 if(
a
->
ty³
 < 
b
->type)  -1;

62 if(
a
->
ty³
 > 
b
->type)  1;

64 if(
a
->
ty³
 =ğ
SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
)

66 if(
a
->
sfw_5tu¶e_´Ùo
 < 
b
->sfw_5tuple_proto)  -1;

67 if(
a
->
sfw_5tu¶e_´Ùo
 > 
b
->sfw_5tuple_proto)  1;

69 if(
a
->
sfw_5tu¶e_¥Üt
 < 
b
->sfw_5tuple_sport)  -1;

70 if(
a
->
sfw_5tu¶e_¥Üt
 > 
b
->sfw_5tuple_sport)  1;

72 if(
a
->
sfw_5tu¶e_dpÜt
 < 
b
->sfw_5tuple_dport)  -1;

73 if(
a
->
sfw_5tu¶e_dpÜt
 > 
b
->sfw_5tuple_dport)  1;

75 if((
i
 = 
	`sÿm³r_addr_cmp
(
a
->
sfw_5tu¶e_¤c
, 
b
->sfw_5tuple_src)) != 0)

76  
i
;

78 if(
a
->
sfw_5tu¶e_d¡
 =ğ
NULL
 && 
b
->sfw_5tuple_dst == NULL)

80 if(
a
->
sfw_5tu¶e_d¡
 !ğ
NULL
 && 
b
->sfw_5tuple_dst == NULL)

82 if(
a
->
sfw_5tu¶e_d¡
 =ğ
NULL
 && 
b
->sfw_5tuple_dst != NULL)

85  
	`sÿm³r_addr_cmp
(
a
->
sfw_5tu¶e_d¡
, 
b
->sfw_5tuple_dst);

89 
	}
}

91 
	$fœew®l_’Œy_cmp
(cÚ¡ *
a
, cÚ¡ *
b
)

93  
	`fœew®l_ruË_cmp
(((cÚ¡ 
sÿm³r_fœew®l_’Œy_t
 *)
a
)->
ruË
,

94 ((cÚ¡ 
sÿm³r_fœew®l_’Œy_t
 *)
b
)->
ruË
);

95 
	}
}

97 #ifdeà
HAVE_IPFW


101 
h—p_t
 *
	gä“¦Ùs
 = 
NULL
;

102 
	gfw_š™ed
 = 0;

103 
	ghave_v6
 = 0;

104 
	ghave_v4
 = 0;

106 
sÿm³r_fœew®l_ruË_t
 *
	$fœew®l_ruË_dup
(
sÿm³r_fœew®l_ruË_t
 *
sfw
)

108 
sÿm³r_fœew®l_ruË_t
 *
dup
;

110 if((
dup
 = 
	`memdup
(
sfw
, (
sÿm³r_fœew®l_ruË_t
))è=ğ
NULL
)

111  
NULL
;

113 
	`sÿm³r_addr_u£
(
dup
->
sfw_5tu¶e_¤c
);

114 if(
dup
->
sfw_5tu¶e_d¡
 !ğ
NULL
)

115 
	`sÿm³r_addr_u£
(
dup
->
sfw_5tu¶e_d¡
);

117  
dup
;

118 
	}
}

120 
	$fœew®l_ruË_ä“
(
sÿm³r_fœew®l_ruË_t
 *
sfw
)

122 if(
sfw
 =ğ
NULL
)

127 if(
sfw
->
sfw_5tu¶e_¤c
 !ğ
NULL
)

128 
	`sÿm³r_addr_ä“
(
sfw
->
sfw_5tu¶e_¤c
);

129 if(
sfw
->
sfw_5tu¶e_d¡
 !ğ
NULL
)

130 
	`sÿm³r_addr_ä“
(
sfw
->
sfw_5tu¶e_d¡
);

131 
	`ä“
(
sfw
);

134 
	}
}

142 
	$fœew®l_’Œy_ä“
(
sÿm³r_fœew®l_’Œy_t
 *
’Œy
)

144 if(
’Œy
->
node
 !ğ
NULL
)

145 
	`¥ÏyŒ“_»move_node
(
’Œ›s
, 
’Œy
->
node
);

146 
	`fœew®l_ruË_ä“
(
’Œy
->
ruË
);

147 
	`ä“
(
’Œy
);

149 
	}
}

157 
	$ä“¦Ùs_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

159 
sÿm³r_fœew®l_’Œy_t
 *
a
 = (sÿm³r_fœew®l_’Œy_ˆ*)
va
;

160 
sÿm³r_fœew®l_’Œy_t
 *
b
 = (sÿm³r_fœew®l_’Œy_ˆ*)
vb
;

162 if(
a
->
¦Ù
 > 
b
->slot)  -1;

163 if(
a
->
¦Ù
 < 
b
->slot)  1;

165 
	}
}

167 
	$fw_sysùl_check
()

169 cÚ¡ 
sÿm³r_osšfo_t
 *
osšfo
;

170 
size_t
 
Ën
;

171 *
Çme
;

172 
i
;

174 
Ën
 = (
i
);

175 
Çme
 = "net.inet.ip.fw.enable";

176 if(
	`sysùlbyÇme
(
Çme
, &
i
, &
Ën
, 
NULL
, 0) != 0)

178 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù sysùÈ%s", 
Çme
);

183 if(
i
 != 0)

184 
have_v4
 = 1;

186 
	`sÿm³r_debug
(
__func__
, "ipfw ipv4‚otƒnabled");

189 
Ën
 = (
i
);

190 
Çme
 = "net.inet6.ip6.fw.enable";

191 if(
	`sysùlbyÇme
(
Çme
, &
i
, &
Ën
, 
NULL
, 0) != 0)

193 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù sysùÈ%s", 
Çme
);

194 if(
”ºo
 !ğ
ENOENT
)

201 
i
 = 0;

202 
osšfo
 = 
	`sÿm³r_osšfo_g‘
();

203 if((
osšfo
->
os_id
 =ğ
SCAMPER_OSINFO_OS_FREEBSD
 &&

204 
osšfo
->
os_»l
[0] == 6 && osinfo->os_rel[1] < 3) ||

205 (
osšfo
->
os_id
 =ğ
SCAMPER_OSINFO_OS_DARWIN
 &&

206 
osšfo
->
os_»l
[0] == 8))

208 
have_v6
 = 
have_v4
;

210 
i
++;

212 if(
i
 != 0)

217 if(
i
 != 0)

218 
have_v6
 = 1;

220 
	`sÿm³r_debug
(
__func__
, "ipfw ipv6‚otƒnabled");

224 
	}
}

226 #ifdeà
_IPFW2_H


227 
	gfws
 = -1;

229 
	$sÿm³r_fœew®l_fw_š™
()

231 if(
fws
 !ğ-1 || 
	`fw_sysùl_check
(è!ğ0 || 
fw_š™ed
 != 0)

234 if((
fws
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_RAW
)) < 0)

236 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket for ipfw");

239 
fw_š™ed
 = 1;

242 
	}
}

244 
	$sÿm³r_fœew®l_fw_ş—nup
()

246 if(
fws
 != -1)

248 
	`şo£
(
fws
);

249 
fws
 = -1;

252 
	}
}

254 #ià
__F»eBSD_v”siÚ
 >= 600000

255 
	$fw_d’y_6_ext6hdr_äag
(
n
, *
s
, *
d
)

257 
_fw
 *
fw
 = 
NULL
;

258 
sockËn_t
 
¦
;

259 
ušt16_t
 
š¢c
;

260 
fw_š¢_6
 *
š¢_6
;

261 
fw_š¢
 *
š¢
;

263 
š¢c
 = 1 + 5 + 1 + 1;

265 if(
d
 !ğ
NULL
)

266 
š¢c
 += 5;

268 
š¢c
 += 1;

270 
¦
 = (
_fw
è+ (
š¢c
*4) - 4;

272 if((
fw
 = 
	`m®loc_z”o
(
¦
)è=ğ
NULL
)

274 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc ip_fw");

275 
”r
;

278 
fw
->
ruËnum
 = 
n
;

279 
fw
->
aù_ofs
 = 
š¢c
-1;

280 
fw
->
cmd_Ën
 = 
š¢c
;

281 
š¢
 = 
fw
->
cmd
;

283 
š¢
->
İcode
 = 
O_IP6
;

284 
š¢
->
Ën
 = 1;

285 
š¢
 +ğš¢->
Ën
;

287 
š¢_6
 = (
fw_š¢_6
 *)
š¢
;

288 
š¢
->
İcode
 = 
O_IP6_SRC
;

289 
š¢
->
Ën
 = 5;

290 
	`memıy
(&
š¢_6
->
addr6
, 
s
, 16);

291 
š¢
 +ğš¢->
Ën
;

293 if(
d
 !ğ
NULL
)

295 
š¢_6
 = (
fw_š¢_6
 *)
š¢
;

296 
š¢
->
İcode
 = 
O_IP6_DST
;

297 
š¢
->
Ën
 = 5;

298 
	`memıy
(&
š¢_6
->
addr6
, 
d
, 16);

302 
š¢
->
İcode
 = 
O_IP6_DST_ME
;

303 
š¢
->
Ën
 = 1;

305 
š¢
 +ğš¢->
Ën
;

307 
š¢
->
İcode
 = 
O_EXT_HDR
;

308 
š¢
->
Ën
 = 1;

309 
š¢
->
¬g1
 = 
EXT_FRAGMENT
;

310 
š¢
 +ğš¢->
Ën
;

312 
š¢
->
İcode
 = 
O_DENY
;

313 
š¢
->
Ën
 = 1;

315 if(
	`g‘sockİt
(
fws
, 
IPPROTO_IP
, 
IP_FW_ADD
, 
fw
, &
¦
) != 0)

317 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd„ule");

318 
”r
;

321 
	`ä“
(
fw
);

324 
”r
:

325 if(
fw
 !ğ
NULL
è
	`ä“
(fw);

327 
	}
}

330 
	$sÿm³r_fœew®l_fw_add
(
n
,
af
,
p
,*
s
,*
d
,
¥
,
dp
)

332 
fw_š¢_u32
 *
š¢_u32
;

333 
fw_š¢_u16
 *
š¢_u16
;

334 
_fw
 *
fw
 = 
NULL
;

335 
fw_š¢
 *
š¢
;

336 
sockËn_t
 
¦
;

337 
size_t
 
Ën
;

339 #ià
__F»eBSD_v”siÚ
 >= 600000

340 
fw_š¢_6
 *
š¢_6
;

349 
Ën
 = 2 + 2 + 1;

351 if(
af
 =ğ
AF_INET
)

352 
Ën
 += 2;

353 if(
af
 =ğ
AF_INET6
)

354 
Ën
 += 5;

356 
”r
;

358 if(
d
 =ğ
NULL
)

359 
Ën
 += 1;

360 if(
af
 =ğ
AF_INET
)

361 
Ën
 += 2;

362 if(
af
 =ğ
AF_INET6
)

363 
Ën
 += 5;

365 
”r
;

367 if((
fw
 = 
	`m®loc_z”o
((
_fw
è+ (
Ën
 * 4))è=ğ
NULL
)

369 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc ip_fw");

370 
”r
;

372 
¦
 = (
_fw
è+ (
Ën
 * 4);

374 #ià
	`defšed
(
__APPLE__
)

375 
fw
->
v”siÚ
 = 
IP_FW_CURRENT_API_VERSION
;

378 
fw
->
ruËnum
 = 
n
;

379 
fw
->
aù_ofs
 = 
Ën
;

380 
fw
->
cmd_Ën
 = 
Ën
+1;

381 
š¢
 = 
fw
->
cmd
;

384 
š¢
->
İcode
 = 
O_PROTO
;

385 
š¢
->
Ën
 = 1;

386 
š¢
->
¬g1
 = 
p
;

387 
š¢
 +ğš¢->
Ën
;

390 if(
af
 =ğ
AF_INET
)

392 
š¢_u32
 = (
fw_š¢_u32
 *)
š¢
;

393 
	`memıy
(
š¢_u32
->
d
, 
s
, 4);

394 
š¢
->
İcode
 = 
O_IP_SRC
;

395 
š¢
->
Ën
 = 2;

397 #ià
__F»eBSD_v”siÚ
 >= 600000

398 if(
af
 =ğ
AF_INET6
)

400 
š¢_6
 = (
fw_š¢_6
 *)
š¢
;

401 
	`memıy
(&
š¢_6
->
addr6
, 
s
, 16);

402 
š¢
->
İcode
 = 
O_IP6_SRC
;

403 
š¢
->
Ën
 = 5;

407 
”r
;

409 
š¢
 +ğš¢->
Ën
;

412 
š¢_u16
 = (
fw_š¢_u16
 *)
š¢
;

413 
š¢
->
İcode
 = 
O_IP_SRCPORT
;

414 
š¢
->
Ën
 = 2;

415 
š¢_u16
->
pÜts
[0] = 
¥
;

416 
š¢_u16
->
pÜts
[1] = 
¥
;

417 
š¢
 +ğš¢->
Ën
;

420 if(
d
 =ğ
NULL
)

422 if(
af
 =ğ
AF_INET
)

423 
š¢
->
İcode
 = 
O_IP_DST_ME
;

424 #ià
__F»eBSD_v”siÚ
 >= 600000

425 if(
af
 =ğ
AF_INET6
)

426 
š¢
->
İcode
 = 
O_IP6_DST_ME
;

429 
”r
;

430 
š¢
->
Ën
 = 1;

432 if(
af
 =ğ
AF_INET
)

434 
š¢_u32
 = (
fw_š¢_u32
 *)
š¢
;

435 
	`memıy
(
š¢_u32
->
d
, d, 4);

436 
š¢
->
İcode
 = 
O_IP_DST
;

437 
š¢
->
Ën
 = 2;

439 #ià
__F»eBSD_v”siÚ
 >= 600000

440 if(
af
 =ğ
AF_INET6
)

442 
š¢_6
 = (
fw_š¢_6
 *)
š¢
;

443 
	`memıy
(&
š¢_6
->
addr6
, 
d
, 16);

444 
š¢
->
İcode
 = 
O_IP6_DST
;

445 
š¢
->
Ën
 = 5;

449 
”r
;

450 
š¢
 +ğš¢->
Ën
;

453 
š¢_u16
 = (
fw_š¢_u16
 *)
š¢
;

454 
š¢
->
İcode
 = 
O_IP_DSTPORT
;

455 
š¢
->
Ën
 = 2;

456 
š¢_u16
->
pÜts
[0] = 
dp
;

457 
š¢_u16
->
pÜts
[1] = 
dp
;

458 
š¢
 +ğš¢->
Ën
;

461 
š¢
->
İcode
 = 
O_DENY
;

462 
š¢
->
Ën
 = 1;

464 if(
	`g‘sockİt
(
fws
, 
IPPROTO_IP
, 
IP_FW_ADD
, 
fw
, &
¦
) != 0)

466 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd„ule");

467 
”r
;

470 
	`ä“
(
fw
);

472 #ià
__F»eBSD_v”siÚ
 >= 600000

473 if(
af
 =ğ
AF_INET6
)

474 
	`fw_d’y_6_ext6hdr_äag
(
n
, 
s
, 
d
);

479 
”r
:

480 if(
fw
 !ğ
NULL
è
	`ä“
(fw);

482 
	}
}

484 
	$sÿm³r_fœew®l_fw_d–
(
n
, 
af
)

486 
ušt32_t
 
ruË
 = 
n
;

488 if(
	`£tsockİt
(
fws
, 
IPPROTO_IP
, 
IP_FW_DEL
, &
ruË
, (rule)) != 0)

490 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù d–‘ruË %d", 
n
);

495 
	}
}

498 #ià
defšed
(
_IP_FW_H
è|| defšed(
__APPLE__
)

499 
	gfw4s
 = -1;

500 
	gfw6s
 = -1;

502 
	$sÿm³r_fœew®l_fw_š™
()

504 if(
fw4s
 !ğ-1 || 
fw6s
 !ğ-1 || 
	`fw_sysùl_check
(è!ğ0 || 
fw_š™ed
 != 0)

507 if(
have_v4
 !ğ0 && (
fw4s
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_RAW
)) < 0)

509 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket for ipfw");

512 if(
have_v6
 !ğ0 && (
fw6s
 = 
	`sock‘
(
AF_INET6
, 
SOCK_RAW
, 
IPPROTO_RAW
)) < 0)

514 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket for ip6fw");

518 
fw_š™ed
 = 1;

520 
	}
}

522 
	$sÿm³r_fœew®l_fw_ş—nup
()

524 if(
fw4s
 != -1)

526 
	`şo£
(
fw4s
);

527 
fw4s
 = -1;

529 if(
fw6s
 != -1)

531 
	`şo£
(
fw6s
);

532 
fw6s
 = -1;

535 
	}
}

537 
	$sÿm³r_fœew®l_fw_add
(
n
,
af
,
p
,*
s
,*
d
,
¥
,
dp
)

539 
_fw
 
fw
;

540 
6_fw
 
fw6
;

541 
Ëv–
, 
İŠame
;

542 *
İtv®
;

543 
sockËn_t
 
İ’
;

544 
i
, 
fd
;

546 if(
af
 =ğ
AF_INET
)

548 
	`mem£t
(&
fw
, 0, (fw));

549 
fw
.
fw_numb”
 = 
n
;

550 
fw
.
fw_æg
 = 
IP_FW_F_DENY
 | 
IP_FW_F_IN
;

551 
fw
.
fw_´Ù
 = 
p
;

552 
	`memıy
(&
fw
.
fw_¤c
, 
s
, 4);

553 
fw
.
fw_smsk
.
s_addr
 = ~0;

554 
	`memıy
(&
fw
.
fw_d¡
, 
d
, 4);

555 
fw
.
fw_dmsk
.
s_addr
 = ~0;

556 
fw
.
fw_u¬
.
fw_±s
[0] = 
¥
;

557 
	`IP_FW_SETNSRCP
(&
fw
, 1);

558 
fw
.
fw_u¬
.
fw_±s
[1] = 
dp
;

559 
	`IP_FW_SETNDSTP
(&
fw
, 1);

561 #ifdeà
__APPLE__


562 
fw
.
v”siÚ
 = 
IP_FW_CURRENT_API_VERSION
;

565 
Ëv–
 = 
IPPROTO_IP
;

566 
İŠame
 = 
IP_FW_ADD
;

567 
İtv®
 = &
fw
;

568 
İ’
 = (
fw
);

569 
fd
 = 
fw4s
;

571 if(
af
 =ğ
AF_INET6
)

573 
	`mem£t
(&
fw6
, 0, (fw6));

574 
fw6
.
fw_numb”
 = 
n
;

575 
fw6
.
fw_æg
 = 
IPV6_FW_F_DENY
 | 
IPV6_FW_F_IN
;

576 
fw6
.
fw_´Ù
 = 
p
;

577 
	`memıy
(&
fw6
.
fw_¤c
, 
s
, 16);

578 
i
=0; i<4; i++)

579 
fw6
.
fw_smsk
.
s6_addr32
[
i
] = ~0;

580 
	`memıy
(&
fw6
.
fw_d¡
, 
d
, 16);

581 
i
=0; i<4; i++)

582 
fw6
.
fw_dmsk
.
s6_addr32
[
i
] = ~0;

583 
fw6
.
fw_±s
[0] = 
¥
;

584 
	`IPV6_FW_SETNSRCP
(&
fw6
, 1);

585 
fw6
.
fw_±s
[1] = 
dp
;

586 
	`IPV6_FW_SETNDSTP
(&
fw6
, 1);

588 #ifdeà
__APPLE__


589 
fw6
.
v”siÚ
 = 
IPV6_FW_CURRENT_API_VERSION
;

592 
Ëv–
 = 
IPPROTO_IPV6
;

593 
İŠame
 = 
IPV6_FW_ADD
;

594 
İtv®
 = &
fw6
;

595 
İ’
 = (
fw6
);

596 
fd
 = 
fw6s
;

600 if(
	`£tsockİt
(
fd
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
) != 0)

602 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd fw„ule");

607 
	}
}

609 
	$sÿm³r_fœew®l_fw_d–
(
n
, 
af
)

611 
_fw
 
fw
;

612 
6_fw
 
fw6
;

613 
Ëv–
, 
İŠame
;

614 *
İtv®
;

615 
sockËn_t
 
İ’
;

616 
fd
;

618 if(
af
 =ğ
AF_INET
)

620 
	`mem£t
(&
fw
, 0, (fw));

621 
fw
.
fw_numb”
 = 
n
;

622 #ifdeà
__APPLE__


623 
fw
.
v”siÚ
 = 
IP_FW_CURRENT_API_VERSION
;

626 
Ëv–
 = 
IPPROTO_IP
;

627 
İŠame
 = 
IP_FW_DEL
;

628 
İtv®
 = &
fw
;

629 
İ’
 = (
fw
);

630 
fd
 = 
fw4s
;

632 if(
af
 =ğ
AF_INET6
)

634 
	`mem£t
(&
fw6
, 0, (fw6));

635 
fw6
.
fw_numb”
 = 
n
;

636 #ifdeà
__APPLE__


637 
fw6
.
v”siÚ
 = 
IPV6_FW_CURRENT_API_VERSION
;

640 
Ëv–
 = 
IPPROTO_IPV6
;

641 
İŠame
 = 
IPV6_FW_DEL
;

642 
İtv®
 = &
fw6
;

643 
İ’
 = (
fw6
);

644 
fd
 = 
fw6s
;

651 if(
	`£tsockİt
(
fd
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
) != 0)

653 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù d–‘ruË %d", 
n
);

658 
	}
}

661 
	$fœew®l_ruË_d–‘e
(
sÿm³r_fœew®l_’Œy_t
 *
’Œy
)

663 #ià
	`defšed
(
HAVE_IPFW
)

664 
af
;

666 if(
’Œy
->
ruË
->
sfw_5tu¶e_¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

667 
af
 = 
AF_INET
;

669 
af
 = 
AF_INET6
;

671 #ifdeà
WITHOUT_PRIVSEP


672 
	`sÿm³r_fœew®l_fw_d–
(
’Œy
->
¦Ù
, 
af
);

674 
	`sÿm³r_´iv£p_fw_d–
(
’Œy
->
¦Ù
, 
af
);

679 if(
	`h—p_š£¹
(
ä“¦Ùs
, 
’Œy
è=ğ
NULL
)

681 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

682 "could‚Ù‡ddƒÁry %d", 
’Œy
->
¦Ù
);

683 
	`fœew®l_’Œy_ä“
(
’Œy
);

687 
	`fœew®l_ruË_ä“
(
’Œy
->
ruË
);

688 
’Œy
->
ruË
 = 
NULL
;

691 
	}
}

693 
sÿm³r_fœew®l_’Œy_t
 *
	$fœew®l_’Œy_g‘
()

695  
	`h—p_»move
(
ä“¦Ùs
);

696 
	}
}

698 
	$fw_š™
()

700 
sÿm³r_fœew®l_’Œy_t
 *
’Œy
;

701 
i
;

703 if(
	`fw_sysùl_check
() != 0)

706 if((
ä“¦Ùs
 = 
	`h—p_®loc
(
ä“¦Ùs_cmp
)è=ğ
NULL
)

708 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create freeslots heap");

712 
i
=1; i<500; i++)

714 if((
’Œy
 = 
	`m®loc_z”o
((
sÿm³r_fœew®l_’Œy_t
))è=ğ
NULL
)

716 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù‡Îoø’Œy %d", 
i
);

717 
”r
;

719 
’Œy
->
¦Ù
 = 
i
;

720 if(
	`h—p_š£¹
(
ä“¦Ùs
, 
’Œy
è=ğ
NULL
)

722 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù‡ddƒÁry %d", 
i
);

723 
”r
;

727 #ifdeà
WITHOUT_PRIVSEP


728 if(
	`sÿm³r_fœew®l_fw_š™
() != 0)

729 
”r
;

731 if(
	`sÿm³r_´iv£p_fw_š™
() != 0)

732 
”r
;

737 
”r
:

739 
	}
}

741 
	$fw_ş—nup_fÜ—ch
(*
·¿m
, *
™em
)

743 
sÿm³r_fœew®l_’Œy_t
 *
’Œy
 = 
™em
;

745 
	`fœew®l_ruË_d–‘e
(
’Œy
);

746 
’Œy
->
¦Ù
 = -1;

749 
	}
}

751 
	$fw_ş—nup
()

753 
sÿm³r_fœew®l_’Œy_t
 *
’Œy
;

755 
	`¥ÏyŒ“_šÜd”
(
’Œ›s
, 
fw_ş—nup_fÜ—ch
, 
NULL
);

757 if(
ä“¦Ùs
 !ğ
NULL
)

759 (
’Œy
 = 
	`h—p_»move
(
ä“¦Ùs
)è!ğ
NULL
)

761 
	`fœew®l_’Œy_ä“
(
’Œy
);

764 
	`h—p_ä“
(
ä“¦Ùs
, 
NULL
);

765 
ä“¦Ùs
 = 
NULL
;

768 #ifdeà
WITHOUT_PRIVSEP


769 
	`sÿm³r_fœew®l_fw_ş—nup
();

771 if(
fw_š™ed
 != 0)

772 
	`sÿm³r_´iv£p_fw_ş—nup
();

776 
	}
}

778 
sÿm³r_fœew®l_’Œy_t
 *
	$sÿm³r_fœew®l_’Œy_g‘
(
sÿm³r_fœew®l_ruË_t
 *
sfw
)

780 
sÿm³r_fœew®l_’Œy_t
 
fšdme
, *
’Œy
 = 
NULL
;

781 
n
, 
af
, 
p
, 
¥
, 
dp
;

782 *
s
, *
d
;

785 if((
sfw
->
sfw_5tu¶e_´Ùo
 !ğ
IPPROTO_TCP
 &&

786 
sfw
->
sfw_5tu¶e_´Ùo
 !ğ
IPPROTO_UDP
) ||

787 
sfw
->
sfw_5tu¶e_¥Üt
 == 0 ||

788 
sfw
->
sfw_5tu¶e_dpÜt
 == 0 ||

789 (
sfw
->
sfw_5tu¶e_d¡
 =ğ
NULL
 || sfw->
sfw_5tu¶e_¤c
 == NULL ||

790 
sfw
->
sfw_5tu¶e_¤c
->
ty³
 !ğsfw->
sfw_5tu¶e_d¡
->type))

792 
	`sÿm³r_debug
(
__func__
, "invalid 5tuple„ule");

793 
”r
;

796 if(
sfw
->
sfw_5tu¶e_¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

798 if(
have_v4
 == 0)

800 
	`sÿm³r_debug
(
__func__
, "IPv4„ule„equested but‚o IPv4 firewall");

801 
”r
;

803 
af
 = 
AF_INET
;

805 if(
sfw
->
sfw_5tu¶e_¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

807 if(
have_v6
 == 0)

809 
	`sÿm³r_debug
(
__func__
, "IPv6„ule„equested but‚o IPv6 firewall");

810 
”r
;

812 
af
 = 
AF_INET6
;

816 
	`sÿm³r_debug
(
__func__
, "invalid srcype");

817 
”r
;

820 
fšdme
.
ruË
 = 
sfw
;

821 if((
’Œy
 = 
	`¥ÏyŒ“_fšd
(
’Œ›s
, &
fšdme
)è!ğ
NULL
)

823 
’Œy
->
»fút
++;

824  
’Œy
;

827 if((
’Œy
 = 
	`fœew®l_’Œy_g‘
()è=ğ
NULL
)

828 
”r
;

830 
’Œy
->
»fút
 = 1;

831 if((
’Œy
->
ruË
 = 
	`fœew®l_ruË_dup
(
sfw
)è=ğ
NULL
 ||

832 (
’Œy
->
node
 = 
	`¥ÏyŒ“_š£¹
(
’Œ›s
,ƒÁry)è=ğ
NULL
)

834 
”r
;

837 
n
 = 
’Œy
->
¦Ù
;

838 
p
 = 
sfw
->
sfw_5tu¶e_´Ùo
;

839 
dp
 = 
sfw
->
sfw_5tu¶e_dpÜt
;

840 
¥
 = 
sfw
->
sfw_5tu¶e_¥Üt
;

841 
s
 = 
sfw
->
sfw_5tu¶e_¤c
->
addr
;

842 if(
sfw
->
sfw_5tu¶e_d¡
 =ğ
NULL
)

843 
d
 = 
NULL
;

845 
d
 = 
sfw
->
sfw_5tu¶e_d¡
->
addr
;

847 #ifdeà
WITHOUT_PRIVSEP


848 if(
	`sÿm³r_fœew®l_fw_add
(
n
, 
af
, 
p
, 
s
, 
d
, 
¥
, 
dp
) != 0)

849 
”r
;

851 if(
	`sÿm³r_´iv£p_fw_add
(
n
, 
af
, 
p
, 
s
, 
d
, 
¥
, 
dp
) != 0)

852 
”r
;

855  
’Œy
;

857 
”r
:

858 if(
’Œy
 !ğ
NULL
)

860 if(
’Œy
->
ruË
 !ğ
NULL
)

861 
	`fœew®l_ruË_ä“
(
’Œy
->
ruË
);

862 
	`ä“
(
’Œy
);

864  
NULL
;

865 
	}
}

868 #iâdeà
HAVE_IPFW


869 
	$fœew®l_ruË_d–‘e
(
sÿm³r_fœew®l_’Œy_t
 *
’Œy
)

872 
	}
}

874 
sÿm³r_fœew®l_’Œy_t
 *
	$sÿm³r_fœew®l_’Œy_g‘
(
sÿm³r_fœew®l_ruË_t
 *
sfw
)

876  
NULL
;

877 
	}
}

880 
	$sÿm³r_fœew®l_’Œy_ä“
(
sÿm³r_fœew®l_’Œy_t
 *
’Œy
)

882 
’Œy
->
»fút
--;

883 if(
’Œy
->
»fút
 > 0)

889 
	`¥ÏyŒ“_»move_node
(
’Œ›s
, 
’Œy
->
node
);

890 
’Œy
->
node
 = 
NULL
;

897 if(
’Œy
->
¦Ù
 >= 0)

899 
	`fœew®l_ruË_d–‘e
(
’Œy
);

903 
	}
}

907 
	$sÿm³r_fœew®l_ş—nup
()

909 #ià
	`defšed
(
HAVE_IPFW
)

910 
	`fw_ş—nup
();

912 if(
’Œ›s
 !ğ
NULL
)

913 
	`¥ÏyŒ“_ä“
(
’Œ›s
, 
NULL
);

915 
	}
}

917 
	$sÿm³r_fœew®l_š™
(*
İt
)

919 if((
’Œ›s
 = 
	`¥ÏyŒ“_®loc
(
fœew®l_’Œy_cmp
)è=ğ
NULL
)

921 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot createƒntriesree");

925 #ià
	`defšed
(
HAVE_IPFW
)

926  
	`fw_š™
();

930 
	}
}

	@scamper_firewall.h

24 #iâdeà
__SCAMPER_FIREWALL_H


25 
	#__SCAMPER_FIREWALL_H


	)

27 
	#SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
 0x1

	)

30 
sÿm³r_fœew®l_’Œy
 
	tsÿm³r_fœew®l_’Œy_t
;

32 #ifdeà
__SCAMPER_ADDR_H


33 
	ssÿm³r_fœew®l_ruË


35 
ušt16_t
 
	mty³
;

38 
	sfiv‘u¶e


40 
ušt8_t
 
	m´Ùo
;

41 
sÿm³r_addr_t
 *
	m¤c
;

42 
sÿm³r_addr_t
 *
	md¡
;

43 
ušt16_t
 
	m¥Üt
;

44 
ušt16_t
 
	mdpÜt
;

45 } 
	mfiv‘u¶e
;

46 } 
	mun
;

47 } 
	tsÿm³r_fœew®l_ruË_t
;

49 
sÿm³r_fœew®l_’Œy_t
 *
sÿm³r_fœew®l_’Œy_g‘
(
sÿm³r_fœew®l_ruË_t
 *);

52 
	#sfw_5tu¶e_´Ùo
 
un
.
fiv‘u¶e
.
´Ùo


	)

53 
	#sfw_5tu¶e_¤c
 
un
.
fiv‘u¶e
.
¤c


	)

54 
	#sfw_5tu¶e_d¡
 
un
.
fiv‘u¶e
.
d¡


	)

55 
	#sfw_5tu¶e_¥Üt
 
un
.
fiv‘u¶e
.
¥Üt


	)

56 
	#sfw_5tu¶e_dpÜt
 
un
.
fiv‘u¶e
.
dpÜt


	)

58 
sÿm³r_fœew®l_’Œy_ä“
(
sÿm³r_fœew®l_’Œy_t
 *);

61 
sÿm³r_fœew®l_š™
(*
İt
);

62 
sÿm³r_fœew®l_ş—nup
();

64 #ià
defšed
(
__F»eBSD__
è|| defšed(
__APPLE__
)

65 
sÿm³r_fœew®l_fw_š™
();

66 
sÿm³r_fœew®l_fw_ş—nup
();

67 
sÿm³r_fœew®l_fw_add
(
n
,
af
,
p
,*
s
,*
d
,
¥
,
dp
);

68 
sÿm³r_fœew®l_fw_d–
(
n
,
af
);

	@scamper_getsrc.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_debug.h
"

38 
	~"sÿm³r_g‘¤c.h
"

39 
	~"uts.h
"

41 
	gudp4
 = -1;

42 
	gudp6
 = -1;

44 
sÿm³r_addrÿche_t
 *
addrÿche
;

52 
sÿm³r_addr_t
 *
	$sÿm³r_g‘¤c
(cÚ¡ 
sÿm³r_addr_t
 *
d¡
, 
ifšdex
)

54 
sockaddr_¡Üage
 
§s
;

55 
sÿm³r_addr_t
 *
¤c
;

56 
sockËn_t
 
sockËn
, 
sockËno
;

57 
sock
;

58 *
addr
;

59 
buf
[64];

61 if(
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

63 if(
udp4
 =ğ-1 && (udp4 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) == -1)

65 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open udp4 sock");

66  
NULL
;

69 
sock
 = 
udp4
;

70 
addr
 = &((
sockaddr_š
 *)&
§s
)->
sš_addr
;

71 
sockËn
 = (
sockaddr_š
);

73 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET
, 
d¡
->
addr
, 80);

75 if(
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

77 if(
udp6
 =ğ-1 && (udp6 = 
	`sock‘
(
AF_INET6
, 
SOCK_DGRAM
,
IPPROTO_UDP
)) == -1)

79 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open udp6 sock");

80  
NULL
;

83 
sock
 = 
udp6
;

84 
addr
 = &((
sockaddr_š6
 *)&
§s
)->
sš6_addr
;

85 
sockËn
 = (
sockaddr_š6
);

87 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET6
, 
d¡
->
addr
, 80);

89 if(
	`sÿm³r_addr_i¦škloÿl
(
d¡
) != 0)

91 ((
sockaddr_š6
 *)&
§s
)->
sš6_scİe_id
 = 
ifšdex
;

94  
NULL
;

96 if(
	`cÚÃù
(
sock
, (
sockaddr
 *)&
§s
, 
sockËn
) != 0)

98 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "connecto dst failed for %s",

99 
	`sÿm³r_addr_to¡r
(
d¡
, 
buf
, (buf)));

100  
NULL
;

103 
sockËno
 = 
sockËn
;

104 if(
	`g‘sockÇme
(
sock
, (
sockaddr
 *)&
§s
, &
sockËno
) != 0)

106 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot getsockname for %s",

107 
	`sÿm³r_addr_to¡r
(
d¡
, 
buf
, (buf)));

108  
NULL
;

111 
¤c
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
d¡
->
ty³
, 
addr
);

113 
	`mem£t
(&
§s
, 0, (sas));

114 
	`cÚÃù
(
sock
, (
sockaddr
 *)&
§s
, 
sockËn
);

115  
¤c
;

116 
	}
}

118 
	$sÿm³r_g‘¤c_š™
()

121 
	}
}

123 
	$sÿm³r_g‘¤c_ş—nup
()

125 if(
udp4
 != -1)

127 #iâdeà
_WIN32


128 
	`şo£
(
udp4
);

130 
	`şo£sock‘
(
udp4
);

132 
udp4
 = -1;

135 if(
udp6
 != -1)

137 #iâdeà
_WIN32


138 
	`şo£
(
udp6
);

140 
	`şo£sock‘
(
udp6
);

142 
udp6
 = -1;

146 
	}
}

	@scamper_getsrc.h

25 #iâdeà
__SCAMPER_GETSRC_H


26 
	#__SCAMPER_GETSRC_H


	)

28 
sÿm³r_addr_t
 *
sÿm³r_g‘¤c
(cÚ¡ sÿm³r_addr_ˆ*
d¡
, 
ifšdex
);

29 
sÿm³r_g‘¤c_š™
();

30 
sÿm³r_g‘¤c_ş—nup
();

	@scamper_icmp4.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_dl.h
"

38 
	~"sÿm³r_´obe.h
"

39 
	~"sÿm³r_icmp_»¥.h
"

40 
	~"sÿm³r_4.h
"

41 
	~"sÿm³r_icmp4.h
"

42 
	~"sÿm³r_´iv£p.h
"

43 
	~"sÿm³r_debug.h
"

44 
	~"uts.h
"

46 
ušt8_t
 *
	gtxbuf
 = 
NULL
;

47 
size_t
 
	gtxbuf_Ën
 = 0;

48 
ušt8_t
 
	grxbuf
[65536];

50 
	$icmp4_h—d”
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
)

52 
buf
[0] = 
´obe
->
´_icmp_ty³
;

53 
buf
[1] = 
´obe
->
´_icmp_code
;

54 
buf
[2] = 0; buf[3] = 0;

56 
´obe
->
´_icmp_ty³
)

58 
ICMP_ECHO
:

59 
ICMP_ECHOREPLY
:

60 
ICMP_TSTAMP
:

61 
	`by‹s_htÚs
(
buf
+4, 
´obe
->
´_icmp_id
);

62 
	`by‹s_htÚs
(
buf
+6, 
´obe
->
´_icmp_£q
);

65 
ICMP_UNREACH
:

66 
	`mem£t
(
buf
+4, 0, 4);

67 if(
´obe
->
´_icmp_code
 =ğ
ICMP_UNREACH_NEEDFRAG
)

68 
	`by‹s_htÚs
(
buf
+6, 
´obe
->
´_icmp_mtu
);

72 
	`mem£t
(
buf
+4, 0, 4);

77 
	}
}

79 
ušt16_t
 
	$sÿm³r_icmp4_cksum
(
sÿm³r_´obe_t
 *
´obe
)

81 
ušt8_t
 
hdr
[8];

82 
ušt16_t
 
tmp
, *
w
;

83 
i
, 
sum
 = 0;

85 
	`icmp4_h—d”
(
´obe
, 
hdr
);

87 
w
 = (
ušt16_t
 *)
hdr
;

88 
i
=0; i<8; i+=2)

89 
sum
 +ğ*
w
++;

91 
w
 = (
ušt16_t
 *)
´obe
->
´_d©a
;

92 
i
 = 
´obe
->
´_Ën
; i > 1; i -= 2)

93 
sum
 +ğ*
w
++;

94 if(
i
 != 0)

95 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

98 
sum
 = (sum >> 16) + (sum & 0xffff);

99 
sum
 += (sum >> 16);

101 if((
tmp
 = ~
sum
) == 0)

103 
tmp
 = 0xffff;

106  
tmp
;

107 
	}
}

109 
	$icmp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
)

111 
ušt16_t
 
csum
;

113 
	`icmp4_h—d”
(
´obe
, 
buf
);

115 if(
´obe
->
´_Ën
 > 0)

116 
	`memıy
(
buf
 + 8, 
´obe
->
´_d©a
,…robe->
´_Ën
);

118 
csum
 = 
	`š_cksum
(
buf
, (
size_t
)(
´obe
->
´_Ën
 + 8));

119 
	`memıy
(
buf
+2, &
csum
, 2);

122 
	}
}

124 
	$sÿm³r_icmp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

126 
size_t
 
4hËn
, 
»q
;

127 
rc
 = 0;

129 
4hËn
 = *
Ën
;

130 
	`sÿm³r_4_bud
(
´obe
, 
buf
, &
4hËn
);

131 
»q
 = 
4hËn
 + 8 + 
´obe
->
´_Ën
;

133 if(
»q
 <ğ*
Ën
)

134 
	`icmp4_bud
(
´obe
, 
buf
 + 
4hËn
);

136 
rc
 = -1;

138 *
Ën
 = 
»q
;

139  
rc
;

140 
	}
}

147 
	$sÿm³r_icmp4_´obe
(
sÿm³r_´obe_t
 *
´obe
)

149 
sockaddr_š
 
sš4
;

150 
addr
[128];

151 
size_t
 
4hËn
, 
Ën
, 
tmp
;

152 
i
, 
icmphd¾’
;

154 #ià!
	`defšed
(
IP_HDR_HTONS
)

155 

 *ip;

158 
	`as£¹
(
´obe
 !ğ
NULL
);

159 
	`as£¹
(
´obe
->
´__´Ùo
 =ğ
IPPROTO_ICMP
);

160 
	`as£¹
(
´obe
->
´__d¡
 !ğ
NULL
);

161 
	`as£¹
(
´obe
->
´__¤c
 !ğ
NULL
);

162 
	`as£¹
(
´obe
->
´_Ën
 > 0 ||…robe->
´_d©a
 =ğ
NULL
);

164 
´obe
->
´_icmp_ty³
)

166 
ICMP_ECHO
:

167 
ICMP_TSTAMP
:

168 
icmphd¾’
 = (1 + 1 + 2 + 2 + 2);

172 
´obe
->
´_”ºo
 = 
EINVAL
;

176 
	`sÿm³r_4_hËn
(
´obe
, &
4hËn
);

179 
Ën
 = 
4hËn
 + 
icmphd¾’
 + 
´obe
->
´_Ën
;

181 
i
 = 
Ën
;

182 if(
	`£tsockİt
(
´obe
->
´_fd
,

183 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
i
, (i)) == -1)

185 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

186 "could‚Ù s‘ bufã¸tØ%d by‹s", 
i
);

190 if(
txbuf_Ën
 < 
Ën
)

192 if(
	`»®loc_w¿p
((**)&
txbuf
, 
Ën
) != 0)

194 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

197 
txbuf_Ën
 = 
Ën
;

201 
tmp
 = 
Ën
;

202 
	`sÿm³r_4_bud
(
´obe
, 
txbuf
, &
tmp
);

205 #ià!
	`defšed
(
IP_HDR_HTONS
)

206 

 = ( *)
txbuf
;

207 

->
_Ën
 = 
	`Áohs
(ip->ip_len);

208 

->
_off
 = 
	`Áohs
(ip->ip_off);

211 
	`icmp4_bud
(
´obe
, 
txbuf
 + 
4hËn
);

213 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
,

214 
´obe
->
´__d¡
->
addr
, 0);

217 
	`g‘timeofday_w¿p
(&
´obe
->
´_tx
);

219 
i
 = 
	`£ndto
(
´obe
->
´_fd
, 
txbuf
, 
Ën
, 0, (
sockaddr
 *)&
sš4
,

220 (
sockaddr_š
));

222 if(
i
 < 0)

225 
´obe
->
´_”ºo
 = 
”ºo
;

226 
	`´š‹¼Ü
(
´obe
->
´_”ºo
, 
¡»¼Ü
, 
__func__
,

228 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)),

229 
´obe
->
´__‰l
,…robe->
´_icmp_£q
, 
Ën
);

232 if((
size_t
)
i
 !ğ
Ën
)

235 
	`årštf
(
¡d”r
,

237 
i
, ()
Ën
,

238 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)));

243 
	}
}

262 
ušt16_t
 
	$icmp4_quÙe__Ën
(cÚ¡ 
icmp
 *icmp)

264 
ušt16_t
 
Ën
;

266 #ià
	`defšed
(
__lšux__
è|| defšed(
__O³nBSD__
è|| defšed(
__sun__
è|| defšed(
_WIN32
)

267 
Ën
 = 
	`Áohs
(
icmp
->
icmp_
.
_Ën
);

268 #–ià
	`defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
è|| defšed(
__APPLE__
è|| defšed(
__D¿gÚFly__
)

269 if(
icmp
->
icmp_ty³
 =ğ
ICMP_TIMXCEED
)

271 if(
icmp
->
icmp_code
 <= 1)

273 
Ën
 = 
icmp
->
icmp_
.
_Ën
;

277 
Ën
 = 
	`Áohs
(
icmp
->
icmp_
.
_Ën
);

282 
icmp
->
icmp_code
)

284 
ICMP_UNREACH_NET
:

285 
ICMP_UNREACH_HOST
:

286 
ICMP_UNREACH_PROTOCOL
:

287 
ICMP_UNREACH_PORT
:

288 
ICMP_UNREACH_SRCFAIL
:

289 
ICMP_UNREACH_NEEDFRAG
:

290 
ICMP_UNREACH_NET_UNKNOWN
:

291 
ICMP_UNREACH_NET_PROHIB
:

292 
ICMP_UNREACH_TOSNET
:

293 
ICMP_UNREACH_HOST_UNKNOWN
:

294 
ICMP_UNREACH_ISOLATED
:

295 
ICMP_UNREACH_HOST_PROHIB
:

296 
ICMP_UNREACH_TOSHOST
:

298 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__APPLE__
è|| defšed(
__D¿gÚFly__
)

299 
ICMP_UNREACH_HOST_PRECEDENCE
:

300 
ICMP_UNREACH_PRECEDENCE_CUTOFF
:

301 
ICMP_UNREACH_FILTER_PROHIB
:

303 
Ën
 = 
icmp
->
icmp_
.
_Ën
;

307 
Ën
 = 
	`Áohs
(
icmp
->
icmp_
.
_Ën
);

311 
Ën
 = 
icmp
->
icmp_
.
_Ën
;

314  
Ën
;

315 
	}
}

323 
ušt16_t
 
	$icmp4__Ën
(cÚ¡ 

 *ip)

325 
ušt16_t
 
Ën
;

327 #ià
	`defšed
(
__lšux__
è|| defšed(
__O³nBSD__
è|| defšed(
__sun__
è|| defšed(
_WIN32
)

328 
Ën
 = 
	`Áohs
(

->
_Ën
);

330 
Ën
 = 

->
_Ën
 + (->
_hl
 << 2);

333  
Ën
;

334 
	}
}

336 
	$_quÙe_¼
(
sÿm³r_icmp_»¥_t
 *
œ
, 
¼c
, *
¼s
)

338 
œ
->
œ_šÃr_İt_¼c
 = 
¼c
;

339 
œ
->
œ_šÃr_İt_¼s
 = 
¼s
;

341 
	}
}

343 
	$_¼
(
sÿm³r_icmp_»¥_t
 *
œ
, 
¼c
, *
¼s
)

345 
œ
->
œ_İt_¼c
 = 
¼c
;

346 
œ
->
œ_İt_¼s
 = 
¼s
;

348 
	}
}

350 
ušt8_t
 
	$_tsc
(
æ
, 
Ën
)

352 if(
æ
 == 0)

354 if(
Ën
 >= 4 && (len % 4) == 0)

355  
Ën
 / 4;

357 if(
æ
 == 1 || fl == 3)

359 if(
Ën
 >= 8 && (len % 8) == 0)

360  
Ën
 / 8;

364 
	}
}

366 
	$_quÙe_ts
(
sÿm³r_icmp_»¥_t
 *
œ
, 
æ
,

367 cÚ¡ 
ušt8_t
 *
buf
, 
Ën
)

369 cÚ¡ 
ušt8_t
 *
±r
 = 
buf
;

370 
ušt8_t
 
i
, 
tsc
;

372 
œ
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_INNER_IPOPT_TS
;

374 if((
tsc
 = 
	`_tsc
(
æ
, 
Ën
)) == 0)

377 if(
æ
 == 1 || fl == 3)

379 
œ
->
œ_šÃr_İt_tss
 = 
	`m®loc
((
š_addr
è* 
tsc
);

380 if(
œ
->
œ_šÃr_İt_tss
 =ğ
NULL
)

384 if((
œ
->
œ_šÃr_İt_t¡ss
 = 
	`m®loc
((
ušt32_t
è* 
tsc
)è=ğ
NULL
)

387 
i
=0; i<
tsc
; i++)

389 if(
æ
 == 1 || fl == 3)

391 
	`memıy
(&
œ
->
œ_šÃr_İt_tss
[
i
], 
±r
, 4);

392 
±r
 += 4;

394 
œ
->
œ_šÃr_İt_t¡ss
[
i
] = 
	`by‹s_Áohl
(
±r
);

395 
±r
 += 4;

398 
œ
->
œ_šÃr_İt_tsc
 = 
tsc
;

400 
	}
}

402 
	$_ts
(
sÿm³r_icmp_»¥_t
 *
œ
, 
æ
, cÚ¡ 
ušt8_t
 *
buf
, 
Ën
)

404 cÚ¡ 
ušt8_t
 *
±r
 = 
buf
;

405 
ušt8_t
 
i
, 
tsc
;

407 
œ
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_IPOPT_TS
;

409 if((
tsc
 = 
	`_tsc
(
æ
, 
Ën
)) == 0)

412 if(
æ
 == 1 || fl == 3)

414 if((
œ
->
œ_İt_tss
 = 
	`m®loc
((
š_addr
è* 
tsc
)è=ğ
NULL
)

418 if((
œ
->
œ_İt_t¡ss
 = 
	`m®loc
((
ušt32_t
è* 
tsc
)è=ğ
NULL
)

421 
i
=0; i<
tsc
; i++)

423 if(
æ
 == 1 || fl == 3)

425 
	`memıy
(&
œ
->
œ_İt_tss
[
i
], 
±r
, 4);

426 
±r
 += 4;

428 
œ
->
œ_İt_t¡ss
[
i
] = 
	`by‹s_Áohl
(
±r
);

429 
±r
 += 4;

432 
œ
->
œ_İt_tsc
 = 
tsc
;

434 
	}
}

436 
	$İt_·r£
(
sÿm³r_icmp_»¥_t
 *
œ
, cÚ¡ 
ušt8_t
 *
buf
, 
hl
,

437 (*
¼
)(
sÿm³r_icmp_»¥_t
 *, , *),

438 (*
ts
)(
sÿm³r_icmp_»¥_t
 *, ,

439 cÚ¡ 
ušt8_t
 *, ))

441 
off
, 
Ş
, 
p
, 
æ
, 
¼c
;

442 *
¼s
;

444 
off
 = 20;

445 
off
 < 
hl
)

448 if(
buf
[
off
] == 0)

452 if(
buf
[
off
] == 1)

454 
off
++;

458 
Ş
 = 
buf
[
off
+1];

461 if(
Ş
 < 2 || 
off
 + oÈ> 
hl
)

464 if(
buf
[
off
] =ğ7 && 
¼
 !ğ
NULL
)

467 
p
 = 
buf
[
off
+2];

468 if(
p
 >ğ4 && (°% 4è=ğ0 && (
¼c
 = (p / 4) - 1) != 0 &&

469 (
¼s
 = 
	`memdup
(
buf
+
off
+3, 
¼c
 * 4)è!ğ
NULL
)

471 
	`¼
(
œ
, 
¼c
, 
¼s
);

474 if(
buf
[
off
] =ğ68 && 
ts
 !ğ
NULL
)

477 
p
 = 
buf
[
off
+2];

478 
æ
 = 
buf
[
off
+3] & 0xf;

479 if(
p
 == 1)

480 
	`ts
(
œ
, 
æ
, 
buf
+
off
+4, 
Ş
-4);

481 if(
p
 >ğ5 &&…-1 <ğ
Ş
)

482 
	`ts
(
œ
, 
æ
, 
buf
+
off
+4, 
p
-5);

485 
off
 +ğ
Ş
;

489 
	}
}

497 #iâdeà
_WIN32


498 
	$icmp4_»cv_
(
fd
, 
sÿm³r_icmp_»¥_t
 *
œ
, cÚ¡ 
ušt8_t
 *
buf
,

499 
hl
, 
msghdr
 *
msg
)

501 
	$icmp4_»cv_
(
fd
, 
sÿm³r_icmp_»¥_t
 *
œ
, cÚ¡ 
ušt8_t
 *
buf
,

502 
hl
)

505 cÚ¡ 

 * = (cÚ¡  *)
buf
;

506 cÚ¡ 
icmp
 *icm°ğ(cÚ¡ icm°*)(
buf
 + 
hl
);

512 #ià
	`defšed
(
SO_TIMESTAMP
)

513 
cmsghdr
 *
cmsg
;

519 if(
msg
->
msg_cÚŒŞËn
 >ğ(
cmsghdr
))

521 
cmsg
 = (
cmsghdr
 *)
	`CMSG_FIRSTHDR
(
msg
);

522 
cmsg
 !ğ
NULL
)

524 if(
cmsg
->
cmsg_Ëv–
 =ğ
SOL_SOCKET
 && cmsg->
cmsg_ty³
 =ğ
SCM_TIMESTAMP
)

526 
	`timev®_ıy
(&
œ
->
œ_rx
, (
timev®
 *)
	`CMSG_DATA
(
cmsg
));

527 
œ
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_KERNRX
;

530 
cmsg
 = (
cmsghdr
 *)
	`CMSG_NXTHDR
(
msg
, cmsg);

533 #–ià
	`defšed
(
SIOCGSTAMP
)

534 if(
	`ioùl
(
fd
, 
SIOCGSTAMP
, &
œ
->
œ_rx
) != -1)

536 
œ
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_KERNRX
;

539 
	`g‘timeofday_w¿p
(&
œ
->
œ_rx
);

543 
	`memıy
(&
œ
->
œ__¤c
.
v4
, &

->
_¤c
, (
š_addr
));

545 
œ
->
œ_af
 = 
AF_INET
;

546 
œ
->
œ__‰l
 = 

->
_‰l
;

547 
œ
->
œ__id
 = 
	`Áohs
(

->
_id
);

548 
œ
->
œ__tos
 = 

->
_tos
;

549 
œ
->
œ__size
 = 
	`icmp4__Ën
(

);

550 
œ
->
œ_icmp_ty³
 = 
icmp
->
icmp_ty³
;

551 
œ
->
œ_icmp_code
 = 
icmp
->
icmp_code
;

552 
	`İt_·r£
(
œ
, 
buf
, 
hl
, 
_¼
, 
_ts
);

555 
	}
}

557 
	$_hl
(cÚ¡ *
buf
)

559  (((cÚ¡ 
ušt8_t
 *)
buf
)[0] & 0xf) << 2;

560 
	}
}

562 
	$sÿm³r_icmp4_»cv
(
fd
, 
sÿm³r_icmp_»¥_t
 *
»¥
)

564 
ssize_t
 
poff£t
;

565 
ssize_t
 
pbuæ’
;

566 
icmp
 *icmp;

567 

 *
_ou‹r
 = ( *)
rxbuf
;

568 

 *
_šÃr
;

569 
udphdr
 *
udp
;

570 
tıhdr
 *
tı
;

571 
ušt8_t
 
ty³
, 
code
;

572 
ušt8_t
 
nh
;

573 
hl
;

574 
hlq
;

575 
ušt8_t
 *
ext
;

576 
ssize_t
 
ex’
;

578 #iâdeà
_WIN32


579 
sockaddr_š
 
äom
;

580 
ušt8_t
 
ù¾buf
[256];

581 
msghdr
 
msg
;

582 
iovec
 
iov
;

584 
	`mem£t
(&
iov
, 0, (iov));

585 
iov
.
iov_ba£
 = (
ÿddr_t
)
rxbuf
;

586 
iov
.
iov_Ën
 = (
rxbuf
);

588 
msg
.
msg_Çme
 = (
ÿddr_t
)&
äom
;

589 
msg
.
msg_Çm–’
 = (
äom
);

590 
msg
.
msg_iov
 = &
iov
;

591 
msg
.
msg_iovËn
 = 1;

592 
msg
.
msg_cÚŒŞ
 = (
ÿddr_t
)
ù¾buf
;

593 
msg
.
msg_cÚŒŞËn
 = (
ù¾buf
);

595 if((
pbuæ’
 = 
	`»cvmsg
(
fd
, &
msg
, 0)) == -1)

597 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecvmsg");

603 if((
pbuæ’
 = 
	`»cv
(
fd
, 
rxbuf
, Ôxbuf), 0)è=ğ
SOCKET_ERROR
)

605 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecv");

611 if((
hl
 = 
	`_hl
(
_ou‹r
)) < 20)

613 
	`sÿm³r_debug
(
__func__
, "hÈ%d < 20", 
hl
);

621 if(
pbuæ’
 < 
hl
 + 8)

623 
	`sÿm³r_debug
(
__func__
, "pbuæ’ [%d] < iphÈ[%d] + 8", 
pbuæ’
, 
hl
);

627 
icmp
 = (icm°*)(
rxbuf
 + 
hl
);

628 
ty³
 = 
icmp
->
icmp_ty³
;

629 
code
 = 
icmp
->
icmp_code
;

632 if((
ty³
 !ğ
ICMP_TIMXCEED
 || 
code
 !ğ
ICMP_TIMXCEED_INTRANS
) &&

633 
ty³
 !ğ
ICMP_UNREACH
 &&y³ !ğ
ICMP_ECHOREPLY
 &&

634 
ty³
 !ğ
ICMP_TSTAMPREPLY
)

636 
	`sÿm³r_debug
(
__func__
, "ty³ %d, cod%d‚Ù wª‹d", 
ty³
, 
code
);

640 
	`mem£t
(
»¥
, 0, (
sÿm³r_icmp_»¥_t
));

642 
»¥
->
œ_fd
 = 
fd
;

649 if(
ty³
 =ğ
ICMP_ECHOREPLY
 ||y³ =ğ
ICMP_TSTAMPREPLY
)

651 
»¥
->
œ_icmp_id
 = 
	`Áohs
(
icmp
->
icmp_id
);

652 
»¥
->
œ_icmp_£q
 = 
	`Áohs
(
icmp
->
icmp_£q
);

653 
	`memıy
(&
»¥
->
œ_šÃr__d¡
.
v4
, &
_ou‹r
->
_¤c
,

654 (
š_addr
));

656 if(
ty³
 =ğ
ICMP_TSTAMPREPLY
)

658 
»¥
->
œ_icmp_tso
 = 
	`by‹s_Áohl
(
rxbuf
 + 
hl
 + 8);

659 
»¥
->
œ_icmp_t¤
 = 
	`by‹s_Áohl
(
rxbuf
 + 
hl
 + 12);

660 
»¥
->
œ_icmp_t¡
 = 
	`by‹s_Áohl
(
rxbuf
 + 
hl
 + 16);

663 #iâdeà
_WIN32


664 
	`icmp4_»cv_
(
fd
, 
»¥
, 
rxbuf
, 
hl
, &
msg
);

666 
	`icmp4_»cv_
(
fd
, 
»¥
, 
rxbuf
, 
hl
);

672 
_šÃr
 = &
icmp
->
icmp_
;

673 
nh
 = 
_šÃr
->
_p
;

674 
hlq
 = 
	`_hl
(
_šÃr
);

675 
poff£t
 = 
hl
 + 8 + 
hlq
;

678 
poff£t
 + 8 <ğ
pbuæ’
)

681 if(
nh
 !ğ
IPPROTO_UDP
 &&‚h !ğ
IPPROTO_ICMP
 &&‚h !ğ
IPPROTO_TCP
)

683 
	`sÿm³r_debug
(
__func__
, "unhªdËd‚exˆh—d” %d", 
nh
);

687 
»¥
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_INNER_IP
;

690 #iâdeà
_WIN32


691 
	`icmp4_»cv_
(
fd
, 
»¥
, 
rxbuf
, 
hl
, &
msg
);

693 
	`icmp4_»cv_
(
fd
, 
»¥
, 
rxbuf
, 
hl
);

697 
	`memıy
(&
»¥
->
œ_šÃr__d¡
.
v4
, &
_šÃr
->
_d¡
,

698 (
š_addr
));

700 
»¥
->
œ_šÃr__´Ùo
 = 
nh
;

701 
»¥
->
œ_šÃr__‰l
 = 
_šÃr
->
_‰l
;

702 
»¥
->
œ_šÃr__id
 = 
	`Áohs
(
_šÃr
->
_id
);

703 
»¥
->
œ_šÃr__off
 = 
	`Áohs
(
_šÃr
->
_off
è& 
IP_OFFMASK
;

704 
»¥
->
œ_šÃr__tos
 = 
_šÃr
->
_tos
;

705 
»¥
->
œ_šÃr__size
 = 
	`icmp4_quÙe__Ën
(
icmp
);

707 if(
ty³
 =ğ
ICMP_UNREACH
 && 
code
 =ğ
ICMP_UNREACH_NEEDFRAG
)

708 
»¥
->
œ_icmp_nhmtu
 = 
	`Áohs
(
icmp
->
icmp_Ãxtmtu
);

710 if(
»¥
->
œ_šÃr__off
 == 0)

712 
	`İt_·r£
(
»¥
, 
rxbuf
+
hl
+8, 
hlq
, 
_quÙe_¼
, 
_quÙe_ts
);

714 if(
nh
 =ğ
IPPROTO_UDP
)

716 
udp
 = (
udphdr
 *)(
rxbuf
+
poff£t
);

717 
»¥
->
œ_šÃr_udp_¥Üt
 = 
	`Áohs
(
udp
->
uh_¥Üt
);

718 
»¥
->
œ_šÃr_udp_dpÜt
 = 
	`Áohs
(
udp
->
uh_dpÜt
);

719 
»¥
->
œ_šÃr_udp_sum
 = 
udp
->
uh_sum
;

721 if(
nh
 =ğ
IPPROTO_ICMP
)

723 
icmp
 = (icm°*)(
rxbuf
+
poff£t
);

724 
»¥
->
œ_šÃr_icmp_ty³
 = 
icmp
->
icmp_ty³
;

725 
»¥
->
œ_šÃr_icmp_code
 = 
icmp
->
icmp_code
;

726 
»¥
->
œ_šÃr_icmp_sum
 = 
icmp
->
icmp_cksum
;

727 
»¥
->
œ_šÃr_icmp_id
 = 
	`Áohs
(
icmp
->
icmp_id
);

728 
»¥
->
œ_šÃr_icmp_£q
 = 
	`Áohs
(
icmp
->
icmp_£q
);

730 if(
nh
 =ğ
IPPROTO_TCP
)

732 
tı
 = (
tıhdr
 *)(
rxbuf
+
poff£t
);

733 
»¥
->
œ_šÃr_tı_¥Üt
 = 
	`Áohs
(
tı
->
th_¥Üt
);

734 
»¥
->
œ_šÃr_tı_dpÜt
 = 
	`Áohs
(
tı
->
th_dpÜt
);

735 
»¥
->
œ_šÃr_tı_£q
 = 
	`Áohl
(
tı
->
th_£q
);

740 
»¥
->
œ_šÃr_d©a
 = 
rxbuf
 + 
poff£t
;

741 
»¥
->
œ_šÃr_d©®’
 = 
pbuæ’
 - 
poff£t
;

754 if(
pbuæ’
 - (
hl
+8) > 128 + 4)

756 
ext
 = 
rxbuf
 + (
hl
 + 8 + 128);

757 
ex’
 = 
pbuæ’
 - (
hl
 + 8 + 128);

759 if(((
ext
[0] & 0xf0) == 0x20 ||ƒxt[0] == 0x02) &&

760 ((
ext
[2] =ğ0 &&ƒxt[3] =ğ0è|| 
	`š_cksum
Óxt, 
ex’
) == 0))

762 
»¥
->
œ_ext
 = 
	`memdup
(
ext
, 
ex’
);

763 
»¥
->
œ_ex’
 = 
ex’
;

770 
	`sÿm³r_debug
(
__func__
, "packet‚ot ours");

773 
	}
}

775 
	$sÿm³r_icmp4_»ad_cb
(cÚ¡ 
fd
, *
·¿m
)

777 
sÿm³r_icmp_»¥_t
 
œ
;

779 
	`mem£t
(&
œ
, 0, (ir));

781 if(
	`sÿm³r_icmp4_»cv
(
fd
, &
œ
) == 0)

782 
	`sÿm³r_icmp_»¥_hªdË
(&
œ
);

784 
	`sÿm³r_icmp_»¥_ş—n
(&
œ
);

787 
	}
}

789 
	$sÿm³r_icmp4_ş—nup
()

791 if(
txbuf
 !ğ
NULL
)

793 
	`ä“
(
txbuf
);

794 
txbuf
 = 
NULL
;

798 
	}
}

800 
	$sÿm³r_icmp4_şo£
(
fd
)

802 #iâdeà
_WIN32


803 
	`şo£
(
fd
);

805 
	`şo£sock‘
(
fd
);

808 
	}
}

810 
	$sÿm³r_icmp4_İ’
(cÚ¡ *
addr
)

812 
sockaddr_š
 
sš
;

813 
tmp
[32];

814 
fd
 = -1;

815 
İt
;

817 #ià
	`defšed
(
ICMP_FILTER
)

818 
icmp_f‹r
 
f‹r
;

821 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

822 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_ICMP
)) == -1)

824 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open ICMP socket");

825 
”r
;

827 
İt
 = 1;

828 if(
	`£tsockİt
(
fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, (*)&
İt
, (opt)) == -1)

830 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IP_HDRINCL");

831 
”r
;

834 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_icmp
(
AF_INET
)) == -1)

836 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open ICMP socket");

837 
”r
;

841 
İt
 = 65535 + 128;

842 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*)&
İt
, (opt)) == -1)

844 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_RCVBUF");

845 
”r
;

848 #ià
	`defšed
(
SO_TIMESTAMP
)

849 
İt
 = 1;

850 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_TIMESTAMP
, &
İt
, (opt)) == -1)

852 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_TIMESTAMP");

853 
”r
;

861 #ià
	`defšed
(
ICMP_FILTER
)

862 
f‹r
.
d©a
 = ~((1 << 
ICMP_DEST_UNREACH
) |

863 (1 << 
ICMP_TIME_EXCEEDED
) |

864 (1 << 
ICMP_ECHOREPLY
) |

865 (1 << 
ICMP_TSTAMPREPLY
)

867 if(
	`£tsockİt
(
fd
, 
SOL_RAW
, 
ICMP_FILTER
, &
f‹r
, (filter)) == -1)

869 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set ICMP_FILTER");

870 
”r
;

874 if(
addr
 !ğ
NULL
)

876 
	`sockaddr_compo£
((
sockaddr
 *)&
sš
, 
AF_INET
, 
addr
, 0);

877 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš
, (sin)) != 0)

879 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind %s",

880 
	`sockaddr_to¡r
((
sockaddr
 *)&
sš
,
tmp
,(tmp)));

881 
”r
;

885  
fd
;

887 
”r
:

888 if(
fd
 !ğ-1è
	`sÿm³r_icmp4_şo£
(fd);

890 
	}
}

	@scamper_icmp4.h

25 #iâdeà
__SCAMPER_ICMP4_H


26 
	#__SCAMPER_ICMP4_H


	)

28 
sÿm³r_icmp4_İ’
(cÚ¡ *
addr
);

29 
sÿm³r_icmp4_şo£
(
fd
);

31 
sÿm³r_icmp4_ş—nup
();

32 
sÿm³r_icmp4_»ad_cb
(cÚ¡ 
fd
, *
·¿m
);

34 #ifdeà
__SCAMPER_PROBE_H


35 
sÿm³r_icmp4_´obe
(
sÿm³r_´obe_t
 *
´obe
);

36 
sÿm³r_icmp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

37 
ušt16_t
 
sÿm³r_icmp4_cksum
(
sÿm³r_´obe_t
 *
´obe
);

40 #ifdeà
__SCAMPER_ICMP_RESP_H


41 
sÿm³r_icmp4_»cv
(
fd
, 
sÿm³r_icmp_»¥_t
 *
»¥
);

	@scamper_icmp6.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_dl.h
"

38 
	~"sÿm³r_´obe.h
"

39 
	~"sÿm³r_icmp_»¥.h
"

40 
	~"sÿm³r_6.h
"

41 
	~"sÿm³r_icmp6.h
"

42 
	~"sÿm³r_´iv£p.h
"

43 
	~"sÿm³r_debug.h
"

44 
	~"uts.h
"

46 
ušt8_t
 *
	gtxbuf
 = 
NULL
;

47 
size_t
 
	gtxbuf_Ën
 = 0;

48 
ušt8_t
 
	grxbuf
[65536];

50 
	$icmp6_h—d”
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
)

52 
buf
[0] = 
´obe
->
´_icmp_ty³
;

53 
buf
[1] = 0;

54 
buf
[2] = 0; buf[3] = 0;

56 
´obe
->
´_icmp_ty³
)

58 
ICMP6_ECHO_REQUEST
:

59 
ICMP6_ECHO_REPLY
:

60 
	`by‹s_htÚs
(
buf
+4, 
´obe
->
´_icmp_id
);

61 
	`by‹s_htÚs
(
buf
+6, 
´obe
->
´_icmp_£q
);

64 
ICMP6_PACKET_TOO_BIG
:

65 
	`by‹s_htÚl
(
buf
+4, 
´obe
->
´_icmp_mtu
);

69 
	`mem£t
(
buf
+4, 0, 4);

74 
	}
}

76 
ušt16_t
 
	$sÿm³r_icmp6_cksum
(
sÿm³r_´obe_t
 *
´obe
)

78 
ušt8_t
 
hdr
[8];

79 
ušt16_t
 
tmp
, *
w
;

80 
i
, 
sum
 = 0;

88 
w
 = (
ušt16_t
 *)
´obe
->
´__¤c
->
addr
;

89 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

90 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

91 
w
 = (
ušt16_t
 *)
´obe
->
´__d¡
->
addr
;

92 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

93 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

94 
sum
 +ğ
	`htÚs
(
´obe
->
´_Ën
 + 8);

95 
sum
 +ğ
	`htÚs
(
IPPROTO_ICMPV6
);

98 
	`icmp6_h—d”
(
´obe
, 
hdr
);

99 
w
 = (
ušt16_t
 *)
hdr
;

100 
i
=0; i<8; i+=2)

101 
sum
 +ğ*
w
++;

104 
w
 = (
ušt16_t
 *)
´obe
->
´_d©a
;

105 
i
 = 
´obe
->
´_Ën
; i > 1; i -= 2)

106 
sum
 +ğ*
w
++;

107 if(
i
 != 0)

108 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

111 
sum
 = (sum >> 16) + (sum & 0xffff);

112 
sum
 += (sum >> 16);

114 if((
tmp
 = ~
sum
) == 0)

116 
tmp
 = 0xffff;

119  
tmp
;

120 
	}
}

122 
	$sÿm³r_icmp6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

124 
6_hdr
 *
6
;

125 
icmp6_hdr
 *
icmp
;

126 
size_t
 
6hËn
, 
»q
, 
icmp6hËn
;

133 
6hËn
 = *
Ën
;

134 
	`sÿm³r_6_bud
(
´obe
, 
buf
, &
6hËn
);

137 
icmp6hËn
 = 8;

140 
»q
 = 
6hËn
 + 
icmp6hËn
 + 
´obe
->
´_Ën
;

142 if(
»q
 <ğ*
Ën
)

148 
6
 = (
6_hdr
 *)
buf
;

149 
6
->
6_¶’
 = 
	`htÚs
(
6hËn
 - 40 + 
icmp6hËn
 + 
´obe
->
´_Ën
);

152 
icmp
 = (
icmp6_hdr
 *)(
buf
 + 
6hËn
);

153 
	`icmp6_h—d”
(
´obe
, 
buf
+
6hËn
);

156 if(
´obe
->
´_Ën
 > 0)

158 
	`memıy
(
buf
 + 
6hËn
 + 
icmp6hËn
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

162 
icmp
->
icmp6_cksum
 = 
	`sÿm³r_icmp6_cksum
(
´obe
);

164 *
Ën
 = 
»q
;

168 *
Ën
 = 
»q
;

170 
	}
}

172 
	$sÿm³r_icmp6_´obe
(
sÿm³r_´obe_t
 *
´obe
)

174 
sockaddr_š6
 
sš6
;

175 
icmp6_hdr
 *
icmp
;

176 
addr
[128];

177 
size_t
 
Ën
, 
icmphd¾’
;

178 
i
;

180 
	`as£¹
(
´obe
 !ğ
NULL
);

181 
	`as£¹
(
´obe
->
´__´Ùo
 =ğ
IPPROTO_ICMPV6
);

182 
	`as£¹
(
´obe
->
´__d¡
 !ğ
NULL
);

183 
	`as£¹
(
´obe
->
´__¤c
 !ğ
NULL
);

184 
	`as£¹
(
´obe
->
´_Ën
 > 0 ||…robe->
´_d©a
 =ğ
NULL
);

186 if(
´obe
->
´_icmp_ty³
 !ğ
ICMP6_ECHO_REQUEST
)

188 
´obe
->
´_”ºo
 = 
EINVAL
;

192 
icmphd¾’
 = (1 + 1 + 2 + 2 + 2);

193 
Ën
 = 
´obe
->
´_Ën
 + 
icmphd¾’
;

195 
i
 = 
´obe
->
´__‰l
;

196 if(
	`£tsockİt
(
´obe
->
´_fd
,

197 
IPPROTO_IPV6
, 
IPV6_UNICAST_HOPS
, (*)&
i
, (i)) == -1)

199 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù s‘ hlimØ%d", 
i
);

203 
i
 = 
Ën
;

204 if(
	`£tsockİt
(
´obe
->
´_fd
,

205 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
i
, (i)) == -1)

207 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

208 "could‚Ù s‘ bufã¸tØ%d by‹s", 
i
);

212 if(
txbuf_Ën
 < 
Ën
)

214 if(
	`»®loc_w¿p
((**)&
txbuf
, 
Ën
) != 0)

216 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

219 
txbuf_Ën
 = 
Ën
;

222 
icmp
 = (
icmp6_hdr
 *)
txbuf
;

223 
icmp
->
icmp6_ty³
 = 
´obe
->
´_icmp_ty³
;

224 
icmp
->
icmp6_code
 = 
´obe
->
´_icmp_code
;

225 
icmp
->
icmp6_cksum
 = 0;

226 
icmp
->
icmp6_id
 = 
	`htÚs
(
´obe
->
´_icmp_id
);

227 
icmp
->
icmp6_£q
 = 
	`htÚs
(
´obe
->
´_icmp_£q
);

230 if(
´obe
->
´_Ën
 > 0)

232 
	`memıy
(
txbuf
 + 
icmphd¾’
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

235 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
,

236 
´obe
->
´__d¡
->
addr
, 0);

239 
	`g‘timeofday_w¿p
(&
´obe
->
´_tx
);

241 
i
 = 
	`£ndto
(
´obe
->
´_fd
, 
txbuf
, 
Ën
, 0, (
sockaddr
 *)&
sš6
,

242 (
sockaddr_š6
));

244 if(
i
 < 0)

247 
´obe
->
´_”ºo
 = 
”ºo
;

248 
	`´š‹¼Ü
(
´obe
->
´_”ºo
, 
¡»¼Ü
, 
__func__
,

250 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)),

251 
´obe
->
´__‰l
,…robe->
´_icmp_£q
, 
Ën
);

254 if((
size_t
)
i
 !ğ
Ën
)

257 
	`årštf
(
¡d”r
,

259 
i
, ()
Ën
,

260 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)));

265 
	}
}

273 
icmp6_»cv__ou‹r
(
fd
, 
sÿm³r_icmp_»¥_t
 *
»¥
,

274 #iâdeà
_WIN32


275 
msghdr
 *
msg
,

277 
icmp6_hdr
 *
icmp
,

278 
sockaddr_š6
 *
äom
, 
size_t
 
size
)

280 
št16_t
 
	ghlim
 = -1;

282 #ià(
defšed
(
IPV6_HOPLIMIT
è|| defšed(
SO_TIMESTAMP
)è&& !defšed(
_WIN32
)

284 
cmsghdr
 *
	gcm
;

290 if(
	gmsg
->
	gmsg_cÚŒŞËn
 >ğ(
cmsghdr
))

292 
cm
 = (
cmsghdr
 *)
CMSG_FIRSTHDR
(
msg
);

293 
	gcm
 !ğ
NULL
)

295 #ià
defšed
(
IPV6_HOPLIMIT
)

296 if(
cm
->
cmsg_Ëv–
 =ğ
IPPROTO_IPV6
 && cm->
cmsg_ty³
 =ğ
IPV6_HOPLIMIT
)

297 
hlim
 = *((
ušt8_t
 *)
CMSG_DATA
(
cm
));

300 #ià
defšed
(
SO_TIMESTAMP
)

301 if(
	gcm
->
	gcmsg_Ëv–
 =ğ
SOL_SOCKET
 && 
cm
->
cmsg_ty³
 =ğ
SCM_TIMESTAMP
)

303 
timev®_ıy
(&
»¥
->
œ_rx
, (
timev®
 *)
CMSG_DATA
(
cm
));

304 
	g»¥
->
	gœ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_KERNRX
;

307 
	gcm
 = (
cmsghdr
 *)
CMSG_NXTHDR
(
msg
, 
cm
);

312 #ià
defšed
(
SIOCGSTAMP
)

313 if((
	g»¥
->
	gœ_æags
 & 
	gSCAMPER_ICMP_RESP_FLAG_KERNRX
) == 0)

315 if(
ioùl
(
fd
, 
SIOCGSTAMP
, &
»¥
->
œ_rx
) != -1)

316 
»¥
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_KERNRX
;

320 if((
	g»¥
->
	gœ_æags
 & 
	gSCAMPER_ICMP_RESP_FLAG_KERNRX
) == 0)

321 
g‘timeofday_w¿p
(&
»¥
->
œ_rx
);

323 
memıy
(&
»¥
->
œ__¤c
.
v6
, &
äom
->
sš6_addr
, (
š6_addr
));

325 
	g»¥
->
	gœ_af
 = 
AF_INET6
;

326 
	g»¥
->
	gœ_icmp_ty³
 = 
icmp
->
icmp6_ty³
;

327 
	g»¥
->
	gœ_icmp_code
 = 
icmp
->
icmp6_code
;

328 
	g»¥
->
	gœ__hlim
 = 
hlim
;

329 
	g»¥
->
	gœ__size
 = 
size
;

346 
	$sÿm³r_icmp6_»cv
(
fd
, 
sÿm³r_icmp_»¥_t
 *
»¥
)

348 
sockaddr_š6
 
äom
;

349 
ssize_t
 
poff£t
;

350 
ssize_t
 
pbuæ’
;

351 
icmp6_hdr
 *
icmp
, *
icmpq
;

352 
6_hdr
 *

;

353 
6_äag
 *
äag
;

354 
udphdr
 *
udp
;

355 
tıhdr
 *
tı
;

356 
ušt8_t
 
ty³
, 
code
;

357 
ušt8_t
 
nh
;

358 
ušt8_t
 *
ext
;

359 
ssize_t
 
ex’
;

361 #iâdeà
_WIN32


362 
ušt8_t
 
ù¾buf
[256];

363 
msghdr
 
msg
;

364 
iovec
 
iov
;

366 
	`mem£t
(&
iov
, 0, (iov));

367 
iov
.
iov_ba£
 = (
ÿddr_t
)
rxbuf
;

368 
iov
.
iov_Ën
 = (
rxbuf
);

370 
msg
.
msg_Çme
 = (
ÿddr_t
)&
äom
;

371 
msg
.
msg_Çm–’
 = (
äom
);

372 
msg
.
msg_iov
 = &
iov
;

373 
msg
.
msg_iovËn
 = 1;

374 
msg
.
msg_cÚŒŞ
 = (
ÿddr_t
)
ù¾buf
;

375 
msg
.
msg_cÚŒŞËn
 = (
ù¾buf
);

377 if((
pbuæ’
 = 
	`»cvmsg
(
fd
, &
msg
, 0)) == -1)

379 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecvmsg");

384 #ifdeà
_WIN32


385 if((
pbuæ’
 = 
	`»cv
(
fd
, 
rxbuf
, (rxbuf), 0)) < 0)

387 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecv");

392 
icmp
 = (
icmp6_hdr
 *)
rxbuf
;

393 if(
pbuæ’
 < (
ssize_t
)(
icmp6_hdr
))

398 
ty³
 = 
icmp
->
icmp6_ty³
;

399 
code
 = 
icmp
->
icmp6_code
;

402 if((
ty³
 !ğ
ICMP6_TIME_EXCEEDED
 || 
code
 !ğ
ICMP6_TIME_EXCEED_TRANSIT
) &&

403 
ty³
 !ğ
ICMP6_DST_UNREACH
 &&y³ !ğ
ICMP6_PACKET_TOO_BIG
 &&

404 
ty³
 !ğ
ICMP6_ECHO_REPLY
)

406 
	`sÿm³r_debug
(
__func__
,"ICMP6y³ %d / cod%d‚Ù wª‹d", 
ty³
, 
code
);

410 
poff£t
 = (
icmp6_hdr
);

411 

 = (
6_hdr
 *)(
rxbuf
 + 
poff£t
);

413 
	`mem£t
(
»¥
, 0, (
sÿm³r_icmp_»¥_t
));

415 
»¥
->
œ_fd
 = 
fd
;

417 if(
ty³
 =ğ
ICMP6_ECHO_REPLY
)

419 
»¥
->
œ_icmp_id
 = 
	`Áohs
(
icmp
->
icmp6_id
);

420 
»¥
->
œ_icmp_£q
 = 
	`Áohs
(
icmp
->
icmp6_£q
);

421 
	`memıy
(&
»¥
->
œ_šÃr__d¡
.
v6
, &
äom
.
sš6_addr
,

422 (
š6_addr
));

424 #iâdeà
_WIN32


425 
	`icmp6_»cv__ou‹r
(
fd
,
»¥
,&
msg
,
icmp
,&
äom
,

426 
pbuæ’
 + (
6_hdr
));

428 
	`icmp6_»cv__ou‹r
(
fd
,
»¥
,
icmp
,&
äom
,
pbuæ’
+(
6_hdr
));

434 
nh
 = 

->
6_nxt
;

435 
poff£t
 +ğ(
6_hdr
);

438 
poff£t
 + 8 <ğ
pbuæ’
)

440 if(
nh
 !ğ
IPPROTO_UDP
 &&‚h !ğ
IPPROTO_ICMPV6
 &&‚h !ğ
IPPROTO_TCP
 &&

441 
nh
 !ğ
IPPROTO_FRAGMENT
)

443 
	`sÿm³r_debug
(
__func__
, "unhªdËd‚exˆh—d” %d", 
nh
);

447 
»¥
->
œ_æags
 |ğ
SCAMPER_ICMP_RESP_FLAG_INNER_IP
;

449 if(
nh
 =ğ
IPPROTO_UDP
)

451 
udp
 = (
udphdr
 *)(
rxbuf
+
poff£t
);

452 
»¥
->
œ_šÃr_udp_¥Üt
 = 
	`Áohs
(
udp
->
uh_¥Üt
);

453 
»¥
->
œ_šÃr_udp_dpÜt
 = 
	`Áohs
(
udp
->
uh_dpÜt
);

454 
»¥
->
œ_šÃr_udp_sum
 = 
udp
->
uh_sum
;

456 if(
nh
 =ğ
IPPROTO_ICMPV6
)

458 
icmpq
 = (
icmp6_hdr
 *)(
rxbuf
+
poff£t
);

459 
»¥
->
œ_šÃr_icmp_ty³
 = 
icmpq
->
icmp6_ty³
;

460 
»¥
->
œ_šÃr_icmp_code
 = 
icmpq
->
icmp6_code
;

461 
»¥
->
œ_šÃr_icmp_sum
 = 
icmpq
->
icmp6_cksum
;

462 
»¥
->
œ_šÃr_icmp_id
 = 
	`Áohs
(
icmpq
->
icmp6_id
);

463 
»¥
->
œ_šÃr_icmp_£q
 = 
	`Áohs
(
icmpq
->
icmp6_£q
);

465 if(
nh
 =ğ
IPPROTO_TCP
)

467 
tı
 = (
tıhdr
 *)(
rxbuf
+
poff£t
);

468 
»¥
->
œ_šÃr_tı_¥Üt
 = 
	`Áohs
(
tı
->
th_¥Üt
);

469 
»¥
->
œ_šÃr_tı_dpÜt
 = 
	`Áohs
(
tı
->
th_dpÜt
);

470 
»¥
->
œ_šÃr_tı_£q
 = 
	`Áohl
(
tı
->
th_£q
);

472 if(
nh
 =ğ
IPPROTO_FRAGMENT
)

474 
äag
 = (
6_äag
 *)(
rxbuf
+
poff£t
);

475 
»¥
->
œ_šÃr__´Ùo
 = 
nh
 = 
äag
->
6f_nxt
;

476 
»¥
->
œ_šÃr__off
 = 
	`Áohs
(
äag
->
6f_ofæg
) >> 3;

477 
»¥
->
œ_šÃr__id
 = 
	`Áohl
(
äag
->
6f_id’t
);

478 
poff£t
 += 8;

480 if(
»¥
->
œ_šÃr__off
 == 0)

483 
»¥
->
œ_šÃr_d©a
 = 
rxbuf
 + 
poff£t
;

484 
»¥
->
œ_šÃr_d©®’
 = 
pbuæ’
 - 
poff£t
;

488 #iâdeà
_WIN32


489 
	`icmp6_»cv__ou‹r
(
fd
,
»¥
,&
msg
,
icmp
,&
äom
,

490 
pbuæ’
 + (
6_hdr
));

492 
	`icmp6_»cv__ou‹r
(
fd
,
»¥
,
icmp
,&
äom
,
pbuæ’
+(
6_hdr
));

495 
	`memıy
(&
»¥
->
œ_šÃr__d¡
.
v6
, &

->
6_d¡
, (
š6_addr
));

496 
»¥
->
œ_šÃr__´Ùo
 = 
nh
;

497 
»¥
->
œ_šÃr__hlim
 = 

->
6_hlim
;

498 
»¥
->
œ_šÃr__size
 = 
	`Áohs
(

->
6_¶’
è+ (
6_hdr
);

499 
»¥
->
œ_šÃr__æow
 = 
	`Áohl
(

->
6_æow
) & 0xfffff;

501 if(
ty³
 =ğ
ICMP6_PACKET_TOO_BIG
)

502 
»¥
->
œ_icmp_nhmtu
 = (
	`Áohl
(
icmp
->
icmp6_mtu
) % 0xffff);

511 if(
pbuæ’
 - 8 > 128 + 4)

513 
ext
 = 
rxbuf
 + (8 + 128);

514 
ex’
 = 
pbuæ’
 - (8 + 128);

516 if((
ext
[0] & 0xf0) == 0x20 &&

517 ((
ext
[2] =ğ0 &&ƒxt[3] =ğ0è|| 
	`š_cksum
Óxt, 
ex’
) == 0))

519 
»¥
->
œ_ext
 = 
	`memdup
(
ext
, 
ex’
);

520 
»¥
->
œ_ex’
 = 
ex’
;

528 
	}
}

530 
	$sÿm³r_icmp6_»ad_cb
(cÚ¡ 
fd
, *
·¿m
)

532 
sÿm³r_icmp_»¥_t
 
œ
;

534 
	`mem£t
(&
œ
, 0, (ir));

536 if(
	`sÿm³r_icmp6_»cv
(
fd
, &
œ
) == 0)

537 
	`sÿm³r_icmp_»¥_hªdË
(&
œ
);

539 
	`sÿm³r_icmp_»¥_ş—n
(&
œ
);

542 
	}
}

544 
	$sÿm³r_icmp6_ş—nup
()

546 if(
txbuf
 !ğ
NULL
)

548 
	`ä“
(
txbuf
);

549 
txbuf
 = 
NULL
;

553 
	}
}

555 
	$sÿm³r_icmp6_şo£
(
fd
)

557 #iâdeà
_WIN32


558 
	`şo£
(
fd
);

560 
	`şo£sock‘
(
fd
);

563 
	}
}

565 
	$sÿm³r_icmp6_İ’
(cÚ¡ *
addr
)

567 
sockaddr_š6
 
sš6
;

568 
fd
 = -1;

569 
İt
;

571 #ià
	`defšed
(
ICMP6_FILTER
)

572 
icmp6_f‹r
 
f‹r
;

575 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

576 if((
fd
 = 
	`sock‘
(
AF_INET6
, 
SOCK_RAW
, 
IPPROTO_ICMPV6
)) == -1)

578 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_icmp
(
AF_INET6
)) == -1)

581 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open ICMP socket");

582 
”r
;

585 
İt
 = 65535 + 128;

586 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*)&
İt
, (opt)) == -1)

588 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot SO_RCVBUF");

589 
”r
;

592 #ià
	`defšed
(
SO_TIMESTAMP
)

593 
İt
 = 1;

594 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_TIMESTAMP
, &
İt
, (opt)) == -1)

596 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_TIMESTAMP");

597 
”r
;

601 #ià
	`defšed
(
ICMP6_FILTER
)

607 
	`ICMP6_FILTER_SETBLOCKALL
(&
f‹r
);

608 
	`ICMP6_FILTER_SETPASS
(
ICMP6_DST_UNREACH
, &
f‹r
);

609 
	`ICMP6_FILTER_SETPASS
(
ICMP6_PACKET_TOO_BIG
, &
f‹r
);

610 
	`ICMP6_FILTER_SETPASS
(
ICMP6_TIME_EXCEEDED
, &
f‹r
);

611 
	`ICMP6_FILTER_SETPASS
(
ICMP6_ECHO_REPLY
, &
f‹r
);

612 if(
	`£tsockİt
(
fd
,
IPPROTO_ICMPV6
,
ICMP6_FILTER
,&
f‹r
,(filter)) == -1)

614 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot IPV6_FILTER");

615 
”r
;

619 #ià
	`defšed
(
IPV6_DONTFRAG
)

620 
İt
 = 1;

621 if(
	`£tsockİt
(
fd
,
IPPROTO_IPV6
,
IPV6_DONTFRAG
,(*)&
İt
, (opt)) == -1)

623 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IPV6_DONTFRAG");

624 
”r
;

632 #ià
	`defšed
(
IPV6_RECVHOPLIMIT
)

633 
İt
 = 1;

634 if(
	`£tsockİt
(
fd
, 
IPPROTO_IPV6
,
IPV6_RECVHOPLIMIT
, &
İt
,(opt)) == -1)

636 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IPV6_RECVHOPLIMIT");

638 #–ià
	`defšed
(
IPV6_HOPLIMIT
)

639 
İt
 = 1;

640 if(
	`£tsockİt
(
fd
,
IPPROTO_IPV6
,
IPV6_HOPLIMIT
,(*)&
İt
,(opt)) == -1)

642 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IPV6_HOPLIMIT");

646 if(
addr
 !ğ
NULL
)

648 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
, 
addr
, 0);

649 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš6
, (sin6)) != 0)

651 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind");

652 
”r
;

656  
fd
;

658 
”r
:

659 if(
fd
 !ğ-1è
	`sÿm³r_icmp6_şo£
(fd);

661 
	}
}

	@scamper_icmp6.h

25 #iâdeà
__SCAMPER_ICMP6_H


26 
	#__SCAMPER_ICMP6_H


	)

28 
sÿm³r_icmp6_İ’
(cÚ¡ *
addr
);

29 
sÿm³r_icmp6_şo£
(
fd
);

31 
sÿm³r_icmp6_ş—nup
();

32 
sÿm³r_icmp6_»ad_cb
(cÚ¡ 
fd
, *
·¿m
);

34 #ifdeà
__SCAMPER_PROBE_H


35 
sÿm³r_icmp6_´obe
(
sÿm³r_´obe_t
 *
´obe
);

36 
sÿm³r_icmp6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

37 
ušt16_t
 
sÿm³r_icmp6_cksum
(
sÿm³r_´obe_t
 *
´obe
);

40 #ifdeà
__SCAMPER_ICMP_RESP_H


41 
sÿm³r_icmp6_»cv
(
fd
, 
sÿm³r_icmp_»¥_t
 *
»¥
);

	@scamper_icmp_resp.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"uts.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_sk.h
"

39 
	~"sÿm³r_icmp_»¥.h
"

40 
	~"sÿm³r_debug.h
"

42 #ià!
defšed
(
NDEBUG
è&& !defšed(
WITHOUT_DEBUGFILE
)

43 
	$sÿm³r_icmp_»¥_´št
(cÚ¡ 
sÿm³r_icmp_»¥_t
 *
œ
)

45 *
t
 = 
NULL
, 
tbuf
[64];

46 *
c
 = 
NULL
, 
cbuf
[64];

47 
addr
[64];

48 

[256];

49 
icmp
[256];

50 
šÃr_
[256];

51 
šÃr_Œª¥Üt
[256];

52 
ext
[256];

53 
i
, 
j
;

54 
size_t
 
off
;

56 
	`as£¹
(
œ
->
œ_af
 =ğ
AF_INET
 || ir->œ_aà=ğ
AF_INET6
);

58 if(
œ
->
œ_af
 =ğ
AF_INET
)

60 
	`addr_to¡r
(
AF_INET
, &
œ
->
œ__¤c
.
v4
, 
addr
, (addr));

62 
off
 = 0;

63 
	`¡ršg_cÚÿt
(

, (), &
off
,

65 
addr
, 
œ
->
œ__size
, ir->
œ__‰l
, ir->
œ__tos
,

66 
œ
->
œ__id
);

68 if(
œ
->
œ_İt_¼c
 > 0)

69 
	`¡ršg_cÚÿt
(

, (), &
off
, "„¸%d", 
œ
->
œ_İt_¼c
);

71 
œ
->
œ_icmp_ty³
)

73 
ICMP_UNREACH
:

74 
t
 = "unreach";

75 
œ
->
œ_icmp_code
)

77 
ICMP_UNREACH_NET
: 
c
 = "net"; ;

78 
ICMP_UNREACH_HOST
: 
c
 = "host"; ;

79 
ICMP_UNREACH_PROTOCOL
: 
c
 = "protocol"; ;

80 
ICMP_UNREACH_PORT
: 
c
 = "port"; ;

81 
ICMP_UNREACH_SRCFAIL
: 
c
 = "src-rt failed"; ;

82 
ICMP_UNREACH_NET_UNKNOWN
: 
c
 = "net unknown"; ;

83 
ICMP_UNREACH_HOST_UNKNOWN
: 
c
 = "host unknown"; ;

84 
ICMP_UNREACH_ISOLATED
: 
c
 = "isolated"; ;

85 
ICMP_UNREACH_NET_PROHIB
: 
c
 = "net…rohib"; ;

86 
ICMP_UNREACH_HOST_PROHIB
: 
c
 = "host…rohib"; ;

87 
ICMP_UNREACH_TOSNET
: 
c
 = "tos‚et"; ;

88 
ICMP_UNREACH_TOSHOST
: 
c
 = "tos host"; ;

89 
ICMP_UNREACH_FILTER_PROHIB
: 
c
 = "admin…rohib"; ;

90 
ICMP_UNREACH_NEEDFRAG
:

95 
	`¢´štf
(
tbuf
, Ñbuf), "Ãed f¿g %d", 
œ
->
œ_icmp_nhmtu
);

96 
t
 = 
tbuf
;

100 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
œ
->
œ_icmp_code
);

101 
c
 = 
cbuf
;

106 
ICMP_TIMXCEED
:

107 
t
 = "timeƒxceeded";

108 
œ
->
œ_icmp_code
)

110 
ICMP_TIMXCEED_INTRANS
: 
c
 = "inrans"; ;

111 
ICMP_TIMXCEED_REASS
: 
c
 = "in„eass"; ;

113 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
œ
->
œ_icmp_code
);

114 
c
 = 
cbuf
;

119 
ICMP_ECHOREPLY
:

120 
t
 = "echo„eply";

121 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

122 
œ
->
œ_icmp_id
, ir->
œ_icmp_£q
);

123 
c
 = 
cbuf
;

126 
ICMP_TSTAMPREPLY
:

127 
t
 = "ts„eply";

128 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

129 
œ
->
œ_icmp_id
, ir->
œ_icmp_£q
);

130 
c
 = 
cbuf
;

136 
	`addr_to¡r
(
AF_INET6
, &
œ
->
œ__¤c
.
v6
, 
addr
, (addr));

138 
	`¢´štf
(

, (), "äom % siz%d hlim %d", 
addr
,

139 
œ
->
œ__size
, ir->
œ__hlim
);

141 
œ
->
œ_icmp_ty³
)

143 
ICMP6_DST_UNREACH
:

144 
t
 = "unreach";

145 
œ
->
œ_icmp_code
)

147 
ICMP6_DST_UNREACH_NOROUTE
: 
c
 = "no„oute"; ;

148 
ICMP6_DST_UNREACH_ADMIN
: 
c
 = "admin…rohib"; ;

149 
ICMP6_DST_UNREACH_BEYONDSCOPE
: 
c
 = "beyond scope"; ;

150 
ICMP6_DST_UNREACH_ADDR
: 
c
 = "addr"; ;

151 
ICMP6_DST_UNREACH_NOPORT
: 
c
 = "port"; ;

154 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
œ
->
œ_icmp_code
);

155 
c
 = 
cbuf
;

160 
ICMP6_TIME_EXCEEDED
:

161 
t
 = "timeƒxceeded";

162 
œ
->
œ_icmp_code
)

164 
ICMP6_TIME_EXCEED_TRANSIT
: 
c
 = "inrans"; ;

165 
ICMP6_TIME_EXCEED_REASSEMBLY
: 
c
 = "in„eass"; ;

168 
	`¢´štf
(
cbuf
, (cbuf), "cod%d", 
œ
->
œ_icmp_code
);

169 
c
 = 
cbuf
;

174 
ICMP6_PACKET_TOO_BIG
:

175 
	`¢´štf
(
tbuf
, Ñbuf), "Ãed f¿g %d", 
œ
->
œ_icmp_nhmtu
);

176 
t
 = 
tbuf
;

179 
ICMP6_ECHO_REPLY
:

180 
t
 = "echo„eply";

181 
	`¢´štf
(
cbuf
, (cbuf), "id %d seq %d",

182 
œ
->
œ_icmp_id
, ir->
œ_icmp_£q
);

183 
c
 = 
cbuf
;

188 if(
t
 =ğ
NULL
)

190 
	`¢´štf
(
icmp
, (icmp), "icmp %d code %d",

191 
œ
->
œ_icmp_ty³
, ir->
œ_icmp_code
);

193 if(
c
 =ğ
NULL
)

195 
	`¢´štf
(
icmp
, (icmp), "icm°%s", 
t
);

199 
	`¢´štf
(
icmp
, (icmp), "icm°% %s", 
t
, 
c
);

202 if(
œ
->
œ_æags
 & 
SCAMPER_ICMP_RESP_FLAG_INNER_IP
)

204 if(
œ
->
œ_af
 =ğ
AF_INET
)

206 
	`addr_to¡r
(
AF_INET
, &
œ
->
œ_šÃr__d¡
.
v4
, 
addr
, (addr));

208 
off
 = 0;

209 
	`¡ršg_cÚÿt
(
šÃr_
, (šÃr_), &
off
,

211 
addr
, 
œ
->
œ_šÃr__size
, ir->
œ_šÃr__‰l
,

212 
œ
->
œ_šÃr__tos
, ir->
œ_šÃr__id
);

213 if(
œ
->
œ_šÃr_İt_¼c
 > 0)

214 
	`¡ršg_cÚÿt
(
šÃr_
, (šÃr_), &
off
, "„r %d",

215 
œ
->
œ_šÃr_İt_¼c
);

219 
	`addr_to¡r
(
AF_INET6
, &
œ
->
œ_šÃr__d¡
.
v6
, 
addr
, (addr));

220 
	`¢´štf
(
šÃr_
, (inner_ip),

221 "Ø% siz%d hlim %d flow 0x%05x", 
addr
,

222 
œ
->
œ_šÃr__size
, ir->
œ_šÃr__hlim
,

223 
œ
->
œ_šÃr__æow
);

226 
œ
->
œ_šÃr__´Ùo
)

228 
IPPROTO_UDP
:

229 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

231 
œ
->
œ_šÃr_udp_¥Üt
, ir->
œ_šÃr_udp_dpÜt
,

232 
	`Áohs
(
œ
->
œ_šÃr_udp_sum
));

235 
IPPROTO_ICMP
:

236 
IPPROTO_ICMPV6
:

237 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

239 
œ
->
œ_šÃr_icmp_ty³
, ir->
œ_šÃr_icmp_code
,

240 
œ
->
œ_šÃr_icmp_id
, ir->
œ_šÃr_icmp_£q
,

241 
	`Áohs
(
œ
->
œ_šÃr_icmp_sum
));

244 
IPPROTO_TCP
:

245 
	`¢´štf
(
šÃr_Œª¥Üt
, (inner_transport),

247 
œ
->
œ_šÃr_tı_¥Üt
, ir->
œ_šÃr_tı_dpÜt
,

248 
œ
->
œ_šÃr_tı_£q
);

252 
šÃr_Œª¥Üt
[0] = '\0';

258 
šÃr_
[0] = '\0';

259 
šÃr_Œª¥Üt
[0] = '\0';

262 if(
œ
->
œ_ext
 !ğ
NULL
)

264 
	`¢´štf
(
ext
, (ext), " icmp-ext");

265 
j
 = 9;

266 
i
=0; i<
œ
->
œ_ex’
; i++)

268 if(
i
 % 4 == 0)

270 if((
ext
)-
j
 < 4)

272 
ext
[
j
++] = ' ';

274 if((
ext
)-
j
 < 3)

276 
	`by‹2hex
(
œ
->
œ_ext
[
i
], 
ext
 + 
j
);

277 
j
 += 2;

279 
ext
[
j
] = '\0';

283 
ext
[0] = '\0';

286 
	`sÿm³r_debug
(
NULL
, "% %s%s%s%s", 

, 
icmp
, 
šÃr_
, 
šÃr_Œª¥Üt
, 
ext
);

288 
	}
}

291 
	$sÿm³r_icmp_»¥_¤c
(
sÿm³r_icmp_»¥_t
 *
»¥
, 
sÿm³r_addr_t
 *
addr
)

293 if(
»¥
->
œ_af
 =ğ
AF_INET
)

295 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

296 
addr
->add¸ğ&
»¥
->
œ__¤c
.
v4
;

299 if(
»¥
->
œ_af
 =ğ
AF_INET6
)

301 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

302 
addr
->add¸ğ&
»¥
->
œ__¤c
.
v6
;

306 
	}
}

308 
	$sÿm³r_icmp_»¥_šÃr_d¡
(
sÿm³r_icmp_»¥_t
 *
»¥
,
sÿm³r_addr_t
 *
addr
)

310 if(
»¥
->
œ_af
 =ğ
AF_INET
)

312 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

313 
addr
->add¸ğ&
»¥
->
œ_šÃr__d¡
.
v4
;

316 if(
»¥
->
œ_af
 =ğ
AF_INET6
)

318 
addr
->
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

319 
addr
->add¸ğ&
»¥
->
œ_šÃr__d¡
.
v6
;

323 
	}
}

325 
	$sÿm³r_icmp_»¥_ş—n
(
sÿm³r_icmp_»¥_t
 *
œ
)

327 if(
œ
->
œ_ext
 !ğ
NULL
)

328 
	`ä“
(
œ
->
œ_ext
);

330 if(
œ
->
œ_İt_¼s
 !ğ
NULL
)

331 
	`ä“
(
œ
->
œ_İt_¼s
);

333 if(
œ
->
œ_İt_tss
 !ğ
NULL
)

334 
	`ä“
(
œ
->
œ_İt_tss
);

336 if(
œ
->
œ_İt_t¡ss
 !ğ
NULL
)

337 
	`ä“
(
œ
->
œ_İt_t¡ss
);

339 if(
œ
->
œ_šÃr_İt_¼s
 !ğ
NULL
)

340 
	`ä“
(
œ
->
œ_šÃr_İt_¼s
);

342 if(
œ
->
œ_šÃr_İt_tss
 !ğ
NULL
)

343 
	`ä“
(
œ
->
œ_šÃr_İt_tss
);

345 if(
œ
->
œ_šÃr_İt_t¡ss
 !ğ
NULL
)

346 
	`ä“
(
œ
->
œ_šÃr_İt_t¡ss
);

349 
	}
}

351 
	$sÿm³r_icmp_»¥_hªdË
(
sÿm³r_icmp_»¥_t
 *
»¥
)

353 
sÿm³r_sk_sig_t
 
sig
;

354 
sÿm³r_sk_t
 *
sk
;

355 
sÿm³r_addr_t
 
addr
;

357 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
»¥
) ||

358 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
»¥
) ||

359 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
»¥
))

362 if(!
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
»¥
))

364 if(
	`sÿm³r_icmp_»¥_šÃr_d¡
(
»¥
, &
addr
) != 0)

367 if(
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
»¥
) ||

368 
	`SCAMPER_ICMP_RESP_IS_TIME_REPLY
(
»¥
))

371 if(
	`sÿm³r_icmp_»¥_¤c
(
»¥
, &
addr
) != 0)

379 
	`mem£t
(&
sig
, 0, (sig));

380 
sig
.
sig_ty³
 = 
SCAMPER_TASK_SIG_TYPE_TX_IP
;

381 
sig
.
sig_tx__d¡
 = &
addr
;

382 if((
sk
 = 
	`sÿm³r_sk_fšd
(&
sig
)è!ğ
NULL
)

383 
	`sÿm³r_sk_hªdËicmp
(
sk
, 
»¥
);

385 
	}
}

	@scamper_icmp_resp.h

26 #iâdeà
__SCAMPER_ICMP_RESP_H


27 
	#__SCAMPER_ICMP_RESP_H


	)

29 
	#SCAMPER_ICMP_RESP_FLAG_KERNRX
 0x01

	)

30 
	#SCAMPER_ICMP_RESP_FLAG_INNER_IP
 0x02

	)

31 
	#SCAMPER_ICMP_RESP_FLAG_IPOPT_TS
 0x04

	)

32 
	#SCAMPER_ICMP_RESP_FLAG_INNER_IPOPT_TS
 0x08

	)

34 
	#SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
) ( \

35 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 == 0) || \

36 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_icmp_ty³
 =ğ129))

	)

38 
	#SCAMPER_ICMP_RESP_IS_TIME_REPLY
(
œ
) ( \

39 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 =ğ14))

	)

41 
	#SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) ( \

42 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 == 11) || \

43 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_icmp_ty³
 =ğ3))

	)

45 
	#SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ( \

46 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 == 3) || \

47 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_icmp_ty³
 =ğ1))

	)

49 
	#SCAMPER_ICMP_RESP_IS_UNREACH_PORT
(
œ
) ( \

50 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 =ğ3 && ir->
œ_icmp_code
 == 3) || \

51 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_icmp_ty³
 =ğ1 && ir->
œ_icmp_code
 =ğ4))

	)

53 
	#SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
) ( \

54 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_icmp_ty³
 =ğ3 && ir->
œ_icmp_code
 == 4) || \

55 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_icmp_ty³
 =ğ2))

	)

58 
	#SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
) ( \

59 ((
œ
->
œ_æags
 & 
SCAMPER_ICMP_RESP_FLAG_INNER_IP
è!ğ0))

	)

61 
	#SCAMPER_ICMP_RESP_INNER_IS_ICMP
(
œ
) ( \

62 (
œ
->
œ_af
 =ğ
AF_INET
 && ir->
œ_šÃr__´Ùo
 == 1) || \

63 (
œ
->
œ_af
 =ğ
AF_INET6
 && ir->
œ_šÃr__´Ùo
 =ğ58))

	)

65 
	#SCAMPER_ICMP_RESP_INNER_IS_TCP
(
œ
) ( \

66 (
œ
->
œ_šÃr__´Ùo
 =ğ6))

	)

68 
	#SCAMPER_ICMP_RESP_INNER_IS_UDP
(
œ
) ( \

69 (
œ
->
œ_šÃr__´Ùo
 =ğ17))

	)

71 
	#SCAMPER_ICMP_RESP_INNER_IS_ICMP_ECHO_REQ
(
œ
) ( \

72 (
œ
->
œ_af
 =ğ
AF_INET
 && \

73 
œ
->
œ_šÃr__´Ùo
 =ğ1 && ir->
œ_šÃr_icmp_ty³
 == 8) || \

74 (
œ
->
œ_af
 =ğ
AF_INET6
 && \

75 
œ
->
œ_šÃr__´Ùo
 =ğ58 && ir->
œ_šÃr_icmp_ty³
 =ğ128))

	)

77 
	#SCAMPER_ICMP_RESP_INNER_IS_ICMP_TIME_REQ
(
œ
) ( \

78 
œ
->
œ_af
 =ğ
AF_INET
 && \

79 
œ
->
œ_šÃr__´Ùo
 =ğ1 && ir->
œ_šÃr_icmp_ty³
 =ğ13)

	)

99 
	ssÿm³r_icmp_»¥


102 
	mœ_af
;

105 
	mœ_fd
;

108 
timev®
 
	mœ_rx
;

111 
ušt8_t
 
	mœ_æags
;

124 
š_addr
 
	mv4
;

125 
š6_addr
 
	mv6
;

126 } 
	mœ__¤c
;

128 
ušt16_t
 
	mœ__size
;

129 
ušt16_t
 
	mœ__id
;

130 
ušt8_t
 
	mœ__tos
;

131 
št16_t
 
	mœ__‰l
;

137 
š_addr
 *
	mœ_İt_¼s
;

138 
ušt8_t
 
	mœ_İt_¼c
;

144 
ušt8_t
 
	mœ_İt_tsc
;

145 
š_addr
 *
	mœ_İt_tss
;

146 
ušt32_t
 *
	mœ_İt_t¡ss
;

155 
ušt8_t
 
	mœ_icmp_ty³
;

156 
ušt8_t
 
	mœ_icmp_code
;

157 
ušt16_t
 
	mœ_icmp_id
;

158 
ušt16_t
 
	mœ_icmp_£q
;

159 
ušt16_t
 
	mœ_icmp_nhmtu
;

160 
ušt32_t
 
	mœ_icmp_tso
;

161 
ušt32_t
 
	mœ_icmp_t¤
;

162 
ušt32_t
 
	mœ_icmp_t¡
;

174 
š_addr
 
	mv4
;

175 
š6_addr
 
	mv6
;

176 } 
	mœ_šÃr__d¡
;

178 
ušt16_t
 
	mœ_šÃr__size
;

179 
ušt32_t
 
	mœ_šÃr__id
;

180 
ušt16_t
 
	mœ_šÃr__off
;

181 
ušt32_t
 
	mœ_šÃr__æow
;

182 
ušt8_t
 
	mœ_šÃr__tos
;

183 
ušt8_t
 
	mœ_šÃr__‰l
;

184 
ušt8_t
 
	mœ_šÃr__´Ùo
;

185 
š_addr
 *
	mœ_šÃr_İt_¼s
;

186 
ušt8_t
 
	mœ_šÃr_İt_¼c
;

187 
ušt8_t
 
	mœ_šÃr_İt_tsc
;

188 
š_addr
 *
	mœ_šÃr_İt_tss
;

189 
ušt32_t
 *
	mœ_šÃr_İt_t¡ss
;

191 
ušt8_t
 *
	mœ_šÃr_d©a
;

192 
ušt16_t
 
	mœ_šÃr_d©®’
;

201 
	sœt_udp


203 
ušt16_t
 
	m¥Üt
;

204 
ušt16_t
 
	mdpÜt
;

205 
ušt16_t
 
	msum
;

206 } 
	mœ™_udp
;

208 
	sœt_tı


210 
ušt16_t
 
	m¥Üt
;

211 
ušt16_t
 
	mdpÜt
;

212 
ušt32_t
 
	m£q
;

213 } 
	mœ™_tı
;

215 
	sœt_icmp


217 
ušt8_t
 
	mty³
;

218 
ušt8_t
 
	mcode
;

219 
ušt16_t
 
	msum
;

220 
ušt16_t
 
	mid
;

221 
ušt16_t
 
	m£q
;

222 } 
	mœ™_icmp
;

223 } 
	mœ_šÃr_Œªs_un
;

225 
ušt8_t
 *
	mœ_ext
;

226 
ušt16_t
 
	mœ_ex’
;

228 } 
	tsÿm³r_icmp_»¥_t
;

230 
	#œ__hlim
 
œ__‰l


	)

232 
	#œ_šÃr__hlim
 
œ_šÃr__‰l


	)

233 
	#œ_šÃr_udp_¥Üt
 
œ_šÃr_Œªs_un
.
œ™_udp
.
¥Üt


	)

234 
	#œ_šÃr_udp_dpÜt
 
œ_šÃr_Œªs_un
.
œ™_udp
.
dpÜt


	)

235 
	#œ_šÃr_udp_sum
 
œ_šÃr_Œªs_un
.
œ™_udp
.
sum


	)

236 
	#œ_šÃr_tı_¥Üt
 
œ_šÃr_Œªs_un
.
œ™_tı
.
¥Üt


	)

237 
	#œ_šÃr_tı_dpÜt
 
œ_šÃr_Œªs_un
.
œ™_tı
.
dpÜt


	)

238 
	#œ_šÃr_tı_£q
 
œ_šÃr_Œªs_un
.
œ™_tı
.
£q


	)

239 
	#œ_šÃr_icmp_ty³
 
œ_šÃr_Œªs_un
.
œ™_icmp
.
ty³


	)

240 
	#œ_šÃr_icmp_code
 
œ_šÃr_Œªs_un
.
œ™_icmp
.
code


	)

241 
	#œ_šÃr_icmp_sum
 
œ_šÃr_Œªs_un
.
œ™_icmp
.
sum


	)

242 
	#œ_šÃr_icmp_id
 
œ_šÃr_Œªs_un
.
œ™_icmp
.
id


	)

243 
	#œ_šÃr_icmp_£q
 
œ_šÃr_Œªs_un
.
œ™_icmp
.
£q


	)

245 
sÿm³r_icmp_»¥_¤c
(
sÿm³r_icmp_»¥_t
 *
»¥
, 
sÿm³r_addr_t
 *
addr
);

246 
sÿm³r_icmp_»¥_šÃr_d¡
(
sÿm³r_icmp_»¥_t
 *
»¥
, 
sÿm³r_addr_t
 *
a
);

248 
sÿm³r_icmp_»¥_hªdË
(
sÿm³r_icmp_»¥_t
 *
»¥
);

250 
sÿm³r_icmp_»¥_ş—n
(
sÿm³r_icmp_»¥_t
 *
œ
);

253 #ià!
defšed
(
NDEBUG
è&& !defšed(
WITHOUT_DEBUGFILE
)

254 
sÿm³r_icmp_»¥_´št
(cÚ¡ 
sÿm³r_icmp_»¥_t
 *
»¥
);

256 
	#sÿm³r_icmp_»¥_´št
(
»¥
è(()0)

	)

	@scamper_icmpext.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_icm³xt.h
"

36 
	~"uts.h
"

38 
sÿm³r_icm³xt_t
 *
	$sÿm³r_icm³xt_®loc
(
ušt8_t
 
ú
, ušt8_ˆ
ù
, 
ušt16_t
 
dl
,

39 cÚ¡ *
d©a
)

41 
sÿm³r_icm³xt_t
 *
›
;

43 if((
›
 = 
	`m®loc
((
sÿm³r_icm³xt_t
))è=ğ
NULL
)

45  
NULL
;

48 if(
dl
 != 0)

50 if((
›
->
›_d©a
 = 
	`m®loc
(
dl
)è!ğ
NULL
)

52 
	`memıy
(
›
->
›_d©a
, 
d©a
, 
dl
);

56 
	`ä“
(
›
);

57  
NULL
;

62 
›
->
›_d©a
 = 
NULL
;

65 
›
->
›_Ãxt
 = 
NULL
;

66 
›
->
›_ú
 = 
ú
;

67 
›
->
›_ù
 = 
ù
;

68 
›
->
›_dl
 = 
dl
;

70  
›
;

71 
	}
}

73 
	$sÿm³r_icm³xt_ä“
(
sÿm³r_icm³xt_t
 *
›
)

75 
sÿm³r_icm³xt_t
 *
Ãxt
;

77 
›
 !ğ
NULL
)

79 
Ãxt
 = 
›
->
›_Ãxt
;

80 if(
›
->
›_d©a
 !ğ
NULL
)

81 
	`ä“
(
›
->
›_d©a
);

82 
	`ä“
(
›
);

83 
›
 = 
Ãxt
;

87 
	}
}

89 
	$sÿm³r_icm³xt_·r£
(
sÿm³r_icm³xt_t
 **
exts
, *
d©a
, 
ušt16_t
 
Ën
)

91 
sÿm³r_icm³xt_t
 *
›
, *
Ãxt
;

92 
ušt8_t
 *
u8
 = 
d©a
;

93 
ušt16_t
 
dl
;

94 
ušt8_t
 
ú
, 
ù
;

95 
off
;

97 *
exts
 = 
NULL
;

98 
Ãxt
 = *
exts
;

101 
off
 = 4; ofà+ 4 < 
Ën
; ofà+ğ
dl
)

104 
	`memıy
(&
dl
, 
u8
+
off
, 2);

105 
dl
 = 
	`Áohs
(dl);

108 if(
off
 + 
dl
 < 
Ën
)

111 
ú
 = 
u8
[
off
+2];

112 
ù
 = 
u8
[
off
+3];

114 if(
dl
 < 8)

119 if((
›
 = 
	`sÿm³r_icm³xt_®loc
(
ú
, 
ù
, 
dl
-4, 
u8
+
off
+4)è=ğ
NULL
)

124 if(
Ãxt
 =ğ
NULL
)

126 *
exts
 = 
›
;

130 
Ãxt
->
›_Ãxt
 = 
›
;

132 
Ãxt
 = 
›
;

136 
	}
}

138 
	$sÿm³r_icm³xt_uÂumb”ed_·r£
(
sÿm³r_icm³xt_t
 *
›
,

139 
sÿm³r_icm³xt_uÂumb”ed_t
 *
uÂ
)

141 
ušt8_t
 *
u8
 = 
›
->
›_d©a
;

142 
ušt32_t
 
off
 = 0;

143 
ušt16_t
 
u16
;

144 
i
;

146 
	`mem£t
(
uÂ
, 0, (
sÿm³r_icm³xt_uÂumb”ed_t
));

148 
i
=4; i<=7; i++)

150 if(
i
 =ğ4 && 
	`SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_IFINDEX
(
›
))

152 if(
›
->
›_dl
 > 
off
 + 4)

155 
uÂ
->
ifšdex
 = 
	`by‹s_Áohl
(
u8
 + 
off
);

156 
uÂ
->
æags
 |ğ
SCAMPER_ICMPEXT_UNNUMBERED_CT_IFINDEX
;

157 
off
 += 4;

159 if(
i
 =ğ5 && 
	`SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_IPADDR
(
›
))

161 if(
›
->
›_dl
 > 
off
 + 4)

164 
u16
 = 
	`by‹s_Áohs
(
u8
 + 
off
); off += 4;

165 if(
u16
 == 1)

167 
uÂ
->
af
 = 
AF_INET
;

168 
u16
 = 4;

170 if(
u16
 == 2)

172 
uÂ
->
af
 = 
AF_INET6
;

173 
u16
 = 16;

177 if(
›
->
›_dl
 > 
off
 + 
u16
)

180 
uÂ
->
æags
 |ğ
SCAMPER_ICMPEXT_UNNUMBERED_CT_IPADDR
;

181 
	`memıy
(&
uÂ
->
un
.
v6
, 
u8
 + 
off
, 
u16
);

182 
off
 +ğ
u16
;

184 if(
i
 =ğ6 && 
	`SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_NAME
(
›
))

186 if(
u8
[
off
] > 64 || 
›
->
›_dl
 > off + u8[off])

189 
uÂ
->
æags
 |ğ
SCAMPER_ICMPEXT_UNNUMBERED_CT_NAME
;

190 
	`memıy
(
uÂ
->
Çme
, &
u8
[
off
+1], u8[off]-1);

191 
uÂ
->
Çme
[63] = 0;

192 
off
 +ğ
u8
[off];

194 if(
i
 =ğ7 && 
	`SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_MTU
(
›
))

196 if(
›
->
›_dl
 > 
off
 + 4)

199 
uÂ
->
mtu
 = 
	`by‹s_Áohl
(
u8
 + 
off
);

200 
uÂ
->
æags
 |ğ
SCAMPER_ICMPEXT_UNNUMBERED_CT_MTU
;

201 
off
 += 4;

204 
	}
}

	@scamper_icmpext.h

25 #iâdeà
__SCAMPER_ICMPEXT_H


26 
	#__SCAMPER_ICMPEXT_H


	)

33 
	ssÿm³r_icm³xt


35 
ušt8_t
 
	m›_ú
;

36 
ušt8_t
 
	m›_ù
;

37 
ušt16_t
 
	m›_dl
;

38 
ušt8_t
 *
	m›_d©a
;

39 
sÿm³r_icm³xt
 *
	m›_Ãxt
;

40 } 
	tsÿm³r_icm³xt_t
;

42 
	#SCAMPER_ICMPEXT_IS_MPLS
(
›
) \

43 ((
›
)->
›_ú
 =ğ1 && (›)->
›_ù
 =ğ1)

	)

45 
	#SCAMPER_ICMPEXT_IS_UNNUMBERED
(
›
) \

46 ((
›
)->
›_ú
 =ğ2)

	)

48 
	#SCAMPER_ICMPEXT_MPLS_COUNT
(
›
) \

49 ((
›
)->
›_dl
 >> 2)

	)

51 
	#SCAMPER_ICMPEXT_MPLS_LABEL
(
›
, 
x
) \

52 (Ğ(
›
)->
›_d©a
[((
x
)<<2)+0] << 12) + \

53 Ğ(
›
)->
›_d©a
[((
x
)<<2)+1] << 4) + \

54 (((
›
)->
›_d©a
[((
x
)<<2)+2] >> 4è& 0xff))

	)

56 
	#SCAMPER_ICMPEXT_MPLS_EXP
(
›
, 
x
) \

57 (((
›
)->
›_d©a
[((
x
)<<2)+2] >> 1è& 0x7)

	)

59 
	#SCAMPER_ICMPEXT_MPLS_S
(
›
, 
x
) \

60 ((
›
)->
›_d©a
[((
x
)<<2)+2] & 0x1)

	)

62 
	#SCAMPER_ICMPEXT_MPLS_TTL
(
›
, 
x
) \

63 ((
›
)->
›_d©a
[((
x
)<<2)+3])

	)

65 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_ROLE
(
›
) \

66 ((
›
)->
›_d©a
[0] >> 6)

	)

68 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_ROLE_ARRIVED_IP
 0

	)

69 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_ROLE_ARRIVED_SUBIP
 1

	)

70 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_ROLE_FORWARD
 2

	)

71 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_ROLE_NEXTHOP
 3

	)

73 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IFINDEX
 4

	)

74 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IPADDR
 5

	)

75 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_NAME
 6

	)

76 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_MTU
 7

	)

78 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_IFINDEX
(
›
) \

79 ((
›
)->
›_ù
 & 
SCAMPER_ICMPEXT_UNNUMBERED_CT_IFINDEX
)

	)

81 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_IPADDR
(
›
) \

82 ((
›
)->
›_ù
 & 
SCAMPER_ICMPEXT_UNNUMBERED_CT_IPADDR
)

	)

84 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_NAME
(
›
) \

85 ((
›
)->
›_ù
 & 
SCAMPER_ICMPEXT_UNNUMBERED_CT_NAME
)

	)

87 
	#SCAMPER_ICMPEXT_UNNUMBERED_CT_IS_MTU
(
›
) \

88 ((
›
)->
›_ù
 & 
SCAMPER_ICMPEXT_UNNUMBERED_CT_MTU
)

	)

90 
	ssÿm³r_icm³xt_uÂumb”ed


92 
ušt8_t
 
	mæags
;

93 
ušt32_t
 
	mifšdex
;

94 
	maf
;

97 
š_addr
 
	mv4
;

98 
š6_addr
 
	mv6
;

99 } 
	mun
;

100 
	mÇme
[64];

101 
ušt32_t
 
	mmtu
;

102 } 
	tsÿm³r_icm³xt_uÂumb”ed_t
;

104 
sÿm³r_icm³xt_uÂumb”ed_·r£
(
sÿm³r_icm³xt_t
 *
ext
,

105 
sÿm³r_icm³xt_uÂumb”ed_t
 *
uÂ
);

107 
sÿm³r_icm³xt_t
 *
sÿm³r_icm³xt_®loc
(
ušt8_t
 
ú
, ušt8_ˆ
ù
, 
ušt16_t
 
dl
,

108 cÚ¡ *
d©a
);

109 
sÿm³r_icm³xt_·r£
(
sÿm³r_icm³xt_t
 **
ext
, *
d©a
, 
ušt16_t
 
Ën
);

110 
sÿm³r_icm³xt_ä“
(
sÿm³r_icm³xt_t
 *
exts
);

	@scamper_if.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_debug.h
"

35 
	~"sÿm³r_fds.h
"

36 
	~"sÿm³r_if.h
"

37 
	~"sÿm³r_´iv£p.h
"

38 
	~"uts.h
"

40 #iâdeà
_WIN32


41 
	$sÿm³r_if_g‘ifšdex
(cÚ¡ *
iâame
, *
ifšdex
)

43 
i
;

45 if((
i
 = 
	`if_Çm‘ošdex
(
iâame
)) == 0)

47 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

48 "could‚Ù g‘ index fÜ %s", 
iâame
);

52 *
ifšdex
 = 
i
;

54 
	}
}

57 #ifdeà
_WIN32


58 
	$sÿm³r_if_g‘ifšdex
(cÚ¡ *
iâame
, *
ifšdex
)

61 
	}
}

64 #ifdeà
_WIN32


65 
	$sÿm³r_if_g‘iâame
(*
¡r
, 
size_t
 
Ën
, 
ifšdex
)

67 
MIB_IFROW
 
row
;

68 
row
.
dwIndex
 = 
ifšdex
;

69 if(
	`G‘IfEÁry
(&
row
è!ğ
NO_ERROR
)

71 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù G‘IfEÁry %d", 
ifšdex
);

76 
	`_¢´štf
(
¡r
, 
Ën
, "XXX");

78 
	}
}

81 #iâdeà
_WIN32


82 
	$sÿm³r_if_g‘iâame
(*
¡r
, 
size_t
 
Ën
, 
ifšdex
)

84 
iâame
[
IFNAMSIZ
];

86 if(
	`if_šdextÚame
(
ifšdex
, 
iâame
è=ğ
NULL
)

88 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

89 "could‚Ù g‘‚amfÜ %d", 
ifšdex
);

93 if(
	`¡¾’
(
iâame
è+ 1 > 
Ën
)

95 
	`sÿm³r_debug
(
__func__
, "ifnameoo small");

99 
	`¡ºıy
(
¡r
, 
iâame
, 
Ën
);

101 
	}
}

110 #iâdeà
_WIN32


111 
	$sÿm³r_if_g‘mtu
(cÚ¡ 
ifšdex
, 
ušt16_t
 *
ifmtu
)

113 
sÿm³r_fd_t
 *
fd
;

114 
iäeq
 
iä
;

115 
mtu
;

117 
	`as£¹
(
ifšdex
 >= 0);

120 if(
	`if_šdextÚame
(()
ifšdex
, 
iä
.
iä_Çme
è=ğ
NULL
)

122 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot if_indextoname");

126 if((
fd
 = 
	`sÿm³r_fd_ifsock
()è=ğ
NULL
)

128 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifsock");

132 if(
	`ioùl
(
	`sÿm³r_fd_fd_g‘
(
fd
), 
SIOCGIFMTU
, &
iä
) == -1)

134 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot SIOCGIFMTU");

135 
	`sÿm³r_fd_ä“
(
fd
);

138 
	`sÿm³r_fd_ä“
(
fd
);

140 #ià
	`defšed
(
__sun__
)

141 
mtu
 = 
iä
.
iä_m‘ric
;

143 
mtu
 = 
iä
.
iä_mtu
;

146 if(
mtu
 >= 0 && mtu <= 65535)

148 *
ifmtu
 = 
mtu
;

153 
	}
}

156 #ifdeà
_WIN32


157 
	$sÿm³r_if_g‘mtu
(cÚ¡ 
ifšdex
, 
ušt16_t
 *
ifmtu
)

159 
MIB_IFROW
 
row
;

160 
row
.
dwIndex
 = 
ifšdex
;

161 if(
	`G‘IfEÁry
(&
row
è!ğ
NO_ERROR
)

163 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù G‘IfEÁry %d", 
ifšdex
);

166 *
ifmtu
 = (
ušt16_t
)
row
.
dwMtu
;

168 
	}
}

171 #ià
defšed
(
__lšux__
)

172 
	$sÿm³r_if_g‘mac
(cÚ¡ 
ifšdex
, 
ušt8_t
 *
mac
)

174 
sÿm³r_fd_t
 *
fd
 = 
NULL
;

175 
iäeq
 
iä
;

177 if(
	`if_šdextÚame
(
ifšdex
, 
iä
.
iä_Çme
è=ğ
NULL
)

179 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot if_indextoname");

180 
”r
;

183 if((
fd
 = 
	`sÿm³r_fd_ifsock
()è=ğ
NULL
)

185 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifsock");

186 
”r
;

189 if(
	`ioùl
(
	`sÿm³r_fd_fd_g‘
(
fd
), 
SIOCGIFHWADDR
, &
iä
) == -1)

191 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot SIOCGIFHWADDR");

192 
”r
;

194 
	`memıy
(
mac
, 
iä
.
iä_hwaddr
.
§_d©a
, 6);

196 
	`sÿm³r_fd_ä“
(
fd
);

199 
”r
:

200 if(
fd
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(fd);

202 
	}
}

203 #–ià
defšed
(
_WIN32
)

204 
	$sÿm³r_if_g‘mac
(cÚ¡ 
ifšdex
, 
ušt8_t
 *
mac
)

206 
MIB_IFROW
 
row
;

207 
row
.
dwIndex
 = 
ifšdex
;

208 if(
	`G‘IfEÁry
(&
row
è!ğ
NO_ERROR
)

210 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù G‘IfEÁry %d", 
ifšdex
);

213 
	`memıy
(
mac
, 
row
.
bPhysAddr
, 6);

215 
	}
}

216 #–ià
defšed
(
__sun__
)

217 
	$sÿm³r_if_g‘mac
(cÚ¡ 
ifšdex
, 
ušt8_t
 *
mac
)

219 
DL_´im™ives
 *
dÍ
;

220 
ušt8_t
 
»qbuf
[
DL_PHYS_ADDR_REQ_SIZE
];

221 
ušt8_t
 
ackbuf
[
DL_PHYS_ADDR_ACK_SIZE
 + 64];

222 
dl_phys_addr_»q_t
 *
»q
 = (dl_phys_addr_»q_ˆ*)
»qbuf
;

223 
dl_phys_addr_ack_t
 *
ack
 = (dl_phys_addr_ack_ˆ*)
ackbuf
;

224 
¡rbuf
 
ùl
;

225 
fd
 = -1, 
æags
;

227 #ifdeà
WITHOUT_PRIVSEP


228 
iâame
[5+
IFNAMSIZ
];

229 
	`¡ºıy
(
iâame
, "/dev/", (ifname));

230 if(
	`if_šdextÚame
(
ifšdex
, 
iâame
+5è=ğ
NULL
)

232 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "if_šdextÚam%d", 
ifšdex
);

233 
”r
;

235 if((
fd
 = 
	`İ’
(
iâame
, 
O_RDWR
)) == -1)

237 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù o³À%s", 
iâame
);

238 
”r
;

241 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_d©®šk
(
ifšdex
)) == -1)

243 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù o³À%d", 
ifšdex
);

244 
”r
;

248 
	`mem£t
(
»qbuf
, 0, (reqbuf));

249 
»q
->
dl_´im™ive
 = 
DL_PHYS_ADDR_REQ
;

250 
»q
->
dl_addr_ty³
 = 
DL_CURR_PHYS_ADDR
;

251 
	`mem£t
(&
ùl
, 0, (ctl));

252 
ùl
.
Ën
 = (
»qbuf
);

253 
ùl
.
buf
 = (*)
»q
;

254 if(
	`putmsg
(
fd
, &
ùl
, 
NULL
, 0) == -1)

256 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…utmsg");

257 
”r
;

260 
æags
 = 0;

261 
	`mem£t
(&
ùl
, 0, (ctl));

262 
ùl
.
maxËn
 = (
ackbuf
);

263 
ùl
.
buf
 = (*)
ack
;

264 if(
	`g‘msg
(
fd
, &
ùl
, 
NULL
, &
æags
) == -1)

266 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot getmsg");

267 
”r
;

269 
	`şo£
(
fd
); fd = -1;

271 
dÍ
 = (*)
ack
;

272 if(
dÍ
->
dl_´im™ive
 !ğ
DL_PHYS_ADDR_ACK
)

274 
”r
;

276 
	`memıy
(
mac
, 
ùl
.
buf
+
ack
->
dl_addr_off£t
, 6);

280 
”r
:

281 if(
fd
 !ğ-1è
	`şo£
(fd);

283 
	}
}

285 
	$sÿm³r_if_g‘mac
(cÚ¡ 
ifšdex
, 
ušt8_t
 *
mac
)

287 
sockaddr_dl
 *
sdl
;

288 
mib
[6];

289 
size_t
 
Ën
;

290 
ušt8_t
 *
buf
;

292 
mib
[0] = 
CTL_NET
;

293 
mib
[1] = 
AF_ROUTE
;

294 
mib
[2] = 0;

295 
mib
[3] = 
AF_LINK
;

296 
mib
[4] = 
NET_RT_IFLIST
;

297 
mib
[5] = 
ifšdex
;

299 if(
	`sysùl
(
mib
, 6, 
NULL
, &
Ën
, NULL, 0) == -1)

301 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot sysctl buflen");

305 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

307 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc buf");

311 if(
	`sysùl
(
mib
, 6, 
buf
, &
Ën
, 
NULL
, 0) < 0)

313 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot sysctl data");

314 
	`ä“
(
buf
);

318 
sdl
 = (
sockaddr_dl
 *)(
buf
+(
if_msghdr
));

319 
	`memıy
(
mac
, 
	`LLADDR
(
sdl
), 6);

321 
	`ä“
(
buf
);

323 
	}
}

326 #ifdeà
HAVE_GETIFADDRS


327 
	$sÿm³r_if_g‘ifšdex_byaddr
(cÚ¡ 
sockaddr
 *
addr
, *
ifšdex
)

329 
içddrs
 *
iç
 = 
NULL
, *
iå
;

330 
rc
;

332 if(
	`g‘içddrs
(&
iç
) != 0)

333 
”r
;

335 
iå
 = 
iç
; iå !ğ
NULL
; iå = iå->
iç_Ãxt
)

337 if(
iå
->
iç_addr
 =ğ
NULL
 || iå->iç_addr->
§_çmy
 !ğ
addr
->sa_family)

340 if(
addr
->
§_çmy
 =ğ
AF_INET
)

341 
rc
 = 
	`addr4_cmp
(&((
sockaddr_š
 *)
addr
)->
sš_addr
,

342 &((
sockaddr_š
 *)
iå
->
iç_addr
)->
sš_addr
);

343 if(
addr
->
§_çmy
 =ğ
AF_INET6
)

344 
rc
 = 
	`addr6_cmp
(&((
sockaddr_š6
 *)
addr
)->
sš6_addr
,

345 &((
sockaddr_š6
 *)
iå
->
iç_addr
)->
sš6_addr
);

346 
”r
;

348 if(
rc
 == 0)

352 if(
iå
 =ğ
NULL
)

354 
”ºo
 = 
ENOENT
;

355 
”r
;

358 
rc
 = 
	`sÿm³r_if_g‘ifšdex
(
iå
->
iç_Çme
, 
ifšdex
);

359 
	`ä“içddrs
(
iç
);

360  
rc
;

362 
”r
:

363 if(
iç
 !ğ
NULL
è
	`ä“içddrs
(ifa);

365 
	}
}

367 
	$sÿm³r_if_g‘ifšdex_byaddr
(cÚ¡ 
sockaddr
 *
addr
, *
ifšdex
)

370 
	}
}

	@scamper_if.h

24 #iâdeà
__SCAMPER_IF_H


25 
	#__SCAMPER_IF_H


	)

27 
sÿm³r_if_g‘mtu
(cÚ¡ 
ifšdex
, 
ušt16_t
 *
ifmtu
);

28 
sÿm³r_if_g‘mac
(cÚ¡ 
ifšdex
, 
ušt8_t
 *
mac
);

29 
sÿm³r_if_g‘ifšdex
(cÚ¡ *
iâame
, *
ifšdex
);

30 
sÿm³r_if_g‘iâame
(*
¡r
, 
size_t
 
Ën
, 
ifšdex
);

31 
sÿm³r_if_g‘ifšdex_byaddr
(cÚ¡ 
sockaddr
 *
addr
, *
ifšdex
);

	@scamper_ip4.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_dl.h
"

36 
	~"sÿm³r_´obe.h
"

37 
	~"sÿm³r_4.h
"

38 
	~"sÿm³r_tı4.h
"

39 
	~"sÿm³r_´iv£p.h
"

40 
	~"sÿm³r_debug.h
"

41 
	~"uts.h
"

43 
	$sÿm³r_4_şo£
(
fd
)

45 #iâdeà
_WIN32


46 
	`şo£
(
fd
);

48 
	`şo£sock‘
(
fd
);

51 
	}
}

53 
	$sÿm³r_4_İ’¿w
()

55 
fd
 = -1;

57 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

58 
hdr
 = 1;

59 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_RAW
)) == -1)

61 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

62 
”r
;

64 if(
	`£tsockİt
(
fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, (*)&
hdr
, (hdr)) == -1)

66 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot IP_HDRINCL");

67 
”r
;

70 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_¿w
()) == -1)

72 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

73 
”r
;

77  
fd
;

79 
”r
:

80 if(
fd
 !ğ-1è
	`sÿm³r_4_şo£
(fd);

82 
	}
}

84 
	$sÿm³r_4_hËn
(
sÿm³r_´obe_t
 *
´
, 
size_t
 *
hËn
)

86 
size_t
 
4hËn
 = (

);

87 
sÿm³r_´obe_İt_t
 *
İt
;

88 
i
;

90 
i
=0; i<
´
->
´_İtc
; i++)

92 
İt
 = &
´
->
´_İts
[
i
];

93 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4RR
)

99 if(
4hËn
 + 8 > 60)

100 
”r
;

103 
4hËn
 = 60;

105 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSPS
)

107 if(
İt
->
İt_v4t¥s_c
 < 1 || opt->opt_v4tsps_ipc > 4)

108 
”r
;

110 
4hËn
 +ğ(
İt
->
İt_v4t¥s_c
 * 4 * 2) + 4;

111 if(
4hËn
 > 60)

112 
”r
;

114 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSO
)

116 
4hËn
 += 40;

117 if(
4hËn
 > 60)

118 
”r
;

120 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSAA
)

122 
4hËn
 += 36;

123 if(
4hËn
 > 60)

124 
”r
;

126 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_QUICKSTART
)

128 
4hËn
 += 8;

129 if(
4hËn
 > 60)

130 
”r
;

132 
”r
;

135 *
hËn
 = 
4hËn
;

138 
”r
:

139 
	`sÿm³r_debug
(
__func__
, "invalid IPv4 header specification");

141 
	}
}

143 
	$sÿm³r_4_bud
(
sÿm³r_´obe_t
 *
´
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

145 
sÿm³r_´obe_İt_t
 *
İt
;

146 

 *ip;

147 
size_t
 
off
, 
4hËn
;

148 
i
, 
j
;

150 if(
	`sÿm³r_4_hËn
(
´
, &
4hËn
) != 0)

153 if(
4hËn
 > *
Ën
)

155 *
Ën
 = 
4hËn
;

159 

 = ( *)
buf
;

160 
off
 = (

);

162 #iâdeà
_WIN32


163 

->
_v
 = 4;

164 

->
_hl
 = (
4hËn
 / 4);

166 

->
_vhl
 = 0x40 | (
4hËn
 / 4);

169 if((
´
->
´__off
 & 
IP_OFFMASK
è!ğ0 ||…r->
´_no_Œªs
)

170 

->
_Ën
 = 
	`htÚs
(
4hËn
 + 
´
->
´_Ën
);

171 if(
´
->
´__´Ùo
 =ğ
IPPROTO_ICMP
 ||…r->´__´ÙØ=ğ
IPPROTO_UDP
)

172 

->
_Ën
 = 
	`htÚs
(
4hËn
 + 8 + 
´
->
´_Ën
);

173 if(
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

174 

->
_Ën
 = 
	`htÚs
(
4hËn
 + 
	`sÿm³r_tı4_hËn
(
´
è+…r->
´_Ën
);

177 
	`sÿm³r_debug
(
__func__
, "unim¶em’‹d…¸%d", 
´
->
´__´Ùo
);

181 

->
_tos
 = 
´
->
´__tos
;

182 

->
_id
 = 
	`htÚs
(
´
->
´__id
);

183 

->
_off
 = 
	`htÚs
(
´
->
´__off
);

184 

->
_‰l
 = 
´
->
´__‰l
;

185 

->
_p
 = 
´
->
´__´Ùo
;

186 

->
_sum
 = 0;

187 
	`memıy
(&

->
_¤c
, 
´
->
´__¤c
->
addr
, (ip->ip_src));

188 
	`memıy
(&

->
_d¡
, 
´
->
´__d¡
->
addr
, (ip->ip_dst));

190 
i
=0; i<
´
->
´_İtc
; i++)

192 
İt
 = &
´
->
´_İts
[
i
];

193 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4RR
)

195 
	`mem£t
(
buf
+
off
+3, 0, 37);

196 
buf
[
off
+0] = 7;

197 
buf
[
off
+1] = 39;

198 
buf
[
off
+2] = 4;

199 
off
 = 60;

201 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSPS
 ||

202 
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSO
 ||

203 
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSAA
)

205 
buf
[
off
+0] = 68;

206 
buf
[
off
+2] = 5;

208 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSPS
)

210 
buf
[
off
+1] = (
İt
->
İt_v4t¥s_c
 * 4 * 2) + 4;

211 
buf
[
off
+3] = 3;

212 
off
 += 4;

213 
j
=0; j<
İt
->
İt_v4t¥s_c
; j++)

215 
	`memıy
(
buf
+
off
, &
İt
->
İt_v4t¥s_s
[
j
], 4); off += 4;

216 
	`mem£t
(
buf
+
off
, 0, 4); off += 4;

219 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSO
)

221 
buf
[
off
+1] = 40;

222 
	`mem£t
(
buf
+
off
+3, 0, 41);

223 
off
 += 40;

225 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_V4TSAA
)

227 
buf
[
off
+1] = 36;

228 
buf
[
off
+3] = 1;

229 
	`mem£t
(
buf
+
off
+4, 0, 36);

230 
off
 += 36;

233 if(
İt
->
ty³
 =ğ
SCAMPER_PROBE_IPOPTS_QUICKSTART
)

235 
	`as£¹
(
İt
->
İt_qs_func
 <= 0xf);

236 
	`as£¹
(
İt
->
İt_qs_¿‹
 <= 0xf);

237 
buf
[
off
+0] = 25;

238 
buf
[
off
+1] = 8;

239 
buf
[
off
+2] = (
İt
->
İt_qs_func
 << 4è| o±->
İt_qs_¿‹
;

240 
buf
[
off
+3] = 
İt
->
İt_qs_‰l
;

241 
	`by‹s_htÚl
(&
buf
[
off
+4], 
İt
->
İt_qs_nÚû
 << 2);

242 
off
 += 8;

247 
	`as£¹
(
off
 =ğ
4hËn
);

248 

->
_sum
 = 
	`š_cksum
(, 
4hËn
);

250 *
Ën
 = 
off
;

252 
	}
}

259 
	$sÿm³r_4_äag_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

261 
size_t
 
4hËn
, 
»q
;

262 
rc
 = 0;

265 
4hËn
 = *
Ën
;

266 
	`sÿm³r_4_bud
(
´obe
, 
buf
, &
4hËn
);

269 
»q
 = 
4hËn
 + 
´obe
->
´_Ën
;

271 if(
»q
 > *
Ën
)

272 
rc
 = -1;

273 if(
´obe
->
´_Ën
 != 0)

274 
	`memıy
(
buf
 + 
4hËn
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

276 *
Ën
 = 
»q
;

277  
rc
;

278 
	}
}

	@scamper_ip4.h

24 #iâdeà
__SCAMPER_IP4_H


25 
	#__SCAMPER_IP4_H


	)

27 #ifdeà
__SCAMPER_PROBE_H


28 
sÿm³r_4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

29 
sÿm³r_4_hËn
(
sÿm³r_´obe_t
 *
´obe
, 
size_t
 *
Ën
);

30 
sÿm³r_4_äag_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

33 
sÿm³r_4_İ’¿w
();

34 
sÿm³r_4_şo£
(
fd
);

	@scamper_ip6.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_dl.h
"

37 
	~"sÿm³r_´obe.h
"

38 
	~"sÿm³r_6.h
"

40 
	~"sÿm³r_debug.h
"

41 
	~"uts.h
"

51 
	$6_ext_rou‹0
(
6_hdr
 *
6
,

52 cÚ¡ 
sÿm³r_´obe_İt_t
 *
İt
,

53 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

55 
i
;

56 
ssize_t
 
off
;

58 
	`as£¹
(
İt
->
İt_v6rh0_c
 > 0);

60 if(*
Ën
 < (
İt
->
İt_v6rh0_c
 * 16) + 8)

62 *
Ën
 = (
İt
->
İt_v6rh0_c
 * 16) + 8;

71 
buf
[1] = 
İt
->
İt_v6rh0_c
 * 2;

74 
buf
[2] = 0;

77 
buf
[3] = 
İt
->
İt_v6rh0_c
;

80 
	`mem£t
(
buf
+4, 0, 4);

82 
off
 = 8;

88 
i
=1; i<
İt
->
İt_v6rh0_c
; i++)

90 
	`memıy
(
buf
+
off
, &
İt
->
İt_v6rh0_s
[
i
], 16);

91 
off
 += 16;

98 
	`memıy
(
buf
+
off
, &
6
->
6_d¡
, 16);

99 
off
 += 16;

102 
	`memıy
(&
6
->
6_d¡
, &
İt
->
İt_v6rh0_s
[0], 16);

104 *
Ën
 = 
off
;

106 
	}
}

108 
	$6_ext_äag
(
6_hdr
 *
6
,

109 cÚ¡ 
sÿm³r_´obe_İt_t
 *
İt
,

110 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

113 if(*
Ën
 < 8)

115 *
Ën
 = 8;

120 
buf
[1] = 0;

123 
	`by‹s_htÚs
(
buf
+2, 
İt
->
İt_v6äag_off
);

124 
	`by‹s_htÚl
(
buf
+4, 
İt
->
İt_v6äag_id
);

126 *
Ën
 = 8;

128 
	}
}

130 
	$6_ext_quick¡¬t
(
6_hdr
 *
6
,

131 cÚ¡ 
sÿm³r_´obe_İt_t
 *
İt
,

132 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

134 
size_t
 
off
 = 1;

136 if(*
Ën
 < 16)

138 *
Ën
 = 16;

142 
buf
[
off
++] = 1;

145 
buf
[
off
++] = 0;

146 
buf
[
off
++] = 0;

149 
buf
[
off
++] = 0x26;

150 
buf
[
off
++] = 6;

151 
buf
[
off
++] = (
İt
->
İt_qs_func
 << 4è| o±->
İt_qs_¿‹
;

152 
buf
[
off
++] = 
İt
->
İt_qs_‰l
;

153 
	`by‹s_htÚl
(&
buf
[
off
], 
İt
->
İt_qs_nÚû
 << 2);

154 
off
 += 4;

157 
buf
[
off
++] = 1;

158 
buf
[
off
++] = 2;

159 
buf
[
off
++] = 0;

160 
buf
[
off
++] = 0;

162 *
Ën
 = 
off
;

164 
	}
}

180 
	$sÿm³r_6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

182 (*cÚ¡ 
func
[])(
6_hdr
 *, cÚ¡ 
sÿm³r_´obe_İt_t
 *,

183 
ušt8_t
 *, 
size_t
 *) = {

184 
6_ext_rou‹0
,

185 
6_ext_äag
,

186 
NULL
,

187 
NULL
,

188 
NULL
,

189 
NULL
,

190 
6_ext_quick¡¬t
,

193 cÚ¡ 
nxthdrv®
[] = {

194 
IPPROTO_ROUTING
,

195 
IPPROTO_FRAGMENT
,

200 
IPPROTO_HOPOPTS
,

203 
6_hdr
 *
6
;

204 
sÿm³r_´obe_İt_t
 *
İt
;

205 
size_t
 
off
, 
tmp
;

206 
i
;

209 
6
 = (
6_hdr
 *)
buf
;

210 
off
 = (
6_hdr
);

212 if(
off
 <ğ*
Ën
)

215 
6
->
6_æow
 = 
	`htÚl
(0x6<<28|
´obe
->
´__tos
<<20|Õrobe->
´__æow
 & 0x000fffff));

216 
6
->
6_hlim
 = 
´obe
->
´__‰l
;

217 
	`memıy
(&
6
->
6_¤c
, 
´obe
->
´__¤c
->
addr
, 16);

218 
	`memıy
(&
6
->
6_d¡
, 
´obe
->
´__d¡
->
addr
, 16);

225 if(
´obe
->
´_İtc
 == 0)

227 if(
off
 <ğ*
Ën
)

229 
6
->
6_nxt
 = 
´obe
->
´__´Ùo
;

231 
dÚe
;

238 if(
off
 <ğ*
Ën
)

240 if(
nxthdrv®
[
´obe
->
´_İts
[0].
ty³
] == -1)

243 
6
->
6_nxt
 = 
nxthdrv®
[
´obe
->
´_İts
[0].
ty³
];

247 
i
=0; i<
´obe
->
´_İtc
; i++)

249 if(
off
 + 1 < *
Ën
)

252 if(
i
 =ğ
´obe
->
´_İtc
-1)

254 
buf
[
off
] = 
´obe
->
´__´Ùo
;

258 if(
nxthdrv®
[
´obe
->
´_İts
[
i
+1].
ty³
] == -1)

261 
buf
[
off
] = 
nxthdrv®
[
´obe
->
´_İts
[
i
+1].
ty³
];

266 
İt
 = &
´obe
->
´_İts
[
i
];

269 if(*
Ën
 >ğ
off
)

270 
tmp
 = *
Ën
 - 
off
;

272 
tmp
 = 0;

275 
func
[
İt
->
ty³
](
6
, o±, 
buf
+
off
, &
tmp
);

277 
off
 +ğ
tmp
;

280 
dÚe
:

285 if(
off
 > *
Ën
)

287 *
Ën
 = 
off
;

291 *
Ën
 = 
off
;

293 
	}
}

301 
	$sÿm³r_6_hËn
(
sÿm³r_´obe_t
 *
´obe
, 
size_t
 *
6hËn
)

303 *
6hËn
 = 0;

304 
	`sÿm³r_6_bud
(
´obe
, 
NULL
, 
6hËn
);

306 
	}
}

313 
	$sÿm³r_6_äag_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

315 
6_hdr
 *
6
;

316 
size_t
 
6hËn
, 
»q
;

319 
6hËn
 = *
Ën
;

320 
	`sÿm³r_6_bud
(
´obe
, 
buf
, &
6hËn
);

323 
»q
 = 
6hËn
 + 
´obe
->
´_Ën
;

325 if(
»q
 > *
Ën
)

327 *
Ën
 = 
»q
;

332 
6
 = (
6_hdr
 *)
buf
;

333 
6
->
6_¶’
 = 
	`htÚs
(
6hËn
 - 40 + 
´obe
->
´_Ën
);

334 if(
´obe
->
´_Ën
 != 0)

335 
	`memıy
(
buf
 + 
6hËn
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

336 *
Ën
 = 
»q
;

339 
	}
}

	@scamper_ip6.h

25 #iâdeà
__SCAMPER_IP6_H


26 
	#__SCAMPER_IP6_H


	)

28 
sÿm³r_6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

29 
sÿm³r_6_hËn
(
sÿm³r_´obe_t
 *
´obe
, 
size_t
 *
6hËn
);

30 
sÿm³r_6_äag_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

	@scamper_linepoll.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r_lš•Şl.h
"

41 
	ssÿm³r_lš•Şl


43 
sÿm³r_lš•Şl_hªdËr_t
 
	mhªdËr
;

44 *
	m·¿m
;

45 
ušt8_t
 *
	mbuf
;

46 
size_t
 
	mËn
;

54 
	$sÿm³r_lš•Şl_æush
(
sÿm³r_lš•Şl_t
 *
Í
)

56 *
tmp
;

58 if(
Í
->
Ën
 <= 0)

61 if((
tmp
 = 
	`»®loc
(
Í
->
buf
,†p->
Ën
+1)è=ğ
NULL
)

64 
Í
->
buf
 = 
tmp
;

65 
Í
->
buf
[Í->
Ën
] = '\0';

66 
Í
->
	`hªdËr
Öp->
·¿m
,†p->
buf
,†p->
Ën
);

68 
	`ä“
(
Í
->
buf
);

69 
Í
->
buf
 = 
NULL
;

70 
Í
->
Ën
 = 0;

73 
	}
}

81 
	$sÿm³r_lš•Şl_hªdË
(
sÿm³r_lš•Şl_t
 *
Í
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

83 
ušt8_t
 *
bbuf
;

84 
size_t
 
i
 = 0, 
s
 = 0, 
bËn
;

86 
	`as£¹
(
Í
 !ğ
NULL
);

87 
	`as£¹
(
buf
 !ğ
NULL
);

90 if(
Ën
 < 1)

100 if(
Í
->
Ën
 > 0)

103 
i
 < 
Ën
)

106 if(
buf
[
i
] != '\n')

108 
i
++;

113 if((
bbuf
 = 
	`m®loc
(
Í
->
Ën
 + 
i
 + 1)è=ğ
NULL
)

117 
buf
[
i
] = '\0';

118 
	`memıy
(
bbuf
, 
Í
->
buf
,†p->
Ën
);

119 
	`memıy
(
bbuf
+
Í
->
Ën
, 
buf
, 
i
+1);

120 
bËn
 = 
Í
->
Ën
+
i
;

123 
	`ä“
(
Í
->
buf
);†p->buàğ
NULL
;†p->
Ën
 = 0;

126 if(
bbuf
[
bËn
-1] == '\r')

132 if(
bËn
-1 > 0)

134 
bbuf
[--
bËn
] = '\0';

135 
Í
->
	`hªdËr
Öp->
·¿m
, 
bbuf
, 
bËn
);

141 
	`as£¹
(
bËn
 > 0);

142 
Í
->
	`hªdËr
Öp->
·¿m
, 
bbuf
, 
bËn
);

145 
	`ä“
(
bbuf
);

153 if(
i
 =ğ
Ën
)

156 if((
bbuf
 = 
	`»®loc
(
Í
->
buf
,†p->
Ën
 +†’)è=ğ
NULL
)

160 
Í
->
buf
 = 
bbuf
;

166 
	`memıy
(
Í
->
buf
+Í->
Ën
, buf,†en);

167 
Í
->
Ën
 +=†en;

172 
s
 = ++
i
;

175 
i
 < 
Ën
)

178 if(
buf
[
i
] != '\n')

180 
i
++;

189 if(
s
 !ğ
i
)

191 
buf
[
i
] = '\0';

192 if(
buf
[
i
-1] != '\r')

194 
Í
->
	`hªdËr
Öp->
·¿m
, 
buf
+
s
, 
i
-s);

196 if(
i
 - 1 != 0)

198 
buf
[
i
-1] = '\0';

199 
Í
->
	`hªdËr
Öp->
·¿m
, 
buf
+
s
, 
i
-s-1);

204 
s
 = ++
i
;

207 if(
s
 < 
Ën
)

209 if((
Í
->
buf
 = 
	`m®loc
(
Ën
 - 
s
)è=ğ
NULL
)

214 
Í
->
Ën
 =†’ - 
s
;

215 
	`memıy
(
Í
->
buf
, buf+
s
,†p->
Ën
);

219 
	}
}

221 
sÿm³r_lš•Şl_t
 *
	$sÿm³r_lš•Şl_®loc
(
sÿm³r_lš•Şl_hªdËr_t
 
hªdËr
,

222 *
·¿m
)

224 
sÿm³r_lš•Şl_t
 *
Í
;

226 if((
Í
 = 
	`m®loc
((
sÿm³r_lš•Şl_t
))è=ğ
NULL
)

228  
NULL
;

231 
Í
->
hªdËr
 = handler;

232 
Í
->
·¿m
 =…aram;

233 
Í
->
buf
 = 
NULL
;

234 
Í
->
Ën
 = 0;

236  
Í
;

237 
	}
}

239 
	$sÿm³r_lš•Şl_ä“
(
sÿm³r_lš•Şl_t
 *
Í
, 
ãedÏ¡lše
)

241 
	`as£¹
(
Í
 !ğ
NULL
);

243 if(
ãedÏ¡lše
 == 1)

245 
	`sÿm³r_lš•Şl_æush
(
Í
);

248 if(
Í
->
buf
 !ğ
NULL
è
	`ä“
(lp->buf);

249 
	`ä“
(
Í
);

252 
	}
}

	@scamper_linepoll.h

25 #iâdeà
__SCAMPER_LINEPOLL_H


26 
	#__SCAMPER_LINEPOLL_H


	)

28 
sÿm³r_lš•Şl
 
	tsÿm³r_lš•Şl_t
;

29 (*
	tsÿm³r_lš•Şl_hªdËr_t
)(*
	t·¿m
,
	tušt8_t
 *
	tbuf
,
	tsize_t
 
	tËn
);

31 
	`sÿm³r_lš•Şl_hªdË
(
sÿm³r_lš•Şl_t
 *
Í
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
);

33 
	`sÿm³r_lš•Şl_æush
(
sÿm³r_lš•Şl_t
 *
Í
);

35 
sÿm³r_lš•Şl_t
 *
	`sÿm³r_lš•Şl_®loc
(
sÿm³r_lš•Şl_hªdËr_t
 
hªdËr
,

36 *
·¿m
);

38 
	`sÿm³r_lš•Şl_ä“
(
sÿm³r_lš•Şl_t
 *
Í
, 
ãedÏ¡lše
);

	@scamper_list.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"uts.h
"

46 
	$sÿm³r_cyşe_cmp
(
sÿm³r_cyşe_t
 *
a
, sÿm³r_cyşe_ˆ*
b
)

48 
i
;

50 if(
a
 =ğ
b
)

56 if((
i
 = 
	`sÿm³r_li¡_cmp
(
a
->
li¡
, 
b
->list)) != 0)

58  
i
;

62 if(
a
->
id
 < 
b
->id)  -1;

63 if(
a
->
id
 > 
b
->id)  1;

66 if(
a
->
¡¬t_time
 < 
b
->start_time)  -1;

67 if(
a
->
¡¬t_time
 > 
b
->start_time)  1;

70 if(
a
->
ho¡Çme
 !ğ
NULL
 || 
b
->hostname != NULL)

72 if(
a
->
ho¡Çme
 =ğ
NULL
 && 
b
->hostname != NULL)  -1;

73 if(
a
->
ho¡Çme
 !ğ
NULL
 && 
b
->hostname == NULL)  1;

74 if((
i
 = 
	`¡rcmp
(
a
->
ho¡Çme
, 
b
->hostname)) != 0)  i;

79 
	}
}

81 
sÿm³r_cyşe_t
 *
	$sÿm³r_cyşe_®loc
(
sÿm³r_li¡_t
 *
li¡
)

83 
sÿm³r_cyşe_t
 *
cyşe
;

85 if(
li¡
 =ğ
NULL
)

87  
NULL
;

90 if((
cyşe
 = 
	`m®loc_z”o
((
sÿm³r_cyşe
))è=ğ
NULL
)

92  
NULL
;

95 
cyşe
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

96 
cyşe
->
»fút
 = 1;

98  
cyşe
;

99 
	}
}

101 
sÿm³r_cyşe_t
 *
	$sÿm³r_cyşe_u£
(
sÿm³r_cyşe_t
 *
cyşe
)

103 if(
cyşe
 !ğ
NULL
ècyşe->
»fút
++;

104  
cyşe
;

105 
	}
}

107 
	$sÿm³r_cyşe_ä“
(
sÿm³r_cyşe_t
 *
cyşe
)

109 if(
cyşe
 !ğ
NULL
)

111 
	`as£¹
(
cyşe
->
»fút
 > 0);

113 if(--
cyşe
->
»fút
 > 0)

118 if(
cyşe
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(cycle->list);

119 if(
cyşe
->
ho¡Çme
 !ğ
NULL
è
	`ä“
(cycle->hostname);

120 
	`ä“
(
cyşe
);

124 
	}
}

126 
	$sÿm³r_li¡_cmp
(cÚ¡ 
sÿm³r_li¡_t
 *
a
, cÚ¡ sÿm³r_li¡_ˆ*
b
)

128 
i
;

131 if(
a
 =ğ
b
)

137 if(
a
->
id
 < 
b
->id)  -1;

138 if(
a
->
id
 > 
b
->id)  1;

141 if(
a
->
Çme
 !ğ
NULL
 || 
b
->name != NULL)

143 if(
a
->
Çme
 =ğ
NULL
 && 
b
->name != NULL)  -1;

144 if(
a
->
Çme
 !ğ
NULL
 && 
b
->name == NULL)  1;

145 if((
i
 = 
	`¡rcmp
(
a
->
Çme
, 
b
->name)) != 0)  i;

149 if(
a
->
desü
 !ğ
NULL
 || 
b
->descr != NULL)

151 if(
a
->
desü
 =ğ
NULL
 && 
b
->descr != NULL)  -1;

152 if(
a
->
desü
 !ğ
NULL
 && 
b
->descr == NULL)  1;

153 if((
i
 = 
	`¡rcmp
(
a
->
desü
, 
b
->descr)) != 0)  i;

157 if(
a
->
mÚ™Ü
 !ğ
NULL
 || 
b
->monitor != NULL)

159 if(
a
->
mÚ™Ü
 =ğ
NULL
 && 
b
->monitor != NULL)  -1;

160 if(
a
->
mÚ™Ü
 !ğ
NULL
 && 
b
->monitor == NULL)  1;

161 if((
i
 = 
	`¡rcmp
(
a
->
mÚ™Ü
, 
b
->monitor)) != 0)  i;

166 
	}
}

168 
sÿm³r_li¡_t
 *
	$sÿm³r_li¡_®loc
(cÚ¡ 
ušt32_t
 
id
, cÚ¡ *
Çme
,

169 cÚ¡ *
desü
, cÚ¡ *
mÚ™Ü
)

171 
sÿm³r_li¡_t
 *
li¡
;

173 if((
li¡
 = 
	`m®loc_z”o
((
sÿm³r_li¡
))è=ğ
NULL
)

175  
NULL
;

178 
li¡
->
id
 = id;

179 
li¡
->
»fút
 = 1;

181 if(
Çme
 !ğ
NULL
 && (
li¡
->Çmğ
	`¡rdup
(name)) == NULL)

183 
”r
;

186 if(
desü
 !ğ
NULL
 && (
li¡
->desü = 
	`¡rdup
(descr)) == NULL)

188 
”r
;

191 if(
mÚ™Ü
 !ğ
NULL
 && (
li¡
->mÚ™Ü = 
	`¡rdup
(monitor)) == NULL)

193 
”r
;

196  
li¡
;

198 
”r
:

199 
	`sÿm³r_li¡_ä“
(
li¡
);

200  
NULL
;

201 
	}
}

203 
sÿm³r_li¡_t
 *
	$sÿm³r_li¡_u£
(
sÿm³r_li¡_t
 *
li¡
)

205 if(
li¡
 !ğ
NULL
èli¡->
»fút
++;

206  
li¡
;

207 
	}
}

209 
	$sÿm³r_li¡_ä“
(
sÿm³r_li¡_t
 *
li¡
)

211 if(
li¡
 !ğ
NULL
)

213 
	`as£¹
(
li¡
->
»fút
 > 0);

215 if(--
li¡
->
»fút
 > 0)

220 if(
li¡
->
Çme
 !ğ
NULL
è
	`ä“
(list->name);

221 if(
li¡
->
desü
 !ğ
NULL
è
	`ä“
(list->descr);

222 if(
li¡
->
mÚ™Ü
 !ğ
NULL
è
	`ä“
(list->monitor);

223 
	`ä“
(
li¡
);

227 
	}
}

	@scamper_list.h

25 #iâdeà
__SCAMPER_LIST_H


26 
	#__SCAMPER_LIST_H


	)

39 
	ssÿm³r_li¡


41 
ušt32_t
 
	mid
;

42 *
	mÇme
;

43 *
	mdesü
;

44 *
	mmÚ™Ü
;

45 
	m»fút
;

46 } 
	tsÿm³r_li¡_t
;

60 
	ssÿm³r_cyşe


62 
sÿm³r_li¡_t
 *
	mli¡
;

63 
ušt32_t
 
	mid
;

64 
ušt32_t
 
	m¡¬t_time
;

65 
ušt32_t
 
	m¡İ_time
;

66 *
	mho¡Çme
;

67 
	m»fút
;

68 } 
	tsÿm³r_cyşe_t
;

77 
sÿm³r_li¡_t
 *
sÿm³r_li¡_®loc
(cÚ¡ 
ušt32_t
 
id
, cÚ¡ *
Çme
,

78 cÚ¡ *
desü
, cÚ¡ *
mÚ™Ü
);

79 
sÿm³r_li¡_t
 *
sÿm³r_li¡_u£
(sÿm³r_li¡_ˆ*
li¡
);

80 
sÿm³r_li¡_ä“
(
sÿm³r_li¡_t
 *
li¡
);

81 
sÿm³r_li¡_cmp
(cÚ¡ 
sÿm³r_li¡_t
 *
a
, cÚ¡ sÿm³r_li¡_ˆ*
b
);

83 
sÿm³r_cyşe_t
 *
sÿm³r_cyşe_®loc
(
sÿm³r_li¡_t
 *
li¡
);

84 
sÿm³r_cyşe_t
 *
sÿm³r_cyşe_u£
(sÿm³r_cyşe_ˆ*
cyşe
);

85 
sÿm³r_cyşe_ä“
(
sÿm³r_cyşe_t
 *
cyşe
);

86 
sÿm³r_cyşe_cmp
(
sÿm³r_cyşe_t
 *
a
, sÿm³r_cyşe_ˆ*
b
);

	@scamper_options.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_İtiÚs.h
"

35 
	~"uts.h
"

43 
	$İt_add
(
sÿm³r_İtiÚ_out_t
 **
h—d
, sÿm³r_İtiÚ_out_ˆ**

,

44 cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İt
, *
¡r
)

46 
	`as£¹
(
h—d
 !ğ
NULL
);

47 
	`as£¹
(

 !ğ
NULL
);

49 if(*

 =ğ
NULL
)

51 
	`as£¹
(*
h—d
 =ğ
NULL
);

53 if((*
h—d
 = 
	`m®loc
((
sÿm³r_İtiÚ_out_t
))è=ğ
NULL
)

57 *

 = *
h—d
;

61 if(((*

)->
Ãxt
 = 
	`m®loc
((
sÿm³r_İtiÚ_out_t
))è=ğ
NULL
)

65 *

 = (*)->
Ãxt
;

68 (*

)->
Ãxt
 = 
NULL
;

69 (*

)->
id
 = 
İt
->id;

70 (*

)->
ty³
 = 
İt
->type;

71 (*

)->
¡r
 = str;

74 
	}
}

83 
	$İt_·r£_·¿m
(
ty³
, **
¡r
, **
Ãxt
)

85 *
tmp
 = *
¡r
;

86 
d–im
;

88 if(
ty³
 =ğ
SCAMPER_OPTION_TYPE_NUM
)

90 
	`isdig™
(()*
tmp
) != 0)

92 
tmp
++;

96 if(
tmp
 =ğ*
¡r
)

98 
”r
;

102 if(*
tmp
 != '\0')

104 if(
	`is¥aû
(()*
tmp
) == 0)

106 
”r
;

110 if(
ty³
 =ğ
SCAMPER_OPTION_TYPE_STR
)

116 if(
tmp
[0] == '"' ||mp[0] == '\'')

119 
d–im
 = 
tmp
[0];

120 
tmp
++; *
¡r
 =mp;

131 
tmp
[0] !ğ
d–im
 &&mp[0] != '\0')mp++;

132 if(
tmp
[0] =ğ'\0'è
”r
;

136 *
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(*
¡r
);

142 if(
tmp
[0] == '\0')

144 *
Ãxt
 = 
NULL
;

149 
tmp
[0] = '\0';mp++;

155 
	`is¥aû
(()*
tmp
) != 0)mp++;

156 if(
tmp
[0] !ğ'\0'è*
Ãxt
 =mp;

157 *
Ãxt
 = 
NULL
;

161 
”r
:

162 *
Ãxt
 = 
NULL
;

164 
	}
}

166 
	$sÿm³r_İtiÚs_c2id
(cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts
,cÚ¡ 
út
,
c
)

168 
i
;

169 
i
=0; i<
út
; i++)

171 if(
c
 =ğ
İts
[
i
].c)

172  
İts
[
i
].
id
;

175 
	}
}

185 
	$sÿm³r_İtiÚs_·r£
(*
¡r
,

186 cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts
, cÚ¡ 
út
,

187 
sÿm³r_İtiÚ_out_t
 **
İts_out
, **
¡İ
)

189 
sÿm³r_İtiÚ_out_t
 *
h—d
 = 
NULL
;

190 
sÿm³r_İtiÚ_out_t
 *

 = 
NULL
;

191 *
Ãxt
;

192 
i
;

195 *
¡r
 !ğ'\0' && 
	`is¥aû
(()*str) != 0)

197 
¡r
++;

200 if(*
¡r
 == '\0')

202 
dÚe
;

214 if(
¡r
[0] != '-')

223 
Ãxt
 = 
	`¡ršg_ÃxtwÜd
(
¡r
);

229 if(
¡r
[1] == '-')

232 
i
=0; i<
út
; i++)

234 if(
İts
[
i
].
¡r
 !ğ
NULL
 && 
	`¡rcmp
(&str[2], opts[i].str) == 0)

240 if(
i
 !ğ
út
)

248 if(
İts
[
i
].
ty³
 =ğ
SCAMPER_OPTION_TYPE_NULL
)

250 if(
	`İt_add
(&
h—d
, &

, &
İts
[
i
], 
NULL
) == -1)

252 
”r
;

261 if(
Ãxt
 =ğ
NULL
è
”r
;

267 
¡r
 = 
Ãxt
;

268 if(
	`İt_·r£_·¿m
(
İts
[
i
].
ty³
, &
¡r
, &
Ãxt
) == -1)

270 
”r
;

272 if(
	`İt_add
(&
h—d
, &

, &
İts
[
i
], 
¡r
) == -1)

274 
”r
;

277 
Ãxt
;

280 
”r
;

285 
¡r
++;

293 *
¡r
 != '\0')

296 
i
=0; i<
út
; i++)

298 if(
İts
[
i
].
c
 !ğ'\0' && o±s[i].ø=ğ*
¡r
)

306 if(
İts
[
i
].
ty³
 =ğ
SCAMPER_OPTION_TYPE_NULL
)

308 if(
	`İt_add
(&
h—d
, &

, &
İts
[
i
], 
NULL
) == -1)

310 
”r
;

324 if(
¡r
[1] !ğ'\0' || 
Ãxt
 =ğ
NULL
)

326 
”r
;

333 
¡r
 = 
Ãxt
;

334 if(
	`İt_·r£_·¿m
(
İts
[
i
].
ty³
, &
¡r
, &
Ãxt
) == -1)

336 
”r
;

338 if(
	`İt_add
(&
h—d
, &

, &
İts
[
i
], 
¡r
) == -1)

340 
”r
;

343 
Ãxt
;

348 if(
i
 =ğ
út
è
”r
;

351 
¡r
++;

355 
Ãxt
:

356 
¡r
 = 
Ãxt
;

358 
Ãxt
 !ğ
NULL
);

360 
dÚe
:

361 *
¡İ
 = 
¡r
;

362 *
İts_out
 = 
h—d
;

365 
”r
:

366 *
¡İ
 = 
¡r
;

367 *
İts_out
 = 
h—d
;

369 
	}
}

371 
sÿm³r_İtiÚs_v®id©e
(cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts
, cÚ¡ 
út
,

372 
¬gc
, *
¬gv
[], *
¡İ
,

373 
	$v®id©e
(
İtid
, *
·¿m
, *
out
))

375 
i
, 
j
, 
k
, 
Ãedp
;

376 
İtid
 = -1;

378 
i
=1; i<
¬gc
; i++)

380 if(
¬gv
[
i
][0] != '-')

382 *
¡İ
 = 
i
;

386 
j
 = 1;

387 
Ãedp
 = 0;

388 
¬gv
[
i
][
j
] != '\0')

390 
k
=0; k<
út
; k++)

392 if(
İts
[
k
].
c
 =ğ
¬gv
[
i
][
j
])

398 if(
k
 =ğ
út
)

399 
”r
;

401 if(
İts
[
k
].
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
)

403 if(
Ãedp
 != 0)

404 
”r
;

405 
Ãedp
++;

406 
İtid
 = 
İts
[
k
].
id
;

409 
j
++;

412 if(
Ãedp
 == 1)

414 if(++
i
 =ğ
¬gc
)

415 
”r
;

417 if(
	`v®id©e
(
İtid
, 
¬gv
[
i
], 
NULL
) != 0)

418 
”r
;

422 *
¡İ
 = 
i
;

425 
”r
:

427 
	}
}

434 
	$sÿm³r_İtiÚs_couÁ
(
sÿm³r_İtiÚ_out_t
 *
İts
)

436 
i
 = 0;

438 
İts
 !ğ
NULL
)

440 
i
++;

441 
İts
 = o±s->
Ãxt
;

444  
i
;

445 
	}
}

453 
	$sÿm³r_İtiÚs_ä“
(
sÿm³r_İtiÚ_out_t
 *
İts
)

455 
sÿm³r_İtiÚ_out_t
 *
tmp
;

457 
İts
 !ğ
NULL
)

459 
tmp
 = 
İts
->
Ãxt
;

460 
	`ä“
(
İts
);

461 
İts
 = 
tmp
;

465 
	}
}

	@scamper_options.h

24 #iâdeà
__SCAMPER_OPTIONS_H


25 
	#__SCAMPER_OPTIONS_H


	)

27 
	#SCAMPER_OPTION_TYPE_NULL
 0x00

	)

28 
	#SCAMPER_OPTION_TYPE_STR
 0x01

	)

29 
	#SCAMPER_OPTION_TYPE_NUM
 0x02

	)

39 
	ssÿm³r_İtiÚ_š


46 
	mc
;

47 *
	m¡r
;

53 
	mid
;

59 
	mty³
;

61 } 
	tsÿm³r_İtiÚ_š_t
;

63 
	#SCAMPER_OPTION_COUNT
(
İts
è((İts)/(
sÿm³r_İtiÚ_š_t
))

	)

73 
	ssÿm³r_İtiÚ_out


75 
	mid
;

76 
	mty³
;

77 *
	m¡r
;

78 
sÿm³r_İtiÚ_out
 *
	mÃxt
;

79 } 
	tsÿm³r_İtiÚ_out_t
;

94 
sÿm³r_İtiÚs_·r£
(*
İt_¡r
,

95 cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts_š
, cÚ¡ 
út_š
,

96 
sÿm³r_İtiÚ_out_t
 **
İts_out
, **
¡İ
);

98 
sÿm³r_İtiÚs_v®id©e
(cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts
, cÚ¡ 
út
,

99 
¬gc
, *
¬gv
[], *
¡İ
,

100 
v®id©e
(
İtid
, *
·¿m
, *
out
));

107 
sÿm³r_İtiÚs_couÁ
(
sÿm³r_İtiÚ_out_t
 *
İts
);

109 
sÿm³r_İtiÚs_c2id
(cÚ¡ 
sÿm³r_İtiÚ_š_t
 *
İts
,cÚ¡ 
út
,
c
);

116 
sÿm³r_İtiÚs_ä“
(
sÿm³r_İtiÚ_out_t
 *
İts
);

	@scamper_osinfo.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_osšfo.h
"

35 
	~"uts.h
"

37 
sÿm³r_osšfo_t
 *
	gosšfo
 = 
NULL
;

39 cÚ¡ 
sÿm³r_osšfo_t
 *
	$sÿm³r_osšfo_g‘
()

41  
osšfo
;

42 
	}
}

49 #iâdeà
_WIN32


50 
	$sÿm³r_osšfo_š™
()

52 
ut¢ame
 utsname;

53 
i
;

54 *
¡r
;

57 if(
	`uÇme
(&
ut¢ame
) < 0)

58 
”r
;

61 if((
osšfo
 = 
	`m®loc_z”o
((
sÿm³r_osšfo_t
))è=ğ
NULL
)

62 
”r
;

65 if((
osšfo
->
os
 = 
	`¡rdup
(
ut¢ame
.
sy¢ame
)è=ğ
NULL
)

66 
”r
;

69 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "FreeBSD") == 0)

70 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_FREEBSD
;

71 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "OpenBSD") == 0)

72 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_OPENBSD
;

73 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "NetBSD") == 0)

74 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_NETBSD
;

75 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "SunOS") == 0)

76 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_SUNOS
;

77 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "Linux") == 0)

78 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_LINUX
;

79 if(
	`¡rÿ£cmp
(
osšfo
->
os
, "Darwin") == 0)

80 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_DARWIN
;

83 
¡r
 = 
ut¢ame
.
»Ëa£
;

84 *
¡r
 != '\0')

86 if(*
¡r
 == '.')

88 *
¡r
 = '\0';

89 
osšfo
->
os_»l_dÙs
++;

91 if(
	`isdig™
(()*
¡r
) == 0)

93 *
¡r
 = '\0';

96 
¡r
++;

98 if((
osšfo
->
os_»l
 = 
	`m®loc
(osšfo->
os_»l_dÙs
 * ())è=ğ
NULL
)

99 
”r
;

100 
¡r
 = 
ut¢ame
.
»Ëa£
;

101 
i
=0; i < 
osšfo
->
os_»l_dÙs
; i++)

103 if(
	`¡ršg_tŞÚg
(
¡r
, &
osšfo
->
os_»l
[
i
]) != 0)

104 
”r
;

106 *
¡r
 != '\0') str++;

107 
¡r
++;

112 
”r
:

114 
	}
}

117 #ifdeà
_WIN32


118 
	$sÿm³r_osšfo_š™
()

120 if((
osšfo
 = 
	`m®loc_z”o
((
sÿm³r_osšfo_t
))è=ğ
NULL
)

121 
”r
;

122 if((
osšfo
->
os
 = 
	`¡rdup
("Wšdows")è=ğ
NULL
)

123 
”r
;

124 
osšfo
->
os_id
 = 
SCAMPER_OSINFO_OS_WINDOWS
;

127 
”r
:

129 
	}
}

132 
	$sÿm³r_osšfo_ş—nup
()

134 if(
osšfo
 =ğ
NULL
)

136 if(
osšfo
->
os
 !ğ
NULL
è
	`ä“
(osinfo->os);

137 if(
osšfo
->
os_»l
 !ğ
NULL
è
	`ä“
(osinfo->os_rel);

138 
	`ä“
(
osšfo
);

140 
	}
}

	@scamper_osinfo.h

24 
	#SCAMPER_OSINFO_OS_NULL
 0

	)

25 
	#SCAMPER_OSINFO_OS_FREEBSD
 1

	)

26 
	#SCAMPER_OSINFO_OS_OPENBSD
 2

	)

27 
	#SCAMPER_OSINFO_OS_NETBSD
 3

	)

28 
	#SCAMPER_OSINFO_OS_SUNOS
 4

	)

29 
	#SCAMPER_OSINFO_OS_LINUX
 5

	)

30 
	#SCAMPER_OSINFO_OS_DARWIN
 6

	)

31 
	#SCAMPER_OSINFO_OS_WINDOWS
 7

	)

33 
	ssÿm³r_osšfo


36 *
	mos
;

37 
	mos_id
;

40 *
	mos_»l
;

41 
	mos_»l_dÙs
;

43 } 
	tsÿm³r_osšfo_t
;

45 
	#SCAMPER_OSINFO_IS_SUNOS
(
os
è((os)->
os_id
 =ğ
SCAMPER_OSINFO_OS_SUNOS
)

	)

47 
sÿm³r_osšfo_š™
();

48 
sÿm³r_osšfo_ş—nup
();

50 cÚ¡ 
sÿm³r_osšfo_t
 *
sÿm³r_osšfo_g‘
();

	@scamper_outfiles.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_debug.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_´iv£p.h
"

39 
	~"sÿm³r_outfes.h
"

40 
	~"uts.h
"

41 
	~"mjl_¥ÏyŒ“.h
"

43 
	ssÿm³r_outfe


45 *
	mÇme
;

46 
sÿm³r_fe_t
 *
	msf
;

47 
	m»fút
;

50 
¥ÏyŒ“_t
 *
	goutfes
 = 
NULL
;

51 
sÿm³r_outfe_t
 *
	goutfe_def
 = 
NULL
;

53 
	$outfe_cmp
(cÚ¡ *
a
, cÚ¡ *
b
)

55  
	`¡rÿ£cmp
(((cÚ¡ 
sÿm³r_outfe_t
 *)
b
)->
Çme
,

56 ((cÚ¡ 
sÿm³r_outfe_t
 *)
a
)->
Çme
);

57 
	}
}

59 
sÿm³r_outfe_t
 *
	$outfe_®loc
(*
Çme
, 
sÿm³r_fe_t
 *
sf
)

61 
sÿm³r_outfe_t
 *
sof
 = 
NULL
;

63 if((
sof
 = 
	`m®loc_z”o
((
sÿm³r_outfe_t
))è=ğ
NULL
)

65 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc sof");

66 
”r
;

69 
sof
->
sf
 = sf;

70 
sof
->
»fút
 = 1;

72 if((
sof
->
Çme
 = 
	`¡rdup
Òame)è=ğ
NULL
)

74 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup");

75 
”r
;

78 if(
	`¥ÏyŒ“_š£¹
(
outfes
, 
sof
è=ğ
NULL
)

80 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert");

81 
”r
;

84 
	`sÿm³r_debug
(
__func__
, "Çm% fd %d", 
Çme
, 
	`sÿm³r_fe_g‘fd
(
sf
));

85  
sof
;

87 
”r
:

88 if(
sof
 !ğ
NULL
)

90 if(
sof
->
Çme
 !ğ
NULL
è
	`ä“
(sof->name);

91 
	`ä“
(
sof
);

93  
NULL
;

94 
	}
}

96 
	$outfe_ä“
(
sÿm³r_outfe_t
 *
sof
)

98 
	`as£¹
(
sof
 !ğ
NULL
);

100 if(
sof
->
Çme
 !ğ
NULL
 && sof->
sf
 != NULL)

101 
	`sÿm³r_debug
(
__func__
, "Çm% fd %d", 
sof
->
Çme
,

102 
	`sÿm³r_fe_g‘fd
(
sof
->
sf
));

104 if(
sof
->
Çme
 !ğ
NULL
)

106 
	`¥ÏyŒ“_»move_™em
(
outfes
, 
sof
);

107 
	`ä“
(
sof
->
Çme
);

110 if(
sof
->
sf
 !ğ
NULL
)

112 
	`sÿm³r_fe_şo£
(
sof
->
sf
);

115 
	`ä“
(
sof
);

117 
	}
}

119 
	$sÿm³r_outfe_g‘»fút
(cÚ¡ 
sÿm³r_outfe_t
 *
sof
)

121  
sof
->
»fút
;

122 
	}
}

124 
sÿm³r_fe_t
 *
	$sÿm³r_outfe_g‘fe
(
sÿm³r_outfe_t
 *
sof
)

126  
sof
->
sf
;

127 
	}
}

129 cÚ¡ *
	$sÿm³r_outfe_g‘Çme
(cÚ¡ 
sÿm³r_outfe_t
 *
sof
)

131  
sof
->
Çme
;

132 
	}
}

134 
sÿm³r_outfe_t
 *
	$sÿm³r_outfe_u£
(
sÿm³r_outfe_t
 *
sof
)

136 if(
sof
 !ğ
NULL
)

138 
sof
->
»fút
++;

140  
sof
;

141 
	}
}

143 
	$sÿm³r_outfe_ä“
(
sÿm³r_outfe_t
 *
sof
)

145 
	`as£¹
(
sof
->
»fút
 > 0);

147 if(--
sof
->
»fút
 == 0)

148 
	`outfe_ä“
(
sof
);

151 
	}
}

153 
	$sÿm³r_outfe_şo£
(
sÿm³r_outfe_t
 *
sof
)

155 if(
sof
->
»fút
 > 1)

157 
	`sÿm³r_debug
(
__func__
,"nÙ closšg % »fúˆ%d",
sof
->
Çme
,sof->
»fút
);

161 
	`outfe_ä“
(
sof
);

163 
	}
}

165 
sÿm³r_outfe_t
 *
	$sÿm³r_outfes_g‘
(cÚ¡ *
Çme
)

167 cÚ¡ 
sÿm³r_outfe_t
 
fšdme
 = {(*)
Çme
, 
NULL
, 0};

168 if(
Çme
 =ğ
NULL
)

169  
outfe_def
;

170  
	`¥ÏyŒ“_fšd
(
outfes
, &
fšdme
);

171 
	}
}

178 
	$sÿm³r_outfes_sw­
(
sÿm³r_outfe_t
 *
a
, sÿm³r_outfe_ˆ*
b
)

180 
sÿm³r_fe_t
 *
sf
;

182 
sf
 = 
b
->sf;

183 
b
->
sf
 = 
a
->sf;

184 
a
->
sf
 = sf;

187 
	}
}

189 
sÿm³r_outfe_t
 *
	$sÿm³r_outfe_İ’
(*
Çme
, *
fe
, *
mo
)

191 
sÿm³r_outfe_t
 *
sof
;

192 
sÿm³r_fe_t
 *
sf
;

193 
æags
;

194 
mode_t
 
mode
;

195 
sf_mode
;

196 
fd
;

198 #ià
	`defšed
(
WITHOUT_PRIVSEP
è&& !defšed(
_WIN32
)

199 
uid_t
 
uid
;

202 if(
Çme
 =ğ
NULL
 || 
fe
 =ğNULL || 
mo
 == NULL)

204  
NULL
;

207 if((
sof
 = 
	`sÿm³r_outfes_g‘
(
Çme
)è!ğ
NULL
)

209  
NULL
;

212 if(
	`¡rÿ£cmp
(
mo
, "append") == 0)

214 
æags
 = 
O_RDWR
 | 
O_APPEND
 | 
O_CREAT
;

215 
sf_mode
 = 'a';

217 if(
	`¡rÿ£cmp
(
mo
, "truncate") == 0)

219 
æags
 = 
O_WRONLY
 | 
O_TRUNC
 | 
O_CREAT
;

220 
sf_mode
 = 'w';

224  
NULL
;

227 #iâdeà
_WIN32


228 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

230 
mode
 = 
_S_IREAD
 | 
_S_IWRITE
;

233 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

234 
fd
 = 
	`İ’
(
fe
, 
æags
, 
mode
);

236 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
fe
, 
æags
, 
mode
);

240 if(
fd
 == -1)

242  
NULL
;

245 #ià
	`defšed
(
WITHOUT_PRIVSEP
è&& !defšed(
_WIN32
)

246 if((
uid
 = 
	`g‘uid
()è!ğ
	`g‘euid
(è&& 
	`fchown
(
fd
, uid, -1) != 0)

248 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot fchown");

252 if((
sf
 = 
	`sÿm³r_fe_İ’fd
(
fd
, 
fe
, 
sf_mode
, "w¬ts")è=ğ
NULL
)

254 
	`şo£
(
fd
);

255  
NULL
;

258 if((
sof
 = 
	`outfe_®loc
(
Çme
, 
sf
)è=ğ
NULL
)

260 
	`sÿm³r_fe_şo£
(
sf
);

261  
NULL
;

264  
sof
;

265 
	}
}

267 
	$outfe_İ’def
(*
f’ame
, *
ty³
)

269 
sÿm³r_fe_t
 *
sf
;

270 
æags
;

271 
mode_t
 
mode
;

272 
sf_mode
;

273 
fd
;

275 
æags
 = 
O_WRONLY
 | 
O_TRUNC
 | 
O_CREAT
;

276 
sf_mode
 = 'w';

278 #iâdeà
_WIN32


279 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

281 
mode
 = 
_S_IREAD
 | 
_S_IWRITE
;

284 if(
	`¡rcmp
(
f’ame
, "-") == 0)

286 
fd
 = 
STDOUT_FILENO
;

290 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

291 
fd
 = 
	`İ’
(
f’ame
, 
æags
, 
mode
);

293 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
f’ame
, 
æags
, 
mode
);

297 if(
fd
 == -1)

302 if((
sf
 = 
	`sÿm³r_fe_İ’fd
(
fd
, 
f’ame
, 
sf_mode
, 
ty³
)è=ğ
NULL
)

304 
	`şo£
(
fd
);

308 if((
outfe_def
 = 
	`outfe_®loc
(
f’ame
, 
sf
)è=ğ
NULL
)

310 
	`sÿm³r_fe_şo£
(
sf
);

315 
	}
}

317 
sÿm³r_outfe_t
 *
	$sÿm³r_outfe_İ’fd
(*
Çme
, 
fd
, *
ty³
)

319 
sÿm³r_outfe_t
 *
sof
 = 
NULL
;

320 
sÿm³r_fe_t
 *
sf
 = 
NULL
;

322 if(
fd
 =ğ-1 || (
sf
 = 
	`sÿm³r_fe_İ’fd
(fd, 
NULL
, 'w', 
ty³
)) == NULL)

323  
NULL
;

325 if((
sof
 = 
	`outfe_®loc
(
Çme
, 
sf
)è=ğ
NULL
)

327 
	`sÿm³r_fe_ä“
(
sf
);

328  
NULL
;

331  
sof
;

332 
	}
}

334 
sÿm³r_outfe_t
 *
	$sÿm³r_outfe_İ’nuÎ
(*
Çme
)

336 
sÿm³r_outfe_t
 *
sof
;

337 
sÿm³r_fe_t
 *
sf
;

339 if((
sf
 = 
	`sÿm³r_fe_İ’nuÎ
('w')è=ğ
NULL
)

340  
NULL
;

342 if((
sof
 = 
	`outfe_®loc
(
Çme
, 
sf
)è=ğ
NULL
)

344 
	`sÿm³r_fe_ä“
(
sf
);

345  
NULL
;

348  
sof
;

349 
	}
}

351 
	$sÿm³r_outfes_fÜ—ch
(*
p
,

352 (*
func
)(*
p
, 
sÿm³r_outfe_t
 *
sof
))

354 
	`¥ÏyŒ“_šÜd”
(
outfes
, (
¥ÏyŒ“_šÜd”_t
)
func
, 
p
);

356 
	}
}

358 
	$sÿm³r_outfes_š™
(*
def_f’ame
, *
def_ty³
)

360 if((
outfes
 = 
	`¥ÏyŒ“_®loc
(
outfe_cmp
)è=ğ
NULL
)

365 if(
	`outfe_İ’def
(
def_f’ame
, 
def_ty³
) != 0)

371 
	}
}

373 
	$sÿm³r_outfes_ş—nup
()

375 if(
outfe_def
 !ğ
NULL
)

377 if(--
outfe_def
->
»fút
 > 0)

379 
	`sÿm³r_debug
(
__func__
,

380 "deçuÉ outf»fúˆ%d", 
outfe_def
->
»fút
);

383 
	`outfe_ä“
(
outfe_def
);

384 
outfe_def
 = 
NULL
;

387 if(
outfes
 !ğ
NULL
)

389 
	`¥ÏyŒ“_ä“
(
outfes
, 
NULL
);

390 
outfes
 = 
NULL
;

394 
	}
}

	@scamper_outfiles.h

25 #iâdeà
__SCAMPER_OUTFILES_H


26 
	#__SCAMPER_OUTFILES_h


	)

28 
sÿm³r_outfe
 
	tsÿm³r_outfe_t
;

30 
	gsÿm³r_fe
;

32 
sÿm³r_fe
 *
sÿm³r_outfe_g‘fe
(
sÿm³r_outfe_t
 *
sof
);

33 cÚ¡ *
sÿm³r_outfe_g‘Çme
(cÚ¡ 
sÿm³r_outfe_t
 *
sof
);

34 
sÿm³r_outfe_g‘»fút
(cÚ¡ 
sÿm³r_outfe_t
 *
sof
);

36 
sÿm³r_outfe_t
 *
sÿm³r_outfe_İ’
(*
®Ÿs
, *
fe
, *
mo
);

37 
sÿm³r_outfe_şo£
(
sÿm³r_outfe_t
 *
sof
);

38 
sÿm³r_outfe_t
 *
sÿm³r_outfe_u£
(sÿm³r_outfe_ˆ*
sof
);

39 
sÿm³r_outfe_ä“
(
sÿm³r_outfe_t
 *
sof
);

41 
sÿm³r_outfe_t
 *
sÿm³r_outfe_İ’fd
(*
Çme
, 
fd
, *
ty³
);

42 
sÿm³r_outfe_t
 *
sÿm³r_outfe_İ’nuÎ
(*
Çme
);

44 
sÿm³r_outfe_t
 *
sÿm³r_outfes_g‘
(cÚ¡ *
®Ÿs
);

45 
sÿm³r_outfes_sw­
(
sÿm³r_outfe_t
 *
a
, sÿm³r_outfe_ˆ*
b
);

47 
sÿm³r_outfes_fÜ—ch
(*
p
,

48 (*
func
)(*
p
, 
sÿm³r_outfe_t
 *
sof
));

50 
	`sÿm³r_outfes_š™
(*
def_f’ame
, *
def_ty³
);

51 
	`sÿm³r_outfes_ş—nup
();

	@scamper_privsep.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~"cÚfig.h
"

30 #iâdeà
WITHOUT_PRIVSEP


32 #iâdeà
lšt


33 cÚ¡ 
	grcsid
[] =

37 
	~"š‹º®.h
"

39 
	~"sÿm³r_´iv£p.h
"

40 
	~"sÿm³r_debug.h
"

41 
	~"uts.h
"

43 
	~"sÿm³r_dl.h
"

44 
	~"sÿm³r_¹sock.h
"

45 
	~"sÿm³r_fœew®l.h
"

47 
	s´iv£p_msg


49 
ušt16_t
 
	m¶’
;

50 
ušt16_t
 
	mty³
;

51 } 
	t´iv£p_msg_t
;

53 
	s´iv£p_func


55 (*
	mdofunc
)(
ušt16_t
 
	mËn
, cÚ¡ 
ušt8_t
 *
	m·¿m
);

56 (*
	mtxfunc
)(, , 
	mušt8_t
);

57 } 
	t´iv£p_func_t
;

59 
pid_t
 
	groÙ_pid
 = -1;

60 
	groÙ_fd
 = -1;

61 
	gÏme_fd
 = -1;

63 #ià
defšed
(
IPPROTO_DIVERT
)

64 
	gdiv”t_Ú
 = 0;

72 
	#SCAMPER_PRIVSEP_EXIT
 0x00U

	)

73 
	#SCAMPER_PRIVSEP_OPEN_DATALINK
 0x01U

	)

74 
	#SCAMPER_PRIVSEP_OPEN_FILE
 0x02U

	)

75 
	#SCAMPER_PRIVSEP_OPEN_RTSOCK
 0x03U

	)

76 
	#SCAMPER_PRIVSEP_OPEN_ICMP
 0x04U

	)

77 
	#SCAMPER_PRIVSEP_OPEN_DIVERT
 0x05U

	)

78 
	#SCAMPER_PRIVSEP_OPEN_SOCK
 0x06U

	)

79 
	#SCAMPER_PRIVSEP_OPEN_RAWUDP
 0x07U

	)

80 
	#SCAMPER_PRIVSEP_OPEN_UNIX
 0x08U

	)

81 
	#SCAMPER_PRIVSEP_OPEN_RAWIP
 0x09U

	)

82 
	#SCAMPER_PRIVSEP_UNLINK
 0x0aU

	)

83 
	#SCAMPER_PRIVSEP_IPFW_INIT
 0x0bU

	)

84 
	#SCAMPER_PRIVSEP_IPFW_CLEANUP
 0x0cU

	)

85 
	#SCAMPER_PRIVSEP_IPFW_ADD
 0x0dU

	)

86 
	#SCAMPER_PRIVSEP_IPFW_DEL
 0x0eU

	)

88 
	#SCAMPER_PRIVSEP_MAXTYPE
 (
SCAMPER_PRIVSEP_IPFW_DEL
)

	)

97 
	$´iv£p_İ’_icmp
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

99 
ty³
, 
´ÙocŞ
, 
İt
;

100 
fd
 = -1;

102 if(
¶’
 !ğ(
ty³
))

104 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ%d", 
¶’
, (
ty³
));

108 
	`memıy
(&
ty³
, 
·¿m
, (type));

110 if(
ty³
 =ğ
AF_INET
)

112 
´ÙocŞ
 = 
IPPROTO_ICMP
;

114 if(
ty³
 =ğ
AF_INET6
)

116 
´ÙocŞ
 = 
IPPROTO_ICMPV6
;

120 
	`sÿm³r_debug
(
__func__
, "ty³ %d !ğAF_INET || AF_INET6", 
ty³
);

121 
”ºo
 = 
EINVAL
;

122 
”r
;

125 if((
fd
 = 
	`sock‘
(
ty³
, 
SOCK_RAW
, 
´ÙocŞ
)) == -1)

127 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

128 
”r
;

131 if(
ty³
 =ğ
AF_INET
)

133 
İt
 = 1;

134 if(
	`£tsockİt
(
fd
,
IPPROTO_IP
,
IP_HDRINCL
,(*)&
İt
,(opt)) == -1)

136 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IP_HDRINCL");

137 
”r
;

141  
fd
;

143 
”r
:

144 if(
fd
 !ğ-1è
	`şo£
(fd);

146 
	}
}

154 
	$´iv£p_İ’_¹sock
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

156 if(
¶’
 != 0)

158 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ0", 
¶’
, 0);

159 
”ºo
 = 
EINVAL
;

163  
	`sÿm³r_¹sock_İ’_fd
();

164 
	}
}

172 
	$´iv£p_İ’_d©®šk
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

174 
ifšdex
;

177 if(
¶’
 !ğ(
ifšdex
))

179 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ%d", 
¶’
, (
ifšdex
));

180 
”ºo
 = 
EINVAL
;

184 
	`memıy
(&
ifšdex
, 
·¿m
, (ifindex));

186  
	`sÿm³r_dl_İ’_fd
(
ifšdex
);

187 
	}
}

194 
	$´iv£p_İ’_div”t
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

196 
fd
 = -1;

198 #ià
	`defšed
(
IPPROTO_DIVERT
)

199 
sockaddr_š
 
sš
;

200 
pÜt
;

202 if(
div”t_Ú
 == 0)

205 if(
¶’
 !ğ(
pÜt
))

207 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ%d", 
¶’
, (
pÜt
));

208 
”ºo
 = 
EINVAL
;

212 
	`memıy
(&
pÜt
, 
·¿m
, (port));

214 if((
fd
 = 
	`sock‘
(
PF_INET
, 
SOCK_RAW
, 
IPPROTO_DIVERT
)) == -1)

216 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

220 
	`mem£t
(&
sš
, 0, (sin));

221 
sš
.
sš_Ën
 = (sin);

222 
sš
.
sš_çmy
 = 
AF_INET
;

223 
sš
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

224 
sš
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

225 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš
, (sin)) == -1)

227 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind socket");

231 
	`sÿm³r_debug
(
__func__
, "divert sockets‚ot supported");

232 
”ºo
 = 
EINVAL
;

235  
fd
;

236 
	}
}

238 
	$´iv£p_İ’_sock
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

240 
sockaddr_š
 
sš4
;

241 
sockaddr_š6
 
sš6
;

242 
domaš
, 
ty³
, 
´ÙocŞ
, 
pÜt
;

243 cÚ¡ 
size_t
 
size
 = (
domaš
è+ (
´ÙocŞ
è+ (
pÜt
);

244 
size_t
 
off
 = 0;

245 
fd
 = -1;

247 if(
¶’
 !ğ
size
)

249 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ%d", 
¶’
, 
size
);

250 
”ºo
 = 
EINVAL
;

251 
”r
;

253 
off
 = 0;

254 
	`memıy
(&
domaš
, 
·¿m
+
off
, (domain)); off += (domain);

255 
	`memıy
(&
´ÙocŞ
, 
·¿m
+
off
, (protocol)); off += (protocol);

256 
	`memıy
(&
pÜt
, 
·¿m
+
off
, (port)); off += (port);

258 if(
off
 !ğ
¶’
)

259 
šv®
;

261 if(
pÜt
 < 1 ||…ort > 65535)

263 
	`sÿm³r_debug
(
__func__
, "»fusšgØbšdØpÜˆ%d", 
pÜt
);

264 
šv®
;

267 if(
´ÙocŞ
 =ğ
IPPROTO_TCP
è
ty³
 = 
SOCK_STREAM
;

268 if(
´ÙocŞ
 =ğ
IPPROTO_UDP
è
ty³
 = 
SOCK_DGRAM
;

271 
	`sÿm³r_debug
(
__func__
, "unhªdËd IPv4…rÙocŞ %d", 
´ÙocŞ
);

272 
šv®
;

275 if(
domaš
 =ğ
AF_INET
)

277 if((
fd
 = 
	`sock‘
(
AF_INET
, 
ty³
, 
´ÙocŞ
)) == -1)

279 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open IPv4 socket");

280 
”r
;

282 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, 
NULL
, 
pÜt
);

283 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš4
, (sin4)) == -1)

285 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

287 
´ÙocŞ
, 
pÜt
);

288 
”r
;

291 if(
domaš
 =ğ
AF_INET6
)

293 if((
fd
 = 
	`sock‘
(
AF_INET6
, 
ty³
, 
´ÙocŞ
)) == -1)

295 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open IPv6 socket");

296 
”r
;

298 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
, 
NULL
, 
pÜt
);

299 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš6
, (sin6)) == -1)

301 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

303 
´ÙocŞ
, 
pÜt
);

304 
”r
;

309  
fd
;

311 
šv®
:

312 
”ºo
 = 
EINVAL
;

313 
”r
:

314 if(
fd
 !ğ-1è
	`şo£
(fd);

316 
	}
}

318 
	$´iv£p_İ’_¿wudp
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

320 
š_addr
 
š
;

321 
sockaddr_š
 
sš4
;

322 
fd
, 
hdr
;

323 
tmp
[32];

325 if(
¶’
 != 4)

327 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ4", 
¶’
);

328 
”ºo
 = 
EINVAL
;

332 
	`memıy
(&
š
, 
·¿m
+0, (in));

333 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_UDP
)) == -1)

335 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

339 
hdr
 = 1;

340 if(
	`£tsockİt
(
fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, (*)&
hdr
, (hdr)) == -1)

342 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IP_HDRINCL");

343 
”r
;

346 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, &
š
, 0);

347 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš4
, (sin4)) == -1)

349 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind %s",

350 
	`sockaddr_to¡r
((
sockaddr
 *)&
sš4
, 
tmp
, (tmp)));

351 
”r
;

354  
fd
;

356 
”r
:

357 if(
fd
 !ğ-1è
	`şo£
(fd);

359 
	}
}

361 
	$´iv£p_İ’_¿w
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

363 
fd
, 
hdr
 = 1;

365 if(
¶’
 != 0)

367 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ4", 
¶’
);

368 
”ºo
 = 
EINVAL
;

372 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_RAW
)) == -1)

374 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

378 if(
	`£tsockİt
(
fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, (*)&
hdr
, (hdr)) == -1)

380 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IP_HDRINCL");

381 
”r
;

384  
fd
;

386 
”r
:

387 if(
fd
 !ğ-1è
	`şo£
(fd);

389 
	}
}

391 
	$´iv£p_fw_š™
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

393 #ifdeà
HAVE_IPFW


394 if(
¶’
 != 0)

396 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ0", 
¶’
);

397 
”ºo
 = 
EINVAL
;

400  
	`sÿm³r_fœew®l_fw_š™
();

402 
	`sÿm³r_debug
(
__func__
, "nÙ oÀfw sy¡em", 
¶’
);

403 
”ºo
 = 
EINVAL
;

406 
	}
}

408 
	$´iv£p_fw_ş—nup
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

410 #ifdeà
HAVE_IPFW


411 if(
¶’
 != 0)

413 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ0", 
¶’
);

414 
”ºo
 = 
EINVAL
;

417 
	`sÿm³r_fœew®l_fw_ş—nup
();

420 
	`sÿm³r_debug
(
__func__
, "nÙ oÀfw sy¡em", 
¶’
);

421 
”ºo
 = 
EINVAL
;

424 
	}
}

426 
	$´iv£p_fw_add
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

428 #ifdeà
HAVE_IPFW


429 
n
, 
af
, 
p
, 
¥
, 
dp
;

430 
š_addr
 
s4
, 
d4
;

431 
š6_addr
 
s6
, 
d6
;

432 *
s
, *
d
 = 
NULL
;

433 
ušt8_t
 
df
;

434 
ušt16_t
 
off
 = 0, 
®
;

436 if(
¶’
 < 1 + ())

438 
	`sÿm³r_debug
(
__func__
, "¶’ %d < %d", 
¶’
, 1 + ());

439 
šv®
;

442 
df
 = 
·¿m
[0]; 
off
++;

443 if(
df
 != 0 && df != 1)

445 
	`sÿm³r_debug
(
__func__
, "dà%d", 
df
);

446 
šv®
;

449 
	`memıy
(&
af
, 
·¿m
+
off
, (af)); off += (af);

450 if(
af
 =ğ
AF_INET
)

452 
s
 = &
s4
;

453 
®
 = 4;

454 if(
df
 == 0)

456 if(
¶’
 !ğ1 + ((è* 5è+ (
š_addr
))

457 
šv®
;

461 if(
¶’
 !ğ1 + ((è* 5è+ ((
š_addr
) * 2))

462 
šv®
;

463 
d
 = &
d4
;

466 if(
af
 =ğ
AF_INET6
)

468 
s
 = &
s6
;

469 
®
 = 16;

470 if(
df
 == 0)

472 if(
¶’
 !ğ1 + ((è* 5è+ (
š6_addr
))

473 
šv®
;

477 if(
¶’
 !ğ1 + ((è* 5è+ ((
š6_addr
) * 2))

478 
šv®
;

479 
d
 = &
d6
;

482 
šv®
;

484 
	`memıy
(&
n
, 
·¿m
+
off
, (n)); off += (n);

485 
	`memıy
(&
p
, 
·¿m
+
off
, (p)); off += (p);

487 if(
af
 =ğ
AF_INET
)

488 
	`memıy
(&
s4
, 
·¿m
+
off
, 
®
);

490 
	`memıy
(&
s6
, 
·¿m
+
off
, 
®
);

491 
off
 +ğ
®
;

493 if(
df
 != 0)

495 if(
af
 =ğ
AF_INET
)

496 
	`memıy
(&
d4
, 
·¿m
+
off
, 
®
);

498 
	`memıy
(&
d6
, 
·¿m
+
off
, 
®
);

499 
off
 +ğ
®
;

502 
	`memıy
(&
¥
, 
·¿m
+
off
, (sp)); off += (sp);

503 
	`memıy
(&
dp
, 
·¿m
+
off
, (dp)); off += (dp);

505 if(
off
 !ğ
¶’
)

506 
šv®
;

507 if(
¥
 < 0 || s°> 65535 || 
dp
 < 0 || dp > 65535)

508 
šv®
;

509 if(
p
 !ğ
IPPROTO_TCP
 &&… !ğ
IPPROTO_UDP
)

510 
šv®
;

512  
	`sÿm³r_fœew®l_fw_add
(
n
, 
af
, 
p
, 
s
, 
d
, 
¥
, 
dp
);

514 
šv®
:

515 
”ºo
 = 
EINVAL
;

518 
	`sÿm³r_debug
(
__func__
, "nÙ oÀfw sy¡em", 
¶’
);

519 
”ºo
 = 
EINVAL
;

522 
	}
}

524 
	$´iv£p_fw_d–
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

526 #ifdeà
HAVE_IPFW


527 
n
, 
af
;

528 
ušt16_t
 
off
 = 0;

530 if(
¶’
 != () * 2)

532 
	`sÿm³r_debug
(
__func__
, "¶’ %d !ğ%d", 
¶’
, () * 2);

533 
šv®
;

536 
	`memıy
(&
n
, 
·¿m
+
off
, (n)); off += (n);

537 
	`memıy
(&
af
, 
·¿m
+
off
, (af)); off += (af);

538 if(
off
 !ğ
¶’
)

539 
šv®
;

541  
	`sÿm³r_fœew®l_fw_d–
(
n
, 
af
);

543 
šv®
:

544 
”ºo
 = 
EINVAL
;

547 
	`sÿm³r_debug
(
__func__
, "nÙ oÀfw sy¡em", 
¶’
);

548 
”ºo
 = 
EINVAL
;

551 
	}
}

553 
	$´iv£p_uÆšk
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

555 cÚ¡ *
Çme
 = (cÚ¡ *)
·¿m
;

556 
uid_t
 
uid
, 
euid
;

558 if(
¶’
 < 2 || 
Çme
[plen-1] != '\0')

561 
uid
 = 
	`g‘uid
();

562 
euid
 = 
	`g‘euid
();

563 if(
	`£‹uid
(
uid
) != 0)

565 
	`uÆšk
(
Çme
);

566 if(
	`£‹uid
(
euid
) != 0)

567 
	`ex™
(-
”ºo
);

570 
	}
}

572 
	$´iv£p_İ’_unix
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

574 cÚ¡ *
Çme
 = (cÚ¡ *)
·¿m
;

575 
sockaddr_un
 
¢
;

576 
uid_t
 
uid
, 
euid
;

577 
fd
, 
brc
;

579 if(
¶’
 < 2 || 
Çme
[plen-1] != '\0')

582 if(
	`sockaddr_compo£_un
((
sockaddr
 *)&
¢
, 
Çme
) != 0)

586 
uid
 = 
	`g‘uid
();

587 
euid
 = 
	`g‘euid
();

588 if(
	`£‹uid
(
uid
) != 0)

592 if((
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) != -1)

594 if((
brc
 = 
	`bšd
(
fd
, (
sockaddr
 *)&
¢
, (sn))) != 0 ||

595 
	`li¡’
(
fd
, -1) != 0)

597 
	`şo£
(
fd
);

598 
fd
 = -1;

599 if(
brc
 == 0)

600 
	`uÆšk
(
Çme
);

604 if(
	`£‹uid
(
euid
) != 0)

606 if(
fd
 !ğ-1è
	`şo£
(fd);

607 
	`ex™
(-
”ºo
);

610  
fd
;

611 
	}
}

619 
	$´iv£p_İ’_fe
(
ušt16_t
 
¶’
, cÚ¡ 
ušt8_t
 *
·¿m
)

621 cÚ¡ *
fe
;

622 
uid_t
 
uid
, 
euid
;

623 
æags
;

624 
mode_t
 
mode
 = 0;

625 
ušt16_t
 
off
;

626 
fd
;

632 if(
¶’
 < () + 2)

635 
	`memıy
(&
æags
, 
·¿m
, ());

636 
off
 = ();

639 if(
æags
 & 
O_CREAT
)

645 if(
¶’
 < 
off
 + (
mode_t
) + 2)

648 
	`memıy
(&
mode
, 
·¿m
+
off
, (mode));

649 
off
 +ğ(
mode
);

652 
fe
 = (cÚ¡ *)(
·¿m
 + 
off
);

658 if(
fe
[
¶’
-
off
-1] != '\0')

660 
	`sÿm³r_debug
(
__func__
, "filename‚oterminated with‡‚ull");

664 
uid
 = 
	`g‘uid
();

665 
euid
 = 
	`g‘euid
();

668 if(
	`£‹uid
(
uid
) == -1)

673 if(
æags
 & 
O_CREAT
)

674 
fd
 = 
	`İ’
(
fe
, 
æags
, 
mode
);

676 
fd
 = 
	`İ’
(
fe
, 
æags
);

682 if(
	`£‹uid
(
euid
) == -1)

684 if(
fd
 !ğ-1è
	`şo£
(fd);

685 
	`ex™
(-
”ºo
);

688  
fd
;

689 
	}
}

691 
	$´iv£p_£nd_rc
(
rc
, 
”rÜ
, 
ušt8_t
 
msg_ty³
)

693 
ušt8_t
 
buf
[() * 2];

694 
msghdr
 
msg
;

695 
iovec
 
vec
;

697 
	`sÿm³r_debug
(
__func__
, "rc: %d,ƒrror: %d, msg_type: 0x%02x",

698 
rc
, 
”rÜ
, 
msg_ty³
);

700 
	`mem£t
(&
vec
, 0, (vec));

701 
	`mem£t
(&
msg
, 0, (msg));

703 
	`memıy
(
buf
, &
rc
, ());

704 
	`memıy
(
buf
+(), &
”rÜ
, ());

705 
vec
.
iov_ba£
 = (*)
buf
;

706 
vec
.
iov_Ën
 = (
buf
);

708 
msg
.
msg_iov
 = &
vec
;

709 
msg
.
msg_iovËn
 = 1;

711 if(
	`£ndmsg
(
roÙ_fd
, &
msg
, 0) == -1)

716 
	}
}

725 
	$´iv£p_£nd_fd
(
fd
, 
”rÜ
, 
ušt8_t
 
msg_ty³
)

727 
ušt8_t
 
buf
[()];

728 
msghdr
 
msg
;

729 
iovec
 
vec
;

731 #ià!
	`defšed
(
HAVE_ACCRIGHTS
)

732 
cmsghdr
 *
cmsg
;

733 
ušt8_t
 
tmp
[
	`CMSG_LEN
(())];

736 
	`sÿm³r_debug
(
__func__
, "fd: %dƒrror: %d msg_type: 0x%02x",

737 
fd
, 
”rÜ
, 
msg_ty³
);

739 
	`mem£t
(&
vec
, 0, (vec));

740 
	`mem£t
(&
msg
, 0, (msg));

742 
	`memıy
(
buf
, &
”rÜ
, ());

743 
vec
.
iov_ba£
 = (*)
buf
;

744 
vec
.
iov_Ën
 = (
buf
);

746 
msg
.
msg_iov
 = &
vec
;

747 
msg
.
msg_iovËn
 = 1;

749 if(
fd
 != -1)

751 #ià
	`defšed
(
HAVE_ACCRIGHTS
)

752 
msg
.
msg_acüights
 = (
ÿddr_t
)&
fd
;

753 
msg
.
msg_acüight¦’
 = (
fd
);

755 
msg
.
msg_cÚŒŞ
 = (
ÿddr_t
)
tmp
;

756 
msg
.
msg_cÚŒŞËn
 = 
	`CMSG_LEN
(());

758 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
);

759 
cmsg
->
cmsg_Ën
 = 
	`CMSG_LEN
(());

760 
cmsg
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

761 
cmsg
->
cmsg_ty³
 = 
SCM_RIGHTS
;

762 *(*)
	`CMSG_DATA
(
cmsg
èğ
fd
;

766 if(
	`£ndmsg
(
roÙ_fd
, &
msg
, 0) == -1)

768 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "couldnt send fd");

773 
	}
}

775 
	$´iv£p_»cv_fd
()

777 
msghdr
 
msg
;

778 
iovec
 
vec
;

779 
ssize_t
 
rc
;

780 
fd
 = -1, 
”rÜ
;

782 #ià!
	`defšed
(
HAVE_ACCRIGHTS
)

783 
cmsghdr
 *
cmsg
;

784 
ušt8_t
 
tmp
[
	`CMSG_LEN
(())];

787 
	`mem£t
(&
vec
, 0, (vec));

788 
	`mem£t
(&
msg
, 0, (msg));

790 
vec
.
iov_ba£
 = (*)&
”rÜ
;

791 
vec
.
iov_Ën
 = (
”rÜ
);

793 
msg
.
msg_iov
 = &
vec
;

794 
msg
.
msg_iovËn
 = 1;

796 #ià
	`defšed
(
HAVE_ACCRIGHTS
)

797 
msg
.
msg_acüights
 = (
ÿddr_t
)&
fd
;

798 
msg
.
msg_acüight¦’
 = (
fd
);

800 
msg
.
msg_cÚŒŞ
 = 
tmp
;

801 
msg
.
msg_cÚŒŞËn
 = (
tmp
);

804 if((
rc
 = 
	`»cvmsg
(
Ïme_fd
, &
msg
, 0)) == -1)

806 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "recvmsg failed");

809 if(
rc
 !ğ(
”rÜ
))

814 if(
”rÜ
 == 0)

816 #ià
	`defšed
(
HAVE_ACCRIGHTS
)

817 if(
msg
.
msg_acüight¦’
 !ğ(
fd
))

819 
fd
 = -1;

822 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
);

823 if(
cmsg
 !ğ
NULL
 && cmsg->
cmsg_ty³
 =ğ
SCM_RIGHTS
)

825 
fd
 = (*(*)
	`CMSG_DATA
(
cmsg
));

831 
”ºo
 = 
”rÜ
;

834  
fd
;

835 
	}
}

844 
	$´iv£p_do
()

846 cÚ¡ 
´iv£p_func_t
 
funcs
[] = {

847 {
NULL
, NULL},

848 {
´iv£p_İ’_d©®šk
, 
´iv£p_£nd_fd
},

849 {
´iv£p_İ’_fe
, 
´iv£p_£nd_fd
},

850 {
´iv£p_İ’_¹sock
, 
´iv£p_£nd_fd
},

851 {
´iv£p_İ’_icmp
, 
´iv£p_£nd_fd
},

852 {
´iv£p_İ’_div”t
, 
´iv£p_£nd_fd
},

853 {
´iv£p_İ’_sock
, 
´iv£p_£nd_fd
},

854 {
´iv£p_İ’_¿wudp
, 
´iv£p_£nd_fd
},

855 {
´iv£p_İ’_unix
, 
´iv£p_£nd_fd
},

856 {
´iv£p_İ’_¿w
, 
´iv£p_£nd_fd
},

857 {
´iv£p_uÆšk
, 
´iv£p_£nd_rc
},

858 {
´iv£p_fw_š™
, 
´iv£p_£nd_rc
},

859 {
´iv£p_fw_ş—nup
, 
´iv£p_£nd_rc
},

860 {
´iv£p_fw_add
, 
´iv£p_£nd_rc
},

861 {
´iv£p_fw_d–
, 
´iv£p_£nd_rc
},

864 
´iv£p_msg_t
 
msg
;

865 *
d©a
 = 
NULL
;

866 
»t
 = 0, 
”rÜ
;

867 
fd
;

869 #ià
	`defšed
(
HAVE_SETPROCTITLE
)

870 
	`£roù™Ë
("%s", "[priv]");

874 
roÙ_pid
 = 
	`g‘pid
();

880 
	`şo£
(
Ïme_fd
);

881 
Ïme_fd
 = -1;

886 if((
»t
 = 
	`»ad_w¿p
(
roÙ_fd
, (
ušt8_t
 *)&
msg
, 
NULL
, (msg))) != 0)

888 if(
»t
 == -1)

889 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ead msg hdr");

894 if(
msg
.
ty³
 =ğ
SCAMPER_PRIVSEP_EXIT
)

897 if(
msg
.
ty³
 > 
SCAMPER_PRIVSEP_MAXTYPE
)

899 
	`sÿm³r_debug
(
__func__
, "msg %d > maxty³", 
msg
.
ty³
);

900 
»t
 = -
EINVAL
;

905 if(
msg
.
¶’
 != 0)

907 if((
d©a
 = 
	`m®loc
(
msg
.
¶’
)è=ğ
NULL
)

909 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "couldnt malloc data");

910 
»t
 = (-
”ºo
);

914 if((
»t
 = 
	`»ad_w¿p
(
roÙ_fd
, 
d©a
, 
NULL
, 
msg
.
¶’
)) != 0)

916 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "couldnt„ead data");

917 
	`ä“
(
d©a
);

921 
d©a
 = 
NULL
;

923 if((
fd
 = 
funcs
[
msg
.
ty³
].
	`dofunc
(msg.
¶’
, 
d©a
)) == -1)

924 
”rÜ
 = 
”ºo
;

926 
”rÜ
 = 0;

929 if(
d©a
 !ğ
NULL
)

930 
	`ä“
(
d©a
);

932 if(
funcs
[
msg
.
ty³
].
	`txfunc
(
fd
, 
”rÜ
, msg.type) != 0)

935 if(
funcs
[
msg
.
ty³
].
txfunc
 =ğ
´iv£p_£nd_fd
 && 
fd
 != -1)

936 
	`şo£
(
fd
);

939 
	`şo£
(
roÙ_fd
);

940  
»t
;

941 
	}
}

949 
	$´iv£p_Ïme_£nd
(cÚ¡ 
ušt16_t
 
ty³
, cÚ¡ ušt16_ˆ
Ën
,

950 cÚ¡ 
ušt8_t
 *
·¿m
)

952 
´iv£p_msg_t
 
msg
;

954 
	`as£¹
(
ty³
 !ğ
SCAMPER_PRIVSEP_EXIT
);

955 
	`as£¹
(
ty³
 <ğ
SCAMPER_PRIVSEP_MAXTYPE
);

958 
msg
.
ty³
 =ype;

959 
msg
.
¶’
 = 
Ën
;

960 if(
	`wr™e_w¿p
(
Ïme_fd
, &
msg
, 
NULL
, (msg)) == -1)

962 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send msg header");

967 if(
Ën
 !ğ0 && 
	`wr™e_w¿p
(
Ïme_fd
, 
·¿m
, 
NULL
,†en) == -1)

969 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send msg…aram");

974 
	}
}

982 
	$´iv£p_g‘fd
(
ušt16_t
 
ty³
, ušt16_ˆ
Ën
, cÚ¡ 
ušt8_t
 *
·¿m
)

984 if(
	`´iv£p_Ïme_£nd
(
ty³
, 
Ën
, 
·¿m
) == -1)

989  
	`´iv£p_»cv_fd
();

990 
	}
}

992 
	$´iv£p_dÙask
(
ušt16_t
 
ty³
, ušt16_ˆ
Ën
, cÚ¡ 
ušt8_t
 *
·¿m
)

994 
ušt8_t
 
buf
[()*2];

995 
”rÜ
;

996 
rc
;

998 if(
	`´iv£p_Ïme_£nd
(
ty³
, 
Ën
, 
·¿m
) == -1)

1001 if(
	`»ad_w¿p
(
Ïme_fd
, 
buf
, 
NULL
, (buf)) == -1)

1004 
	`memıy
(&
rc
, 
buf
, (rc));

1005 
	`memıy
(&
”rÜ
, 
buf
+(), (error));

1007 if(
rc
 != 0)

1008 
”ºo
 = 
”rÜ
;

1010  
rc
;

1011 
	}
}

1013 
	$´iv£p_g‘fd_1št
(cÚ¡ 
ušt16_t
 
ty³
, cÚ¡ 
p1
)

1015 
ušt8_t
 
·¿m
[(
p1
)];

1016 
	`memıy
(
·¿m
, &
p1
, (p1));

1017  
	`´iv£p_g‘fd
(
ty³
, (
·¿m
),…aram);

1018 
	}
}

1020 
	$´iv£p_g‘fd_3št
(cÚ¡ 
ušt16_t
 
ty³
,

1021 cÚ¡ 
p1
, cÚ¡ 
p2
, cÚ¡ 
p3
)

1023 
ušt8_t
 
·¿m
[(
p1
)+(
p2
)+(
p3
)];

1024 
size_t
 
off
 = 0;

1025 
	`memıy
(
·¿m
+
off
, &
p1
, (p1)); off += (p1);

1026 
	`memıy
(
·¿m
+
off
, &
p2
, (p2)); off += (p2);

1027 
	`memıy
(
·¿m
+
off
, &
p3
, (p3));

1028  
	`´iv£p_g‘fd
(
ty³
, (
·¿m
),…aram);

1029 
	}
}

1031 
	$sÿm³r_´iv£p_İ’_d©®šk
(cÚ¡ 
ifšdex
)

1033  
	`´iv£p_g‘fd_1št
(
SCAMPER_PRIVSEP_OPEN_DATALINK
, 
ifšdex
);

1034 
	}
}

1036 
	$sÿm³r_´iv£p_İ’_unix
(cÚ¡ *
fe
)

1038 
Ën
 = 
	`¡¾’
(
fe
) + 1;

1039  
	`´iv£p_g‘fd
(
SCAMPER_PRIVSEP_OPEN_UNIX
, 
Ën
, (cÚ¡ 
ušt8_t
 *)
fe
);

1040 
	}
}

1042 
	$sÿm³r_´iv£p_İ’_fe
(cÚ¡ *
fe
,

1043 cÚ¡ 
æags
, cÚ¡ 
mode_t
 
mode
)

1045 
ušt8_t
 *
·¿m
;

1046 
off
, 
Ën
, 
fd
;

1052 
Ën
 = (
æags
è+ 
	`¡¾’
(
fe
) + 1;

1053 if(
æags
 & 
O_CREAT
)

1054 
Ën
 +ğ(
mode
);

1060 if(
Ën
 > 65535)

1064 if((
·¿m
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1068 
	`memıy
(
·¿m
, &
æags
, (æags)); 
off
 = (flags);

1069 if(
æags
 & 
O_CREAT
)

1071 
	`memıy
(
·¿m
+
off
, &
mode
, (mode));

1072 
off
 +ğ(
mode
);

1076 
	`memıy
(
·¿m
+
off
, 
fe
, 
Ën
-off);

1079 
fd
 = 
	`´iv£p_g‘fd
(
SCAMPER_PRIVSEP_OPEN_FILE
, 
Ën
, 
·¿m
);

1080 
	`ä“
(
·¿m
);

1081  
fd
;

1082 
	}
}

1084 
	$sÿm³r_´iv£p_İ’_¹sock
()

1086  
	`´iv£p_g‘fd
(
SCAMPER_PRIVSEP_OPEN_RTSOCK
, 0, 
NULL
);

1087 
	}
}

1089 
	$sÿm³r_´iv£p_İ’_icmp
(cÚ¡ 
domaš
)

1091  
	`´iv£p_g‘fd_1št
(
SCAMPER_PRIVSEP_OPEN_ICMP
, 
domaš
);

1092 
	}
}

1094 
	$sÿm³r_´iv£p_İ’_div”t
(cÚ¡ 
pÜt
)

1096  
	`´iv£p_g‘fd_1št
(
SCAMPER_PRIVSEP_OPEN_DIVERT
, 
pÜt
);

1097 
	}
}

1099 
	$sÿm³r_´iv£p_İ’_tı
(cÚ¡ 
domaš
, cÚ¡ 
pÜt
)

1101  
	`´iv£p_g‘fd_3št
(
SCAMPER_PRIVSEP_OPEN_SOCK
,
domaš
,
IPPROTO_TCP
,
pÜt
);

1102 
	}
}

1104 
	$sÿm³r_´iv£p_İ’_udp
(cÚ¡ 
domaš
, cÚ¡ 
pÜt
)

1106  
	`´iv£p_g‘fd_3št
(
SCAMPER_PRIVSEP_OPEN_SOCK
,
domaš
,
IPPROTO_UDP
,
pÜt
);

1107 
	}
}

1109 
	$sÿm³r_´iv£p_İ’_¿wudp
(cÚ¡ *
addr
)

1111 
ušt8_t
 
·¿m
[4];

1113 if(
addr
 =ğ
NULL
)

1114 
	`mem£t
(
·¿m
, 0, 4);

1116 
	`memıy
(
·¿m
, 
addr
, 4);

1118  
	`´iv£p_g‘fd
(
SCAMPER_PRIVSEP_OPEN_RAWUDP
, (
·¿m
),…aram);

1119 
	}
}

1121 
	$sÿm³r_´iv£p_İ’_¿w
()

1123  
	`´iv£p_g‘fd
(
SCAMPER_PRIVSEP_OPEN_RAWIP
, 0, 
NULL
);

1124 
	}
}

1126 
	$sÿm³r_´iv£p_uÆšk
(cÚ¡ *
fe
)

1128 
Ën
 = 
	`¡¾’
(
fe
) + 1;

1129  
	`´iv£p_dÙask
(
SCAMPER_PRIVSEP_UNLINK
, 
Ën
, (cÚ¡ 
ušt8_t
 *)
fe
);

1130 
	}
}

1132 
	$sÿm³r_´iv£p_fw_š™
()

1134  
	`´iv£p_dÙask
(
SCAMPER_PRIVSEP_IPFW_INIT
, 0, 
NULL
);

1135 
	}
}

1137 
	$sÿm³r_´iv£p_fw_ş—nup
()

1139  
	`´iv£p_dÙask
(
SCAMPER_PRIVSEP_IPFW_CLEANUP
, 0, 
NULL
);

1140 
	}
}

1142 
	$sÿm³r_´iv£p_fw_add
(
n
,
af
,
p
,*
s
,*
d
,
¥
,
dp
)

1144 
ušt8_t
 
·¿m
[1 + (() * 5) + (16 * 2)];

1145 
ušt16_t
 
Ën
 = 0;

1146 
ušt16_t
 
®
;

1148 if(
d
 =ğ
NULL
)

1149 
·¿m
[0] = 0;

1151 
·¿m
[0] = 1;

1152 
Ën
++;

1154 if(
af
 =ğ
AF_INET
)

1155 
®
 = 4;

1156 if(
af
 =ğ
AF_INET6
)

1157 
®
 = 16;

1161 
	`memıy
(
·¿m
+
Ën
, &
af
, (af));†en += (af);

1162 
	`memıy
(
·¿m
+
Ën
, &
n
, (n));†en += (n);

1163 
	`memıy
(
·¿m
+
Ën
, &
p
, (p));†en += (p);

1164 
	`memıy
(
·¿m
+
Ën
, 
s
, 
®
);†en +=‡l;

1165 if(
d
 !ğ
NULL
)

1167 
	`memıy
(
·¿m
+
Ën
, 
d
, 
®
);

1168 
Ën
 +ğ
®
;

1170 
	`memıy
(
·¿m
+
Ën
, &
¥
, (sp));†en += (sp);

1171 
	`memıy
(
·¿m
+
Ën
, &
dp
, (dp));†en += (dp);

1173  
	`´iv£p_dÙask
(
SCAMPER_PRIVSEP_IPFW_ADD
, 
Ën
, 
·¿m
);

1174 
	}
}

1176 
	$sÿm³r_´iv£p_fw_d–
(
n
, 
af
)

1178 
ušt8_t
 
·¿m
[(() * 2)];

1179 
ušt16_t
 
Ën
 = 0;

1180 
	`memıy
(
·¿m
+
Ën
, &
n
, ());†en += (n);

1181 
	`memıy
(
·¿m
+
Ën
, &
af
, ());†en += (af);

1182  
	`´iv£p_dÙask
(
SCAMPER_PRIVSEP_IPFW_DEL
, 
Ën
, 
·¿m
);

1183 
	}
}

1192 
	$sÿm³r_´iv£p_š™
()

1194 
addršfo
 
hšts
, *
»s0
;

1195 
timev®
 
tv
;

1196 
·sswd
 *
pw
;

1197 
¡©
 
sb
;

1198 
mode_t
 
mode
;

1199 
uid_t
 
uid
;

1200 
gid_t
 
gid
;

1201 
sock‘s
[2];

1202 
pid_t
 
pid
;

1203 
»t
;

1204 
time_t
 
t
;

1207 if(
	`¡©
(
PRIVSEP_DIR
, &
sb
) == -1)

1210 if(
”ºo
 =ğ
ENOENT
)

1216 if((
pw
 = 
	`g‘pwÇm
(
PRIVSEP_DIR_USER
)è=ğ
NULL
)

1218 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1219 "could‚Ù g‘pwÇm " 
PRIVSEP_DIR_USER
);

1220 
	`’dpw’t
();

1223 
uid
 = 
pw
->
pw_uid
;

1224 
	`’dpw’t
();

1226 
gid
 = 0;

1229 
mode
 = 
S_IRUSR
 | 
S_IXUSR
 | 
S_IRGRP
 | 
S_IXGRP
 | 
S_IROTH
 | 
S_IXOTH
;

1230 if(
	`mkdœ
(
PRIVSEP_DIR
, 
mode
) == -1)

1232 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1233 "could‚Ù mkdœ " 
PRIVSEP_DIR
);

1238 if(
	`chown
(
PRIVSEP_DIR
, 
uid
, 
gid
) == -1)

1240 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1241 "could‚Ù chowÀ" 
PRIVSEP_DIR
);

1242 
	`rmdœ
(
PRIVSEP_DIR
);

1248 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù sˆ" 
PRIVSEP_DIR
);

1257 if(
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
sock‘s
) == -1)

1259 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot socketpair");

1263 
Ïme_fd
 = 
sock‘s
[0];

1264 
roÙ_fd
 = 
sock‘s
[1];

1266 if((
pid
 = 
	`fÜk
()) == -1)

1268 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot fork");

1271 if(
pid
 == 0)

1277 
»t
 = 
	`´iv£p_do
();

1278 
	`ex™
(
»t
);

1282 
roÙ_pid
 = 
pid
;

1288 
	`şo£
(
roÙ_fd
);

1289 
roÙ_fd
 = -1;

1295 if((
pw
 = 
	`g‘pwÇm
(
PRIVSEP_USER
)è=ğ
NULL
)

1297 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1298 "could‚Ù g‘pwÇm " 
PRIVSEP_USER
);

1301 
uid
 = 
pw
->
pw_uid
;

1302 
gid
 = 
pw
->
pw_gid
;

1303 
	`mem£t
(
pw
->
pw_·sswd
, 0, 
	`¡¾’
(pw->pw_passwd));

1304 
	`’dpw’t
();

1311 
	`g‘timeofday_w¿p
(&
tv
);

1312 
t
 = 
tv
.
tv_£c
;

1313 
	`loÿÉime
(&
t
);

1320 
	`mem£t
(&
hšts
, 0, (
addršfo
));

1321 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

1322 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

1323 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_UDP
;

1324 
hšts
.
ai_çmy
 = 
AF_INET
;

1325 
	`g‘addršfo
("127.0.0.1", 
NULL
, &
hšts
, &
»s0
);

1326 
	`ä“addršfo
(
»s0
);

1329 #iâdeà
NDEBUG


1330 if(
	`chroÙ
(
PRIVSEP_DIR
) == -1)

1332 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1333 "could‚Ù chroÙØ" 
PRIVSEP_DIR
);

1338 if(
	`chdœ
("/") == -1)

1340 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot chdir /");

1346 if(
	`£tgroups
(1, &
gid
) == -1)

1348 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot setgroups");

1351 if(
	`£tgid
(
gid
) == -1)

1353 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot setgid");

1358 if(
	`£tuid
(
uid
) == -1)

1360 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot setuid");

1364  
Ïme_fd
;

1365 
	}
}

1367 
	$sÿm³r_´iv£p_ş—nup
()

1369 
´iv£p_msg_t
 
msg
;

1371 if(
roÙ_pid
 != -1)

1373 
msg
.
¶’
 = 0;

1374 
msg
.
ty³
 = 
SCAMPER_PRIVSEP_EXIT
;

1376 
	`wr™e_w¿p
(
Ïme_fd
, (
ušt8_t
 *)&
msg
, 
NULL
, (msg));

1377 
roÙ_pid
 = -1;

1380 if(
Ïme_fd
 != -1)

1382 
	`şo£
(
Ïme_fd
);

1383 
Ïme_fd
 = -1;

1387 
	}
}

	@scamper_privsep.h

25 #iâdeà
__SCAMPER_PRIVSEP_H


26 
	#__SCAMPER_PRIVSEP_H


	)

28 #iâdeà
WITHOUT_PRIVSEP


30 
sÿm³r_´iv£p_İ’_d©®šk
(cÚ¡ 
ifšdex
);

32 
sÿm³r_´iv£p_İ’_fe
(cÚ¡ *
fe
,

33 cÚ¡ 
æags
, cÚ¡ 
mode_t
 
mode
);

35 
sÿm³r_´iv£p_İ’_¹sock
();

37 
sÿm³r_´iv£p_İ’_div”t
(cÚ¡ 
pÜt
);

39 
sÿm³r_´iv£p_İ’_icmp
(cÚ¡ 
domaš
);

40 
sÿm³r_´iv£p_İ’_udp
(cÚ¡ 
domaš
, cÚ¡ 
pÜt
);

41 
sÿm³r_´iv£p_İ’_tı
(cÚ¡ 
domaš
, cÚ¡ 
pÜt
);

42 
sÿm³r_´iv£p_İ’_¿wudp
(cÚ¡ *
addr
);

43 
sÿm³r_´iv£p_İ’_¿w
();

44 
sÿm³r_´iv£p_İ’_unix
(cÚ¡ *
fe
);

46 
sÿm³r_´iv£p_fw_š™
();

47 
sÿm³r_´iv£p_fw_ş—nup
();

48 
sÿm³r_´iv£p_fw_add
(
n
,
af
,
p
,*
s
,*
d
,
¥
,
dp
);

49 
sÿm³r_´iv£p_fw_d–
(
n
,
af
);

51 
sÿm³r_´iv£p_uÆšk
(cÚ¡ *
fe
);

53 
sÿm³r_´iv£p_š™
();

54 
sÿm³r_´iv£p_ş—nup
();

	@scamper_probe.c

27 #iâdeà
lšt


28 cÚ¡ 
	grcsid
[] =

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

35 
	~"š‹º®.h
"

37 
	~"sÿm³r.h
"

38 
	~"sÿm³r_addr.h
"

39 
	~"sÿm³r_dl.h
"

40 
	~"sÿm³r_fds.h
"

41 
	~"sÿm³r_¹sock.h
"

42 
	~"sÿm³r_sk.h
"

43 
	~"sÿm³r_´obe.h
"

44 
	~"sÿm³r_udp4.h
"

45 
	~"sÿm³r_udp6.h
"

46 
	~"sÿm³r_icmp4.h
"

47 
	~"sÿm³r_icmp6.h
"

48 
	~"sÿm³r_tı4.h
"

49 
	~"sÿm³r_tı6.h
"

50 
	~"sÿm³r_4.h
"

51 
	~"sÿm³r_6.h
"

52 
	~"sÿm³r_dl.h
"

53 
	~"sÿm³r_dlhdr.h
"

54 
	~"sÿm³r_osšfo.h
"

55 
	~"sÿm³r_debug.h
"

56 
	~"uts.h
"

66 
	s´obe_¡©e


68 
sÿm³r_´obe_t
 *
	m´
;

69 
sÿm³r_sk_t
 *
	msk
;

70 
sÿm³r_sk_ªc_t
 *
	mªc
;

71 
sÿm³r_fd_t
 *
	m¹sock
;

72 
sÿm³r_rou‹_t
 *
	m¹
;

73 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

74 
ušt8_t
 *
	mbuf
;

75 
size_t
 
	mËn
;

76 
timev®
 
	mtv
;

77 
	mmode
;

78 
	m”rÜ
;

79 } 
	t´obe_¡©e_t
;

81 
	#PROBE_MODE_RT
 1

	)

82 
	#PROBE_MODE_DL
 2

	)

83 
	#PROBE_MODE_TX
 3

	)

84 
	#PROBE_MODE_ERR
 4

	)

91 
	#PAD
(
s
è(( > 0è? (1 + (( - 1è| ((è- 1)è- sè: 0)

	)

93 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

94 
size_t
 
	gpktbuf_Ën
 = 0;

95 
	gid_dl
 = 0;

96 
	g¿wtı
 = 0;

98 #ifdeà
HAVE_SCAMPER_DEBUG


99 *
	$tı_æags
(*
buf
, 
size_t
 
Ën
, 
sÿm³r_´obe_t
 *
´obe
)

101 
ušt8_t
 
æags
 = 
´obe
->
´_tı_æags
;

102 
ušt8_t
 
æag
;

103 
size_t
 
off
;

104 
i
;

106 
buf
[0] = '\0';

107 if(
´obe
->
´_Ën
 != 0)

108 
æags
 &ğ~(
TH_ACK
);

110 
off
 = 0;

111 
i
=0; i<8 && 
æags
 != 0; i++)

113 
æag
 = 1 << 
i
;

115 if((
æags
 & 
æag
) == 0)

117 
æags
 &ğ~
æag
;

119 
æag
)

121 
TH_SYN
:

122 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " syn");

125 
TH_RST
:

126 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "„st");

129 
TH_FIN
:

130 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " fin");

133 
TH_ACK
:

134 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "‡ck");

137 
TH_PUSH
:

138 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "…sh");

141 
TH_URG
:

142 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " urg");

145 
TH_ECE
:

146 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "ƒce");

149 
TH_CWR
:

150 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " cwr");

155  
buf
;

156 
	}
}

158 *
	$tı_pos
(*
buf
, 
size_t
 
Ën
, 
sÿm³r_´obe_t
 *
´obe
)

160 
size_t
 
off
 = 0;

161 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "%u", 
´obe
->
´_tı_£q
);

162 if(
´obe
->
´_tı_æags
 & 
TH_ACK
)

163 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, ":%u", 
´obe
->
´_tı_ack
);

164  
buf
;

165 
	}
}

167 
	$´obe_´št
(
sÿm³r_´obe_t
 *
´obe
)

169 
size_t
 
hl
;

170 
tı
[16];

171 
pos
[32];

172 
addr
[128];

173 
icmp
[16];

174 
tos
[8];

176 
	`as£¹
(
´obe
->
´__d¡
 !ğ
NULL
);

178 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr));

180 
tos
[0] = '\0';

181 
icmp
[0] = '\0';

183 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

185 if((
´obe
->
´__tos
 & 
IPTOS_ECN_CE
) == IPTOS_ECN_CE)

186 
	`¢´štf
(
tos
, (tos), ", ce");

187 if(
´obe
->
´__tos
 & 
IPTOS_ECN_ECT1
)

188 
	`¢´štf
(
tos
, (tos), ",ƒct1");

189 if(
´obe
->
´__tos
 & 
IPTOS_ECN_ECT0
)

190 
	`¢´štf
(
tos
, (tos), ",ƒct0");

193 if(
´obe
->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

195 if(
	`sÿm³r_4_hËn
(
´obe
, &
hl
) != 0)

198 if((
´obe
->
´__off
 & 
IP_OFFMASK
è!ğ0 ||…robe->
´_no_Œªs
)

200 
	`sÿm³r_debug
("tx", "frag %s %04x:%dtl %d,†en %d",

201 
addr
, 
´obe
->
´__id
,…robe->
´__off
 << 3,

202 
´obe
->
´__‰l
, 
hl
 +…robe->
´_Ën
);

206 
´obe
->
´__´Ùo
)

208 
IPPROTO_UDP
:

209 
	`sÿm³r_debug
("tx", "udp %s,tl %d, %d:%d,†en %d",

210 
addr
, 
´obe
->
´__‰l
,…robe->
´_udp_¥Üt
,

211 
´obe
->
´_udp_dpÜt
, 
hl
 + 8 +…robe->
´_Ën
);

214 
IPPROTO_TCP
:

215 
	`sÿm³r_debug
("tx",

217 
addr
, 
tos
, 
´obe
->
´__‰l
,

218 
´obe
->
´_tı_¥Üt
,…robe->
´_tı_dpÜt
,

219 
	`tı_æags
(
tı
, Ñı), 
´obe
),

220 
´obe
->
´__id
, 
	`tı_pos
(
pos
, (pos),…robe),

221 
hl
 + 
	`sÿm³r_tı4_hËn
(
´obe
è+…robe->
´_Ën
);

224 
IPPROTO_ICMP
:

225 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP_ECHO
)

227 if(
´obe
->
´_icmp_sum
 != 0)

229 
	`¢´štf
(
icmp
, (icmp), ", sum %04x",

230 
	`Áohs
(
´obe
->
´_icmp_sum
));

232 
	`sÿm³r_debug
("tx", "icmp %sƒcho,tl %d%s, seq %d,†en %d",

233 
addr
, 
´obe
->
´__‰l
, 
icmp
,…robe->
´_icmp_£q
,

234 
hl
 + 8 + 
´obe
->
´_Ën
);

236 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP_UNREACH
)

238 if(
´obe
->
´_icmp_code
 =ğ
ICMP_UNREACH_NEEDFRAG
)

239 
	`¢´štf
(
icmp
,(icmp),"±b %d", 
´obe
->
´_icmp_mtu
);

241 
	`¢´štf
(
icmp
,(icmp),"uÄ—ch %d", 
´obe
->
´_icmp_code
);

242 
	`sÿm³r_debug
("tx", "icmp %s %s,†en %d",

243 
addr
, 
icmp
, 
hl
 + 8 + 
´obe
->
´_Ën
);

245 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP_TSTAMP
)

247 
	`sÿm³r_debug
("tx", "icmp %ss,tl %d, seq %d,†en %d",

248 
addr
, 
´obe
->
´__‰l
,…robe->
´_icmp_£q
,

249 
hl
 + 20);

253 
	`sÿm³r_debug
("tx", "icmp %sype %d, code %d,†en %d",

254 
addr
, 
´obe
->
´_icmp_ty³
,…robe->
´_icmp_code
,

255 
hl
 + 8 + 
´obe
->
´_Ën
);

260 if(
´obe
->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

262 if(
	`sÿm³r_6_hËn
(
´obe
, &
hl
) != 0)

265 if(
´obe
->
´__off
 !ğ0 ||…robe->
´_no_Œªs
)

267 
	`sÿm³r_debug
("tx", "frag %s off %04x,tl %d,†en %d",

268 
addr
, 
´obe
->
´__off
,…robe->
´__‰l
,

269 
hl
 + 
´obe
->
´_Ën
);

273 
´obe
->
´__´Ùo
)

275 
IPPROTO_UDP
:

276 
	`sÿm³r_debug
("tx", "udp %s,tl %d, %d:%d,†en %d",

277 
addr
, 
´obe
->
´__‰l
,…robe->
´_udp_¥Üt
,

278 
´obe
->
´_udp_dpÜt
, 
hl
 + 8 +…robe->
´_Ën
);

281 
IPPROTO_TCP
:

282 
	`sÿm³r_debug
("tx", "tcp %s%s,tl %d, %d:%d%s, %s,†en %d",

283 
addr
, 
tos
, 
´obe
->
´__‰l
,

284 
´obe
->
´_tı_¥Üt
,…robe->
´_tı_dpÜt
,

285 
	`tı_æags
(
tı
, Ñı), 
´obe
),

286 
	`tı_pos
(
pos
, Õos), 
´obe
),

287 
hl
 + 
	`sÿm³r_tı6_hËn
(
´obe
è+…robe->
´_Ën
);

290 
IPPROTO_ICMPV6
:

291 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP6_ECHO_REQUEST
)

293 if(
´obe
->
´_icmp_sum
 != 0)

295 
	`¢´štf
(
icmp
, (icmp), ", sum %04x",

296 
	`Áohs
(
´obe
->
´_icmp_sum
));

298 
	`sÿm³r_debug
("tx", "icmp %sƒcho,tl %d%s, seq %d,†en %d",

299 
addr
, 
´obe
->
´__‰l
, 
icmp
,…robe->
´_icmp_£q
,

300 
hl
 + 8 + 
´obe
->
´_Ën
);

302 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP6_PACKET_TOO_BIG
)

304 
	`sÿm³r_debug
("tx", "icm°% ±b %d,†’ %d", 
addr
,

305 
´obe
->
´_icmp_mtu
, 
hl
 + 8 +…robe->
´_Ën
);

307 if(
´obe
->
´_icmp_ty³
 =ğ
ICMP6_DST_UNREACH
)

309 
	`sÿm³r_debug
("tx", "icm°% uÄ—ch %d,†’ %d", 
addr
,

310 
´obe
->
´_icmp_code
, 
hl
 + 8 +…robe->
´_Ën
);

314 
	`sÿm³r_debug
("tx", "icmp %sype %d, code %d,†en %d",

315 
addr
, 
´obe
->
´_icmp_ty³
,…robe->
´_icmp_code
,

316 
hl
 + 8 + 
´obe
->
´_Ën
);

323 
	}
}

325 
	#´obe_´št
(
´obe
è(()0)

	)

328 
	$´obe_ä“
(
sÿm³r_´obe_t
 *
´
)

330 if(
´
 =ğ
NULL
) ;

331 if(
´
->
´__d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pr->pr_ip_dst);

332 if(
´
->
´__¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(pr->pr_ip_src);

333 if(
´
->
´_İts
 !ğ
NULL
è
	`ä“
(pr->pr_ipopts);

334 if(
´
->
´_d©a
 !ğ
NULL
è
	`ä“
(pr->pr_data);

335 
	`ä“
(
´
);

337 
	}
}

339 
sÿm³r_´obe_t
 *
	$´obe_dup
(
sÿm³r_´obe_t
 *
´
)

341 
sÿm³r_´obe_t
 *
pd
 = 
NULL
;

342 
size_t
 
Ën
;

344 if((
pd
 = 
	`memdup
(
´
, (
sÿm³r_´obe_t
))è=ğ
NULL
)

345 
”r
;

347 
pd
->
´_dl
 = 
NULL
;

348 
pd
->
´_dl_buf
 = 
NULL
;

349 
pd
->
´_dl_Ën
 = 0;

350 
pd
->
´_İts
 = 
NULL
;

351 
pd
->
´_d©a
 = 
NULL
;

352 if(
´
->
´__¤c
 !ğ
NULL
)

353 
pd
->
´__¤c
 = 
	`sÿm³r_addr_u£
(
´
->pr_ip_src);

354 if(
´
->
´__d¡
 !ğ
NULL
)

355 
pd
->
´__d¡
 = 
	`sÿm³r_addr_u£
(
´
->pr_ip_dst);

357 if(
´
->
´_İtc
 > 0)

359 
Ën
 = 
´
->
´_İtc
 * (
sÿm³r_´obe_İt_t
);

360 if((
pd
->
´_İts
 = 
	`memdup
(
´
->´_İts, 
Ën
)è=ğ
NULL
)

361 
”r
;

364 if(
´
->
´_Ën
 > 0)

366 if((
pd
->
´_d©a
 = 
	`memdup
(
´
->´_d©a,…r->
´_Ën
)è=ğ
NULL
)

367 
”r
;

370  
pd
;

372 
”r
:

373 
	`´obe_ä“
(
pd
);

374  
NULL
;

375 
	}
}

377 
	$´obe_¡©e_ä“_cb
(*
v±
)

379 
´obe_¡©e_t
 *
±
 = 
v±
;

380 if(
±
 =ğ
NULL
)

382 if(
±
->
´
 !ğ
NULL
)

383 
	`´obe_ä“
(
±
->
´
);

384 if(
±
->
buf
 !ğ
NULL
 &&…t->buà!ğ
pktbuf
)

385 
	`ä“
(
±
->
buf
);

386 if(
±
->
¹
 !ğ
NULL
)

387 
	`sÿm³r_rou‹_ä“
(
±
->
¹
);

388 if(
±
->
dlhdr
 !ğ
NULL
)

389 
	`sÿm³r_dlhdr_ä“
(
±
->
dlhdr
);

390 
	`ä“
(
±
);

392 
	}
}

394 
	$´obe_¡©e_ä“
(
´obe_¡©e_t
 *
±
)

396 if(
±
 =ğ
NULL
)

398 if(
±
->
ªc
 !ğ
NULL
)

399 
	`sÿm³r_sk_ªc_d–
(
±
->
sk
,…t->
ªc
);

400 
	`´obe_¡©e_ä“_cb
(
±
);

402 
	}
}

410 
´obe_¡©e_t
 *
	$´obe_¡©e_®loc
(
sÿm³r_´obe_t
 *
´
)

412 (*
bud_func
)(
sÿm³r_´obe_t
 *, 
ušt8_t
 *, 
size_t
 *èğ
NULL
;

413 
´obe_¡©e_t
 *
±
 = 
NULL
;

414 
size_t
 
Ën
;

416 if((
±
 = 
	`m®loc_z”o
((
´obe_¡©e_t
))è=ğ
NULL
)

418 
´
->
´_”ºo
 = 
”ºo
;

419 
”r
;

422 if(
¿wtı
 !ğ0 && 
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
 &&

423 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´
->
´__d¡
))

425 if((
±
->
´
 = 
	`´obe_dup
Õr)è=ğ
NULL
)

427 
´
->
´_”ºo
 = 
”ºo
;

428 
”r
;

430  
±
;

433 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´
->
´__d¡
))

435 if((
´
->
´__off
 & 
IP_OFFMASK
è!ğ0 ||…r->
´_no_Œªs
)

436 
bud_func
 = 
sÿm³r_4_äag_bud
;

437 if(
´
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

438 
bud_func
 = 
sÿm³r_udp4_bud
;

439 if(
´
->
´__´Ùo
 =ğ
IPPROTO_ICMP
)

440 
bud_func
 = 
sÿm³r_icmp4_bud
;

441 if(
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

442 
bud_func
 = 
sÿm³r_tı4_bud
;

444 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
´
->
´__d¡
))

446 if(
´
->
´__off
 !ğ0 ||…r->
´_no_Œªs
)

447 
bud_func
 = 
sÿm³r_6_äag_bud
;

448 if(
´
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

449 
bud_func
 = 
sÿm³r_udp6_bud
;

450 if(
´
->
´__´Ùo
 =ğ
IPPROTO_ICMPV6
)

451 
bud_func
 = 
sÿm³r_icmp6_bud
;

452 if(
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

453 
bud_func
 = 
sÿm³r_tı6_bud
;

456 if(
bud_func
 =ğ
NULL
)

458 
´
->
´_”ºo
 = 
EINVAL
;

459 
”r
;

463 if(16 >ğ
pktbuf_Ën
)

464 
Ën
 = 0;

466 
Ën
 = 
pktbuf_Ën
-16;

468 if(
	`bud_func
(
´
, 
pktbuf
+16, &
Ën
) != 0)

471 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
Ën
+16) != 0)

473 
´
->
´_”ºo
 = 
”ºo
;

474 
”r
;

476 
pktbuf_Ën
 = 
Ën
+16;

477 if(
	`bud_func
(
´
, 
pktbuf
+16, &
Ën
) != 0)

479 
´
->
´_”ºo
 = 
EINVAL
;

480 
”r
;

484 
±
->
buf
 = 
pktbuf
;

485 
±
->
Ën
 =†en;

486  
±
;

488 
”r
:

489 if(
±
 !ğ
NULL
è
	`´obe_¡©e_ä“
(pt);

490  
NULL
;

491 
	}
}

493 
	$´obe_dlhdr_cb
(
sÿm³r_dlhdr_t
 *
dlhdr
)

495 
´obe_¡©e_t
 *
´
 = 
dlhdr
->
·¿m
;

496 
sÿm³r_fd_t
 *
fd
 = 
NULL
;

497 
sÿm³r_dl_t
 *
dl
 = 
NULL
;

498 
ušt8_t
 *
pkt
;

500 if(
dlhdr
->
”rÜ
 != 0)

502 
´
->
”rÜ
 = 
dlhdr
->error;

503 
”r
;

506 
	`as£¹
(
dlhdr
->
Ën
 < 16);

507 
pkt
 = 
´
->
buf
+16-
dlhdr
->
Ën
;

508 if(
dlhdr
->
Ën
 > 0)

509 
	`memıy
(
pkt
, 
dlhdr
->
buf
, dlhdr->
Ën
);

511 if((
fd
 = 
	`sÿm³r_sk_fd_dl
(
´
->
sk
,…r->
¹
->
ifšdex
)è=ğ
NULL
)

513 
´
->
”rÜ
 = 
EINVAL
;

514 
”r
;

517 if(
´
->
buf
 =ğ
pktbuf
)

518 
	`g‘timeofday_w¿p
(&
´
->
tv
);

519 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
fd
);

520 if(
	`sÿm³r_dl_tx
(
dl
, 
pkt
, 
dlhdr
->
Ën
 + 
´
->len) == -1)

522 
´
->
”rÜ
 = 
”ºo
;

523 
”r
;

525 
´
->
mode
 = 
PROBE_MODE_TX
;

526 
dÚe
;

528 
”r
:

529 
´
->
mode
 = 
PROBE_MODE_ERR
;

531 
dÚe
:

532 if(
´
->
ªc
 !ğ
NULL
)

533 
	`´obe_¡©e_ä“
(
´
);

535 
	}
}

537 
	$´obe_rou‹_cb
(
sÿm³r_rou‹_t
 *
¹
)

539 
sÿm³r_fd_t
 *
fd
 = 
NULL
;

540 
sÿm³r_dl_t
 *
dl
 = 
NULL
;

541 
´obe_¡©e_t
 *
´
 = 
¹
->
·¿m
;

543 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

545 
´
->
”rÜ
 = 
¹
->error;

546 
”r
;

548 if((
fd
 = 
	`sÿm³r_sk_fd_dl
(
´
->
sk
, 
¹
->
ifšdex
)è=ğ
NULL
)

550 
´
->
”rÜ
 = 
”ºo
;

551 
”r
;

554 if(
¿wtı
 !ğ0 && 
´
->´->
´__´Ùo
 =ğ
IPPROTO_TCP
 &&

555 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´
->´->
´__d¡
))

557 if((
fd
 = 
	`sÿm³r_sk_fd_4
(
´
->
sk
)è!ğ
NULL
)

559 
´
->´->
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
fd
);

560 if(
	`sÿm³r_tı4_´obe
(
´
->pr) != 0)

561 
´
->
mode
 = 
PROBE_MODE_ERR
;

563 if(
´
->
ªc
 !ğ
NULL
)

564 
	`´obe_¡©e_ä“
(
´
);

568 if((
´
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

570 
´
->
”rÜ
 = 
”ºo
;

571 
”r
;

573 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
fd
);

575 
´
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
¹
->dst);

576 
´
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

577 
´
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

578 
´
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

579 
´
->
dlhdr
->
·¿m
 =…r;

580 
´
->
dlhdr
->
cb
 = 
´obe_dlhdr_cb
;

581 
´
->
mode
 = 
PROBE_MODE_DL
;

582 if(
	`sÿm³r_dlhdr_g‘
(
´
->
dlhdr
) != 0)

584 
´
->
”rÜ
 =…r->
dlhdr
->error;

585 
”r
;

590 
”r
:

591 
´
->
mode
 = 
PROBE_MODE_ERR
;

592 if(
´
->
ªc
 !ğ
NULL
)

593 
	`´obe_¡©e_ä“
(
´
);

595 
	}
}

597 
	$sÿm³r_´obe_sk
(
sÿm³r_´obe_t
 *
´
, 
sÿm³r_sk_t
 *
sk
)

599 
´obe_¡©e_t
 *
±
 = 
NULL
;

600 
sÿm³r_fd_t
 *
icmp
 = 
NULL
;

601 
sÿm³r_fd_t
 *
fd
;

602 
¥oof
 = 0;

603 
ušt16_t
 
¥
;

604 *
¤c
 = 
NULL
;

605 
dl
 = 0;

607 
	`´obe_´št
(
´
);

609 if((
´
->
´_æags
 & 
SCAMPER_PROBE_FLAG_SPOOF
) != 0)

610 
¥oof
 = 1;

613 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´
->
´__d¡
))

615 if(
¥oof
 == 0)

617 
¤c
 = 
´
->
´__¤c
->
addr
;

618 if((
icmp
 = 
	`sÿm³r_sk_fd_icmp4
(
sk
, 
¤c
)è=ğ
NULL
)

620 
´
->
´_”ºo
 = 
”ºo
;

621 
”r
;

625 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
´
->
´__d¡
))

627 if(
¥oof
 == 0)

629 
¤c
 = 
´
->
´__¤c
->
addr
;

630 if((
icmp
 = 
	`sÿm³r_sk_fd_icmp6
(
sk
, 
¤c
)è=ğ
NULL
)

632 
´
->
´_”ºo
 = 
”ºo
;

633 
”r
;

639 
	`sÿm³r_debug
(
__func__
, "missing destination‡ddress");

640 
´
->
´_”ºo
 = 
EINVAL
;

641 
”r
;

650 if(
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
 ||

651 (
id_dl
 !ğ0 && 
	`SCAMPER_PROBE_IS_IPID
(
´
)) ||

652 (
´
->
´_æags
 & 
SCAMPER_PROBE_FLAG_NOFRAG
) != 0 ||

653 
¥oof
 != 0 ||

654 (
´
->
´_æags
 & 
SCAMPER_PROBE_FLAG_DL
) != 0)

655 
dl
 = 1;

657 if(
dl
 != 0)

659 if((
±
 = 
	`´obe_¡©e_®loc
(
´
)è=ğ
NULL
)

661 
´
->
´_”ºo
 = 
”ºo
;

662 
”r
;

664 
±
->
sk
 =ask;

665 
±
->
mode
 = 
PROBE_MODE_RT
;

666 
±
->
¹
 = 
	`sÿm³r_rou‹_®loc
(
´
->
´__d¡
,…t, 
´obe_rou‹_cb
);

667 if(
±
->
¹
 =ğ
NULL
)

669 
´
->
´_”ºo
 = 
”ºo
;

670 
”r
;

673 #iâdeà
_WIN32


674 if((
±
->
¹sock
 = 
	`sÿm³r_sk_fd_¹sock
(
sk
)è=ğ
NULL
)

676 
´
->
´_”ºo
 = 
”ºo
;

677 
”r
;

679 if(
	`sÿm³r_¹sock_g‘rou‹
(
±
->
¹sock
,…t->
¹
) != 0)

681 
´
->
´_”ºo
 = 
”ºo
;

682 
”r
;

685 if(
	`sÿm³r_¹sock_g‘rou‹
(
±
->
¹
) != 0)

687 
´
->
´_”ºo
 = 
”ºo
;

688 
”r
;

692 if(
±
->
mode
 =ğ
PROBE_MODE_ERR
)

694 
´
->
´_”ºo
 = 
±
->
”rÜ
;

695 
”r
;

698 if(
±
->
mode
 !ğ
PROBE_MODE_TX
)

700 if(
±
->
Ën
 > 0 && (±->
buf
 = 
	`memdup
(
pktbuf
,…t->ËÀ+ 16)è=ğ
NULL
)

702 
´
->
´_”ºo
 = 
”ºo
;

703 
”r
;

706 
±
->
ªc
 = 
	`sÿm³r_sk_ªc_add
(
sk
,…t, 
´obe_¡©e_ä“_cb
);

707 if(
±
->
ªc
 =ğ
NULL
)

709 
´
->
´_”ºo
 = 
”ºo
;

710 
”r
;

712 
	`g‘timeofday_w¿p
(&
´
->
´_tx
);

716 
	`timev®_ıy
(&
´
->
´_tx
, &
±
->
tv
);

717 
	`´obe_¡©e_ä“
(
±
);

721 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
´
->
´__d¡
))

723 if(
´
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

725 
¥
 = 
´
->
´_udp_¥Üt
;

726 if((
fd
 = 
	`sÿm³r_sk_fd_udp4
(
sk
, 
¤c
, 
¥
)è=ğ
NULL
)

728 
´
->
´_”ºo
 = 
”ºo
;

729 
”r
;

731 
´
->
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
fd
);

732 if(
	`sÿm³r_udp4_´obe
(
´
) != 0)

734 
´
->
´_”ºo
 = 
”ºo
;

735 
”r
;

738 if(
´
->
´__´Ùo
 =ğ
IPPROTO_ICMP
)

740 
´
->
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
icmp
);

741 if(
	`sÿm³r_icmp4_´obe
(
´
) != 0)

743 
´
->
´_”ºo
 = 
”ºo
;

744 
”r
;

749 
	`sÿm³r_debug
(
__func__
, "unhªdËd…rÙocŞ %d", 
´
->
´__´Ùo
);

750 
´
->
´_”ºo
 = 
EINVAL
;

751 
”r
;

754 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
´
->
´__d¡
))

756 if(
´
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

758 
¥
 = 
´
->
´_udp_¥Üt
;

759 if((
fd
 = 
	`sÿm³r_sk_fd_udp6
(
sk
, 
¤c
, 
¥
)è=ğ
NULL
)

761 
´
->
´_”ºo
 = 
”ºo
;

762 
”r
;

764 
´
->
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
fd
);

765 if(
	`sÿm³r_udp6_´obe
(
´
) != 0)

767 
´
->
´_”ºo
 = 
”ºo
;

768 
”r
;

771 if(
´
->
´__´Ùo
 =ğ
IPPROTO_ICMPV6
)

773 
´
->
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
icmp
);

774 if(
	`sÿm³r_icmp6_´obe
(
´
) != 0)

776 
´
->
´_”ºo
 = 
”ºo
;

777 
”r
;

782 
´
->
´_”ºo
 = 
EINVAL
;

783 
”r
;

788 
´
->
´_”ºo
 = 
EINVAL
;

789 
”r
;

794 
”r
:

795 
	`´š‹¼Ü
(
´
->
´_”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…robe");

796 if(
±
 !ğ
NULL
)

797 
	`´obe_¡©e_ä“
(
±
);

799 
	}
}

809 
	$sÿm³r_´obe
(
sÿm³r_´obe_t
 *
´obe
)

811 (*
£nd_func
)(
sÿm³r_´obe_t
 *èğ
NULL
;

812 (*
bud_func
)(
sÿm³r_´obe_t
 *, 
ušt8_t
 *, 
size_t
 *èğ
NULL
;

813 
size_t
 
·d
, 
Ën
;

814 
ušt8_t
 *
buf
;

816 
´obe
->
´_”ºo
 = 0;

817 
	`´obe_´št
(
´obe
);

820 if(
´obe
->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

822 if((
´obe
->
´__off
 & 
IP_OFFMASK
è!ğ0 ||…robe->
´_no_Œªs
)

824 
bud_func
 = 
sÿm³r_4_äag_bud
;

826 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

828 
£nd_func
 = 
sÿm³r_udp4_´obe
;

829 
bud_func
 = 
sÿm³r_udp4_bud
;

831 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

833 
bud_func
 = 
sÿm³r_tı4_bud
;

834 if(
´obe
->
´_fd
 != -1)

835 
£nd_func
 = 
sÿm³r_tı4_´obe
;

837 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_ICMP
)

839 
£nd_func
 = 
sÿm³r_icmp4_´obe
;

840 
bud_func
 = 
sÿm³r_icmp4_bud
;

843 if(
´obe
->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

845 if(
´obe
->
´__off
 !ğ0 ||…robe->
´_no_Œªs
)

847 
bud_func
 = 
sÿm³r_6_äag_bud
;

849 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_UDP
)

851 
£nd_func
 = 
sÿm³r_udp6_´obe
;

852 
bud_func
 = 
sÿm³r_udp6_bud
;

854 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_TCP
)

856 
bud_func
 = 
sÿm³r_tı6_bud
;

858 if(
´obe
->
´__´Ùo
 =ğ
IPPROTO_ICMPV6
)

860 
£nd_func
 = 
sÿm³r_icmp6_´obe
;

861 
bud_func
 = 
sÿm³r_icmp6_bud
;

866 if(
´obe
->
´_dl
 =ğ
NULL
)

868 if(
£nd_func
 !ğ
NULL
)

869  
	`£nd_func
(
´obe
);

870 
´obe
->
´_”ºo
 = 
EINVAL
;

875 if(
bud_func
 =ğ
NULL
)

877 
´obe
->
´_”ºo
 = 
EINVAL
;

887 
·d
 = 
	`PAD
(
´obe
->
´_dl_Ën
);

888 if(
·d
 + 
´obe
->
´_dl_Ën
 >ğ
pktbuf_Ën
)

889 
Ën
 = 0;

891 
Ën
 = 
pktbuf_Ën
 - 
·d
 - 
´obe
->
´_dl_Ën
;

897 if(
	`bud_func
(
´obe
, 
pktbuf
 + 
·d
 +…robe->
´_dl_Ën
, &
Ën
) != 0)

899 
	`as£¹
(
pktbuf_Ën
 < 
·d
 + 
´obe
->
´_dl_Ën
 + 
Ën
);

902 
Ën
 +ğ
·d
 + 
´obe
->
´_dl_Ën
;

903 if((
buf
 = 
	`»®loc
(
pktbuf
, 
Ën
)è=ğ
NULL
)

905 
´obe
->
´_”ºo
 = 
”ºo
;

906 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

909 
pktbuf
 = 
buf
;

910 
pktbuf_Ën
 = 
Ën
;

912 
Ën
 = 
pktbuf_Ën
 - 
·d
 - 
´obe
->
´_dl_Ën
;

913 if(
	`bud_func
(
´obe
, 
pktbuf
 + 
·d
 +…robe->
´_dl_Ën
, &
Ën
) != 0)

915 
´obe
->
´_”ºo
 = 
EINVAL
;

921 
Ën
 +ğ
´obe
->
´_dl_Ën
;

924 if(
´obe
->
´_dl_Ën
 > 0)

925 
	`memıy
(
pktbuf
+
·d
, 
´obe
->
´_dl_buf
,…robe->
´_dl_Ën
);

927 
	`g‘timeofday_w¿p
(&
´obe
->
´_tx
);

928 if(
	`sÿm³r_dl_tx
(
´obe
->
´_dl
, 
pktbuf
+
·d
, 
Ën
) == -1)

930 
´obe
->
´_”ºo
 = 
”ºo
;

934 
´obe
->
´_tx_¿w
 = 
pktbuf
 + 
·d
 +…robe->
´_dl_Ën
;

935 
´obe
->
´_tx_¿wËn
 = 
Ën
 -…robe->
´_dl_Ën
;

937 
	}
}

939 
	$sÿm³r_´obe_š™
()

941 cÚ¡ 
sÿm³r_osšfo_t
 *
osšfo
 = 
	`sÿm³r_osšfo_g‘
();

942 if(
	`SCAMPER_OSINFO_IS_SUNOS
(
osšfo
))

943 
id_dl
 = 1;

944 if(
	`sÿm³r_İtiÚ_¶ª‘Ïb
(è|| 
	`sÿm³r_İtiÚ_¿wtı
())

945 
¿wtı
 = 1;

947 
	}
}

949 
	$sÿm³r_´obe_ş—nup
()

951 if(
pktbuf
 !ğ
NULL
)

953 
	`ä“
(
pktbuf
);

954 
pktbuf
 = 
NULL
;

957 
pktbuf_Ën
 = 0;

959 
	}
}

	@scamper_probe.h

27 #iâdeà
__SCAMPER_PROBE_H


28 
	#__SCAMPER_PROBE_H


	)

35 
	ssÿm³r_´obe_İt


37 
ušt8_t
 
	mty³
;

41 
	sv4t¥s


43 
š_addr
 
	ms
[4];

44 
ušt8_t
 
	mc
;

45 } 
	mv4t¥s
;

47 
	sv6rh0


49 
š6_addr
 *
	ms
;

50 
ušt8_t
 
	mc
;

51 } 
	mv6rh0
;

53 
	sv6äag


55 
ušt16_t
 
	moff
;

56 
ušt32_t
 
	mid
;

57 } 
	mv6äag
;

59 
	squick¡¬t


61 
ušt8_t
 
	mfunc
;

62 
ušt8_t
 
	m¿‹
;

63 
ušt8_t
 
	m‰l
;

64 
ušt32_t
 
	mnÚû
;

65 } 
	mquick¡¬t
;

66 } 
	mun
;

67 } 
	tsÿm³r_´obe_İt_t
;

69 
	#İt_v4t¥s_s
 
un
.
v4t¥s
.
s


	)

70 
	#İt_v4t¥s_c
 
un
.
v4t¥s
.
c


	)

71 
	#İt_v6rh0_s
 
un
.
v6rh0
.
s


	)

72 
	#İt_v6rh0_c
 
un
.
v6rh0
.
c


	)

73 
	#İt_v6äag_off
 
un
.
v6äag
.
off


	)

74 
	#İt_v6äag_id
 
un
.
v6äag
.
id


	)

75 
	#İt_qs_nÚû
 
un
.
quick¡¬t
.
nÚû


	)

76 
	#İt_qs_‰l
 
un
.
quick¡¬t
.
‰l


	)

77 
	#İt_qs_¿‹
 
un
.
quick¡¬t
.
¿‹


	)

78 
	#İt_qs_func
 
un
.
quick¡¬t
.
func


	)

80 
	#SCAMPER_PROBE_IPOPTS_V6ROUTE0
 0

	)

81 
	#SCAMPER_PROBE_IPOPTS_V6FRAG
 1

	)

82 
	#SCAMPER_PROBE_IPOPTS_V4RR
 2

	)

83 
	#SCAMPER_PROBE_IPOPTS_V4TSPS
 3

	)

84 
	#SCAMPER_PROBE_IPOPTS_V4TSO
 4

	)

85 
	#SCAMPER_PROBE_IPOPTS_V4TSAA
 5

	)

86 
	#SCAMPER_PROBE_IPOPTS_QUICKSTART
 6

	)

88 
	#SCAMPER_PROBE_FLAG_IPID
 0x0001

	)

89 
	#SCAMPER_PROBE_FLAG_NOFRAG
 0x0002

	)

90 
	#SCAMPER_PROBE_FLAG_SPOOF
 0x0004

	)

91 
	#SCAMPER_PROBE_FLAG_DL
 0x0008

	)

93 
	#SCAMPER_PROBE_TCPOPT_SACK
 0x01

	)

94 
	#SCAMPER_PROBE_TCPOPT_TS
 0x02

	)

98 
	#SCAMPER_PROBE_IS_IPID
(
´
) ( \

99 ((
´
)->
´_æags
 & 
SCAMPER_PROBE_FLAG_IPID
) != 0 && \

100 (
´
)->
´__d¡
 !ğ
NULL
 && 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(Õr)->´__d¡))

	)

108 
	ssÿm³r_´obe


117 
	m´_fd
;

118 
sÿm³r_dl_t
 *
	m´_dl
;

119 
ušt8_t
 *
	m´_dl_buf
;

120 
ušt16_t
 
	m´_dl_Ën
;

123 
ušt16_t
 
	m´_æags
;

126 
sÿm³r_addr_t
 *
	m´__¤c
;

127 
sÿm³r_addr_t
 *
	m´__d¡
;

128 
ušt8_t
 
	m´__tos
;

129 
ušt8_t
 
	m´__‰l
;

130 
ušt8_t
 
	m´__´Ùo
;

131 
ušt16_t
 
	m´__id
;

132 
ušt16_t
 
	m´__off
;

133 
ušt32_t
 
	m´__æow
;

136 
sÿm³r_´obe_İt_t
 *
	m´_İts
;

137 
	m´_İtc
;

140 
ušt16_t
 
	m´_udp_¥Üt
;

141 
ušt16_t
 
	m´_udp_dpÜt
;

144 
ušt8_t
 
	m´_icmp_ty³
;

145 
ušt8_t
 
	m´_icmp_code
;

146 
ušt16_t
 
	m´_icmp_sum
;

147 
ušt16_t
 
	m´_icmp_id
;

148 
ušt16_t
 
	m´_icmp_£q
;

149 
ušt16_t
 
	m´_icmp_mtu
;

151 
ušt8_t
 
	m´_no_Œªs
;

153 
ušt16_t
 
	m´_tı_¥Üt
;

154 
ušt16_t
 
	m´_tı_dpÜt
;

155 
ušt32_t
 
	m´_tı_£q
;

156 
ušt32_t
 
	m´_tı_ack
;

157 
ušt8_t
 
	m´_tı_æags
;

158 
ušt8_t
 
	m´_tı_İts
;

159 
ušt16_t
 
	m´_tı_wš
;

160 
ušt16_t
 
	m´_tı_mss
;

161 
ušt32_t
 
	m´_tı_tsv®
;

162 
ušt32_t
 
	m´_tı_t£ü
;

163 
ušt32_t
 
	m´_tı_§ck
[8];

164 
ušt8_t
 
	m´_tı_§ckb
;

165 
ušt8_t
 
	m´_tı_wsÿË
;

166 
ušt32_t
 
	m´_tı_mpÿ·bË
;

167 
ušt32_t
 
	m´_tı_mpÿ·bË2
;

168 
ušt32_t
 
	m´_tı_mpjoš
;

169 
ušt32_t
 
	m´_tı_mpjoš2
;

170 
ušt8_t
 
	m´_tı_md5
;

171 
ušt32_t
 
	m´_tı_md5dige¡
[4];

172 
ušt8_t
 
	m´_tı_auth
;

173 
ušt8_t
 
	m´_tı_authkeyid
;

174 
ušt8_t
 
	m´_tı_authºextkeyid
;

175 
ušt32_t
 
	m´_tı_authmac
[4];

178 
ušt8_t
 *
	m´_d©a
;

179 
ušt16_t
 
	m´_Ën
;

182 
timev®
 
	m´_tx
;

185 
ušt8_t
 *
	m´_tx_¿w
;

186 
ušt16_t
 
	m´_tx_¿wËn
;

189 
	m´_”ºo
;

190 } 
	tsÿm³r_´obe_t
;

192 
sÿm³r_´obe
(
sÿm³r_´obe_t
 *
´obe
);

193 
sÿm³r_´obe_t
 *
´obe_dup
(sÿm³r_´obe_ˆ*
´
);

195 #ifdeà
__SCAMPER_TASK_H


196 
sÿm³r_´obe_sk
(
sÿm³r_´obe_t
 *
´obe
, 
sÿm³r_sk_t
 *
sk
);

200 
	#SCAMPER_PROBE_ICMP_ECHO
(
´
, 
id
, 
£q
) do { \

201 
	`as£¹
((
´
)->
´__d¡
 !ğ
NULL
); \

202 
	`as£¹
((
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 || \

203 (
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
); \

204 if((
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
) \

206 (
´
)->
´__´Ùo
 = 
IPPROTO_ICMP
; \

207 (
´
)->
´_icmp_ty³
 = 
ICMP_ECHO
; \

211 (
´
)->
´__´Ùo
 = 
IPPROTO_ICMPV6
; \

212 (
´
)->
´_icmp_ty³
 = 
ICMP6_ECHO_REQUEST
; \

214 (
´
)->
´_icmp_id
 = (
id
); \

215 (
´
)->
´_icmp_£q
 = (
£q
); \

216 } 0)

	)

219 
	#SCAMPER_PROBE_ICMP_TIME
(
´
, 
id
, 
£q
) do { \

220 
	`as£¹
((
´
)->
´__d¡
 !ğ
NULL
); \

221 
	`as£¹
((
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
); \

222 (
´
)->
´__´Ùo
 = 
IPPROTO_ICMP
; \

223 (
´
)->
´_icmp_ty³
 = 
ICMP_TSTAMP
; \

224 (
´
)->
´_icmp_id
 = (
id
); \

225 (
´
)->
´_icmp_£q
 = (
£q
); \

226 } 0)

	)

228 
	#SCAMPER_PROBE_ICMP_PTB
(
´
, 
mtu
) do { \

229 
	`as£¹
((
´
)->
´__d¡
 !ğ
NULL
); \

230 
	`as£¹
((
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 || \

231 (
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
); \

232 if((
´
)->
´__d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
) \

234 (
´
)->
´__´Ùo
 = 
IPPROTO_ICMP
; \

235 (
´
)->
´_icmp_ty³
 = 
ICMP_UNREACH
; \

236 (
´
)->
´_icmp_code
 = 
ICMP_UNREACH_NEEDFRAG
; \

240 (
´
)->
´__´Ùo
 = 
IPPROTO_ICMPV6
; \

241 (
´
)->
´_icmp_ty³
 = 
ICMP6_PACKET_TOO_BIG
; \

243 (
´
)->
´_icmp_mtu
 = (
mtu
); \

244 } 0)

	)

250 
sÿm³r_´obe_š™
();

251 
sÿm³r_´obe_ş—nup
();

	@scamper_queue.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_sk.h
"

37 
	~"sÿm³r_queue.h
"

38 
	~"sÿm³r_debug.h
"

39 
	~"uts.h
"

40 
	~"mjl_li¡.h
"

41 
	~"mjl_h—p.h
"

43 
	ssÿm³r_queue


46 
sÿm³r_sk
 *
	msk
;

49 
timev®
 
	mtimeout
;

52 *
	mqueue
;

55 *
	mnode
;

58 
dli¡_t
 *
	g´obe_queue
 = 
NULL
;

59 
h—p_t
 *
	gwa™_queue
 = 
NULL
;

60 
h—p_t
 *
	gdÚe_queue
 = 
NULL
;

61 
	gcouÁ
 = 0;

68 
	$queue_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

70 cÚ¡ 
sÿm³r_queue_t
 *
a
 = (cÚ¡ sÿm³r_queue_ˆ*)
va
;

71 cÚ¡ 
sÿm³r_queue_t
 *
b
 = (cÚ¡ sÿm³r_queue_ˆ*)
vb
;

72  
	`timev®_cmp
(&
b
->
timeout
, &
a
->timeout);

73 
	}
}

75 
	$queue_Ú»move
(*
™em
)

77 
sÿm³r_queue_t
 *
sq
 = 
™em
;

78 
sq
->
queue
 = 
NULL
;

79 
sq
->
node
 = 
NULL
;

81 
	}
}

88 
	$queue_uÆšk
(
sÿm³r_queue_t
 *
sq
)

90 if(
sq
->
queue
 =ğ
NULL
)

94 if(
sq
->
queue
 =ğ
´obe_queue
)

96 
	`dli¡_node_pİ
(
sq
->
queue
, sq->
node
);

98 if(
sq
->
queue
 =ğ
wa™_queue
 || sq->queu=ğ
dÚe_queue
)

100 
	`h—p_d–‘e
(
sq
->
queue
, sq->
node
);

103 
couÁ
--;

105 
	}
}

113 
	$queue_lšk
(
sÿm³r_queue_t
 *
sq
, *
queue
)

115 *
node
;

117 
	`as£¹
(
sq
->
queue
 =ğ
NULL
);

118 
	`as£¹
(
sq
->
node
 =ğ
NULL
);

121 if(
queue
 =ğ
´obe_queue
)

123 
node
 = 
	`dli¡__push
(
queue
, 
sq
);

127 
	`as£¹
(
queue
 =ğ
wa™_queue
 || queu=ğ
dÚe_queue
);

128 
node
 = 
	`h—p_š£¹
(
queue
, 
sq
);

132 if(
node
 !ğ
NULL
)

134 
sq
->
queue
 = queue;

135 
sq
->
node
 =‚ode;

136 
couÁ
++;

141 
	}
}

149 
	$sÿm³r_queue_´obe_h—d
(
sÿm³r_queue_t
 *
sq
)

151 
dli¡_node_t
 *
node
;

153 
	`queue_uÆšk
(
sq
);

155 if((
node
 = 
	`dli¡_h—d_push
(
´obe_queue
, 
sq
)è=ğ
NULL
)

157 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…ush‚ode");

161 
sq
->
queue
 = 
´obe_queue
;

162 
sq
->
node
 =‚ode;

163 
couÁ
++;

165 
	}
}

167 
	$sÿm³r_queue_´obe
(
sÿm³r_queue_t
 *
sq
)

169 
	`queue_uÆšk
(
sq
);

170  
	`queue_lšk
(
sq
, 
´obe_queue
);

171 
	}
}

173 
	$sÿm³r_queue_i¥robe
(
sÿm³r_queue_t
 *
sq
)

175 if(
sq
->
queue
 =ğ
´obe_queue
)

178 
	}
}

180 
	$sÿm³r_queue_wa™
(
sÿm³r_queue_t
 *
sq
, 
m£c
)

182 
	`queue_uÆšk
(
sq
);

183 
	`g‘timeofday_w¿p
(&
sq
->
timeout
);

184 
	`timev®_add_ms
(&
sq
->
timeout
, &sq->timeout, 
m£c
);

185  
	`queue_lšk
(
sq
, 
wa™_queue
);

186 
	}
}

188 
	$sÿm³r_queue_iswa™
(
sÿm³r_queue_t
 *
sq
)

190 if(
sq
->
queue
 =ğ
wa™_queue
)

193 
	}
}

195 
	$sÿm³r_queue_wa™_tv
(
sÿm³r_queue_t
 *
sq
, cÚ¡ 
timev®
 *
tv
)

197 
	`queue_uÆšk
(
sq
);

198 
	`timev®_ıy
(&
sq
->
timeout
, 
tv
);

199  
	`queue_lšk
(
sq
, 
wa™_queue
);

200 
	}
}

202 
	$sÿm³r_queue_dÚe
(
sÿm³r_queue_t
 *
sq
, 
m£c
)

204 
	`queue_uÆšk
(
sq
);

205 
	`g‘timeofday_w¿p
(&
sq
->
timeout
);

206 
	`timev®_add_ms
(&
sq
->
timeout
, &sq->timeout, 
m£c
);

207  
	`queue_lšk
(
sq
, 
dÚe_queue
);

208 
	}
}

210 
	$sÿm³r_queue_isdÚe
(
sÿm³r_queue_t
 *
sq
)

212 if(
sq
->
queue
 =ğ
dÚe_queue
)

215 
	}
}

217 
	$sÿm³r_queue_d‘ach
(
sÿm³r_queue_t
 *
sq
)

219 
	`queue_uÆšk
(
sq
);

221 
	}
}

228 
sÿm³r_sk
 *
	$sÿm³r_queue_£Ëù
()

230 
sÿm³r_queue_t
 *
sq
;

232 if((
sq
 = 
	`dli¡_h—d_pİ
(
´obe_queue
)è!ğ
NULL
)

234 
couÁ
--;

235  
sq
->
sk
;

238  
NULL
;

239 
	}
}

245 
sÿm³r_sk
 *
	$sÿm³r_queue_g‘dÚe
(cÚ¡ 
timev®
 *
tv
)

247 
sÿm³r_queue_t
 *
sq
;

249 if((
sq
 = (
sÿm³r_queue_t
 *)
	`h—p_h—d_™em
(
dÚe_queue
)è=ğ
NULL
)

250  
NULL
;

252 if(
	`timev®_cmp
(
tv
, &
sq
->
timeout
) >= 0)

254 
	`queue_uÆšk
(
sq
);

255  
sq
->
sk
;

258  
NULL
;

259 
	}
}

272 
	$sÿm³r_queue_wa™time
(
timev®
 *
tv
)

274 
sÿm³r_queue_t
 *
sq
;

275 
h—p_t
 *
queues
[2];

276 
i
, 
£t
 = 0;

278 
queues
[0] = 
wa™_queue
;

279 
queues
[1] = 
dÚe_queue
;

281 
i
=((
queues
)/(
h—p_t
 *))-1; i >= 0; i--)

283 if((
sq
 = (
sÿm³r_queue_t
 *)
	`h—p_h—d_™em
(
queues
[
i
])è!ğ
NULL
)

285 if(
£t
 =ğ0 || 
	`timev®_cmp
(
tv
, &
sq
->
timeout
) > 0)

287 
	`timev®_ıy
(
tv
, &
sq
->
timeout
);

288 
£t
++;

293  
£t
;

294 
	}
}

306 
	$sÿm³r_queue_»adycouÁ
()

308 
sÿm³r_queue_t
 *
sq
;

309 
timev®
 
tv
;

311 if(
	`h—p_couÁ
(
wa™_queue
) > 0)

313 
	`g‘timeofday_w¿p
(&
tv
);

316 (
sq
 = 
	`h—p_h—d_™em
(
wa™_queue
)è!ğ
NULL
)

318 if(
	`timev®_cmp
(&
tv
, &
sq
->
timeout
) < 0)

321 
	`queue_uÆšk
(
sq
);

323 
	`sÿm³r_sk_hªdËtimeout
(
sq
->
sk
);

325 if(
sq
->
queue
 =ğ
NULL
)

326 
	`queue_lšk
(
sq
, 
´obe_queue
);

330  
	`dli¡_couÁ
(
´obe_queue
);

331 
	}
}

333 
	$sÿm³r_queue_wšdowcouÁ
()

335  
	`dli¡_couÁ
(
´obe_queue
è+ 
	`h—p_couÁ
(
wa™_queue
);

336 
	}
}

344 
	$sÿm³r_queue_em±y
()

346 
sÿm³r_queue_t
 *
sq
;

348 (
sq
 = (
sÿm³r_queue_t
 *)
	`h—p_»move
(
wa™_queue
)è!ğ
NULL
)

350 
couÁ
--;

353 (
sq
 = (
sÿm³r_queue_t
 *)
	`dli¡_h—d_pİ
(
´obe_queue
)è!ğ
NULL
)

355 
couÁ
--;

359 
	}
}

361 
	$sÿm³r_queue_couÁ
()

363  
couÁ
;

364 
	}
}

366 
sÿm³r_queue_t
 *
	$sÿm³r_queue_®loc
(
sÿm³r_sk_t
 *
sk
)

368 
sÿm³r_queue_t
 *
sq
;

369 if((
sq
 = 
	`m®loc_z”o
((
sÿm³r_queue_t
))è!ğ
NULL
)

370 
sq
->
sk
 =ask;

371  
sq
;

372 
	}
}

374 
	$sÿm³r_queue_ä“
(
sÿm³r_queue_t
 *
sq
)

376 if(
sq
 =ğ
NULL
)

379 
	`queue_uÆšk
(
sq
);

380 
	`ä“
(
sq
);

382 
	}
}

384 
	$sÿm³r_queue_š™
()

386 if((
´obe_queue
 = 
	`dli¡_®loc
()è=ğ
NULL
)

390 
	`dli¡_Ú»move
(
´obe_queue
, 
queue_Ú»move
);

392 if((
wa™_queue
 = 
	`h—p_®loc
(
queue_cmp
)è=ğ
NULL
)

396 
	`h—p_Ú»move
(
wa™_queue
, 
queue_Ú»move
);

398 if((
dÚe_queue
 = 
	`h—p_®loc
(
queue_cmp
)è=ğ
NULL
)

402 
	`h—p_Ú»move
(
dÚe_queue
, 
queue_Ú»move
);

405 
	}
}

407 
	$sÿm³r_queue_ş—nup
()

409 if(
dÚe_queue
 !ğ
NULL
)

411 
	`h—p_ä“
(
dÚe_queue
, 
NULL
);

412 
dÚe_queue
 = 
NULL
;

415 if(
wa™_queue
 !ğ
NULL
)

417 
	`h—p_ä“
(
wa™_queue
, 
NULL
);

418 
wa™_queue
 = 
NULL
;

421 if(
´obe_queue
 !ğ
NULL
)

423 
	`dli¡_ä“
(
´obe_queue
);

424 
´obe_queue
 = 
NULL
;

428 
	}
}

	@scamper_queue.h

25 #iâdeà
__SCAMPER_QUEUE_H


26 
	#__SCAMPER_QUEUE_H


	)

28 
sÿm³r_queue
 
	tsÿm³r_queue_t
;

40 
sÿm³r_queue_´obe
(
sÿm³r_queue_t
 *
queue
);

41 
sÿm³r_queue_´obe_h—d
(
sÿm³r_queue_t
 *
sq
);

42 
sÿm³r_queue_wa™
(
sÿm³r_queue_t
 *
queue
, 
m£c
);

43 
sÿm³r_queue_dÚe
(
sÿm³r_queue_t
 *
queue
, 
m£c
);

44 
sÿm³r_queue_wa™_tv
(
sÿm³r_queue_t
 *
queue
, cÚ¡ 
timev®
 *
tv
);

46 
sÿm³r_queue_i¥robe
(
sÿm³r_queue_t
 *
queue
);

47 
sÿm³r_queue_iswa™
(
sÿm³r_queue_t
 *
queue
);

48 
sÿm³r_queue_isdÚe
(
sÿm³r_queue_t
 *
queue
);

50 
sÿm³r_queue_t
 *
sÿm³r_queue_®loc
(
sÿm³r_sk_t
 *
sk
);

51 
sÿm³r_queue_ä“
(
sÿm³r_queue_t
 *
queue
);

54 
sÿm³r_queue_d‘ach
(
sÿm³r_queue_t
 *
queue
);

57 
sÿm³r_sk
 *
sÿm³r_queue_£Ëù
();

60 
sÿm³r_sk
 *
sÿm³r_queue_g‘dÚe
(cÚ¡ 
timev®
 *
tv
);

63 
sÿm³r_queue_wa™time
(
timev®
 *
tv
);

66 
sÿm³r_queue_couÁ
();

69 
sÿm³r_queue_»adycouÁ
();

72 
sÿm³r_queue_wšdowcouÁ
();

75 
sÿm³r_queue_em±y
();

77 
sÿm³r_queue_š™
();

78 
sÿm³r_queue_ş—nup
();

	@scamper_rtsock.c

42 #iâdeà
lšt


43 cÚ¡ 
	grcsid
[] =

47 #ifdeà
HAVE_CONFIG_H


48 
	~"cÚfig.h
"

50 
	~"š‹º®.h
"

52 #ià
defšed
(
__APPLE__
)

53 
	gbrok’
 = -1;

57 #ià
defšed
(
__lšux__
)

59 
	sÆmsghdr


61 
ušt32_t
 
	mÆmsg_Ën
;

62 
ušt16_t
 
	mÆmsg_ty³
;

63 
ušt16_t
 
	mÆmsg_æags
;

64 
ušt32_t
 
	mÆmsg_£q
;

65 
ušt32_t
 
	mÆmsg_pid
;

68 
	sÆmsg”r


70 
	m”rÜ
;

71 
Æmsghdr
 
	mmsg
;

74 
	s¹©Œ


76 
	m¹a_Ën
;

77 
	m¹a_ty³
;

80 
	s¹msg


82 
	m¹m_çmy
;

83 
	m¹m_d¡_Ën
;

84 
	m¹m_¤c_Ën
;

85 
	m¹m_tos
;

86 
	m¹m_bË
;

87 
	m¹m_´ÙocŞ
;

88 
	m¹m_scİe
;

89 
	m¹m_ty³
;

90 
	m¹m_æags
;

93 
	#NLMSG_ERROR
 0x2

	)

94 
	#NLMSG_ALIGNTO
 4

	)

95 
	#NLMSG_ALIGN
(
Ën
è((Ö’)+
NLMSG_ALIGNTO
-1è& ~(NLMSG_ALIGNTO-1))

	)

96 
	#NLMSG_LENGTH
(
Ën
è(Ö’)+
	`NLMSG_ALIGN
((
Æmsghdr
)))

	)

97 
	#NLMSG_DATA
(
Æh
è((*)(((*êlhè+ 
	`NLMSG_LENGTH
(0)))

	)

99 
	#RTA_ALIGNTO
 4

	)

100 
	#RTA_ALIGN
(
Ën
è((Ö’)+
RTA_ALIGNTO
-1è& ~(RTA_ALIGNTO-1))

	)

101 
	#RTA_LENGTH
(
Ën
è(
	`RTA_ALIGN
((
¹©Œ
)è+ (Ën))

	)

102 
	#RTA_DATA
(
¹a
è((*)(((*)Ô)è+ 
	`RTA_LENGTH
(0)))

	)

103 
	#RTA_OK
(
¹a
,
Ën
è(Ö’è> 0 && (¹a)->
¹a_Ën
 >ğ(
¹©Œ
) && \

104 (
¹a
)->
¹a_Ën
 <ğ(
Ën
))

	)

105 
	#RTA_NEXT
(
¹a
,
©ŒËn
è(×‰¾’è-ğ
	`RTA_ALIGN
(Ô)->
¹a_Ën
), \

106 (
¹©Œ
*)(((*)(
¹a
)è+ 
	`RTA_ALIGN
(Ô)->
¹a_Ën
)))

	)

107 
	#RTA_UNSPEC
 0

	)

108 
	#RTA_DST
 1

	)

109 
	#RTA_SRC
 2

	)

110 
	#RTA_IIF
 3

	)

111 
	#RTA_OIF
 4

	)

112 
	#RTA_GATEWAY
 5

	)

113 
	#RTA_PRIORITY
 6

	)

114 
	#RTA_PREFSRC
 7

	)

115 
	#RTA_METRICS
 8

	)

116 
	#RTA_MULTIPATH
 9

	)

117 
	#RTA_PROTOINFO
 10

	)

118 
	#RTA_FLOW
 11

	)

119 
	#RTA_CACHEINFO
 12

	)

120 
	#RTA_SESSION
 13

	)

122 
	#RTM_RTA
(
r
è((
¹©Œ
*)(((*)(r)) + \

123 
	`NLMSG_ALIGN
((
¹msg
))))

	)

124 
	#RTM_BASE
 0x10

	)

125 
	#RTM_NEWROUTE
 (
RTM_BASE
+8)

	)

126 
	#RTM_GETROUTE
 (
RTM_BASE
+10)

	)

127 
	#NLM_F_REQUEST
 1

	)

128 
	#NETLINK_ROUTE
 0

	)

132 
	~"sÿm³r.h
"

133 
	~"sÿm³r_addr.h
"

134 
	~"sÿm³r_li¡.h
"

135 
	~"sÿm³r_fds.h
"

136 
	~"sÿm³r_¹sock.h
"

137 
	~"sÿm³r_´iv£p.h
"

138 
	~"sÿm³r_osšfo.h
"

139 
	~"sÿm³r_debug.h
"

140 
	~"uts.h
"

141 
	~"mjl_li¡.h
"

143 
sÿm³r_addrÿche_t
 *
addrÿche
;

145 #iâdeà
_WIN32


146 
	s¹sock_·œ


148 
sÿm³r_rou‹_t
 *
	mrou‹
;

149 
ušt16_t
 
	m£q
;

150 
dli¡_node_t
 *
	mnode
;

151 } 
	t¹sock_·œ_t
;

153 
pid_t
 
	gpid
;

154 
ušt16_t
 
	g£q
 = 0;

155 
dli¡_t
 *
	g·œs
 = 
NULL
;

157 
¹sock_·œ_t
 *
	$¹sock_·œ_®loc
(
sÿm³r_rou‹_t
 *
rou‹
, 
£q
)

159 
¹sock_·œ_t
 *
·œ
;

160 if((
·œ
 = 
	`m®loc
((
¹sock_·œ_t
))è=ğ
NULL
)

161  
NULL
;

162 
·œ
->
rou‹
 =„oute;

163 
·œ
->
£q
 = seq;

164 if((
·œ
->
node
 = 
	`dli¡_h—d_push
(
·œs
,…aœ)è=ğ
NULL
)

166 
	`ä“
(
·œ
);

167  
NULL
;

169 
rou‹
->
š‹º®
 = 
·œ
;

170  
·œ
;

171 
	}
}

173 
	$¹sock_·œ_ä“
(
¹sock_·œ_t
 *
·œ
)

175 if(
·œ
 =ğ
NULL
)

177 
·œ
->
rou‹
->
š‹º®
 = 
NULL
;

178 if(
·œ
->
node
 !ğ
NULL
)

179 
	`dli¡_node_pİ
(
·œs
, 
·œ
->
node
);

180 
	`ä“
(
·œ
);

182 
	}
}

184 
¹sock_·œ_t
 *
	$¹sock_·œ_g‘
(
ušt16_t
 
£q
)

186 
¹sock_·œ_t
 *
·œ
;

187 
dli¡_node_t
 *
node
;

189 
node
=
	`dli¡_h—d_node
(
·œs
);‚od!ğ
NULL
;‚ode=
	`dli¡_node_Ãxt
(node))

191 
·œ
 = 
	`dli¡_node_™em
(
node
);

192 if(
·œ
->
£q
 != seq)

194 
	`dli¡_node_pİ
(
·œs
, 
node
);

195 
·œ
->
node
 = 
NULL
;

196  
·œ
;

199  
NULL
;

200 
	}
}

202 #ià
defšed
(
HAVE_BSD_ROUTE_SOCKET
)

204 
	$¹msg_dump
(cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

206 
¡r
[80];

207 
size_t
 
i
, 
off
 = 0;

208 
k
 = 0;

210 
i
=0; i<
Ën
; i++)

212 if(
k
 == 20)

214 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
, "%s", 
¡r
);

215 
k
 = 0;

216 
off
 = 0;

219 if(
k
 != 0 && (k % 4) == 0)

220 
	`¡ršg_cÚÿt
(
¡r
, (¡r), &
off
, " ");

221 
	`¡ršg_cÚÿt
(
¡r
, (¡r), &
off
, "%02x", 
buf
[
i
]);

222 
k
++;

225 if(
k
 != 0)

226 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
, "%s", 
¡r
);

228 
	}
}

231 
	$sÿm³r_¹sock_roundup
(
size_t
 
Ën
)

233 #ifdeà
__APPLE__


234 cÚ¡ 
sÿm³r_osšfo_t
 *
osšfo
;

236 if(
brok’
 == -1)

238 
osšfo
 = 
	`sÿm³r_osšfo_g‘
();

239 if(
osšfo
->
os_id
 =ğ
SCAMPER_OSINFO_OS_DARWIN
 && osšfo->
os_»l
[0] >= 10)

240 
brok’
 = 1;

242 
brok’
 = 0;

245 if(
brok’
 != 0)

247 if(
Ën
 > 0)

248  (1 + ((
Ën
 - 1è| ((
ušt32_t
) - 1)));

250  (
ušt32_t
);

254  ((
Ën
 > 0) ? (1 + ((len - 1) | (() - 1))) : ());

255 
	}
}

264 
	$sÿm³r_¹sock_g‘ifšdex
(
fd
, 
sÿm³r_addr_t
 *
d¡
)

266 
sockaddr_¡Üage
 
§s
;

267 
sockaddr_dl
 *
sdl
;

268 
¹_msghdr
 *
¹m
;

269 
ušt8_t
 
buf
[1024];

270 
size_t
 
Ën
;

271 
ssize_t
 
ss
;

272 
¦’
;

274 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
d¡
))

275 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET
, 
d¡
->
addr
, 0);

276 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
d¡
))

277 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET6
, 
d¡
->
addr
, 0);

281 if((
¦’
 = 
	`sockaddr_Ën
((
sockaddr
 *)&
§s
)) <= 0)

284 
Ën
 = (
¹_msghdr
è+ 
	`sÿm³r_¹sock_roundup
(
¦’
) +

285 
	`sÿm³r_¹sock_roundup
((
sockaddr_dl
));

286 if(
Ën
 > (
buf
))

289 
	`mem£t
(
buf
, 0, 
Ën
);

290 
¹m
 = (
¹_msghdr
 *)
buf
;

291 
¹m
->
¹m_msgËn
 = 
Ën
;

292 
¹m
->
¹m_v”siÚ
 = 
RTM_VERSION
;

293 
¹m
->
¹m_ty³
 = 
RTM_GET
;

294 
¹m
->
¹m_addrs
 = 
RTA_DST
 | 
RTA_IFP
;

295 
¹m
->
¹m_pid
 = 
pid
;

296 
¹m
->
¹m_£q
 = 
£q
;

297 
	`memıy
(
buf
 + (
¹_msghdr
), &
§s
, (
size_t
)
¦’
);

299 
sdl
 = (
sockaddr_dl
 *)(
buf
 + (
¹_msghdr
) +

300 
	`sÿm³r_¹sock_roundup
(
¦’
));

301 
sdl
->
sdl_çmy
 = 
AF_LINK
;

303 #ià!
	`defšed
(
__sun__
)

304 
sdl
->
sdl_Ën
 = (
sockaddr_dl
);

307 if((
ss
 = 
	`wr™e
(
fd
, 
buf
, 
Ën
)è< 0 || (
size_t
)ss !=†en)

309 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot write„outing socket");

314 
	}
}

317 #ià
defšed
(
__lšux__
)

332 
	$sÿm³r_¹sock_g‘ifšdex
(
fd
, 
sÿm³r_addr_t
 *
d¡
)

334 
Æmsghdr
 *
Æmsg
;

335 
¹msg
 *rtmsg;

336 
¹©Œ
 *
¹a
;

337 
”rÜ
;

338 
d¡_Ën
;

339 
ušt8_t
 
buf
[1024];

340 
af
;

342 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
d¡
))

344 
d¡_Ën
 = 4;

345 
af
 = 
AF_INET
;

347 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
d¡
))

349 
d¡_Ën
 = 16;

350 
af
 = 
AF_INET6
;

364 
	`mem£t
(
buf
, 0, (buf));

365 
Æmsg
 = (
Æmsghdr
 *)
buf
;

366 
Æmsg
->
Æmsg_Ën
 = 
	`NLMSG_LENGTH
((
¹msg
));

367 
Æmsg
->
Æmsg_ty³
 = 
RTM_GETROUTE
;

368 
Æmsg
->
Æmsg_æags
 = 
NLM_F_REQUEST
;

369 
Æmsg
->
Æmsg_£q
 = 
£q
;

370 
Æmsg
->
Æmsg_pid
 = 
pid
;

373 
¹msg
 = 
	`NLMSG_DATA
(
Æmsg
);

374 
¹msg
->
¹m_çmy
 = 
af
;

375 
¹msg
->
¹m_æags
 = 0;

376 
¹msg
->
¹m_d¡_Ën
 = 
d¡_Ën
 * 8;

378 
¹a
 = (
¹©Œ
 *)(
buf
 + 
	`NLMSG_ALIGN
(
Æmsg
->
Æmsg_Ën
));

379 
¹a
->
¹a_ty³
 = 
RTA_DST
;

380 
¹a
->
¹a_Ën
 = 
	`RTA_LENGTH
(
d¡_Ën
);

381 
Æmsg
->
Æmsg_Ën
 +ğ
	`RTA_LENGTH
(
d¡_Ën
);

382 
	`memıy
(
	`RTA_DATA
(
¹a
), 
d¡
->
addr
, 
d¡_Ën
);

385 if((
”rÜ
 = 
	`£nd
(
fd
, 
buf
, 
Æmsg
->
Æmsg_Ën
, 0)) !=‚lmsg->nlmsg_len)

387 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send");

392 
	}
}

395 
	$sÿm³r_¹sock_g‘rou‹
(
sÿm³r_fd_t
 *
fdn
, 
sÿm³r_rou‹_t
 *
rou‹
)

397 
¹sock_·œ_t
 *
·œ
 = 
NULL
;

398 
fd
;

401 if((
fd
 = 
	`sÿm³r_fd_fd_g‘
(
fdn
)) == -1)

405 if(
	`sÿm³r_¹sock_g‘ifšdex
(
fd
, 
rou‹
->
d¡
) != 0)

409 if((
·œ
 = 
	`¹sock_·œ_®loc
(
rou‹
, 
£q
++)è=ğ
NULL
)

412 
	}
}

414 #ià
defšed
(
__lšux__
)

416 
	$¹©Œ_dump
(
¹©Œ
 *
¹a
)

418 *
¹a_ty³
;

419 
¹a_d©a
[64];

420 
i
;

422 
¹a
->
¹a_ty³
)

424 
RTA_UNSPEC
: 
¹a_ty³
 = "unspec"; ;

425 
RTA_DST
: 
¹a_ty³
 = "dst"; ;

426 
RTA_SRC
: 
¹a_ty³
 = "src"; ;

427 
RTA_IIF
: 
¹a_ty³
 = "iif"; ;

428 
RTA_OIF
: 
¹a_ty³
 = "oif"; ;

429 
RTA_GATEWAY
: 
¹a_ty³
 = "gateway"; ;

430 
RTA_PRIORITY
: 
¹a_ty³
 = "priority"; ;

431 
RTA_PREFSRC
: 
¹a_ty³
 = "prefsrc"; ;

432 
RTA_METRICS
: 
¹a_ty³
 = "metrics"; ;

433 
RTA_MULTIPATH
: 
¹a_ty³
 = "multipath"; ;

434 
RTA_PROTOINFO
: 
¹a_ty³
 = "protoinfo"; ;

435 
RTA_FLOW
: 
¹a_ty³
 = "flow"; ;

436 
RTA_CACHEINFO
: 
¹a_ty³
 = "cacheinfo"; ;

437 
RTA_SESSION
: 
¹a_ty³
 = "session"; ;

438 : 
¹a_ty³
 = "<unknown>"; ;

441 
i
=0;i<
¹a
->
¹a_Ën
-(
¹©Œ
)&&i<((
¹a_d©a
)/2)-1;i++)

443 
	`¢´štf
(&
¹a_d©a
[
i
*2], 3, "%02x",

444 *(
ušt8_t
 *)(((*)
¹a
è+ (
¹©Œ
è+ 
i
));

447 if(
i
 != 0)

449 
	`sÿm³r_debug
(
__func__
, "type %s†en %d data %s",

450 
¹a_ty³
, 
¹a
->
¹a_Ën
-(
¹©Œ
), 
¹a_d©a
);

454 
	`sÿm³r_debug
(
__func__
, "ty³ %s\n", 
¹a_ty³
);

458 
	}
}

461 
	$¹sock_·r£msg
(
ušt8_t
 *
buf
, 
size_t
 
Ën
)

463 
Æmsghdr
 *
Æmsg
;

464 
Æmsg”r
 *
Æ”r
;

465 
¹msg
 *rtmsg;

466 
¹©Œ
 *
¹a
;

467 *
gwa
 = 
NULL
;

468 
ifšdex
 = -1;

469 
sÿm³r_addr_t
 *
gw
 = 
NULL
;

470 
¹sock_·œ_t
 *
·œ
 = 
NULL
;

471 
sÿm³r_rou‹_t
 *
rou‹
 = 
NULL
;

473 if(
Ën
 < (
Æmsghdr
))

475 
	`sÿm³r_debug
(
__func__
, "ËÀ%d !ğ%d", 
Ën
, (
Æmsghdr
));

479 
Æmsg
 = (
Æmsghdr
 *)
buf
;

482 if(
Æmsg
->
Æmsg_pid
 !ğ
pid
)

485 if((
·œ
 = 
	`¹sock_·œ_g‘
(
Æmsg
->
Æmsg_£q
)è=ğ
NULL
)

487 
rou‹
 = 
·œ
->route;

488 
	`¹sock_·œ_ä“
(
·œ
);

490 if(
Æmsg
->
Æmsg_ty³
 =ğ
RTM_NEWROUTE
)

492 
¹msg
 = 
	`NLMSG_DATA
(
Æmsg
);

495 
Ën
 = 
Æmsg
->
Æmsg_Ën
 - 
	`NLMSG_LENGTH
((
¹msg
));

498 
¹a
 = 
	`RTM_RTA
(
¹msg
);

499 
	`RTA_OK
(
¹a
, 
Ën
))

501 
¹a
->
¹a_ty³
)

503 
RTA_OIF
:

504 
ifšdex
 = *(*)
	`RTA_DATA
(
¹a
);

507 
RTA_GATEWAY
:

508 
gwa
 = 
	`RTA_DATA
(
¹a
);

511 
¹a
 = 
	`RTA_NEXT
Ô, 
Ën
);

514 if(
gwa
 !ğ
NULL
)

516 if(
¹msg
->
¹m_çmy
 =ğ
AF_INET
)

517 
gw
 = 
	`sÿm³r_addrÿche_g‘_v4
(
addrÿche
, 
gwa
);

518 if(
¹msg
->
¹m_çmy
 =ğ
AF_INET6
)

519 
gw
 = 
	`sÿm³r_addrÿche_g‘_v6
(
addrÿche
, 
gwa
);

521 
rou‹
->
”rÜ
 = 
EINVAL
;

524 if(
Æmsg
->
Æmsg_ty³
 =ğ
NLMSG_ERROR
)

526 
Æ”r
 = 
	`NLMSG_DATA
(
Æmsg
);

527 
rou‹
->
”rÜ
 = 
Æ”r
->error;

529 
sk
;

531 
rou‹
->
gw
 = gw;

532 
rou‹
->
ifšdex
 = ifindex;

533 
rou‹
->
	`cb
(route);

537 
sk
:

538 if(
rou‹
 !ğ
NULL
è
	`sÿm³r_rou‹_ä“
(route);

540 
	}
}

543 #ià
defšed
(
HAVE_BSD_ROUTE_SOCKET
)

544 
	$¹sock_·r£msg
(
ušt8_t
 *
buf
, 
size_t
 
Ën
)

546 
¹_msghdr
 *
¹m
;

547 
sockaddr
 *
addrs
[
RTAX_MAX
];

548 
sockaddr_dl
 *
sdl
;

549 
sockaddr
 *
§
;

550 
š6_addr
 *
6
;

551 
size_t
 
off
, 
tmp
, 
x
;

552 
i
, 
ifšdex
;

553 *
addr
;

554 
sÿm³r_addr_t
 *
gw
;

555 
¹sock_·œ_t
 *
·œ
;

556 
sÿm³r_rou‹_t
 *
rou‹
;

558 
x
 = 0;

559 
x
 < 
Ën
)

561 if(
Ën
 - 
x
 < (
¹_msghdr
))

563 
	`sÿm³r_debug
(
__func__
,"ËÀ%d !ğ%d",
Ën
,(
¹_msghdr
));

571 
¹m
 = (
¹_msghdr
 *)(
buf
 + 
x
);

572 if(
¹m
->
¹m_pid
 !ğ
pid
 ||

573 
¹m
->
¹m_msgËn
 > 
Ën
 - 
x
 ||

574 
¹m
->
¹m_ty³
 !ğ
RTM_GET
 ||

575 (
¹m
->
¹m_æags
 & 
RTF_DONE
) == 0 ||

576 (
·œ
 = 
	`¹sock_·œ_g‘
(
¹m
->
¹m_£q
)è=ğ
NULL
)

578 
x
 +ğ
¹m
->
¹m_msgËn
;

582 
rou‹
 = 
·œ
->route;

583 
	`¹sock_·œ_ä“
(
·œ
);

585 
ifšdex
 = -1;

586 
addr
 = 
NULL
;

587 
gw
 = 
NULL
;

589 if(
¹m
->
¹m_”ºo
 != 0)

591 
rou‹
->
”rÜ
 = 
¹m
->
¹m_”ºo
;

592 
dÚe
;

595 
off
 = (
¹_msghdr
);

596 
	`mem£t
(
addrs
, 0, (addrs));

597 
i
=0; i<
RTAX_MAX
; i++)

599 if(
¹m
->
¹m_addrs
 & (1 << 
i
))

601 
addrs
[
i
] = 
§
 = (
sockaddr
 *)(
buf
 + 
x
 + 
off
);

602 if((
tmp
 = 
	`sockaddr_Ën
(
§
)) == -1)

604 
	`´š‹¼Ü
(0,
NULL
,
__func__
,"unhªdËd‡à%d",
§
->
§_çmy
);

605 
rou‹
->
”rÜ
 = 
EINVAL
;

606 
dÚe
;

608 
off
 +ğ
	`sÿm³r_¹sock_roundup
(
tmp
);

612 if((
sdl
 = (
sockaddr_dl
 *)
addrs
[
RTAX_IFP
]è!ğ
NULL
)

614 if(
sdl
->
sdl_çmy
 !ğ
AF_LINK
)

616 
	`´š‹¼Ü
(0, 
NULL
, 
__func__
, "sdl_çmy %d", 
sdl
->
sdl_çmy
);

617 
rou‹
->
”rÜ
 = 
EINVAL
;

618 
dÚe
;

620 
ifšdex
 = 
sdl
->
sdl_šdex
;

623 if((
§
 = 
addrs
[
RTAX_GATEWAY
]è!ğ
NULL
)

625 if(
§
->
§_çmy
 =ğ
AF_INET
)

627 
i
 = 
SCAMPER_ADDR_TYPE_IPV4
;

628 
addr
 = &((
sockaddr_š
 *)
§
)->
sš_addr
;

630 if(
§
->
§_çmy
 =ğ
AF_INET6
)

636 
6
 = &((
sockaddr_š6
 *)
§
)->
sš6_addr
;

637 if(
	`IN6_IS_ADDR_LINKLOCAL
(
6
))

639 
6
->
s6_addr
[2] = 0;

640 
6
->
s6_addr
[3] = 0;

642 
i
 = 
SCAMPER_ADDR_TYPE_IPV6
;

643 
addr
 = 
6
;

645 if(
§
->
§_çmy
 =ğ
AF_LINK
)

647 
sdl
 = (
sockaddr_dl
 *)
§
;

648 if(
sdl
->
sdl_ty³
 =ğ
IFT_ETHER
 && sdl->
sdl_®’
 =ğ
ETHER_ADDR_LEN
)

650 
i
 = 
SCAMPER_ADDR_TYPE_ETHERNET
;

651 
addr
 = 
sdl
->
sdl_d©a
 + sdl->
sdl_Æ’
;

659 if(
addr
 !ğ
NULL
 &&

660 (
gw
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
i
, 
addr
)è=ğ
NULL
)

662 
	`sÿm³r_debug
(
__func__
, "could‚ot get„tsmsg->rr.gw");

663 
rou‹
->
”rÜ
 = 
EINVAL
;

664 
dÚe
;

668 
dÚe
:

669 
rou‹
->
gw
 = gw;

670 
rou‹
->
ifšdex
 = ifindex;

671 
rou‹
->
	`cb
(route);

672 
x
 +ğ
¹m
->
¹m_msgËn
;

676 
	}
}

691 
	$sÿm³r_¹sock_»ad_cb
(cÚ¡ 
fd
, *
·¿m
)

693 
ušt8_t
 
buf
[2048];

694 
ssize_t
 
Ën
;

696 if((
Ën
 = 
	`»cv
(
fd
, 
buf
, (buf), 0)) < 0)

698 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "recv failed");

702 if(
Ën
 > 0)

703 
	`¹sock_·r£msg
(
buf
, 
Ën
);

706 
	}
}

708 
	$sÿm³r_¹sock_şo£
(
fd
)

710 
	`şo£
(
fd
);

712 
	}
}

714 
	$sÿm³r_¹sock_İ’_fd
()

716 #ià
	`defšed
(
HAVE_BSD_ROUTE_SOCKET
)

717  
	`sock‘
(
PF_ROUTE
, 
SOCK_RAW
, 
AF_UNSPEC
);

718 #–ià
	`defšed
(
__lšux__
)

719  
	`sock‘
(
PF_NETLINK
, 
SOCK_DGRAM
, 
NETLINK_ROUTE
);

723 
	}
}

725 
	$sÿm³r_¹sock_İ’
()

727 
fd
;

729 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

730 if((
fd
 = 
	`sÿm³r_¹sock_İ’_fd
()) == -1)

732 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_¹sock
()) == -1)

735 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open„oute socket");

739  
fd
;

740 
	}
}

743 #ifdeà
_WIN32


744 
	$sÿm³r_¹sock_g‘rou‹4
(
sÿm³r_rou‹_t
 *
rou‹
)

746 
š_addr
 *
š
 = 
rou‹
->
d¡
->
addr
;

747 
MIB_IPFORWARDROW
 
fw
;

748 
DWORD
 
dw
;

750 if((
dw
 = 
	`G‘Be¡Rou‹
(
š
->
s_addr
, 0, &
fw
)è!ğ
NO_ERROR
)

752 
rou‹
->
”rÜ
 = 
dw
;

756 
rou‹
->
ifšdex
 = 
fw
.
dwFÜw¬dIfIndex
;

759 if((
dw
 = 
fw
.
dwFÜw¬dNextHİ
) != 0)

761 if((
rou‹
->
gw
 = 
	`sÿm³r_addrÿche_g‘_v4
(
addrÿche
, &
dw
)è=ğ
NULL
)

763 
rou‹
->
”rÜ
 = 
”ºo
;

769 
	}
}

771 
	$sÿm³r_¹sock_g‘rou‹
(
sÿm³r_rou‹_t
 *
rou‹
)

773 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
rou‹
->
d¡
) &&

774 
	`sÿm³r_¹sock_g‘rou‹4
(
rou‹
) == 0)

776 
rou‹
->
	`cb
(route);

781 
	}
}

784 
	$sÿm³r_rou‹_ä“
(
sÿm³r_rou‹_t
 *
rou‹
)

786 if(
rou‹
 =ğ
NULL
)

788 #iâdeà
_WIN32


789 if(
rou‹
->
š‹º®
 !ğ
NULL
)

790 
	`¹sock_·œ_ä“
(
rou‹
->
š‹º®
);

792 if(
rou‹
->
d¡
 !ğ
NULL
)

793 
	`sÿm³r_addr_ä“
(
rou‹
->
d¡
);

794 if(
rou‹
->
gw
 !ğ
NULL
)

795 
	`sÿm³r_addr_ä“
(
rou‹
->
gw
);

796 
	`ä“
(
rou‹
);

798 
	}
}

800 
sÿm³r_rou‹_t
 *
	$sÿm³r_rou‹_®loc
(
sÿm³r_addr_t
 *
d¡
, *
·¿m
,

801 (*
cb
)(
sÿm³r_rou‹_t
 *
¹
))

803 
sÿm³r_rou‹_t
 *
rou‹
;

804 if((
rou‹
 = 
	`m®loc_z”o
((
sÿm³r_rou‹_t
))è=ğ
NULL
)

805  
NULL
;

806 
rou‹
->
d¡
 = 
	`sÿm³r_addr_u£
(dst);

807 
rou‹
->
·¿m
 =…aram;

808 
rou‹
->
cb
 = cb;

809  
rou‹
;

810 
	}
}

812 
	$sÿm³r_¹sock_š™
()

814 #iâdeà
_WIN32


815 if((
·œs
 = 
	`dli¡_®loc
()è=ğ
NULL
)

817 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocate…air†ist");

820 
pid
 = 
	`g‘pid
();

824 
	}
}

826 
	$sÿm³r_¹sock_ş—nup
()

828 #iâdeà
_WIN32


829 
¹sock_·œ_t
 *
·œ
;

831 if(
·œs
 !ğ
NULL
)

833 (
·œ
 = 
	`dli¡_h—d_pİ
(
·œs
)è!ğ
NULL
)

835 
·œ
->
node
 = 
NULL
;

836 
	`¹sock_·œ_ä“
(
·œ
);

839 
	`dli¡_ä“
(
·œs
);

840 
·œs
 = 
NULL
;

845 
	}
}

	@scamper_rtsock.h

25 #iâdeà
__SCAMPER_RTSOCK_H


26 
	#__SCAMPER_RTSOCK_H


	)

28 
sÿm³r_¹sock_š™
();

29 
sÿm³r_¹sock_ş—nup
();

31 
sÿm³r_¹sock_roundup
(
size_t
 
Ën
);

33 
sÿm³r_rou‹
 
	tsÿm³r_rou‹_t
;

35 #ifdeà
__SCAMPER_ADDR_H


36 
sÿm³r_rou‹_t
 *
sÿm³r_rou‹_®loc
(
sÿm³r_addr_t
 *
d¡
, *
·¿m
,

37 (*
cb
)(
sÿm³r_rou‹_t
 *
¹
));

39 
	`sÿm³r_rou‹_ä“
(
sÿm³r_rou‹_t
 *
rou‹
);

41 #iâdeà
_WIN32


42 
	`sÿm³r_¹sock_İ’
();

43 
	`sÿm³r_¹sock_İ’_fd
();

44 
	`sÿm³r_¹sock_»ad_cb
(cÚ¡ 
fd
, *
·¿m
);

45 
	`sÿm³r_¹sock_şo£
(
fd
);

48 #ià
	`defšed
(
_WIN32
)

49 
	`sÿm³r_¹sock_g‘rou‹
(
sÿm³r_rou‹_t
 *
rou‹
);

50 #–ià
	`defšed
(
__SCAMPER_FD_H
)

51 
	`sÿm³r_¹sock_g‘rou‹
(
sÿm³r_fd_t
 *
fd
, 
sÿm³r_rou‹_t
 *
rou‹
);

54 #ià
	`defšed
(
__SCAMPER_ADDR_H
)

55 
	ssÿm³r_rou‹


63 
sÿm³r_addr_t
 *
d¡
;

64 (*
cb
)(
sÿm³r_rou‹_t
 *
¹
);

65 *
·¿m
;

73 
sÿm³r_addr_t
 *
gw
;

74 
ifšdex
;

75 
”rÜ
;

78 *
š‹º®
;

	@scamper_source_cmdline.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_debug.h
"

36 
	~"sÿm³r_sk.h
"

37 
	~"sÿm³r_outfes.h
"

38 
	~"sÿm³r_sourûs.h
"

39 
	~"sÿm³r_sourû_cmdlše.h
"

40 
	~"uts.h
"

42 
	$commªd_as£mbË
(**
out
, 
size_t
 *
Ën
,

43 cÚ¡ *
cmd
, 
size_t
 
cmdËn
, cÚ¡ *
addr
)

45 
size_t
 
add¾’
 = 
	`¡¾’
(
addr
);

46 
size_t
 
»qËn
 = 
cmdËn
 + 1 + 
add¾’
 + 1;

47 *
tmp
;

49 if(
»qËn
 > *
Ën
)

51 if(*
Ën
 != 0)

53 if((
tmp
 = 
	`»®loc
(*
out
, 
»qËn
)è=ğ
NULL
)

55 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

56 "could‚Ù„—Îoø%d by‹ fÜmp", 
»qËn
);

62 if((
tmp
 = 
	`m®loc
(
»qËn
)è=ğ
NULL
)

64 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

65 "could‚Ù m®loø%d by‹ fÜmp", 
»qËn
);

69 
	`memıy
(
tmp
, 
cmd
, 
cmdËn
);

70 
tmp
[
cmdËn
] = ' ';

73 *
out
 = 
tmp
;

74 *
Ën
 = 
»qËn
;

77 
	`memıy
((*
out
)+
cmdËn
+1, 
addr
, 
add¾’
 + 1);

79 
	}
}

81 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_cmdlše_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

82 cÚ¡ *
cmd
,

83 **
¬g
, 
¬g_út
)

85 
sÿm³r_sourû_t
 *
sourû
 = 
NULL
;

86 
size_t
 
cmd_Ën
, 
Ën
 = 0;

87 *
buf
 = 
NULL
;

88 
i
;

90 
s¥
->
ty³
 = 
SCAMPER_SOURCE_TYPE_CMDLINE
;

92 if((
sourû
 = 
	`sÿm³r_sourû_®loc
(
s¥
)è=ğ
NULL
)

94 
”r
;

97 if(
cmd
 !ğ
NULL
)

99 
cmd_Ën
 = 
	`¡¾’
(
cmd
);

100 
i
=0; i<
¬g_út
; i++)

102 if(
	`commªd_as£mbË
(&
buf
, &
Ën
, 
cmd
, 
cmd_Ën
, 
¬g
[
i
]) != 0 ||

103 
	`sÿm³r_sourû_commªd
(
sourû
, 
buf
) != 0)

105 
”r
;

111 
i
=0; i<
¬g_út
; i++)

113 if(
	`sÿm³r_sourû_commªd
(
sourû
, 
¬g
[
i
]) != 0)

114 
”r
;

118 if(
buf
 !ğ
NULL
)

119 
	`ä“
(
buf
);

121  
sourû
;

123 
”r
:

124 if(
sourû
 !ğ
NULL
è
	`sÿm³r_sourû_ä“
(source);

125 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

126  
NULL
;

127 
	}
}

	@scamper_source_cmdline.h

25 #iâdeà
__SCAMPER_SOURCE_CMDLINE_H


26 
	#__SCAMPER_SOURCE_CMDLINE_H


	)

28 
sÿm³r_sourû_t
 *
sÿm³r_sourû_cmdlše_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

29 cÚ¡ *
commªd
,

30 **
¬g
, 
¬g_út
);

	@scamper_source_control.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_sk.h
"

35 
	~"sÿm³r_outfes.h
"

36 
	~"sÿm³r_sourûs.h
"

37 
	~"sÿm³r_debug.h
"

38 
	~"sÿm³r_sourû_cÚŒŞ.h
"

39 
	~"uts.h
"

41 
	ssÿm³r_sourû_cÚŒŞ


44 
sÿm³r_sourû_t
 *
	msourû
;

47 
	misfšished
;

50 (*
	msigÇlmÜe
)(*
	m·¿m
);

51 * (*
	mto¡r
)(*
	m·¿m
, *
	mbuf
, 
size_t
 
	mËn
);

52 *
	m·¿m
;

54 } 
	tsÿm³r_sourû_cÚŒŞ_t
;

62 
	$ssc_ke
(*
d©a
)

64 
sÿm³r_sourû_cÚŒŞ_t
 *
ssc
 = (sÿm³r_sourû_cÚŒŞ_ˆ*)
d©a
;

65 if(
	`sÿm³r_sourû_g‘commªdcouÁ
(
ssc
->
sourû
è=ğ0 && ssc->
isfšished
 == 0)

67 
ssc
->
	`sigÇlmÜe
(ssc->
·¿m
);

70 
	}
}

72 
	$ssc_ä“d©a
(*
d©a
)

74 
	`ä“
(
d©a
);

76 
	}
}

78 
	$ssc_isfšished
(*
d©a
)

80  ((
sÿm³r_sourû_cÚŒŞ_t
 *)
d©a
)->
isfšished
;

81 
	}
}

83 *
	$ssc_to¡r
(*
d©a
, *
¡r
, 
size_t
 
Ën
)

85 
sÿm³r_sourû_cÚŒŞ_t
 *
ssc
 = 
d©a
;

86 
size_t
 
off
 = 0;

87 
buf
[128];

89 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "type control ");

91 if(
ssc
->
	`to¡r
(ssc->
·¿m
, 
buf
, (buf)è!ğ
NULL
)

92 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "% ", 
buf
);

94 if(
ssc
->
isfšished
 == 0)

95 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "more");

97 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "nomore");

99  
¡r
;

100 
	}
}

108 
	$sÿm³r_sourû_cÚŒŞ_fšish
(
sÿm³r_sourû_t
 *
sourû
)

110 
sÿm³r_sourû_cÚŒŞ_t
 *
ssc
;

112 
	`as£¹
(
	`sÿm³r_sourû_g‘ty³
(
sourû
è=ğ
SCAMPER_SOURCE_TYPE_CONTROL
);

113 
ssc
 = (
sÿm³r_sourû_cÚŒŞ_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
);

114 
	`as£¹
(
ssc
 !ğ
NULL
);

116 if(
ssc
->
isfšished
 != 0)

119 
ssc
->
isfšished
 = 1;

120 if(
	`sÿm³r_sourû_isfšished
(
sourû
) != 0)

122 
	`sÿm³r_sourû_fšished
(
sourû
);

126 
	}
}

135 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_cÚŒŞ_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

136 (*
sigÇlmÜe
)(*),

137 *(*
to¡r
)(*,*,
size_t
),

138 *
·¿m
)

140 
sÿm³r_sourû_cÚŒŞ_t
 *
ssc
 = 
NULL
;

141 
sÿm³r_sourû_t
 *
sourû
 = 
NULL
;

143 if(
s¥
 =ğ
NULL
 || 
sigÇlmÜe
 =ğNULL || 
·¿m
 == NULL)

145 
”r
;

149 if((
ssc
 = 
	`m®loc_z”o
((
sÿm³r_sourû_cÚŒŞ_t
))è=ğ
NULL
)

151 
”r
;

153 
ssc
->
sigÇlmÜe
 = signalmore;

154 
ssc
->
·¿m
 =…aram;

155 
ssc
->
to¡r
 =ostr;

158 
s¥
->
d©a
 = 
ssc
;

159 
s¥
->
ke
 = 
ssc_ke
;

160 
s¥
->
ä“d©a
 = 
ssc_ä“d©a
;

161 
s¥
->
isfšished
 = 
ssc_isfšished
;

162 
s¥
->
to¡r
 = 
ssc_to¡r
;

163 
s¥
->
ty³
 = 
SCAMPER_SOURCE_TYPE_CONTROL
;

165 if((
sourû
 = 
	`sÿm³r_sourû_®loc
(
s¥
)è=ğ
NULL
)

167 
”r
;

169 
ssc
->
sourû
 = source;

171  
sourû
;

173 
”r
:

174 if(
ssc
 !ğ
NULL
è
	`ä“
(ssc);

175 if(
sourû
 !ğ
NULL
è
	`sÿm³r_sourû_ä“
(source);

176  
NULL
;

177 
	}
}

	@scamper_source_control.h

24 #iâdeà
__SCAMPER_SOURCE_CONTROL_H


25 
	#__SCAMPER_SOURCE_CONTROL_H


	)

27 
sÿm³r_sourû_t
 *
sÿm³r_sourû_cÚŒŞ_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

28 (*
sigÇlmÜe
)(*),

29 *(*
to¡r
)(*,*,
size_t
),

30 *
·¿m
);

32 
	`sÿm³r_sourû_cÚŒŞ_fšish
(
sÿm³r_sourû_t
 *
sourû
);

	@scamper_source_file.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_debug.h
"

37 
	~"sÿm³r_outfes.h
"

38 
	~"sÿm³r_sk.h
"

39 
	~"sÿm³r_sourûs.h
"

40 
	~"sÿm³r_lš•Şl.h
"

41 
	~"sÿm³r_fds.h
"

42 
	~"sÿm³r_´iv£p.h
"

43 
	~"sÿm³r_sourû_fe.h
"

45 
	~"uts.h
"

47 
	ssÿm³r_sourû_fe


50 
sÿm³r_sourû_t
 *
	msourû
;

53 *
	mf’ame
;

54 *
	mcommªd
;

55 
size_t
 
	mcommªd_Ën
;

56 
	mcyşes
;

57 
	mautÜ–ßd
;

60 
	m»lßd
;

61 
time_t
 
	mmtime
;

62 
sÿm³r_fd_t
 *
	mfd
;

63 
sÿm³r_lš•Şl_t
 *
	mÍ
;

65 } 
	tsÿm³r_sourû_fe_t
;

67 
	g¡dš_u£d
 = 0;

74 
	$ssf_ä“
(
sÿm³r_sourû_fe_t
 *
ssf
)

76 
fd
 = -1;

78 if(
ssf
->
Í
 !ğ
NULL
)

80 
	`sÿm³r_lš•Şl_ä“
(
ssf
->
Í
, 0);

81 
ssf
->
Í
 = 
NULL
;

84 if(
ssf
->
f’ame
 !ğ
NULL
)

86 
	`ä“
(
ssf
->
f’ame
);

87 
ssf
->
f’ame
 = 
NULL
;

90 if(
ssf
->
commªd
 !ğ
NULL
)

92 
	`ä“
(
ssf
->
commªd
);

93 
ssf
->
commªd
 = 
NULL
;

96 if(
ssf
->
fd
 !ğ
NULL
)

98 
fd
 = 
	`sÿm³r_fd_fd_g‘
(
ssf
->fd);

99 
	`sÿm³r_fd_ä“
(
ssf
->
fd
);

100 
ssf
->
fd
 = 
NULL
;

103 if(
fd
 != -1)

105 
	`şo£
(
fd
);

108 
	`ä“
(
ssf
);

110 
	}
}

112 
	$ssf_İ’
(cÚ¡ *
f’ame
)

114 
fd
 = -1;

117 if(
	`¡rcmp
(
f’ame
, "-") != 0)

119 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

120 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

122 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
f’ame
, 
O_RDONLY
, 0);

125 if(
¡dš_u£d
 == 0)

127 
fd
 = 
STDIN_FILENO
;

128 
¡dš_u£d
 = 1;

131 if(
fd
 == -1)

133 
”r
;

136 #ifdeà
O_NONBLOCK


137 if(
	`fú_£t
(
fd
, 
O_NONBLOCK
) == -1)

139 
”r
;

143  
fd
;

145 
”r
:

146 if(
fd
 !ğ-1è
	`şo£
(fd);

148 
	}
}

158 
	$ssf_»ad_lše
(*
·¿m
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

160 
sÿm³r_sourû_fe_t
 *
ssf
 = (sÿm³r_sourû_fe_ˆ*)
·¿m
;

161 
sÿm³r_sourû_t
 *
sourû
 = 
ssf
->source;

162 *
¡r
 = (*)
buf
;

163 
cmd_buf
[256], *
cmd
 = 
NULL
;

164 
size_t
 
»qd_Ën
;

167 if(
	`¡ršg_i¥ršt
(
¡r
, 
Ën
) == 0)

169 
”r
;

172 if(
ssf
->
commªd
 !ğ
NULL
)

175 
	`¡ršg_nuÎ‹rm
(
¡r
, " \r\t#", 
NULL
);

176 if(
¡r
[0] == '\0' || str[0] == '#')

180 
Ën
 = 
	`¡¾’
(
¡r
);

181 if((
cmd_buf
è>ğ(
»qd_Ën
 = 
ssf
->
commªd_Ën
 + 1 + 
Ën
 + 1))

183 
cmd
 = 
cmd_buf
;

187 if((
cmd
 = 
	`m®loc
(
»qd_Ën
)è=ğ
NULL
)

189 
”r
;

194 
	`memıy
(
cmd
, 
ssf
->
commªd
, ssf->
commªd_Ën
);

195 
cmd
[
ssf
->
commªd_Ën
] = ' ';

196 
	`memıy
(
cmd
 + 
ssf
->
commªd_Ën
 + 1, 
¡r
, 
Ën
+1);

200 
	`¡ršg_nuÎ‹rm
(
¡r
, "\r\t#", 
NULL
);

201 if(
¡r
[0] == '\0' || str[0] == '#')

203 
cmd
 = 
¡r
;

207 if(
	`sÿm³r_sourû_commªd
(
sourû
, 
cmd
) != 0)

209 
”r
;

212 if(
cmd
 !ğ
cmd_buf
 && cmd !ğ
¡r
è
	`ä“
(cmd);

215 
”r
:

216 if(
cmd
 !ğ
cmd_buf
 && cmd !ğ
¡r
è
	`ä“
(cmd);

218 
	}
}

220 
	$ssf_»ad
(cÚ¡ 
fd
, *
·¿m
)

222 
sÿm³r_sourû_fe_t
 *
ssf
 = (sÿm³r_sourû_fe_ˆ*)
·¿m
;

223 
sÿm³r_sourû_t
 *
sourû
 = 
ssf
->source;

224 
ušt8_t
 
buf
[1024];

225 
ssize_t
 
rc
;

226 
time_t
 
mtime
;

227 
»lßd
 = 0;

228 
Ãwfd
;

230 
	`as£¹
(
ssf
->
cyşes
 != 0);

232 if((
rc
 = 
	`»ad
(
fd
, 
buf
, (buf))) > 0)

235 
	`sÿm³r_lš•Şl_hªdË
(
ssf
->
Í
, 
buf
, (
size_t
)
rc
);

241 if(
	`sÿm³r_sourû_g‘commªdcouÁ
(
sourû
è>ğ
	`sÿm³r_µs_g‘
())

243 
	`sÿm³r_fd_»ad_·u£
(
ssf
->
fd
);

246 if(
rc
 =ğ0 && 
ssf
->
cyşes
 == 1)

249 
	`sÿm³r_lš•Şl_æush
(
ssf
->
Í
);

250 
ssf
->
cyşes
 = 0;

251 
	`sÿm³r_fd_»ad_·u£
(
ssf
->
fd
);

253 if(
rc
 == 0)

255 
	`sÿm³r_lš•Şl_æush
(
ssf
->
Í
);

258 if(
ssf
->
cyşes
 != -1)

260 
ssf
->
cyşes
--;

264 if(
ssf
->
»lßd
 == 1)

267 if(
	`¡©_mtime
(
ssf
->
f’ame
, &
mtime
) == 0)

269 
»lßd
 = 1;

272 if(
ssf
->
autÜ–ßd
 == 1)

278 if(
	`¡©_mtime
(
ssf
->
f’ame
, &
mtime
) == 0 && ssf->mtime != mtime)

280 
»lßd
 = 1;

285 if(
»lßd
 =ğ1 && (
Ãwfd
 = 
	`ssf_İ’
(
ssf
->
f’ame
)) != -1)

288 if(
	`sÿm³r_fd_fd_£t
(
ssf
->
fd
, 
Ãwfd
) == -1)

290 
”r
;

294 
	`şo£
(
fd
);

297 
ssf
->
mtime
 = mtime;

298 
ssf
->
»lßd
 = 0;

303 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
) == -1)

305 
”r
;

310 if(
	`sÿm³r_sourû_g‘cyşecouÁ
(
ssf
->
sourû
) < 1)

312 
	`sÿm³r_fd_»ad_uÅau£
(
ssf
->
fd
);

316 
	`sÿm³r_fd_»ad_·u£
(
ssf
->
fd
);

320 if(
	`sÿm³r_sourû_cyşe
(
sourû
) != 0)

322 
”r
;

327 
	`as£¹
(
rc
 == -1);

329 if(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

331 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "»ad faed fd %d", 
fd
);

332 
”r
;

338 
”r
:

344 
ssf
->
cyşes
 = 0;

346 
	}
}

353 *
	$ssf_to¡r
(*
d©a
, *
¡r
, 
size_t
 
Ën
)

355 
sÿm³r_sourû_fe_t
 *
ssf
 = (sÿm³r_sourû_fe_ˆ*)
d©a
;

356 
size_t
 
off
 = 0;

358 if(
Ën
 < 1)

359  
NULL
;

361 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "type file ");

363 if(
ssf
->
fd
 !ğ
NULL
)

364 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "fd %d ", 
	`sÿm³r_fd_fd_g‘
(
ssf
->
fd
));

366 if(
ssf
->
f’ame
 !ğ
NULL
)

367 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "f\"%s\" ", 
ssf
->
f’ame
);

369 if(
ssf
->
commªd
 !ğ
NULL
)

370 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "cmd \"%s\" ", 
ssf
->
commªd
);

372 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "cyşe %d", 
ssf
->
cyşes
);

373  
¡r
;

374 
	}
}

381 
	$ssf_ke
(*
d©a
)

383 
sÿm³r_sourû_fe_t
 *
ssf
 = (sÿm³r_sourû_fe_ˆ*)
d©a
;

385 if(
	`sÿm³r_sourû_g‘cyşecouÁ
(
ssf
->
sourû
) < 2 &&

386 
	`sÿm³r_sourû_g‘commªdcouÁ
(
ssf
->
sourû
è< 
	`sÿm³r_µs_g‘
() &&

387 
ssf
->
cyşes
 != 0)

389 
	`sÿm³r_fd_»ad_uÅau£
(
ssf
->
fd
);

393 
	}
}

395 
	$ssf_ä“d©a
(*
d©a
)

397 
	`ssf_ä“
((
sÿm³r_sourû_fe_t
 *)
d©a
);

399 
	}
}

408 
	$ssf_isfšished
(*
d©a
)

410 
sÿm³r_sourû_fe_t
 *
ssf
 = (sÿm³r_sourû_fe_ˆ*)
d©a
;

412 if(
ssf
->
cyşes
 != 0)

418 
	}
}

420 
	$sÿm³r_sourû_fe_g‘cyşes
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

422 
sÿm³r_sourû_fe_t
 *
ssf
;

424 if((
ssf
 = (
sÿm³r_sourû_fe_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
)è!ğ
NULL
)

426  
ssf
->
cyşes
;

430 
	}
}

432 
	$sÿm³r_sourû_fe_g‘autÜ–ßd
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

434 
sÿm³r_sourû_fe_t
 *
ssf
;

436 if((
ssf
 = (
sÿm³r_sourû_fe_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
)è!ğ
NULL
)

438  
ssf
->
autÜ–ßd
;

442 
	}
}

444 cÚ¡ *
	$sÿm³r_sourû_fe_g‘f’ame
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

446 
sÿm³r_sourû_fe_t
 *
ssf
;

448 if((
ssf
 = (
sÿm³r_sourû_fe_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
)è!ğ
NULL
)

450  
ssf
->
f’ame
;

453  
NULL
;

454 
	}
}

456 
	$sÿm³r_sourû_fe_upd©e
(
sÿm³r_sourû_t
 *
sourû
,

457 cÚ¡ *
autÜ–ßd
, cÚ¡ *
cyşes
)

459 
sÿm³r_sourû_fe_t
 *
ssf
;

460 
sÿm³r_sourû_ev’t_t
 
s£
;

462 if(
	`sÿm³r_sourû_g‘ty³
(
sourû
è!ğ
SCAMPER_SOURCE_TYPE_FILE
 ||

463 (
ssf
 = (
sÿm³r_sourû_fe_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
)è=ğ
NULL
)

468 
	`mem£t
(&
s£
, 0, (sse));

470 if(
autÜ–ßd
 !ğ
NULL
)

472 
s£
.
s£_upd©e_æags
 |= 0x01;

473 
s£
.
s£_upd©e_autÜ–ßd
 = *
autÜ–ßd
;

474 
ssf
->
autÜ–ßd
 = *autoreload;

477 if(
cyşes
 !ğ
NULL
)

479 
s£
.
s£_upd©e_æags
 |= 0x02;

480 
s£
.
s£_upd©e_cyşes
 = *
cyşes
;

481 
ssf
->
cyşes
 = *cycles;

484 if(
s£
.
s£_upd©e_æags
 != 0)

486 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_UPDATE
, &
s£
);

490 
	}
}

492 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_fe_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

493 cÚ¡ *
f’ame
,

494 cÚ¡ *
commªd
,

495 
cyşes
, 
autÜ–ßd
)

497 
sÿm³r_sourû_fe_t
 *
ssf
 = 
NULL
;

498 
fd
 = -1;

501 if(
s¥
 =ğ
NULL
 || 
f’ame
 == NULL)

503 
”r
;

507 if((
ssf
 = 
	`m®loc_z”o
((
sÿm³r_sourû_fe_t
))è=ğ
NULL
 ||

508 (
ssf
->
f’ame
 = 
	`¡rdup
(f’ame)è=ğ
NULL
)

510 
”r
;

512 
ssf
->
cyşes
 = cycles;

513 
ssf
->
autÜ–ßd
 =‡utoreload;

516 if(
commªd
 !ğ
NULL
)

518 if((
ssf
->
commªd
 = 
	`¡rdup
(commªd)è=ğ
NULL
)

519 
”r
;

520 
ssf
->
commªd_Ën
 = 
	`¡¾’
(ssf->
commªd
);

523 if((
fd
 = 
	`ssf_İ’
(
f’ame
)) == -1)

525 
”r
;

529 if((
ssf
->
fd
 = 
	`sÿm³r_fd_´iv©e
(fd, 
ssf_»ad
, ssf, 
NULL
, NULL)) == NULL)

531 
”r
;

533 
fd
 = -1;

535 if((
ssf
->
Í
 = 
	`sÿm³r_lš•Şl_®loc
(
ssf_»ad_lše
, ssf)è=ğ
NULL
)

537 
”r
;

543 
s¥
->
d©a
 = 
ssf
;

544 
s¥
->
ke
 = 
ssf_ke
;

545 
s¥
->
ä“d©a
 = 
ssf_ä“d©a
;

546 
s¥
->
isfšished
 = 
ssf_isfšished
;

547 
s¥
->
to¡r
 = 
ssf_to¡r
;

548 
s¥
->
ty³
 = 
SCAMPER_SOURCE_TYPE_FILE
;

551 if((
ssf
->
sourû
 = 
	`sÿm³r_sourû_®loc
(
s¥
)è=ğ
NULL
)

553 
”r
;

556  
ssf
->
sourû
;

558 
”r
:

559 if(
ssf
 !ğ
NULL
)

561 
	`as£¹
(
ssf
->
sourû
 =ğ
NULL
);

562 
	`ssf_ä“
(
ssf
);

564 if(
fd
 !ğ-1è
	`şo£
(fd);

565  
NULL
;

566 
	}
}

	@scamper_source_file.h

25 #iâdeà
__SCAMPER_SOURCE_FILE_H


26 
	#__SCAMPER_SOURCE_FILE_H


	)

28 
sÿm³r_sourû_t
 *
sÿm³r_sourû_fe_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

29 cÚ¡ *
f’ame
,

30 cÚ¡ *
commªd
,

31 
cyşes
, 
autÜ–ßd
);

33 cÚ¡ *
sÿm³r_sourû_fe_g‘f’ame
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

34 
sÿm³r_sourû_fe_g‘cyşes
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

35 
sÿm³r_sourû_fe_g‘autÜ–ßd
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

37 
sÿm³r_sourû_fe_upd©e
(
sÿm³r_sourû_t
 *
sourû
,

38 cÚ¡ *
autÜ–ßd
, cÚ¡ *
cyşes
);

	@scamper_source_tsps.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r.h
"

36 
	~"sÿm³r_debug.h
"

37 
	~"sÿm³r_outfes.h
"

38 
	~"sÿm³r_sk.h
"

39 
	~"sÿm³r_sourûs.h
"

40 
	~"sÿm³r_lš•Şl.h
"

41 
	~"sÿm³r_fds.h
"

42 
	~"sÿm³r_´iv£p.h
"

43 
	~"sÿm³r_sourû_t¥s.h
"

44 
	~"uts.h
"

46 
	ssÿm³r_sourû_t¥s


48 
sÿm³r_sourû_t
 *
	msourû
;

49 *
	mf’ame
;

50 
sÿm³r_fd_t
 *
	mfd
;

51 
sÿm³r_lš•Şl_t
 *
	mÍ
;

52 
	mdÚe
;

53 } 
	tsÿm³r_sourû_t¥s_t
;

55 
	g¡dš_u£d
 = 0;

62 
	$ssf_ä“
(
sÿm³r_sourû_t¥s_t
 *
ssf
)

64 
fd
 = -1;

66 if(
ssf
->
Í
 !ğ
NULL
)

68 
	`sÿm³r_lš•Şl_ä“
(
ssf
->
Í
, 0);

69 
ssf
->
Í
 = 
NULL
;

72 if(
ssf
->
f’ame
 !ğ
NULL
)

74 
	`ä“
(
ssf
->
f’ame
);

75 
ssf
->
f’ame
 = 
NULL
;

78 if(
ssf
->
fd
 !ğ
NULL
)

80 
fd
 = 
	`sÿm³r_fd_fd_g‘
(
ssf
->fd);

81 
	`sÿm³r_fd_ä“
(
ssf
->
fd
);

82 
ssf
->
fd
 = 
NULL
;

85 if(
fd
 != -1)

87 
	`şo£
(
fd
);

90 
	`ä“
(
ssf
);

92 
	}
}

94 
	$ssf_İ’
(cÚ¡ *
f’ame
)

96 
fd
 = -1;

99 if(
	`¡rcmp
(
f’ame
, "-") != 0)

101 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

102 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

104 
fd
 = 
	`sÿm³r_´iv£p_İ’_fe
(
f’ame
, 
O_RDONLY
, 0);

107 if(
¡dš_u£d
 == 0)

109 
fd
 = 1;

110 
¡dš_u£d
 = 1;

113 if(
fd
 == -1)

114 
”r
;

116 #ifdeà
O_NONBLOCK


117 if(
	`fú_£t
(
fd
, 
O_NONBLOCK
) == -1)

118 
”r
;

121  
fd
;

123 
”r
:

124 if(
fd
 !ğ-1è
	`şo£
(fd);

126 
	}
}

136 
	$ssf_»ad_lše
(*
·¿m
, 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

138 
sÿm³r_sourû_t¥s_t
 *
ssf
 = (sÿm³r_sourû_t¥s_ˆ*)
·¿m
;

139 
sÿm³r_sourû_t
 *
sourû
 = 
ssf
->source;

140 *
¡r
 = (*)
buf
;

141 *
b™s
[5];

142 
i
, 
b™c
 = 0;

143 
cb
[256];

144 
size_t
 
off
 = 0;

147 if(
	`¡ršg_i¥ršt
(
¡r
, 
Ën
) == 0)

148 
”r
;

151 if(
¡r
[0] == '\0' || str[0] == '#')

156 if(
b™c
 == 5)

157 
”r
;

159 
b™s
[
b™c
++] = 
¡r
;

160 
	`isdig™
(()*
¡r
) != 0 || *str == '.')

161 
¡r
++;

163 if(*
¡r
 == '\0')

166 if(*
¡r
 == ' ' || *str == '\t')

168 *
¡r
 = '\0'; str++;

169 if(*
¡r
 == '\0')

170 
”r
;

173 
”r
;

176 
	`¡ršg_cÚÿt
(
cb
, (cb), &
off
, "ping");

177 if(
b™c
 > 1)

179 
	`¡ršg_cÚÿt
(
cb
, (cb), &
off
, " -T¥»¥ec=%s", 
b™s
[1]);

180 
i
=2; i<
b™c
; i++)

181 
	`¡ršg_cÚÿt
(
cb
, (cb), &
off
, ",%s", 
b™s
[
i
]);

183 
	`¡ršg_cÚÿt
(
cb
, (cb), &
off
, " %s", 
b™s
[0]);

185 if(
	`sÿm³r_sourû_commªd
(
sourû
, 
cb
) != 0)

186 
”r
;

190 
”r
:

192 
	}
}

194 
	$ssf_»ad
(cÚ¡ 
fd
, *
·¿m
)

196 
sÿm³r_sourû_t¥s_t
 *
ssf
 = (sÿm³r_sourû_t¥s_ˆ*)
·¿m
;

197 
sÿm³r_sourû_t
 *
sourû
 = 
ssf
->source;

198 
ušt8_t
 
buf
[1024];

199 
ssize_t
 
rc
;

201 
	`as£¹
(
ssf
->
dÚe
 == 0);

203 if((
rc
 = 
	`»ad
(
fd
, 
buf
, (buf))) > 0)

206 
	`sÿm³r_lš•Şl_hªdË
(
ssf
->
Í
, 
buf
, (
size_t
)
rc
);

212 if(
	`sÿm³r_sourû_g‘commªdcouÁ
(
sourû
è>ğ
	`sÿm³r_µs_g‘
())

214 
	`sÿm³r_fd_»ad_·u£
(
ssf
->
fd
);

217 if(
rc
 == 0)

219 
	`sÿm³r_lš•Şl_æush
(
ssf
->
Í
);

220 
ssf
->
dÚe
 = 1;

221 
	`sÿm³r_fd_»ad_·u£
(
ssf
->
fd
);

225 if(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
)

227 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "read failed");

228 
”r
;

234 
”r
:

240 
ssf
->
dÚe
 = 1;

242 
	}
}

244 
	$ssf_ke
(*
d©a
)

246 
sÿm³r_sourû_t¥s_t
 *
ssf
 = (sÿm³r_sourû_t¥s_ˆ*)
d©a
;

248 if(
	`sÿm³r_sourû_g‘commªdcouÁ
(
ssf
->
sourû
è< 
	`sÿm³r_µs_g‘
() &&

249 
ssf
->
dÚe
 == 0)

251 
	`sÿm³r_fd_»ad_uÅau£
(
ssf
->
fd
);

254 
	}
}

256 
	$ssf_ä“d©a
(*
d©a
)

258 
	`ssf_ä“
((
sÿm³r_sourû_t¥s_t
 *)
d©a
);

260 
	}
}

262 
	$ssf_isfšished
(*
d©a
)

264 
sÿm³r_sourû_t¥s_t
 *
ssf
 = (sÿm³r_sourû_t¥s_ˆ*)
d©a
;

265  
ssf
->
dÚe
;

266 
	}
}

268 cÚ¡ *
	$sÿm³r_sourû_t¥s_g‘f’ame
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

270 
sÿm³r_sourû_t¥s_t
 *
ssf
;

271 if((
ssf
 = (
sÿm³r_sourû_t¥s_t
 *)
	`sÿm³r_sourû_g‘d©a
(
sourû
)è!ğ
NULL
)

272  
ssf
->
f’ame
;

273  
NULL
;

274 
	}
}

276 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_t¥s_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

277 cÚ¡ *
f’ame
)

279 
sÿm³r_sourû_t¥s_t
 *
ssf
 = 
NULL
;

280 
fd
 = -1;

283 if(
s¥
 =ğ
NULL
 || 
f’ame
 == NULL)

285 
”r
;

289 if((
ssf
 = 
	`m®loc_z”o
((
sÿm³r_sourû_t¥s_t
))è=ğ
NULL
 ||

290 (
ssf
->
f’ame
 = 
	`¡rdup
(f’ame)è=ğ
NULL
)

292 
”r
;

295 if((
fd
 = 
	`ssf_İ’
(
f’ame
)) == -1)

297 
”r
;

301 if((
ssf
->
fd
 = 
	`sÿm³r_fd_´iv©e
(fd, 
ssf_»ad
, ssf, 
NULL
, NULL)) == NULL)

303 
”r
;

305 
fd
 = -1;

307 if((
ssf
->
Í
 = 
	`sÿm³r_lš•Şl_®loc
(
ssf_»ad_lše
, ssf)è=ğ
NULL
)

309 
”r
;

315 
s¥
->
d©a
 = 
ssf
;

316 
s¥
->
ke
 = 
ssf_ke
;

317 
s¥
->
ä“d©a
 = 
ssf_ä“d©a
;

318 
s¥
->
isfšished
 = 
ssf_isfšished
;

319 
s¥
->
ty³
 = 
SCAMPER_SOURCE_TYPE_TSPS
;

322 if((
ssf
->
sourû
 = 
	`sÿm³r_sourû_®loc
(
s¥
)è=ğ
NULL
)

324 
”r
;

327  
ssf
->
sourû
;

329 
”r
:

330 if(
ssf
 !ğ
NULL
)

332 
	`as£¹
(
ssf
->
sourû
 =ğ
NULL
);

333 
	`ssf_ä“
(
ssf
);

335 if(
fd
 !ğ-1è
	`şo£
(fd);

336  
NULL
;

337 
	}
}

	@scamper_source_tsps.h

24 #iâdeà
__SCAMPER_SOURCE_TSPS_H


25 
	#__SCAMPER_SOURCE_TSPS_H


	)

27 
sÿm³r_sourû_t
 *
sÿm³r_sourû_t¥s_®loc
(
sÿm³r_sourû_·¿ms_t
 *
s¥
,

28 cÚ¡ *
f’ame
);

30 cÚ¡ *
sÿm³r_sourû_t¥s_g‘f’ame
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

	@scamper_sources.c

28 #iâdeà
lšt


29 cÚ¡ 
	grcsid
[] =

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

36 
	~"š‹º®.h
"

38 
	~"sÿm³r.h
"

39 
	~"sÿm³r_addr.h
"

40 
	~"sÿm³r_li¡.h
"

41 
	~"sÿm³r_sk.h
"

42 
	~"sÿm³r_fe.h
"

43 
	~"sÿm³r_outfes.h
"

44 
	~"sÿm³r_sourûs.h
"

45 
	~"sÿm³r_cyşemÚ.h
"

47 
	~"Œaû/sÿm³r_Œaû_do.h
"

48 
	~"pšg/sÿm³r_pšg_do.h
"

49 
	~"Œaûlb/sÿm³r_Œaûlb_do.h
"

50 
	~"d—lŸs/sÿm³r_d—lŸs_do.h
"

51 
	~"¡šg/sÿm³r_¡šg_do.h
"

52 
	~"Ãighbourdisc/sÿm³r_Ãighbourdisc_do.h
"

53 
	~"tb™/sÿm³r_tb™_do.h
"

54 
	~"Œaûbox/sÿm³r_Œaûbox_do.h
"

55 
	~"¢iff/sÿm³r_¢iff_do.h
"

56 
	~"årštšg/sÿm³r_årštšg_do.h
"

58 
	~"sÿm³r_debug.h
"

60 
	~"uts.h
"

61 
	~"mjl_li¡.h
"

62 
	~"mjl_¥ÏyŒ“.h
"

72 
	ssÿm³r_sourû


75 
sÿm³r_li¡_t
 *
	mli¡
;

76 
sÿm³r_cyşe_t
 *
	mcyşe
;

79 
ušt32_t
 
	m´iÜ™y
;

80 
	mty³
;

81 
	m»fút
;

82 
sÿm³r_outfe_t
 *
	msof
;

83 
sÿm³r_cyşemÚ_t
 *
	mcyşemÚ
;

94 
dli¡_t
 *
	mcommªds
;

95 
	mcyşe_pošts
;

96 
dli¡_t
 *
	mÚhŞd
;

97 
dli¡_t
 *
	msks
;

98 
ušt32_t
 
	mid
;

99 
¥ÏyŒ“_t
 *
	midŒ“
;

105 *
	mli¡_
;

106 *
	mli¡_node
;

107 
¥ÏyŒ“_node_t
 *
	mŒ“_node
;

110 *
	md©a
;

111 (*
	mke
)(*
	md©a
);

112 (*
	mä“d©a
)(*
	md©a
);

113 (*
	misfšished
)(*
	md©a
);

114 * (*
	mto¡r
)(*
	md©a
, *
	m¡r
, 
size_t
 
	mËn
);

117 
	ssÿm³r_sourûsk


119 
sÿm³r_sourû_t
 *
	msourû
;

120 
sÿm³r_sk_t
 *
	msk
;

121 
dli¡_node_t
 *
	mnode
;

122 
ušt32_t
 
	mid
;

123 
¥ÏyŒ“_node_t
 *
	midnode
;

136 
	ssÿm³r_sourû_ob£rv”


138 
sÿm³r_sourû_ev’tf_t
 
	mfunc
;

139 *
	m·¿m
;

140 
dli¡_node_t
 *
	mnode
;

149 
	scommªd_func


151 *
	mcommªd
;

152 
size_t
 
	mËn
;

153 *(*
	m®locd©a
)(*);

154 
	msÿm³r_sk_t
 *(*
	m®loùask
)(*, 
	msÿm³r_li¡_t
 *, 
	msÿm³r_cyşe_t
 *);

155 (*
	mä“d©a
)(*
	md©a
);

156 } 
	tcommªd_func_t
;

158 cÚ¡ 
commªd_func_t
 
	gcommªd_funcs
[] = {

161 
sÿm³r_do_Œaû_®loc
,

162 
sÿm³r_do_Œaû_®loùask
,

163 
sÿm³r_do_Œaû_ä“
,

167 
sÿm³r_do_pšg_®loc
,

168 
sÿm³r_do_pšg_®loùask
,

169 
sÿm³r_do_pšg_ä“
,

173 
sÿm³r_do_Œaûlb_®loc
,

174 
sÿm³r_do_Œaûlb_®loùask
,

175 
sÿm³r_do_Œaûlb_ä“
,

179 
sÿm³r_do_d—lŸs_®loc
,

180 
sÿm³r_do_d—lŸs_®loùask
,

181 
sÿm³r_do_d—lŸs_ä“
,

185 
sÿm³r_do_¡šg_®loc
,

186 
sÿm³r_do_¡šg_®loùask
,

187 
sÿm³r_do_¡šg_ä“
,

191 
sÿm³r_do_Ãighbourdisc_®loc
,

192 
sÿm³r_do_Ãighbourdisc_®loùask
,

193 
sÿm³r_do_Ãighbourdisc_ä“
,

197 
sÿm³r_do_tb™_®loc
,

198 
sÿm³r_do_tb™_®loùask
,

199 
sÿm³r_do_tb™_ä“
,

203 
sÿm³r_do_Œaûbox_®loc
,

204 
sÿm³r_do_Œaûbox_®loùask
,

205 
sÿm³r_do_Œaûbox_ä“
,

209 
sÿm³r_do_¢iff_®loc
,

210 
sÿm³r_do_¢iff_®loùask
,

211 
sÿm³r_do_¢iff_ä“
,

215 
sÿm³r_do_årštšg_®loc
,

216 
sÿm³r_do_årštšg_®loùask
,

217 
sÿm³r_do_årštšg_ä“
,

221 
size_t
 
	gcommªd_funcc
 = (
commªd_funcs
è/ (
commªd_func_t
);

231 
	scommªd


233 
ušt8_t
 
	mty³
;

237 
	scommªd_´obe


239 cÚ¡ 
commªd_func_t
 *
	mfuncs
;

240 *
	md©a
;

241 
sÿm³r_cyşemÚ_t
 *
	mcyşemÚ
;

242 } 
	m´
;

243 
sÿm³r_cyşe_t
 *
	mcyşe
;

244 
sÿm³r_sourûsk_t
 *
	msourûsk
;

245 } 
	mun
;

246 } 
	tcommªd_t
;

248 
	#COMMAND_PROBE
 0x00

	)

249 
	#COMMAND_CYCLE
 0x01

	)

250 
	#COMMAND_TASK
 0x02

	)

252 
	#COMMAND_TYPE_MIN
 0x00

	)

253 
	#COMMAND_TYPE_MAX
 0x02

	)

266 
	scommªd_ÚhŞd


268 
sÿm³r_sk_t
 *
	mblock
;

269 
sÿm³r_sourûsk_t
 *
	m¡
;

270 
sÿm³r_sourû_t
 *
	msourû
;

271 
dli¡_node_t
 *
	mnode
;

272 *
	mcook›
;

273 } 
	tcommªd_ÚhŞd_t
;

289 
şi¡_t
 *
	gaùive
 = 
NULL
;

290 
dli¡_t
 *
	gblocked
 = 
NULL
;

291 
dli¡_t
 *
	gfšished
 = 
NULL
;

292 
sÿm³r_sourû_t
 *
	gsourû_cur
 = 
NULL
;

293 
ušt32_t
 
	gsourû_út
 = 0;

294 
¥ÏyŒ“_t
 *
	gsourû_Œ“
 = 
NULL
;

295 
dli¡_t
 *
	gob£rv”s
 = 
NULL
;

298 
sourû_ä“
(
sÿm³r_sourû_t
 *
sourû
);

300 #ià!
defšed
(
NDEBUG
è&& defšed(
SOURCES_DEBUG
)

301 
	$commªd_as£¹
(*
™em
, *
·¿m
)

303 
commªd_t
 *
c
 = 
™em
;

304 *
cyşes
 = 
·¿m
;

306 
	`as£¹
(
c
->
ty³
 <ğ
COMMAND_TYPE_MAX
);

308 
c
->
ty³
)

310 
COMMAND_PROBE
:

311 
	`as£¹
(
c
->
un
.
´
.
d©a
 !ğ
NULL
);

312 
	`as£¹
(
c
->
un
.
´
.
cyşemÚ
 !ğ
NULL
);

315 
COMMAND_TASK
:

316 
	`as£¹
(
c
->
un
.
sourûsk
 !ğ
NULL
);

319 
COMMAND_CYCLE
:

320 *
cyşes
 = *cycles + 1;

325 
	}
}

327 
	$sourû_as£¹
(*
™em
, *
·¿m
)

329 
sÿm³r_sourû_t
 *
s
 = 
™em
;

330 
commªd_ÚhŞd_t
 *
c
;

331 
dli¡_node_t
 *
dn
;

332 
cyşes
;

335 
	`as£¹
(
s
->
»fút
 > 0);

336 if(
s
->
li¡
 !ğ
NULL
)

337 
	`as£¹
(
s
->
li¡
->
»fút
 > 0);

338 if(
s
->
cyşe
 !ğ
NULL
)

339 
	`as£¹
(
s
->
cyşe
->
»fút
 > 0);

340 if(
s
->
sof
 !ğ
NULL
)

341 
	`as£¹
(
	`sÿm³r_outfe_g‘»fút
(
s
->
sof
) > 0);

344 
	`as£¹
(
s
->
ty³
 >ğ
SCAMPER_SOURCE_TYPE_MIN
);

345 
	`as£¹
(
s
->
ty³
 <ğ
SCAMPER_SOURCE_TYPE_MAX
);

346 
	`as£¹
(
s
->
sks
 !ğ
NULL
);

349 
	`as£¹
(
s
->
li¡_
 !ğ
NULL
);

350 
	`as£¹
(
s
->
li¡_
 =ğ
aùive
 || s->li¡_ =ğ
blocked
 || s->li¡_ =ğ
fšished
);

351 
	`as£¹
(
s
->
li¡_
 =ğ
·¿m
);

354 
	`as£¹
(
s
->
commªds
 !ğ
NULL
);

355 
cyşes
 = 0;

356 
	`dli¡_fÜ—ch
(
s
->
commªds
, 
commªd_as£¹
, &
cyşes
);

360 
	`as£¹
(
s
->
ÚhŞd
 !ğ
NULL
);

361 
dn
=
	`dli¡_h—d_node
(
s
->
ÚhŞd
); dÀ!ğ
NULL
; dÀğ
	`dli¡_node_Ãxt
(dn))

363 
c
 = 
	`dli¡_node_™em
(
dn
);

364 
	`as£¹
(
c
->
node
 =ğ
dn
);

365 
	`as£¹
(
c
->
sourû
 =ğ
s
);

369 
	}
}

371 
	$sourûs_as£¹
()

373 
	`as£¹
(
aùive
 !ğ
NULL
);

374 
	`şi¡_fÜ—ch
(
aùive
, 
sourû_as£¹
,‡ctive);

375 
	`as£¹
(
blocked
 !ğ
NULL
);

376 
	`dli¡_fÜ—ch
(
blocked
, 
sourû_as£¹
, blocked);

377 
	`as£¹
(
fšished
 !ğ
NULL
);

378 
	`dli¡_fÜ—ch
(
fšished
, 
sourû_as£¹
, finished);

380 
	}
}

382 
	#sourûs_as£¹
()(()0)

	)

385 
	$sourû_»fút_dec
(
sÿm³r_sourû_t
 *
sourû
)

387 
	`as£¹
(
sourû
->
»fút
 > 0);

388 
sourû
->
»fút
--;

389  
sourû
->
»fút
;

390 
	}
}

398 
	$sourû_ev’t_po¡_cb
(*
™em
, *
·¿m
)

400 
sÿm³r_sourû_ob£rv”_t
 *
ob£rv”
 = (sÿm³r_sourû_ob£rv”_ˆ*)
™em
;

401 
sÿm³r_sourû_ev’t_t
 *
ev’t
 = (sÿm³r_sourû_ev’t_ˆ*)
·¿m
;

402 
ob£rv”
->
	`func
(
ev’t
, ob£rv”->
·¿m
);

404 
	}
}

411 
	$sÿm³r_sourû_ev’t_po¡
(
sÿm³r_sourû_t
 *
sourû
, 
ty³
,

412 
sÿm³r_sourû_ev’t_t
 *
ev
)

414 
sÿm³r_sourû_ev’t_t
 
s£
;

415 
timev®
 
tv
;

418 if(
ob£rv”s
 =ğ
NULL
)

422 if(
ev
 =ğ
NULL
)

424 
	`mem£t
(&
s£
, 0, (sse));

425 
ev
 = &
s£
;

428 
	`g‘timeofday_w¿p
(&
tv
);

429 
ev
->
sourû
 = source;

430 
ev
->
ev’t
 = 
ty³
;

431 
ev
->
£c
 = 
tv
.
tv_£c
;

432 
	`dli¡_fÜ—ch
(
ob£rv”s
, 
sourû_ev’t_po¡_cb
, 
ev
);

435 
	}
}

437 
sÿm³r_sourûsk_t
 *
	$sourûsk_®loc
(
sÿm³r_sourû_t
 *
sourû
,

438 
sÿm³r_sk_t
 *
sk
)

440 
sÿm³r_sourûsk_t
 *
¡
 = 
NULL
;

441 if((
¡
 = 
	`m®loc_z”o
((
sÿm³r_sourûsk_t
))è=ğ
NULL
)

442 
”r
;

443 if((
¡
->
node
 = 
	`dli¡__push
(
sourû
->
sks
, st)è=ğ
NULL
)

444 
”r
;

445 
¡
->
sourû
 = 
	`sÿm³r_sourû_u£
(source);

446 
¡
->
sk
 =ask;

447  
¡
;

449 
”r
:

450 if(
¡
 !ğ
NULL
è
	`ä“
(st);

451  
NULL
;

452 
	}
}

454 
	$idŒ“_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

456 cÚ¡ 
sÿm³r_sourûsk_t
 *
a
 = 
va
;

457 cÚ¡ 
sÿm³r_sourûsk_t
 *
b
 = 
vb
;

458 if(
a
->
id
 < 
b
->id)  -1;

459 if(
a
->
id
 > 
b
->id)  1;

461 
	}
}

463 
commªd_t
 *
	$commªd_®loc
(
ty³
)

465 
commªd_t
 *
cmd
;

466 if((
cmd
 = 
	`m®loc_z”o
((
commªd_t
))è=ğ
NULL
)

468 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc command");

469  
NULL
;

471 
cmd
->
ty³
 =ype;

472  
cmd
;

473 
	}
}

475 
	$commªd_ä“
(
commªd_t
 *
commªd
)

477 if(
commªd
->
ty³
 =ğ
COMMAND_PROBE
)

479 if(
commªd
->
un
.
´
.
funcs
->
ä“d©a
 !ğ
NULL
 && commªd->un.´.
d©a
 != NULL)

480 
commªd
->
un
.
´
.
funcs
->
	`ä“d©a
(commªd->un.´.
d©a
);

481 if(
commªd
->
un
.
´
.
cyşemÚ
 !ğ
NULL
)

482 
	`sÿm³r_cyşemÚ_unu£
(
commªd
->
un
.
´
.
cyşemÚ
);

485 
	`ä“
(
commªd
);

487 
	}
}

494 
	$commªd_cyşe
(
sÿm³r_sourû_t
 *
sourû
, 
sÿm³r_cyşe_t
 *
cyşe
)

496 
commªd_t
 *
commªd
 = 
NULL
;

498 if((
commªd
 = 
	`commªd_®loc
(
COMMAND_CYCLE
)è=ğ
NULL
)

499 
”r
;

500 
commªd
->
un
.
cyşe
 = cycle;

501 if(
	`dli¡__push
(
sourû
->
commªds
, 
commªd
è=ğ
NULL
)

502 
”r
;

503 
sourû
->
cyşe_pošts
++;

507 
”r
:

508 if(
commªd
 !ğ
NULL
è
	`commªd_ä“
(command);

510 
	}
}

519 
sÿm³r_sourû_t
 *
	$sourû_Ãxt
()

521 *
node
;

523 if((
node
 = 
	`şi¡_node_Ãxt
(
sourû_cur
->
li¡_node
)) != source_cur->list_node)

524 
sourû_cur
 = 
	`şi¡_node_™em
(
node
);

526 
sourû_út
 = 0;

528  
sourû_cur
;

529 
	}
}

537 
	$sourû_aùive_d‘ach
(
sÿm³r_sourû_t
 *
sourû
)

539 *
node
;

541 
	`as£¹
(
sourû
->
li¡_
 =ğ
aùive
);

543 
sourû_cur
 = 
NULL
;

544 
sourû_út
 = 0;

546 if(
sourû
->
li¡_node
 !ğ
NULL
)

548 if((
node
 = 
	`şi¡_node_Ãxt
(
sourû
->
li¡_node
)) != source->list_node)

549 
sourû_cur
 = 
	`şi¡_node_™em
(
node
);

551 
	`şi¡_node_pİ
(
aùive
, 
sourû
->
li¡_node
);

554 
sourû
->
li¡_
 = 
NULL
;

555 
sourû
->
li¡_node
 = 
NULL
;

558 
	}
}

565 
	$sourû_blocked_d‘ach
(
sÿm³r_sourû_t
 *
sourû
)

567 
	`as£¹
(
sourû
->
li¡_
 =ğ
blocked
);

569 
	`dli¡_node_pİ
(
blocked
, 
sourû
->
li¡_node
);

570 
sourû
->
li¡_
 = 
NULL
;

571 
sourû
->
li¡_node
 = 
NULL
;

573 
	}
}

580 
	$sourû_fšished_d‘ach
(
sÿm³r_sourû_t
 *
sourû
)

582 
	`as£¹
(
sourû
->
li¡_
 =ğ
fšished
);

584 
	`dli¡_node_pİ
(
fšished
, 
sourû
->
li¡_node
);

585 
sourû
->
li¡_
 = 
NULL
;

586 
sourû
->
li¡_node
 = 
NULL
;

588 
	}
}

602 
	$sourû_aùive_©ch
(
sÿm³r_sourû_t
 *
sourû
)

604 if(
sourû
->
li¡_
 =ğ
aùive
)

607 if(
sourû
->
li¡_
 =ğ
fšished
)

610 if(
sourû
->
li¡_
 =ğ
blocked
)

613 if(
sourû
->
´iÜ™y
 == 0)

615 
	`sourû_blocked_d‘ach
(
sourû
);

618 if((
sourû
->
li¡_node
 = 
	`şi¡__push
(
aùive
, sourû)è=ğ
NULL
)

620 
sourû
->
li¡_
 = 
aùive
;

622 if(
sourû_cur
 =ğ
NULL
)

624 
sourû_cur
 = 
sourû
;

625 
sourû_út
 = 0;

629 
	}
}

636 
	$sourû_blocked_©ch
(
sÿm³r_sourû_t
 *
sourû
)

638 if(
sourû
->
li¡_
 =ğ
blocked
)

641 if(
sourû
->
li¡_
 =ğ
fšished
)

644 if(
sourû
->
li¡_node
 !ğ
NULL
)

645 
	`sourû_aùive_d‘ach
(
sourû
);

647 if((
sourû
->
li¡_node
 = 
	`dli¡__push
(
blocked
, sourû)è=ğ
NULL
)

649 
sourû
->
li¡_
 = 
blocked
;

652 
	}
}

659 
	$sourû_fšished_©ch
(
sÿm³r_sourû_t
 *
sourû
)

661 if(
sourû
->
li¡_
 =ğ
fšished
)

664 if(
sourû
->
li¡_
 =ğ
aùive
)

665 
	`sourû_aùive_d‘ach
(
sourû
);

666 if(
sourû
->
li¡_
 =ğ
blocked
)

667 
	`sourû_blocked_d‘ach
(
sourû
);

669 if((
sourû
->
li¡_node
 = 
	`dli¡__push
(
fšished
, sourû)è=ğ
NULL
)

672 
sourû
->
li¡_
 = 
fšished
;

674 
	}
}

683 
	$sourû_commªd_unhŞd
(*
cook›
)

685 
commªd_ÚhŞd_t
 *
ÚhŞd
 = (commªd_ÚhŞd_ˆ*)
cook›
;

686 
sÿm³r_sourû_t
 *
sourû
 = 
ÚhŞd
->source;

687 
sÿm³r_sourûsk_t
 *
¡
 = 
ÚhŞd
->st;

688 
commªd_t
 *
cmd
 = 
NULL
;

696 
	`dli¡_node_pİ
(
sourû
->
ÚhŞd
, onhŞd->
node
);

697 
	`ä“
(
ÚhŞd
);

698 if((
cmd
 = 
	`commªd_®loc
(
COMMAND_TASK
)è=ğ
NULL
)

699 
”r
;

700 
cmd
->
un
.
sourûsk
 = 
¡
; sˆğ
NULL
;

701 if(
	`dli¡_h—d_push
(
sourû
->
commªds
, 
cmd
è=ğ
NULL
)

702 
”r
;

703 
	`sourû_aùive_©ch
(
sourû
);

706 
”r
:

707 if(
¡
 !ğ
NULL
è
	`sÿm³r_sourûsk_ä“
(st);

708 if(
cmd
 !ğ
NULL
è
	`ä“
(cmd);

710 
	}
}

717 
	$sourû_commªd_ÚhŞd
(
sÿm³r_sourû_t
 *
sourû
,

718 
sÿm³r_sk_t
 *
block
,

719 
sÿm³r_sourûsk_t
 *
¡
)

721 
commªd_ÚhŞd_t
 *
ÚhŞd
 = 
NULL
;

723 if((
ÚhŞd
 = 
	`m®loc_z”o
((
commªd_ÚhŞd_t
))è=ğ
NULL
 ||

724 (
ÚhŞd
->
node
 = 
	`dli¡__push
(
sourû
->ÚhŞd, onhŞd)è=ğ
NULL
 ||

725 (
ÚhŞd
->
cook›
 = 
	`sÿm³r_sk_ÚhŞd
(
block
, onhold,

726 
sourû_commªd_unhŞd
)è=ğ
NULL
)

728 
”r
;

731 
ÚhŞd
->
block
 = block;

732 
ÚhŞd
->
sourû
 = source;

733 
ÚhŞd
->
¡
 = st;

737 
”r
:

738 if(
ÚhŞd
 !ğ
NULL
)

740 if(
ÚhŞd
->
node
 !ğ
NULL
è
	`dli¡_node_pİ
(
sourû
->onhold, onhold->node);

741 
	`ä“
(
ÚhŞd
);

744 
	}
}

752 
	$sourû_sk_š¡®l
(
sÿm³r_sourû_t
 *
sourû
,

753 
sÿm³r_sourûsk_t
 *
¡
, 
sÿm³r_sk_t
 **
out
)

755 
sÿm³r_sk_t
 *
sk
 = 
¡
->task;

756 
sÿm³r_sk_t
 *
block
;

758 if((
block
 = 
	`sÿm³r_sk_sig_block
(
sk
)è=ğ
NULL
)

760 if(
	`sÿm³r_sk_sig_š¡®l
(
sk
) != 0)

762 *
out
 = 
sk
;

766 if(
	`sourû_commªd_ÚhŞd
(
sourû
, 
block
, 
¡
) != 0)

768 *
out
 = 
NULL
;

772 
	}
}

774 
	$commªd_sk_hªdË
(
sÿm³r_sourû_t
 *
sourû
, 
commªd_t
 *
commªd
,

775 
sÿm³r_sk_t
 **
sk_out
)

777 
sÿm³r_sourûsk_t
 *
¡
 = 
commªd
->
un
.
sourûsk
;

778 
	`commªd_ä“
(
commªd
);

779  
	`sourû_sk_š¡®l
(
sourû
, 
¡
, 
sk_out
);

780 
	}
}

782 
	$commªd_´obe_hªdË
(
sÿm³r_sourû_t
 *
sourû
, 
commªd_t
 *
commªd
,

783 
sÿm³r_sk_t
 **
sk_out
)

785 cÚ¡ 
commªd_func_t
 *
funcs
 = 
commªd
->
un
.
´
.funcs;

786 
sÿm³r_sourûsk_t
 *
¡
 = 
NULL
;

787 
sÿm³r_cyşe_t
 *
cyşe
;

788 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

790 
	`sourûs_as£¹
();

793 
cyşe
 = 
	`sÿm³r_cyşemÚ_cyşe
(
commªd
->
un
.
´
.
cyşemÚ
);

796 if((
sk
 = 
funcs
->
	`®loùask
(
commªd
->
un
.
´
.
d©a
,
sourû
->
li¡
,
cyşe
)è=ğ
NULL
)

797 
”r
;

798 
	`sÿm³r_sk_£tcyşemÚ
(
sk
, 
commªd
->
un
.
´
.
cyşemÚ
);

799 
commªd
->
un
.
´
.
d©a
 = 
NULL
;

800 
	`commªd_ä“
(
commªd
);

801 
commªd
 = 
NULL
;

807 if((
¡
 = 
	`sourûsk_®loc
(
sourû
, 
sk
)è=ğ
NULL
)

808 
”r
;

809 
sk
 = 
NULL
;

810 
	`sÿm³r_sk_£tsourûsk
(
¡
->
sk
, st);

812 if(
	`sourû_sk_š¡®l
(
sourû
, 
¡
, 
sk_out
) != 0)

813 
”r
;

815 
	`sourûs_as£¹
();

818 
”r
:

819 if(
¡
 !ğ
NULL
è
	`sÿm³r_sourûsk_ä“
(st);

820 if(
sk
 !ğ
NULL
è
	`sÿm³r_sk_ä“
(task);

821 if(
commªd
 !ğ
NULL
è
	`commªd_ä“
(command);

822 
	`sourûs_as£¹
();

824 
	}
}

831 
	$commªd_cyşe_hªdË
(
sÿm³r_sourû_t
 *
sourû
, 
commªd_t
 *
commªd
)

833 
sÿm³r_sourû_ev’t_t
 
s£
;

834 
sÿm³r_cyşe_t
 *
cyşe
 = 
commªd
->
un
.cycle;

835 
sÿm³r_fe_t
 *
fe
;

836 
timev®
 
tv
;

837 
ho¡Çme
[
MAXHOSTNAMELEN
];

839 
	`sourûs_as£¹
();

842 if(
	`g‘ho¡Çme
(
ho¡Çme
, (hostname)) == 0)

843 
cyşe
->
ho¡Çme
 = 
	`¡rdup
(hostname);

846 
	`g‘timeofday_w¿p
(&
tv
);

847 
cyşe
->
¡¬t_time
 = (
ušt32_t
)
tv
.
tv_£c
;

850 if(
sourû
->
sof
 !ğ
NULL
 &&

851 (
fe
 = 
	`sÿm³r_outfe_g‘fe
(
sourû
->
sof
)è!ğ
NULL
)

853 
	`sÿm³r_fe_wr™e_cyşe_¡¬t
(
fe
, 
cyşe
);

857 
	`mem£t
(&
s£
, 0, (sse));

858 
s£
.
s£_cyşe_cyşe_id
 = 
cyşe
->
id
;

859 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_CYCLE
, &
s£
);

861 
	`commªd_ä“
(
commªd
);

862 
	`sourûs_as£¹
();

864 
	}
}

871 
	$sourû_cyşe_fšish
(
sÿm³r_cyşe_t
 *
cyşe
,

872 
sÿm³r_sourû_t
 *
sourû
,

873 
sÿm³r_outfe_t
 *
outfe
)

875 
sÿm³r_fe_t
 *
sf
;

876 
timev®
 
tv
;

878 
	`sourûs_as£¹
();

881 
	`g‘timeofday_w¿p
(&
tv
);

882 
cyşe
->
¡İ_time
 = (
ušt32_t
)
tv
.
tv_£c
;

885 if(
outfe
 !ğ
NULL
)

887 
sf
 = 
	`sÿm³r_outfe_g‘fe
(
outfe
);

888 
	`sÿm³r_fe_wr™e_cyşe_¡İ
(
sf
, 
cyşe
);

891 if(
sourû
 !ğ
NULL
)

892 
sourû
->
cyşe_pošts
--;

894 
	`sourûs_as£¹
();

896 
	}
}

904 
	$sourû_cyşe
(
sÿm³r_sourû_t
 *
sourû
, 
ušt32_t
 
cyşe_id
)

906 
sÿm³r_cyşemÚ_t
 *
cyşemÚ
 = 
NULL
;

907 
sÿm³r_cyşe_t
 *
cyşe
 = 
NULL
;

909 
	`sourûs_as£¹
();

912 if((
cyşe
 = 
	`sÿm³r_cyşe_®loc
(
sourû
->
li¡
)è=ğ
NULL
)

914 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ew cycle");

915 
”r
;

919 
cyşe
->
id
 = 
cyşe_id
;

922 if((
cyşemÚ
 = 
	`sÿm³r_cyşemÚ_®loc
(
cyşe
, 
sourû_cyşe_fšish
, 
sourû
,

923 
sourû
->
sof
)è=ğ
NULL
)

925 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ew cyclemon");

926 
”r
;

930 if(
	`commªd_cyşe
(
sourû
, 
cyşe
) != 0)

932 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert cycle marker");

933 
”r
;

940 if(
sourû
->
cyşe
 !ğ
NULL
)

941 
	`sÿm³r_cyşe_ä“
(
sourû
->
cyşe
);

942 if(
sourû
->
cyşemÚ
 !ğ
NULL
)

943 
	`sÿm³r_cyşemÚ_unu£
(
sourû
->
cyşemÚ
);

946 
sourû
->
cyşe
 = cycle;

947 
sourû
->
cyşemÚ
 = cyclemon;

949 
	`sourûs_as£¹
();

952 
”r
:

953 if(
cyşemÚ
 !ğ
NULL
è
	`sÿm³r_cyşemÚ_ä“
(cyclemon);

954 if(
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(cycle);

955 
	`sourûs_as£¹
();

957 
	}
}

959 
	$sourû_cmp
(cÚ¡ *
a
, cÚ¡ *
b
)

961  
	`¡rÿ£cmp
(((cÚ¡ 
sÿm³r_sourû_t
 *)
b
)->
li¡
->
Çme
,

962 ((cÚ¡ 
sÿm³r_sourû_t
 *)
a
)->
li¡
->
Çme
);

963 
	}
}

971 
	$sourû_æush_commªds
(
sÿm³r_sourû_t
 *
sourû
)

973 
commªd_ÚhŞd_t
 *
ÚhŞd
;

974 
commªd_t
 *
commªd
;

976 
	`sourûs_as£¹
();

978 if(
sourû
->
d©a
 !ğ
NULL
)

979 
sourû
->
	`ä“d©a
(sourû->
d©a
);

981 
sourû
->
d©a
 = 
NULL
;

982 
sourû
->
ke
 = 
NULL
;

983 
sourû
->
ä“d©a
 = 
NULL
;

984 
sourû
->
isfšished
 = 
NULL
;

985 
sourû
->
to¡r
 = 
NULL
;

987 if(
sourû
->
commªds
 !ğ
NULL
)

989 (
commªd
 = 
	`dli¡_h—d_pİ
(
sourû
->
commªds
)è!ğ
NULL
)

990 
	`commªd_ä“
(
commªd
);

991 
	`dli¡_ä“
(
sourû
->
commªds
);

992 
sourû
->
commªds
 = 
NULL
;

995 if(
sourû
->
ÚhŞd
 !ğ
NULL
)

997 (
ÚhŞd
 = 
	`dli¡_h—d_pİ
(
sourû
->ÚhŞd)è!ğ
NULL
)

999 
	`sÿm³r_sk_dehŞd
(
ÚhŞd
->
block
, onhŞd->
cook›
);

1000 
	`ä“
(
ÚhŞd
);

1002 
	`dli¡_ä“
(
sourû
->
ÚhŞd
);

1003 
sourû
->
ÚhŞd
 = 
NULL
;

1006 
	`sourûs_as£¹
();

1008 
	}
}

1015 
	$sourû_æush_sks
(
sÿm³r_sourû_t
 *
sourû
)

1017 
sÿm³r_sourûsk_t
 *
¡
;

1019 
	`sourûs_as£¹
();

1022 if(
sourû
->
sks
 !ğ
NULL
)

1025 (
¡
 = 
	`dli¡_h—d_pİ
(
sourû
->
sks
)è!ğ
NULL
)

1027 
¡
->
node
 = 
NULL
;

1028 
	`sÿm³r_sk_ä“
(
¡
->
sk
);

1030 
	`dli¡_ä“
(
sourû
->
sks
);

1031 
sourû
->
sks
 = 
NULL
;

1034 
	`sourûs_as£¹
();

1036 
	}
}

1043 
	$sourû_d‘ach
(
sÿm³r_sourû_t
 *
sourû
)

1046 if(
sourû
->
li¡_
 =ğ
aùive
)

1047 
	`sourû_aùive_d‘ach
(
sourû
);

1048 if(
sourû
->
li¡_
 =ğ
blocked
)

1049 
	`sourû_blocked_d‘ach
(
sourû
);

1050 if(
sourû
->
li¡_
 =ğ
fšished
)

1051 
	`sourû_fšished_d‘ach
(
sourû
);

1053 
	`as£¹
(
sourû
->
li¡_
 =ğ
NULL
);

1054 
	`as£¹
(
sourû
->
li¡_node
 =ğ
NULL
);

1057 if(
sourû
->
Œ“_node
 !ğ
NULL
)

1059 
	`¥ÏyŒ“_»move_node
(
sourû_Œ“
, 
sourû
->
Œ“_node
);

1060 
sourû
->
Œ“_node
 = 
NULL
;

1063 if(
	`sourû_»fút_dec
(
sourû
) == 0)

1064 
	`sourû_ä“
(
sourû
);

1068 
	}
}

1076 
	$sÿm³r_sourû_isfšished
(
sÿm³r_sourû_t
 *
sourû
)

1078 
	`sourûs_as£¹
();

1081 if(
sourû
->
commªds
 !ğ
NULL
 && 
	`dli¡_couÁ
(source->commands) > 0)

1085 if(
sourû
->
ÚhŞd
 !ğ
NULL
 && 
	`dli¡_couÁ
(source->onhold) > 0)

1089 if(
sourû
->
sks
 !ğ
NULL
 && 
	`dli¡_couÁ
(source->tasks) > 0)

1097 if(
sourû
->
isfšished
 !ğ
NULL
 && sourû->
	`isfšished
(sourû->
d©a
) == 0)

1101 
	}
}

1109 
	$sÿm³r_sourû_fšished
(
sÿm³r_sourû_t
 *
sourû
)

1111 
	`sourûs_as£¹
();

1112 
	`as£¹
(
	`sÿm³r_sourû_isfšished
(
sourû
) != 0);

1113 if(
sourû
->
cyşemÚ
 !ğ
NULL
)

1115 
	`as£¹
(
	`sÿm³r_cyşemÚ_»fút
(
sourû
->
cyşemÚ
) == 1);

1116 
	`sÿm³r_cyşemÚ_unu£
(
sourû
->
cyşemÚ
);

1117 
sourû
->
cyşemÚ
 = 
NULL
;

1119 
	`sourû_fšished_©ch
(
sourû
);

1120 
	`sourûs_as£¹
();

1122 
	}
}

1129 
	$sourû_ä“
(
sÿm³r_sourû_t
 *
sourû
)

1131 
buf
[512];

1133 
	`as£¹
(
sourû
 !ğ
NULL
);

1134 
	`as£¹
(
sourû
->
»fút
 == 0);

1136 if(
	`sÿm³r_sourû_to¡r
(
sourû
, 
buf
, (buf)è!ğ
NULL
)

1137 
	`sÿm³r_debug
(
__func__
, "%s", 
buf
);

1140 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_FINISH
, 
NULL
);

1142 if(
sourû
->
cyşemÚ
 !ğ
NULL
)

1144 
	`sÿm³r_cyşemÚ_sourû_d‘ach
(
sourû
->
cyşemÚ
);

1145 
	`sÿm³r_cyşemÚ_unu£
(
sourû
->
cyşemÚ
);

1146 
sourû
->
cyşemÚ
 = 
NULL
;

1150 
	`sourû_d‘ach
(
sourû
);

1153 if(
sourû
->
commªds
 !ğ
NULL
)

1154 
	`sourû_æush_commªds
(
sourû
);

1157 if(
sourû
->
sks
 !ğ
NULL
)

1158 
	`sourû_æush_sks
(
sourû
);

1161 if(
sourû
->
idŒ“
 !ğ
NULL
)

1163 
	`as£¹
(
	`¥ÏyŒ“_couÁ
(
sourû
->
idŒ“
) == 0);

1164 
	`¥ÏyŒ“_ä“
(
sourû
->
idŒ“
, 
NULL
);

1168 if(
sourû
->
sof
 !ğ
NULL
è
	`sÿm³r_outfe_ä“
(source->sof);

1170 if(
sourû
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(source->list);

1171 if(
sourû
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(source->cycle);

1173 
	`ä“
(
sourû
);

1174 
	`sourûs_as£¹
();

1176 
	}
}

1183 cÚ¡ *
	$sÿm³r_sourû_g‘Çme
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1185 if(
sourû
->
li¡
 =ğ
NULL
)  NULL;

1186  
sourû
->
li¡
->
Çme
;

1187 
	}
}

1194 cÚ¡ *
	$sÿm³r_sourû_g‘desü
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1196 if(
sourû
->
li¡
 =ğ
NULL
)  NULL;

1197  
sourû
->
li¡
->
desü
;

1198 
	}
}

1205 cÚ¡ *
	$sÿm³r_sourû_g‘outfe
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1207  
	`sÿm³r_outfe_g‘Çme
(
sourû
->
sof
);

1208 
	}
}

1215 
ušt32_t
 
	$sÿm³r_sourû_g‘li¡id
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1217  
sourû
->
li¡
->
id
;

1218 
	}
}

1225 
ušt32_t
 
	$sÿm³r_sourû_g‘cyşeid
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1227  
sourû
->
cyşe
->
id
;

1228 
	}
}

1235 
ušt32_t
 
	$sÿm³r_sourû_g‘´iÜ™y
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1237  
sourû
->
´iÜ™y
;

1238 
	}
}

1240 
	$sÿm³r_sourû_£riÜ™y
(
sÿm³r_sourû_t
 *
sourû
, 
ušt32_t
 
´iÜ™y
)

1242 
sÿm³r_sourû_ev’t_t
 
s£
;

1243 
ušt32_t
 
Şd_´iÜ™y
;

1245 
	`sourûs_as£¹
();

1247 
Şd_´iÜ™y
 = 
sourû
->
´iÜ™y
;

1248 
sourû
->
´iÜ™y
 =…riority;

1250 if(
´iÜ™y
 =ğ0 && 
Şd_´iÜ™y
 > 0)

1251 
	`sourû_blocked_©ch
(
sourû
);

1252 if(
´iÜ™y
 > 0 && 
Şd_´iÜ™y
 == 0)

1253 
	`sourû_aùive_©ch
(
sourû
);

1255 
	`mem£t
(&
s£
, 0, (sse));

1256 
s£
.
s£_upd©e_æags
 |= 0x04;

1257 
s£
.
s£_upd©e_´iÜ™y
 = 
´iÜ™y
;

1258 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_UPDATE
, &
s£
);

1260 
	`sourûs_as£¹
();

1262 
	}
}

1264 cÚ¡ *
	$sÿm³r_sourû_ty³_to¡r
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1266 
sourû
->
ty³
)

1268 
SCAMPER_SOURCE_TYPE_FILE
:  "file";

1269 
SCAMPER_SOURCE_TYPE_CMDLINE
:  "cmdline";

1270 
SCAMPER_SOURCE_TYPE_CONTROL
:  "control";

1271 
SCAMPER_SOURCE_TYPE_TSPS
:  "tsps";

1274  
NULL
;

1275 
	}
}

1277 *
	$sÿm³r_sourû_to¡r
(cÚ¡ 
sÿm³r_sourû_t
 *
¤c
, *
buf
, 
size_t
 
Ën
)

1279 
tmp
[512];

1280 
size_t
 
off
 = 0;

1282 if(
¤c
->
li¡
 =ğ
NULL
 || src->li¡->
Çme
 == NULL)

1283  
NULL
;

1285 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "Çm%s", 
¤c
->
li¡
->
Çme
);

1286 if(
¤c
->
to¡r
 !ğ
NULL
 && src->
	`to¡r
(¤c->
d©a
, 
tmp
, (tmp)) != NULL)

1287 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " %s", 
tmp
);

1289  
buf
;

1290 
	}
}

1297 
	$sÿm³r_sourû_g‘commªdcouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1299 if(
sourû
->
commªds
 !ğ
NULL
)

1300  
	`dli¡_couÁ
(
sourû
->
commªds
);

1302 
	}
}

1304 
	$sÿm³r_sourû_g‘cyşecouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1306  
sourû
->
cyşe_pošts
;

1307 
	}
}

1309 
	$sÿm³r_sourû_g‘skcouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1311 if(
sourû
->
sks
 !ğ
NULL
)

1312  
	`dli¡_couÁ
(
sourû
->
sks
);

1314 
	}
}

1316 
	$sÿm³r_sourû_g‘ty³
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1318  
sourû
->
ty³
;

1319 
	}
}

1321 *
	$sÿm³r_sourû_g‘d©a
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
)

1323  
sourû
->
d©a
;

1324 
	}
}

1326 cÚ¡ 
commªd_func_t
 *
	$commªd_func_g‘
(cÚ¡ *
commªd
)

1328 cÚ¡ 
commªd_func_t
 *
func
 = 
NULL
;

1329 
size_t
 
i
;

1331 
i
=0; i<
commªd_funcc
; i++)

1333 
func
 = &
commªd_funcs
[
i
];

1334 if(
	`¡ºÿ£cmp
(
commªd
, 
func
->commªd, func->
Ën
) == 0 &&

1335 
	`is¥aû
(()
commªd
[
func
->
Ën
]) && command[func->len] != '\0')

1337  
func
;

1341  
NULL
;

1342 
	}
}

1350 *
	$commªd_func_®locd©a
(cÚ¡ 
commªd_func_t
 *
f
, cÚ¡ *
cmd
)

1352 *
İts
 = 
NULL
;

1353 *
d©a
;

1354 if((
İts
 = 
	`¡rdup
(
cmd
 + 
f
->
Ën
)è=ğ
NULL
)

1356 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot strdup cmd opts");

1357  
NULL
;

1359 
d©a
 = 
f
->
	`®locd©a
(
İts
);

1360 
	`ä“
(
İts
);

1361  
d©a
;

1362 
	}
}

1364 
	$sÿm³r_sourû_h®‰ask
(
sÿm³r_sourû_t
 *
sourû
, 
ušt32_t
 
id
)

1366 
sÿm³r_sourûsk_t
 *
¡
, 
fm
;

1367 
commªd_t
 *
cmd
;

1368 
dli¡_node_t
 *
no
;

1370 
	`sourûs_as£¹
();

1372 
fm
.
id
 = id;

1373 if(
sourû
->
idŒ“
 =ğ
NULL
)

1375 if((
¡
 = 
	`¥ÏyŒ“_fšd
(
sourû
->
idŒ“
, &
fm
)è=ğ
NULL
)

1378 
	`sÿm³r_sk_h®t
(
¡
->
sk
);

1380 
no
=
	`dli¡_h—d_node
(
sourû
->
commªds
);‚Ø!ğ
NULL
;‚o=
	`dli¡_node_Ãxt
(no))

1382 
cmd
 = 
	`dli¡_node_™em
(
no
);

1383 if(
cmd
->
ty³
 =ğ
COMMAND_TASK
 && cmd->
un
.
sourûsk
 =ğ
¡
)

1385 
cmd
 = 
	`dli¡_node_pİ
(
sourû
->
commªds
, 
no
);

1386 
	`commªd_ä“
(
cmd
);

1391 
	`sourûs_as£¹
();

1393 
	}
}

1401 
	$sÿm³r_sourû_commªd2
(
sÿm³r_sourû_t
 *
s
, cÚ¡ *
commªd
,

1402 
ušt32_t
 *
id
)

1404 cÚ¡ 
commªd_func_t
 *
f
 = 
NULL
;

1405 
sÿm³r_sourûsk_t
 *
¡
 = 
NULL
;

1406 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

1407 
commªd_t
 *
cmd
 = 
NULL
;

1408 *
d©a
 = 
NULL
;

1410 
	`sourûs_as£¹
();

1412 if(
s
->
idŒ“
 =ğ
NULL
 && (s->idŒ“ = 
	`¥ÏyŒ“_®loc
(
idŒ“_cmp
)) == NULL)

1414 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc idtree");

1415 
”r
;

1418 if((
f
 = 
	`commªd_func_g‘
(
commªd
)è=ğ
NULL
)

1420 
	`sÿm³r_debug
(
__func__
, "could‚ot determine commandype");

1421 
”r
;

1423 if((
d©a
 = 
	`commªd_func_®locd©a
(
f
, 
commªd
)è=ğ
NULL
)

1424 
”r
;

1425 if((
sk
 = 
f
->
	`®loùask
(
d©a
, 
s
->
li¡
, s->
cyşe
)è=ğ
NULL
)

1426 
”r
;

1427 
d©a
 = 
NULL
;

1433 if((
¡
 = 
	`sourûsk_®loc
(
s
, 
sk
)è=ğ
NULL
)

1434 
”r
;

1435 
	`sÿm³r_sk_£tsourûsk
(
sk
, 
¡
);

1436 
	`sÿm³r_sk_£tcyşemÚ
(
sk
, 
s
->
cyşemÚ
);

1437 
sk
 = 
NULL
;

1440 
¡
->
id
 = *id = 
s
->id;

1441 if(++
s
->
id
 == 0) s->id = 1;

1442 if((
¡
->
idnode
 = 
	`¥ÏyŒ“_š£¹
(
s
->
idŒ“
, st)è=ğ
NULL
)

1444 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡ddo idtree");

1445 
”r
;

1448 if((
cmd
 = 
	`commªd_®loc
(
COMMAND_TASK
)è=ğ
NULL
)

1449 
”r
;

1450 
cmd
->
un
.
sourûsk
 = 
¡
;

1452 if(
	`dli¡__push
(
s
->
commªds
, 
cmd
è=ğ
NULL
)

1454 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡ddo commands†ist");

1455 
”r
;

1458 
	`sourû_aùive_©ch
(
s
);

1459 
	`sourûs_as£¹
();

1462 
”r
:

1464 if(
d©a
 !ğ
NULL
è
f
->
	`ä“d©a
(data);

1465 if(
cmd
 !ğ
NULL
è
	`commªd_ä“
(cmd);

1466 
	`sourûs_as£¹
();

1468 
	}
}

1474 
	$sÿm³r_sourû_commªd
(
sÿm³r_sourû_t
 *
sourû
, cÚ¡ *
commªd
)

1476 cÚ¡ 
commªd_func_t
 *
func
 = 
NULL
;

1477 
commªd_t
 *
cmd
 = 
NULL
;

1478 *
İts
 = 
NULL
;

1479 *
d©a
 = 
NULL
;

1481 
	`sourûs_as£¹
();

1483 if((
func
 = 
	`commªd_func_g‘
(
commªd
)è=ğ
NULL
)

1484 
”r
;

1485 if((
d©a
 = 
	`commªd_func_®locd©a
(
func
, 
commªd
)è=ğ
NULL
)

1486 
”r
;

1488 if((
cmd
 = 
	`commªd_®loc
(
COMMAND_PROBE
)è=ğ
NULL
)

1489 
”r
;

1490 
cmd
->
un
.
´
.
funcs
 = 
func
;

1491 
cmd
->
un
.
´
.
d©a
 = data;

1492 
cmd
->
un
.
´
.
cyşemÚ
 = 
	`sÿm³r_cyşemÚ_u£
(
sourû
->cyclemon);

1494 if(
	`dli¡__push
(
sourû
->
commªds
, 
cmd
è=ğ
NULL
)

1495 
”r
;

1497 
	`sourû_aùive_©ch
(
sourû
);

1498 
	`sourûs_as£¹
();

1501 
”r
:

1502 if(
İts
 !ğ
NULL
è
	`ä“
(opts);

1503 if(
d©a
 !ğ
NULL
è
func
->
	`ä“d©a
(data);

1504 if(
cmd
 !ğ
NULL
è
	`ä“
(cmd);

1505 
	`sourûs_as£¹
();

1507 
	}
}

1515 
	$sÿm³r_sourû_cyşe
(
sÿm³r_sourû_t
 *
sourû
)

1517  
	`sourû_cyşe
(
sourû
, sourû->
cyşe
->
id
 + 1);

1518 
	}
}

1520 
sÿm³r_sourû_t
 *
	$sÿm³r_sourûsk_g‘sourû
(
sÿm³r_sourûsk_t
 *
¡
)

1522  
¡
->
sourû
;

1523 
	}
}

1531 
	$sÿm³r_sourûsk_ä“
(
sÿm³r_sourûsk_t
 *
¡
)

1533 
sÿm³r_sourû_t
 *
sourû
 = 
¡
->source;

1535 
	`sourûs_as£¹
();

1537 if(
¡
->
node
 !ğ
NULL
)

1538 
	`dli¡_node_pİ
(
sourû
->
sks
, 
¡
->
node
);

1539 if(
¡
->
idnode
 !ğ
NULL
)

1540 
	`¥ÏyŒ“_»move_node
(
sourû
->
idŒ“
, 
¡
->
idnode
);

1541 
	`sÿm³r_sourû_ä“
(
¡
->
sourû
);

1542 
	`ä“
(
¡
);

1544 if(
	`sÿm³r_sourû_isfšished
(
sourû
) != 0)

1546 if(
sourû
->
cyşemÚ
 !ğ
NULL
)

1548 
	`as£¹
(
	`sÿm³r_cyşemÚ_»fút
(
sourû
->
cyşemÚ
) == 1);

1549 
	`sÿm³r_cyşemÚ_unu£
(
sourû
->
cyşemÚ
);

1550 
sourû
->
cyşemÚ
 = 
NULL
;

1552 
	`sourû_d‘ach
(
sourû
);

1555 
	`sourûs_as£¹
();

1557 
	}
}

1563 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_u£
(
sÿm³r_sourû_t
 *
sourû
)

1565 
	`sourûs_as£¹
();

1566 
sourû
->
»fút
++;

1567  
sourû
;

1568 
	}
}

1574 
	$sÿm³r_sourû_abªdÚ
(
sÿm³r_sourû_t
 *
sourû
)

1576 
	`sourûs_as£¹
();

1577 
	`sourû_æush_sks
(
sourû
);

1578 
	`sourû_æush_commªds
(
sourû
);

1579 
	`sourû_d‘ach
(
sourû
);

1580 
	`sourûs_as£¹
();

1582 
	}
}

1591 
	$sÿm³r_sourû_ä“
(
sÿm³r_sourû_t
 *
sourû
)

1593 
	`sourûs_as£¹
();

1599 if(
	`sourû_»fút_dec
(
sourû
) != 0)

1602 
	`sourû_ä“
(
sourû
);

1603 
	`sourûs_as£¹
();

1605 
	}
}

1614 
sÿm³r_sourû_t
 *
	$sÿm³r_sourû_®loc
(cÚ¡ 
sÿm³r_sourû_·¿ms_t
 *
s¥
)

1616 
sÿm³r_sourû_t
 *
sourû
 = 
NULL
;

1619 if(
s¥
 =ğ
NULL
 || s¥->
Çme
 == NULL)

1621 
	`sÿm³r_debug
(
__func__
, "missing‚ecessary…arameters");

1622 
”r
;

1625 if((
sourû
 = 
	`m®loc_z”o
((
sÿm³r_sourû_t
))è=ğ
NULL
)

1627 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc source");

1628 
”r
;

1630 
sourû
->
»fút
 = 1;

1633 
sourû
->
d©a
 = 
s¥
->data;

1634 
sourû
->
ke
 = 
s¥
->take;

1635 
sourû
->
ä“d©a
 = 
s¥
->freedata;

1636 
sourû
->
isfšished
 = 
s¥
->isfinished;

1637 
sourû
->
to¡r
 = 
s¥
->tostr;

1639 if((
sourû
->
li¡
 = 
	`sÿm³r_li¡_®loc
(
s¥
->
li¡_id
, s¥->
Çme
, s¥->
desü
,

1640 
	`sÿm³r_mÚ™ÜÇme_g‘
())è=ğ
NULL
)

1642 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc source->list");

1643 
”r
;

1646 if((
sourû
->
commªds
 = 
	`dli¡_®loc
()è=ğ
NULL
)

1648 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot‡lloc source->commands");

1649 
”r
;

1652 if((
sourû
->
ÚhŞd
 = 
	`dli¡_®loc
()è=ğ
NULL
)

1654 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot‡lloc source->onhold");

1655 
”r
;

1658 if((
sourû
->
sks
 = 
	`dli¡_®loc
()è=ğ
NULL
)

1660 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot‡lloc source->tasks");

1661 
”r
;

1664 
sourû
->
sof
 = 
	`sÿm³r_outfe_u£
(
s¥
->sof);

1665 if(
	`sourû_cyşe
(
sourû
, 
s¥
->
cyşe_id
) != 0)

1667 
”r
;

1670 
sourû
->
ty³
 = 
s¥
->type;

1671 
sourû
->
´iÜ™y
 = 
s¥
->priority;

1672 
sourû
->
id
 = 1;

1674  
sourû
;

1676 
”r
:

1677 if(
sourû
 !ğ
NULL
)

1679 if(
sourû
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(source->list);

1680 if(
sourû
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(source->cycle);

1681 if(
sourû
->
commªds
 !ğ
NULL
è
	`dli¡_ä“
(source->commands);

1682 if(
sourû
->
ÚhŞd
 !ğ
NULL
è
	`dli¡_ä“
(source->onhold);

1683 if(
sourû
->
sks
 !ğ
NULL
è
	`dli¡_ä“
(source->tasks);

1684 
	`ä“
(
sourû
);

1686  
NULL
;

1687 
	}
}

1695 
sÿm³r_sourû_ob£rv”_t
 *
	$sÿm³r_sourûs_ob£rve
(
sÿm³r_sourû_ev’tf_t
 
cb
,

1696 *
·¿m
)

1698 
sÿm³r_sourû_ob£rv”_t
 *
ob£rv”
 = 
NULL
;

1700 if((
ob£rv”s
 =ğ
NULL
 && (ob£rv” ğ
	`dli¡_®loc
()) == NULL) ||

1701 (
ob£rv”
 = 
	`m®loc_z”o
((
sÿm³r_sourû_ob£rv”_t
))è=ğ
NULL
 ||

1702 (
ob£rv”
->
node
 = 
	`dli¡__push
(
ob£rv”s
, ob£rv”)è=ğ
NULL
)

1704 
”r
;

1707 
ob£rv”
->
func
 = 
cb
;

1708 
ob£rv”
->
·¿m
 =…aram;

1710  
ob£rv”
;

1712 
”r
:

1713 if(
ob£rv”
 !ğ
NULL
è
	`sÿm³r_sourûs_unob£rve
(observer);

1714  
NULL
;

1715 
	}
}

1721 
	$sÿm³r_sourûs_unob£rve
(
sÿm³r_sourû_ob£rv”_t
 *
ob£rv”
)

1723 
	`dli¡_node_pİ
(
ob£rv”s
, 
ob£rv”
->
node
);

1724 
	`ä“
(
ob£rv”
);

1726 if(
	`dli¡_couÁ
(
ob£rv”s
) == 0)

1728 
	`dli¡_ä“
(
ob£rv”s
);

1729 
ob£rv”s
 = 
NULL
;

1733 
	}
}

1740 
sÿm³r_sourû_t
 *
	$sÿm³r_sourûs_g‘
(*
Çme
)

1742 
sÿm³r_sourû_t
 
fšdme
;

1743 
sÿm³r_li¡_t
 
li¡
;

1745 
li¡
.
Çme
 =‚ame;

1746 
fšdme
.
li¡
 = &list;

1748  (
sÿm³r_sourû_t
 *)
	`¥ÏyŒ“_fšd
(
sourû_Œ“
, &
fšdme
);

1749 
	}
}

1759 
	$sÿm³r_sourûs_d–
(
sÿm³r_sourû_t
 *
sourû
)

1761 
	`sourûs_as£¹
();

1763 
	`sourû_æush_sks
(
sourû
);

1764 
	`sourû_æush_commªds
(
sourû
);

1765 
	`sourû_d‘ach
(
sourû
);

1768 if(
sourû
->
»fút
 > 1)

1773 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_DELETE
, 
NULL
);

1774 
	`sourû_ä“
(
sourû
);

1776 
	`sourûs_as£¹
();

1778 
	}
}

1786 
	$sÿm³r_sourûs_i£m±y
()

1788 
	`sourûs_as£¹
();

1794 if((
aùive
 !ğ
NULL
 && 
	`şi¡_couÁ
(active) > 0) ||

1795 (
blocked
 !ğ
NULL
 && 
	`dli¡_couÁ
(blocked) > 0) ||

1796 (
fšished
 !ğ
NULL
 && 
	`dli¡_couÁ
(finished) > 0))

1802 
	}
}

1809 
	$sÿm³r_sourûs_i¤—dy
()

1811 
	`sourûs_as£¹
();

1813 if(
sourû_cur
 !ğ
NULL
 || 
	`dli¡_couÁ
(
fšished
) > 0)

1819 
	}
}

1826 
	$sÿm³r_sourûs_em±y
()

1828 
sÿm³r_sourû_t
 *
sourû
;

1830 
	`sourûs_as£¹
();

1836 (
sourû
 = 
	`dli¡__g‘
(
blocked
)è!ğ
NULL
)

1838 
	`sourû_æush_commªds
(
sourû
);

1839 
	`sourû_d‘ach
(
sourû
);

1842 (
sourû
 = 
	`şi¡__g‘
(
aùive
)è!ğ
NULL
)

1844 
	`sourû_æush_commªds
(
sourû
);

1845 
	`sourû_d‘ach
(
sourû
);

1848 (
sourû
 = 
	`dli¡_h—d_g‘
(
fšished
)è!ğ
NULL
)

1850 
	`sourû_d‘ach
(
sourû
);

1853 
	`sourûs_as£¹
();

1855 
	}
}

1863 
	$sÿm³r_sourûs_fÜ—ch
(*
p
, (*
func
)(*, 
sÿm³r_sourû_t
 *))

1865 
	`¥ÏyŒ“_šÜd”
(
sourû_Œ“
, (
¥ÏyŒ“_šÜd”_t
)
func
, 
p
);

1867 
	}
}

1874 
	$sÿm³r_sourûs_g‘sk
(
sÿm³r_sk_t
 **
sk
)

1876 
sÿm³r_sourû_t
 *
sourû
;

1877 
commªd_t
 *
commªd
;

1879 
	`sourûs_as£¹
();

1881 (
sourû
 = 
	`dli¡_h—d_g‘
(
fšished
)è!ğ
NULL
)

1882 
	`sourû_d‘ach
(
sourû
);

1889 if(
sourû_cur
 !ğ
NULL
 && 
sourû_út
 >ğsourû_cur->
´iÜ™y
)

1890 
	`sourû_Ãxt
();

1892 (
sourû
 = 
sourû_cur
è!ğ
NULL
)

1894 
	`as£¹
(
sourû
->
´iÜ™y
 > 0);

1896 (
commªd
 = 
	`dli¡_h—d_pİ
(
sourû
->
commªds
)è!ğ
NULL
)

1898 if(
sourû
->
ke
 !ğ
NULL
)

1899 
sourû
->
	`ke
(sourû->
d©a
);

1901 
commªd
->
ty³
)

1903 
COMMAND_PROBE
:

1904 if(
	`commªd_´obe_hªdË
(
sourû
, 
commªd
, 
sk
) != 0)

1905 
”r
;

1906 if(*
sk
 =ğ
NULL
)

1908 
sourû_út
++;

1909 
dÚe
;

1911 
COMMAND_TASK
:

1912 if(
	`commªd_sk_hªdË
(
sourû
, 
commªd
, 
sk
) != 0)

1913 
”r
;

1914 if(*
sk
 =ğ
NULL
)

1916 
sourû_út
++;

1917 
dÚe
;

1919 
COMMAND_CYCLE
:

1920 
	`commªd_cyşe_hªdË
(
sourû
, 
commªd
);

1924 
”r
;

1929 
	`as£¹
(
	`dli¡_couÁ
(
sourû
->
commªds
) == 0);

1935 if(
	`sÿm³r_sourû_isfšished
(
sourû
) == 0)

1936 
	`sourû_blocked_©ch
(
sourû
);

1938 
	`sourû_d‘ach
(
sourû
);

1941 *
sk
 = 
NULL
;

1943 
dÚe
:

1944 
	`sourûs_as£¹
();

1947 
”r
:

1948 
	`sourûs_as£¹
();

1950 
	}
}

1957 
	$sÿm³r_sourûs_add
(
sÿm³r_sourû_t
 *
sourû
)

1959 
buf
[512];

1961 
	`as£¹
(
sourû
 !ğ
NULL
);

1962 
	`sourûs_as£¹
();

1964 if(
	`sÿm³r_sourû_to¡r
(
sourû
, 
buf
, (buf)è!ğ
NULL
)

1965 
	`sÿm³r_debug
(
__func__
, "%s", 
buf
);

1968 if((
sourû
->
Œ“_node
 = 
	`¥ÏyŒ“_š£¹
(
sourû_Œ“
, sourû)è=ğ
NULL
)

1969 
”r
;

1970 
	`sÿm³r_sourû_u£
(
sourû
);

1973 if(
	`sourû_aùive_©ch
(
sourû
) != 0)

1974 
”r
;

1976 
	`sÿm³r_sourû_ev’t_po¡
(
sourû
, 
SCAMPER_SOURCE_EVENT_ADD
, 
NULL
);

1977 
	`sourûs_as£¹
();

1980 
”r
:

1981 
	`sourûs_as£¹
();

1983 
	}
}

1990 
	$sÿm³r_sourûs_š™
()

1992 if((
aùive
 = 
	`şi¡_®loc
()è=ğ
NULL
)

1995 if((
blocked
 = 
	`dli¡_®loc
()è=ğ
NULL
)

1998 if((
fšished
 = 
	`dli¡_®loc
()è=ğ
NULL
)

2001 if((
sourû_Œ“
 = 
	`¥ÏyŒ“_®loc
(
sourû_cmp
)è=ğ
NULL
)

2005 
	}
}

2012 
	$sÿm³r_sourûs_ş—nup
()

2014 
f
, 
b
, 
a
;

2016 
f
 = 
fšished
 !ğ
NULL
 ? 
	`dli¡_couÁ
(finished) : 0;

2017 
b
 = 
blocked
 !ğ
NULL
 ? 
	`dli¡_couÁ
(blocked) : 0;

2018 
a
 = 
aùive
 !ğ
NULL
 ? 
	`şi¡_couÁ
(active) : 0;

2020 if(
f
 !ğ0 || 
b
 !ğ0 || 
a
 != 0)

2021 
	`sÿm³r_debug
(
__func__
, "fšished %d, blocked %d,‡ùiv%d", 
f
, 
b
, 
a
);

2023 if(
sourû_Œ“
 !ğ
NULL
)

2025 
	`¥ÏyŒ“_ä“
(
sourû_Œ“
, 
NULL
);

2026 
sourû_Œ“
 = 
NULL
;

2029 if(
blocked
 !ğ
NULL
)

2031 
	`dli¡_ä“
(
blocked
);

2032 
blocked
 = 
NULL
;

2035 if(
aùive
 !ğ
NULL
)

2037 
	`şi¡_ä“
(
aùive
);

2038 
aùive
 = 
NULL
;

2041 if(
fšished
 !ğ
NULL
)

2043 
	`dli¡_ä“
(
fšished
);

2044 
fšished
 = 
NULL
;

2048 
	}
}

	@scamper_sources.h

25 #iâdeà
__SCAMPER_SOURCE_H


26 
	#__SCAMPER_SOURCE_H


	)

28 
sÿm³r_sourû
 
	tsÿm³r_sourû_t
;

30 
	#SCAMPER_SOURCE_TYPE_FILE
 1

	)

31 
	#SCAMPER_SOURCE_TYPE_CMDLINE
 2

	)

32 
	#SCAMPER_SOURCE_TYPE_CONTROL
 3

	)

33 
	#SCAMPER_SOURCE_TYPE_TSPS
 4

	)

35 
	#SCAMPER_SOURCE_TYPE_MIN
 1

	)

36 
	#SCAMPER_SOURCE_TYPE_MAX
 4

	)

39 
sÿm³r_sourûsk
 
	tsÿm³r_sourûsk_t
;

41 
	ssÿm³r_sourû_·¿ms


52 *
	mÇme
;

53 *
	mdesü
;

54 
ušt32_t
 
	mli¡_id
;

55 
ušt32_t
 
	mcyşe_id
;

56 
	mty³
;

57 
ušt32_t
 
	m´iÜ™y
;

58 
sÿm³r_outfe_t
 *
	msof
;

63 *
	md©a
;

64 (*
	mke
)(*
	md©a
);

65 (*
	mä“d©a
)(*
	md©a
);

66 (*
	misfšished
)(*
	md©a
);

67 * (*
	mto¡r
)(*
	md©a
, *
	m¡r
, 
size_t
 
	mËn
);

69 } 
	tsÿm³r_sourû_·¿ms_t
;

72 
sÿm³r_sourû_t
 *
sÿm³r_sourû_®loc
(cÚ¡ 
sÿm³r_sourû_·¿ms_t
 *
s¥
);

73 
sÿm³r_sourû_t
 *
sÿm³r_sourû_u£
(sÿm³r_sourû_ˆ*
sourû
);

74 
sÿm³r_sourû_ä“
(
sÿm³r_sourû_t
 *
sourû
);

75 
sÿm³r_sourû_abªdÚ
(
sÿm³r_sourû_t
 *
sourû
);

78 
sÿm³r_sourû_fšished
(
sÿm³r_sourû_t
 *
sourû
);

81 cÚ¡ *
sÿm³r_sourû_g‘Çme
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

82 cÚ¡ *
sÿm³r_sourû_g‘desü
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

83 cÚ¡ *
sÿm³r_sourû_g‘outfe
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

84 
ušt32_t
 
sÿm³r_sourû_g‘li¡id
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

85 
ušt32_t
 
sÿm³r_sourû_g‘cyşeid
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

86 
sÿm³r_sourû_g‘ty³
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

87 
ušt32_t
 
sÿm³r_sourû_g‘´iÜ™y
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

88 
sÿm³r_sourû_£riÜ™y
(
sÿm³r_sourû_t
 *
sourû
, 
ušt32_t
 
´iÜ™y
);

91 cÚ¡ *
sÿm³r_sourû_ty³_to¡r
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

92 *
sÿm³r_sourû_to¡r
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
, *
b
, 
size_t
 
l
);

95 *
sÿm³r_sourû_g‘d©a
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

96 
sÿm³r_sourû_£td©a
(
sÿm³r_sourû_t
 *
sourû
, *
d©a
);

99 
sÿm³r_sourû_g‘commªdcouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

100 
sÿm³r_sourû_g‘cyşecouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

101 
sÿm³r_sourû_g‘skcouÁ
(cÚ¡ 
sÿm³r_sourû_t
 *
sourû
);

104 
sÿm³r_sourû_isfšished
(
sÿm³r_sourû_t
 *
sourû
);

107 
sÿm³r_sourû_commªd
(
sÿm³r_sourû_t
 *
sourû
, cÚ¡ *
commªd
);

108 
sÿm³r_sourû_commªd2
(
sÿm³r_sourû_t
 *
sourû
, cÚ¡ *
commªd
,

109 
ušt32_t
 *
id
);

110 
sÿm³r_sourû_cyşe
(
sÿm³r_sourû_t
 *
sourû
);

111 
sÿm³r_sourû_sk
(
sÿm³r_sourû_t
 *
sourû
, 
sÿm³r_sk
 *
sk
);

112 
sÿm³r_sourû_h®‰ask
(
sÿm³r_sourû_t
 *
sourû
, 
ušt32_t
 
id
);

115 
sÿm³r_sourûsk_ä“
(
sÿm³r_sourûsk_t
 *
¡
);

116 
sÿm³r_sourû_t
 *
sÿm³r_sourûsk_g‘sourû
(
sÿm³r_sourûsk_t
 *
¡
);

119 
sÿm³r_sourûs_add
(
sÿm³r_sourû_t
 *
sourû
);

120 
sÿm³r_sourûs_g‘sk
(
sÿm³r_sk
 **
sk
);

121 
sÿm³r_sourûs_d–
(
sÿm³r_sourû_t
 *
sourû
);

122 
sÿm³r_sourû_t
 *
sÿm³r_sourûs_g‘
(*
Çme
);

123 
sÿm³r_sourûs_i¤—dy
();

124 
sÿm³r_sourûs_i£m±y
();

125 
sÿm³r_sourûs_fÜ—ch
(*
p
, (*
func
)(*, 
sÿm³r_sourû_t
 *));

126 
	`sÿm³r_sourûs_em±y
();

127 
	`sÿm³r_sourûs_š™
();

128 
	`sÿm³r_sourûs_ş—nup
();

135 
	ssÿm³r_sourû_ev’t


137 
sÿm³r_sourû_t
 *
sourû
;

138 
time_t
 
£c
;

139 
ev’t
;

141 
	#SCAMPER_SOURCE_EVENT_ADD
 0x01

	)

142 
	#SCAMPER_SOURCE_EVENT_UPDATE
 0x02

	)

143 
	#SCAMPER_SOURCE_EVENT_CYCLE
 0x03

	)

144 
	#SCAMPER_SOURCE_EVENT_DELETE
 0x04

	)

145 
	#SCAMPER_SOURCE_EVENT_FINISH
 0x05

	)

150 
	ss£_upd©e


152 
ušt8_t
 
æags
;

153 
autÜ–ßd
;

154 
cyşes
;

155 
´iÜ™y
;

156 } 
s£u_upd©e
;

158 
	#s£_upd©e_æags
 
s£_un
.
s£u_upd©e
.
æags


	)

159 
	#s£_upd©e_autÜ–ßd
 
s£_un
.
s£u_upd©e
.
autÜ–ßd


	)

160 
	#s£_upd©e_cyşes
 
s£_un
.
s£u_upd©e
.
cyşes


	)

161 
	#s£_upd©e_´iÜ™y
 
s£_un
.
s£u_upd©e
.
´iÜ™y


	)

163 
	ss£_cyşe


165 
cyşe_id
;

166 } 
s£u_cyşe
;

168 
	#s£_cyşe_cyşe_id
 
s£_un
.
s£u_cyşe
.
cyşe_id


	)

170 } 
s£_un
;

172 } 
	tsÿm³r_sourû_ev’t_t
;

174 
sÿm³r_sourû_ob£rv”
 
	tsÿm³r_sourû_ob£rv”_t
;

176 (*
	tsÿm³r_sourû_ev’tf_t
)(cÚ¡ 
	tsÿm³r_sourû_ev’t_t
 *
	ts£
,

177 *
	t·¿m
);

178 
sÿm³r_sourû_ob£rv”_t
 *
	`sÿm³r_sourûs_ob£rve
(
sÿm³r_sourû_ev’tf_t
 
cb
,

179 *
·¿m
);

180 
	`sÿm³r_sourûs_unob£rve
(
sÿm³r_sourû_ob£rv”_t
 *
ob£rv”
);

182 
	`sÿm³r_sourû_ev’t_po¡
(
sÿm³r_sourû_t
 *
sourû
, 
ty³
,

183 
sÿm³r_sourû_ev’t_t
 *
ev
);

	@scamper_task.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_icmp_»¥.h
"

39 
	~"sÿm³r_fds.h
"

40 
	~"sÿm³r_sk.h
"

41 
	~"sÿm³r_queue.h
"

42 
	~"sÿm³r_debug.h
"

43 
	~"sÿm³r_li¡.h
"

44 
	~"sÿm³r_cyşemÚ.h
"

45 
	~"sÿm³r_outfes.h
"

46 
	~"sÿm³r_sourûs.h
"

47 
	~"sÿm³r_fe.h
"

48 
	~"sÿm³r_¹sock.h
"

49 
	~"sÿm³r_dl.h
"

50 
	~"mjl_li¡.h
"

51 
	~"mjl_¥ÏyŒ“.h
"

52 
	~"uts.h
"

54 
	ssÿm³r_sk


57 *
	md©a
;

60 *
	m¡©e
;

63 
dli¡_t
 *
	mÚhŞd
;

66 
sÿm³r_sk_funcs_t
 *
	mfuncs
;

69 
sÿm³r_queue_t
 *
	mqueue
;

72 
sÿm³r_sourûsk_t
 *
	msourûsk
;

75 
sÿm³r_cyşemÚ
 *
	mcyşemÚ
;

78 
¦i¡_t
 *
	msigli¡
;

81 
dli¡_t
 *
	mªcÏry
;

84 
sÿm³r_fd_t
 **
	mfds
;

85 
	mfdc
;

88 
	ssÿm³r_sk_ªc


90 *
	md©a
;

91 (*
	mä“d©a
)(*);

92 
dli¡_node_t
 *
	mnode
;

95 
	ss2t


97 
sÿm³r_sk_sig_t
 *
	msig
;

98 
sÿm³r_sk_t
 *
	msk
;

99 *
	mnode
;

100 } 
	ts2t_t
;

102 
	ssk_ÚhŞd


104 (*
	munhŞd
)(*
	m·¿m
);

105 *
	m·¿m
;

106 } 
	tsk_ÚhŞd_t
;

108 
¥ÏyŒ“_t
 *
	gtx_
 = 
NULL
;

109 
¥ÏyŒ“_t
 *
	gtx_nd
 = 
NULL
;

110 
dli¡_t
 *
	g¢iff
 = 
NULL
;

112 
	$tx__cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

114 cÚ¡ 
sÿm³r_sk_sig_t
 *
a
 = ((cÚ¡ 
s2t_t
 *)
va
)->
sig
;

115 cÚ¡ 
sÿm³r_sk_sig_t
 *
b
 = ((cÚ¡ 
s2t_t
 *)
vb
)->
sig
;

116 
	`as£¹
(
a
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
);

117 
	`as£¹
(
b
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
);

118  
	`sÿm³r_addr_cmp
(
a
->
sig_tx__d¡
, 
b
->sig_tx_ip_dst);

119 
	}
}

121 
	$tx_nd_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

123 cÚ¡ 
sÿm³r_sk_sig_t
 *
a
 = ((cÚ¡ 
s2t_t
 *)
va
)->
sig
;

124 cÚ¡ 
sÿm³r_sk_sig_t
 *
b
 = ((cÚ¡ 
s2t_t
 *)
vb
)->
sig
;

125 
	`as£¹
(
a
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
);

126 
	`as£¹
(
b
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
);

127  
	`sÿm³r_addr_cmp
(
a
->
sig_tx_nd_
, 
b
->sig_tx_nd_ip);

128 
	}
}

130 
	$tx__check
(
sÿm³r_dl_»c_t
 *
dl
)

132 
sÿm³r_sk_sig_t
 
sig
;

133 
sÿm³r_addr_t
 
addr
;

134 
s2t_t
 
fm
, *
s2t
;

136 if(
	`SCAMPER_DL_IS_IPV4
(
dl
))

137 
addr
.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

138 if(
	`SCAMPER_DL_IS_IPV6
(
dl
))

139 
addr
.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

143 if(
dl
->
dl__off
 != 0)

145 
addr
.add¸ğ
dl
->
dl__¤c
;

147 if(
	`SCAMPER_DL_IS_TCP
(
dl
))

149 if((
dl
->
dl_tı_æags
 & 
TH_SYN
è&& (dl->dl_tı_æag & 
TH_ACK
) == 0)

150 
addr
.add¸ğ
dl
->
dl__d¡
;

152 
addr
.add¸ğ
dl
->
dl__¤c
;

154 if(
	`SCAMPER_DL_IS_ICMP
(
dl
))

156 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REQUEST
(
dl
))

157 
addr
.add¸ğ
dl
->
dl__d¡
;

158 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
))

159 
addr
.add¸ğ
dl
->
dl__¤c
;

160 if(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
))

161 
addr
.add¸ğ
dl
->
dl_icmp__d¡
;

162 if(
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
))

163 
addr
.add¸ğ
dl
->
dl_icmp__d¡
;

164 if(
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
))

165 
addr
.add¸ğ
dl
->
dl_icmp__d¡
;

171 
addr
.add¸ğ
dl
->
dl__d¡
;

174 
fm
.
sig
 = &sig;

175 
sig
.
sig_ty³
 = 
SCAMPER_TASK_SIG_TYPE_TX_IP
;

176 
sig
.
sig_tx__d¡
 = &
addr
;

178 if((
s2t
 = 
	`¥ÏyŒ“_fšd
(
tx_
, &
fm
)è=ğ
NULL
)

181 if(
s2t
->
sk
->
funcs
->
hªdË_dl
 !ğ
NULL
)

182 
s2t
->
sk
->
funcs
->
	`hªdË_dl
(s2t->sk, 
dl
);

185 
	}
}

187 
	$tx_nd_check
(
sÿm³r_dl_»c_t
 *
dl
)

189 
sÿm³r_sk_sig_t
 
sig
;

190 
sÿm³r_addr_t
 

;

191 
s2t_t
 
fm
, *
s2t
;

193 if(
	`¥ÏyŒ“_couÁ
(
tx_nd
) <= 0)

196 if(
	`SCAMPER_DL_IS_ARP_OP_REPLY
(
dl
è&& 
	`SCAMPER_DL_IS_ARP_PRO_IPV4
(dl))

198 

.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

199 

.
addr
 = 
dl
->
dl_¬p_¥a
;

201 if(
	`SCAMPER_DL_IS_ICMP6_ND_NADV
(
dl
))

203 

.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

204 

.
addr
 = 
dl
->
dl_icmp6_nd_rg‘
;

208 
sig
.
sig_ty³
 = 
SCAMPER_TASK_SIG_TYPE_TX_ND
;

209 
sig
.
sig_tx_nd_
 = &

;

210 
fm
.
sig
 = &sig;

211 if((
s2t
 = 
	`¥ÏyŒ“_fšd
(
tx_nd
, &
fm
)è=ğ
NULL
)

214 if(
s2t
->
sk
->
funcs
->
hªdË_dl
 !ğ
NULL
)

215 
s2t
->
sk
->
funcs
->
	`hªdË_dl
(s2t->sk, 
dl
);

218 
	}
}

220 
	$¢iff_check
(
sÿm³r_dl_»c_t
 *
dl
)

222 
sÿm³r_sk_sig_t
 *
sig
;

223 
s2t_t
 *
s2t
;

224 
dli¡_node_t
 *
n
;

225 
sÿm³r_addr_t
 
¤c
;

226 
ušt16_t
 
id
;

228 if(
	`dli¡_couÁ
(
¢iff
) <= 0)

231 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
))

232 
id
 = 
dl
->
dl_icmp_id
;

233 if(
	`SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO
(
dl
))

234 
id
 = 
dl
->
dl_icmp_icmp_id
;

238 if(
	`SCAMPER_DL_IS_IPV4
(
dl
))

239 
¤c
.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

240 if(
	`SCAMPER_DL_IS_IPV6
(
dl
))

241 
¤c
.
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

244 
¤c
.
addr
 = 
dl
->
dl__d¡
;

246 
n
 = 
	`dli¡_h—d_node
(
¢iff
);‚ !ğ
NULL
;‚ = 
	`dli¡_node_Ãxt
(n))

248 
s2t
 = 
	`dli¡_node_™em
(
n
); 
sig
 = s2t->sig;

249 if(
sig
->
sig_¢iff_icmp_id
 !ğ
id
)

251 if(
	`sÿm³r_addr_cmp
(
sig
->
sig_¢iff_¤c
, &
¤c
) != 0)

254 if(
s2t
->
sk
->
funcs
->
hªdË_dl
 !ğ
NULL
)

255 
s2t
->
sk
->
funcs
->
	`hªdË_dl
(s2t->sk, 
dl
);

259 
	}
}

261 
	$s2t_ä“
(
s2t_t
 *
s2t
)

263 
sÿm³r_sk_sig_t
 *
sig
 = 
s2t
->sig;

265 if(
s2t
 =ğ
NULL
)

268 if(
s2t
->
node
 !ğ
NULL
)

270 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
)

271 
	`¥ÏyŒ“_»move_node
(
tx_
, 
s2t
->
node
);

272 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
)

273 
	`¥ÏyŒ“_»move_node
(
tx_nd
, 
s2t
->
node
);

274 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_SNIFF
)

275 
	`dli¡_node_pİ
(
¢iff
, 
s2t
->
node
);

278 
	`ä“
(
s2t
);

280 
	}
}

282 *
	$sÿm³r_sk_sig_to¡r
(
sÿm³r_sk_sig_t
 *
sig
, *
buf
, 
size_t
 
Ën
)

284 
tmp
[64];

285 
size_t
 
off
 = 0;

287 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
)

288 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "ip %s",

289 
	`sÿm³r_addr_to¡r
(
sig
->
sig_tx__d¡
, 
tmp
, (tmp)));

290 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
)

291 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "nd %s",

292 
	`sÿm³r_addr_to¡r
(
sig
->
sig_tx_nd_
, 
tmp
, (tmp)));

293 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_SNIFF
)

294 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "sniff %s icmp-id %04x",

295 
	`sÿm³r_addr_to¡r
(
sig
->
sig_¢iff_¤c
, 
tmp
, (tmp)),

296 
sig
->
sig_¢iff_icmp_id
);

298  
NULL
;

300  
buf
;

301 
	}
}

303 
sÿm³r_sk_sig_t
 *
	$sÿm³r_sk_sig_®loc
(
ušt8_t
 
ty³
)

305 
sÿm³r_sk_sig_t
 *
sig
;

306 if((
sig
 = 
	`m®loc_z”o
((
sÿm³r_sk_sig_t
))è!ğ
NULL
)

307 
sig
->
sig_ty³
 = 
ty³
;

308  
sig
;

309 
	}
}

311 
	$sÿm³r_sk_sig_ä“
(
sÿm³r_sk_sig_t
 *
sig
)

313 if(
sig
 =ğ
NULL
)

316 
sig
->
sig_ty³
)

318 
SCAMPER_TASK_SIG_TYPE_TX_IP
:

319 if(
sig
->
sig_tx__d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sig->sig_tx_ip_dst);

320 if(
sig
->
sig_tx__¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sig->sig_tx_ip_src);

323 
SCAMPER_TASK_SIG_TYPE_TX_ND
:

324 if(
sig
->
sig_tx_nd_
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sig->sig_tx_nd_ip);

327 
SCAMPER_TASK_SIG_TYPE_SNIFF
:

328 if(
sig
->
sig_¢iff_¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sig->sig_sniff_src);

332 
	`ä“
(
sig
);

334 
	}
}

336 
sÿm³r_sk_ªc_t
 *
	$sÿm³r_sk_ªc_add
(
sÿm³r_sk_t
 *
sk
, *
d©a
,

337 (*
ä“d©a
)(*))

339 
sÿm³r_sk_ªc_t
 *
ªc
 = 
NULL
;

340 if(
sk
->
ªcÏry
 =ğ
NULL
 && (sk->ªcÏry = 
	`dli¡_®loc
()) == NULL)

341  
NULL
;

342 if((
ªc
 = 
	`m®loc_z”o
((
sÿm³r_sk_ªc_t
))è=ğ
NULL
)

343  
NULL
;

344 
ªc
->
d©a
 = data;

345 
ªc
->
ä“d©a
 = freedata;

346 if((
ªc
->
node
 = 
	`dli¡__push
(
sk
->
ªcÏry
,‡nc)è=ğ
NULL
)

348 
	`ä“
(
ªc
);

349  
NULL
;

351  
ªc
;

352 
	}
}

354 
	$sÿm³r_sk_ªc_d–
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_sk_ªc_t
 *
ªc
)

356 if(
ªc
 =ğ
NULL
)

358 
	`dli¡_node_pİ
(
sk
->
ªcÏry
, 
ªc
->
node
);

359 
	`ä“
(
ªc
);

361 
	}
}

363 
	$sÿm³r_sk_sig_add
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_sk_sig_t
 *
sig
)

365 
s2t_t
 *
s2t
;

366 if((
s2t
 = 
	`m®loc_z”o
((
s2t_t
))è=ğ
NULL
)

368 
s2t
->
sig
 = sig;

369 
s2t
->
sk
 =ask;

370 if(
	`¦i¡__push
(
sk
->
sigli¡
, 
s2t
è=ğ
NULL
)

373 
	}
}

375 
sÿm³r_sk_t
 *
	$sÿm³r_sk_fšd
(
sÿm³r_sk_sig_t
 *
sig
)

377 
s2t_t
 
fm
, *
s2t
;

379 
fm
.
sig
 = sig;

380 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
)

381 
s2t
 = 
	`¥ÏyŒ“_fšd
(
tx_
, &
fm
);

382 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
)

383 
s2t
 = 
	`¥ÏyŒ“_fšd
(
tx_nd
, &
fm
);

385  
NULL
;

387 if(
s2t
 !ğ
NULL
)

388  
s2t
->
sk
;

389  
NULL
;

390 
	}
}

392 
	$sÿm³r_sk_sig_deš¡®l
(
sÿm³r_sk_t
 *
sk
)

394 
s2t_t
 *
s2t
;

395 
sÿm³r_sk_sig_t
 *
sig
;

396 
¦i¡_node_t
 *
n
;

398 
n
=
	`¦i¡_h—d_node
(
sk
->
sigli¡
);‚ !ğ
NULL
;‚ = 
	`¦i¡_node_Ãxt
(n))

400 
s2t
 = 
	`¦i¡_node_™em
(
n
); 
sig
 = s2t->sig;

401 
	`s2t_ä“
(
s2t
);

402 
	`sÿm³r_sk_sig_ä“
(
sig
);

406 
	}
}

408 
	$sÿm³r_sk_sig_š¡®l
(
sÿm³r_sk_t
 *
sk
)

410 
sÿm³r_sk_sig_t
 *
sig
;

411 
sÿm³r_sk_t
 *
tf
;

412 
s2t_t
 *
s2t
;

413 
¦i¡_node_t
 *
n
;

415 if(
	`¦i¡_couÁ
(
sk
->
sigli¡
) < 1)

418 
n
=
	`¦i¡_h—d_node
(
sk
->
sigli¡
);‚ !ğ
NULL
;‚ = 
	`¦i¡_node_Ãxt
(n))

420 
s2t
 = 
	`¦i¡_node_™em
(
n
); 
sig
 = s2t->sig;

423 if((
tf
 = 
	`sÿm³r_sk_fšd
(
sig
)è!ğ
NULL
)

425 if(
tf
 !ğ
sk
)

426 
”r
;

430 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_IP
)

431 
s2t
->
node
 = 
	`¥ÏyŒ“_š£¹
(
tx_
, s2t);

432 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_TX_ND
)

433 
s2t
->
node
 = 
	`¥ÏyŒ“_š£¹
(
tx_nd
, s2t);

434 if(
sig
->
sig_ty³
 =ğ
SCAMPER_TASK_SIG_TYPE_SNIFF
)

435 
s2t
->
node
 = 
	`dli¡__push
(
¢iff
, s2t);

437 if(
s2t
->
node
 =ğ
NULL
)

439 
	`sÿm³r_debug
(
__func__
, "could‚ot install sig");

440 
”r
;

446 
”r
:

447 
	`sÿm³r_sk_sig_deš¡®l
(
sk
);

449 
	}
}

458 
sÿm³r_sk_t
 *
	$sÿm³r_sk_sig_block
(
sÿm³r_sk_t
 *
sk
)

460 
sÿm³r_sk_sig_t
 *
sig
;

461 
sÿm³r_sk_t
 *
tf
;

462 
¦i¡_node_t
 *
n
;

463 
s2t_t
 *
s2t
;

465 
n
=
	`¦i¡_h—d_node
(
sk
->
sigli¡
);‚ !ğ
NULL
;‚ = 
	`¦i¡_node_Ãxt
(n))

467 
s2t
 = 
	`¦i¡_node_™em
(
n
); 
sig
 = s2t->sig;

468 if((
tf
 = 
	`sÿm³r_sk_fšd
(
sig
)è!ğ
NULL
 &&à!ğ
sk
)

469  
tf
;

472  
NULL
;

473 
	}
}

475 *
	$sÿm³r_sk_ÚhŞd
(
sÿm³r_sk_t
 *
sk
, *
·¿m
,

476 (*
unhŞd
)(*
·¿m
))

478 
sk_ÚhŞd_t
 *
toh
 = 
NULL
;

479 
dli¡_node_t
 *
cook›
;

481 if(
sk
->
ÚhŞd
 =ğ
NULL
 && (sk->ÚhŞd = 
	`dli¡_®loc
()) == NULL)

482 
”r
;

483 if((
toh
 = 
	`m®loc
((
sk_ÚhŞd_t
))è=ğ
NULL
)

484 
”r
;

485 if((
cook›
 = 
	`dli¡__push
(
sk
->
ÚhŞd
, 
toh
)è=ğ
NULL
)

486 
”r
;

488 
toh
->
·¿m
 =…aram;

489 
toh
->
unhŞd
 = unhold;

491  
cook›
;

493 
”r
:

494 if(
toh
 !ğ
NULL
è
	`ä“
(toh);

495  
NULL
;

496 
	}
}

498 
	$sÿm³r_sk_dehŞd
(
sÿm³r_sk_t
 *
sk
, *
cook›
)

500 
sk_ÚhŞd_t
 *
toh
;

501 
	`as£¹
(
sk
->
ÚhŞd
 !ğ
NULL
);

502 if((
toh
 = 
	`dli¡_node_pİ
(
sk
->
ÚhŞd
, 
cook›
)è=ğ
NULL
)

504 
	`ä“
(
toh
);

506 
	}
}

513 
sÿm³r_sk_t
 *
	$sÿm³r_sk_®loc
(*
d©a
, 
sÿm³r_sk_funcs_t
 *
funcs
)

515 
sÿm³r_sk_t
 *
sk
;

517 
	`as£¹
(
d©a
 !ğ
NULL
);

518 
	`as£¹
(
funcs
 !ğ
NULL
);

520 if((
sk
 = 
	`m®loc_z”o
((
sÿm³r_sk_t
))è=ğ
NULL
)

522 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot mallocask");

523 
”r
;

526 if((
sk
->
queue
 = 
	`sÿm³r_queue_®loc
Ñask)è=ğ
NULL
)

527 
”r
;

529 if((
sk
->
sigli¡
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

530 
”r
;

532 
sk
->
funcs
 = funcs;

533 
sk
->
d©a
 = data;

535  
sk
;

537 
”r
:

538 
	`sÿm³r_sk_ä“
(
sk
);

539  
NULL
;

540 
	}
}

550 
	$sÿm³r_sk_ä“
(
sÿm³r_sk_t
 *
sk
)

552 
sÿm³r_sk_ªc_t
 *
ªc
;

553 
sk_ÚhŞd_t
 *
toh
;

554 
i
;

556 if(
sk
->
funcs
 !ğ
NULL
)

557 
sk
->
funcs
->
	`sk_ä“
(task);

559 if(
sk
->
queue
 !ğ
NULL
)

561 
	`sÿm³r_queue_ä“
(
sk
->
queue
);

562 
sk
->
queue
 = 
NULL
;

565 if(
sk
->
ÚhŞd
 !ğ
NULL
)

567 (
toh
 = 
	`dli¡_h—d_pİ
(
sk
->
ÚhŞd
)è!ğ
NULL
)

569 
toh
->
	`unhŞd
Ñoh->
·¿m
);

570 
	`ä“
(
toh
);

572 
	`dli¡_ä“
(
sk
->
ÚhŞd
);

575 if(
sk
->
cyşemÚ
 !ğ
NULL
)

577 
	`sÿm³r_cyşemÚ_unu£
(
sk
->
cyşemÚ
);

578 
sk
->
cyşemÚ
 = 
NULL
;

581 if(
sk
->
sourûsk
 !ğ
NULL
)

583 
	`sÿm³r_sourûsk_ä“
(
sk
->
sourûsk
);

584 
sk
->
sourûsk
 = 
NULL
;

587 if(
sk
->
sigli¡
 !ğ
NULL
)

589 
	`sÿm³r_sk_sig_deš¡®l
(
sk
);

590 
	`¦i¡_ä“
(
sk
->
sigli¡
);

593 if(
sk
->
ªcÏry
 !ğ
NULL
)

595 (
ªc
 = 
	`dli¡_h—d_pİ
(
sk
->
ªcÏry
)è!ğ
NULL
)

597 
ªc
->
node
 = 
NULL
;

598 
ªc
->
	`ä“d©a
×nc->
d©a
);

599 
	`ä“
(
ªc
);

601 
	`dli¡_ä“
(
sk
->
ªcÏry
);

604 if(
sk
->
fds
 !ğ
NULL
)

606 
i
=0; i<
sk
->
fdc
; i++)

607 
	`sÿm³r_fd_ä“
(
sk
->
fds
[
i
]);

608 
	`ä“
(
sk
->
fds
);

611 
	`ä“
(
sk
);

613 
	}
}

615 *
	$sÿm³r_sk_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

617  
sk
->
d©a
;

618 
	}
}

620 *
	$sÿm³r_sk_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

622  
sk
->
¡©e
;

623 
	}
}

625 
	$sÿm³r_sk_£td©ªuÎ
(
sÿm³r_sk_t
 *
sk
)

627 
sk
->
d©a
 = 
NULL
;

629 
	}
}

631 
	$sÿm³r_sk_£t¡©e
(
sÿm³r_sk_t
 *
sk
, *
¡©e
)

633 
sk
->
¡©e
 = state;

635 
	}
}

637 
sÿm³r_sourû_t
 *
	$sÿm³r_sk_g‘sourû
(
sÿm³r_sk_t
 *
sk
)

639 if(
sk
->
sourûsk
 =ğ
NULL
)  NULL;

640  
	`sÿm³r_sourûsk_g‘sourû
(
sk
->
sourûsk
);

641 
	}
}

643 
	$sÿm³r_sk_£tsourûsk
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_sourûsk_t
 *
¡
)

645 
	`as£¹
(
sk
->
sourûsk
 =ğ
NULL
);

646 
sk
->
sourûsk
 = 
¡
;

648 
	}
}

650 
	$sÿm³r_sk_£tcyşemÚ
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_cyşemÚ_t
 *
cm
)

652 
sk
->
cyşemÚ
 = 
	`sÿm³r_cyşemÚ_u£
(
cm
);

654 
	}
}

656 
	$sÿm³r_sk_wr™e
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_fe_t
 *
fe
)

658 
sk
->
funcs
->
	`wr™e
(
fe
,ask);

660 
	}
}

662 
	$sÿm³r_sk_´obe
(
sÿm³r_sk_t
 *
sk
)

664 
sk
->
funcs
->
	`´obe
(task);

666 
	}
}

668 
	$sÿm³r_sk_h®t
(
sÿm³r_sk_t
 *
sk
)

670 
sk
->
funcs
->
	`h®t
(task);

672 
	}
}

674 
	$sÿm³r_sk_hªdËicmp
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
»¥
)

676 if(
sk
->
funcs
->
hªdË_icmp
 !ğ
NULL
)

677 
sk
->
funcs
->
	`hªdË_icmp
Ñask, 
»¥
);

679 
	}
}

681 
	$sÿm³r_sk_hªdËdl
(
sÿm³r_dl_»c_t
 *
dl
)

683 
	`tx__check
(
dl
);

684 
	`tx_nd_check
(
dl
);

685 
	`¢iff_check
(
dl
);

687 
	}
}

689 
	$sÿm³r_sk_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
)

691 if(
sk
->
funcs
->
hªdË_timeout
 !ğ
NULL
)

692 
sk
->
funcs
->
	`hªdË_timeout
(task);

694 
	}
}

696 
	$sÿm³r_sk_queue_´obe
(
sÿm³r_sk_t
 *
sk
)

698  
	`sÿm³r_queue_´obe
(
sk
->
queue
);

699 
	}
}

701 
	$sÿm³r_sk_queue_´obe_h—d
(
sÿm³r_sk_t
 *
sk
)

703  
	`sÿm³r_queue_´obe_h—d
(
sk
->
queue
);

704 
	}
}

706 
	$sÿm³r_sk_queue_wa™
(
sÿm³r_sk_t
 *
sk
, 
ms
)

708  
	`sÿm³r_queue_wa™
(
sk
->
queue
, 
ms
);

709 
	}
}

711 
	$sÿm³r_sk_queue_wa™_tv
(
sÿm³r_sk_t
 *
sk
, 
timev®
 *
tv
)

713  
	`sÿm³r_queue_wa™_tv
(
sk
->
queue
, 
tv
);

714 
	}
}

716 
	$sÿm³r_sk_queue_dÚe
(
sÿm³r_sk_t
 *
sk
, 
ms
)

718  
	`sÿm³r_queue_dÚe
(
sk
->
queue
, 
ms
);

719 
	}
}

721 
	$sÿm³r_sk_queue_i¥robe
(
sÿm³r_sk_t
 *
sk
)

723  
	`sÿm³r_queue_i¥robe
(
sk
->
queue
);

724 
	}
}

726 
	$sÿm³r_sk_queue_isdÚe
(
sÿm³r_sk_t
 *
sk
)

728  
	`sÿm³r_queue_isdÚe
(
sk
->
queue
);

729 
	}
}

731 
	$sk_fd_cmp
(cÚ¡ 
sÿm³r_fd_t
 *
a
, cÚ¡ sÿm³r_fd_ˆ*
b
)

733 if(
a
 < 
b
)  -1;

734 if(
a
 > 
b
)  1;

736 
	}
}

743 
sÿm³r_fd_t
 *
	$sk_fd
(
sÿm³r_sk_t
 *
t
, 
sÿm³r_fd_t
 *
fd
)

745 if(
fd
 =ğ
NULL
)

746  
NULL
;

748 if(
	`¬¿y_fšd
((**)
t
->
fds
,->
fdc
, 
fd
, (
¬¿y_cmp_t
)
sk_fd_cmp
è=ğ
NULL
)

750 if(
	`¬¿y_š£¹
((***)&
t
->
fds
, &t->
fdc
, 
fd
,

751 (
¬¿y_cmp_t
)
sk_fd_cmp
) != 0)

753 
	`sÿm³r_fd_ä“
(
fd
);

754  
NULL
;

760 
	`sÿm³r_fd_ä“
(
fd
);

762  
fd
;

763 
	}
}

765 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_icmp4
(
sÿm³r_sk_t
 *
sk
, *
addr
)

767 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_icmp4
(
addr
);

768  
	`sk_fd
(
sk
, 
fd
);

769 
	}
}

771 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_icmp6
(
sÿm³r_sk_t
 *
sk
, *
addr
)

773 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_icmp6
(
addr
);

774  
	`sk_fd
(
sk
, 
fd
);

775 
	}
}

777 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_udp4
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
)

779 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_udp4
(
a
, 
¥
);

780  
	`sk_fd
(
sk
, 
fd
);

781 
	}
}

783 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_udp6
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
)

785 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_udp6
(
a
, 
¥
);

786  
	`sk_fd
(
sk
, 
fd
);

787 
	}
}

789 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_tı4
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
)

791 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_tı4
(
a
, 
¥
);

792  
	`sk_fd
(
sk
, 
fd
);

793 
	}
}

795 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_tı6
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
)

797 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_tı6
(
a
, 
¥
);

798  
	`sk_fd
(
sk
, 
fd
);

799 
	}
}

801 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_dl
(
sÿm³r_sk_t
 *
sk
, 
ifšdex
)

803 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_dl
(
ifšdex
);

804  
	`sk_fd
(
sk
, 
fd
);

805 
	}
}

807 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_4
(
sÿm³r_sk_t
 *
sk
)

809 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_4
();

810  
	`sk_fd
(
sk
, 
fd
);

811 
	}
}

813 #iâdeà
_WIN32


814 
sÿm³r_fd_t
 *
	$sÿm³r_sk_fd_¹sock
(
sÿm³r_sk_t
 *
sk
)

816 
sÿm³r_fd_t
 *
fd
 = 
	`sÿm³r_fd_¹sock
();

817  
	`sk_fd
(
sk
, 
fd
);

818 
	}
}

821 
	$sÿm³r_sk_š™
()

823 if((
tx_
 = 
	`¥ÏyŒ“_®loc
(
tx__cmp
)è=ğ
NULL
)

825 if((
tx_nd
 = 
	`¥ÏyŒ“_®loc
(
tx_nd_cmp
)è=ğ
NULL
)

827 if((
¢iff
 = 
	`dli¡_®loc
()è=ğ
NULL
)

830 
	}
}

832 
	$sÿm³r_sk_ş—nup
()

834 if(
tx_
 !ğ
NULL
)

836 
	`¥ÏyŒ“_ä“
(
tx_
, 
NULL
);

837 
tx_
 = 
NULL
;

840 if(
tx_nd
 !ğ
NULL
)

842 
	`¥ÏyŒ“_ä“
(
tx_nd
, 
NULL
);

843 
tx_nd
 = 
NULL
;

846 if(
¢iff
 !ğ
NULL
)

848 
	`dli¡_ä“
(
¢iff
);

849 
¢iff
 = 
NULL
;

853 
	}
}

	@scamper_task.h

26 #iâdeà
__SCAMPER_TASK_H


27 
	#__SCAMPER_TASK_H


	)

29 
	gsÿm³r_addr
;

30 
	gsÿm³r_queue
;

31 
	gsÿm³r_sk
;

32 
	gsÿm³r_dl_»c
;

33 
	gsÿm³r_icmp_»¥
;

34 
	gsÿm³r_cyşemÚ
;

35 
	gsÿm³r_fe
;

36 
	gsÿm³r_sourûsk
;

38 
	#SCAMPER_TASK_SIG_TYPE_TX_IP
 1

	)

39 
	#SCAMPER_TASK_SIG_TYPE_TX_ND
 2

	)

40 
	#SCAMPER_TASK_SIG_TYPE_SNIFF
 3

	)

42 
sÿm³r_sk
 
	tsÿm³r_sk_t
;

43 
sÿm³r_sk_ªc
 
	tsÿm³r_sk_ªc_t
;

45 
	ssÿm³r_sk_sig


47 
ušt8_t
 
	msig_ty³
;

50 
	stx_


52 
sÿm³r_addr
 *
	md¡
;

53 
sÿm³r_addr
 *
	m¤c
;

54 } 
	m
;

55 
	stx_nd


57 
sÿm³r_addr
 *
	m
;

58 } 
	mnd
;

59 
	s¢iff


61 
sÿm³r_addr
 *
	m¤c
;

62 
ušt16_t
 
	micmpid
;

63 } 
	m¢iff
;

64 } 
	mun
;

65 } 
	tsÿm³r_sk_sig_t
;

67 
	#sig_tx__d¡
 
un
.

.
d¡


	)

68 
	#sig_tx__¤c
 
un
.

.
¤c


	)

69 
	#sig_tx_nd_
 
un
.
nd
.



	)

70 
	#sig_¢iff_¤c
 
un
.
¢iff
.
¤c


	)

71 
	#sig_¢iff_icmp_id
 
un
.
¢iff
.
icmpid


	)

73 
	ssÿm³r_sk_funcs


76 (*
	m´obe
)(
sÿm³r_sk
 *
	msk
);

79 (*
	mhªdË_icmp
)(
sÿm³r_sk
 *
	msk
,

80 
sÿm³r_icmp_»¥
 *
	micmp
);

83 (*
	mhªdË_dl
)(
sÿm³r_sk
 *
	msk
, 
sÿm³r_dl_»c
 *
	mdl_»c
);

86 (*
	mhªdË_timeout
)(
sÿm³r_sk
 *
	msk
);

88 (*
	mh®t
)(
sÿm³r_sk
 *
	msk
);

91 (*
	mwr™e
)(
sÿm³r_fe
 *
	mfe
, 
sÿm³r_sk
 *
	msk
);

94 (*
	msk_ä“
)(
sÿm³r_sk
 *
	msk
);

96 } 
	tsÿm³r_sk_funcs_t
;

98 
sÿm³r_sk_t
 *
sÿm³r_sk_®loc
(*
d©a
, 
sÿm³r_sk_funcs_t
 *
funcs
);

99 
sÿm³r_sk_ä“
(
sÿm³r_sk_t
 *
sk
);

102 *
sÿm³r_sk_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
);

103 *
sÿm³r_sk_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
);

104 
sÿm³r_sourû
 *
sÿm³r_sk_g‘sourû
(
sÿm³r_sk_t
 *
sk
);

107 
sÿm³r_sk_£td©ªuÎ
(
sÿm³r_sk_t
 *
sk
);

108 
sÿm³r_sk_£t¡©e
(
sÿm³r_sk_t
 *
sk
, *
¡©e
);

109 
sÿm³r_sk_£tsourûsk
(
sÿm³r_sk_t
 *
sk
,

110 
sÿm³r_sourûsk
 *
¡
);

111 
sÿm³r_sk_£tcyşemÚ
(
sÿm³r_sk_t
 *
t
, 
sÿm³r_cyşemÚ
 *
cm
);

114 
sÿm³r_sk_wr™e
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_fe
 *
fe
);

115 
sÿm³r_sk_´obe
(
sÿm³r_sk_t
 *
sk
);

116 
sÿm³r_sk_hªdËicmp
(
sÿm³r_sk_t
 *
sk
,
sÿm³r_icmp_»¥
 *
r
);

117 
sÿm³r_sk_hªdËtimeout
(
sÿm³r_sk_t
 *
sk
);

118 
sÿm³r_sk_h®t
(
sÿm³r_sk_t
 *
sk
);

121 
sÿm³r_sk_hªdËdl
(
sÿm³r_dl_»c
 *
dl
);

124 
sÿm³r_sk_queue_´obe
(
sÿm³r_sk_t
 *
sk
);

125 
sÿm³r_sk_queue_´obe_h—d
(
sÿm³r_sk_t
 *
sk
);

126 
sÿm³r_sk_queue_wa™
(
sÿm³r_sk_t
 *
sk
, 
ms
);

127 
sÿm³r_sk_queue_wa™_tv
(
sÿm³r_sk_t
 *
sk
, 
timev®
 *
tv
);

128 
sÿm³r_sk_queue_dÚe
(
sÿm³r_sk_t
 *
sk
, 
ms
);

129 
sÿm³r_sk_queue_i¥robe
(
sÿm³r_sk_t
 *
sk
);

130 
sÿm³r_sk_queue_isdÚe
(
sÿm³r_sk_t
 *
sk
);

133 #ifdeà
__SCAMPER_FD_H


134 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_icmp4
(
sÿm³r_sk_t
 *
sk
, *
addr
);

135 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_icmp6
(
sÿm³r_sk_t
 *
sk
, *
addr
);

136 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_udp4
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
);

137 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_udp6
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
);

138 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_tı4
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
);

139 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_tı6
(
sÿm³r_sk_t
 *
sk
, *
a
, 
ušt16_t
 
¥
);

140 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_dl
(
sÿm³r_sk_t
 *
sk
, 
ifšdex
);

141 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_4
(
sÿm³r_sk_t
 *
sk
);

144 #ià
defšed
(
__SCAMPER_FD_H
è&& !defšed(
_WIN32
)

145 
sÿm³r_fd_t
 *
sÿm³r_sk_fd_¹sock
(
sÿm³r_sk_t
 *
sk
);

149 
sÿm³r_sk_sig_t
 *
sÿm³r_sk_sig_®loc
(
ušt8_t
 
ty³
);

150 
sÿm³r_sk_sig_ä“
(
sÿm³r_sk_sig_t
 *
sig
);

151 
sÿm³r_sk_sig_add
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_sk_sig_t
 *
sig
);

152 
sÿm³r_sk_t
 *
sÿm³r_sk_sig_block
(sÿm³r_sk_ˆ*
sk
);

153 
sÿm³r_sk_sig_š¡®l
(
sÿm³r_sk_t
 *
sk
);

154 
sÿm³r_sk_sig_deš¡®l
(
sÿm³r_sk_t
 *
sk
);

155 
sÿm³r_sk_t
 *
sÿm³r_sk_fšd
(
sÿm³r_sk_sig_t
 *
sig
);

156 *
sÿm³r_sk_sig_to¡r
(
sÿm³r_sk_sig_t
 *
sig
, *
buf
, 
size_t
 
Ën
);

159 
sÿm³r_sk_ªc_t
 *
sÿm³r_sk_ªc_add
(
sÿm³r_sk_t
 *
sk
, *
d©a
,

160 (*
ä“d©a
)(*));

161 
	`sÿm³r_sk_ªc_d–
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_sk_ªc_t
 *
ªc
);

172 *
	`sÿm³r_sk_ÚhŞd
(
sÿm³r_sk_t
 *
sk
, *
·¿m
,

173 (*
unhŞd
)(*
·¿m
));

181 
	`sÿm³r_sk_dehŞd
(
sÿm³r_sk_t
 *
sk
, *
cook›
);

183 
	`sÿm³r_sk_š™
();

184 
	`sÿm³r_sk_ş—nup
();

	@scamper_tcp4.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_dl.h
"

38 
	~"sÿm³r_´obe.h
"

39 
	~"sÿm³r_4.h
"

40 
	~"sÿm³r_tı4.h
"

41 
	~"sÿm³r_debug.h
"

42 
	~"uts.h
"

49 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

50 
size_t
 
	gpktbuf_Ën
 = 0;

52 
size_t
 
	$tı_md5
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

54 
buf
[0] = 19;

55 
buf
[1] = 18;

56 
i
;

57 
i
=0;i<4;i++)

58 
	`by‹s_htÚl
(
buf
+2+(4*
i
), 
´obe
->
´_tı_md5dige¡
[i]);

60 
	}
}

62 
size_t
 
	$tı_auth
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

64 
buf
[0] = 29;

65 
buf
[1] = 20;

66 
buf
[2] = 
´obe
->
´_tı_authkeyid
;

67 
buf
[3] = 
´obe
->
´_tı_authºextkeyid
;

68 
i
;

69 
i
=0;i<4;i++)

70 
	`by‹s_htÚl
(
buf
+2+(4*
i
), 
´obe
->
´_tı_authmac
[i]);

72 
	}
}

74 
size_t
 
	$tı_mpÿ·bË
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

76 
buf
[0] = 30;

77 
buf
[1] = 12;

78 
buf
[2] = 0;

79 
buf
[3] = 129;

80 
	`by‹s_htÚl
(
buf
+4, 
´obe
->
´_tı_mpÿ·bË
);

81 
	`by‹s_htÚl
(
buf
+8, 
´obe
->
´_tı_mpÿ·bË2
);

83 
	}
}

85 
size_t
 
	$tı_mpjoš
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

87 
buf
[0] = 30;

88 
buf
[1] = 12;

89 
buf
[2] = 16;

90 
buf
[3] = 0;

91 
	`by‹s_htÚl
(
buf
+4, 
´obe
->
´_tı_mpjoš
);

92 
	`by‹s_htÚl
(
buf
+8, 
´obe
->
´_tı_mpjoš2
);

94 
	}
}

96 
size_t
 
	$tı_wsÿË
(
ušt8_t
 *
buf
, ušt8_ˆ
wsÿË
)

98 
buf
[0] = 3;

99 
buf
[1] = 3;

100 
buf
[2] = 
wsÿË
;

103 
	}
}

105 
size_t
 
	$tı_mss
(
ušt8_t
 *
buf
, 
ušt16_t
 
mss
)

107 
buf
[0] = 2;

108 
buf
[1] = 4;

109 
	`by‹s_htÚs
(
buf
+2, 
mss
);

111 
	}
}

113 
size_t
 
	$tı_§ckp
(
ušt8_t
 *
buf
)

115 
buf
[0] = 4;

116 
buf
[1] = 2;

118 
	}
}

120 
size_t
 
	$tı_§ck
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´
)

122 
size_t
 
off
 = 2;

123 
ušt8_t
 
i
;

124 
	`as£¹
(
´
->
´_tı_§ckb
 > 0);

125 
	`as£¹
(
´
->
´_tı_§ckb
 <= 4);

126 
buf
[0] = 5;

127 
i
=0; i<
´
->
´_tı_§ckb
 * 2; i++)

129 
	`by‹s_htÚl
(
buf
+
off
, 
´
->
´_tı_§ck
[
i
]);

130 
off
 += 4;

132 
buf
[1] = 
off
;

133  
off
;

134 
	}
}

136 
size_t
 
	$tı_nİ
(
ušt8_t
 *
buf
)

138 
buf
[0] = 1;

140 
	}
}

142 
size_t
 
	$tı_ts
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

144 
buf
[0] = 8;

145 
buf
[1] = 10;

146 
	`by‹s_htÚl
(
buf
+2, 
´obe
->
´_tı_tsv®
);

147 
	`by‹s_htÚl
(
buf
+6, 
´obe
->
´_tı_t£ü
);

149 
	}
}

151 
	$tı_cksum
(
sÿm³r_´obe_t
 *
´obe
, 
tıhdr
 *
tı
, 
size_t
 
Ën
)

153 
ušt16_t
 *
w
;

154 
sum
 = 0;

161 
w
 = 
´obe
->
´__¤c
->
addr
;

162 
sum
 +ğ*
w
++; sum += *w++;

163 
w
 = 
´obe
->
´__d¡
->
addr
;

164 
sum
 +ğ*
w
++; sum += *w++;

165 
sum
 +ğ
	`htÚs
(
Ën
);

166 
sum
 +ğ
	`htÚs
(
IPPROTO_TCP
);

169 
w
 = (
ušt16_t
 *)
tı
;

170 
Ën
 > 1)

172 
sum
 +ğ*
w
++;

173 
Ën
 -= 2;

176 if(
Ën
 != 0)

177 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

180 
sum
 = (sum >> 16) + (sum & 0xffff);

181 
sum
 += (sum >> 16);

183 if((
tı
->
th_sum
 = ~
sum
) == 0)

184 
tı
->
th_sum
 = 0xffff;

187 
	}
}

189 
	$tı4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
)

191 
tıhdr
 *
tı
 = (tıhd¸*)
buf
;

192 
size_t
 
tıhËn
 = 20;

194 
tı
->
th_¥Üt
 = 
	`htÚs
(
´obe
->
´_tı_¥Üt
);

195 
tı
->
th_dpÜt
 = 
	`htÚs
(
´obe
->
´_tı_dpÜt
);

196 
tı
->
th_£q
 = 
	`htÚl
(
´obe
->
´_tı_£q
);

197 
tı
->
th_ack
 = 
	`htÚl
(
´obe
->
´_tı_ack
);

198 
tı
->
th_æags
 = 
´obe
->
´_tı_æags
;

199 
tı
->
th_wš
 = 
	`htÚs
(
´obe
->
´_tı_wš
);

200 
tı
->
th_sum
 = 0;

201 
tı
->
th_u½
 = 0;

203 if(
´obe
->
´_tı_æags
 & 
TH_SYN
)

205 if(
´obe
->
´_tı_mss
 != 0)

206 
tıhËn
 +ğ
	`tı_mss
(
buf
+tıhËn, 
´obe
->
´_tı_mss
);

207 if((
´obe
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_SACK
) != 0)

208 
tıhËn
 +ğ
	`tı_§ckp
(
buf
+tcphlen);

209 if(
´obe
->
´_tı_mpÿ·bË
 != 0)

210 
tıhËn
 +ğ
	`tı_mpÿ·bË
(
buf
+tıhËn, 
´obe
);

211 if(
´obe
->
´_tı_mpjoš
 != 0)

212 
tıhËn
 +ğ
	`tı_mpjoš
(
buf
+tıhËn, 
´obe
);

213 if(
´obe
->
´_tı_wsÿË
 != 0)

214 
tıhËn
 +ğ
	`tı_wsÿË
(
buf
+tıhËn, 
´obe
->
´_tı_wsÿË
);

215 if(
´obe
->
´_tı_md5
 != 0)

216 
tıhËn
 +ğ
	`tı_md5
(
buf
+tıhËn, 
´obe
);

217 if(
´obe
->
´_tı_auth
 != 0)

218 
tıhËn
 +ğ
	`tı_auth
(
buf
+tıhËn, 
´obe
);

222 if((
´obe
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_TS
) != 0)

224 
tıhËn
 +ğ
	`tı_ts
(
buf
+tıhËn, 
´obe
);

225 (
tıhËn
 % 4) != 0)

226 
tıhËn
 +ğ
	`tı_nİ
(
buf
+tcphlen);

229 if(
´obe
->
´_tı_§ckb
 != 0)

230 
tıhËn
 +ğ
	`tı_§ck
(
buf
+tıhËn, 
´obe
);

232 (
tıhËn
 % 4) != 0)

233 
tıhËn
 +ğ
	`tı_nİ
(
buf
+tcphlen);

235 #iâdeà
_WIN32


236 
tı
->
th_off
 = 
tıhËn
 >> 2;

237 
tı
->
th_x2
 = 0;

239 
tı
->
th_offx2
 = ((
tıhËn
 >> 2) << 4);

243 if(
´obe
->
´_Ën
 > 0)

244 
	`memıy
(
buf
 + 
tıhËn
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

247 
	`tı_cksum
(
´obe
, 
tı
, 
tıhËn
 +…robe->
´_Ën
);

250 
	}
}

252 
size_t
 
	$sÿm³r_tı4_hËn
(
sÿm³r_´obe_t
 *
´
)

254 
size_t
 
Ën
 = 20;

255 if(
´
->
´_tı_æags
 & 
TH_SYN
)

257 if(
´
->
´_tı_mss
 != 0)

258 
Ën
 += 4;

259 if((
´
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_SACK
) != 0)

260 
Ën
 += 2;

261 if(
´
->
´_tı_wsÿË
 != 0)

262 
Ën
 += 3;

263 if(
´
->
´_tı_mpÿ·bË
 != 0)

264 
Ën
 += 12;

265 if(
´
->
´_tı_mpjoš
 != 0)

266 
Ën
 += 12;

267 if(
´
->
´_tı_md5
 != 0)

268 
Ën
 += 18;

269 if(
´
->
´_tı_auth
 != 0)

270 
Ën
 += 20;

272 if((
´
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_TS
) != 0)

274 
Ën
 += 10;

275 if(
´
->
´_tı_§ckb
 != 0)

276 (
Ën
 % 4) != 0)

277 
Ën
++;

279 if(
´
->
´_tı_§ckb
 != 0)

280 
Ën
 +ğ((8 * 
´
->
´_tı_§ckb
) + 2);

281 (
Ën
 % 4) != 0)

282 
Ën
++;

283 
	`as£¹
(
Ën
 <= 60);

284  
Ën
;

285 
	}
}

287 
	$sÿm³r_tı4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

289 
size_t
 
4hËn
, 
»q
;

290 
rc
 = 0;

292 
4hËn
 = *
Ën
;

293 
	`sÿm³r_4_bud
(
´obe
, 
buf
, &
4hËn
);

294 
»q
 = 
4hËn
 + 
	`sÿm³r_tı4_hËn
(
´obe
è+…robe->
´_Ën
;

296 if(
»q
 <ğ*
Ën
)

297 
	`tı4_bud
(
´obe
, 
buf
 + 
4hËn
);

299 
rc
 = -1;

301 *
Ën
 = 
»q
;

302  
rc
;

303 
	}
}

305 
	$sÿm³r_tı4_´obe
(
sÿm³r_´obe_t
 *
´
)

307 
sockaddr_š
 
sš4
;

308 
i
;

309 
addr
[128];

310 
size_t
 
4hËn
, 
tıhËn
, 
Ën
, 
tmp
;

312 #ià!
	`defšed
(
IP_HDR_HTONS
)

313 

 *ip;

316 
	`as£¹
(
´
 !ğ
NULL
);

317 
	`as£¹
(
´
->
´__´Ùo
 =ğ
IPPROTO_TCP
);

318 
	`as£¹
(
´
->
´__d¡
 !ğ
NULL
);

319 
	`as£¹
(
´
->
´__¤c
 !ğ
NULL
);

320 
	`as£¹
(
´
->
´_Ën
 > 0 ||…r->
´_d©a
 =ğ
NULL
);

323 
	`sÿm³r_4_hËn
(
´
, &
4hËn
);

324 
tıhËn
 = 
	`sÿm³r_tı4_hËn
(
´
);

325 
Ën
 = 
4hËn
 + 
tıhËn
 + 
´
->
´_Ën
;

327 
i
 = 
Ën
;

328 if(
	`£tsockİt
(
´
->
´_fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
i
, (i)) == -1)

330 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
,"could‚Ù s‘ bufã¸tØ%d by‹s",
i
);

334 if(
pktbuf_Ën
 < 
Ën
)

336 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
Ën
) != 0)

338 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

341 
pktbuf_Ën
 = 
Ën
;

344 
tmp
 = 
Ën
;

345 
	`sÿm³r_4_bud
(
´
, 
pktbuf
, &
tmp
);

347 #ià!
	`defšed
(
IP_HDR_HTONS
)

348 

 = ( *)
pktbuf
;

349 

->
_Ën
 = 
	`Áohs
(ip->ip_len);

350 

->
_off
 = 
	`Áohs
(ip->ip_off);

353 
	`tı4_bud
(
´
, 
pktbuf
 + 
4hËn
);

355 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, 
´
->
´__d¡
->
addr
, 0);

358 
	`g‘timeofday_w¿p
(&
´
->
´_tx
);

360 
i
 = 
	`£ndto
(
´
->
´_fd
, 
pktbuf
, 
Ën
, 0, (
sockaddr
 *)&
sš4
,

361 (
sockaddr_š
));

363 if(
i
 < 0)

366 
´
->
´_”ºo
 = 
”ºo
;

367 
	`´š‹¼Ü
(
´
->
´_”ºo
, 
¡»¼Ü
, 
__func__
,

369 
	`sÿm³r_addr_to¡r
(
´
->
´__d¡
, 
addr
, (addr)),

370 
´
->
´__‰l
,…r->
´_tı_dpÜt
, 
Ën
);

373 if((
size_t
)
i
 !ğ
Ën
)

376 
	`årštf
(
¡d”r
,

378 
i
, ()
Ën
,

379 
	`sÿm³r_addr_to¡r
(
´
->
´__d¡
, 
addr
, (addr)));

384 
	}
}

386 
	$sÿm³r_tı4_ş—nup
()

388 if(
pktbuf
 !ğ
NULL
)

390 
	`ä“
(
pktbuf
);

391 
pktbuf
 = 
NULL
;

395 
	}
}

397 
	$sÿm³r_tı4_şo£
(
fd
)

399 #iâdeà
_WIN32


400 
	`şo£
(
fd
);

402 
	`şo£sock‘
(
fd
);

405 
	}
}

407 
	$sÿm³r_tı4_İ’
(cÚ¡ *
addr
, 
¥Üt
)

409 
sockaddr_š
 
sš4
;

410 
tmp
[32];

411 
İt
, 
fd
 = -1;

413 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) == -1)

415 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

416 
”r
;

419 
İt
 = 1;

420 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
İt
, (opt)) != 0)

422 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_REUSEADDR");

423 
”r
;

426 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, 
addr
, 
¥Üt
);

427 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš4
, (sin4)) == -1)

429 if(
addr
 =ğ
NULL
 || 
	`addr_to¡r
(
AF_INET
,‡ddr, 
tmp
, (tmp)) == NULL)

430 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd…Üˆ%d", 
¥Üt
);

432 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd %s:%d", 
tmp
, 
¥Üt
);

433 
”r
;

436  
fd
;

438 
”r
:

439 if(
fd
 !ğ-1è
	`sÿm³r_tı4_şo£
(fd);

441 
	}
}

	@scamper_tcp4.h

25 #iâdeà
__SCAMPER_TCP4_H


26 
	#__SCAMPER_TCP4_H


	)

28 
sÿm³r_tı4_İ’
(cÚ¡ *
addr
, 
¥Üt
);

29 
sÿm³r_tı4_şo£
(
fd
);

30 
sÿm³r_tı4_ş—nup
();

32 #ifdeà
__SCAMPER_PROBE_H


33 
size_t
 
sÿm³r_tı4_hËn
(
sÿm³r_´obe_t
 *
´obe
);

34 
sÿm³r_tı4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

35 
sÿm³r_tı4_´obe
(
sÿm³r_´obe_t
 *
´obe
);

	@scamper_tcp6.c

26 #iâdeà
lšt


27 cÚ¡ 
	grcsid
[] =

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

34 
	~"š‹º®.h
"

36 
	~"sÿm³r_addr.h
"

37 
	~"sÿm³r_dl.h
"

38 
	~"sÿm³r_´obe.h
"

39 
	~"sÿm³r_6.h
"

40 
	~"sÿm³r_tı6.h
"

42 
	~"sÿm³r_debug.h
"

43 
	~"uts.h
"

46 
size_t
 
	$tı_md5
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

48 
buf
[0] = 19;

49 
buf
[1] = 18;

50 
i
;

51 
i
=0;i<4;i++)

52 
	`by‹s_htÚl
(
buf
+2+(4*
i
), 
´obe
->
´_tı_md5dige¡
[i]);

54 
	}
}

56 
size_t
 
	$tı_auth
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

58 
buf
[0] = 29;

59 
buf
[1] = 20;

60 
buf
[2] = 
´obe
->
´_tı_authkeyid
;

61 
buf
[3] = 
´obe
->
´_tı_authºextkeyid
;

62 
i
;

63 
i
=0;i<4;i++)

64 
	`by‹s_htÚl
(
buf
+2+(4*
i
), 
´obe
->
´_tı_authmac
[i]);

66 
	}
}

68 
size_t
 
	$tı_mpÿ·bË
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

70 
buf
[0] = 30;

71 
buf
[1] = 12;

72 
buf
[2] = 0;

73 
buf
[3] = 129;

74 
	`by‹s_htÚl
(
buf
+4, 
´obe
->
´_tı_mpÿ·bË
);

75 
	`by‹s_htÚl
(
buf
+8, 
´obe
->
´_tı_mpÿ·bË2
);

77 
	}
}

79 
size_t
 
	$tı_mpjoš
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

81 
buf
[0] = 30;

82 
buf
[1] = 12;

83 
buf
[2] = 16;

84 
buf
[3] = 0;

85 
	`by‹s_htÚl
(
buf
+4, 
´obe
->
´_tı_mpjoš
);

86 
	`by‹s_htÚl
(
buf
+8, 
´obe
->
´_tı_mpjoš2
);

88 
	}
}

90 
size_t
 
	$tı_wsÿË
(
ušt8_t
 *
buf
, ušt8_ˆ
wsÿË
)

92 
buf
[0] = 3;

93 
buf
[1] = 3;

94 
buf
[2] = 
wsÿË
;

97 
	}
}

99 
size_t
 
	$tı_mss
(
ušt8_t
 *
buf
, 
ušt16_t
 
mss
)

101 
buf
[0] = 2;

102 
buf
[1] = 4;

103 
	`by‹s_htÚs
(
buf
+2, 
mss
);

105 
	}
}

107 
size_t
 
	$tı_§ckp
(
ušt8_t
 *
buf
)

109 
buf
[0] = 4;

110 
buf
[1] = 2;

112 
	}
}

114 
size_t
 
	$tı_§ck
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´
)

116 
size_t
 
off
 = 2;

117 
ušt8_t
 
i
;

118 
	`as£¹
(
´
->
´_tı_§ckb
 > 0);

119 
	`as£¹
(
´
->
´_tı_§ckb
 <= 4);

120 
buf
[0] = 5;

121 
i
=0; i<
´
->
´_tı_§ckb
 * 2; i++)

123 
	`by‹s_htÚl
(
buf
+
off
, 
´
->
´_tı_§ck
[
i
]);

124 
off
 += 4;

126 
buf
[1] = 
off
;

127  
off
;

128 
	}
}

130 
size_t
 
	$tı_nİ
(
ušt8_t
 *
buf
)

132 
buf
[0] = 1;

134 
	}
}

136 
size_t
 
	$tı_ts
(
ušt8_t
 *
buf
, cÚ¡ 
sÿm³r_´obe_t
 *
´obe
)

138 
buf
[0] = 8;

139 
buf
[1] = 10;

140 
	`by‹s_htÚl
(
buf
+2, 
´obe
->
´_tı_tsv®
);

141 
	`by‹s_htÚl
(
buf
+6, 
´obe
->
´_tı_t£ü
);

143 
	}
}

145 
	$tı_cksum
(
6_hdr
 *
6
, 
tıhdr
 *
tı
, 
size_t
 
Ën
)

147 
ušt16_t
 *
w
;

148 
sum
 = 0;

155 
w
 = (
ušt16_t
 *)&
6
->
6_¤c
;

156 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

157 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

158 
w
 = (
ušt16_t
 *)&
6
->
6_d¡
;

159 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

160 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

161 
sum
 +ğ
	`htÚs
(
Ën
);

162 
sum
 +ğ
	`htÚs
(
IPPROTO_TCP
);

165 
w
 = (
ušt16_t
 *)
tı
;

166 
Ën
 > 1)

168 
sum
 +ğ*
w
++;

169 
Ën
 -= 2;

172 if(
Ën
 != 0)

174 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

178 
sum
 = (sum >> 16) + (sum & 0xffff);

179 
sum
 += (sum >> 16);

181 if((
tı
->
th_sum
 = ~
sum
) == 0)

183 
tı
->
th_sum
 = 0xffff;

187 
	}
}

189 
size_t
 
	$sÿm³r_tı6_hËn
(
sÿm³r_´obe_t
 *
´
)

191 
size_t
 
tıhËn
 = 20;

192 if(
´
->
´_tı_æags
 & 
TH_SYN
)

194 if(
´
->
´_tı_mss
 != 0)

195 
tıhËn
 += 4;

196 if((
´
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_SACK
) != 0)

197 
tıhËn
 += 2;

198 if(
´
->
´_tı_mpÿ·bË
 != 0)

199 
tıhËn
 += 12;

200 if(
´
->
´_tı_mpjoš
 != 0)

201 
tıhËn
 += 12;

202 if(
´
->
´_tı_wsÿË
 != 0)

203 
tıhËn
 += 3;

204 if(
´
->
´_tı_md5
 != 0)

205 
tıhËn
 += 18;

206 if(
´
->
´_tı_auth
 != 0)

207 
tıhËn
 += 20;

209 if((
´
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_TS
) != 0)

211 
tıhËn
 += 10;

212 if(
´
->
´_tı_§ckb
 != 0)

213 (
tıhËn
 % 4) != 0)

214 
tıhËn
++;

216 if(
´
->
´_tı_§ckb
 != 0)

217 
tıhËn
 +ğ((8 * 
´
->
´_tı_§ckb
) + 2);

218 (
tıhËn
 % 4) != 0)

219 
tıhËn
++;

220 
	`as£¹
(
tıhËn
 <= 60);

221  
tıhËn
;

222 
	}
}

224 
	$sÿm³r_tı6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

226 
6_hdr
 *
6
;

227 
tıhdr
 *
tı
;

228 
size_t
 
6hËn
, 
tıhËn
, 
»q
;

231 
6hËn
 = *
Ën
;

232 
	`sÿm³r_6_bud
(
´obe
, 
buf
, &
6hËn
);

235 
tıhËn
 = 
	`sÿm³r_tı6_hËn
(
´obe
);

238 
»q
 = 
6hËn
 + 
tıhËn
 + 
´obe
->
´_Ën
;

240 if(
»q
 <ğ*
Ën
)

242 
6
 = (
6_hdr
 *)
buf
;

243 
6
->
6_¶’
 = 
	`htÚs
(
6hËn
 - 40 + 
tıhËn
 + 
´obe
->
´_Ën
);

246 
tı
 = (
tıhdr
 *)(
buf
 + 
6hËn
);

247 
tı
->
th_¥Üt
 = 
	`htÚs
(
´obe
->
´_tı_¥Üt
);

248 
tı
->
th_dpÜt
 = 
	`htÚs
(
´obe
->
´_tı_dpÜt
);

249 
tı
->
th_£q
 = 
	`htÚl
(
´obe
->
´_tı_£q
);

250 
tı
->
th_ack
 = 
	`htÚl
(
´obe
->
´_tı_ack
);

251 
tı
->
th_æags
 = 
´obe
->
´_tı_æags
;

252 
tı
->
th_wš
 = 
	`htÚs
(
´obe
->
´_tı_wš
);

253 
tı
->
th_sum
 = 0;

254 
tı
->
th_u½
 = 0;

256 
tıhËn
 = 20;

258 if(
´obe
->
´_tı_æags
 & 
TH_SYN
)

260 if(
´obe
->
´_tı_mss
 != 0)

261 
tıhËn
 +ğ
	`tı_mss
(
buf
+
6hËn
+tıhËn, 
´obe
->
´_tı_mss
);

262 if((
´obe
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_SACK
) != 0)

263 
tıhËn
 +ğ
	`tı_§ckp
(
buf
+
6hËn
+tcphlen);

264 if(
´obe
->
´_tı_mpÿ·bË
 != 0)

265 
tıhËn
 +ğ
	`tı_mpÿ·bË
(
buf
+
6hËn
+tıhËn, 
´obe
);

266 if(
´obe
->
´_tı_mpjoš
 != 0)

267 
tıhËn
 +ğ
	`tı_mpjoš
(
buf
+
6hËn
+tıhËn, 
´obe
);

268 if(
´obe
->
´_tı_wsÿË
 != 0)

269 
tıhËn
 +ğ
	`tı_wsÿË
(
buf
+
6hËn
+tıhËn, 
´obe
->
´_tı_wsÿË
);

270 if(
´obe
->
´_tı_md5
 != 0)

271 
tıhËn
 +ğ
	`tı_md5
(
buf
+
6hËn
+tıhËn, 
´obe
);

272 if(
´obe
->
´_tı_auth
 != 0)

273 
tıhËn
 +ğ
	`tı_auth
(
buf
+
6hËn
+tıhËn, 
´obe
);

276 if((
´obe
->
´_tı_İts
 & 
SCAMPER_PROBE_TCPOPT_TS
) != 0)

278 
tıhËn
 +ğ
	`tı_ts
(
buf
+
6hËn
+tıhËn, 
´obe
);

279 (
tıhËn
 % 4) != 0)

280 
tıhËn
 +ğ
	`tı_nİ
(
buf
+
6hËn
+tcphlen);

283 if(
´obe
->
´_tı_§ckb
 != 0)

284 
tıhËn
 +ğ
	`tı_§ck
(
buf
+
6hËn
+tıhËn, 
´obe
);

286 (
tıhËn
 % 4) != 0)

287 
tıhËn
 +ğ
	`tı_nİ
(
buf
+
6hËn
+tcphlen);

289 #iâdeà
_WIN32


290 
tı
->
th_off
 = 
tıhËn
 >> 2;

291 
tı
->
th_x2
 = 0;

293 
tı
->
th_offx2
 = ((
tıhËn
 >> 2) << 4);

297 if(
´obe
->
´_Ën
 > 0)

299 
	`memıy
(
buf
 + 
6hËn
 + 
tıhËn
, 
´obe
->
´_d©a
,…robe->
´_Ën
);

303 
	`tı_cksum
(
6
, 
tı
, 
tıhËn
 + 
´obe
->
´_Ën
);

305 *
Ën
 = 
»q
;

309 *
Ën
 = 
»q
;

311 
	}
}

313 
	$sÿm³r_tı6_şo£
(
fd
)

315 #iâdeà
_WIN32


316 
	`şo£
(
fd
);

318 
	`şo£sock‘
(
fd
);

321 
	}
}

323 
	$sÿm³r_tı6_İ’
(cÚ¡ *
addr
, 
¥Üt
)

325 
sockaddr_š6
 
sš6
;

326 
tmp
[128];

327 
fd
 = -1;

329 if((
fd
 = 
	`sock‘
(
AF_INET6
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) == -1)

331 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

332 
”r
;

335 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
, 
addr
, 
¥Üt
);

336 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš6
, (sin6)) == -1)

338 if(
addr
 =ğ
NULL
 || 
	`addr_to¡r
(
AF_INET6
,‡ddr, 
tmp
, (tmp)) == NULL)

339 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd…Üˆ%d", 
¥Üt
);

341 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd %s:%d", 
tmp
, 
¥Üt
);

342 
”r
;

345  
fd
;

347 
”r
:

348 if(
fd
 !ğ-1è
	`sÿm³r_tı6_şo£
(fd);

350 
	}
}

	@scamper_tcp6.h

25 #iâdeà
__SCAMPER_TCP6_H


26 
	#__SCAMPER_TCP6_H


	)

28 
sÿm³r_tı6_İ’
(cÚ¡ *
addr
, 
¥Üt
);

29 
sÿm³r_tı6_şo£
(
fd
);

31 #ifdeà
__SCAMPER_PROBE_H


32 
size_t
 
sÿm³r_tı6_hËn
(
sÿm³r_´obe_t
 *
´obe
);

33 
sÿm³r_tı6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

	@scamper_udp4.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_dl.h
"

37 
	~"sÿm³r_´obe.h
"

38 
	~"sÿm³r_4.h
"

39 
	~"sÿm³r_udp4.h
"

40 
	~"sÿm³r_´iv£p.h
"

41 
	~"sÿm³r_debug.h
"

42 
	~"uts.h
"

49 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

50 
size_t
 
	gpktbuf_Ën
 = 0;

52 
ušt16_t
 
	$sÿm³r_udp4_cksum
(
sÿm³r_´obe_t
 *
´obe
)

54 
ušt16_t
 
tmp
, *
w
;

55 
i
, 
sum
 = 0;

58 
w
 = (
ušt16_t
 *)
´obe
->
´__¤c
->
addr
;

59 
sum
 +ğ*
w
++; sum += *w++;

60 
w
 = (
ušt16_t
 *)
´obe
->
´__d¡
->
addr
;

61 
sum
 +ğ*
w
++; sum += *w++;

62 
sum
 +ğ
	`htÚs
(
IPPROTO_UDP
);

63 
sum
 +ğ
	`htÚs
(
´obe
->
´_Ën
 + 8);

66 
sum
 +ğ
	`htÚs
(
´obe
->
´_udp_¥Üt
);

67 
sum
 +ğ
	`htÚs
(
´obe
->
´_udp_dpÜt
);

68 
sum
 +ğ
	`htÚs
(
´obe
->
´_Ën
 + 8);

71 
w
 = (
ušt16_t
 *)
´obe
->
´_d©a
;

72 
i
 = 
´obe
->
´_Ën
; i > 1; i -= 2)

74 
sum
 +ğ*
w
++;

76 if(
i
 != 0)

78 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

82 
sum
 = (sum >> 16) + (sum & 0xffff);

83 
sum
 += (sum >> 16);

85 if((
tmp
 = ~
sum
) == 0)

87 
tmp
 = 0xffff;

90  
tmp
;

91 
	}
}

93 
	$udp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
)

95 
udphdr
 *
udp
 = (udphd¸*)
buf
;

97 
udp
->
uh_¥Üt
 = 
	`htÚs
(
´obe
->
´_udp_¥Üt
);

98 
udp
->
uh_dpÜt
 = 
	`htÚs
(
´obe
->
´_udp_dpÜt
);

99 
udp
->
uh_uËn
 = 
	`htÚs
(8 + 
´obe
->
´_Ën
);

100 
udp
->
uh_sum
 = 
	`sÿm³r_udp4_cksum
(
´obe
);

103 if(
´obe
->
´_Ën
 > 0)

105 
	`memıy
(
buf
 + 8, 
´obe
->
´_d©a
,…robe->
´_Ën
);

109 
	}
}

111 
	$sÿm³r_udp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

113 
size_t
 
4hËn
, 
»q
;

114 
rc
 = 0;

116 
4hËn
 = *
Ën
;

117 
	`sÿm³r_4_bud
(
´obe
, 
buf
, &
4hËn
);

118 
»q
 = 
4hËn
 + 8 + 
´obe
->
´_Ën
;

120 if(
»q
 <ğ*
Ën
)

121 
	`udp4_bud
(
´obe
, 
buf
 + 
4hËn
);

123 
rc
 = -1;

125 *
Ën
 = 
»q
;

126  
rc
;

127 
	}
}

129 
	$sÿm³r_udp4_´obe
(
sÿm³r_´obe_t
 *
´obe
)

131 
sockaddr_š
 
sš4
;

132 
i
;

133 
addr
[128];

134 
size_t
 
4hËn
, 
Ën
, 
tmp
;

135 
ušt8_t
 *
buf
;

137 #ià!
	`defšed
(
IP_HDR_HTONS
)

138 

 *ip;

141 
	`as£¹
(
´obe
 !ğ
NULL
);

142 
	`as£¹
(
´obe
->
´__´Ùo
 =ğ
IPPROTO_UDP
);

143 
	`as£¹
(
´obe
->
´__d¡
 !ğ
NULL
);

144 
	`as£¹
(
´obe
->
´__¤c
 !ğ
NULL
);

145 
	`as£¹
(
´obe
->
´_Ën
 > 0 ||…robe->
´_d©a
 =ğ
NULL
);

147 
	`sÿm³r_4_hËn
(
´obe
, &
4hËn
);

150 
Ën
 = 
4hËn
 + (
udphdr
è+ 
´obe
->
´_Ën
;

152 
i
 = 
Ën
;

153 if(
	`£tsockİt
(
´obe
->
´_fd
,

154 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
i
, (i)) == -1)

156 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

157 "could‚Ù s‘ bufã¸tØ%d by‹s", 
i
);

161 if(
pktbuf_Ën
 < 
Ën
)

163 if((
buf
 = 
	`»®loc
(
pktbuf
, 
Ën
)è=ğ
NULL
)

165 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

168 
pktbuf
 = 
buf
;

169 
pktbuf_Ën
 = 
Ën
;

172 
tmp
 = 
Ën
;

173 
	`sÿm³r_4_bud
(
´obe
, 
pktbuf
, &
tmp
);

175 #ià!
	`defšed
(
IP_HDR_HTONS
)

176 

 = ( *)
pktbuf
;

177 

->
_Ën
 = 
	`Áohs
(ip->ip_len);

178 

->
_off
 = 
	`Áohs
(ip->ip_off);

181 
	`udp4_bud
(
´obe
, 
pktbuf
 + 
4hËn
);

183 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
,

184 
´obe
->
´__d¡
->
addr
,…robe->
´_udp_dpÜt
);

187 
	`g‘timeofday_w¿p
(&
´obe
->
´_tx
);

189 
i
 = 
	`£ndto
(
´obe
->
´_fd
, 
pktbuf
, 
Ën
, 0, (
sockaddr
 *)&
sš4
,

190 (
sockaddr_š
));

192 if(
i
 < 0)

195 
´obe
->
´_”ºo
 = 
”ºo
;

196 
	`´š‹¼Ü
(
´obe
->
´_”ºo
, 
¡»¼Ü
, 
__func__
,

198 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)),

199 
´obe
->
´__‰l
,…robe->
´_udp_dpÜt
, 
Ën
);

202 if((
size_t
)
i
 !ğ
Ën
)

205 
	`årštf
(
¡d”r
,

207 
i
, ()
Ën
,

208 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)));

213 
	}
}

215 
	$sÿm³r_udp4_ş—nup
()

217 if(
pktbuf
 !ğ
NULL
)

219 
	`ä“
(
pktbuf
);

220 
pktbuf
 = 
NULL
;

224 
	}
}

226 
	$sÿm³r_udp4_şo£
(
fd
)

228 #iâdeà
_WIN32


229 
	`şo£
(
fd
);

231 
	`şo£sock‘
(
fd
);

234 
	}
}

236 
	$sÿm³r_udp4_İ’dg¿m
(cÚ¡ *
addr
, 
¥Üt
)

238 
sockaddr_š
 
sš4
;

239 
tmp
[32];

240 
fd
 = -1;

241 
İt
;

243 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) == -1)

245 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

246 
”r
;

249 
İt
 = 1;

250 if(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
İt
, (opt)) != 0)

252 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set SO_REUSEADDR");

253 
”r
;

256 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, 
addr
, 
¥Üt
);

257 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš4
, (sin4)) == -1)

259 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot bind %s",

260 
	`sockaddr_to¡r
((
sockaddr
 *)&
sš4
, 
tmp
, (tmp)));

261 
”r
;

264  
fd
;

266 
”r
:

267 if(
fd
 !ğ-1è
	`sÿm³r_udp4_şo£
(fd);

269 
	}
}

271 
	$sÿm³r_udp4_İ’¿w
(cÚ¡ *
addr
)

273 
fd
 = -1;

275 #ià
	`defšed
(
WITHOUT_PRIVSEP
)

276 
sockaddr_š
 
sš4
;

277 
tmp
[32];

278 
hdr
 = 1;

280 if((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_RAW
, 
IPPROTO_UDP
)) == -1)

282 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

283 
”r
;

285 if(
	`£tsockİt
(
fd
, 
IPPROTO_IP
, 
IP_HDRINCL
, (*)&
hdr
, (hdr)) == -1)

287 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot IP_HDRINCL");

288 
”r
;

290 
	`sockaddr_compo£
((
sockaddr
 *)&
sš4
, 
AF_INET
, 
addr
, 0);

291 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš4
, (sin4)) == -1)

293 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot bind %s",

294 
	`sockaddr_to¡r
((
sockaddr
 *)&
sš4
, 
tmp
, (tmp)));

295 
”r
;

298 if((
fd
 = 
	`sÿm³r_´iv£p_İ’_¿wudp
(
addr
)) == -1)

300 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

301 
”r
;

305  
fd
;

307 
”r
:

308 if(
fd
 !ğ-1è
	`sÿm³r_udp4_şo£
(fd);

310 
	}
}

	@scamper_udp4.h

25 #iâdeà
__SCAMPER_UDP4_H


26 
	#__SCAMPER_UDP4_H


	)

28 
sÿm³r_udp4_İ’¿w
(cÚ¡ *
addr
);

29 
sÿm³r_udp4_İ’dg¿m
(cÚ¡ *
addr
, 
¥Üt
);

30 
sÿm³r_udp4_şo£
(
fd
);

32 
sÿm³r_udp4_ş—nup
();

34 #ifdeà
__SCAMPER_PROBE_H


35 
sÿm³r_udp4_´obe
(
sÿm³r_´obe_t
 *
´obe
);

36 
sÿm³r_udp4_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

37 
ušt16_t
 
sÿm³r_udp4_cksum
(
sÿm³r_´obe_t
 *
´obe
);

	@scamper_udp6.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_dl.h
"

37 
	~"sÿm³r_´obe.h
"

38 
	~"sÿm³r_6.h
"

39 
	~"sÿm³r_udp6.h
"

41 
	~"sÿm³r_debug.h
"

42 
	~"uts.h
"

44 
ušt16_t
 
	$sÿm³r_udp6_cksum
(
sÿm³r_´obe_t
 *
´obe
)

46 
ušt16_t
 *
w
, 
tmp
;

47 
i
, 
sum
 = 0;

50 
w
 = (
ušt16_t
 *)
´obe
->
´__¤c
->
addr
;

51 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

52 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

53 
w
 = (
ušt16_t
 *)
´obe
->
´__d¡
->
addr
;

54 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

55 
sum
 +ğ*
w
++; sum += *w++; sum += *w++; sum += *w++;

56 
sum
 +ğ
	`htÚs
(
´obe
->
´_Ën
 + 8);

57 
sum
 +ğ
	`htÚs
(
IPPROTO_UDP
);

60 
sum
 +ğ
	`htÚs
(
´obe
->
´_udp_¥Üt
);

61 
sum
 +ğ
	`htÚs
(
´obe
->
´_udp_dpÜt
);

62 
sum
 +ğ
	`htÚs
(
´obe
->
´_Ën
 + 8);

65 
w
 = (
ušt16_t
 *)
´obe
->
´_d©a
;

66 
i
 = 
´obe
->
´_Ën
; i > 1; i -= 2)

68 
sum
 +ğ*
w
++;

70 if(
i
 != 0)

72 
sum
 +ğ((
ušt8_t
 *)
w
)[0];

76 
sum
 = (sum >> 16) + (sum & 0xffff);

77 
sum
 += (sum >> 16);

79 if((
tmp
 = ~
sum
) == 0)

81 
tmp
 = 0xffff;

84  
tmp
;

85 
	}
}

87 
	$sÿm³r_udp6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
)

89 
6_hdr
 *
6
;

90 
udphdr
 *
udp
;

91 
size_t
 
6hËn
, 
»q
;

94 
6hËn
 = *
Ën
;

95 
	`sÿm³r_6_bud
(
´obe
, 
buf
, &
6hËn
);

98 
»q
 = 
6hËn
 + 8 + 
´obe
->
´_Ën
;

100 if(
»q
 <ğ*
Ën
)

103 
6
 = (
6_hdr
 *)
buf
;

104 
6
->
6_¶’
 = 
	`htÚs
(
6hËn
 - 40 + 8 + 
´obe
->
´_Ën
);

106 
udp
 = (
udphdr
 *)(
buf
 + 
6hËn
);

107 
udp
->
uh_¥Üt
 = 
	`htÚs
(
´obe
->
´_udp_¥Üt
);

108 
udp
->
uh_dpÜt
 = 
	`htÚs
(
´obe
->
´_udp_dpÜt
);

109 
udp
->
uh_uËn
 = 
	`htÚs
((
udphdr
è+ 
´obe
->
´_Ën
);

110 
udp
->
uh_sum
 = 
	`sÿm³r_udp6_cksum
(
´obe
);

113 if(
´obe
->
´_Ën
 != 0)

115 
	`memıy
(
buf
 + 
6hËn
 + 8, 
´obe
->
´_d©a
,…robe->
´_Ën
);

118 *
Ën
 = 
»q
;

122 *
Ën
 = 
»q
;

124 
	}
}

137 
	$sÿm³r_udp6_´obe
(
sÿm³r_´obe_t
 *
´obe
)

139 
sockaddr_š6
 
sš6
;

140 
i
;

141 
addr
[128];

143 
	`as£¹
(
´obe
 !ğ
NULL
);

144 
	`as£¹
(
´obe
->
´__´Ùo
 =ğ
IPPROTO_UDP
);

145 
	`as£¹
(
´obe
->
´__d¡
 !ğ
NULL
);

146 
	`as£¹
(
´obe
->
´__¤c
 !ğ
NULL
);

147 
	`as£¹
(
´obe
->
´_Ën
 !ğ0 ||…robe->
´_d©a
 =ğ
NULL
);

149 
i
 = 
´obe
->
´__‰l
;

150 if(
	`£tsockİt
(
´obe
->
´_fd
,

151 
IPPROTO_IPV6
, 
IPV6_UNICAST_HOPS
, (*)&
i
, (i)) == -1)

153 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù s‘ hlimØ%d", 
i
);

157 
i
 = 
´obe
->
´_Ën
;

158 if(
	`£tsockİt
(
´obe
->
´_fd
,

159 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
i
, (i)) == -1)

161 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

162 "could‚Ù s‘ bufã¸tØ%d by‹s", 
i
);

166 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
,

167 
´obe
->
´__d¡
->
addr
,…robe->
´_udp_dpÜt
);

170 
	`g‘timeofday_w¿p
(&
´obe
->
´_tx
);

172 
i
 = 
	`£ndto
(
´obe
->
´_fd
,…robe->
´_d©a
,…robe->
´_Ën
, 0,

173 (
sockaddr
 *)&
sš6
, (
sockaddr_š6
));

176 if(
i
 =ğ
´obe
->
´_Ën
)

182 
´obe
->
´_”ºo
 = 
”ºo
;

185 if(
i
 == -1)

187 
	`´š‹¼Ü
(
´obe
->
´_”ºo
, 
¡»¼Ü
, 
__func__
,

189 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)),

190 
´obe
->
´__‰l
,…robe->
´_udp_dpÜt
,…robe->
´_Ën
);

195 
	`årštf
(
¡d”r
,

197 
i
, ()
´obe
->
´_Ën
,

198 
	`sÿm³r_addr_to¡r
(
´obe
->
´__d¡
, 
addr
, (addr)));

202 
	}
}

204 
	$sÿm³r_udp6_şo£
(
fd
)

206 #iâdeà
_WIN32


207 
	`şo£
(
fd
);

209 
	`şo£sock‘
(
fd
);

212 
	}
}

214 
	$sÿm³r_udp6_İ’
(cÚ¡ *
addr
, 
¥Üt
)

216 
sockaddr_š6
 
sš6
;

217 
buf
[128];

218 
fd
 = -1;

220 #ià
	`defšed
(
IPV6_DONTFRAG
)

221 
İt
;

224 if((
fd
 = 
	`sock‘
(
AF_INET6
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) == -1)

226 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot open socket");

227 
”r
;

230 
	`sockaddr_compo£
((
sockaddr
 *)&
sš6
, 
AF_INET6
, 
addr
, 
¥Üt
);

231 if(
	`bšd
(
fd
, (
sockaddr
 *)&
sš6
, (sin6)) == -1)

233 if(
addr
 =ğ
NULL
 || 
	`addr_to¡r
(
AF_INET6
,‡ddr, 
buf
, (buf)) == NULL)

234 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd…Üˆ%d", 
¥Üt
);

236 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚Ù bšd %s:%d", 
buf
, 
¥Üt
);

237 
”r
;

240 #ià
	`defšed
(
IPV6_DONTFRAG
)

241 
İt
 = 1;

242 if(
	`£tsockİt
(
fd
, 
IPPROTO_IPV6
, 
IPV6_DONTFRAG
,

243 (*)&
İt
, (opt)) == -1)

245 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot set IPV6_DONTFRAG");

246 
”r
;

250  
fd
;

252 
”r
:

253 if(
fd
 !ğ-1è
	`sÿm³r_udp6_şo£
(fd);

255 
	}
}

	@scamper_udp6.h

25 #iâdeà
__SCAMPER_UDP6_H


26 
	#__SCAMPER_UDP6_H


	)

28 
sÿm³r_udp6_İ’
(cÚ¡ *
addr
, 
¥Üt
);

29 
sÿm³r_udp6_şo£
(
fd
);

31 #ifdeà
__SCAMPER_PROBE_H


32 
sÿm³r_udp6_´obe
(
sÿm³r_´obe_t
 *
´obe
);

33 
sÿm³r_udp6_bud
(
sÿm³r_´obe_t
 *
´obe
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
);

34 
ušt16_t
 
sÿm³r_udp6_cksum
(
sÿm³r_´obe_t
 *
´obe
);

	@scamper_writebuf.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_fds.h
"

36 
	~"sÿm³r_wr™ebuf.h
"

37 
	~"mjl_li¡.h
"

38 
	~"uts.h
"

52 
	ssÿm³r_wr™ebuf


54 
¦i¡_t
 *
	miovs
;

55 
sÿm³r_fd_t
 *
	mfdn
;

56 
	m”rÜ
;

59 *
	m·¿m
;

60 (*
	mefunc
)(*, , 
	msÿm³r_wr™ebuf_t
 *);

61 (*
	mdfunc
)(*, 
	msÿm³r_wr™ebuf_t
 *);

64 *
	mı¬am
;

65 (*
	mcfunc
)(*);

68 #iâdeà
_WIN32


69 
	$wr™ebuf_tx
(
sÿm³r_wr™ebuf_t
 *
wb
, 
fd
)

71 
msghdr
 
msg
;

72 
iovec
 *
iov
;

73 
ušt8_t
 *
by‹s
;

74 
ssize_t
 
size
;

75 
¦i¡_node_t
 *
node
;

76 
i
, 
iovs
;

78 if((
iovs
 = 
	`¦i¡_couÁ
(
wb
->iovs)) <= 0)

88 if(
iovs
 =ğ1 || (
iov
 = 
	`m®loc
(iov * (
iovec
))è=ğ
NULL
)

90 
iov
 = 
	`¦i¡_h—d_g‘
(
wb
->
iovs
);

91 
iovs
 = 1;

95 
node
 = 
	`¦i¡_h—d_node
(
wb
->
iovs
);

96 
i
=0; i<
iovs
; i++)

98 
	`as£¹
(
node
 !ğ
NULL
);

99 
	`memıy
(&
iov
[
i
], 
	`¦i¡_node_™em
(
node
), (
iovec
));

100 
node
 = 
	`¦i¡_node_Ãxt
(node);

105 
	`mem£t
(&
msg
, 0, (msg));

106 
msg
.
msg_iov
 = 
iov
;

107 
msg
.
msg_iovËn
 = 
iovs
;

108 
size
 = 
	`£ndmsg
(
fd
, &
msg
, 0);

111 if(
iovs
 > 1)

113 
	`ä“
(
iov
);

116 if(
size
 == -1)

118 if(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
)

124 
size
 > 0)

126 
node
 = 
	`¦i¡_h—d_node
(
wb
->
iovs
);

127 
iov
 = 
	`¦i¡_node_™em
(
node
);

130 if(
iov
->
iov_Ën
 <ğ(
size_t
)
size
)

132 
size
 -ğ
iov
->
iov_Ën
;

133 
	`ä“
(
iov
->
iov_ba£
);

134 
	`ä“
(
iov
);

135 
	`¦i¡_h—d_pİ
(
wb
->
iovs
);

140 
by‹s
 = (
ušt8_t
 *)
iov
->
iov_ba£
;

141 
	`memmove
(
iov
->
iov_ba£
, 
by‹s
 + 
size
, iov->
iov_Ën
 - size);

142 
iov
->
iov_Ën
 -ğ
size
;

147 
	}
}

150 #ifdeà
_WIN32


151 
	$wr™ebuf_tx
(
sÿm³r_wr™ebuf_t
 *
wb
, 
fd
)

153 
iovec
 *
iov
;

154 
size
;

156 if(
	`¦i¡_couÁ
(
wb
->
iovs
) == 0)

159 
iov
 = 
	`¦i¡_h—d_g‘
(
wb
->
iovs
);

160 if((
size
 = 
	`£nd
(
fd
, 
iov
->
iov_ba£
, iov->
iov_Ën
, 0)) == -1)

163 if((
size_t
)
size
 =ğ
iov
->
iov_Ën
)

165 
	`¦i¡_h—d_pİ
(
wb
->
iovs
);

166 
	`ä“
(
iov
->
iov_ba£
);

167 
	`ä“
(
iov
);

171 
iov
->
iov_Ën
 -ğ
size
;

172 
	`memmove
(
iov
->
iov_ba£
, (
ušt8_t
 *)iov->iov_ba£ + 
size
, iov->
iov_Ën
);

176 
	}
}

185 
	$wr™ebuf_ÿÎback
(
fd
, *
·¿m
)

187 
sÿm³r_wr™ebuf_t
 *
wb
 = (sÿm³r_wr™ebuf_ˆ*)
·¿m
;

189 
	`as£¹
(
wb
->
fdn
 !ğ
NULL
);

190 
	`as£¹
(
	`sÿm³r_fd_fd_g‘
(
wb
->
fdn
è=ğ
fd
);

197 if(
	`¦i¡_couÁ
(
wb
->
iovs
è=ğ0 && wb->
cfunc
 !ğ
NULL
)

199 
wb
->
	`cfunc
(wb->
ı¬am
);

202 if(
	`¦i¡_couÁ
(
wb
->
iovs
) > 0)

204 if(
	`wr™ebuf_tx
(
wb
, 
fd
) != 0)

206 
wb
->
”rÜ
 = 
”ºo
;

207 if(
wb
->
efunc
 !ğ
NULL
)

208 
wb
->
	`efunc
(wb->
·¿m
, 
”ºo
, wb);

214 if(
wb
->
cfunc
 !ğ
NULL
)

216 
wb
->
cfunc
 = 
NULL
;

217 
wb
->
ı¬am
 = 
NULL
;

222 if(
	`¦i¡_couÁ
(
wb
->
iovs
è=ğ0 && wb->
cfunc
 =ğ
NULL
)

224 
	`sÿm³r_fd_wr™e_·u£
(
wb
->
fdn
);

225 if(
wb
->
dfunc
 !ğ
NULL
)

226 
wb
->
	`dfunc
(wb->
·¿m
, wb);

231 
	}
}

233 
size_t
 
	$sÿm³r_wr™ebuf_Ën
(cÚ¡ 
sÿm³r_wr™ebuf_t
 *
wb
)

235 
¦i¡_node_t
 *
node
 = 
	`¦i¡_h—d_node
(
wb
->
iovs
);

236 
iovec
 *
iov
;

237 
size_t
 
Ën
 = 0;

239 
node
 !ğ
NULL
)

241 
iov
 = 
	`¦i¡_node_™em
(
node
);

242 
Ën
 +ğ
iov
->
iov_Ën
;

243 
node
 = 
	`¦i¡_node_Ãxt
(node);

246  
Ën
;

247 
	}
}

249 
size_t
 
	$sÿm³r_wr™ebuf_Ën2
(cÚ¡ 
sÿm³r_wr™ebuf_t
 *
wb
,*
¡r
,
size_t
 
Ën
)

251 
¦i¡_node_t
 *
node
;

252 
iovec
 *
iov
;

253 
size_t
 
k
 = 0, 
off
 = 0;

254 
c
 = 0;

256 
node
=
	`¦i¡_h—d_node
(
wb
->
iovs
);‚od!ğ
NULL
;‚ode=
	`¦i¡_node_Ãxt
(node))

258 
iov
 = 
	`¦i¡_node_™em
(
node
);

259 
k
 +ğ
iov
->
iov_Ën
;

260 
c
++;

263 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "%d,%d%s", 
k
, 
c
, (k != 0) ? ":" : "");

264 
node
=
	`¦i¡_h—d_node
(
wb
->
iovs
);‚od!ğ
NULL
;‚ode=
	`¦i¡_node_Ãxt
(node))

266 
iov
 = 
	`¦i¡_node_™em
(
node
);

267 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, " %d", 
iov
->
iov_Ën
);

270  
k
;

271 
	}
}

279 
	$sÿm³r_wr™ebuf_æush
(
sÿm³r_wr™ebuf_t
 *
wb
)

281 
	`as£¹
(
wb
->
fdn
 !ğ
NULL
);

282 
	`wr™ebuf_ÿÎback
(
	`sÿm³r_fd_fd_g‘
(
wb
->
fdn
), wb);

284 
	}
}

286 
	$sÿm³r_wr™ebuf_d‘ach
(
sÿm³r_wr™ebuf_t
 *
wb
)

288 
	`as£¹
(
wb
->
fdn
 !ğ
NULL
);

289 
	`sÿm³r_fd_wr™e_·u£
(
wb
->
fdn
);

290 
wb
->
fdn
 = 
NULL
;

291 
wb
->
efunc
 = 
NULL
;

292 
wb
->
·¿m
 = 
NULL
;

294 
	}
}

302 
	$sÿm³r_wr™ebuf_£nd
(
sÿm³r_wr™ebuf_t
 *
wb
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

304 
iovec
 *
iov
 = 
NULL
;

307 if(
Ën
 < 1)

314 if(
wb
->
”rÜ
 != 0)

318 if((
iov
 = 
	`m®loc_z”o
((
iovec
))è=ğ
NULL
 ||

319 (
iov
->
iov_ba£
 = 
	`memdup
(
d©a
, 
Ën
)è=ğ
NULL
)

321 
”r
;

323 
iov
->
iov_Ën
 = 
Ën
;

326 if(
	`¦i¡__push
(
wb
->
iovs
, 
iov
è=ğ
NULL
)

327 
”r
;

329 if(
wb
->
fdn
 !ğ
NULL
)

330 
	`sÿm³r_fd_wr™e_uÅau£
(
wb
->
fdn
);

334 
”r
:

335 if(
iov
 =ğ
NULL
)

337 if(
iov
->
iov_ba£
 !ğ
NULL
è
	`ä“
(iov->iov_base);

338 
	`ä“
(
iov
);

340 
	}
}

342 
sÿm³r_wr™ebuf_cÚsume
(
sÿm³r_wr™ebuf_t
 *
wb
, *
ı¬am
,

343 
	$cfunc
(*
·¿m
))

345 
wb
->
ı¬am
 = cparam;

346 
wb
->
cfunc
 = cfunc;

349 if(
	`¦i¡_couÁ
(
wb
->
iovs
) > 0)

353 
	`cfunc
(
ı¬am
);

354 if(
	`¦i¡_couÁ
(
wb
->
iovs
) == 0)

356 
wb
->
ı¬am
 = 
NULL
;

357 
wb
->
cfunc
 = 
NULL
;

361 
	}
}

367 
	$sÿm³r_wr™ebuf_ä“
(
sÿm³r_wr™ebuf_t
 *
wb
)

369 
iovec
 *
iov
;

371 if(
wb
 =ğ
NULL
)

374 if(
wb
->
fdn
 !ğ
NULL
)

375 
	`sÿm³r_fd_wr™e_·u£
(
wb
->
fdn
);

377 if(
wb
->
iovs
 !ğ
NULL
)

379 (
iov
 = 
	`¦i¡_h—d_pİ
(
wb
->
iovs
)è!ğ
NULL
)

381 
	`ä“
(
iov
->
iov_ba£
);

382 
	`ä“
(
iov
);

384 
	`¦i¡_ä“
(
wb
->
iovs
);

387 
	`ä“
(
wb
);

389 
	}
}

391 
	$sÿm³r_wr™ebuf_©ch
(
sÿm³r_wr™ebuf_t
 *
wb
,

392 
sÿm³r_fd_t
 *
fdn
, *
·¿m
,

393 (*
efunc
)(*, , 
sÿm³r_wr™ebuf_t
 *),

394 (*
dfunc
)(*, 
sÿm³r_wr™ebuf_t
 *))

396 
wb
->
fdn
 = fdn;

397 
wb
->
·¿m
 =…aram;

398 
wb
->
efunc
 =ƒfunc;

399 
wb
->
dfunc
 = dfunc;

400 
	`sÿm³r_fd_wr™e_£t
(
fdn
, 
wr™ebuf_ÿÎback
, 
wb
);

402 
	}
}

408 
sÿm³r_wr™ebuf_t
 *
	$sÿm³r_wr™ebuf_®loc
()

410 
sÿm³r_wr™ebuf_t
 *
wb
 = 
NULL
;

412 if((
wb
 = 
	`m®loc_z”o
((
sÿm³r_wr™ebuf_t
))è=ğ
NULL
)

414 
”r
;

417 if((
wb
->
iovs
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

419 
”r
;

422  
wb
;

424 
”r
:

425 
	`sÿm³r_wr™ebuf_ä“
(
wb
);

426  
NULL
;

427 
	}
}

	@scamper_writebuf.h

25 #iâdeà
__SCAMPER_WRITEBUF_H


26 
	#__SCAMPER_WRITEBUF_H


	)

28 
sÿm³r_wr™ebuf
 
	tsÿm³r_wr™ebuf_t
;

30 
sÿm³r_wr™ebuf_t
 *
sÿm³r_wr™ebuf_®loc
();

31 
sÿm³r_wr™ebuf_ä“
(
sÿm³r_wr™ebuf_t
 *
wb
);

34 
sÿm³r_wr™ebuf_£nd
(
sÿm³r_wr™ebuf_t
 *
wb
, cÚ¡ *
d©a
,
size_t
 
Ën
);

37 
sÿm³r_wr™ebuf_cÚsume
(
sÿm³r_wr™ebuf_t
 *
wb
, *
·¿m
,

38 
cfunc
(*
·¿m
));

41 
size_t
 
sÿm³r_wr™ebuf_Ën
(cÚ¡ 
sÿm³r_wr™ebuf_t
 *
wb
);

42 
size_t
 
sÿm³r_wr™ebuf_Ën2
(cÚ¡ 
sÿm³r_wr™ebuf_t
 *, *, size_t);

57 
sÿm³r_wr™ebuf_©ch
(
sÿm³r_wr™ebuf_t
 *
wb
,

58 
sÿm³r_fd_t
 *
fdn
, *
·¿m
,

59 (*
efunc
)(*, , 
sÿm³r_wr™ebuf_t
 *),

60 (*
dfunc
)(*, 
sÿm³r_wr™ebuf_t
 *));

61 
	`sÿm³r_wr™ebuf_d‘ach
(
sÿm³r_wr™ebuf_t
 *
wb
);

62 
	`sÿm³r_wr™ebuf_æush
(
sÿm³r_wr™ebuf_t
 *
wb
);

	@sniff/scamper_sniff.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_li¡.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_¢iff.h
"

38 
	~"uts.h
"

40 
sÿm³r_¢iff_pkt_t
 *
	$sÿm³r_¢iff_pkt_®loc
(
ušt8_t
 *
d©a
, 
ušt16_t
 
Ën
,

41 
timev®
 *
tv
)

43 
sÿm³r_¢iff_pkt_t
 *
pkt
;

45 if((
pkt
 = 
	`m®loc_z”o
((
sÿm³r_¢iff_pkt_t
))è=ğ
NULL
)

46 
”r
;

48 if(
Ën
 !ğ0 && 
d©a
 !ğ
NULL
)

50 if((
pkt
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

51 
”r
;

52 
pkt
->
Ën
 =†en;

54 if(
tv
 !ğ
NULL
è
	`timev®_ıy
(&
pkt
->tv,v);

55  
pkt
;

57 
”r
:

58 
	`ä“
(
pkt
);

59  
NULL
;

60 
	}
}

62 
	$sÿm³r_¢iff_pkt_ä“
(
sÿm³r_¢iff_pkt_t
 *
pkt
)

64 if(
pkt
 =ğ
NULL
)

66 if(
pkt
->
d©a
 !ğ
NULL
)

67 
	`ä“
(
pkt
->
d©a
);

68 
	`ä“
(
pkt
);

70 
	}
}

72 
sÿm³r_¢iff_t
 *
	$sÿm³r_¢iff_®loc
()

74  
	`m®loc_z”o
((
sÿm³r_¢iff_t
));

75 
	}
}

77 
	$sÿm³r_¢iff_ä“
(
sÿm³r_¢iff_t
 *
¢iff
)

79 
i
;

81 if(
¢iff
 =ğ
NULL
)

84 if(
¢iff
->
li¡
 !ğ
NULL
)

85 
	`sÿm³r_li¡_ä“
(
¢iff
->
li¡
);

86 if(
¢iff
->
cyşe
 !ğ
NULL
)

87 
	`sÿm³r_cyşe_ä“
(
¢iff
->
cyşe
);

88 if(
¢iff
->
¤c
 !ğ
NULL
)

89 
	`sÿm³r_addr_ä“
(
¢iff
->
¤c
);

91 if(
¢iff
->
pkts
 !ğ
NULL
)

93 
i
=0; i<
¢iff
->
pktc
; i++)

94 if(
¢iff
->
pkts
[
i
] !ğ
NULL
)

95 
	`sÿm³r_¢iff_pkt_ä“
(
¢iff
->
pkts
[
i
]);

96 
	`ä“
(
¢iff
->
pkts
);

99 
	`ä“
(
¢iff
);

102 
	}
}

104 
	$sÿm³r_¢iff_pkts_®loc
(
sÿm³r_¢iff_t
 *
¢iff
, 
pktc
)

106 
size_t
 
size
 = 
pktc
 * (
sÿm³r_¢iff_pkt_t
 *);

107 if((
¢iff
->
pkts
 = (
sÿm³r_¢iff_pkt_t
 **)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

109 
¢iff
->
pktc
 =…ktc;

111 
	}
}

	@sniff/scamper_sniff.h

24 #iâdeà
__SCAMPER_SNIFF_H


25 
	#__SCAMPER_SNIFF_H


	)

27 
	#SCAMPER_SNIFF_STOP_NONE
 0x00

	)

28 
	#SCAMPER_SNIFF_STOP_ERROR
 0x01

	)

29 
	#SCAMPER_SNIFF_STOP_LIMIT_TIME
 0x02

	)

30 
	#SCAMPER_SNIFF_STOP_LIMIT_PKTC
 0x03

	)

31 
	#SCAMPER_SNIFF_STOP_HALTED
 0x04

	)

33 
	ssÿm³r_¢iff_pkt


35 
timev®
 
	mtv
;

36 
ušt8_t
 *
	md©a
;

37 
ušt16_t
 
	mËn
;

38 } 
	tsÿm³r_¢iff_pkt_t
;

40 
	ssÿm³r_¢iff


42 
sÿm³r_li¡_t
 *
	mli¡
;

43 
sÿm³r_cyşe_t
 *
	mcyşe
;

44 
ušt32_t
 
	mu£rid
;

46 
timev®
 
	m¡¬t
;

47 
timev®
 
	mfšish
;

48 
ušt8_t
 
	m¡İ_»asÚ
;

49 
ušt32_t
 
	mlim™_pktc
;

50 
ušt16_t
 
	mlim™_time
;

52 
sÿm³r_addr_t
 *
	m¤c
;

53 
ušt16_t
 
	micmpid
;

55 
sÿm³r_¢iff_pkt_t
 **
	mpkts
;

56 
ušt32_t
 
	mpktc
;

58 } 
	tsÿm³r_¢iff_t
;

60 
sÿm³r_¢iff_t
 *
sÿm³r_¢iff_®loc
();

61 
sÿm³r_¢iff_ä“
(
sÿm³r_¢iff_t
 *);

63 
sÿm³r_¢iff_pkt_t
 *
sÿm³r_¢iff_pkt_®loc
(
ušt8_t
 *
d©a
, 
ušt16_t
 
Ën
,

64 
timev®
 *
tv
);

65 
sÿm³r_¢iff_pkt_ä“
(
sÿm³r_¢iff_pkt_t
 *
pkt
);

67 
sÿm³r_¢iff_pkts_®loc
(
sÿm³r_¢iff_t
 *
¢iff
, 
pktc
);

	@sniff/scamper_sniff_do.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_¢iff.h
"

38 
	~"sÿm³r_fds.h
"

39 
	~"sÿm³r_dl.h
"

40 
	~"sÿm³r_sk.h
"

41 
	~"sÿm³r_İtiÚs.h
"

42 
	~"sÿm³r_if.h
"

43 
	~"sÿm³r_queue.h
"

44 
	~"sÿm³r_fe.h
"

45 
	~"sÿm³r_debug.h
"

46 
	~"sÿm³r_¢iff_do.h
"

47 
	~"mjl_li¡.h
"

48 
	~"uts.h
"

50 
	s¢iff_¡©e


52 
sÿm³r_fd_t
 *
	mfd
;

53 
¦i¡_t
 *
	mli¡
;

54 } 
	t¢iff_¡©e_t
;

57 
sÿm³r_sk_funcs_t
 
	g¢iff_funcs
;

60 
sÿm³r_addrÿche_t
 *
addrÿche
;

62 
	#SNIFF_OPT_LIMIT_PKTC
 1

	)

63 
	#SNIFF_OPT_LIMIT_TIME
 2

	)

64 
	#SNIFF_OPT_SRCADDR
 3

	)

65 
	#SNIFF_OPT_USERID
 4

	)

67 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

68 {'c', 
NULL
, 
SNIFF_OPT_LIMIT_PKTC
, 
SCAMPER_OPTION_TYPE_NUM
},

69 {'G', 
NULL
, 
SNIFF_OPT_LIMIT_TIME
, 
SCAMPER_OPTION_TYPE_NUM
},

70 {'S', 
NULL
, 
SNIFF_OPT_SRCADDR
, 
SCAMPER_OPTION_TYPE_STR
},

71 {'U', 
NULL
, 
SNIFF_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

74 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

76 cÚ¡ *
	$sÿm³r_do_¢iff_u§ge
()

79 
	}
}

81 
sÿm³r_¢iff_t
 *
	$¢iff_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

83  
	`sÿm³r_sk_g‘d©a
(
sk
);

84 
	}
}

86 
¢iff_¡©e_t
 *
	$¢iff_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

88  
	`sÿm³r_sk_g‘¡©e
(
sk
);

89 
	}
}

91 
	$¢iff_fšish
(
sÿm³r_sk_t
 *
sk
, 
»asÚ
)

93 
sÿm³r_¢iff_t
 *
¢iff
 = 
	`¢iff_g‘d©a
(
sk
);

94 
¢iff_¡©e_t
 *
¡©e
 = 
	`¢iff_g‘¡©e
(
sk
);

95 
sÿm³r_¢iff_pkt_t
 *
pkt
;

96 
i
, 
rc
;

98 
	`g‘timeofday_w¿p
(&
¢iff
->
fšish
);

100 if(
¡©e
 !ğ
NULL
 && s‹->
li¡
 !ğNULL && (
rc
=
	`¦i¡_couÁ
(state->list)) > 0)

102 if(
	`sÿm³r_¢iff_pkts_®loc
(
¢iff
, 
rc
) != 0)

104 
¢iff
->
¡İ_»asÚ
 = 
SCAMPER_SNIFF_STOP_ERROR
;

105 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

109 
i
 = 0;

110 (
pkt
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
li¡
)è!ğ
NULL
)

111 
¢iff
->
pkts
[
i
++] = 
pkt
;

112 
	`as£¹
(
i
 =ğ
rc
);

115 
¢iff
->
¡İ_»asÚ
 = 
»asÚ
;

116 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

118 
	}
}

120 
	$do_¢iff_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

122 
sÿm³r_¢iff_t
 *
¢iff
 = 
	`¢iff_g‘d©a
(
sk
);

123 
¢iff_¡©e_t
 *
¡©e
 = 
	`¢iff_g‘¡©e
(
sk
);

124 
sÿm³r_¢iff_pkt_t
 *
pkt
;

125 
ÿp
 = 0;

127 if(
	`SCAMPER_DL_IS_ICMP
(
dl
))

129 if((
	`SCAMPER_DL_IS_ICMP_ECHO
(
dl
) &&

130 
dl
->
dl_icmp_id
 =ğ
¢iff
->
icmpid
 &&

131 
	`sÿm³r_addr_¿w_cmp
(
¢iff
->
¤c
, 
dl
->
dl__d¡
) == 0) ||

132 (
	`SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO
(
dl
) &&

133 
dl
->
dl_icmp_icmp_id
 =ğ
¢iff
->
icmpid
 &&

134 
	`sÿm³r_addr_¿w_cmp
(
¢iff
->
¤c
, 
dl
->
dl_icmp__¤c
) == 0))

135 
ÿp
 = 1;

138 if(
ÿp
 == 0)

141 
pkt
 = 
	`sÿm³r_¢iff_pkt_®loc
(
dl
->
dl_Ãt_¿w
, dl->
dl__size
, &dl->
dl_tv
);

142 if(
pkt
 =ğ
NULL
)

144 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…kt");

145 
”r
;

148 if(
	`¦i¡__push
(
¡©e
->
li¡
, 
pkt
è=ğ
NULL
)

150 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot…ush…kt");

151 
”r
;

154 if(
	`¦i¡_couÁ
(
¡©e
->
li¡
è>ğ
¢iff
->
lim™_pktc
)

155 
	`¢iff_fšish
(
sk
, 
SCAMPER_SNIFF_STOP_LIMIT_PKTC
);

159 
”r
:

160 
	`¢iff_fšish
(
sk
, 
SCAMPER_SNIFF_STOP_ERROR
);

162 
	}
}

164 
	$do_¢iff_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

166 
	`¢iff_fšish
(
sk
, 
SCAMPER_SNIFF_STOP_LIMIT_TIME
);

168 
	}
}

170 
	$¢iff_¡©e_ä“
(
¢iff_¡©e_t
 *
¡©e
)

172 if(
¡©e
 =ğ
NULL
)

175 if(
¡©e
->
fd
 !ğ
NULL
)

176 
	`sÿm³r_fd_ä“
(
¡©e
->
fd
);

177 if(
¡©e
->
li¡
 !ğ
NULL
)

178 
	`¦i¡_ä“
(
¡©e
->
li¡
);

180 
	`ä“
(
¡©e
);

182 
	}
}

184 
	$¢iff_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

186 
sÿm³r_¢iff_t
 *
¢iff
 = 
	`¢iff_g‘d©a
(
sk
);

187 
¢iff_¡©e_t
 *
¡©e
 = 
NULL
;

188 
sockaddr_¡Üage
 
§s
;

189 
ifšdex
;

191 
	`as£¹
(
¢iff
->
¤c
 !ğ
NULL
);

193 if(
¢iff
->
¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

194 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET
, 
¢iff
->
¤c
->
addr
, 0);

195 if(
¢iff
->
¤c
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

196 
	`sockaddr_compo£
((
sockaddr
 *)&
§s
, 
AF_INET6
, 
¢iff
->
¤c
->
addr
, 0);

198 
”r
;

200 if(
	`sÿm³r_if_g‘ifšdex_byaddr
((
sockaddr
 *)&
§s
, &
ifšdex
) != 0)

201 
”r
;

203 if((
¡©e
 = 
	`m®loc_z”o
((
¢iff_¡©e_t
))è=ğ
NULL
)

204 
”r
;

206 if((
¡©e
->
li¡
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

208 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc†ist");

209 
”r
;

212 if((
¡©e
->
fd
 = 
	`sÿm³r_fd_dl
(
ifšdex
)è=ğ
NULL
)

214 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get dl");

215 
”r
;

218 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

221 
”r
:

222 if(
¡©e
 !ğ
NULL
è
	`¢iff_¡©e_ä“
(state);

224 
	}
}

226 
	$do_¢iff_´obe
(
sÿm³r_sk_t
 *
sk
)

228 
sÿm³r_¢iff_t
 *
¢iff
 = 
	`¢iff_g‘d©a
(
sk
);

229 
timev®
 
tv
;

231 
	`as£¹
(
	`¢iff_g‘¡©e
(
sk
è=ğ
NULL
);

233 
	`g‘timeofday_w¿p
(&
¢iff
->
¡¬t
);

234 if(
	`¢iff_¡©e_®loc
(
sk
) != 0)

236 
	`¢iff_fšish
(
sk
, 
SCAMPER_SNIFF_STOP_ERROR
);

240 
	`timev®_add_s
(&
tv
, &
¢iff
->
¡¬t
, sniff->
lim™_time
);

241 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
tv
);

243 
	}
}

245 
	$do_¢iff_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

247 
	`sÿm³r_fe_wr™e_¢iff
(
sf
, 
	`¢iff_g‘d©a
(
sk
));

249 
	}
}

251 
	$¢iff_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

253 
tmp
 = 0;

255 
İtid
)

257 
SNIFF_OPT_SRCADDR
:

260 
SNIFF_OPT_LIMIT_PKTC
:

261 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 1 ||mp > 5000)

262 
”r
;

265 
SNIFF_OPT_LIMIT_TIME
:

266 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0 ||mp > 1200)

267 
”r
;

270 
SNIFF_OPT_USERID
:

271 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

272 
”r
;

279 if(
out
 !ğ
NULL
)

280 *
out
 = 
tmp
;

283 
”r
:

285 
	}
}

287 
	$sÿm³r_do_¢iff_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

289  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

290 
¢iff_¬g_·¿m_v®id©e
);

291 
	}
}

293 *
	$sÿm³r_do_¢iff_®loc
(*
¡r
)

295 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

296 
sÿm³r_¢iff_t
 *
¢iff
 = 
NULL
;

297 
ušt32_t
 
u£rid
 = 0;

298 
ušt32_t
 
lim™_pktc
 = 100;

299 
ušt16_t
 
lim™_time
 = 60;

300 
icmpid
 = -1;

301 *
ex´
 = 
NULL
;

302 *
¤c
 = 
NULL
;

303 
tmp
 = 0;

306 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
ex´
) != 0)

307 
”r
;

309 if(
ex´
 =ğ
NULL
)

310 
”r
;

312 if(
	`¡ºÿ£cmp
(
ex´
, "icmp[icmpid] == ", 16) != 0 ||

313 
	`¡ršg_i¢umb”
(
ex´
+16) == 0 ||

314 
	`¡ršg_tŞÚg
(
ex´
+16, &
icmpid
) != 0 ||

315 
icmpid
 < 0 || icmpid > 65535)

317 
	`sÿm³r_debug
(
__func__
, "icmp[icmpid]‚ot supplied");

318 
”r
;

322 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

324 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

325 
	`¢iff_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

327 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

328 
”r
;

331 
İt
->
id
)

333 
SNIFF_OPT_SRCADDR
:

334 
¤c
 = 
İt
->
¡r
;

337 
SNIFF_OPT_USERID
:

338 
u£rid
 = (
ušt32_t
)
tmp
;

341 
SNIFF_OPT_LIMIT_TIME
:

342 
lim™_time
 = (
ušt16_t
)
tmp
;

345 
SNIFF_OPT_LIMIT_PKTC
:

346 
lim™_pktc
 = (
ušt32_t
)
tmp
;

350 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

352 if(
¤c
 =ğ
NULL
)

354 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "missing -S…arameter");

355 
”r
;

358 if((
¢iff
 = 
	`sÿm³r_¢iff_®loc
()è=ğ
NULL
)

359 
”r
;

361 if((
¢iff
->
¤c
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,¤c)è=ğ
NULL
)

363 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù„esŞv%s", 
¤c
);

364 
”r
;

367 
¢iff
->
lim™_pktc
 =†imit_pktc;

368 
¢iff
->
lim™_time
 =†imit_time;

369 
¢iff
->
u£rid
 = userid;

370 
¢iff
->
icmpid
 = icmpid;

372  
¢iff
;

374 
”r
:

375 if(
¢iff
 !ğ
NULL
è
	`sÿm³r_¢iff_ä“
(sniff);

376 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

377  
NULL
;

378 
	}
}

380 
	$do_¢iff_h®t
(
sÿm³r_sk_t
 *
sk
)

382 
	`¢iff_fšish
(
sk
, 
SCAMPER_SNIFF_STOP_HALTED
);

384 
	}
}

386 
	$do_¢iff_ä“
(
sÿm³r_sk_t
 *
sk
)

388 
sÿm³r_¢iff_t
 *
¢iff
;

389 
¢iff_¡©e_t
 *
¡©e
;

391 if((
¢iff
 = 
	`¢iff_g‘d©a
(
sk
)è!ğ
NULL
)

392 
	`sÿm³r_¢iff_ä“
(
¢iff
);

394 if((
¡©e
 = 
	`¢iff_g‘¡©e
(
sk
)è!ğ
NULL
)

395 
	`¢iff_¡©e_ä“
(
¡©e
);

398 
	}
}

400 
sÿm³r_sk_t
 *
	$sÿm³r_do_¢iff_®loùask
(*
d©a
, 
sÿm³r_li¡_t
 *
li¡
,

401 
sÿm³r_cyşe_t
 *
cyşe
)

403 
sÿm³r_¢iff_t
 *
¢iff
 = (sÿm³r_¢iff_ˆ*)
d©a
;

404 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

405 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

408 if((
sk
 = 
	`sÿm³r_sk_®loc
(
¢iff
, &
¢iff_funcs
)è=ğ
NULL
)

409 
”r
;

412 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_SNIFF
)è=ğ
NULL
)

413 
”r
;

414 
sig
->
sig_¢iff_¤c
 = 
	`sÿm³r_addr_u£
(
¢iff
->
¤c
);

415 
sig
->
sig_¢iff_icmp_id
 = 
¢iff
->
icmpid
;

416 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

417 
”r
;

418 
sig
 = 
NULL
;

421 
¢iff
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

422 
¢iff
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

424  
sk
;

426 
”r
:

427 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

428 if(
sk
 !ğ
NULL
)

430 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

431 
	`sÿm³r_sk_ä“
(
sk
);

433  
NULL
;

434 
	}
}

436 
	$sÿm³r_do_¢iff_ä“
(*
d©a
)

438 
	`sÿm³r_¢iff_ä“
((
sÿm³r_¢iff_t
 *)
d©a
);

440 
	}
}

442 
	$sÿm³r_do_¢iff_ş—nup
()

445 
	}
}

447 
	$sÿm³r_do_¢iff_š™
()

449 
¢iff_funcs
.
´obe
 = 
do_¢iff_´obe
;

450 
¢iff_funcs
.
hªdË_timeout
 = 
do_¢iff_hªdË_timeout
;

451 
¢iff_funcs
.
hªdË_dl
 = 
do_¢iff_hªdË_dl
;

452 
¢iff_funcs
.
wr™e
 = 
do_¢iff_wr™e
;

453 
¢iff_funcs
.
sk_ä“
 = 
do_¢iff_ä“
;

454 
¢iff_funcs
.
h®t
 = 
do_¢iff_h®t
;

457 
	}
}

	@sniff/scamper_sniff_do.h

24 #iâdeà
__SCAMPER_DO_SNIFF_H


25 
	#__SCAMPER_DO_SNIFF_H


	)

27 cÚ¡ *
sÿm³r_do_¢iff_u§ge
();

29 *
sÿm³r_do_¢iff_®loc
(*
¡r
);

31 
sÿm³r_do_¢iff_ä“
(*
d©a
);

33 
sÿm³r_sk_t
 *
sÿm³r_do_¢iff_®loùask
(*
d©a
,

34 
sÿm³r_li¡_t
 *
li¡
,

35 
sÿm³r_cyşe_t
 *
cyşe
);

37 
sÿm³r_do_¢iff_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

39 
sÿm³r_do_¢iff_ş—nup
();

40 
sÿm³r_do_¢iff_š™
();

	@sniff/scamper_sniff_warts.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_¢iff.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_fe_w¬ts.h
"

39 
	~"sÿm³r_¢iff_w¬ts.h
"

40 
	~"uts.h
"

42 
	#WARTS_SNIFF_LIST
 1

	)

43 
	#WARTS_SNIFF_CYCLE
 2

	)

44 
	#WARTS_SNIFF_USERID
 3

	)

45 
	#WARTS_SNIFF_SRC
 4

	)

46 
	#WARTS_SNIFF_START
 5

	)

47 
	#WARTS_SNIFF_FINISH
 6

	)

48 
	#WARTS_SNIFF_STOP_REASON
 7

	)

49 
	#WARTS_SNIFF_LIMIT_PKTC
 8

	)

50 
	#WARTS_SNIFF_LIMIT_TIME
 9

	)

51 
	#WARTS_SNIFF_PKTC
 10

	)

52 
	#WARTS_SNIFF_ICMPID
 11

	)

54 cÚ¡ 
w¬ts_v¬_t
 
	g¢iff_v¬s
[] =

56 {
WARTS_SNIFF_LIST
, 4, -1},

57 {
WARTS_SNIFF_CYCLE
, 4, -1},

58 {
WARTS_SNIFF_USERID
, 4, -1},

59 {
WARTS_SNIFF_SRC
, -1, -1},

60 {
WARTS_SNIFF_START
, 8, -1},

61 {
WARTS_SNIFF_FINISH
, 8, -1},

62 {
WARTS_SNIFF_STOP_REASON
, 1, -1},

63 {
WARTS_SNIFF_LIMIT_PKTC
, 4, -1},

64 {
WARTS_SNIFF_LIMIT_TIME
, 2, -1},

65 {
WARTS_SNIFF_PKTC
, 4, -1},

66 {
WARTS_SNIFF_ICMPID
, 2, -1},

68 
	#¢iff_v¬s_mfb
 
	`WARTS_VAR_MFB
(
¢iff_v¬s
)

	)

70 
	#WARTS_SNIFF_PKT_TIME
 1

	)

71 
	#WARTS_SNIFF_PKT_DATALEN
 2

	)

72 
	#WARTS_SNIFF_PKT_DATA
 3

	)

74 cÚ¡ 
w¬ts_v¬_t
 
	g¢iff_pkt_v¬s
[] =

76 {
WARTS_SNIFF_PKT_TIME
, 8, -1},

77 {
WARTS_SNIFF_PKT_DATALEN
, 2, -1},

78 {
WARTS_SNIFF_PKT_DATA
, -1, -1},

80 
	#¢iff_pkt_v¬s_mfb
 
	`WARTS_VAR_MFB
(
¢iff_pkt_v¬s
)

	)

82 
	sw¬ts_¢iff_pkt


84 
ušt8_t
 
	mæags
[
¢iff_pkt_v¬s_mfb
];

85 
ušt16_t
 
	mæags_Ën
;

86 
ušt16_t
 
	m·¿ms_Ën
;

87 } 
	tw¬ts_¢iff_pkt_t
;

89 
	$w¬ts_¢iff_pkt_·¿ms
(cÚ¡ 
sÿm³r_¢iff_pkt_t
 *
pkt
,

90 
w¬ts_¢iff_pkt_t
 *
¡©e
, 
ušt32_t
 *
Ën
)

92 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

93 
max_id
 = 0;

94 
ušt16_t
 
i
;

96 
	`mem£t
(
¡©e
->
æags
, 0, 
¢iff_pkt_v¬s_mfb
);

97 
¡©e
->
·¿ms_Ën
 = 0;

99 
i
=0; i<(
¢iff_pkt_v¬s
è/ (
w¬ts_v¬_t
); i++)

101 
v¬
 = &
¢iff_pkt_v¬s
[
i
];

103 if(
v¬
->
id
 =ğ
WARTS_SNIFF_PKT_DATA
)

105 if(
pkt
->
Ën
 == 0)

108 
¡©e
->
·¿ms_Ën
 +ğ
pkt
->
Ën
;

109 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

113 
	`as£¹
(
v¬
->
size
 >= 0);

114 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

115 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

118 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

120 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

122 if(
¡©e
->
·¿ms_Ën
 != 0)

123 *
Ën
 += 2;

126 
	}
}

128 
sÿm³r_¢iff_pkt_t
 *
	$w¬ts_¢iff_pkt_»ad
(
w¬ts_¡©e_t
 *
¡©e
,

129 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

130 
ušt32_t
 
Ën
)

132 
sÿm³r_¢iff_pkt_t
 *
pkt
 = 
NULL
;

133 
ušt8_t
 *
d©a
 = 
NULL
;

134 
timev®
 
tv
;

135 
ušt16_t
 
¶’
;

136 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

137 {&
tv
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

138 {&
¶’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

139 {&
d©a
, (
w´_t
)
exŒaù_by‹s_±r
, &
¶’
},

141 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

143 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0 ||

144 (
pkt
 = 
	`sÿm³r_¢iff_pkt_®loc
(
d©a
, 
¶’
, &
tv
)è=ğ
NULL
)

145 
”r
;

147  
pkt
;

149 
”r
:

150 if(
pkt
 !ğ
NULL
è
	`sÿm³r_¢iff_pkt_ä“
(pkt);

151  
NULL
;

152 
	}
}

154 
	$w¬ts_¢iff_pkt_wr™e
(cÚ¡ 
sÿm³r_¢iff_pkt_t
 *
pkt
,

155 cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
ušt8_t
 *
buf
,

156 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

157 
w¬ts_¢iff_pkt_t
 *
¡©e
)

159 
ušt16_t
 
dl
 = 
pkt
->
Ën
;

160 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

161 {&
pkt
->
tv
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

162 {&
pkt
->
Ën
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

163 {
pkt
->
d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
dl
},

165 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

166 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

167 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

169 
	}
}

171 
	$w¬ts_¢iff_·¿ms
(cÚ¡ 
sÿm³r_¢iff_t
 *
¢iff
,

172 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

173 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

175 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

176 
i
, 
max_id
 = 0;

179 
	`mem£t
(
æags
, 0, 
¢iff_v¬s_mfb
);

180 *
·¿ms_Ën
 = 0;

182 
i
=0; i<(
¢iff_v¬s
)/(
w¬ts_v¬_t
); i++)

184 
v¬
 = &
¢iff_v¬s
[
i
];

187 if(
v¬
->
id
 =ğ
WARTS_SNIFF_LIST
 && 
¢iff
->
li¡
 =ğ
NULL
)

189 if(
v¬
->
id
 =ğ
WARTS_SNIFF_CYCLE
 && 
¢iff
->
cyşe
 =ğ
NULL
)

191 if(
v¬
->
id
 =ğ
WARTS_SNIFF_USERID
 && 
¢iff
->
u£rid
 == 0)

193 if(
v¬
->
id
 =ğ
WARTS_SNIFF_SRC
 && 
¢iff
->
¤c
 =ğ
NULL
)

197 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

200 if(
v¬
->
id
 =ğ
WARTS_SNIFF_SRC
)

202 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
¢iff
->
¤c
);

207 *
·¿ms_Ën
 +ğ
v¬
->
size
;

210 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

212 
	}
}

214 
	$w¬ts_¢iff_·¿ms_»ad
(
sÿm³r_¢iff_t
 *
¢iff
,

215 
w¬ts_add¹abË_t
 *
bË
,

216 
w¬ts_¡©e_t
 *
¡©e
,

217 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

219 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

220 {&
¢iff
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

221 {&
¢iff
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

222 {&
¢iff
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

223 {&
¢iff
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

224 {&
¢iff
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

225 {&
¢iff
->
fšish
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

226 {&
¢iff
->
¡İ_»asÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

227 {&
¢iff
->
lim™_pktc
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

228 {&
¢iff
->
lim™_time
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

229 {&
¢iff
->
pktc
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

230 {&
¢iff
->
icmpid
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

232 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

234  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

235 
	}
}

237 
	$w¬ts_¢iff_·¿ms_wr™e
(cÚ¡ 
sÿm³r_¢iff_t
 *
¢iff
,

238 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

239 
w¬ts_add¹abË_t
 *
bË
,

240 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

241 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 *
æags
,

242 cÚ¡ 
ušt16_t
 
æags_Ën
,

243 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

245 
ušt32_t
 
li¡_id
, 
cyşe_id
;

248 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

249 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

250 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

251 {&
¢iff
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

252 {
¢iff
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

253 {&
¢iff
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

254 {&
¢iff
->
fšish
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

255 {&
¢iff
->
¡İ_»asÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

256 {&
¢iff
->
lim™_pktc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

257 {&
¢iff
->
lim™_time
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

258 {&
¢iff
->
pktc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

259 {&
¢iff
->
icmpid
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

261 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

263 if(
	`w¬ts_li¡_g‘id
(
sf
, 
¢iff
->
li¡
, &
li¡_id
) == -1)  -1;

264 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
¢iff
->
cyşe
, &
cyşe_id
) == -1)  -1;

266 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
,

267 
hªdËrs
, 
hªdËr_út
);

270 
	}
}

272 
	$sÿm³r_fe_w¬ts_¢iff_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

273 
sÿm³r_¢iff_t
 **
¢iff_out
)

275 
sÿm³r_¢iff_t
 *
¢iff
 = 
NULL
;

276 
w¬ts_add¹abË_t
 
bË
;

277 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

278 
ušt8_t
 *
buf
 = 
NULL
;

279 
ušt32_t
 
off
 = 0;

280 
ušt32_t
 
i
;

282 
	`mem£t
(&
bË
, 0, (table));

285 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

287 
”r
;

290 if(
buf
 =ğ
NULL
)

292 *
¢iff_out
 = 
NULL
;

297 if((
¢iff
 = 
	`sÿm³r_¢iff_®loc
()è=ğ
NULL
)

299 
”r
;

303 if(
	`w¬ts_¢iff_·¿ms_»ad
(
¢iff
, &
bË
, 
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

305 
”r
;

309 if(
¢iff
->
pktc
 > 0)

312 if(
	`sÿm³r_¢iff_pkts_®loc
(
¢iff
, sniff->
pktc
) != 0)

314 
”r
;

321 
i
=0; i<
¢iff
->
pktc
; i++)

323 
¢iff
->
pkts
[
i
] = 
	`w¬ts_¢iff_pkt_»ad
(
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
);

324 if(
¢iff
->
pkts
[
i
] =ğ
NULL
)

326 
”r
;

331 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

332 
	`w¬ts_add¹abË_ş—n
(&
bË
);

333 *
¢iff_out
 = 
¢iff
;

334 
	`ä“
(
buf
);

337 
”r
:

338 
	`w¬ts_add¹abË_ş—n
(&
bË
);

339 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

340 if(
¢iff
 !ğ
NULL
è
	`sÿm³r_¢iff_ä“
(sniff);

342 
	}
}

345 
	$sÿm³r_fe_w¬ts_¢iff_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

346 cÚ¡ 
sÿm³r_¢iff_t
 *
¢iff
)

348 
w¬ts_add¹abË_t
 
bË
;

349 
w¬ts_¢iff_pkt_t
 *
pkts
 = 
NULL
;

350 
ušt8_t
 *
buf
 = 
NULL
;

351 
ušt8_t
 
æags
[
¢iff_v¬s_mfb
];

352 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

353 
ušt32_t
 
Ën
, 
i
, 
off
 = 0;

354 
size_t
 
size
;

356 
	`mem£t
(&
bË
, 0, (table));

359 
	`w¬ts_¢iff_·¿ms
(
¢iff
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

360 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

362 if(
¢iff
->
pktc
 > 0)

365 
size
 = 
¢iff
->
pktc
 * (
w¬ts_¢iff_pkt_t
);

366 if((
pkts
 = (
w¬ts_¢iff_pkt_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

367 
”r
;

369 
i
=0; i<
¢iff
->
pktc
; i++)

370 
	`w¬ts_¢iff_pkt_·¿ms
(
¢iff
->
pkts
[
i
], &pkts[i], &
Ën
);

374 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

375 
”r
;

376 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_SNIFF
);

379 if(
	`w¬ts_¢iff_·¿ms_wr™e
(
¢iff
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

380 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

382 
”r
;

385 if(
¢iff
->
pktc
 > 0)

387 
i
=0; i<
¢iff
->
pktc
; i++)

388 
	`w¬ts_¢iff_pkt_wr™e
(
¢iff
->
pkts
[
i
], 
sf
, 
buf
, &
off
, 
Ën
, &pkts[i]);

389 
	`ä“
(
pkts
);…kt ğ
NULL
;

392 
	`as£¹
(
off
 =ğ
Ën
);

395 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

396 
”r
;

398 
	`w¬ts_add¹abË_ş—n
(&
bË
);

399 
	`ä“
(
buf
);

402 
”r
:

403 
	`w¬ts_add¹abË_ş—n
(&
bË
);

404 if(
pkts
 !ğ
NULL
è
	`ä“
(pkts);

405 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

407 
	}
}

	@sniff/scamper_sniff_warts.h

24 #iâdeà
__SCAMPER_SNIFF_WARTS_H


25 
	#__SCAMPER_SNIFF_WARTS_H


	)

27 
sÿm³r_fe_w¬ts_¢iff_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

28 cÚ¡ 
sÿm³r_¢iff_t
 *
¢iff
);

30 
sÿm³r_fe_w¬ts_¢iff_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

31 
sÿm³r_¢iff_t
 **
¢iff_out
);

	@sting/scamper_sting.c

28 #iâdeà
lšt


29 cÚ¡ 
	grcsid
[] =

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

36 
	~"š‹º®.h
"

38 
	~"sÿm³r_addr.h
"

39 
	~"sÿm³r_li¡.h
"

40 
	~"sÿm³r_¡šg.h
"

41 
	~"uts.h
"

43 
sÿm³r_¡šg_pkt_t
 *
	$sÿm³r_¡šg_pkt_®loc
(
ušt8_t
 
æags
, ušt8_ˆ*
d©a
,

44 
ušt16_t
 
Ën
, 
timev®
 *
tv
)

46 
sÿm³r_¡šg_pkt_t
 *
pkt
;

48 if((
pkt
 = 
	`m®loc_z”o
((
sÿm³r_¡šg_pkt_t
))è=ğ
NULL
)

49 
”r
;

51 
pkt
->
æags
 = flags;

52 if(
Ën
 !ğ0 && 
d©a
 !ğ
NULL
)

54 if((
pkt
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

55 
”r
;

56 
pkt
->
Ën
 =†en;

58 if(
tv
 !ğ
NULL
è
	`timev®_ıy
(&
pkt
->tv,v);

59  
pkt
;

61 
”r
:

62 
	`ä“
(
pkt
);

63  
NULL
;

64 
	}
}

66 
	$sÿm³r_¡šg_pkt_ä“
(
sÿm³r_¡šg_pkt_t
 *
pkt
)

68 if(
pkt
 =ğ
NULL
)

70 if(
pkt
->
d©a
 !ğ
NULL
è
	`ä“
(pkt->data);

71 
	`ä“
(
pkt
);

73 
	}
}

75 
	$sÿm³r_¡šg_d©a
(
sÿm³r_¡šg_t
 *
¡šg
,cÚ¡ 
ušt8_t
 *
d©a
,
ušt16_t
 
Ën
)

77 
¡šg
->
d©®’
 = 
Ën
;

79 if(
Ën
 !ğ0 && (
¡šg
->
d©a
 = 
	`m®loc
Ö’)è!ğ
NULL
)

81 
	`memıy
(
¡šg
->
d©a
, d©a, 
Ën
);

86 
	}
}

88 
	$sÿm³r_¡šg_pkt_»cÜd
(
sÿm³r_¡šg_t
 *
¡šg
, 
sÿm³r_¡šg_pkt_t
 *
pkt
)

90 
size_t
 
Ën
 = (
¡šg
->
pktc
 + 1è* (
sÿm³r_¡šg_pkt_t
 *);

93 if(
	`»®loc_w¿p
((**)&
¡šg
->
pkts
, 
Ën
) != 0)

96 
¡šg
->
pkts
[¡šg->
pktc
++] = 
pkt
;

98 
	}
}

100 
	$sÿm³r_¡šg_pkts_®loc
(
sÿm³r_¡šg_t
 *
¡šg
, 
ušt32_t
 
pktc
)

102 
size_t
 
size
 = 
pktc
 * (
sÿm³r_¡šg_pkt_t
 *);

103 if((
¡šg
->
pkts
 = (
sÿm³r_¡šg_pkt_t
 **)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

106 
	}
}

108 
	$sÿm³r_¡šg_ä“
(
sÿm³r_¡šg_t
 *
¡šg
)

110 if(
¡šg
 =ğ
NULL
)

113 if(
¡šg
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sting->src);

114 if(
¡šg
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(sting->dst);

115 if(
¡šg
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(sting->list);

116 if(
¡šg
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(sting->cycle);

117 if(
¡šg
->
d©a
 !ğ
NULL
è
	`ä“
(sting->data);

119 
	`ä“
(
¡šg
);

121 
	}
}

123 
sÿm³r_¡šg_t
 *
	$sÿm³r_¡šg_®loc
()

125  (
sÿm³r_¡šg_t
 *)
	`m®loc_z”o
((scamper_sting_t));

126 
	}
}

	@sting/scamper_sting.h

32 #iâdeà
__SCAMPER_STING_H


33 
	#__SCAMPER_STING_H


	)

35 
	#SCAMPER_STING_RESULT_NONE
 0

	)

36 
	#SCAMPER_STING_RESULT_COMPLETED
 1

	)

38 
	#SCAMPER_STING_DISTRIBUTION_EXPONENTIAL
 1

	)

39 
	#SCAMPER_STING_DISTRIBUTION_PERIODIC
 2

	)

40 
	#SCAMPER_STING_DISTRIBUTION_UNIFORM
 3

	)

42 
	ssÿm³r_¡šg_pkt


44 
timev®
 
	mtv
;

45 
ušt8_t
 
	mæags
;

46 
ušt16_t
 
	mËn
;

47 
ušt8_t
 *
	md©a
;

48 } 
	tsÿm³r_¡šg_pkt_t
;

50 
	#SCAMPER_STING_PKT_FLAG_TX
 0x01

	)

51 
	#SCAMPER_STING_PKT_FLAG_RX
 0x02

	)

52 
	#SCAMPER_STING_PKT_FLAG_DATA
 0x04

	)

53 
	#SCAMPER_STING_PKT_FLAG_HOLE
 0x08

	)

60 
	ssÿm³r_¡šg


65 
sÿm³r_li¡_t
 *
	mli¡
;

66 
sÿm³r_cyşe_t
 *
	mcyşe
;

67 
ušt32_t
 
	mu£rid
;

72 
sÿm³r_addr_t
 *
	m¤c
;

73 
sÿm³r_addr_t
 *
	md¡
;

74 
ušt16_t
 
	m¥Üt
;

75 
ušt16_t
 
	mdpÜt
;

76 
ušt16_t
 
	mcouÁ
;

77 
ušt16_t
 
	mm—n
;

78 
ušt16_t
 
	mš‹r
;

79 
ušt8_t
 
	mdi¡
;

80 
ušt8_t
 
	msyÄ‘x
;

81 
ušt8_t
 
	md©¬‘x
;

82 
ušt8_t
 
	m£qsk
;

83 
ušt8_t
 *
	md©a
;

84 
ušt16_t
 
	md©®’
;

89 
timev®
 
	m¡¬t
;

90 
timev®
 
	mh¤‰
;

91 
ušt16_t
 
	md©¯ckc
;

92 
ušt16_t
 
	mhŞec
;

93 
sÿm³r_¡šg_pkt_t
 **
	mpkts
;

94 
ušt32_t
 
	mpktc
;

95 
ušt8_t
 
	m»suÉ
;

97 } 
	tsÿm³r_¡šg_t
;

99 
sÿm³r_¡šg_t
 *
sÿm³r_¡šg_®loc
();

100 
sÿm³r_¡šg_ä“
(
sÿm³r_¡šg_t
 *);

101 
sÿm³r_addr_t
 *
sÿm³r_¡šg_addr
(const *);

102 
sÿm³r_¡šg_d©a
(
sÿm³r_¡šg_t
 *,cÚ¡ 
ušt8_t
 *,
ušt16_t
);

103 
sÿm³r_¡šg_pkts_®loc
(
sÿm³r_¡šg_t
 *, 
ušt32_t
);

104 
sÿm³r_¡šg_pkt_»cÜd
(
sÿm³r_¡šg_t
 *, 
sÿm³r_¡šg_pkt_t
 *);

106 
sÿm³r_¡šg_pkt_t
 *
sÿm³r_¡šg_pkt_®loc
(
ušt8_t
 
æags
, ušt8_ˆ*
d©a
,

107 
ušt16_t
 
Ën
, 
timev®
 *
tv
);

108 
sÿm³r_¡šg_pkt_ä“
(
sÿm³r_¡šg_pkt_t
 *
pkt
);

	@sting/scamper_sting_do.c

32 #iâdeà
lšt


33 cÚ¡ 
	grcsid
[] =

37 #ifdeà
HAVE_CONFIG_H


38 
	~"cÚfig.h
"

40 
	~"š‹º®.h
"

42 
	~"sÿm³r.h
"

43 
	~"sÿm³r_addr.h
"

44 
	~"sÿm³r_li¡.h
"

45 
	~"sÿm³r_¡šg.h
"

46 
	~"sÿm³r_sk.h
"

47 
	~"sÿm³r_dl.h
"

48 
	~"sÿm³r_fds.h
"

49 
	~"sÿm³r_dlhdr.h
"

50 
	~"sÿm³r_fœew®l.h
"

51 
	~"sÿm³r_¹sock.h
"

52 
	~"sÿm³r_´obe.h
"

53 
	~"sÿm³r_g‘¤c.h
"

54 
	~"sÿm³r_tı4.h
"

55 
	~"sÿm³r_tı6.h
"

56 
	~"sÿm³r_queue.h
"

57 
	~"sÿm³r_fe.h
"

58 
	~"sÿm³r_İtiÚs.h
"

59 
	~"sÿm³r_debug.h
"

60 
	~"sÿm³r_¡šg_do.h
"

61 
	~"uts.h
"

62 
	~"mjl_li¡.h
"

70 
	#SCAMPER_DO_STING_COUNT_MIN
 2

	)

71 
	#SCAMPER_DO_STING_COUNT_DEF
 48

	)

72 
	#SCAMPER_DO_STING_COUNT_MAX
 65535

	)

78 
	#SCAMPER_DO_STING_MEAN_MIN
 1

	)

79 
	#SCAMPER_DO_STING_MEAN_DEF
 100

	)

80 
	#SCAMPER_DO_STING_MEAN_MAX
 1000

	)

86 
	#SCAMPER_DO_STING_INTER_MIN
 1

	)

87 
	#SCAMPER_DO_STING_INTER_DEF
 2000

	)

88 
	#SCAMPER_DO_STING_INTER_MAX
 10000

	)

94 
	#SCAMPER_DO_STING_DIST_MIN
 1

	)

95 
	#SCAMPER_DO_STING_DIST_DEF
 3

	)

96 
	#SCAMPER_DO_STING_DIST_MAX
 3

	)

102 
	#SCAMPER_DO_STING_SYNRETX_MIN
 0

	)

103 
	#SCAMPER_DO_STING_SYNRETX_DEF
 3

	)

104 
	#SCAMPER_DO_STING_SYNRETX_MAX
 5

	)

110 
	#SCAMPER_DO_STING_DATARETX_MIN
 0

	)

111 
	#SCAMPER_DO_STING_DATARETX_DEF
 5

	)

112 
	#SCAMPER_DO_STING_DATARETX_MAX
 10

	)

118 
	#SCAMPER_DO_STING_SEQSKIP_MIN
 1

	)

119 
	#SCAMPER_DO_STING_SEQSKIP_DEF
 3

	)

120 
	#SCAMPER_DO_STING_SEQSKIP_MAX
 255

	)

122 
	s¡šg_¡©e


124 
ušt8_t
 
	mmode
;

125 
timev®
 
	mÃxt_tx
;

127 #iâdeà
_WIN32


128 
sÿm³r_fd_t
 *
	m¹sock
;

131 
sÿm³r_fd_t
 *
	mdl
;

132 
sÿm³r_fœew®l_’Œy_t
 *
	mfw
;

133 
sÿm³r_rou‹_t
 *
	mrou‹
;

134 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

135 
ušt32_t
 
	mi¢
;

136 
ušt32_t
 
	mack
;

137 
ušt32_t
 
	moff
;

138 
ušt8_t
 
	m©‹m±
;

139 
sÿm³r_¡šg_pkt_t
 **
	m´obes
;

140 
ušt16_t
 
	m´obec
;

141 } 
	t¡šg_¡©e_t
;

143 cÚ¡ 
ušt8_t
 
	gMODE_RTSOCK
 = 0;

144 cÚ¡ 
ušt8_t
 
	gMODE_DLHDR
 = 1;

145 cÚ¡ 
ušt8_t
 
	gMODE_SYN
 = 2;

146 cÚ¡ 
ušt8_t
 
	gMODE_ACK
 = 3;

147 cÚ¡ 
ušt8_t
 
	gMODE_DATA
 = 4;

148 cÚ¡ 
ušt8_t
 
	gMODE_INTER
 = 5;

149 cÚ¡ 
ušt8_t
 
	gMODE_HOLE
 = 6;

150 cÚ¡ 
ušt8_t
 
	gMODE_RST
 = 7;

153 
sÿm³r_sk_funcs_t
 
	g¡šg_funcs
;

156 
sÿm³r_addrÿche_t
 *
addrÿche
;

158 
	#STING_OPT_COUNT
 1

	)

159 
	#STING_OPT_DPORT
 2

	)

160 
	#STING_OPT_DIST
 3

	)

161 
	#STING_OPT_REQ
 4

	)

162 
	#STING_OPT_HOLE
 5

	)

163 
	#STING_OPT_INTER
 6

	)

164 
	#STING_OPT_MEAN
 7

	)

165 
	#STING_OPT_SPORT
 8

	)

166 
	#STING_OPT_USERID
 9

	)

168 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

169 {'c', 
NULL
, 
STING_OPT_COUNT
, 
SCAMPER_OPTION_TYPE_NUM
},

170 {'d', 
NULL
, 
STING_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

171 {'f', 
NULL
, 
STING_OPT_DIST
, 
SCAMPER_OPTION_TYPE_STR
},

172 {'h', 
NULL
, 
STING_OPT_REQ
, 
SCAMPER_OPTION_TYPE_STR
},

173 {'H', 
NULL
, 
STING_OPT_HOLE
, 
SCAMPER_OPTION_TYPE_NUM
},

174 {'i', 
NULL
, 
STING_OPT_INTER
, 
SCAMPER_OPTION_TYPE_NUM
},

175 {'m', 
NULL
, 
STING_OPT_MEAN
, 
SCAMPER_OPTION_TYPE_STR
},

176 {'s', 
NULL
, 
STING_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

177 {'U', 
NULL
, 
STING_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

179 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

181 cÚ¡ *
	$sÿm³r_do_¡šg_u§ge
()

185 
	}
}

192 cÚ¡ *
	gdeçuÉ»que¡
 =

199 
sÿm³r_¡šg_t
 *
	$¡šg_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

201  
	`sÿm³r_sk_g‘d©a
(
sk
);

202 
	}
}

204 
¡šg_¡©e_t
 *
	$¡šg_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

206  
	`sÿm³r_sk_g‘¡©e
(
sk
);

207 
	}
}

209 
	$¡šg_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

211 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

213 
	}
}

220 
	$hªdËtimeout_syn
(
sÿm³r_sk_t
 *
sk
)

222 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

223 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

225 if(
¡©e
->
©‹m±
 =ğ
¡šg
->
syÄ‘x
)

226 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

228 
	`sÿm³r_sk_queue_´obe
(
sk
);

231 
	}
}

240 
	$hªdËtimeout_š‹r
(
sÿm³r_sk_t
 *
sk
)

242 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

243 
¡©e
->
©‹m±
 = 0;

244 
¡©e
->
off
 = 0;

245 
¡©e
->
mode
 = 
MODE_HOLE
;

246 
	`sÿm³r_sk_queue_´obe
(
sk
);

248 
	}
}

257 
	$hªdËtimeout_hŞe
(
sÿm³r_sk_t
 *
sk
)

259 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

260 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

266 if(
¡©e
->
©‹m±
 =ğ
¡šg
->
d©¬‘x
)

267 
¡©e
->
mode
 = 
MODE_RST
;

269 
	`sÿm³r_sk_queue_´obe
(
sk
);

271 
	}
}

279 
	$hªdËtimeout_r¡
(
sÿm³r_sk_t
 *
sk
)

281 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

283 
	}
}

291 
	$do_¡šg_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

293 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) =

295 
NULL
,

296 
NULL
,

297 
hªdËtimeout_syn
,

298 
NULL
,

299 
NULL
,

300 
hªdËtimeout_š‹r
,

301 
hªdËtimeout_hŞe
,

302 
hªdËtimeout_r¡
,

304 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

306 if(
func
[
¡©e
->
mode
] !ğ
NULL
)

308 
func
[
¡©e
->
mode
](
sk
);

312 
	}
}

319 
	$hªdËtı_syn
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

321 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

322 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

323 
timev®
 
tv
;

329 if((
dl
->
dl_tı_æags
 & (
TH_SYN
|
TH_ACK
)) != (TH_SYN|TH_ACK))

332 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

340 
¡©e
->
i¢
++;

343 if(
dl
->
dl_tı_ack
 !ğ
¡©e
->
i¢
)

345 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

350 if(
¡©e
->
©‹m±
 == 1)

352 
tv
.
tv_£c
 = 
¡©e
->
Ãxt_tx
.tv_sec - 5;

353 
tv
.
tv_u£c
 = 
¡©e
->
Ãxt_tx
.tv_usec;

354 
	`timev®_diff_tv
(&
¡šg
->
h¤‰
, &
tv
, &
dl
->
dl_tv
);

358 
¡©e
->
ack
 = 
dl
->
dl_tı_£q
 + 1;

359 
¡©e
->
mode
 = 
MODE_ACK
;

362 
¡©e
->
off
 = 
¡šg
->
£qsk
;

364 
	`sÿm³r_sk_queue_´obe
(
sk
);

366 
	}
}

374 
	$hªdËtı_d©a
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

376 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

377 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

380 if(
dl
->
dl_tı_ack
 !ğ
¡©e
->
i¢
)

382 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

386 
¡šg
->
d©¯ckc
++;

388 
	}
}

396 
	$hªdËtı_hŞe
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

398 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

399 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

400 
ušt16_t
 
u16
;

406 if(
¡©e
->
i¢
 >ğ
dl
->
dl_tı_ack
)

407 
”r
;

410 if(
¡©e
->
i¢
 + 
¡šg
->
£qsk
 + stšg->
couÁ
 =ğ
dl
->
dl_tı_ack
)

412 
¡©e
->
off
 = 
¡šg
->
£qsk
 + stšg->
couÁ
 - 1;

413 
¡©e
->
mode
 = 
MODE_RST
;

414 
¡šg
->
»suÉ
 = 
SCAMPER_STING_RESULT_COMPLETED
;

415 
	`sÿm³r_sk_queue_´obe
(
sk
);

419 
¡©e
->
off
 = 
dl
->
dl_tı_ack
 - s‹->
i¢
;

420 
u16
 = 
¡©e
->
off
 - 
¡šg
->
£qsk
;

421 if(
u16
 >ğ
¡©e
->
´obec
)

422 
”r
;

424 
¡©e
->
´obes
[
u16
]->
æags
 |ğ
SCAMPER_STING_PKT_FLAG_HOLE
;

425 
¡šg
->
hŞec
++;

426 
¡©e
->
©‹m±
 = 0;

427 
	`sÿm³r_sk_queue_´obe
(
sk
);

430 
”r
:

431 
¡©e
->
mode
 = 
MODE_RST
;

432 
	`sÿm³r_sk_queue_´obe
(
sk
);

434 
	}
}

442 
	$do_¡šg_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

444 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *) =

446 
NULL
,

447 
NULL
,

448 
hªdËtı_syn
,

449 
NULL
,

450 
hªdËtı_d©a
,

451 
hªdËtı_d©a
,

452 
hªdËtı_hŞe
,

453 
NULL
,

455 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

456 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

457 
sÿm³r_¡šg_pkt_t
 *
pkt
;

460 if(
	`SCAMPER_DL_IS_TCP
(
dl
) == 0 ||

461 
dl
->
dl_tı_¥Üt
 !ğ
¡šg
->
dpÜt
 ||

462 
dl
->
dl_tı_dpÜt
 !ğ
¡šg
->
¥Üt
 ||

463 
	`sÿm³r_addr_¿w_cmp
(
¡šg
->
¤c
, 
dl
->
dl__d¡
) != 0 ||

464 
	`sÿm³r_addr_¿w_cmp
(
¡šg
->
d¡
, 
dl
->
dl__¤c
) != 0)

469 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

471 
pkt
 = 
	`sÿm³r_¡šg_pkt_®loc
(
SCAMPER_STING_PKT_FLAG_RX
, 
dl
->
dl_Ãt_¿w
,

472 
dl
->
dl__size
, &dl->
dl_tv
);

473 if(
pkt
 =ğ
NULL
 || 
	`sÿm³r_¡šg_pkt_»cÜd
(
¡šg
,…kt) != 0)

475 if(
pkt
 !ğ
NULL
è
	`sÿm³r_¡šg_pkt_ä“
(pkt);

476 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

481 if((
dl
->
dl_tı_æags
 & 
TH_RST
) != 0)

483 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

487 if(
func
[
¡©e
->
mode
] !ğ
NULL
)

489 
func
[
¡©e
->
mode
](
sk
, 
dl
);

492 
	}
}

494 
	$¡šg_hªdË_dlhdr
(
sÿm³r_dlhdr_t
 *
dlhdr
)

496 
sÿm³r_sk_t
 *
sk
 = 
dlhdr
->
·¿m
;

497 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

499 if(
dlhdr
->
”rÜ
 != 0)

501 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

505 
¡©e
->
mode
 = 
MODE_SYN
;

506 
	`sÿm³r_sk_queue_´obe
(
sk
);

508 
	}
}

510 
	$¡šg_hªdË_¹
(
sÿm³r_rou‹_t
 *
¹
)

512 
sÿm³r_sk_t
 *
sk
 = 
¹
->
·¿m
;

513 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

514 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

515 
sÿm³r_dl_t
 *
dl
;

517 if(
¡©e
->
mode
 !ğ
MODE_RTSOCK
 || s‹->
rou‹
 !ğ
¹
)

518 
dÚe
;

520 #iâdeà
_WIN32


521 if(
¡©e
->
¹sock
 !ğ
NULL
)

523 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

524 
¡©e
->
¹sock
 = 
NULL
;

528 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

530 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifindex");

531 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

532 
dÚe
;

535 if((
¡©e
->
dl
 = 
	`sÿm³r_fd_dl
(
¹
->
ifšdex
)è=ğ
NULL
)

537 
	`sÿm³r_debug
(
__func__
, "could‚Ù g‘ dÈfÜ %d", 
¹
->
ifšdex
);

538 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

539 
dÚe
;

546 
¡©e
->
mode
 = 
MODE_DLHDR
;

547 if((
¡©e
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

549 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

550 
dÚe
;

552 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->dl);

553 
¡©e
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
¡šg
->dst);

554 
¡©e
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

555 
¡©e
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

556 
¡©e
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

557 
¡©e
->
dlhdr
->
·¿m
 = 
sk
;

558 
¡©e
->
dlhdr
->
cb
 = 
¡šg_hªdË_dlhdr
;

559 if(
	`sÿm³r_dlhdr_g‘
(
¡©e
->
dlhdr
) != 0)

561 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

562 
dÚe
;

565 if(
¡©e
->
mode
 !ğ
MODE_SYN
 && 
	`sÿm³r_sk_queue_isdÚe
(
sk
) == 0)

566 
	`sÿm³r_sk_queue_wa™
(
sk
, 1000);

568 
dÚe
:

569 
	`sÿm³r_rou‹_ä“
(
¹
);

570 if(
¡©e
->
rou‹
 =ğ
¹
)

571 
¡©e
->
rou‹
 = 
NULL
;

573 
	}
}

575 
	$do_¡šg_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

577 
	`sÿm³r_fe_wr™e_¡šg
(
sf
, 
	`¡šg_g‘d©a
(
sk
));

579 
	}
}

581 
	$¡šg_¡©e_ä“
(
¡šg_¡©e_t
 *
¡©e
)

583 if(
¡©e
 =ğ
NULL
)

586 if(
¡©e
->
fw
 !ğ
NULL
è
	`sÿm³r_fœew®l_’Œy_ä“
(state->fw);

587 #iâdeà
_WIN32


588 if(
¡©e
->
¹sock
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->rtsock);

590 if(
¡©e
->
dl
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->dl);

591 if(
¡©e
->
dlhdr
 !ğ
NULL
è
	`sÿm³r_dlhdr_ä“
(state->dlhdr);

592 if(
¡©e
->
rou‹
 !ğ
NULL
è
	`sÿm³r_rou‹_ä“
(state->route);

593 
	`ä“
(
¡©e
);

596 
	}
}

598 
	$¡šg_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

600 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

601 
¡šg_¡©e_t
 *
¡©e
;

602 
ušt16_t
 
u16
;

603 
size_t
 
size
;

605 if((
¡©e
 = 
	`m®loc_z”o
((
¡šg_¡©e_t
))è=ğ
NULL
)

607 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

608 
”r
;

610 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

612 
size
 = (
¡šg
->
£qsk
 + stšg->
couÁ
è* (
sÿm³r_¡šg_pkt_t
 *);

613 if((
¡©e
->
´obes
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

614 
”r
;

616 if(
	`¿ndom_u16
(&
u16
) != 0)

618 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„andom isn");

619 
”r
;

621 
¡©e
->
i¢
 = 
u16
;

623 #iâdeà
_WIN32


624 if((
¡©e
->
¹sock
 = 
	`sÿm³r_fd_¹sock
()è=ğ
NULL
)

626 
”r
;

630 
¡©e
->
mode
 = 
MODE_RTSOCK
;

633 
”r
:

635 
	}
}

637 
	$do_¡šg_h®t
(
sÿm³r_sk_t
 *
sk
)

639 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

641 
	}
}

643 
	$do_¡šg_ä“
(
sÿm³r_sk_t
 *
sk
)

645 
sÿm³r_¡šg_t
 *
¡šg
;

646 
¡šg_¡©e_t
 *
¡©e
;

649 if((
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
)è!ğ
NULL
)

651 
	`¡šg_¡©e_ä“
(
¡©e
);

655 if((
¡šg
 = 
	`¡šg_g‘d©a
(
sk
)è!ğ
NULL
)

657 
	`sÿm³r_¡šg_ä“
(
¡šg
);

661 
	}
}

663 
	$do_¡šg_´obe
(
sÿm³r_sk_t
 *
sk
)

665 
sÿm³r_fœew®l_ruË_t
 
sfw
;

666 
sÿm³r_¡šg_pkt_t
 *
pkt
;

667 
sÿm³r_¡šg_t
 *
¡šg
 = 
	`¡šg_g‘d©a
(
sk
);

668 
¡šg_¡©e_t
 *
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

669 
sÿm³r_´obe_t
 
´obe
;

670 
ušt32_t
 
wa™
;

671 
ušt8_t
 
d©a
[3];

673 if(
¡©e
 =ğ
NULL
)

675 
	`g‘timeofday_w¿p
(&
¡šg
->
¡¬t
);

677 if(
	`¡šg_¡©e_®loc
(
sk
) != 0)

678 
”r
;

680 
¡©e
 = 
	`¡šg_g‘¡©e
(
sk
);

683 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
)

685 
¡©e
->
rou‹
 = 
	`sÿm³r_rou‹_®loc
(
¡šg
->
d¡
, 
sk
, 
¡šg_hªdË_¹
);

686 if(
¡©e
->
rou‹
 =ğ
NULL
)

687 
”r
;

689 #iâdeà
_WIN32


690 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
¹sock
, s‹->
rou‹
) != 0)

691 
”r
;

693 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
rou‹
) != 0)

694 
”r
;

697 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

700 if(
¡©e
->
mode
 !ğ
MODE_SYN
)

702 
	`sÿm³r_sk_queue_wa™
(
sk
, 1000);

707 
	`mem£t
(&
´obe
, 0, (probe));

708 
´obe
.
´_dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
dl
);

709 
´obe
.
´_dl_buf
 = 
¡©e
->
dlhdr
->
buf
;

710 
´obe
.
´_dl_Ën
 = 
¡©e
->
dlhdr
->
Ën
;

711 
´obe
.
´__¤c
 = 
¡šg
->
¤c
;

712 
´obe
.
´__d¡
 = 
¡šg
->
d¡
;

713 
´obe
.
´__‰l
 = 255;

714 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

715 
´obe
.
´_tı_¥Üt
 = 
¡šg
->
¥Üt
;

716 
´obe
.
´_tı_dpÜt
 = 
¡šg
->
dpÜt
;

718 if(
¡©e
->
mode
 =ğ
MODE_SYN
)

720 if(
¡©e
->
©‹m±
 == 0)

726 
sfw
.
ty³
 = 
SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
;

727 
sfw
.
sfw_5tu¶e_´Ùo
 = 
IPPROTO_TCP
;

728 
sfw
.
sfw_5tu¶e_¤c
 = 
¡šg
->
d¡
;

729 
sfw
.
sfw_5tu¶e_d¡
 = 
¡šg
->
¤c
;

730 
sfw
.
sfw_5tu¶e_¥Üt
 = 
¡šg
->
dpÜt
;

731 
sfw
.
sfw_5tu¶e_dpÜt
 = 
¡šg
->
¥Üt
;

732 if((
¡©e
->
fw
 = 
	`sÿm³r_fœew®l_’Œy_g‘
(&
sfw
)è=ğ
NULL
)

734 
”r
;

738 
´obe
.
´_tı_£q
 = 
¡©e
->
i¢
;

739 
´obe
.
´_tı_ack
 = 0;

740 
´obe
.
´_tı_æags
 = 
TH_SYN
;

741 
´obe
.
´_tı_wš
 = 0;

742 
´obe
.
´_Ën
 = 0;

745 
wa™
 = 5000;

747 if(
¡©e
->
mode
 =ğ
MODE_ACK
)

749 
´obe
.
´_tı_£q
 = 
¡©e
->
i¢
;

750 
´obe
.
´_tı_ack
 = 
¡©e
->
ack
;

751 
´obe
.
´_tı_æags
 = 
TH_ACK
;

752 
´obe
.
´_tı_wš
 = 0;

753 
´obe
.
´_Ën
 = 0;

756 
wa™
 = 50;

757 
¡©e
->
mode
 = 
MODE_DATA
;

759 if(
¡©e
->
mode
 =ğ
MODE_DATA
)

761 
d©a
[0] = 
¡šg
->d©a[
¡©e
->
off
];

763 
´obe
.
´_tı_£q
 = 
¡©e
->
i¢
 + s‹->
off
;

764 
´obe
.
´_tı_ack
 = 
¡©e
->
ack
;

765 
´obe
.
´_tı_æags
 = 
TH_PUSH
 | 
TH_ACK
;

766 
´obe
.
´_tı_wš
 = 0;

767 
´obe
.
´_Ën
 = 1;

768 
´obe
.
´_d©a
 = 
d©a
;

770 
¡©e
->
off
++;

772 
wa™
 = 
¡šg
->
m—n
;

774 if(
¡©e
->
mode
 =ğ
MODE_HOLE
)

776 
d©a
[0] = 
¡šg
->d©a[
¡©e
->
off
];

778 
´obe
.
´_tı_£q
 = 
¡©e
->
i¢
 + s‹->
off
;

779 
´obe
.
´_tı_ack
 = 
¡©e
->
ack
;

780 
´obe
.
´_tı_æags
 = 
TH_PUSH
 | 
TH_ACK
;

781 
´obe
.
´_tı_wš
 = 0;

782 
´obe
.
´_d©a
 = 
d©a
;

784 if(
¡©e
->
off
 == 0)

786 
d©a
[1] = 
¡šg
->data[1];

787 
d©a
[2] = 
¡šg
->data[2];

788 
´obe
.
´_Ën
 = 3;

792 
´obe
.
´_Ën
 = 1;

796 
wa™
 = 2000;

798 if(
¡©e
->
mode
 =ğ
MODE_RST
)

800 
´obe
.
´_tı_£q
 = 
¡©e
->
i¢
 + s‹->
off
;

801 
´obe
.
´_tı_ack
 = 
¡©e
->
ack
;

802 
´obe
.
´_tı_æags
 = 
TH_RST
;

803 
´obe
.
´_tı_wš
 = 0;

804 
´obe
.
´_Ën
 = 0;

807 
wa™
 = 1000;

811 
”r
;

815 if(
	`sÿm³r_´obe
(&
´obe
) == -1)

817 
”ºo
 = 
´obe
.
´_”ºo
;

818 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send…robe");

819 
”r
;

822 if((
pkt
 = 
	`sÿm³r_¡šg_pkt_®loc
(
SCAMPER_STING_PKT_FLAG_TX
,

823 
´obe
.
´_tx_¿w
,…robe.
´_tx_¿wËn
,

824 &
´obe
.
´_tx
)è=ğ
NULL
 ||

825 
	`sÿm³r_¡šg_pkt_»cÜd
(
¡šg
, 
pkt
) != 0)

827 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecord…acket");

828 
”r
;

831 if(
¡©e
->
mode
 =ğ
MODE_DATA
)

833 
pkt
->
æags
 |ğ
SCAMPER_STING_PKT_FLAG_DATA
;

834 
¡©e
->
´obes
[¡©e->
´obec
] = 
pkt
;

835 if(
¡©e
->
´obec
 =ğ
¡šg
->
couÁ
)

838 
wa™
 = 
¡šg
->
š‹r
;

839 
¡©e
->
mode
 = 
MODE_INTER
;

841 
¡©e
->
´obec
++;

845 
	`timev®_add_ms
(&
¡©e
->
Ãxt_tx
, &
´obe
.
´_tx
, 
wa™
);

848 
	`sÿm³r_sk_queue_wa™
(
sk
, 
wa™
);

850 
¡©e
->
©‹m±
++;

853 
”r
:

854 
	`sÿm³r_debug
(
__func__
, "”rÜ mod%d", 
¡©e
 !ğ
NULL
 ? s‹->
mode
 : -1);

855 
	`¡šg_hªdË”rÜ
(
sk
, 
”ºo
);

857 
	}
}

859 
	$¡šg_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

861 
tmp
;

863 
İtid
)

865 
STING_OPT_COUNT
:

866 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

867 
tmp
 < 
SCAMPER_DO_STING_COUNT_MIN
 ||

868 
tmp
 > 
SCAMPER_DO_STING_COUNT_MAX
)

870 
”r
;

874 
STING_OPT_SPORT
:

875 
STING_OPT_DPORT
:

876 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0 ||mp > 65535)

877 
”r
;

880 
STING_OPT_DIST
:

881 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

882 
tmp
 < 
SCAMPER_DO_STING_DIST_MIN
 ||

883 
tmp
 > 
SCAMPER_DO_STING_DIST_MAX
)

884 
”r
;

887 
STING_OPT_REQ
:

890 
STING_OPT_MEAN
:

891 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

892 
tmp
 < 
SCAMPER_DO_STING_MEAN_MIN
 ||

893 
tmp
 > 
SCAMPER_DO_STING_MEAN_MAX
)

894 
”r
;

897 
STING_OPT_HOLE
:

898 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

899 
tmp
 < 
SCAMPER_DO_STING_SEQSKIP_MIN
 ||

900 
tmp
 > 
SCAMPER_DO_STING_SEQSKIP_MAX
)

901 
”r
;

904 
STING_OPT_INTER
:

905 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

906 
tmp
 < 
SCAMPER_DO_STING_INTER_MIN
 ||

907 
tmp
 > 
SCAMPER_DO_STING_INTER_MAX
)

908 
”r
;

911 
STING_OPT_USERID
:

912 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

913 
”r
;

921 if(
out
 !ğ
NULL
)

922 *
out
 = 
tmp
;

925 
”r
:

927 
	}
}

936 *
	$sÿm³r_do_¡šg_®loc
(*
¡r
)

938 
ušt16_t
 
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

939 
ušt16_t
 
dpÜt
 = 80;

940 
ušt16_t
 
couÁ
 = 
SCAMPER_DO_STING_COUNT_DEF
;

941 
ušt16_t
 
m—n
 = 
SCAMPER_DO_STING_MEAN_DEF
;

942 
ušt16_t
 
š‹r
 = 
SCAMPER_DO_STING_INTER_DEF
;

943 
ušt8_t
 
£qsk
 = 
SCAMPER_DO_STING_SEQSKIP_DEF
;

944 
ušt8_t
 
di¡
 = 
SCAMPER_DO_STING_DIST_DEF
;

945 
ušt8_t
 
syÄ‘x
 = 
SCAMPER_DO_STING_SYNRETX_DEF
;

946 
ušt8_t
 
d©¬‘x
 = 
SCAMPER_DO_STING_DATARETX_DEF
;

947 
ušt32_t
 
u£rid
 = 0;

948 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

949 
sÿm³r_¡šg_t
 *
¡šg
 = 
NULL
;

950 *
addr
;

951 
tmp
 = 0;

954 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

956 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse options");

957 
”r
;

961 if(
addr
 =ğ
NULL
)

963 
	`sÿm³r_debug
(
__func__
, "no‡ddress…arameter");

964 
”r
;

968 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

970 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

971 
	`¡šg_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

973 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

974 
”r
;

977 
İt
->
id
)

979 
STING_OPT_DPORT
:

980 
dpÜt
 = (
ušt16_t
)
tmp
;

983 
STING_OPT_SPORT
:

984 
¥Üt
 = (
ušt16_t
)
tmp
;

987 
STING_OPT_COUNT
:

988 
couÁ
 = (
ušt16_t
)
tmp
;

991 
STING_OPT_MEAN
:

992 
m—n
 = (
ušt16_t
)
tmp
;

995 
STING_OPT_DIST
:

996 
di¡
 = (
ušt8_t
)
tmp
;

999 
STING_OPT_HOLE
:

1000 
£qsk
 = (
ušt8_t
)
tmp
;

1003 
STING_OPT_INTER
:

1004 
š‹r
 = (
ušt16_t
)
tmp
;

1007 
STING_OPT_USERID
:

1008 
u£rid
 = (
ušt32_t
)
tmp
;

1012 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

1014 if((
¡šg
 = 
	`sÿm³r_¡šg_®loc
()è=ğ
NULL
)

1016 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc sting");

1017 
”r
;

1019 if((
¡šg
->
d¡
=
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
)è=ğ
NULL
)

1021 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù„esŞv%s", 
addr
);

1022 
”r
;

1025 
¡šg
->
¥Üt
 = sport;

1026 
¡šg
->
dpÜt
 = dport;

1027 
¡šg
->
couÁ
 = count;

1028 
¡šg
->
m—n
 = mean;

1029 
¡šg
->
š‹r
 = inter;

1030 
¡šg
->
di¡
 = dist;

1031 
¡šg
->
syÄ‘x
 = synretx;

1032 
¡šg
->
d©¬‘x
 = dataretx;

1033 
¡šg
->
£qsk
 = seqskip;

1034 
¡šg
->
u£rid
 = userid;

1037 if(
	`sÿm³r_¡šg_d©a
(
¡šg
, (cÚ¡ 
ušt8_t
 *)
deçuÉ»que¡
,

1038 
£qsk
 + 
couÁ
) != 0)

1040 
”r
;

1043  
¡šg
;

1045 
”r
:

1046 if(
¡šg
 !ğ
NULL
è
	`sÿm³r_¡šg_ä“
(sting);

1047 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

1048  
NULL
;

1049 
	}
}

1056 
	$sÿm³r_do_¡šg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

1058  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

1059 
¡šg_¬g_·¿m_v®id©e
);

1060 
	}
}

1062 
	$sÿm³r_do_¡šg_ä“
(*
d©a
)

1064 
	`sÿm³r_¡šg_ä“
((
sÿm³r_¡šg_t
 *)
d©a
);

1066 
	}
}

1072 
sÿm³r_sk_t
 *
	$sÿm³r_do_¡šg_®loùask
(*
d©a
,

1073 
sÿm³r_li¡_t
 *
li¡
,

1074 
sÿm³r_cyşe_t
 *
cyşe
)

1076 
sÿm³r_¡šg_t
 *
¡šg
 = (sÿm³r_¡šg_ˆ*)
d©a
;

1077 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

1078 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

1081 if((
sk
 = 
	`sÿm³r_sk_®loc
(
¡šg
, &
¡šg_funcs
)è=ğ
NULL
)

1082 
”r
;

1085 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

1086 
”r
;

1087 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
¡šg
->
d¡
);

1088 if(
¡šg
->
¤c
 =ğ
NULL
 && (¡šg->¤øğ
	`sÿm³r_g‘¤c
(¡šg->
d¡
,0)) == NULL)

1089 
”r
;

1090 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
¡šg
->
¤c
);

1091 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

1092 
”r
;

1093 
sig
 = 
NULL
;

1096 
¡šg
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

1097 
¡šg
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

1099  
sk
;

1101 
”r
:

1102 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

1103 if(
sk
 !ğ
NULL
)

1105 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

1106 
	`sÿm³r_sk_ä“
(
sk
);

1108  
NULL
;

1109 
	}
}

1111 
	$sÿm³r_do_¡šg_ş—nup
()

1114 
	}
}

1116 
	$sÿm³r_do_¡šg_š™
()

1118 
¡šg_funcs
.
´obe
 = 
do_¡šg_´obe
;

1119 
¡šg_funcs
.
hªdË_icmp
 = 
NULL
;

1120 
¡šg_funcs
.
hªdË_dl
 = 
do_¡šg_hªdË_dl
;

1121 
¡šg_funcs
.
hªdË_timeout
 = 
do_¡šg_hªdË_timeout
;

1122 
¡šg_funcs
.
wr™e
 = 
do_¡šg_wr™e
;

1123 
¡šg_funcs
.
sk_ä“
 = 
do_¡šg_ä“
;

1124 
¡šg_funcs
.
h®t
 = 
do_¡šg_h®t
;

1127 
	}
}

	@sting/scamper_sting_do.h

31 #iâdeà
__SCAMPER_DO_STING_H


32 
	#__SCAMPER_DO_STING_H


	)

34 *
sÿm³r_do_¡šg_®loc
(*
¡r
);

36 
sÿm³r_sk_t
 *
sÿm³r_do_¡šg_®loùask
(*
d©a
,

37 
sÿm³r_li¡_t
 *
li¡
,

38 
sÿm³r_cyşe_t
 *
cyşe
);

40 
sÿm³r_do_¡šg_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

42 
sÿm³r_do_¡šg_ä“
(*);

44 cÚ¡ *
sÿm³r_do_¡šg_u§ge
();

46 
sÿm³r_do_¡šg_ş—nup
();

47 
sÿm³r_do_¡šg_š™
();

	@sting/scamper_sting_text.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_¡šg.h
"

37 
	~"sÿm³r_fe.h
"

38 
	~"sÿm³r_¡šg_‹xt.h
"

39 
	~"uts.h
"

41 
	$sÿm³r_fe_‹xt_¡šg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

42 cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
)

44 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

45 
buf
[192], 
¤c
[64], 
d¡
[64];

46 
size_t
 
Ën
;

47 
ušt32_t
 
i
, 
txc
 = 0;

49 
	`¢´štf
(
buf
, (buf),

52 
	`sÿm³r_addr_to¡r
(
¡šg
->
¤c
, src, (¤c)), stšg->
¥Üt
,

53 
	`sÿm³r_addr_to¡r
(
¡šg
->
d¡
, d¡, (d¡)), stšg->
dpÜt
,

54 
¡šg
->
couÁ
, stšg->
m—n
, stšg->
d©¯ckc
, stšg->
hŞec
);

56 
Ën
 = 
	`¡¾’
(
buf
);

57 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
);

59 if(
¡šg
->
hŞec
 > 0)

61 
i
=0; i<
¡šg
->
pktc
; i++)

63 if((
¡šg
->
pkts
[
i
]->
æags
 & 
SCAMPER_STING_PKT_FLAG_DATA
) == 0)

65 
txc
++;

67 if(
¡šg
->
pkts
[
i
]->
æags
 & 
SCAMPER_STING_PKT_FLAG_HOLE
)

69 
	`¢´štf
(
buf
, (buf), "…rob%d hŞe\n", 
txc
);

70 
Ën
 = 
	`¡¾’
(
buf
);

71 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
);

77 
	}
}

	@sting/scamper_sting_text.h

23 #iâdeà
__SCAMPER_STING_TEXT_H


24 
	#__SCAMPER_STING_TEXT_H


	)

26 
sÿm³r_fe_‹xt_¡šg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
);

	@sting/scamper_sting_warts.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_icm³xt.h
"

38 
	~"sÿm³r_¡šg.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_fe_w¬ts.h
"

41 
	~"sÿm³r_¡šg_w¬ts.h
"

42 
	~"uts.h
"

44 
	#WARTS_STING_LIST
 1

	)

45 
	#WARTS_STING_CYCLE
 2

	)

46 
	#WARTS_STING_USERID
 3

	)

47 
	#WARTS_STING_SRC
 4

	)

48 
	#WARTS_STING_DST
 5

	)

49 
	#WARTS_STING_SPORT
 6

	)

50 
	#WARTS_STING_DPORT
 7

	)

51 
	#WARTS_STING_COUNT
 8

	)

52 
	#WARTS_STING_MEAN
 9

	)

53 
	#WARTS_STING_INTER
 10

	)

54 
	#WARTS_STING_DIST
 11

	)

55 
	#WARTS_STING_SYNRETX
 12

	)

56 
	#WARTS_STING_DATARETX
 13

	)

57 
	#WARTS_STING_SEQSKIP
 14

	)

58 
	#WARTS_STING_DATALEN
 15

	)

59 
	#WARTS_STING_DATA
 16

	)

60 
	#WARTS_STING_START
 17

	)

61 
	#WARTS_STING_HSRTT
 18

	)

62 
	#WARTS_STING_DATAACKC
 19

	)

63 
	#WARTS_STING_HOLEC
 20

	)

64 
	#WARTS_STING_PKTC
 21

	)

65 
	#WARTS_STING_RESULT
 22

	)

67 cÚ¡ 
w¬ts_v¬_t
 
	g¡šg_v¬s
[] =

69 {
WARTS_STING_LIST
, 4, -1},

70 {
WARTS_STING_CYCLE
, 4, -1},

71 {
WARTS_STING_USERID
, 4, -1},

72 {
WARTS_STING_SRC
, -1, -1},

73 {
WARTS_STING_DST
, -1, -1},

74 {
WARTS_STING_SPORT
, 2, -1},

75 {
WARTS_STING_DPORT
, 2, -1},

76 {
WARTS_STING_COUNT
, 2, -1},

77 {
WARTS_STING_MEAN
, 2, -1},

78 {
WARTS_STING_INTER
, 2, -1},

79 {
WARTS_STING_DIST
, 1, -1},

80 {
WARTS_STING_SYNRETX
, 1, -1},

81 {
WARTS_STING_DATARETX
, 1, -1},

82 {
WARTS_STING_SEQSKIP
, 1, -1},

83 {
WARTS_STING_DATALEN
, 2, -1},

84 {
WARTS_STING_DATA
, -1, -1},

85 {
WARTS_STING_START
, 8, -1},

86 {
WARTS_STING_HSRTT
, 8, -1},

87 {
WARTS_STING_DATAACKC
, 2, -1},

88 {
WARTS_STING_HOLEC
, 2, -1},

89 {
WARTS_STING_PKTC
, 4, -1},

90 {
WARTS_STING_RESULT
, 1, -1},

92 
	#¡šg_v¬s_mfb
 
	`WARTS_VAR_MFB
(
¡šg_v¬s
)

	)

94 
	#WARTS_STING_PKT_FLAGS
 1

	)

95 
	#WARTS_STING_PKT_TIME
 2

	)

96 
	#WARTS_STING_PKT_DATALEN
 3

	)

97 
	#WARTS_STING_PKT_DATA
 4

	)

99 cÚ¡ 
w¬ts_v¬_t
 
	g¡šg_pkt_v¬s
[] =

101 {
WARTS_STING_PKT_FLAGS
, 1, -1},

102 {
WARTS_STING_PKT_TIME
, 8, -1},

103 {
WARTS_STING_PKT_DATALEN
, 2, -1},

104 {
WARTS_STING_PKT_DATA
, -1, -1},

106 
	#¡šg_pkt_v¬s_mfb
 
	`WARTS_VAR_MFB
(
¡šg_pkt_v¬s
)

	)

108 
	sw¬ts_¡šg_pkt


110 
ušt8_t
 
	mæags
[
¡šg_pkt_v¬s_mfb
];

111 
ušt16_t
 
	mæags_Ën
;

112 
ušt16_t
 
	m·¿ms_Ën
;

113 } 
	tw¬ts_¡šg_pkt_t
;

115 
	$w¬ts_¡šg_pkt_·¿ms
(cÚ¡ 
sÿm³r_¡šg_pkt_t
 *
pkt
,

116 
w¬ts_¡šg_pkt_t
 *
¡©e
, 
ušt32_t
 *
Ën
)

118 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

119 
max_id
 = 0;

120 
ušt16_t
 
i
;

122 
	`mem£t
(
¡©e
->
æags
, 0, 
¡šg_pkt_v¬s_mfb
);

123 
¡©e
->
·¿ms_Ën
 = 0;

125 
i
=0; i<(
¡šg_pkt_v¬s
è/ (
w¬ts_v¬_t
); i++)

127 
v¬
 = &
¡šg_pkt_v¬s
[
i
];

129 if(
v¬
->
id
 =ğ
WARTS_STING_PKT_DATA
)

131 if(
pkt
->
Ën
 == 0)

134 
¡©e
->
·¿ms_Ën
 +ğ
pkt
->
Ën
;

135 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

139 
	`as£¹
(
v¬
->
size
 >= 0);

140 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

141 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

144 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

146 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

148 if(
¡©e
->
·¿ms_Ën
 != 0)

149 *
Ën
 += 2;

152 
	}
}

154 
sÿm³r_¡šg_pkt_t
 *
	$w¬ts_¡šg_pkt_»ad
(
w¬ts_¡©e_t
 *
¡©e
,

155 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

156 
ušt32_t
 
Ën
)

158 
sÿm³r_¡šg_pkt_t
 *
pkt
 = 
NULL
;

159 
ušt8_t
 
æags
, *
d©a
 = 
NULL
;

160 
timev®
 
tv
;

161 
ušt16_t
 
¶’
;

162 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

163 {&
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

164 {&
tv
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

165 {&
¶’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

166 {&
d©a
, (
w´_t
)
exŒaù_by‹s_±r
, &
¶’
},

168 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

170 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0 ||

171 (
pkt
 = 
	`sÿm³r_¡šg_pkt_®loc
(
æags
, 
d©a
, 
¶’
, &
tv
)è=ğ
NULL
)

172 
”r
;

174  
pkt
;

176 
”r
:

177 if(
pkt
 !ğ
NULL
è
	`sÿm³r_¡šg_pkt_ä“
(pkt);

178  
NULL
;

179 
	}
}

181 
	$w¬ts_¡šg_pkt_wr™e
(cÚ¡ 
sÿm³r_¡šg_pkt_t
 *
pkt
,

182 cÚ¡ 
sÿm³r_fe_t
 *
sf
, 
ušt8_t
 *
buf
,

183 
ušt32_t
 *
off
, cÚ¡ ušt32_ˆ
Ën
,

184 
w¬ts_¡šg_pkt_t
 *
¡©e
)

186 
ušt16_t
 
dl
 = 
pkt
->
Ën
;

187 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

188 {&
pkt
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

189 {&
pkt
->
tv
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

190 {&
pkt
->
Ën
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

191 {
pkt
->
d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
dl
},

193 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

194 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

195 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

197 
	}
}

199 
	$w¬ts_¡šg_·¿ms
(cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
,

200 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

201 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

203 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

204 
i
, 
max_id
 = 0;

207 
	`mem£t
(
æags
, 0, 
¡šg_v¬s_mfb
);

208 *
·¿ms_Ën
 = 0;

210 
i
=0; i<(
¡šg_v¬s
)/(
w¬ts_v¬_t
); i++)

212 
v¬
 = &
¡šg_v¬s
[
i
];

215 if(
v¬
->
id
 =ğ
WARTS_STING_LIST
 && 
¡šg
->
li¡
 =ğ
NULL
)

217 if(
v¬
->
id
 =ğ
WARTS_STING_CYCLE
 && 
¡šg
->
cyşe
 =ğ
NULL
)

219 if(
v¬
->
id
 =ğ
WARTS_STING_USERID
 && 
¡šg
->
u£rid
 == 0)

221 if(
v¬
->
id
 =ğ
WARTS_STING_SRC
 && 
¡šg
->
¤c
 =ğ
NULL
)

223 if(
v¬
->
id
 =ğ
WARTS_STING_DST
 && 
¡šg
->
d¡
 =ğ
NULL
)

225 if(
v¬
->
id
 =ğ
WARTS_STING_DATA
 && 
¡šg
->
d©®’
 == 0)

227 if(
v¬
->
id
 =ğ
WARTS_STING_RESULT
 && 
¡šg
->
»suÉ
 == 0)

231 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

234 if(
v¬
->
id
 =ğ
WARTS_STING_SRC
)

236 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
¡šg
->
¤c
);

239 if(
v¬
->
id
 =ğ
WARTS_STING_DST
)

241 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
¡šg
->
d¡
);

244 if(
v¬
->
id
 =ğ
WARTS_STING_DATA
)

246 *
·¿ms_Ën
 +ğ
¡šg
->
d©®’
;

251 *
·¿ms_Ën
 +ğ
v¬
->
size
;

254 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

256 
	}
}

258 
	$w¬ts_¡šg_·¿ms_»ad
(
sÿm³r_¡šg_t
 *
¡šg
,

259 
w¬ts_add¹abË_t
 *
bË
,

260 
w¬ts_¡©e_t
 *
¡©e
,

261 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

263 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

264 {&
¡šg
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

265 {&
¡šg
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

266 {&
¡šg
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

267 {&
¡šg
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

268 {&
¡šg
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

269 {&
¡šg
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

270 {&
¡šg
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

271 {&
¡šg
->
couÁ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

272 {&
¡šg
->
m—n
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

273 {&
¡šg
->
š‹r
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

274 {&
¡šg
->
di¡
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

275 {&
¡šg
->
syÄ‘x
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

276 {&
¡šg
->
d©¬‘x
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

277 {&
¡šg
->
£qsk
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

278 {&
¡šg
->
d©®’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

279 {&
¡šg
->
d©a
, (
w´_t
)
exŒaù_by‹s_®loc
, &¡šg->
d©®’
},

280 {&
¡šg
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

281 {&
¡šg
->
h¤‰
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

282 {&
¡šg
->
d©¯ckc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

283 {&
¡šg
->
hŞec
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

284 {&
¡šg
->
pktc
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

285 {&
¡šg
->
»suÉ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

287 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

289  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

290 
	}
}

292 
	$w¬ts_¡šg_·¿ms_wr™e
(cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
,

293 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

294 
w¬ts_add¹abË_t
 *
bË
,

295 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

296 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 *
æags
,

297 cÚ¡ 
ušt16_t
 
æags_Ën
,

298 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

300 
ušt32_t
 
li¡_id
, 
cyşe_id
;

301 
ušt16_t
 
dl
 = 
¡šg
->
d©®’
;

304 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

305 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

306 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

307 {&
¡šg
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

308 {
¡šg
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

309 {
¡šg
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

310 {&
¡šg
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

311 {&
¡šg
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

312 {&
¡šg
->
couÁ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

313 {&
¡šg
->
m—n
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

314 {&
¡šg
->
š‹r
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

315 {&
¡šg
->
di¡
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

316 {&
¡šg
->
syÄ‘x
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

317 {&
¡šg
->
d©¬‘x
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

318 {&
¡šg
->
£qsk
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

319 {&
¡šg
->
d©®’
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

320 {&
¡šg
->
d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
dl
},

321 {&
¡šg
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

322 {&
¡šg
->
h¤‰
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

323 {&
¡šg
->
d©¯ckc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

324 {&
¡šg
->
hŞec
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

325 {&
¡šg
->
pktc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

326 {&
¡šg
->
»suÉ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

328 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

330 if(
	`w¬ts_li¡_g‘id
(
sf
, 
¡šg
->
li¡
, &
li¡_id
) == -1)  -1;

331 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
¡šg
->
cyşe
, &
cyşe_id
) == -1)  -1;

333 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
,

334 
hªdËrs
, 
hªdËr_út
);

337 
	}
}

339 
	$sÿm³r_fe_w¬ts_¡šg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

340 
sÿm³r_¡šg_t
 **
¡šg_out
)

342 
sÿm³r_¡šg_t
 *
¡šg
 = 
NULL
;

343 
w¬ts_add¹abË_t
 
bË
;

344 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

345 
ušt8_t
 *
buf
 = 
NULL
;

346 
ušt32_t
 
off
 = 0;

347 
ušt32_t
 
i
;

349 
	`mem£t
(&
bË
, 0, (table));

352 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

354 
”r
;

357 if(
buf
 =ğ
NULL
)

359 *
¡šg_out
 = 
NULL
;

364 if((
¡šg
 = 
	`sÿm³r_¡šg_®loc
()è=ğ
NULL
)

366 
”r
;

370 if(
	`w¬ts_¡šg_·¿ms_»ad
(
¡šg
, &
bË
, 
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

372 
”r
;

376 if(
¡šg
->
pktc
 > 0)

379 if(
	`sÿm³r_¡šg_pkts_®loc
(
¡šg
, stšg->
pktc
) != 0)

381 
”r
;

388 
i
=0; i<
¡šg
->
pktc
; i++)

390 
¡šg
->
pkts
[
i
] = 
	`w¬ts_¡šg_pkt_»ad
(
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
);

391 if(
¡šg
->
pkts
[
i
] =ğ
NULL
)

393 
”r
;

398 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

399 
	`w¬ts_add¹abË_ş—n
(&
bË
);

400 *
¡šg_out
 = 
¡šg
;

401 
	`ä“
(
buf
);

404 
”r
:

405 
	`w¬ts_add¹abË_ş—n
(&
bË
);

406 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

407 if(
¡šg
 !ğ
NULL
è
	`sÿm³r_¡šg_ä“
(sting);

409 
	}
}

412 
	$sÿm³r_fe_w¬ts_¡šg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

413 cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
)

415 
w¬ts_add¹abË_t
 
bË
;

416 
w¬ts_¡šg_pkt_t
 *
pkts
 = 
NULL
;

417 
ušt8_t
 *
buf
 = 
NULL
;

418 
ušt8_t
 
æags
[
¡šg_v¬s_mfb
];

419 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

420 
ušt32_t
 
Ën
, 
i
, 
off
 = 0;

421 
size_t
 
size
;

423 
	`mem£t
(&
bË
, 0, (table));

426 
	`w¬ts_¡šg_·¿ms
(
¡šg
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

427 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

429 if(
¡šg
->
pktc
 > 0)

432 
size
 = 
¡šg
->
pktc
 * (
w¬ts_¡šg_pkt_t
);

433 if((
pkts
 = (
w¬ts_¡šg_pkt_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

434 
”r
;

436 
i
=0; i<
¡šg
->
pktc
; i++)

437 
	`w¬ts_¡šg_pkt_·¿ms
(
¡šg
->
pkts
[
i
], &pkts[i], &
Ën
);

441 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

442 
”r
;

443 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_STING
);

446 if(
	`w¬ts_¡šg_·¿ms_wr™e
(
¡šg
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

447 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

449 
”r
;

452 if(
¡šg
->
pktc
 > 0)

454 
i
=0; i<
¡šg
->
pktc
; i++)

455 
	`w¬ts_¡šg_pkt_wr™e
(
¡šg
->
pkts
[
i
], 
sf
, 
buf
, &
off
, 
Ën
, &pkts[i]);

456 
	`ä“
(
pkts
);…kt ğ
NULL
;

459 
	`as£¹
(
off
 =ğ
Ën
);

462 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

463 
”r
;

465 
	`w¬ts_add¹abË_ş—n
(&
bË
);

466 
	`ä“
(
buf
);

469 
”r
:

470 
	`w¬ts_add¹abË_ş—n
(&
bË
);

471 if(
pkts
 !ğ
NULL
è
	`ä“
(pkts);

472 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

474 
	}
}

	@sting/scamper_sting_warts.h

23 #iâdeà
__SCAMPER_STING_WARTS_H


24 
	#__SCAMPER_STING_WARTS_H


	)

26 
sÿm³r_fe_w¬ts_¡šg_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_¡šg_t
 *
¡šg
);

29 
sÿm³r_fe_w¬ts_¡šg_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

30 
sÿm³r_¡šg_t
 **
¡šg_out
);

	@tbit/scamper_tbit.c

35 #iâdeà
lšt


36 cÚ¡ 
	grcsid
[] =

40 #ifdeà
HAVE_CONFIG_H


41 
	~"cÚfig.h
"

43 
	~"š‹º®.h
"

45 
	~"sÿm³r_addr.h
"

46 
	~"sÿm³r_li¡.h
"

47 
	~"sÿm³r_tb™.h
"

48 
	~"uts.h
"

50 
	stqe


52 
	moff
;

53 
sÿm³r_tb™_tıqe_t
 *
	mqe
;

54 } 
	ttqe_t
;

56 
	ssÿm³r_tb™_tıq


58 
ušt32_t
 
	m£q
;

59 
tqe_t
 **
	mtqes
;

60 
	mtqec
;

63 
	$tqe_cmp
(cÚ¡ 
tqe_t
 *
a
, cÚ¡qe_ˆ*
b
)

65 if(
a
->
off
 < 
b
->off)  -1;

66 if(
a
->
off
 > 
b
->off)  1;

67 if(
a
->
qe
->
Ën
 < 
b
->qe->len)  -1;

68 if(
a
->
qe
->
Ën
 > 
b
->qe->len)  1;

70 
	}
}

72 
	$sÿm³r_tb™_tıqe_ä“
(
sÿm³r_tb™_tıqe_t
 *
qe
, (*
ff
)(*))

74 if(
qe
 =ğ
NULL
) ;

75 if(
ff
 !ğ
NULL
 && 
qe
->
d©a
 != NULL)

76 
	`ff
(
qe
->
d©a
);

77 
	`ä“
(
qe
);

79 
	}
}

81 
sÿm³r_tb™_tıq_t
 *
	$sÿm³r_tb™_tıq_®loc
(
ušt32_t
 
i¢
)

83 
sÿm³r_tb™_tıq_t
 *
q
;

84 if((
q
 = 
	`m®loc_z”o
((
sÿm³r_tb™_tıq_t
))è=ğ
NULL
)

85 
”r
;

86 
q
->
£q
 = 
i¢
;

87  
q
;

88 
”r
:

89 
	`sÿm³r_tb™_tıq_ä“
(
q
, 
NULL
);

90  
NULL
;

91 
	}
}

93 
	$sÿm³r_tb™_tıq_ä“
(
sÿm³r_tb™_tıq_t
 *
q
, (*
ff
)(*))

95 
tqe_t
 *
tqe
;

96 
i
;

98 if(
q
 =ğ
NULL
)

101 if(
q
->
tqes
 !ğ
NULL
)

103 
i
=0; i<
q
->
tqec
; i++)

105 
tqe
 = 
q
->
tqes
[
i
];

106 
	`sÿm³r_tb™_tıqe_ä“
(
tqe
->
qe
, 
ff
);

107 
	`ä“
(
tqe
);

109 
	`ä“
(
q
->
tqes
);

112 
	`ä“
(
q
);

114 
	}
}

116 
	$sÿm³r_tb™_tıq_£g
(
sÿm³r_tb™_tıq_t
 *
q
, 
ušt32_t
 *
£q
, 
ušt16_t
 *
Ën
)

118 
tqe_t
 *
tqe
;

119 
	`as£¹
(
q
->
tqec
 >= 0);

120 if(
q
->
tqec
 == 0)

122 
tqe
 = 
q
->
tqes
[0];

123 
	`as£¹
(
q
->
£q
 + 
tqe
->
off
 =ğtqe->
qe
->seq);

124 *
£q
 = 
tqe
->
qe
->seq;

125 *
Ën
 = 
tqe
->
qe
->len;

127 
	}
}

129 
sÿm³r_tb™_tıqe_t
 *
	$sÿm³r_tb™_tıq_pİ
(
sÿm³r_tb™_tıq_t
 *
q
)

131 
sÿm³r_tb™_tıqe_t
 *
qe
;

132 
ušt16_t
 
Ën
;

133 
tqe_t
 *
tqe
;

134 
i
, 
off
;

136 if(
q
->
tqec
 == 0)

137  
NULL
;

139 
tqe
 = 
q
->
tqes
[0];

140 
qe
 = 
tqe
->qe;

141 
	`ä“
(
tqe
);

143 if(--
q
->
tqec
 > 0)

144 
	`memmove
(
q
->
tqes
, q->tqes+1, (
tqe_t
 *è* q->
tqec
);

146 
off
 = 
	`sÿm³r_tb™_d©a_£qoff
(
q
->
£q
, 
qe
->seq);

147 if(
off
 < 0 && ofà+ 
qe
->
Ën
 <= 0)

148  
qe
;

150 
Ën
 = 
qe
->ËÀ+ 
off
;

151 
i
=0; i<
q
->
tqec
; i++)

152 
q
->
tqes
[
i
]->
off
 -ğ
Ën
;

153 
q
->
£q
 +ğ
Ën
;

155  
qe
;

156 
	}
}

158 
	$sÿm³r_tb™_tıq_add
(
sÿm³r_tb™_tıq_t
 *
q
, 
ušt32_t
 
£q
,

159 
ušt8_t
 
æags
, 
ušt16_t
 
Ën
, ušt8_ˆ*
d©a
)

161 
tqe_t
 *
tqe
;

163 
	`as£¹
(
	`sÿm³r_tb™_d©a_š¿nge
(
q
->
£q
, seq, 
Ën
) != 0);

164 if((
tqe
 = 
	`m®loc_z”o
((
tqe_t
))è=ğ
NULL
)

165 
”r
;

166 if((
tqe
->
qe
 = 
	`m®loc_z”o
((
sÿm³r_tb™_tıqe_t
))è=ğ
NULL
)

167 
”r
;

168 
tqe
->
off
 = 
	`sÿm³r_tb™_d©a_£qoff
(
q
->
£q
, seq);

169 
tqe
->
qe
->
£q
 = seq;

170 
tqe
->
qe
->
æags
 = flags;

171 
tqe
->
qe
->
Ën
 =†en;

172 
tqe
->
qe
->
d©a
 = data;

173 if(
	`¬¿y_š£¹
((***)&
q
->
tqes
,&q->
tqec
,
tqe
,(
¬¿y_cmp_t
)
tqe_cmp
) != 0)

174 
”r
;

177 
”r
:

178 if(
tqe
 !ğ
NULL
)

180 
	`sÿm³r_tb™_tıqe_ä“
(
tqe
->
qe
, 
NULL
);

181 
	`ä“
(
tqe
);

184 
	}
}

186 
	$sÿm³r_tb™_d©a_£qoff
(
ušt32_t
 
rcv_nxt
, ušt32_ˆ
£q
)

188 if(
£q
 >ğ
rcv_nxt
)

189  
£q
 - 
rcv_nxt
;

190  
TCP_MAX_SEQNUM
 - 
rcv_nxt
 + 
£q
 + 1;

191 
	}
}

193 
	$sÿm³r_tb™_tıq_§ck
(
sÿm³r_tb™_tıq_t
 *
q
, 
ušt32_t
 *
§ck
, 
couÁ
)

195 
ušt32_t
 
Ëá
, 
right
;

196 
sÿm³r_tb™_tıqe_t
 *
qe
;

197 
i
, 
off
, 
c
 = 0;

199 
	`as£¹
(
q
->
tqec
 >= 0);

200 if(
q
->
tqec
 == 0)

203 
qe
 = 
q
->
tqes
[0]->qe;

204 if(
qe
->
Ën
 == 0)

207 
Ëá
 = 
qe
->
£q
;

208 
right
 = 
qe
->
£q
 + qe->
Ën
;

209 
	`as£¹
(
	`sÿm³r_tb™_d©a_£qoff
(
q
->
£q
, 
Ëá
) > 0);

211 
i
=1; i<
q
->
tqec
 && 
c
 < 
couÁ
; i++)

213 
qe
 = 
q
->
tqes
[
i
]->qe;

214 if(
qe
->
Ën
 == 0)

216 if((
off
 = 
	`sÿm³r_tb™_d©a_£qoff
(
right
, 
qe
->
£q
)) <= 0)

218 
off
 = 
	`abs
(off);

219 if(
qe
->
Ën
 > 
off
)

220 
right
 =„ighˆ+ 
qe
->
Ën
 - 
off
;

224 
§ck
[
c
*2] = 
Ëá
;

225 
§ck
[(
c
*2)+1] = 
right
;

226 
c
++;

228 
Ëá
 = 
qe
->
£q
;

229 
right
 = 
qe
->
£q
 + qe->
Ën
;

232 if(
c
 < 
couÁ
)

234 
§ck
[
c
*2] = 
Ëá
;

235 
§ck
[(
c
*2)+1] = 
right
;

236 
c
++;

239  
c
;

240 
	}
}

248 
	$sÿm³r_tb™_d©a_š¿nge
(
ušt32_t
 
rcv_nxt
, ušt32_ˆ
£q
, 
ušt16_t
 
Ën
)

250 if((
	`SEQ_LEQ
(
rcv_nxt
, 
£q
è&& 
	`SEQ_LT
(seq,„cv_nxt + 65535)) ||

251 (
	`SEQ_LEQ
(
rcv_nxt
, 
£q
+
Ën
-1è&& 
	`SEQ_LT
(seq+len-1,„cv_nxt + 65535)))

254 
	}
}

256 
	$sÿm³r_tb™_pkt_Ën
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
)

258 
ušt8_t
 
v
 = 
pkt
->
d©a
[0] >> 4;

259 
rc
 = -1;

261 if(
v
 == 4)

262 
rc
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

263 if(
v
 == 6)

264 
rc
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4) + 40;

266  
rc
;

267 
	}
}

269 
	$sÿm³r_tb™_pkt_h
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
,

270 
ušt8_t
 *
´Ùo
, ušt8_ˆ*
hËn
, 
ušt16_t
 *
Ën
)

272 
ušt8_t
 
v
 = 
pkt
->
d©a
[0] >> 4;

274 if(
v
 == 4)

276 *
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

277 *
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

278 *
´Ùo
 = 
pkt
->
d©a
[9];

282 if(
v
 == 6)

284 *
hËn
 = 40;

285 *
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4) + 40;

286 *
´Ùo
 = 
pkt
->
d©a
[6];

289 *
´Ùo
)

291 
IPPROTO_HOPOPTS
:

292 
IPPROTO_DSTOPTS
:

293 
IPPROTO_ROUTING
:

294 *
´Ùo
 = 
pkt
->
d©a
[*
hËn
];

295 *
hËn
 +ğ(
pkt
->
d©a
[(*iphlen)+1] * 8) + 8;

297 
IPPROTO_FRAGMENT
:

298 *
´Ùo
 = 
pkt
->
d©a
[*
hËn
];

299 if((
	`by‹s_Áohs
(
pkt
->
d©a
+(*
hËn
)+2) & 0xfff8) != 0)

301 if((
pkt
->
d©a
[(*
hËn
)+3] & 0x1) != 0)

303 *
hËn
 += 8;

312 
	}
}

314 
	$sÿm³r_tb™_pkt_tıd©aby‹s
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
, 
ušt16_t
 *
bc
)

316 
ušt8_t
 
hËn
, 
tıhËn
, 
´Ùo
;

317 
ušt16_t
 
Ën
;

319 if(
	`sÿm³r_tb™_pkt_h
(
pkt
, &
´Ùo
, &
hËn
, &
Ën
) != 0)

321 if(
´Ùo
 !ğ
IPPROTO_TCP
)

323 
tıhËn
 = ((
pkt
->
d©a
[
hËn
+12] & 0xf0) >> 4) * 4;

324 *
bc
 = 
Ën
 - 
hËn
 - 
tıhËn
;

326 
	}
}

328 
	$sÿm³r_tb™_pkt_tıack
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
, 
ušt32_t
 *
ack
)

330 
ušt8_t
 
hËn
, 
´Ùo
;

331 
ušt16_t
 
Ën
;

332 if(
	`sÿm³r_tb™_pkt_h
(
pkt
, &
´Ùo
, &
hËn
, &
Ën
) != 0)

334 if(
´Ùo
 !ğ
IPPROTO_TCP
 || (
pkt
->
d©a
[
hËn
+13] & 
TH_ACK
) == 0)

336 *
ack
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+8);

338 
	}
}

340 
	$sÿm³r_tb™_¡©s
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, 
sÿm³r_tb™_¡©s_t
 *
¡©s
)

342 cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
, *
syn
;

343 
sÿm³r_tb™_tıq_t
 *
q
 = 
NULL
;

344 
sÿm³r_tb™_tıqe_t
 *
qe
;

345 
ušt32_t
 
rcv_nxt
, 
£q
;

346 
ušt16_t
 
Ën
, 
d©®’
, 
Ën
;

347 
ušt8_t
 
´Ùo
, 
hËn
, 
tıhËn
, 
æags
;

348 
ušt32_t
 
i
;

349 
off
, 
£’fš
 = 0;

351 
	`mem£t
(
¡©s
, 0, (
sÿm³r_tb™_¡©s_t
));

352 if(
tb™
->
pktc
 < 1)

356 
syn
 = 
tb™
->
pkts
[0];

357 
i
=1; i<
tb™
->
pktc
; i++)

359 
pkt
 = 
tb™
->
pkts
[
i
];

360 if(
pkt
->
dœ
 =ğ
SCAMPER_TBIT_PKT_DIR_RX
)

363 if(
i
 =ğ
tb™
->
pktc
)

366 if(
	`sÿm³r_tb™_pkt_h
(
pkt
, &
´Ùo
, &
hËn
, &
Ën
) != 0)

367 
”r
;

368 if(
´Ùo
 !ğ
IPPROTO_TCP
)

369 
”r
;

370 if((
pkt
->
d©a
[
hËn
+13] & (
TH_SYN
|
TH_ACK
)) != (TH_SYN|TH_ACK))

371 
”r
;

373 
	`timev®_diff_tv
(&
¡©s
->
syÇck_¹t
, &
syn
->
tv
, &
pkt
->tv);

374 
rcv_nxt
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+4) + 1;

376 if((
q
 = 
	`sÿm³r_tb™_tıq_®loc
(
rcv_nxt
)è=ğ
NULL
)

377 
”r
;

379 
i
++; i<
tb™
->
pktc
; i++)

381 
pkt
 = 
tb™
->
pkts
[
i
];

382 if(
pkt
->
dœ
 !ğ
SCAMPER_TBIT_PKT_DIR_RX
)

384 if(
	`sÿm³r_tb™_pkt_h
(
pkt
, &
´Ùo
, &
hËn
, &
Ën
) != 0)

385 
”r
;

386 if(
´Ùo
 !ğ
IPPROTO_TCP
)

387 
”r
;

388 
£q
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+4);

389 
tıhËn
 = ((
pkt
->
d©a
[
hËn
+12] & 0xf0) >> 4) * 4;

390 
æags
 = 
pkt
->
d©a
[
hËn
+13];

391 if((
d©®’
 = 
Ën
 - 
hËn
 - 
tıhËn
è=ğ0 && (
æags
 & 
TH_FIN
) == 0)

394 
¡©s
->
rx_tÙ®size
 +ğ(
Ën
 - 
hËn
 - 
tıhËn
);

397 if(
	`sÿm³r_tb™_d©a_š¿nge
(
rcv_nxt
, 
£q
, 
d©®’
) == 0)

400 if(
	`sÿm³r_tb™_tıq_add
(
q
, 
£q
, 
æags
, 
d©®’
, 
NULL
) != 0)

401 
”r
;

403 
	`sÿm³r_tb™_tıq_£g
(
q
, &
£q
, &
d©®’
) == 0)

405 if(
	`sÿm³r_tb™_d©a_š¿nge
(
rcv_nxt
, 
£q
, 
d©®’
) == 0)

407 
	`sÿm³r_tb™_tıqe_ä“
(
	`sÿm³r_tb™_tıq_pİ
(
q
), 
NULL
);

412 if((
off
 = 
	`sÿm³r_tb™_d©a_£qoff
(
rcv_nxt
, 
£q
)) > 0)

415 
qe
 = 
	`sÿm³r_tb™_tıq_pİ
(
q
);

416 
æags
 = 
qe
->flags;

417 
	`sÿm³r_tb™_tıqe_ä“
(
qe
, 
NULL
);

418 
Ën
 = 
d©®’
 + 
off
;

419 
rcv_nxt
 +ğ
Ën
;

420 
¡©s
->
rx_xãrsize
 +ğ
Ën
;

422 if((
æags
 & 
TH_FIN
) != 0)

424 
	`timev®_diff_tv
(&
¡©s
->
xã¹ime
, &
syn
->
tv
, &
pkt
->tv);

425 
£’fš
 = 1;

430 if(
£’fš
 == 0)

431 
”r
;

433 
	`sÿm³r_tb™_tıq_ä“
(
q
, 
NULL
);

436 
”r
:

437 
	`sÿm³r_tb™_tıq_ä“
(
q
, 
NULL
);

439 
	}
}

441 *
	$sÿm³r_tb™_ty³2¡r
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, *
buf
, 
size_t
 
Ën
)

443 *
t
[] = {

444 
NULL
,

451 if(
tb™
->
ty³
 > (
t
è/ (*è||[tb™->ty³] =ğ
NULL
)

453 
	`¢´štf
(
buf
, 
Ën
, "%d", 
tb™
->
ty³
);

454  
buf
;

457  
t
[
tb™
->
ty³
];

458 
	}
}

460 *
	$sÿm³r_tb™_»s2¡r
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, *
buf
, 
size_t
 
Ën
)

462 *
t
[] = {

474 
NULL
,

475 
NULL
,

476 
NULL
,

477 
NULL
,

478 
NULL
,

479 
NULL
,

480 
NULL
,

481 
NULL
,

482 
NULL
,

490 
NULL
,

491 
NULL
,

492 
NULL
,

499 
NULL
,

500 
NULL
,

501 
NULL
,

502 
NULL
,

505 
NULL
,

506 
NULL
,

507 
NULL
,

508 
NULL
,

509 
NULL
,

510 
NULL
,

511 
NULL
,

512 
NULL
,

520 if(
tb™
->
»suÉ
 > (
t
è/ (*è||[tb™->»suÉ] =ğ
NULL
)

522 
	`¢´štf
(
buf
, 
Ën
, "%d", 
tb™
->
»suÉ
);

523  
buf
;

526  
t
[
tb™
->
»suÉ
];

527 
	}
}

529 
sÿm³r_tb™_pkt_t
 *
	$sÿm³r_tb™_pkt_®loc
(
ušt8_t
 
dœ
, ušt8_ˆ*
d©a
,

530 
ušt16_t
 
Ën
, 
timev®
 *
tv
)

532 
sÿm³r_tb™_pkt_t
 *
pkt
;

534 if((
pkt
 = 
	`m®loc_z”o
((
sÿm³r_tb™_pkt_t
))è=ğ
NULL
)

535 
”r
;

537 
pkt
->
dœ
 = dir;

538 if(
Ën
 !ğ0 && 
d©a
 !ğ
NULL
)

540 if((
pkt
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

541 
”r
;

542 
pkt
->
Ën
 =†en;

544 if(
tv
 !ğ
NULL
è
	`timev®_ıy
(&
pkt
->tv,v);

545  
pkt
;

547 
”r
:

548 
	`ä“
(
pkt
);

549  
NULL
;

550 
	}
}

552 
	$sÿm³r_tb™_pkt_ä“
(
sÿm³r_tb™_pkt_t
 *
pkt
)

554 if(
pkt
 =ğ
NULL
)

556 if(
pkt
->
d©a
 !ğ
NULL
è
	`ä“
(pkt->data);

557 
	`ä“
(
pkt
);

559 
	}
}

561 
	$sÿm³r_tb™_pkts_®loc
(
sÿm³r_tb™_t
 *
tb™
, 
ušt32_t
 
couÁ
)

563 
size_t
 
size
 = 
couÁ
 * (
sÿm³r_tb™_pkt_t
 *);

564 if((
tb™
->
pkts
 = (
sÿm³r_tb™_pkt_t
 **)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

567 
	}
}

569 
	$sÿm³r_tb™_»cÜd_pkt
(
sÿm³r_tb™_t
 *
tb™
, 
sÿm³r_tb™_pkt_t
 *
pkt
)

571 
size_t
 
Ën
 = (
tb™
->
pktc
 + 1è* (
sÿm³r_tb™_pkt_t
 *);

574 if(
	`»®loc_w¿p
((**)&
tb™
->
pkts
, 
Ën
) != 0)

577 
tb™
->
pkts
[tb™->
pktc
++] = 
pkt
;

579 
	}
}

581 
sÿm³r_tb™_­p_h‰p_t
 *
	$sÿm³r_tb™_­p_h‰p_®loc
(*
ho¡
, *
fe
)

583 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
;

585 if((
h‰p
 = 
	`m®loc_z”o
((
sÿm³r_tb™_­p_h‰p_t
))è=ğ
NULL
 ||

586 (
ho¡
 !ğ
NULL
 && (
h‰p
->ho¡ = 
	`¡rdup
(host)) == NULL) ||

587 (
fe
 !ğ
NULL
 && (
h‰p
->fğ
	`¡rdup
(file)) == NULL))

589 if(
h‰p
 =ğ
NULL
)  NULL;

590 if(
h‰p
->
ho¡
 !ğ
NULL
è
	`ä“
(http->host);

591 if(
h‰p
->
fe
 !ğ
NULL
è
	`ä“
(http->file);

592  
NULL
;

595  
h‰p
;

596 
	}
}

598 
	$sÿm³r_tb™_­p_h‰p_ä“
(
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
)

600 if(
h‰p
 =ğ
NULL
)

602 if(
h‰p
->
ho¡
 !ğ
NULL
è
	`ä“
(http->host);

603 if(
h‰p
->
fe
 !ğ
NULL
è
	`ä“
(http->file);

604 
	`ä“
(
h‰p
);

606 
	}
}

608 
sÿm³r_tb™_pmtud_t
 *
	$sÿm³r_tb™_pmtud_®loc
()

610  
	`m®loc_z”o
((
sÿm³r_tb™_pmtud_t
));

611 
	}
}

613 
	$sÿm³r_tb™_pmtud_ä“
(
sÿm³r_tb™_pmtud_t
 *
pmtud
)

615 if(
pmtud
 =ğ
NULL
)

617 if(
pmtud
->
±b¤c
 !ğ
NULL
)

618 
	`sÿm³r_addr_ä“
(
pmtud
->
±b¤c
);

619 
	`ä“
(
pmtud
);

621 
	}
}

623 
sÿm³r_tb™_nuÎ_t
 *
	$sÿm³r_tb™_nuÎ_®loc
()

625  
	`m®loc_z”o
((
sÿm³r_tb™_nuÎ_t
));

626 
	}
}

628 
	$sÿm³r_tb™_nuÎ_ä“
(
sÿm³r_tb™_nuÎ_t
 *
nuÎ
)

630 if(
nuÎ
 =ğ
NULL
)

632 
	`ä“
(
nuÎ
);

634 
	}
}

637 
	$sÿm³r_tb™_ä“
(
sÿm³r_tb™_t
 *
tb™
)

639 
ušt32_t
 
i
;

641 if(
tb™
 =ğ
NULL
)

644 if(
tb™
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(tbit->src);

645 if(
tb™
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(tbit->dst);

646 if(
tb™
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(tbit->list);

647 if(
tb™
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(tbit->cycle);

650 if(
tb™
->
pkts
 !ğ
NULL
)

652 
i
=0; i<
tb™
->
pktc
; i++)

653 
	`sÿm³r_tb™_pkt_ä“
(
tb™
->
pkts
[
i
]);

654 
	`ä“
(
tb™
->
pkts
);

658 if(
tb™
->
­p_d©a
 !ğ
NULL
)

660 if(
tb™
->
­p_´Ùo
 =ğ
SCAMPER_TBIT_APP_HTTP
)

661 
	`sÿm³r_tb™_­p_h‰p_ä“
(
tb™
->
­p_d©a
);

665 if(
tb™
->
d©a
 !ğ
NULL
)

667 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_PMTUD
)

668 
	`sÿm³r_tb™_pmtud_ä“
(
tb™
->
d©a
);

669 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_NULL
)

670 
	`sÿm³r_tb™_nuÎ_ä“
(
tb™
->
d©a
);

673 
	`ä“
(
tb™
);

675 
	}
}

677 
sÿm³r_tb™_t
 *
	$sÿm³r_tb™_®loc
()

679  (
sÿm³r_tb™_t
 *)
	`m®loc_z”o
((scamper_tbit_t));

680 
	}
}

	@tbit/scamper_tbit.h

34 #iâdeà
__SCAMPER_TBIT_H


35 
	#__SCAMPER_TBIT_H


	)

38 
	#SCAMPER_TBIT_TYPE_PMTUD
 1

	)

39 
	#SCAMPER_TBIT_TYPE_ECN
 2

	)

40 
	#SCAMPER_TBIT_TYPE_NULL
 3

	)

41 
	#SCAMPER_TBIT_TYPE_SACK_RCVR
 4

	)

44 
	#SCAMPER_TBIT_APP_HTTP
 1

	)

45 
	#SCAMPER_TBIT_APP_SMTP
 2

	)

46 
	#SCAMPER_TBIT_APP_DNS
 3

	)

47 
	#SCAMPER_TBIT_APP_FTP
 4

	)

50 
	#SCAMPER_TBIT_RESULT_NONE
 0

	)

51 
	#SCAMPER_TBIT_RESULT_TCP_NOCONN
 1

	)

52 
	#SCAMPER_TBIT_RESULT_TCP_RST
 2

	)

53 
	#SCAMPER_TBIT_RESULT_TCP_ERROR
 3

	)

54 
	#SCAMPER_TBIT_RESULT_ERROR
 4

	)

55 
	#SCAMPER_TBIT_RESULT_ABORTED
 5

	)

56 
	#SCAMPER_TBIT_RESULT_TCP_NOCONN_RST
 6

	)

57 
	#SCAMPER_TBIT_RESULT_HALTED
 7

	)

58 
	#SCAMPER_TBIT_RESULT_TCP_BADOPT
 8

	)

59 
	#SCAMPER_TBIT_RESULT_TCP_FIN
 9

	)

60 
	#SCAMPER_TBIT_RESULT_TCP_ZEROWIN
 10

	)

63 
	#SCAMPER_TBIT_RESULT_PMTUD_NOACK
 20

	)

64 
	#SCAMPER_TBIT_RESULT_PMTUD_NODATA
 21

	)

65 
	#SCAMPER_TBIT_RESULT_PMTUD_TOOSMALL
 22

	)

66 
	#SCAMPER_TBIT_RESULT_PMTUD_NODF
 23

	)

67 
	#SCAMPER_TBIT_RESULT_PMTUD_FAIL
 24

	)

68 
	#SCAMPER_TBIT_RESULT_PMTUD_SUCCESS
 25

	)

69 
	#SCAMPER_TBIT_RESULT_PMTUD_CLEARDF
 26

	)

72 
	#SCAMPER_TBIT_RESULT_ECN_SUCCESS
 30

	)

73 
	#SCAMPER_TBIT_RESULT_ECN_INCAPABLE
 31

	)

74 
	#SCAMPER_TBIT_RESULT_ECN_BADSYNACK
 32

	)

75 
	#SCAMPER_TBIT_RESULT_ECN_NOECE
 33

	)

76 
	#SCAMPER_TBIT_RESULT_ECN_NOACK
 34

	)

77 
	#SCAMPER_TBIT_RESULT_ECN_NODATA
 35

	)

80 
	#SCAMPER_TBIT_RESULT_NULL_SUCCESS
 40

	)

81 
	#SCAMPER_TBIT_RESULT_NULL_NODATA
 41

	)

84 
	#SCAMPER_TBIT_RESULT_SACK_INCAPABLE
 50

	)

85 
	#SCAMPER_TBIT_RESULT_SACK_RCVR_SUCCESS
 51

	)

86 
	#SCAMPER_TBIT_RESULT_SACK_RCVR_SHIFTED
 52

	)

87 
	#SCAMPER_TBIT_RESULT_SACK_RCVR_TIMEOUT
 53

	)

88 
	#SCAMPER_TBIT_RESULT_SACK_RCVR_NOSACK
 54

	)

91 
	#SCAMPER_TBIT_PKT_DIR_TX
 1

	)

92 
	#SCAMPER_TBIT_PKT_DIR_RX
 2

	)

95 
	#SCAMPER_TBIT_PMTUD_OPTION_BLACKHOLE
 0x1

	)

98 
	#SCAMPER_TBIT_NULL_OPTION_TCPTS
 0x01

	)

99 
	#SCAMPER_TBIT_NULL_OPTION_IPTS_SYN
 0x02

	)

100 
	#SCAMPER_TBIT_NULL_OPTION_IPRR_SYN
 0x04

	)

101 
	#SCAMPER_TBIT_NULL_OPTION_IPQS_SYN
 0x08

	)

102 
	#SCAMPER_TBIT_NULL_OPTION_SACK
 0x10

	)

105 
	#SCAMPER_TBIT_NULL_RESULT_TCPTS
 0x01

	)

106 
	#SCAMPER_TBIT_NULL_RESULT_SACK
 0x02

	)

108 
	ssÿm³r_tb™_pkt


110 
timev®
 
	mtv
;

111 
ušt8_t
 
	mdœ
;

112 
ušt16_t
 
	mËn
;

113 
ušt8_t
 *
	md©a
;

114 } 
	tsÿm³r_tb™_pkt_t
;

116 
	ssÿm³r_tb™_­p_h‰p


118 *
	mho¡
;

119 *
	mfe
;

120 } 
	tsÿm³r_tb™_­p_h‰p_t
;

122 
	ssÿm³r_tb™_pmtud


124 
ušt16_t
 
	mmtu
;

125 
ušt8_t
 
	m±b_»tx
;

126 
ušt8_t
 
	mİtiÚs
;

127 
sÿm³r_addr_t
 *
	m±b¤c
;

128 } 
	tsÿm³r_tb™_pmtud_t
;

130 
	ssÿm³r_tb™_nuÎ


132 
ušt16_t
 
	mİtiÚs
;

133 
ušt16_t
 
	m»suÉs
;

134 } 
	tsÿm³r_tb™_nuÎ_t
;

141 
	ssÿm³r_tb™


143 
sÿm³r_li¡_t
 *
	mli¡
;

144 
sÿm³r_cyşe_t
 *
	mcyşe
;

145 
ušt32_t
 
	mu£rid
;

147 
sÿm³r_addr_t
 *
	m¤c
;

148 
sÿm³r_addr_t
 *
	md¡
;

149 
ušt16_t
 
	m¥Üt
;

150 
ušt16_t
 
	mdpÜt
;

151 
timev®
 
	m¡¬t
;

154 
ušt16_t
 
	m»suÉ
;

157 
ušt8_t
 
	mty³
;

158 *
	md©a
;

161 
ušt8_t
 
	m­p_´Ùo
;

162 *
	m­p_d©a
;

165 
ušt16_t
 
	mş›Á_mss
;

166 
ušt16_t
 
	m£rv”_mss
;

169 
ušt8_t
 
	msyn_»tx
;

170 
ušt8_t
 
	md©_»tx
;

173 
sÿm³r_tb™_pkt_t
 **
	mpkts
;

174 
ušt32_t
 
	mpktc
;

175 } 
	tsÿm³r_tb™_t
;

177 
sÿm³r_tb™_t
 *
sÿm³r_tb™_®loc
();

178 
sÿm³r_tb™_ä“
(
sÿm³r_tb™_t
 *
tb™
);

180 *
sÿm³r_tb™_»s2¡r
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, *
buf
, 
size_t
 
Ën
);

181 *
sÿm³r_tb™_ty³2¡r
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, *
buf
, 
size_t
 
Ën
);

183 
sÿm³r_tb™_pkt_t
 *
sÿm³r_tb™_pkt_®loc
(
ušt8_t
 
dœ
, ušt8_ˆ*
d©a
,

184 
ušt16_t
 
Ën
, 
timev®
 *
tv
);

185 
sÿm³r_tb™_pkt_ä“
(
sÿm³r_tb™_pkt_t
 *
pkt
);

186 
sÿm³r_tb™_pkt_tıd©aby‹s
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
, 
ušt16_t
 *
bc
);

187 
sÿm³r_tb™_pkt_tıack
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
, 
ušt32_t
 *
ack
);

189 
sÿm³r_tb™_pmtud_t
 *
sÿm³r_tb™_pmtud_®loc
();

190 
sÿm³r_tb™_pmtud_ä“
(
sÿm³r_tb™_pmtud_t
 *
pmtud
);

192 
sÿm³r_tb™_nuÎ_t
 *
sÿm³r_tb™_nuÎ_®loc
();

193 
sÿm³r_tb™_nuÎ_ä“
(
sÿm³r_tb™_nuÎ_t
 *
nuÎ
);

195 
sÿm³r_tb™_­p_h‰p_t
 *
sÿm³r_tb™_­p_h‰p_®loc
(*
ho¡
, *
fe
);

196 
sÿm³r_tb™_­p_h‰p_ho¡
(
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
, cÚ¡ *
h
);

197 
sÿm³r_tb™_­p_h‰p_fe
(
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
, cÚ¡ *
f
);

198 
sÿm³r_tb™_­p_h‰p_ä“
(
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
);

200 
sÿm³r_tb™_pkts_®loc
(
sÿm³r_tb™_t
 *
tb™
, 
ušt32_t
 
couÁ
);

201 
sÿm³r_tb™_»cÜd_pkt
(
sÿm³r_tb™_t
 *
tb™
, 
sÿm³r_tb™_pkt_t
 *
pkt
);

240 
sÿm³r_tb™_tıq
 
	tsÿm³r_tb™_tıq_t
;

241 
	ssÿm³r_tb™_tıqe


243 
ušt32_t
 
	m£q
;

244 
ušt16_t
 
	mËn
;

245 
ušt8_t
 
	mæags
;

246 
ušt8_t
 *
	md©a
;

247 } 
	tsÿm³r_tb™_tıqe_t
;

248 
sÿm³r_tb™_tıq_t
 *
sÿm³r_tb™_tıq_®loc
(
ušt32_t
 
i¢
);

249 
sÿm³r_tb™_tıq_ä“
(
sÿm³r_tb™_tıq_t
 *
q
, (*
ff
)(*));

250 
	`sÿm³r_tb™_tıq_add
(
sÿm³r_tb™_tıq_t
 *
q
, 
ušt32_t
 
£q
,

251 
ušt8_t
 
æags
, 
ušt16_t
 
Ën
, ušt8_ˆ*
d©a
);

252 
	`sÿm³r_tb™_tıq_£g
(
sÿm³r_tb™_tıq_t
 *
q
,
ušt32_t
 *
£q
,
ušt16_t
 *
Ën
);

253 
sÿm³r_tb™_tıqe_t
 *
	`sÿm³r_tb™_tıq_pİ
(
sÿm³r_tb™_tıq_t
 *
q
);

254 
	`sÿm³r_tb™_tıq_§ck
(
sÿm³r_tb™_tıq_t
 *
q
, 
ušt32_t
 *
blocks
, 
c
);

255 
	`sÿm³r_tb™_tıqe_ä“
(
sÿm³r_tb™_tıqe_t
 *
qe
, (*
ff
)(*));

269 
	`sÿm³r_tb™_d©a_š¿nge
(
ušt32_t
 
rcv_nxt
, ušt32_ˆ
£q
, 
ušt16_t
 
Ën
);

270 
	`sÿm³r_tb™_d©a_£qoff
(
ušt32_t
 
rcv_nxt
, ušt32_ˆ
£q
);

277 
	ssÿm³r_tb™_¡©s


279 
timev®
 
syÇck_¹t
;

280 
ušt32_t
 
rx_xãrsize
;

281 
ušt32_t
 
rx_tÙ®size
;

282 
timev®
 
xã¹ime
;

283 } 
	tsÿm³r_tb™_¡©s_t
;

285 
	`sÿm³r_tb™_¡©s
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,
sÿm³r_tb™_¡©s_t
 *
¡©s
);

	@tbit/scamper_tbit_do.c

36 #iâdeà
lšt


37 cÚ¡ 
	grcsid
[] =

41 #ifdeà
HAVE_CONFIG_H


42 
	~"cÚfig.h
"

44 
	~"š‹º®.h
"

46 
	~"sÿm³r.h
"

47 
	~"sÿm³r_addr.h
"

48 
	~"sÿm³r_li¡.h
"

49 
	~"sÿm³r_sk.h
"

50 
	~"sÿm³r_dl.h
"

51 
	~"sÿm³r_fds.h
"

52 
	~"sÿm³r_dlhdr.h
"

53 
	~"sÿm³r_fœew®l.h
"

54 
	~"sÿm³r_¹sock.h
"

55 
	~"sÿm³r_if.h
"

56 
	~"sÿm³r_´obe.h
"

57 
	~"sÿm³r_g‘¤c.h
"

58 
	~"sÿm³r_tı4.h
"

59 
	~"sÿm³r_tı6.h
"

60 
	~"sÿm³r_queue.h
"

61 
	~"sÿm³r_fe.h
"

62 
	~"sÿm³r_İtiÚs.h
"

63 
	~"sÿm³r_debug.h
"

64 
	~"uts.h
"

65 
	~"mjl_li¡.h
"

66 
	~"sÿm³r_tb™.h
"

67 
	~"sÿm³r_tb™_do.h
"

70 
	#TBIT_RETX_DEFAULT
 3

	)

71 
	#TBIT_TIMEOUT_DEFAULT
 10000

	)

72 
	#TBIT_TIMEOUT_LONG
 70000

	)

74 
	stb™_İtiÚs


76 
ušt8_t
 
	m­p
;

77 
ušt8_t
 
	mty³
;

78 
ušt8_t
 
	msyn_»tx
;

79 
ušt8_t
 
	md©_»tx
;

80 
ušt8_t
 
	m±b_»tx
;

81 
ušt8_t
 
	mİtiÚs
;

82 
ušt16_t
 
	mmss
;

83 
ušt16_t
 
	mmtu
;

84 
ušt16_t
 
	m¥Üt
;

85 
ušt16_t
 
	mdpÜt
;

86 *
	mu¾
;

87 *
	m±b¤c
;

88 *
	m¤c
;

89 } 
	ttb™_İtiÚs_t
;

91 
	stb™_£gm’t


93 
ušt8_t
 *
	md©a
;

94 
ušt16_t
 
	mËn
;

95 } 
	ttb™_£gm’t_t
;

97 
	stb™_äag


99 
ušt16_t
 
	moff
;

100 
ušt8_t
 *
	md©a
;

101 
ušt16_t
 
	md©®’
;

102 } 
	ttb™_äag_t
;

104 
	stb™_äags


106 
timev®
 
	mtv
;

107 
ušt32_t
 
	mid
;

108 
tb™_äag_t
 **
	mäags
;

109 
	mäagc
;

110 
ušt8_t
 
	mgÙÏ¡
;

111 } 
	ttb™_äags_t
;

113 
	stb™_´obe


115 
ušt8_t
 
	mty³
;

116 
	mwa™
;

119 
	s_tı


121 
ušt16_t
 
	mËn
;

122 
ušt8_t
 
	mæags
;

123 
ušt8_t
 
	m§ckb
;

124 
ušt32_t
 
	m£q
;

125 
ušt32_t
 
	mack
;

126 
ušt32_t
 
	m§ck
[8];

127 } 
	mtı
;

128 } 
	mun
;

129 } 
	ttb™_´obe_t
;

131 
	#_Ën
 
un
.
tı
.
Ën


	)

132 
	#_æags
 
un
.
tı
.
æags


	)

133 
	#_§ckb
 
un
.
tı
.
§ckb


	)

134 
	#_£q
 
un
.
tı
.
£q


	)

135 
	#_ack
 
un
.
tı
.
ack


	)

136 
	#_§ck
 
un
.
tı
.
§ck


	)

138 
	stb™_¡©e


140 #iâdeà
_WIN32


141 
sÿm³r_fd_t
 *
	m¹sock
;

143 
sÿm³r_fd_t
 *
	mdl
;

144 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

145 
sÿm³r_rou‹_t
 *
	mrou‹
;

146 
sÿm³r_fœew®l_’Œy_t
 *
	mfw
;

147 
ušt8_t
 
	mmode
;

148 
ušt8_t
 
	m©‹m±
;

149 
ušt16_t
 
	mæags
;

150 
timev®
 
	mtimeout
;

151 
ušt16_t
 
	mid
;

153 
¦i¡_t
 *
	mtx
;

154 
¦i¡_t
 *
	m£gm’ts
;

155 
sÿm³r_tb™_tıq_t
 *
	mrxq
;

156 
ušt32_t
 
	m¢d_nxt
;

157 
ušt32_t
 
	mrcv_nxt
;

159 
tb™_äags_t
 **
	mäags
;

160 
	mäagc
;

162 
ušt32_t
 
	mts_»ûÁ
;

163 
ušt32_t
 
	mts_Ï¡ack
;

164 
ušt32_t
 
	mqs_nÚû
;

165 
ušt8_t
 
	mqs_‰l
;

169 
	stb™_pmtud


171 
ušt8_t
 *
	m±b_d©a
;

172 
ušt16_t
 
	m±b_d©®’
;

173 
ušt16_t
 
	m±b_c
;

174 } 
	mpmtud
;

176 
	stb™_§ckr


178 
ušt8_t
 
	mrx
[7];

179 
ušt8_t
 
	mx
;

180 
ušt8_t
 
	mæags
;

181 
ušt8_t
 
	mtimeout
;

182 } 
	m§ckr
;

184 
	stb™_eú


186 
ušt8_t
 
	mæags
;

187 } 
	meú
;

188 } 
	mun
;

189 } 
	ttb™_¡©e_t
;

191 
	#pmtud_±b_d©a
 
un
.
pmtud
.
±b_d©a


	)

192 
	#pmtud_±b_d©®’
 
un
.
pmtud
.
±b_d©®’


	)

193 
	#pmtud_±b_c
 
un
.
pmtud
.
±b_c


	)

194 
	#§ckr_rx
 
un
.
§ckr
.
rx


	)

195 
	#§ckr_x
 
un
.
§ckr
.
x


	)

196 
	#§ckr_æags
 
un
.
§ckr
.
æags


	)

197 
	#§ckr_timeout
 
un
.
§ckr
.
timeout


	)

198 
	#eú_æags
 
un
.
eú
.
æags


	)

201 
sÿm³r_sk_funcs_t
 
	gtb™_funcs
;

204 
sÿm³r_addrÿche_t
 *
addrÿche
;

206 
	#TBIT_STATE_FLAG_FIN_SEEN
 0x0001

	)

207 
	#TBIT_STATE_FLAG_FIN_ACKED
 0x0002

	)

208 
	#TBIT_STATE_FLAG_SEEN_DATA
 0x0004

	)

209 
	#TBIT_STATE_FLAG_SEEN_220
 0x0008

	)

210 
	#TBIT_STATE_FLAG_NODF
 0x0010

	)

211 
	#TBIT_STATE_FLAG_RST_SEEN
 0x0020

	)

212 
	#TBIT_STATE_FLAG_NOMOREDATA
 0x0040

	)

213 
	#TBIT_STATE_FLAG_NORESET
 0x1000

	)

214 
	#TBIT_STATE_FLAG_TCPTS
 0x2000

	)

215 
	#TBIT_STATE_FLAG_SACK
 0x4000

	)

218 
	#TBIT_STATE_ECN_FLAG_ECT
 0x01

	)

219 
	#TBIT_STATE_ECN_FLAG_CE_SET
 0x02

	)

220 
	#TBIT_STATE_ECN_FLAG_CE_SENT
 0x04

	)

221 
	#TBIT_STATE_ECN_FLAG_CWR_SET
 0x08

	)

222 
	#TBIT_STATE_ECN_FLAG_CWR_SENT
 0x10

	)

223 
	#TBIT_STATE_ECN_FLAG_ECE_SEEN
 0x20

	)

226 
	#TBIT_STATE_SACKR_FLAG_INCAPABLE
 0x01

	)

227 
	#TBIT_STATE_SACKR_FLAG_SHIFTED
 0x02

	)

228 
	#TBIT_STATE_SACKR_FLAG_BADOPT
 0x04

	)

231 
	#TBIT_OPT_DPORT
 1

	)

232 
	#TBIT_OPT_MSS
 2

	)

233 
	#TBIT_OPT_MTU
 3

	)

234 
	#TBIT_OPT_OPTION
 4

	)

235 
	#TBIT_OPT_APP
 5

	)

236 
	#TBIT_OPT_PTBSRC
 6

	)

237 
	#TBIT_OPT_SPORT
 7

	)

238 
	#TBIT_OPT_TYPE
 8

	)

239 
	#TBIT_OPT_URL
 9

	)

240 
	#TBIT_OPT_USERID
 10

	)

241 
	#TBIT_OPT_SRCADDR
 11

	)

244 
	#TBIT_OPT_OPTION_BLACKHOLE
 0x01

	)

245 
	#TBIT_OPT_OPTION_TCPTS
 0x02

	)

246 
	#TBIT_OPT_OPTION_IPTS_SYN
 0x04

	)

247 
	#TBIT_OPT_OPTION_IPRR_SYN
 0x08

	)

248 
	#TBIT_OPT_OPTION_IPQS_SYN
 0x10

	)

249 
	#TBIT_OPT_OPTION_SACK
 0x20

	)

252 
	#TBIT_OPT_OPTION_IPOPT_SYN_MASK
 \

253 (
TBIT_OPT_OPTION_IPTS_SYN
 | 
TBIT_OPT_OPTION_IPRR_SYN
 | \

254 
TBIT_OPT_OPTION_IPQS_SYN
)

	)

257 
	#TBIT_PROBE_TYPE_TCP
 1

	)

258 
	#TBIT_PROBE_TYPE_PTB
 2

	)

260 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

261 {'d', 
NULL
, 
TBIT_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

262 {'m', 
NULL
, 
TBIT_OPT_MSS
, 
SCAMPER_OPTION_TYPE_NUM
},

263 {'M', 
NULL
, 
TBIT_OPT_MTU
, 
SCAMPER_OPTION_TYPE_NUM
},

264 {'O', 
NULL
, 
TBIT_OPT_OPTION
, 
SCAMPER_OPTION_TYPE_STR
},

265 {'p', 
NULL
, 
TBIT_OPT_APP
, 
SCAMPER_OPTION_TYPE_STR
},

266 {'P', 
NULL
, 
TBIT_OPT_PTBSRC
, 
SCAMPER_OPTION_TYPE_STR
},

267 {'s', 
NULL
, 
TBIT_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

268 {'S', 
NULL
, 
TBIT_OPT_SRCADDR
, 
SCAMPER_OPTION_TYPE_STR
},

269 {'t', 
NULL
, 
TBIT_OPT_TYPE
, 
SCAMPER_OPTION_TYPE_STR
},

270 {'u', 
NULL
, 
TBIT_OPT_URL
, 
SCAMPER_OPTION_TYPE_STR
},

271 {'U', 
NULL
, 
TBIT_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

273 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

275 cÚ¡ 
ušt8_t
 
	gMODE_RTSOCK
 = 1;

276 cÚ¡ 
ušt8_t
 
	gMODE_DLHDR
 = 2;

277 cÚ¡ 
ušt8_t
 
	gMODE_FIREWALL
 = 3;

278 cÚ¡ 
ušt8_t
 
	gMODE_DONE
 = 4;

279 cÚ¡ 
ušt8_t
 
	gMODE_SYN
 = 5;

280 cÚ¡ 
ušt8_t
 
	gMODE_FIN
 = 6;

281 cÚ¡ 
ušt8_t
 
	gMODE_DATA
 = 7;

282 cÚ¡ 
ušt8_t
 
	gMODE_PMTUD
 = 8;

283 cÚ¡ 
ušt8_t
 
	gMODE_BLACKHOLE
 = 9;

284 cÚ¡ 
ušt8_t
 
	gMODE_ZEROWIN
 = 10;

287 cÚ¡ *
	$sÿm³r_do_tb™_u§ge
()

291 
	}
}

293 
sÿm³r_tb™_t
 *
	$tb™_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

295  
	`sÿm³r_sk_g‘d©a
(
sk
);

296 
	}
}

298 
tb™_¡©e_t
 *
	$tb™_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

300  
	`sÿm³r_sk_g‘¡©e
(
sk
);

301 
	}
}

303 
	$tb™_queue
(
sÿm³r_sk_t
 *
sk
)

305 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

307 if(
	`¦i¡_couÁ
(
¡©e
->
tx
) > 0)

308 
	`sÿm³r_sk_queue_´obe
(
sk
);

309 if(
¡©e
->
mode
 =ğ
MODE_DONE
)

310 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

312 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
¡©e
->
timeout
);

315 
	}
}

322 
	$tb™_»suÉ
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
»suÉ
)

324 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

325 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

326 
buf
[16], 
addr
[64];

327 
d
 = 0;

329 
»suÉ
)

331 
SCAMPER_TBIT_RESULT_NONE
:

332 
SCAMPER_TBIT_RESULT_TCP_NOCONN
:

333 
SCAMPER_TBIT_RESULT_TCP_NOCONN_RST
:

334 
SCAMPER_TBIT_RESULT_TCP_ERROR
:

335 
SCAMPER_TBIT_RESULT_TCP_RST
:

336 
SCAMPER_TBIT_RESULT_TCP_BADOPT
:

337 
SCAMPER_TBIT_RESULT_TCP_FIN
:

338 
SCAMPER_TBIT_RESULT_TCP_ZEROWIN
:

339 
SCAMPER_TBIT_RESULT_ERROR
:

340 
SCAMPER_TBIT_RESULT_ABORTED
:

341 
SCAMPER_TBIT_RESULT_HALTED
:

342 
SCAMPER_TBIT_RESULT_PMTUD_NOACK
:

343 
SCAMPER_TBIT_RESULT_PMTUD_FAIL
:

344 
SCAMPER_TBIT_RESULT_SACK_INCAPABLE
:

345 
SCAMPER_TBIT_RESULT_SACK_RCVR_SUCCESS
:

346 
SCAMPER_TBIT_RESULT_SACK_RCVR_SHIFTED
:

347 
SCAMPER_TBIT_RESULT_SACK_RCVR_TIMEOUT
:

348 
SCAMPER_TBIT_RESULT_SACK_RCVR_NOSACK
:

349 
d
 = 1;

353 if(
tb™
->
»suÉ
 =ğ
SCAMPER_TBIT_RESULT_NONE
)

355 
tb™
->
»suÉ
 =„esult;

356 
	`sÿm³r_addr_to¡r
(
tb™
->
d¡
, 
addr
, (addr));

357 
	`sÿm³r_debug
(
__func__
, "% %s", 
addr
,

358 
	`sÿm³r_tb™_»s2¡r
(
tb™
, 
buf
, (buf)));

361 if(
d
 == 0)

364 if(
¡©e
->
mode
 !ğ
MODE_SYN
)

366 
¡©e
->
mode
 = 
MODE_FIN
;

367 
	`sÿm³r_sk_queue_´obe
(
sk
);

372 
¡©e
->
mode
 = 
MODE_DONE
;

373 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

377 
	}
}

379 
	$tb™_şassify
(
sÿm³r_sk_t
 *
sk
)

381 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

382 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

383 
sÿm³r_tb™_pmtud_t
 *
pmtud
;

384 
v6
 = 
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
tb™
->
d¡
) ? 1 : 0;

385 
bh
 = 0;

387 if(
tb™
->
»suÉ
 !ğ
SCAMPER_TBIT_RESULT_NONE
)

389 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_RST_SEEN
)

391 
¡©e
->
mode
 = 
MODE_DONE
;

392 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

397 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_PMTUD
)

399 
pmtud
 = 
tb™
->
d©a
;

400 if(
pmtud
->
İtiÚs
 & 
SCAMPER_TBIT_PMTUD_OPTION_BLACKHOLE
)

401 
bh
 = 1;

407 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_RST_SEEN
)

409 if(
¡©e
->
pmtud_±b_c
 >= 2)

410 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_FAIL
);

412 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_RST
);

414 if(
¡©e
->
mode
 =ğ
MODE_ZEROWIN
)

415 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_ZEROWIN
);

417 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_SEEN_DATA
) == 0)

418 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_NODATA
);

420 if(
¡©e
->
pmtud_±b_c
 =ğ0 && 
v6
 && 
bh
 =ğ0 && 
pmtud
->
mtu
 < 1280)

421 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_NONE
);

423 if(
¡©e
->
pmtud_±b_c
 > 0)

424 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_FAIL
);

426 if(
v6
 =ğ0 && 
¡©e
->
æags
 & 
TBIT_STATE_FLAG_NODF
)

427 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_NODF
);

429 if(
¡©e
->
mode
 =ğ
MODE_BLACKHOLE
)

430 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_FAIL
);

433 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_TOOSMALL
);

435 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_ECN
)

437 if(
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_ECE_SEEN
)

438 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ECN_SUCCESS
);

439 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_RST_SEEN
)

440 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_RST
);

441 if(
¡©e
->
mode
 =ğ
MODE_ZEROWIN
)

442 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_ZEROWIN
);

443 if(
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CE_SENT
)

444 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ECN_NOECE
);

445 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_SEEN_DATA
) == 0)

446 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ECN_NODATA
);

449 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_NULL
)

451 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_RST_SEEN
)

452 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_RST
);

453 if(
¡©e
->
mode
 =ğ
MODE_ZEROWIN
)

454 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_ZEROWIN
);

455 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_SEEN_DATA
) == 0)

456 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_NULL_NODATA
);

458 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_NULL_SUCCESS
);

460 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

462 if(
¡©e
->
§ckr_æags
 & 
TBIT_STATE_SACKR_FLAG_INCAPABLE
)

463 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_SACK_INCAPABLE
);

464 if(
¡©e
->
§ckr_æags
 & 
TBIT_STATE_SACKR_FLAG_SHIFTED
)

465 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_SACK_RCVR_SHIFTED
);

466 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_RST_SEEN
)

467 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_RST
);

468 if(
¡©e
->
mode
 =ğ
MODE_ZEROWIN
)

469 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_ZEROWIN
);

470 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_SEEN
)

471 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_FIN
);

472 if(
¡©e
->
§ckr_rx
[0] > 3)

473 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_SACK_RCVR_NOSACK
);

474 if(
¡©e
->
§ckr_æags
 & 
TBIT_STATE_SACKR_FLAG_BADOPT
)

475 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_BADOPT
);

476 if(
¡©e
->
§ckr_timeout
 > 2)

477 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_SACK_RCVR_TIMEOUT
);

479 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_SACK_RCVR_SUCCESS
);

483 
	}
}

490 
	$tb™_tışo£d
(
tb™_¡©e_t
 *
¡©e
)

492 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_SEEN
) != 0 &&

493 (
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_ACKED
) != 0)

496 
	}
}

498 
	$tb™_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

500 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

501 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

502 
tb™
->
»suÉ
 = 
SCAMPER_TBIT_RESULT_ERROR
;

503 if(
¡©e
 !ğ
NULL
è¡©e->
mode
 = 
MODE_DONE
;

504 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

506 
	}
}

508 
	$tb™_äags_ä“
(
tb™_äags_t
 *
äags
)

510 
i
;

512 if(
äags
 =ğ
NULL
)

515 if(
äags
->äag !ğ
NULL
)

517 
i
=0; i<
äags
->
äagc
; i++)

519 
	`ä“
(
äags
->äags[
i
]->
d©a
);

520 
	`ä“
(
äags
->äags[
i
]);

522 
	`ä“
(
äags
->frags);

524 
	`ä“
(
äags
);

526 
	}
}

528 
	$tb™_äags_cmp
(cÚ¡ 
tb™_äags_t
 *
a
, cÚ¡b™_äags_ˆ*
b
)

530 if(
a
->
id
 < 
b
->id)  -1;

531 if(
a
->
id
 > 
b
->id)  1;

533 
	}
}

535 
	$tb™_äag_cmp
(cÚ¡ 
tb™_äag_t
 *
a
, cÚ¡b™_äag_ˆ*
b
)

537 if(
a
->
off
 < 
b
->off)  -1;

538 if(
a
->
off
 > 
b
->off)  1;

540 
	}
}

542 
	$tb™_»as£mbË
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 **
out
,

543 
sÿm³r_dl_»c_t
 *
dl
)

545 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

546 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

547 
sÿm³r_tb™_pmtud_t
 *
pmtud
;

548 
sÿm³r_dl_»c_t
 *
Ãwp
 = 
NULL
;

549 
tb™_äags_t
 
fmfs
, *
äags
;

550 
tb™_äag_t
 
fmf
, *
äag
, *
Ãxt
;

551 
ušt8_t
 *
d©a
 = 
NULL
;

552 
size_t
 
off
;

553 
ušt16_t
 
mtu
;

554 
i
, 
rc
, 
pos
, 
v4
 = 0, 
v6
 = 0;

557 if(
dl
->
dl__d©®’
 =ğ0 || dl->
dl__´Ùo
 !ğ
IPPROTO_TCP
)

559 
	`sÿm³r_debug
(
__func__
, "ignoring fragment %d %d",

560 
dl
->
dl__d©®’
, dl->
dl__´Ùo
);

564 if(
dl
->
dl_af
 =ğ
AF_INET
)

565 
v4
 = 1;

567 
v6
 = 1;

570 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_PMTUD
)

572 
pmtud
 = 
tb™
->
d©a
;

574 if(
v4
 || 
pmtud
->
mtu
 > 1280)

575 
mtu
 = 
pmtud
->mtu;

577 
mtu
 = 1280;

584 if((
v6
 || 
	`SCAMPER_DL_IS_IP_DF
(
dl
)è&& dl->
dl__size
 > 
mtu
)

586 if(
dl
->
dl__off
 == 0)

587 *
out
 = 
dl
;

593 if(
v4
)

594 
fmfs
.
id
 = 
dl
->
dl__id
;

596 
fmfs
.
id
 = 
dl
->
dl_6_id
;

597 
pos
 = 
	`¬¿y_fšdpos
((**)
¡©e
->
äags
, s‹->
äagc
, &
fmfs
,

598 (
¬¿y_cmp_t
)
tb™_äags_cmp
);

599 if(
pos
 >= 0)

601 
äags
 = 
¡©e
->äags[
pos
];

605 if((
äags
 = 
	`m®loc_z”o
((
tb™_äags_t
))è=ğ
NULL
)

607 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc frags");

608 
”r
;

610 
äags
->
id
 = 
fmfs
.id;

611 
rc
=
	`¬¿y_š£¹
((***)&
¡©e
->
äags
, &¡©e->
äagc
, frags,

612 (
¬¿y_cmp_t
)
tb™_äags_cmp
);

613 if(
rc
 != 0)

615 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert frags");

616 
”r
;

618 
pos
 = 
	`¬¿y_fšdpos
((**)
¡©e
->
äags
, s‹->
äagc
, frags,

619 (
¬¿y_cmp_t
)
tb™_äags_cmp
);

620 
	`as£¹
(
pos
 != -1);

624 
fmf
.
off
 = 
dl
->
dl__off
;

625 
äag
 = 
	`¬¿y_fšd
((**)
äags
->äags, f¿gs->
äagc
, &
fmf
,

626 (
¬¿y_cmp_t
)
tb™_äag_cmp
);

627 if(
äag
 =ğ
NULL
)

629 if((
äag
 = 
	`m®loc_z”o
((
tb™_äags_t
))è=ğ
NULL
)

631 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc frag");

632 
”r
;

634 
äag
->
off
 = 
fmf
.off;

636 if((
äag
->
d©a
 = 
	`memdup
(
dl
->
dl__d©a
, dl->
dl__d©®’
)è=ğ
NULL
)

638 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot dup %d",

639 
dl
->
dl__d©®’
);

640 
”r
;

642 
äag
->
d©®’
 = 
dl
->
dl__d©®’
;

644 if(
	`¬¿y_š£¹
((***)&
äags
->äags, &äags->
äagc
, 
äag
,

645 (
¬¿y_cmp_t
)
tb™_äag_cmp
) != 0)

647 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd frag");

648 
”r
;

651 if(
	`SCAMPER_DL_IS_IP_MF
(
dl
) == 0)

652 
äags
->
gÙÏ¡
 = 1;

656 if(
äags
->
gÙÏ¡
 =ğ0 || f¿gs->
äagc
 < 2)

661 
i
=0; i<
äags
->
äagc
-1; i++)

663 
äag
 = 
äags
->äags[
i
];

664 
Ãxt
 = 
äags
->äags[
i
+1];

666 if(
äag
->
off
 + f¿g->
d©®’
 !ğ
Ãxt
->off)

672 
äag
 = 
äags
->äags[äags->
äagc
-1];

673 if((
d©a
 = 
	`m®loc
(
äag
->
off
 + f¿g->
d©®’
)è=ğ
NULL
)

675 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc data");

676 
”r
;

678 
i
=0, 
off
=0; i<
äags
->
äagc
; i++)

680 
äag
 = 
äags
->äags[
i
];

681 
	`memıy
(
d©a
+
off
, 
äag
->d©a, f¿g->
d©®’
);

682 
off
 +ğ
äag
->
d©®’
;

684 
	`¬¿y_»move
((**)
¡©e
->
äags
, &¡©e->
äagc
, 
pos
);

685 
	`tb™_äags_ä“
(
äags
);

687 if((
Ãwp
 = 
	`m®loc_z”o
((
sÿm³r_dl_»c_t
))è=ğ
NULL
)

689 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc‚ewp");

690 
”r
;

693 
	`timev®_ıy
(&
Ãwp
->
dl_tv
, &
dl
->dl_tv);

694 
Ãwp
->
dl_ty³
 = 
SCAMPER_DL_TYPE_RAW
;

695 
Ãwp
->
dl_Ãt_ty³
 = 
SCAMPER_DL_REC_NET_TYPE_IP
;

696 
Ãwp
->
dl_ifšdex
 = 
dl
->dl_ifindex;

697 
Ãwp
->
dl_af
 = 
dl
->dl_af;

698 
Ãwp
->
dl__hl
 = 
dl
->dl_ip_hl;

699 
Ãwp
->
dl__´Ùo
 = 
dl
->dl_ip_proto;

700 
Ãwp
->
dl__size
 = 
dl
->
dl__hl
 + 
off
;

701 
Ãwp
->
dl__id
 = 
dl
->dl_ip_id;

702 
Ãwp
->
dl_6_id
 = 
dl
->dl_ip6_id;

703 
Ãwp
->
dl__tos
 = 
dl
->dl_ip_tos;

704 
Ãwp
->
dl__‰l
 = 
dl
->dl_ip_ttl;

705 
Ãwp
->
dl__¤c
 = 
dl
->dl_ip_src;

706 
Ãwp
->
dl__d¡
 = 
dl
->dl_ip_dst;

707 
Ãwp
->
dl__æow
 = 
dl
->dl_ip_flow;

708 
Ãwp
->
dl__d©a
 = 
d©a
;

709 
Ãwp
->
dl__d©®’
 = 
off
;

710 
Ãwp
->
dl__æags
 = 
SCAMPER_DL_IP_FLAG_REASS
;

712 if((
tıhdr
è> 
Ãwp
->
dl__d©®’
)

714 
	`ä“
(
Ãwp
);

715 
	`ä“
(
d©a
);

719 
Ãwp
->
dl_tı_¥Üt
 = 
	`by‹s_Áohs
(
d©a
+0);

720 
Ãwp
->
dl_tı_dpÜt
 = 
	`by‹s_Áohs
(
d©a
+2);

721 
Ãwp
->
dl_tı_£q
 = 
	`by‹s_Áohl
(
d©a
+4);

722 
Ãwp
->
dl_tı_ack
 = 
	`by‹s_Áohl
(
d©a
+8);

723 
Ãwp
->
dl_tı_hl
 = (
d©a
[12] >> 4) * 4;

724 
Ãwp
->
dl_tı_æags
 = 
d©a
[13];

725 
Ãwp
->
dl_tı_wš
 = 
	`by‹s_Áohs
(
d©a
+14);

726 
Ãwp
->
dl_tı_d©®’
 =‚ewp->
dl__d©®’
 -‚ewp->
dl_tı_hl
;

727 if(
Ãwp
->
dl_tı_d©®’
 > 0)

728 
Ãwp
->
dl_tı_d©a
 = 
d©a
 +‚ewp->
dl_tı_hl
;

730 *
out
 = 
Ãwp
;

733 
”r
:

734 if(
Ãwp
 !ğ
NULL
è
	`ä“
(newp);

735 if(
d©a
 !ğ
NULL
è
	`ä“
(data);

737 
	}
}

739 
	$_ä“
(
tb™_´obe_t
 *

)

741 if(

 =ğ
NULL
)

743 
	`ä“
(

);

745 
	}
}

747 
tb™_´obe_t
 *
	$_®loc
(
tb™_¡©e_t
 *
¡©e
, 
ušt8_t
 
ty³
)

749 
tb™_´obe_t
 *

;

750 if((

 = 
	`m®loc_z”o
((
tb™_´obe_t
))è=ğ
NULL
)

752 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot mallocp");

753  
NULL
;

755 if(
	`¦i¡__push
(
¡©e
->
tx
, 

è=ğ
NULL
)

757 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot queuep");

758 
	`ä“
(

);

759  
NULL
;

761 

->
ty³
 =ype;

762  

;

763 
	}
}

765 
tb™_´obe_t
 *
	$_tı
(
tb™_¡©e_t
 *
¡©e
, 
ušt16_t
 
Ën
)

767 
tb™_´obe_t
 *

;

769 if((

 = 
	`_®loc
(
¡©e
, 
TBIT_PROBE_TYPE_TCP
)è=ğ
NULL
)

770  
NULL
;

772 

->
_æags
 = 
TH_ACK
;

773 

->
_£q
 = 
¡©e
->
¢d_nxt
;

774 

->
_ack
 = 
¡©e
->
rcv_nxt
;

775 

->
_Ën
 = 
Ën
;

777  

;

778 
	}
}

780 
tb™_´obe_t
 *
	$_±b
(
tb™_¡©e_t
 *
¡©e
)

782  
	`_®loc
(
¡©e
, 
TBIT_PROBE_TYPE_PTB
);

783 
	}
}

785 
	$tb™_£gm’t_ä“
(
tb™_£gm’t_t
 *
£g
)

787 if(
£g
 =ğ
NULL
)

789 if(
£g
->
d©a
 !ğ
NULL
)

790 
	`ä“
(
£g
->
d©a
);

791 
	`ä“
(
£g
);

793 
	}
}

795 
	$tb™_£gm’t
(
tb™_¡©e_t
 *
¡©e
, cÚ¡ 
ušt8_t
 *
d©a
, 
ušt16_t
 
Ën
)

797 
tb™_£gm’t_t
 *
£g
 = 
NULL
;

799 if((
£g
 = 
	`m®loc_z”o
((
tb™_£gm’t_t
))è=ğ
NULL
)

801 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc seg");

802 
”r
;

804 if((
£g
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

806 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc seg->data");

807 
”r
;

809 
£g
->
Ën
 =†en;

810 if(
	`¦i¡__push
(
¡©e
->
£gm’ts
, 
£g
è=ğ
NULL
)

812 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd seg");

813 
”r
;

818 
”r
:

819 
	`tb™_£gm’t_ä“
(
£g
);

821 
	}
}

823 
	$tb™_d©a_š¿nge
(
tb™_¡©e_t
 *
¡©e
, 
ušt32_t
 
£q
, ušt32_ˆ
Ën
)

825 if(
	`sÿm³r_tb™_d©a_š¿nge
(
¡©e
->
rcv_nxt
, 
£q
, 
Ën
) != 0)

827 
	`sÿm³r_debug
(
__func__
, "out of sequence");

829 
	}
}

831 
	$tb™_rxq
(
tb™_¡©e_t
 *
¡©e
, cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
)

833 *
d©a
 = 
NULL
;

835 
	`as£¹
(
dl
->
dl__´Ùo
 =ğ
IPPROTO_TCP
);

836 
	`as£¹
(
dl
->
dl_tı_d©®’
 > 0 || (dl->
dl_tı_æags
 & 
TH_FIN
) != 0);

838 if(
¡©e
->
rxq
 =ğ
NULL
 &&

839 (
¡©e
->
rxq
 = 
	`sÿm³r_tb™_tıq_®loc
(¡©e->
rcv_nxt
)è=ğ
NULL
)

841 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloccpq");

842 
”r
;

845 if(
dl
->
dl_tı_d©®’
 > 0 &&

846 (
d©a
 = 
	`memdup
(
dl
->
dl_tı_d©a
, dl->
dl_tı_d©®’
)è=ğ
NULL
)

848 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

849 "could‚Ù du°%d by‹s", 
dl
->
dl_tı_d©®’
);

850 
”r
;

853 if(
	`sÿm³r_tb™_tıq_add
(
¡©e
->
rxq
, 
dl
->
dl_tı_£q
, dl->
dl_tı_æags
,

854 
dl
->
dl_tı_d©®’
, 
d©a
) != 0)

856 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd %u/%2x/%u",

857 
dl
->
dl_tı_£q
, dl->
dl_tı_æags
, dl->
dl_tı_d©®’
);

858 
”r
;

863 
”r
:

864 if(
d©a
 !ğ
NULL
è
	`ä“
(data);

866 
	}
}

868 
	$tb™_­p_h‰p_rx
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 *
d©a
, 
ušt16_t
 
dËn
)

870 cÚ¡ *
h‰p_ua
 =

873 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

874 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
 = 
tb™
->
­p_d©a
;

875 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

876 
buf
[512];

877 
size_t
 
off
;

879 if(
¡©e
->
mode
 =ğ
MODE_SYN
)

881 
off
 = 0;

882 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "GET % HTTP/1.0\r\n", 
h‰p
->
fe
);

883 if(
h‰p
->
ho¡
 !ğ
NULL
)

884 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "Ho¡: %s\r\n", 
h‰p
->
ho¡
);

885 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

888 "U£r-Ag’t: %s\r\n\r\n", 
h‰p_ua
);

890 if(
	`tb™_£gm’t
(
¡©e
, (cÚ¡ 
ušt8_t
 *)
buf
, 
off
) != 0)

892 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_NOMOREDATA
;

893  ()
off
;

897 
	}
}

906 
	$tb™_­p_sm_rx
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 *
d©a
, 
ušt16_t
 
dËn
)

908 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

909 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

910 
sÿm³r_tb™_pmtud_t
 *
pmtud
;

911 
buf
[8192], 
ho¡Çme
[256], *
d©a_ıy
 = 
NULL
;

912 
size_t
 
off
 = 0, 
tmp
 = 0, 
Çm–’
;

913 
i
;

915 if(
¡©e
->
mode
 !ğ
MODE_DATA
 || s‹->
æags
 & 
TBIT_STATE_FLAG_SEEN_220
)

919 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_PMTUD
)

921 
pmtud
 = 
tb™
->
d©a
;

922 
tmp
 = (
pmtud
->
mtu
 >= 1280) ?…mtud->mtu : 1280;

926 if(
dËn
 >ğ3 && 
	`¡ºcmp
((*)
d©a
, "220", 3) == 0)

928 if((
d©a_ıy
 = 
	`m®loc
(
dËn
 + 1)è=ğ
NULL
)

929 
qu™
;

930 
	`memıy
(
d©a_ıy
, 
d©a
, 
dËn
);

931 
d©a_ıy
[
dËn
] = '\0';

932 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_SEEN_220
;

934 if(
	`¡ršg_fšdlc
(
d©a_ıy
, "£ndma"è!ğ
NULL
)

936 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "HELP\r\nHELP EHLO\r\n");

938 if(
	`¡ršg_fšdlc
(
d©a_ıy
, "po¡fix"è!ğ
NULL
)

941 if(
	`g‘ho¡Çme
(
ho¡Çme
, (hostname)) != 0 ||

942 (
Çm–’
 = 
	`¡¾’
(
ho¡Çme
)) == 0)

943 
qu™
;

944 
i
=0; i<20; i++)

945 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "EHLO %s\r\n", 
ho¡Çme
);

947 if(
	`¡ršg_fšdlc
(
d©a_ıy
, "exim"è!ğ
NULL
)

950 if(
	`g‘ho¡Çme
(
ho¡Çme
, (hostname)) != 0 ||

951 (
Çm–’
 = 
	`¡¾’
(
ho¡Çme
)) == 0)

952 
qu™
;

953 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "EHLO ");

954 
off
 + 
Çm–’
 +‚am–’ < 
tmp
)

955 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%s.", 
ho¡Çme
);

956 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%s\r\n", 
ho¡Çme
);

958 
	`ä“
(
d©a_ıy
); d©a_ıy = 
NULL
;

965 
qu™
:

966 if(
d©a_ıy
 !ğ
NULL
)

967 
	`ä“
(
d©a_ıy
);

969 if(
off
 == 0)

971 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "QUIT\r\n");

972 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_NOMOREDATA
;

976 if(
	`tb™_£gm’t
(
¡©e
, (
ušt8_t
 *)
buf
, 
off
) != 0)

979  ()
off
;

980 
	}
}

982 
	$tb™_­p_dns_rx
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 *
d©a
, 
ušt16_t
 
dËn
)

985 cÚ¡ 
ušt8_t
 
dns_»que¡
[] = {

996 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

998 if(
¡©e
->
mode
 =ğ
MODE_SYN
)

1000 if(
	`tb™_£gm’t
(
¡©e
, 
dns_»que¡
, (dns_request)) != 0)

1002 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_NOMOREDATA
;

1003  (
dns_»que¡
);

1007 
	}
}

1009 
	$tb™_­p_áp_rx
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 *
d©a
, 
ušt16_t
 
dËn
)

1012 
	}
}

1014 
	$tb™_­p_rx
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 *
d©a
, 
ušt16_t
 
Ën
)

1016 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
ušt8_t
 *, 
ušt16_t
) = {

1017 
NULL
,

1018 
tb™_­p_h‰p_rx
,

1019 
tb™_­p_sm_rx
,

1020 
tb™_­p_dns_rx
,

1021 
tb™_­p_áp_rx
,

1023 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1025 
	`as£¹
(
tb™
->
­p_´Ùo
 != 0);

1026 
	`as£¹
(
tb™
->
­p_´Ùo
 <= 4);

1028  
func
[
tb™
->
­p_´Ùo
](
sk
, 
d©a
, 
Ën
);

1029 
	}
}

1036 
	$dl_syn
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1038 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1039 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1040 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
;

1041 
tb™_´obe_t
 *

 = 
NULL
;

1042 
rc
, 
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1048 if(
	`SCAMPER_DL_IS_TCP_SYNACK
(
dl
è=ğ0 || dl->
dl_tı_ack
 !ğ
¡©e
->
¢d_nxt
 + 1)

1050 if(
dl
->
dl_tı_æags
 & 
TH_RST
)

1051 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_NOCONN_RST
);

1053 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_NOCONN
);

1058 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_ECN
)

1060 if((
dl
->
dl_tı_æags
 & (
TH_ECE
|
TH_CWR
)) != TH_ECE)

1062 if((
dl
->
dl_tı_æags
 & (
TH_ECE
|
TH_CWR
)) == 0)

1063 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ECN_INCAPABLE
);

1065 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ECN_BADSYNACK
);

1069 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_ECT
;

1070 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_CE_SET
;

1073 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

1075 if((
dl
->
dl_tı_İts
 & 
SCAMPER_DL_TCP_OPT_SACKP
) == 0)

1076 
¡©e
->
§ckr_æags
 |ğ
TBIT_STATE_SACKR_FLAG_INCAPABLE
;

1078 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_NULL
)

1080 
nuÎ
 = 
tb™
->
d©a
;

1081 if((
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_TCPTS
) != 0 &&

1082 (
dl
->
dl_tı_İts
 & 
SCAMPER_DL_TCP_OPT_TS
) != 0)

1084 
nuÎ
->
»suÉs
 |ğ
SCAMPER_TBIT_NULL_RESULT_TCPTS
;

1085 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_TCPTS
;

1086 
¡©e
->
ts_»ûÁ
 = 
dl
->
dl_tı_tsv®
;

1088 if((
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_SACK
) != 0 &&

1089 (
dl
->
dl_tı_İts
 & 
SCAMPER_DL_TCP_OPT_SACKP
) != 0)

1091 
nuÎ
->
»suÉs
 |ğ
SCAMPER_TBIT_NULL_RESULT_SACK
;

1092 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_SACK
;

1096 
tb™
->
£rv”_mss
 = 
dl
->
dl_tı_mss
;

1099 
¡©e
->
¢d_nxt
++;

1100 
¡©e
->
rcv_nxt
 = 
dl
->
dl_tı_£q
 + 1;

1103 if((
rc
 = 
	`tb™_­p_rx
(
sk
, 
NULL
, 0)è< 0 || (

 = 
	`_tı
(
¡©e
, 0)) == NULL)

1104 
”r
;

1107 if(
rc
 > 0)

1113 if(
dl
->
dl_tı_wš
 == 0)

1115 

->
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1116 
¡©e
->
mode
 = 
MODE_ZEROWIN
;

1117 
	`tb™_queue
(
sk
);

1121 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

1123 
rc
 = 1;

1124 
wa™
 = 2000;

1126 if((

 = 
	`_tı
(
¡©e
, 
rc
)è=ğ
NULL
)

1127 
”r
;

1128 

->
wa™
 = wait;

1129 
¡©e
->
©‹m±
 = 0;

1132 
¡©e
->
mode
 = 
MODE_DATA
;

1133 
	`tb™_queue
(
sk
);

1136 
”r
:

1137 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1139 
	}
}

1141 
	$timeout_¹
(
sÿm³r_sk_t
 *
sk
)

1143 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ERROR
);

1145 
	}
}

1147 
	$timeout_dlhdr
(
sÿm³r_sk_t
 *
sk
)

1149 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_ERROR
);

1151 
	}
}

1153 
	$timeout_syn
(
sÿm³r_sk_t
 *
sk
)

1155 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1156 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1157 if(
¡©e
->
©‹m±
 >ğ
tb™
->
syn_»tx
)

1158 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_TCP_NOCONN
);

1160 
	}
}

1162 
	$dl_fš
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1164 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1165 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1166 
sÿm³r_tb™_tıqe_t
 *
qe
;

1167 
tb™_´obe_t
 *

;

1168 
ušt32_t
 
£q
;

1169 
ušt16_t
 
d©®’
;

1170 
ušt8_t
 
æags
;

1171 
x
;

1173 
	`timev®_add_ms
(&
¡©e
->
timeout
, &
dl
->
dl_tv
, 
TBIT_TIMEOUT_LONG
);

1176 if(
dl
->
dl_tı_ack
 =ğ
¡©e
->
¢d_nxt
 + 1 &&

1177 (
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_ACKED
) == 0)

1179 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_ACKED
;

1180 
¡©e
->
¢d_nxt
++;

1184 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_SEEN
) &&

1185 
dl
->
dl_tı_£q
 =ğ
¡©e
->
rcv_nxt
)

1187 if(
	`tb™_tışo£d
(
¡©e
))

1189 if(
tb™
->
»suÉ
 =ğ
SCAMPER_TBIT_RESULT_NONE
)

1190 
	`tb™_şassify
(
sk
);

1191 
¡©e
->
mode
 = 
MODE_DONE
;

1192 
	`tb™_queue
(
sk
);

1198 if(
dl
->
dl_tı_d©®’
 =ğ0 && (dl->
dl_tı_æags
 & 
TH_FIN
) == 0)

1201 if((

 = 
	`_tı
(
¡©e
, 0)è=ğ
NULL
)

1202 
”r
;

1205 if(
	`tb™_d©a_š¿nge
(
¡©e
, 
dl
->
dl_tı_£q
, dl->
dl_tı_d©®’
) == 0)

1206 
ack
;

1208 if(
	`tb™_rxq
(
¡©e
, 
dl
) != 0)

1209 
”r
;

1211 
	`sÿm³r_tb™_tıq_£g
(
¡©e
->
rxq
, &
£q
, &
d©®’
) == 0)

1213 if(
	`sÿm³r_tb™_d©a_š¿nge
(
¡©e
->
rcv_nxt
, 
£q
, 
d©®’
) == 0)

1215 
	`sÿm³r_tb™_tıqe_ä“
(
	`sÿm³r_tb™_tıq_pİ
(
¡©e
->
rxq
), 
ä“
);

1220 if((
x
 = 
	`sÿm³r_tb™_d©a_£qoff
(
¡©e
->
rcv_nxt
, 
£q
)) > 0)

1223 
qe
 = 
	`sÿm³r_tb™_tıq_pİ
(
¡©e
->
rxq
);

1224 
æags
 = 
qe
->flags;

1225 
	`sÿm³r_tb™_tıqe_ä“
(
qe
, 
ä“
);

1226 
¡©e
->
rcv_nxt
 +ğ(
d©®’
 - 
	`abs
(
x
));

1228 if((
æags
 & 
TH_FIN
) != 0)

1230 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1231 
¡©e
->
rcv_nxt
++;

1234 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_FIN_ACKED
) == 0)

1235 

->
_æags
 |ğ
TH_FIN
;

1237 if(
	`tb™_tışo£d
(
¡©e
))

1239 if(
tb™
->
»suÉ
 =ğ
SCAMPER_TBIT_RESULT_NONE
)

1240 
	`tb™_şassify
(
sk
);

1241 
¡©e
->
mode
 = 
MODE_DONE
;

1246 
ack
:

1247 

->
_ack
 = 
¡©e
->
rcv_nxt
;

1248 if(
¡©e
->
mode
 !ğ
MODE_DONE
 && (¡©e->
æags
 & 
TBIT_STATE_FLAG_SACK
) != 0)

1250 
x
 = 4;

1251 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_TCPTS
) != 0)

1252 
x
--;

1253 

->
_§ckb
 = 
	`sÿm³r_tb™_tıq_§ck
(
¡©e
->
rxq
,p->
_§ck
, 
x
);

1256 
	`tb™_queue
(
sk
);

1259 
”r
:

1260 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1262 
	}
}

1264 
	$timeout_fš
(
sÿm³r_sk_t
 *
sk
)

1266 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1267 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1269 if(
tb™
->
»suÉ
 =ğ
SCAMPER_TBIT_RESULT_NONE
)

1270 
	`tb™_şassify
(
sk
);

1271 
¡©e
->
mode
 = 
MODE_DONE
;

1272 
	`tb™_queue
(
sk
);

1274 
	}
}

1284 
	$dl_d©a_pmtud
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1286 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1287 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1288 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

1289 
tb™_´obe_t
 *

;

1290 
rc
, 
bh
 = 0, 
v4
 = 0, 
v6
 = 0, 
sk
 = 0, 
äag
 = 0;

1291 
ušt16_t
 
size
;

1294 if(
dl
->
dl_tı_£q
 !ğ
¡©e
->
rcv_nxt
)

1296 if(
	`_tı
(
¡©e
, 0è=ğ
NULL
)

1297 
”r
;

1301 if(
dl
->
dl_af
 =ğ
AF_INET
)

1302 
v4
 = 1;

1304 
v6
 = 1;

1306 if(
	`SCAMPER_DL_IS_IP_FRAG
(
dl
) != 0)

1307 
äag
 = 1;

1309 if(
pmtud
->
İtiÚs
 & 
SCAMPER_TBIT_PMTUD_OPTION_BLACKHOLE
)

1310 
bh
 = 1;

1312 
size
 = 
dl
->
dl__size
;

1319 if(
dl
->
dl_tı_d©®’
 =ğ0 || 
	`SCAMPER_DL_IS_IP_REASS
(dl) != 0)

1320 
sk
 = 1;

1321 if(
v4
 && 
	`SCAMPER_DL_IS_IP_DF
(
dl
) == 0)

1322 
sk
 = 1;

1323 if((
v4
 || 
pmtud
->
mtu
 >ğ1280è&& 
size
 <=…mtud->mtu)

1324 
sk
 = 1;

1325 if(
v6
 && 
bh
 =ğ0 && 
pmtud
->
mtu
 < 1280 && 
äag
 !ğ0 && 
size
 <= 1280)

1326 
sk
 = 1;

1327 if(
v6
 && 
bh
 =ğ1 && 
size
 <ğ
pmtud
->
mtu
)

1328 
sk
 = 1;

1330 if(
dl
->
dl_tı_d©®’
 > 0)

1331 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_SEEN_DATA
;

1333 if(
sk
)

1335 if(
dl
->
dl_tı_d©®’
 > 0)

1337 
¡©e
->
rcv_nxt
 +ğ
dl
->
dl_tı_d©®’
;

1339 if(
v4
 && 
	`SCAMPER_DL_IS_IP_DF
(
dl
) == 0 &&

1340 
size
 > 
pmtud
->
mtu
 && 
	`SCAMPER_DL_IS_IP_REASS
(
dl
) == 0)

1341 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_NODF
;

1344 if(
dl
->
dl_tı_d©®’
 > 0 || (dl->
dl_tı_æags
 & 
TH_FIN
) != 0)

1346 if((
rc
 = 
	`tb™_­p_rx
(
sk
, 
dl
->
dl_tı_d©a
, dl->
dl_tı_d©®’
)) < 0)

1347 
”r
;

1348 if((

 = 
	`_tı
(
¡©e
, 
rc
)è=ğ
NULL
)

1349 
”r
;

1350 if(
rc
 > 0)

1352 

->
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1353 
¡©e
->
©‹m±
 = 0;

1356 if((
dl
->
dl_tı_æags
 & 
TH_FIN
) != 0)

1358 

->
_æags
 |ğ
TH_FIN
;

1359 

->
_ack
++;

1360 
¡©e
->
rcv_nxt
++;

1361 
¡©e
->
mode
 = 
MODE_FIN
;

1362 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1373 if(
bh
 != 0)

1375 
¡©e
->
mode
 = 
MODE_BLACKHOLE
;

1379 
¡©e
->
mode
 = 
MODE_PMTUD
;

1381 if(
dl
->
dl_af
 =ğ
AF_INET
)

1382 
¡©e
->
pmtud_±b_d©®’
 = 
dl
->
dl__hl
 + 8;

1383 if(
size
 >= 1280-40-8)

1384 
¡©e
->
pmtud_±b_d©®’
 = 1280 - 40 - 8;

1386 
¡©e
->
pmtud_±b_d©®’
 = 
size
;

1388 
¡©e
->
pmtud_±b_d©a
 = 
	`memdup
(
dl
->
dl_Ãt_¿w
, s‹->
pmtud_±b_d©®’
);

1389 if(
¡©e
->
pmtud_±b_d©a
 =ğ
NULL
)

1391 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot dup quote");

1392 
”r
;

1395 if(
	`_±b
(
¡©e
è=ğ
NULL
)

1396 
”r
;

1397 
¡©e
->
©‹m±
 = 0;

1401 
”r
:

1402 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1404 
	}
}

1406 
	$timeout_d©a_pmtud
(
sÿm³r_sk_t
 *
sk
)

1408 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_NODATA
);

1410 
	}
}

1417 
	$dl_d©a_eú
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1419 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1420 
tb™_´obe_t
 *

 = 
NULL
;

1421 
rc
, 
fš
 = 0;

1427 if(
dl
->
dl_tı_æags
 & 
TH_ECE
)

1429 if((
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_ECE_SEEN
) == 0)

1431 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_ECE_SEEN
;

1432 if((
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CWR_SET
) == 0)

1433 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_CWR_SET
;

1438 if(
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CWR_SET
)

1440 
¡©e
->
eú_æags
 &ğ~
TBIT_STATE_ECN_FLAG_CWR_SET
;

1441 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_CWR_SENT
;

1446 if(
dl
->
dl_tı_£q
 !ğ
¡©e
->
rcv_nxt
)

1448 if(
	`_tı
(
¡©e
, 0è=ğ
NULL
)

1449 
”r
;

1457 if(
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CE_SET
)

1459 
¡©e
->
eú_æags
 &ğ~
TBIT_STATE_ECN_FLAG_CE_SET
;

1460 
¡©e
->
eú_æags
 |ğ
TBIT_STATE_ECN_FLAG_CE_SENT
;

1463 if((
dl
->
dl_tı_æags
 & 
TH_FIN
) != 0)

1464 
fš
 = 1;

1466 if(
dl
->
dl_tı_d©®’
 > 0)

1468 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_SEEN_DATA
;

1469 
¡©e
->
rcv_nxt
 +ğ
dl
->
dl_tı_d©®’
;

1472 if(
dl
->
dl_tı_d©®’
 > 0 || 
fš
 != 0)

1474 if((
rc
 = 
	`tb™_­p_rx
(
sk
, 
dl
->
dl_tı_d©a
, dl->
dl_tı_d©®’
)) < 0)

1475 
”r
;

1476 if((

 = 
	`_tı
(
¡©e
, 
rc
)è=ğ
NULL
)

1477 
”r
;

1478 if(
rc
 > 0)

1480 

->
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1481 
¡©e
->
©‹m±
 = 0;

1483 if(
fš
 !ğ0 || (
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_ECT
) == 0)

1485 

->
_æags
 |ğ
TH_FIN
;

1486 
¡©e
->
mode
 = 
MODE_FIN
;

1487 if(
fš
 != 0)

1489 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1490 
¡©e
->
rcv_nxt
++;

1491 

->
_ack
++;

1498 
”r
:

1499 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1501 
	}
}

1503 
	$timeout_d©a_eú
(
sÿm³r_sk_t
 *
sk
)

1505 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1507 
	`tb™_şassify
(
sk
);

1508 if(
¡©e
->
mode
 !ğ
MODE_FIN
)

1510 
¡©e
->
mode
 = 
MODE_FIN
;

1511 
	`sÿm³r_sk_queue_´obe
(
sk
);

1515 
	}
}

1522 
	$dl_d©a_nuÎ
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1524 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1525 
tb™_´obe_t
 *

 = 
NULL
;

1526 
sÿm³r_tb™_tıqe_t
 *
qe
 = 
NULL
;

1527 
ušt32_t
 
£q
;

1528 
ušt16_t
 
d©®’
;

1529 
off
, 
rc
, 
fš
, 
tx_fš
 = 0;

1532 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_NOMOREDATA
) != 0 &&

1533 
	`¦i¡_couÁ
(
¡©e
->
£gm’ts
) == 0)

1534 
tx_fš
 = 1;

1537 if(
dl
->
dl_tı_d©®’
 =ğ0 && (dl->
dl_tı_æags
 & 
TH_FIN
) == 0)

1539 if(
tx_fš
 !ğ0 && (
¡©e
->
æags
 & 
TBIT_STATE_FLAG_SEEN_DATA
) != 0)

1541 if((

 = 
	`_tı
(
¡©e
, 0)è=ğ
NULL
)

1542 
”r
;

1543 

->
_æags
 |ğ
TH_FIN
;

1544 
¡©e
->
mode
 = 
MODE_FIN
;

1549 if(
	`tb™_rxq
(
¡©e
, 
dl
) != 0)

1550 
”r
;

1552 
	`sÿm³r_tb™_tıq_£g
(
¡©e
->
rxq
, &
£q
, &
d©®’
) == 0)

1554 if(
	`sÿm³r_tb™_d©a_š¿nge
(
¡©e
->
rcv_nxt
, 
£q
, 
d©®’
) == 0)

1556 
	`sÿm³r_tb™_tıqe_ä“
(
	`sÿm³r_tb™_tıq_pİ
(
¡©e
->
rxq
), 
ä“
);

1560 if(
d©®’
 > 0)

1561 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_SEEN_DATA
;

1564 if((
off
 = 
	`sÿm³r_tb™_d©a_£qoff
(
¡©e
->
rcv_nxt
, 
£q
)) > 0)

1566 if((

 = 
	`_tı
(
¡©e
, 0)è=ğ
NULL
)

1567 
”r
;

1568 if(
tx_fš
 != 0)

1570 

->
_æags
 |ğ
TH_FIN
;

1571 
¡©e
->
mode
 = 
MODE_FIN
;

1584 
qe
 = 
	`sÿm³r_tb™_tıq_pİ
(
¡©e
->
rxq
);

1585 
off
 = 
	`abs
(off);

1586 
fš
 = (
qe
->
æags
 & 
TH_FIN
) != 0 ? 1 : 0;

1587 if(
qe
->
Ën
 > 0)

1588 
¡©e
->
rcv_nxt
 +ğ(
qe
->
Ën
 - 
off
);

1589 if((
rc
 = 
	`tb™_­p_rx
(
sk
, 
qe
->
d©a
+
off
, qe->
Ën
-off)) < 0)

1590 
”r
;

1591 
	`sÿm³r_tb™_tıqe_ä“
(
qe
, 
ä“
); qğ
NULL
;

1593 if((

 = 
	`_tı
(
¡©e
, 
rc
)è=ğ
NULL
)

1594 
”r
;

1595 if(
rc
 > 0)

1597 

->
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1598 
¡©e
->
©‹m±
 = 0;

1600 if(
tx_fš
 !ğ0 || 
fš
 != 0)

1602 

->
_æags
 |ğ
TH_FIN
;

1603 
¡©e
->
mode
 = 
MODE_FIN
;

1604 if(
fš
 != 0)

1606 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1607 
¡©e
->
rcv_nxt
++;

1608 

->
_ack
++;

1616 
”r
:

1617 if(
qe
 !ğ
NULL
è
	`sÿm³r_tb™_tıqe_ä“
(qe, 
ä“
);

1618 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1620 
	}
}

1622 
	$timeout_d©a_nuÎ
(
sÿm³r_sk_t
 *
sk
)

1624 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1626 
	`tb™_şassify
(
sk
);

1627 if(
¡©e
->
mode
 !ğ
MODE_FIN
)

1629 
¡©e
->
mode
 = 
MODE_FIN
;

1630 
	`sÿm³r_sk_queue_´obe
(
sk
);

1634 
	}
}

1636 
	$§ck_rcvr_Ãxt
(
sÿm³r_sk_t
 *
sk
)

1638 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1639 
tb™_´obe_t
 *

;

1642 if(
¡©e
->
§ckr_x
 == 6)

1644 
	`tb™_şassify
(
sk
);

1649 if((

 = 
	`_tı
(
¡©e
, 1)è=ğ
NULL
)

1651 

->
_£q
 +ğ1 + (
¡©e
->
§ckr_x
 * 2);

1652 

->
wa™
 = 2000;

1653 
¡©e
->
©‹m±
 = 0;

1654 
¡©e
->
§ckr_x
++;

1656 
	`tb™_queue
(
sk
);

1658 
	}
}

1666 
	$dl_d©a_§ck_rcvr
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1668 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1669 
ušt32_t
 
edge
;

1670 
i
, 
x
 = -1;

1672 if(
dl
->
dl_tı_£q
 !ğ
¡©e
->
rcv_nxt
)

1676 if((
dl
->
dl_tı_æags
 & 
TH_FIN
) != 0)

1678 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1679 
	`tb™_şassify
(
sk
);

1683 if(
dl
->
dl_tı_§ck_edgec
 == -1)

1685 
¡©e
->
§ckr_æags
 |ğ
TBIT_STATE_SACKR_FLAG_BADOPT
;

1688 if(
dl
->
dl_tı_§ck_edgec
 == 0)

1690 
x
 = 0;

1692 if(
dl
->
dl_tı_§ck_edgec
 > 0)

1694 
	`as£¹
(
dl
->
dl_tı_§ck_edgec
 > 1);

1695 
edge
 = 
dl
->
dl_tı_§ck_edges
[1] - 
¡©e
->
¢d_nxt
;

1696 if((
edge
 & 0x1è=ğ0 &&ƒdg!ğ0 &&ƒdg/ 2 <ğ
¡©e
->
§ckr_x
)

1697 
x
 = 
edge
 / 2;

1700 
i
=0; i<
dl
->
dl_tı_§ck_edgec
; i++)

1702 
edge
 = 
dl
->
dl_tı_§ck_edges
[0] - 
¡©e
->
¢d_nxt
;

1703 if(
edge
 =ğ0 ||ƒdg/ 2 > 
¡©e
->
§ckr_x
)

1705 
¡©e
->
§ckr_æags
 |ğ
TBIT_STATE_SACKR_FLAG_SHIFTED
;

1715 if(
x
 != -1)

1717 
¡©e
->
§ckr_rx
[
x
]++;

1718 if(
¡©e
->
§ckr_rx
[
x
] > 1 && x == 0 &&

1719 (
¡©e
->
§ckr_æags
 & 
TBIT_STATE_SACKR_FLAG_INCAPABLE
) == 0)

1723 if(
	`§ck_rcvr_Ãxt
(
sk
) != 0)

1724 
”r
;

1728 
”r
:

1729 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1731 
	}
}

1733 
	$timeout_d©a_§ck_rcvr
(
sÿm³r_sk_t
 *
sk
)

1735 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1737 
¡©e
->
§ckr_timeout
++;

1738 if(
	`§ck_rcvr_Ãxt
(
sk
) != 0)

1739 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1742 
	}
}

1744 
	$dl_d©a
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1746 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *) =

1748 
NULL
,

1749 
dl_d©a_pmtud
,

1750 
dl_d©a_eú
,

1751 
dl_d©a_nuÎ
,

1752 
dl_d©a_§ck_rcvr
,

1754 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1755 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1756 
tb™_£gm’t_t
 *
£g
;

1757 
ušt32_t
 
ab
;

1759 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_NORESET
) == 0)

1760 
	`timev®_add_ms
(&
¡©e
->
timeout
, &
dl
->
dl_tv
, 
TBIT_TIMEOUT_LONG
);

1763 if(
	`tb™_d©a_š¿nge
(
¡©e
, 
dl
->
dl_tı_£q
, dl->
dl_tı_d©®’
) == 0)

1767 if(
dl
->
dl_tı_ack
 > 
¡©e
->
¢d_nxt
)

1769 if((
£g
 = 
	`¦i¡_h—d_g‘
(
¡©e
->
£gm’ts
)è=ğ
NULL
)

1772 
ab
 = 
dl
->
dl_tı_ack
 - 
¡©e
->
¢d_nxt
;

1773 if(
ab
 >ğ
£g
->
Ën
)

1775 
ab
 = 
£g
->
Ën
;

1776 
	`¦i¡_h—d_pİ
(
¡©e
->
£gm’ts
);

1777 
	`tb™_£gm’t_ä“
(
£g
);

1781 
	`memmove
(
£g
->
d©a
, seg->d©a+
ab
, seg->
Ën
-ab);

1783 
¡©e
->
¢d_nxt
 +ğ
ab
;

1786 
func
[
tb™
->
ty³
](
sk
, 
dl
);

1787 
	`tb™_queue
(
sk
);

1789 
	}
}

1791 
	$timeout_d©a
(
sÿm³r_sk_t
 *
sk
)

1793 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) =

1795 
NULL
,

1796 
timeout_d©a_pmtud
,

1797 
timeout_d©a_eú
,

1798 
timeout_d©a_nuÎ
,

1799 
timeout_d©a_§ck_rcvr
,

1801 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1802 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1803 
tb™_£gm’t_t
 *
£g
;

1804 
tb™_´obe_t
 *

;

1806 if((
£g
 = 
	`¦i¡_h—d_g‘
(
¡©e
->
£gm’ts
)è!ğ
NULL
)

1808 if(
¡©e
->
©‹m±
 >ğ
tb™
->
d©_»tx
)

1810 
func
[
tb™
->
ty³
](
sk
);

1813 if((

=
	`_tı
(
¡©e
, 
£g
->
Ën
)è=ğ
NULL
)

1814 
”r
;

1815 

->
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

1816 
	`tb™_queue
(
sk
);

1820 
	`tb™_şassify
(
sk
);

1821 if(
tb™
->
»suÉ
 !ğ
SCAMPER_TBIT_RESULT_NONE
 && 
¡©e
->
mode
 !ğ
MODE_FIN
)

1823 
¡©e
->
mode
 = 
MODE_FIN
;

1824 
	`sÿm³r_sk_queue_´obe
(
sk
);

1830 
”r
:

1831 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1833 
	}
}

1840 
	$timeout_pmtud
(
sÿm³r_sk_t
 *
sk
)

1842 
	`tb™_şassify
(
sk
);

1844 
	}
}

1849 
	$dl_pmtud
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1851 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1852 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1853 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

1854 
tb™_´obe_t
 *

;

1855 
ušt16_t
 
mtu
 = 
pmtud
->mtu;

1856 
v4
 = 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tb™
->
d¡
) ? 1 : 0;

1857 
sucûss
 = 0;

1860 if(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
tb™
->
d¡
è&& 
pmtud
->
mtu
 < 1280)

1861 
mtu
 = 0;

1864 if(
dl
->
dl_tı_£q
 !ğ
¡©e
->
rcv_nxt
)

1866 if(
dl
->
dl__size
 > 
mtu
)

1868 if(
	`_tı
(
¡©e
, 0è=ğ
NULL
)

1869 
”r
;

1870 
	`tb™_queue
(
sk
);

1874 if(
mtu
 != 0)

1876 if(
	`SCAMPER_DL_IS_IP_REASS
(
dl
è|| dl->
dl__size
 <ğ
mtu
 ||

1877 (
v4
 && 
	`SCAMPER_DL_IS_IP_DF
(
dl
) == 0))

1878 
sucûss
 = 1;

1882 if(
	`SCAMPER_DL_IS_IP_FRAG
(
dl
è|| 
	`SCAMPER_DL_IS_IP_REASS
(dl))

1883 
sucûss
 = 1;

1886 if(
sucûss
)

1888 
¡©e
->
rcv_nxt
 +ğ
dl
->
dl_tı_d©®’
;

1890 if(
v4
 && 
	`SCAMPER_DL_IS_IP_DF
(
dl
) == 0)

1891 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_CLEARDF
);

1893 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_SUCCESS
);

1895 if((

 = 
	`_tı
(
¡©e
, 0)è=ğ
NULL
)

1897 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1900 if((
dl
->
dl_tı_æags
 & 
TH_FIN
) != 0)

1902 

->
_æags
 |ğ
TH_FIN
;

1903 

->
_ack
++;

1904 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1905 
¡©e
->
rcv_nxt
++;

1908 
	`tb™_queue
(
sk
);

1912 if(
pmtud
->
±b_»tx
 !ğ0 && 
¡©e
->
©‹m±
 >=…mtud->ptb_retx)

1914 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_FAIL
);

1919 if(
	`_±b
(
¡©e
è=ğ
NULL
)

1920 
”r
;

1922 
	`tb™_queue
(
sk
);

1925 
”r
:

1926 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1928 
	}
}

1930 
	$dl_bÏckhŞe
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

1932 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

1933 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

1934 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

1935 
tb™_´obe_t
 *

;

1936 
ušt16_t
 
mtu
 = 
pmtud
->mtu;

1937 
v4
 = 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tb™
->
d¡
) ? 1 : 0;

1938 
ack
 = 0;

1941 if(
dl
->
dl_tı_£q
 !ğ
¡©e
->
rcv_nxt
)

1943 if(
dl
->
dl__size
 > 
mtu
)

1945 if(
	`_tı
(
¡©e
, 0è=ğ
NULL
)

1946 
”r
;

1947 
	`tb™_queue
(
sk
);

1951 if(
mtu
 != 0)

1953 if(
dl
->
dl__size
 <ğ
mtu
 || (
v4
 && 
	`SCAMPER_DL_IS_IP_DF
(dl) == 0))

1954 
ack
 = 1;

1958 if(
	`SCAMPER_DL_IS_IP_FRAG
(
dl
è|| 
	`SCAMPER_DL_IS_IP_REASS
(dl))

1959 
ack
 = 1;

1962 if(
ack
 != 0)

1964 
¡©e
->
rcv_nxt
 +ğ
dl
->
dl_tı_d©®’
;

1966 if((

 = 
	`_tı
(
¡©e
, 0)è=ğ
NULL
)

1968 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1976 if((
dl
->
dl_tı_æags
 & 
TH_FIN
) != 0)

1978 

->
_æags
 |ğ
TH_FIN
;

1979 

->
_ack
++;

1980 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_FIN_SEEN
;

1981 
¡©e
->
rcv_nxt
++;

1982 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_PMTUD_SUCCESS
);

1986 
	`timev®_add_ms
(&
¡©e
->
timeout
, &
dl
->
dl_tv
, 
TBIT_TIMEOUT_LONG
);

1989 
	`tb™_queue
(
sk
);

1992 
”r
:

1993 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

1995 
	}
}

1997 
	$timeout_z”owš
(
sÿm³r_sk_t
 *
sk
)

1999 
	`tb™_şassify
(
sk
);

2001 
	}
}

2003 
	$dl_z”owš
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

2005 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2006 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2007 
tb™_£gm’t_t
 *
£g
;

2008 
tb™_´obe_t
 *

;

2009 
Ën
, 
wa™
;

2011 if(
dl
->
dl_tı_wš
 == 0)

2014 
£g
 = 
	`¦i¡_h—d_g‘
(
¡©e
->
£gm’ts
);

2015 
	`as£¹
(
£g
 !ğ
NULL
);

2018 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

2020 
Ën
 = 1;

2021 
wa™
 = 2000;

2025 
Ën
 = 
£g
->len;

2026 
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

2029 if((

 = 
	`_tı
(
¡©e
, 
Ën
)è=ğ
NULL
)

2030 
”r
;

2031 

->
wa™
 = wait;

2032 
¡©e
->
©‹m±
 = 0;

2033 
¡©e
->
mode
 = 
MODE_DATA
;

2034 
	`tb™_queue
(
sk
);

2037 
”r
:

2038 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2040 
	}
}

2048 
	$do_tb™_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

2050 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *) =

2052 
NULL
,

2053 
NULL
,

2054 
NULL
,

2055 
NULL
,

2056 
NULL
,

2057 
dl_syn
,

2058 
dl_fš
,

2059 
dl_d©a
,

2060 
dl_pmtud
,

2061 
dl_bÏckhŞe
,

2062 
dl_z”owš
,

2065 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2066 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2067 
sÿm³r_tb™_pkt_t
 *
pkt
 = 
NULL
;

2068 
sÿm³r_dl_»c_t
 *
Ãwp
 = 
NULL
;

2074 if(
dl
->
dl__off
 !ğ0 || 
	`SCAMPER_DL_IS_IP_MF
(dl))

2076 
	`sÿm³r_dl_»c_äag_´št
(
dl
);

2077 
pkt
 = 
	`sÿm³r_tb™_pkt_®loc
(
SCAMPER_TBIT_PKT_DIR_RX
, 
dl
->
dl_Ãt_¿w
,

2078 
dl
->
dl__size
, &dl->
dl_tv
);

2079 if(
pkt
 =ğ
NULL
 || 
	`sÿm³r_tb™_»cÜd_pkt
(
tb™
,…kt) != 0)

2080 
”r
;

2081 if(
	`tb™_»as£mbË
(
sk
, &
Ãwp
, 
dl
) != 0)

2082 
”r
;

2083 if(
Ãwp
 =ğ
NULL
)

2085 
dl
 = 
Ãwp
;

2089 if(
	`SCAMPER_DL_IS_TCP
(
dl
) == 0 ||

2090 
dl
->
dl_tı_¥Üt
 !ğ
tb™
->
dpÜt
 || dl->
dl_tı_dpÜt
 !ğtb™->
¥Üt
 ||

2091 
	`sÿm³r_addr_¿w_cmp
(
tb™
->
d¡
, 
dl
->
dl__¤c
) != 0 ||

2092 
	`sÿm³r_addr_¿w_cmp
(
tb™
->
¤c
, 
dl
->
dl__d¡
) != 0)

2094 
dÚe
;

2101 if(
Ãwp
 =ğ
NULL
)

2103 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

2104 
pkt
 = 
	`sÿm³r_tb™_pkt_®loc
(
SCAMPER_TBIT_PKT_DIR_RX
, 
dl
->
dl_Ãt_¿w
,

2105 
dl
->
dl__size
, &dl->
dl_tv
);

2106 if(
pkt
 =ğ
NULL
 || 
	`sÿm³r_tb™_»cÜd_pkt
(
tb™
,…kt) != 0)

2108 if(
pkt
 !ğ
NULL
è
	`sÿm³r_tb™_pkt_ä“
(pkt);

2109 
”r
;

2114 if(
func
[
¡©e
->
mode
] =ğ
NULL
)

2115 
dÚe
;

2118 if((
dl
->
dl_tı_æags
 & 
TH_RST
è!ğ0 && 
¡©e
->
mode
 !ğ
MODE_SYN
)

2120 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_RST_SEEN
;

2121 
	`tb™_şassify
(
sk
);

2126 if((
dl
->
dl_tı_æags
 & 
TH_ACK
è=ğ0 && 
¡©e
->
mode
 !ğ
MODE_SYN
)

2127 
dÚe
;

2130 if((
¡©e
->
æags
 & 
TBIT_STATE_FLAG_TCPTS
) != 0 &&

2131 
dl
->
dl_tı_£q
 <ğ
¡©e
->
ts_Ï¡ack
 &&

2132 
¡©e
->
ts_Ï¡ack
 < 
dl
->
dl_tı_£q
 + dl->
dl_tı_d©®’
)

2134 
¡©e
->
ts_»ûÁ
 = 
dl
->
dl_tı_tsv®
;

2137 
func
[
¡©e
->
mode
](
sk
, 
dl
);

2139 
dÚe
:

2140 if(
Ãwp
 !ğ
NULL
 &&‚ew°!ğ
dl
)

2142 if(
Ãwp
->
dl__d©a
 !ğ
NULL
)

2143 
	`ä“
(
Ãwp
->
dl__d©a
);

2144 
	`ä“
(
Ãwp
);

2148 
”r
:

2149 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2151 
	}
}

2153 
	$do_tb™_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

2156 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) =

2158 
NULL
,

2159 
timeout_¹
,

2160 
timeout_dlhdr
,

2161 
NULL
,

2162 
NULL
,

2163 
timeout_syn
,

2164 
timeout_fš
,

2165 
timeout_d©a
,

2166 
timeout_pmtud
,

2167 
timeout_pmtud
,

2168 
timeout_z”owš
,

2170 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2173 if(
func
[
¡©e
->
mode
] !ğ
NULL
)

2174 
func
[
¡©e
->
mode
](
sk
);

2177 
	}
}

2179 
	$tb™_hªdË_dlhdr
(
sÿm³r_dlhdr_t
 *
dlhdr
)

2181 
sÿm³r_sk_t
 *
sk
 = 
dlhdr
->
·¿m
;

2182 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2184 if(
dlhdr
->
”rÜ
 != 0)

2186 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2190 
¡©e
->
mode
 = 
MODE_FIREWALL
;

2191 
	`sÿm³r_sk_queue_´obe
(
sk
);

2193 
	}
}

2195 
	$tb™_hªdË_¹
(
sÿm³r_rou‹_t
 *
¹
)

2197 
sÿm³r_sk_t
 *
sk
 = 
¹
->
·¿m
;

2198 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2199 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2200 
sÿm³r_dl_t
 *
dl
;

2201 
ušt16_t
 
mtu
;

2203 if(
¡©e
->
mode
 !ğ
MODE_RTSOCK
 || s‹->
rou‹
 !ğ
¹
)

2204 
dÚe
;

2206 #iâdeà
_WIN32


2207 if(
¡©e
->
¹sock
 !ğ
NULL
)

2209 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

2210 
¡©e
->
¹sock
 = 
NULL
;

2214 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

2216 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifindex");

2217 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2218 
dÚe
;

2225 if((
¡©e
->
dl
 = 
	`sÿm³r_fd_dl
(
¹
->
ifšdex
)è=ğ
NULL
)

2227 
	`sÿm³r_debug
(
__func__
, "could‚Ù g‘ dÈfÜ %d", 
¹
->
ifšdex
);

2228 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2229 
dÚe
;

2233 if(
tb™
->
ş›Á_mss
 == 0)

2235 if(
	`sÿm³r_if_g‘mtu
(
¹
->
ifšdex
, &
mtu
) != 0)

2237 
	`sÿm³r_debug
(
__func__
, "could‚ot gethe interface mtu");

2238 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2239 
dÚe
;

2242 if(
tb™
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

2243 
tb™
->
ş›Á_mss
 = 
mtu
 - 40;

2244 if(
tb™
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

2245 
tb™
->
ş›Á_mss
 = 
mtu
 - 60;

2247 
	`sÿm³r_debug
(
__func__
, "usšg cl›Á ms ğ%hu", 
tb™
->
ş›Á_mss
);

2254 
¡©e
->
mode
 = 
MODE_DLHDR
;

2255 if((
¡©e
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

2257 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2258 
dÚe
;

2260 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->dl);

2261 
¡©e
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
tb™
->dst);

2262 
¡©e
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

2263 
¡©e
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

2264 
¡©e
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

2265 
¡©e
->
dlhdr
->
·¿m
 = 
sk
;

2266 
¡©e
->
dlhdr
->
cb
 = 
tb™_hªdË_dlhdr
;

2267 if(
	`sÿm³r_dlhdr_g‘
(
¡©e
->
dlhdr
) != 0)

2269 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2270 
dÚe
;

2273 if(
¡©e
->
mode
 !ğ
MODE_FIREWALL
 && 
	`sÿm³r_sk_queue_isdÚe
(
sk
) == 0)

2274 
	`sÿm³r_sk_queue_wa™
(
sk
, 1000);

2276 
dÚe
:

2277 
	`sÿm³r_rou‹_ä“
(
¹
);

2278 if(
¡©e
->
rou‹
 =ğ
¹
)

2279 
¡©e
->
rou‹
 = 
NULL
;

2281 
	}
}

2283 
	$do_tb™_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

2285 
	`sÿm³r_fe_wr™e_tb™
(
sf
, 
	`tb™_g‘d©a
(
sk
));

2287 
	}
}

2289 
	$tb™_¡©e_ä“
(
sÿm³r_sk_t
 *
sk
)

2291 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2292 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2293 
tb™_£gm’t_t
 *
£g
;

2294 
tb™_´obe_t
 *

;

2295 
i
;

2297 if(
¡©e
 =ğ
NULL
)

2299 
	`as£¹
(
tb™
 !ğ
NULL
);

2301 if(
¡©e
->
fw
 !ğ
NULL
)

2302 
	`sÿm³r_fœew®l_’Œy_ä“
(
¡©e
->
fw
);

2304 #iâdeà
_WIN32


2305 if(
¡©e
->
¹sock
 !ğ
NULL
)

2306 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

2309 if(
¡©e
->
dl
 !ğ
NULL
)

2310 
	`sÿm³r_fd_ä“
(
¡©e
->
dl
);

2312 if(
¡©e
->
dlhdr
 !ğ
NULL
)

2313 
	`sÿm³r_dlhdr_ä“
(
¡©e
->
dlhdr
);

2315 if(
¡©e
->
rou‹
 !ğ
NULL
)

2316 
	`sÿm³r_rou‹_ä“
(
¡©e
->
rou‹
);

2318 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_PMTUD
)

2320 if(
¡©e
->
pmtud_±b_d©a
 !ğ
NULL
)

2321 
	`ä“
(
¡©e
->
pmtud_±b_d©a
);

2324 if(
¡©e
->
£gm’ts
 !ğ
NULL
)

2326 (
£g
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
£gm’ts
)è!ğ
NULL
)

2327 
	`tb™_£gm’t_ä“
(
£g
);

2328 
	`¦i¡_ä“
(
¡©e
->
£gm’ts
);

2331 if(
¡©e
->
tx
 !ğ
NULL
)

2333 (

 = 
	`¦i¡_h—d_pİ
(
¡©e
->
tx
)è!ğ
NULL
)

2334 
	`_ä“
(

);

2335 
	`¦i¡_ä“
(
¡©e
->
tx
);

2338 if(
¡©e
->
rxq
 !ğ
NULL
)

2339 
	`sÿm³r_tb™_tıq_ä“
(
¡©e
->
rxq
, 
ä“
);

2341 if(
¡©e
->
äags
 !ğ
NULL
)

2343 
i
=0; i<
¡©e
->
äagc
; i++)

2344 
	`tb™_äags_ä“
(
¡©e
->
äags
[
i
]);

2345 
	`ä“
(
¡©e
->
äags
);

2348 
	`ä“
(
¡©e
);

2350 
	}
}

2352 
	$tb™_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

2354 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2355 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
;

2356 
tb™_¡©e_t
 *
¡©e
;

2357 
ušt16_t
 
£q
;

2359 if((
¡©e
 = 
	`m®loc_z”o
((
tb™_¡©e_t
))è=ğ
NULL
)

2361 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

2362 
”r
;

2364 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

2366 if((
¡©e
->
£gm’ts
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

2368 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create segments†ist");

2369 
”r
;

2371 if((
¡©e
->
tx
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

2373 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot createx†ist");

2374 
”r
;

2381 if(
	`¿ndom_u16
(&
£q
) != 0)

2383 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„andom isn");

2384 
”r
;

2386 
¡©e
->
¢d_nxt
 = 
£q
;

2388 if(
tb™
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

2389 
	`¿ndom_u16
(&
¡©e
->
id
);

2391 #iâdeà
_WIN32


2392 if((
¡©e
->
¹sock
 = 
	`sÿm³r_fd_¹sock
()è=ğ
NULL
)

2394 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„tsock");

2395 
”r
;

2399 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

2400 
¡©e
->
æags
 |ğ
TBIT_STATE_FLAG_NORESET
;

2402 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_NULL
)

2404 
nuÎ
 = 
tb™
->
d©a
;

2405 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_IPQS_SYN
)

2407 
	`¿ndom_u32
(&
¡©e
->
qs_nÚû
);

2408 
¡©e
->
qs_nÚû
 &= 0x3fffffff;

2409 
	`¿ndom_u8
(&
¡©e
->
qs_‰l
);

2413 
¡©e
->
mode
 = 
MODE_RTSOCK
;

2416 
”r
:

2418 
	}
}

2420 
	$do_tb™_h®t
(
sÿm³r_sk_t
 *
sk
)

2422 
	`tb™_»suÉ
(
sk
, 
SCAMPER_TBIT_RESULT_HALTED
);

2424 
	}
}

2426 
	$do_tb™_ä“
(
sÿm³r_sk_t
 *
sk
)

2428 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2429 if(
tb™
 =ğ
NULL
)

2431 
	`tb™_¡©e_ä“
(
sk
);

2432 
	`sÿm³r_tb™_ä“
(
tb™
);

2434 
	}
}

2436 
	$tb™_tx_tı
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_´obe_t
 *
´
,

2437 
tb™_´obe_t
 *

)

2439 
sÿm³r_´obe_İt_t
 
İt
;

2440 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2441 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2442 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
;

2443 
timev®
 
tv
;

2444 
tb™_£gm’t_t
 *
£g
;

2446 
´
->
´__´Ùo
 = 
IPPROTO_TCP
;

2447 
´
->
´_tı_¥Üt
 = 
tb™
->
¥Üt
;

2448 
´
->
´_tı_dpÜt
 = 
tb™
->
dpÜt
;

2449 
´
->
´_tı_£q
 = 
¡©e
->
¢d_nxt
;

2450 
´
->
´_tı_wš
 = 65535;

2452 if(
¡©e
->
mode
 =ğ
MODE_SYN
)

2454 
´
->
´_tı_æags
 = 
TH_SYN
;

2455 
´
->
´_tı_mss
 = 
tb™
->
ş›Á_mss
;

2457 
tb™
->
ty³
)

2459 
SCAMPER_TBIT_TYPE_ECN
:

2460 
´
->
´_tı_æags
 |ğ(
TH_ECE
|
TH_CWR
);

2463 
SCAMPER_TBIT_TYPE_SACK_RCVR
:

2464 
´
->
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_SACK
;

2467 
SCAMPER_TBIT_TYPE_NULL
:

2468 
nuÎ
 = 
tb™
->
d©a
;

2469 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_TCPTS
)

2471 
	`g‘timeofday_w¿p
(&
tv
);

2472 
´
->
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_TS
;

2473 
´
->
´_tı_tsv®
 = 
	`timev®_diff_ms
(&
tv
, &
tb™
->
¡¬t
);

2475 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_SACK
)

2477 
´
->
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_SACK
;

2479 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_IPTS_SYN
)

2481 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4TSO
;

2482 
´
->
´_İts
 = &
İt
;

2483 
´
->
´_İtc
 = 1;

2485 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_IPRR_SYN
)

2487 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V4RR
;

2488 
´
->
´_İts
 = &
İt
;

2489 
´
->
´_İtc
 = 1;

2491 if(
nuÎ
->
İtiÚs
 & 
SCAMPER_TBIT_NULL_OPTION_IPQS_SYN
)

2493 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_QUICKSTART
;

2494 
İt
.
İt_qs_func
 = 0;

2495 
İt
.
İt_qs_¿‹
 = 2;

2496 
İt
.
İt_qs_‰l
 = 
¡©e
->
qs_‰l
;

2497 
İt
.
İt_qs_nÚû
 = 
¡©e
->
qs_nÚû
;

2498 
´
->
´_İts
 = &
İt
;

2499 
´
->
´_İtc
 = 1;

2504 
¡©e
->
©‹m±
++;

2508 if(

 !ğ
NULL
)

2510 if(

->
_Ën
 > 0)

2512 if((
£g
 = 
	`¦i¡_h—d_g‘
(
¡©e
->
£gm’ts
)è=ğ
NULL
)

2515 
´
->
´_d©a
 = 
£g
->
d©a
 + (

->
_£q
 - 
¡©e
->
¢d_nxt
);

2516 
´
->
´_Ën
 = 

->
_Ën
;

2517 
¡©e
->
©‹m±
++;

2519 
´
->
´_tı_£q
 = 

->
_£q
;

2520 
´
->
´_tı_ack
 = 

->
_ack
;

2521 
´
->
´_tı_æags
 = 

->
_æags
;

2523 if(

->
_§ckb
 > 0)

2525 
´
->
´_tı_§ckb
 = 

->
_§ckb
;

2526 
	`memıy
(
´
->
´_tı_§ck
, 

->
_§ck
, 32);

2531 
´
->
´_tı_ack
 = 
¡©e
->
rcv_nxt
;

2532 
´
->
´_tı_æags
 = 
TH_ACK
;

2533 if(
¡©e
->
mode
 =ğ
MODE_FIN
)

2534 
´
->
´_tı_æags
 |ğ
TH_FIN
;

2537 if(
¡©e
->
æags
 & 
TBIT_STATE_FLAG_TCPTS
)

2539 
	`g‘timeofday_w¿p
(&
tv
);

2540 
´
->
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_TS
;

2541 
´
->
´_tı_tsv®
 = 
	`timev®_diff_ms
(&
tv
, &
tb™
->
¡¬t
);

2542 
´
->
´_tı_t£ü
 = 
¡©e
->
ts_»ûÁ
;

2543 
¡©e
->
ts_Ï¡ack
 = 
´
->
´_tı_ack
;

2547 if(
tb™
->
ty³
 =ğ
SCAMPER_TBIT_TYPE_ECN
 &&

2548 (
´
->
´_tı_æags
 & 
TH_FIN
è=ğ0 &&…r->
´_Ën
 > 0)

2550 if((
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CE_SET
) != 0)

2551 
´
->
´__tos
 = 
IPTOS_ECN_CE
;

2552 if((
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_ECT
) != 0)

2553 
´
->
´__tos
 = 
IPTOS_ECN_ECT1
;

2555 if(
¡©e
->
eú_æags
 & 
TBIT_STATE_ECN_FLAG_CWR_SET
)

2556 
´
->
´_tı_æags
 |ğ
TH_CWR
;

2560 
	}
}

2562 
	$tb™_tx_±b
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_´obe_t
 *
´
,

2563 
tb™_´obe_t
 *

)

2565 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2566 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2567 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

2569 
	`SCAMPER_PROBE_ICMP_PTB
(
´
, 
pmtud
->
mtu
);

2571 if(
pmtud
->
±b¤c
 !ğ
NULL
)

2572 
´
->
´__¤c
 = 
pmtud
->
±b¤c
;

2574 
´
->
´_d©a
 = 
¡©e
->
pmtud_±b_d©a
;

2575 
´
->
´_Ën
 = 
¡©e
->
pmtud_±b_d©®’
;

2576 
¡©e
->
©‹m±
++;

2577 
¡©e
->
pmtud_±b_c
++;

2580 
	}
}

2582 
	$do_tb™_´obe
(
sÿm³r_sk_t
 *
sk
)

2584 
sÿm³r_fœew®l_ruË_t
 
sfw
;

2585 
sÿm³r_tb™_t
 *
tb™
 = 
	`tb™_g‘d©a
(
sk
);

2586 
tb™_¡©e_t
 *
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2587 
sÿm³r_tb™_pkt_t
 *
pkt
;

2588 
sÿm³r_´obe_t
 
´obe
;

2589 
tb™_´obe_t
 *

;

2590 
wa™
, 
rc
;

2592 if(
¡©e
 =ğ
NULL
)

2595 
	`g‘timeofday_w¿p
(&
tb™
->
¡¬t
);

2598 if(
	`tb™_¡©e_®loc
(
sk
) != 0)

2599 
”r
;

2601 
¡©e
 = 
	`tb™_g‘¡©e
(
sk
);

2604 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
)

2606 
¡©e
->
rou‹
 = 
	`sÿm³r_rou‹_®loc
(
tb™
->
d¡
, 
sk
, 
tb™_hªdË_¹
);

2607 if(
¡©e
->
rou‹
 =ğ
NULL
)

2608 
”r
;

2610 #iâdeà
_WIN32


2611 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
¹sock
, s‹->
rou‹
) != 0)

2612 
”r
;

2614 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
rou‹
) != 0)

2615 
”r
;

2618 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

2621 if(
¡©e
->
mode
 !ğ
MODE_FIREWALL
)

2623 
	`sÿm³r_sk_queue_wa™
(
sk
, 1000);

2628 if(
¡©e
->
mode
 =ğ
MODE_FIREWALL
)

2630 
sfw
.
ty³
 = 
SCAMPER_FIREWALL_RULE_TYPE_5TUPLE
;

2631 
sfw
.
sfw_5tu¶e_´Ùo
 = 
IPPROTO_TCP
;

2632 
sfw
.
sfw_5tu¶e_¤c
 = 
tb™
->
d¡
;

2633 
sfw
.
sfw_5tu¶e_d¡
 = 
tb™
->
¤c
;

2634 
sfw
.
sfw_5tu¶e_¥Üt
 = 
tb™
->
dpÜt
;

2635 
sfw
.
sfw_5tu¶e_dpÜt
 = 
tb™
->
¥Üt
;

2637 if((
¡©e
->
fw
 = 
	`sÿm³r_fœew®l_’Œy_g‘
(&
sfw
)è=ğ
NULL
)

2639 
	`sÿm³r_debug
(
__func__
, "could‚ot get firewallƒntry");

2640 
”r
;

2643 
¡©e
->
mode
 = 
MODE_SYN
;

2646 
	`mem£t
(&
´obe
, 0, (probe));

2649 
´obe
.
´_dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
dl
);

2650 
´obe
.
´_dl_buf
 = 
¡©e
->
dlhdr
->
buf
;

2651 
´obe
.
´_dl_Ën
 = 
¡©e
->
dlhdr
->
Ën
;

2652 
´obe
.
´__¤c
 = 
tb™
->
¤c
;

2653 
´obe
.
´__d¡
 = 
tb™
->
d¡
;

2654 
´obe
.
´__‰l
 = 255;

2656 if(
tb™
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

2658 
´obe
.
´__id
 = 
¡©e
->
id
++;

2659 
´obe
.
´__off
 = 
IP_DF
;

2662 if((

 = 
	`¦i¡_h—d_pİ
(
¡©e
->
tx
)è!ğ
NULL
)

2664 if(

->
ty³
 =ğ
TBIT_PROBE_TYPE_TCP
)

2665 
rc
 = 
	`tb™_tx_tı
(
sk
, &
´obe
, 

);

2666 if(

->
ty³
 =ğ
TBIT_PROBE_TYPE_PTB
)

2667 
rc
 = 
	`tb™_tx_±b
(
sk
, &
´obe
, 

);

2669 
rc
 = 0;

2670 
wa™
 = 

->wait;

2671 
	`_ä“
(

);

2675 
rc
 = 
	`tb™_tx_tı
(
sk
, &
´obe
, 
NULL
);

2676 
wa™
 = 
TBIT_TIMEOUT_DEFAULT
;

2679 if(
rc
 == 0)

2681 
	`tb™_queue
(
sk
);

2686 if(
	`sÿm³r_´obe
(&
´obe
) != 0)

2688 
”ºo
 = 
´obe
.
´_”ºo
;

2689 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send…robe");

2690 
”r
;

2693 if((
pkt
 = 
	`sÿm³r_tb™_pkt_®loc
(
SCAMPER_TBIT_PKT_DIR_TX
, 
´obe
.
´_tx_¿w
,

2694 
´obe
.
´_tx_¿wËn
, &´obe.
´_tx
))==
NULL
 ||

2695 
	`sÿm³r_tb™_»cÜd_pkt
(
tb™
, 
pkt
) != 0)

2697 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecord…acket");

2698 
”r
;

2701 if(
wa™
 > 0)

2702 
	`timev®_add_ms
(&
¡©e
->
timeout
, &
´obe
.
´_tx
, 
wa™
);

2704 
	`tb™_queue
(
sk
);

2707 
”r
:

2708 
	`tb™_hªdË”rÜ
(
sk
, 
”ºo
);

2710 
	}
}

2712 
	$tb™_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

2714 
tmp
;

2716 
İtid
)

2718 
TBIT_OPT_TYPE
:

2719 if(
	`¡rÿ£cmp
(
·¿m
, "pmtud") == 0)

2720 
tmp
 = 
SCAMPER_TBIT_TYPE_PMTUD
;

2721 if(
	`¡rÿ£cmp
(
·¿m
, "ecn") == 0)

2722 
tmp
 = 
SCAMPER_TBIT_TYPE_ECN
;

2723 if(
	`¡rÿ£cmp
(
·¿m
, "null") == 0)

2724 
tmp
 = 
SCAMPER_TBIT_TYPE_NULL
;

2725 if(
	`¡rÿ£cmp
(
·¿m
, "sack-rcvr") == 0)

2726 
tmp
 = 
SCAMPER_TBIT_TYPE_SACK_RCVR
;

2728 
”r
;

2731 
TBIT_OPT_APP
:

2732 if(
	`¡rÿ£cmp
(
·¿m
, "smtp") == 0)

2733 
tmp
 = 
SCAMPER_TBIT_APP_SMTP
;

2734 if(
	`¡rÿ£cmp
(
·¿m
, "http") == 0)

2735 
tmp
 = 
SCAMPER_TBIT_APP_HTTP
;

2736 if(
	`¡rÿ£cmp
(
·¿m
, "dns") == 0)

2737 
tmp
 = 
SCAMPER_TBIT_APP_DNS
;

2738 if(
	`¡rÿ£cmp
(
·¿m
, "ftp") == 0)

2739 
tmp
 = 
SCAMPER_TBIT_APP_FTP
;

2741 
”r
;

2744 
TBIT_OPT_SPORT
:

2745 
TBIT_OPT_DPORT
:

2746 
TBIT_OPT_MSS
:

2747 
TBIT_OPT_MTU
:

2748 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0 ||mp > 65535)

2749 
”r
;

2752 
TBIT_OPT_USERID
:

2753 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

2754 
”r
;

2757 
TBIT_OPT_PTBSRC
:

2758 
TBIT_OPT_OPTION
:

2759 
TBIT_OPT_URL
:

2760 
TBIT_OPT_SRCADDR
:

2761 
tmp
 = 0;

2769 if(
out
 !ğ
NULL
)

2770 *
out
 = 
tmp
;

2773 
”r
:

2775 
	}
}

2777 
	$sÿm³r_do_tb™_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

2779  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

2780 
tb™_¬g_·¿m_v®id©e
);

2781 
	}
}

2783 
	$tb™_­p_sm
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2785 if(
tb™
->
dpÜt
 == 0)

2786 
tb™
->
dpÜt
 = 25;

2788 
	}
}

2790 
	$tb™_­p_dns
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2792 if(
tb™
->
dpÜt
 == 0)

2793 
tb™
->
dpÜt
 = 53;

2795 
	}
}

2797 
	$tb™_­p_áp
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2799 if(
tb™
->
dpÜt
 == 0)

2800 
tb™
->
dpÜt
 = 21;

2802 
	}
}

2804 
	$tb™_­p_h‰p
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2806 *
ho¡
;

2807 *
fe
;

2808 *
±r
;

2810 if(
tb™
->
dpÜt
 == 0)

2811 
tb™
->
dpÜt
 = 80;

2813 if(
o
->
u¾
 =ğ
NULL
)

2815 
ho¡
 = 
NULL
; 
fe
 = "/";

2816 
dÚe
;

2819 if(
	`¡ºÿ£cmp
(
o
->
u¾
, "http://", 7) != 0)

2823 
ho¡
 = 
±r
 = 
o
->
u¾
+7;

2824 *
±r
 != '\0')

2826 if(*
±r
 == '/') ;

2827 if(
	`i§Êum
(()*
±r
) == 0 && *ptr != '-' && *ptr != '.')  -1;

2828 
±r
++;

2830 if(
±r
 =ğ
ho¡
)

2833 if(*
±r
 == '\0')

2835 
fe
 = "/";

2839 
	`memmove
(
ho¡
-1, ho¡, 
±r
-host);

2840 
ho¡
--;

2841 *(
±r
-1) = '\0';

2842 
fe
 = 
±r
;

2845 
dÚe
:

2846 if((
tb™
->
­p_d©a
 = 
	`sÿm³r_tb™_­p_h‰p_®loc
(
ho¡
, 
fe
)è=ğ
NULL
)

2849 
	}
}

2851 
	$tb™_®loc_pmtud
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2853 
sÿm³r_tb™_pmtud_t
 *
pmtud
;

2854 
af
;

2856 if((
pmtud
 = 
	`sÿm³r_tb™_pmtud_®loc
()è=ğ
NULL
)

2858 
tb™
->
d©a
 = 
pmtud
;

2860 if(
o
->
mtu
 == 0)

2861 
pmtud
->
mtu
 = 1280;

2863 
pmtud
->
mtu
 = 
o
->mtu;

2865 if(
o
->
±b¤c
 !ğ
NULL
)

2867 
af
 = 
	`sÿm³r_addr_af
(
tb™
->
d¡
);

2868 if(
af
 !ğ
AF_INET
 &&‡à!ğ
AF_INET6
)

2870 
pmtud
->
±b¤c
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, 
o
->ptbsrc);

2871 if(
pmtud
->
±b¤c
 =ğ
NULL
 ||…mtud->±b¤c->
ty³
 !ğ
tb™
->
d¡
->type)

2876 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_BLACKHOLE
)

2877 
pmtud
->
İtiÚs
 |ğ
SCAMPER_TBIT_PMTUD_OPTION_BLACKHOLE
;

2879 
pmtud
->
±b_»tx
 = 4;

2882 
	}
}

2884 
	$tb™_®loc_nuÎ
(
sÿm³r_tb™_t
 *
tb™
, 
tb™_İtiÚs_t
 *
o
)

2886 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
;

2887 
ušt16_t
 
u
;

2890 
u
 = (
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_IPOPT_SYN_MASK
);

2891 if(
u
 !ğ0 && 
	`couÁb™s32
(u) != 1)

2894 if((
nuÎ
 = 
	`sÿm³r_tb™_nuÎ_®loc
()è=ğ
NULL
)

2896 
tb™
->
d©a
 = 
nuÎ
;

2898 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_TCPTS
)

2899 
nuÎ
->
İtiÚs
 |ğ
SCAMPER_TBIT_NULL_OPTION_TCPTS
;

2900 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_SACK
)

2901 
nuÎ
->
İtiÚs
 |ğ
SCAMPER_TBIT_NULL_OPTION_SACK
;

2902 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_IPQS_SYN
)

2903 
nuÎ
->
İtiÚs
 |ğ
SCAMPER_TBIT_NULL_OPTION_IPQS_SYN
;

2905 if(
o
->
İtiÚs
 & (
TBIT_OPT_OPTION_IPTS_SYN
 | 
TBIT_OPT_OPTION_IPRR_SYN
))

2907 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
tb™
->
d¡
) == 0)

2910 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_IPTS_SYN
)

2911 
nuÎ
->
İtiÚs
 |ğ
SCAMPER_TBIT_NULL_OPTION_IPTS_SYN
;

2912 if(
o
->
İtiÚs
 & 
TBIT_OPT_OPTION_IPRR_SYN
)

2913 
nuÎ
->
İtiÚs
 |ğ
SCAMPER_TBIT_NULL_OPTION_IPRR_SYN
;

2917 
	}
}

2925 *
	$sÿm³r_do_tb™_®loc
(*
¡r
)

2927 (* cÚ¡ 
ty³_func
[])(
sÿm³r_tb™_t
 *, 
tb™_İtiÚs_t
 *) = {

2928 
NULL
,

2929 
tb™_®loc_pmtud
,

2930 
NULL
,

2931 
tb™_®loc_nuÎ
,

2932 
NULL
,

2934 (* cÚ¡ 
­p_func
[])(
sÿm³r_tb™_t
 *, 
tb™_İtiÚs_t
 *) = {

2935 
NULL
,

2936 
tb™_­p_h‰p
,

2937 
tb™_­p_sm
,

2938 
tb™_­p_dns
,

2939 
tb™_­p_áp
,

2941 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

2942 
sÿm³r_tb™_t
 *
tb™
 = 
NULL
;

2943 
tb™_İtiÚs_t
 
o
;

2944 
ušt8_t
 
ty³
 = 
SCAMPER_TBIT_TYPE_PMTUD
;

2945 
ušt32_t
 
u£rid
 = 0;

2946 *
addr
;

2947 
tmp
 = 0;

2948 
af
;

2950 
	`mem£t
(&
o
, 0, (o));

2953 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

2955 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse options");

2956 
”r
;

2960 if(
addr
 =ğ
NULL
)

2962 
	`sÿm³r_debug
(
__func__
, "no‡ddress…arameter");

2963 
”r
;

2967 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

2969 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

2970 
	`tb™_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

2972 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

2973 
”r
;

2976 
İt
->
id
)

2978 
TBIT_OPT_TYPE
:

2979 
ty³
 = (
ušt8_t
)
tmp
;

2982 
TBIT_OPT_APP
:

2983 
o
.
­p
 = (
ušt8_t
)
tmp
;

2986 
TBIT_OPT_DPORT
:

2987 
o
.
dpÜt
 = (
ušt16_t
)
tmp
;

2990 
TBIT_OPT_SPORT
:

2991 
o
.
¥Üt
 = (
ušt16_t
)
tmp
;

2994 
TBIT_OPT_MSS
:

2995 
o
.
mss
 = (
ušt16_t
)
tmp
;

2998 
TBIT_OPT_MTU
:

2999 
o
.
mtu
 = (
ušt16_t
)
tmp
;

3002 
TBIT_OPT_SRCADDR
:

3003 
o
.
¤c
 = 
İt
->
¡r
;

3006 
TBIT_OPT_URL
:

3007 
o
.
u¾
 = 
İt
->
¡r
;

3010 
TBIT_OPT_USERID
:

3011 
u£rid
 = (
ušt32_t
)
tmp
;

3014 
TBIT_OPT_PTBSRC
:

3015 
o
.
±b¤c
 = 
İt
->
¡r
;

3018 
TBIT_OPT_OPTION
:

3019 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "blackhole") == 0)

3020 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_BLACKHOLE
;

3021 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "tcpts") == 0)

3022 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_TCPTS
;

3023 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "ipts-syn") == 0)

3024 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_IPTS_SYN
;

3025 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "iprr-syn") == 0)

3026 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_IPRR_SYN
;

3027 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "ipqs-syn") == 0)

3028 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_IPQS_SYN
;

3029 if(
	`¡rÿ£cmp
(
İt
->
¡r
, "sack") == 0)

3030 
o
.
İtiÚs
 |ğ
TBIT_OPT_OPTION_SACK
;

3032 
”r
;

3036 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

3038 if(
ty³
 =ğ
SCAMPER_TBIT_TYPE_SACK_RCVR
)

3040 if(
o
.
d©_»tx
 != 0 && o.dat_retx != 1)

3041 
”r
;

3042 if(
o
.
d©_»tx
 == 0)

3043 
o
.
d©_»tx
 = 1;

3046 if((
tb™
 = 
	`sÿm³r_tb™_®loc
()è=ğ
NULL
)

3048 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocbit");

3049 
”r
;

3051 if((
tb™
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
)è=ğ
NULL
)

3053 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù„esŞv%s", 
addr
);

3054 
”r
;

3056 
tb™
->
ty³
 =ype;

3057 
tb™
->
u£rid
 = userid;

3058 
tb™
->
ş›Á_mss
 = 
o
.
mss
;

3059 
tb™
->
dpÜt
 = 
o
.dport;

3060 
tb™
->
¥Üt
 = (
o
.¥Üˆ!ğ0è? o.¥Üˆ: 
	`sÿm³r_¥Üt_deçuÉ
();

3061 
tb™
->
syn_»tx
 = (
o
.syn_»tx !ğ0è? o.syn_»tx : 
TBIT_RETX_DEFAULT
;

3062 
tb™
->
d©_»tx
 = (
o
.d©_»tx !ğ0è? o.d©_»tx : 
TBIT_RETX_DEFAULT
;

3064 if(
o
.
¤c
 !ğ
NULL
)

3066 
af
 = 
	`sÿm³r_addr_af
(
tb™
->
d¡
);

3067 if(
af
 !ğ
AF_INET
 &&‡à!ğ
AF_INET6
)

3068 
”r
;

3069 if((
tb™
->
¤c
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, 
o
.¤c)è=ğ
NULL
)

3070 
”r
;

3073 if(
o
.
­p
 =ğ0èo.­°ğ
SCAMPER_TBIT_APP_HTTP
;

3074 
tb™
->
­p_´Ùo
 = 
o
.
­p
;

3075 if(
­p_func
[
o
.
­p
] !ğ
NULL
 &&‡µ_func[o.­p](
tb™
, &o) != 0)

3076 
”r
;

3078 if(
ty³_func
[
ty³
] !ğ
NULL
 &&y³_func[ty³](
tb™
, &
o
) != 0)

3079 
”r
;

3081  
tb™
;

3083 
”r
:

3084 if(
tb™
 !ğ
NULL
è
	`sÿm³r_tb™_ä“
(tbit);

3085 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

3086  
NULL
;

3087 
	}
}

3089 
	$sÿm³r_do_tb™_ä“
(*
d©a
)

3091 
sÿm³r_tb™_t
 *
tb™
 = (sÿm³r_tb™_ˆ*)
d©a
;

3092 
	`sÿm³r_tb™_ä“
(
tb™
);

3094 
	}
}

3096 
sÿm³r_sk_t
 *
	$sÿm³r_do_tb™_®loùask
(*
d©a
, 
sÿm³r_li¡_t
 *
li¡
,

3097 
sÿm³r_cyşe_t
 *
cyşe
)

3099 
sÿm³r_tb™_t
 *
tb™
 = (sÿm³r_tb™_ˆ*)
d©a
;

3100 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

3101 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

3104 if((
sk
 = 
	`sÿm³r_sk_®loc
(
d©a
, &
tb™_funcs
)è=ğ
NULL
)

3105 
”r
;

3108 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

3109 
”r
;

3110 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
tb™
->
d¡
);

3111 if(
tb™
->
¤c
 =ğ
NULL
 && (tb™->¤øğ
	`sÿm³r_g‘¤c
Ñb™->
d¡
,0)) == NULL)

3112 
”r
;

3113 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
tb™
->
¤c
);

3114 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

3115 
”r
;

3116 
sig
 = 
NULL
;

3119 
tb™
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

3120 
tb™
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

3122  
sk
;

3124 
”r
:

3125 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

3126 if(
sk
 !ğ
NULL
)

3128 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

3129 
	`sÿm³r_sk_ä“
(
sk
);

3131  
NULL
;

3132 
	}
}

3134 
	$sÿm³r_do_tb™_ş—nup
()

3137 
	}
}

3139 
	$sÿm³r_do_tb™_š™
()

3141 
tb™_funcs
.
´obe
 = 
do_tb™_´obe
;

3142 
tb™_funcs
.
hªdË_icmp
 = 
NULL
;

3143 
tb™_funcs
.
hªdË_dl
 = 
do_tb™_hªdË_dl
;

3144 
tb™_funcs
.
hªdË_timeout
 = 
do_tb™_hªdË_timeout
;

3145 
tb™_funcs
.
wr™e
 = 
do_tb™_wr™e
;

3146 
tb™_funcs
.
sk_ä“
 = 
do_tb™_ä“
;

3147 
tb™_funcs
.
h®t
 = 
do_tb™_h®t
;

3150 
	}
}

	@tbit/scamper_tbit_do.h

31 #iâdeà
__SCAMPER_DO_TBIT_H


32 
	#__SCAMPER_DO_TBIT_H


	)

34 cÚ¡ *
sÿm³r_do_tb™_u§ge
();

36 *
sÿm³r_do_tb™_®loc
(*
¡r
);

38 
sÿm³r_do_tb™_ä“
(*
d©a
);

40 
sÿm³r_sk_t
 *
sÿm³r_do_tb™_®loùask
(*
d©a
,

41 
sÿm³r_li¡_t
 *
li¡
,

42 
sÿm³r_cyşe_t
 *
cyşe
);

44 
sÿm³r_do_tb™_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

46 
sÿm³r_do_tb™_ş—nup
();

47 
sÿm³r_do_tb™_š™
();

	@tbit/scamper_tbit_text.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_fe.h
"

37 
	~"sÿm³r_tb™.h
"

38 
	~"sÿm³r_tb™_‹xt.h
"

39 
	~"uts.h
"

41 
	$sÿm³r_fe_‹xt_tb™_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

42 cÚ¡ 
sÿm³r_tb™_t
 *
tb™
)

44 
sÿm³r_tb™_pkt_t
 *
pkt
;

45 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
;

46 
buf
[131072];

47 
¤c
[64], 
d¡
[64], 
tmp
[256], 
id
[12], 
f¡r
[32], 
tf¡r
[32], 
§ck
[128];

48 
timev®
 
diff
;

49 
ušt32_t
 
i
;

50 
ušt32_t
 
£q
, 
ack
, 
£rv”_i¢
, 
ş›Á_i¢
, 
off
, 
id
, 
u32
;

51 
ušt16_t
 
Ën
, 
u16
, 
d©®’
;

52 
ušt8_t
 
´Ùo
, 
æags
, 
hËn
, 
tıhËn
, 
mf
, 
eú
, 
u8
, *
±r
;

53 
size_t
 
soff
 = 0, 
toff
;

54 
äag
;

55 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

57 
id
[0] = '\0';

59 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
,

61 
	`sÿm³r_addr_to¡r
(
tb™
->
¤c
, src, (src)),

62 
	`sÿm³r_addr_to¡r
(
tb™
->
d¡
, dst, (dst)),

63 
tb™
->
£rv”_mss
,

64 
	`sÿm³r_tb™_»s2¡r
(
tb™
, 
tmp
, (tmp)));

66 if(
tb™
->
­p_´Ùo
 =ğ
SCAMPER_TBIT_APP_HTTP
 &&b™->
­p_d©a
 !ğ
NULL
)

68 
h‰p
 = 
tb™
->
­p_d©a
;

69 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, "‡pp: http");

70 if(
h‰p
->
ho¡
 !ğ
NULL
 && h‰p->
fe
 != NULL)

71 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, ", url: http://%s%s",

72 
h‰p
->
ho¡
, h‰p->
fe
);

73 if(
h‰p
->
ho¡
 !ğ
NULL
)

74 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, ", u¾: h‰p://%s", 
h‰p
->
ho¡
);

76 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, ", fe: %s", 
h‰p
->
fe
);

77 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, "\n");

80 
ş›Á_i¢
 = 0;

81 
£rv”_i¢
 = 0;

83 
i
=0; i<
tb™
->
pktc
; i++)

85 
pkt
 = 
tb™
->
pkts
[
i
];

86 
äag
 = 0; 
mf
 = 0; 
id
 = 0; 
off
 = 0;

88 if((
pkt
->
d©a
[0] >> 4) == 4)

90 
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

91 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

92 
´Ùo
 = 
pkt
->
d©a
[9];

93 
eú
 = 
pkt
->
d©a
[1] & 0x3;

94 if(
pkt
->
d©a
[6] & 0x20)

95 
mf
 = 1;

96 
id
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4);

97 
off
 = (
	`by‹s_Áohs
(
pkt
->
d©a
+6) & 0x1fff) * 8;

98 if(
mf
 !ğ0 || 
off
 != 0)

99 
äag
 = 1;

100 
	`¢´štf
(
id
, (id), " %04x", 
	`by‹s_Áohs
(
pkt
->
d©a
+4));

102 if((
pkt
->
d©a
[0] >> 4) == 6)

104 
hËn
 = 40;

105 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4è+ 
hËn
;

106 
´Ùo
 = 
pkt
->
d©a
[6];

107 
eú
 = (
pkt
->
d©a
[1] & 0x30) >> 4;

111 
´Ùo
)

113 
IPPROTO_HOPOPTS
:

114 
IPPROTO_DSTOPTS
:

115 
IPPROTO_ROUTING
:

116 
´Ùo
 = 
pkt
->
d©a
[
hËn
+0];

117 
hËn
 +ğ(
pkt
->
d©a
[iphlen+1] * 8) + 8;

120 
IPPROTO_FRAGMENT
:

121 if(
pkt
->
d©a
[
hËn
+3] & 0x1)

122 
mf
 = 1;

123 
off
 = (
	`by‹s_Áohs
(
pkt
->
d©a
+
hËn
+2) & 0xfff8);

124 
id
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+4);

125 
´Ùo
 = 
pkt
->
d©a
[
hËn
+0];

126 
hËn
 += 8;

127 
äag
 = 1;

138 
	`timev®_diff_tv
(&
diff
, &
tb™
->
¡¬t
, &
pkt
->
tv
);

139 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, " [%3d.%03d] %s ",

140 ()
diff
.
tv_£c
, ()(diff.
tv_u£c
 / 1000),

141 
pkt
->
dœ
 =ğ
SCAMPER_TBIT_PKT_DIR_TX
 ? "TX" : "RX");

143 if(
äag
 != 0)

144 
	`¢´štf
(
f¡r
,(f¡r),"%u:%u%s", 
id
, 
off
, 
mf
 != 0 ? " MF" : "");

146 
f¡r
[0] = '\0';

148 if(
off
 != 0)

150 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
,

151 "%-13 %4dF%21 % %s", "", 
Ën
, "", 
id
, 
f¡r
);

153 if(
´Ùo
 =ğ
IPPROTO_TCP
)

155 
£q
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+4);

156 
ack
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+8);

157 
æags
 = 
pkt
->
d©a
[
hËn
+13];

158 
tıhËn
 = ((
pkt
->
d©a
[
hËn
+12] & 0xf0) >> 4) * 4;

160 
toff
 = 0; 
tf¡r
[0] = '\0';

161 if(
æags
 & 0x2)

163 if(
æags
 & 0x10)

165 
£rv”_i¢
 = 
£q
;

166 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "SYN/ACK");

170 
ş›Á_i¢
 = 
£q
;

171 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "SYN");

174 if(
æags
 & 0x1)

175 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "FIN");

176 if(
æags
 & 0x4)

177 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "RST");

178 if(
æags
 & 0x40)

179 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "%sECE",

180 
toff
 != 0 ? "/" : "");

181 if(
æags
 & 0x80)

182 
	`¡ršg_cÚÿt
(
tf¡r
, Ñf¡r), &
toff
, "%sCWR",

183 
toff
 != 0 ? "/" : "");

186 
u8
 = 20; 
toff
 = 0; 
§ck
[0] = '\0';

187 
u8
 < 
tıhËn
)

189 
±r
 = 
pkt
->
d©a
 + 
hËn
 + 
u8
;

191 if(
±r
[0] == 0)

194 if(
±r
[0] == 1)

196 
u8
++;

200 if(
±r
[1] =ğ0 || 
u8
 +…Œ[1] > 
tıhËn
)

204 if(
±r
[0] == 5 &&

205 (
±r
[1]==10 ||…tr[1]==18 ||…tr[1]==26 ||…tr[1]==34))

207 if(
pkt
->
dœ
 =ğ
SCAMPER_TBIT_PKT_DIR_TX
)

208 
u32
 = 
£rv”_i¢
;

210 
u32
 = 
ş›Á_i¢
;

212 
	`¡ršg_cÚÿt
(
§ck
, (§ck), &
toff
, " {");

213 
u16
=0; u16<(
±r
[1]-2)/8; u16++)

214 
	`¡ršg_cÚÿt
(
§ck
, (§ck), &
toff
, "%s%u:%u",

215 
u16
 != 0 ? "," : "",

216 
	`by‹s_Áohl
(
±r
+2+(
u16
*8)è- 
u32
,

217 
	`by‹s_Áohl
(
±r
+2+(
u16
*8)+4è- 
u32
);

218 
	`¡ršg_cÚÿt
(
§ck
, (§ck), &
toff
, "}");

221 
u8
 +ğ
±r
[1];

224 if(
pkt
->
dœ
 =ğ
SCAMPER_TBIT_PKT_DIR_TX
)

226 
£q
 -ğ
ş›Á_i¢
 + ((£q >ğş›Á_i¢è? 0 : 
TCP_MAX_SEQNUM
+1);

227 
ack
 -ğ
£rv”_i¢
 + (×ck >ğ£rv”_i¢è? 0 : 
TCP_MAX_SEQNUM
+1);

231 
£q
 -ğ
£rv”_i¢
 + ((£q >ğ£rv”_i¢è? 0 : 
TCP_MAX_SEQNUM
+1);

232 
ack
 -ğ
ş›Á_i¢
 + (×ck >ğş›Á_i¢è? 0 : 
TCP_MAX_SEQNUM
+1);

235 
d©®’
 = 
Ën
 - 
hËn
 - 
tıhËn
;

237 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, "%-13s %4d%s",

238 
tf¡r
, 
Ën
, 
äag
 != 0 ? "F" : " ");

240 
toff
 = 0;

241 
	`¡ršg_cÚÿt
(
tmp
, Ñmp), &
toff
, " seq = %u:%u", 
£q
, 
ack
);

242 if(
d©®’
 != 0)

243 
	`¡ršg_cÚÿt
(
tmp
, Ñmp), &
toff
, "(%d)", 
d©®’
);

244 
	`¡ršg_cÚÿt
(
tmp
, Ñmp), &
toff
, 
§ck
);

245 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, "%-23s%s", 
tmp
, 
id
);

246 if(
äag
 !ğ0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, 
f¡r
);

247 if(
d©®’
 > 0 && (
pkt
->
d©a
[0] >> 4) == 4 &&…kt->data[6] & 0x40)

248 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, " DF");

249 if(
eú
 =ğ3è
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, " CE");

250 if(
eú
 !ğ0è
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, " ECT");

252 if(
´Ùo
 =ğ
IPPROTO_ICMP
)

254 if(
pkt
->
d©a
[
hËn
+0] == 3 &&…kt->data[iphlen+1] == 4)

256 
u16
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+
hËn
+6);

257 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
,

258 "%-13 %4d mtu = %d", "PTB", 
Ën
, 
u16
);

261 if(
´Ùo
 =ğ
IPPROTO_ICMPV6
)

263 if(
pkt
->
d©a
[
hËn
+0] == 2)

265 
u32
 = 
	`by‹s_Áohl
(
pkt
->
d©a
+
hËn
+4);

266 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
,

267 "%-13 %4d mtu = %d", "PTB", 
Ën
, 
u32
);

271 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
, "\n");

274 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
soff
);

276 
	}
}

	@tbit/scamper_tbit_text.h

32 #iâdeà
__SCAMPER_FILE_TEXT_TBIT_H


33 
	#__SCAMPER_FILE_TEXT_TBIT_H


	)

35 
sÿm³r_fe_‹xt_tb™_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

36 cÚ¡ 
sÿm³r_tb™_t
 *
tb™
);

	@tbit/scamper_tbit_warts.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_icm³xt.h
"

38 
	~"sÿm³r_tb™.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_fe_w¬ts.h
"

41 
	~"sÿm³r_tb™_w¬ts.h
"

42 
	~"uts.h
"

48 
	#WARTS_TBIT_STRUCT_EOF
 0x0000

	)

49 
	#WARTS_TBIT_STRUCT_TYPE
 0x0001

	)

50 
	#WARTS_TBIT_STRUCT_APP
 0x0002

	)

52 
	#WARTS_TBIT_LIST
 1

	)

53 
	#WARTS_TBIT_CYCLE
 2

	)

54 
	#WARTS_TBIT_USERID
 3

	)

55 
	#WARTS_TBIT_SRC
 4

	)

56 
	#WARTS_TBIT_DST
 5

	)

57 
	#WARTS_TBIT_SPORT
 6

	)

58 
	#WARTS_TBIT_DPORT
 7

	)

59 
	#WARTS_TBIT_START
 8

	)

60 
	#WARTS_TBIT_RESULT
 9

	)

61 
	#WARTS_TBIT_TYPE
 10

	)

62 
	#WARTS_TBIT_APPPROTO
 11

	)

63 
	#WARTS_TBIT_CMSS
 12

	)

64 
	#WARTS_TBIT_SMSS
 13

	)

65 
	#WARTS_TBIT_SYNRETX
 14

	)

66 
	#WARTS_TBIT_DATARETX
 15

	)

67 
	#WARTS_TBIT_PKTC16
 16

	)

68 
	#WARTS_TBIT_PKTC
 17

	)

70 cÚ¡ 
w¬ts_v¬_t
 
	gtb™_v¬s
[] =

72 {
WARTS_TBIT_LIST
, 4, -1},

73 {
WARTS_TBIT_CYCLE
, 4, -1},

74 {
WARTS_TBIT_USERID
, 4, -1},

75 {
WARTS_TBIT_SRC
, -1, -1},

76 {
WARTS_TBIT_DST
, -1, -1},

77 {
WARTS_TBIT_SPORT
, 2, -1},

78 {
WARTS_TBIT_DPORT
, 2, -1},

79 {
WARTS_TBIT_START
, 8, -1},

80 {
WARTS_TBIT_RESULT
, 2, -1},

81 {
WARTS_TBIT_TYPE
, 1, -1},

82 {
WARTS_TBIT_APPPROTO
, 1, -1},

83 {
WARTS_TBIT_CMSS
, 2, -1},

84 {
WARTS_TBIT_SMSS
, 2, -1},

85 {
WARTS_TBIT_SYNRETX
, 1, -1},

86 {
WARTS_TBIT_DATARETX
, 1, -1},

87 {
WARTS_TBIT_PKTC16
, 2, -1},

88 {
WARTS_TBIT_PKTC
, 4, -1},

90 
	#tb™_v¬s_mfb
 
	`WARTS_VAR_MFB
(
tb™_v¬s
)

	)

92 
	#WARTS_TBIT_PKT_DIR
 1

	)

93 
	#WARTS_TBIT_PKT_TIME
 2

	)

94 
	#WARTS_TBIT_PKT_DATALEN
 3

	)

95 
	#WARTS_TBIT_PKT_DATA
 4

	)

97 cÚ¡ 
w¬ts_v¬_t
 
	gtb™_pkt_v¬s
[] =

99 {
WARTS_TBIT_PKT_DIR
, 1, -1},

100 {
WARTS_TBIT_PKT_TIME
, 8, -1},

101 {
WARTS_TBIT_PKT_DATALEN
, 2, -1},

102 {
WARTS_TBIT_PKT_DATA
, -1, -1},

104 
	#tb™_pkt_v¬s_mfb
 
	`WARTS_VAR_MFB
(
tb™_pkt_v¬s
)

	)

106 
	#WARTS_TBIT_PMTUD_MTU
 1

	)

107 
	#WARTS_TBIT_PMTUD_PTBRETX
 2

	)

108 
	#WARTS_TBIT_PMTUD_OPTIONS
 3

	)

109 
	#WARTS_TBIT_PMTUD_PTBSRC
 4

	)

111 cÚ¡ 
w¬ts_v¬_t
 
	gtb™_pmtud_v¬s
[] =

113 {
WARTS_TBIT_PMTUD_MTU
, 2, -1},

114 {
WARTS_TBIT_PMTUD_PTBRETX
, 1, -1},

115 {
WARTS_TBIT_PMTUD_OPTIONS
, 1, -1},

116 {
WARTS_TBIT_PMTUD_PTBSRC
, -1, -1},

118 
	#tb™_pmtud_v¬s_mfb
 
	`WARTS_VAR_MFB
(
tb™_pmtud_v¬s
)

	)

120 
	#WARTS_TBIT_NULL_OPTIONS
 1

	)

121 
	#WARTS_TBIT_NULL_RESULTS
 2

	)

123 cÚ¡ 
w¬ts_v¬_t
 
	gtb™_nuÎ_v¬s
[] =

125 {
WARTS_TBIT_NULL_OPTIONS
, 2, -1},

126 {
WARTS_TBIT_NULL_RESULTS
, 2, -1},

128 
	#tb™_nuÎ_v¬s_mfb
 
	`WARTS_VAR_MFB
(
tb™_nuÎ_v¬s
)

	)

130 
	#WARTS_TBIT_APP_HTTP_HOST
 1

	)

131 
	#WARTS_TBIT_APP_HTTP_FILE
 2

	)

133 cÚ¡ 
w¬ts_v¬_t
 
	gtb™_­p_h‰p_v¬s
[] =

135 {
WARTS_TBIT_APP_HTTP_HOST
, -1, -1},

136 {
WARTS_TBIT_APP_HTTP_FILE
, -1, -1},

138 
	#tb™_­p_h‰p_v¬s_mfb
 
	`WARTS_VAR_MFB
(
tb™_­p_h‰p_v¬s
)

	)

140 
	sw¬ts_tb™_pkt


142 
ušt8_t
 
	mæags
[
tb™_pkt_v¬s_mfb
];

143 
ušt16_t
 
	mæags_Ën
;

144 
ušt16_t
 
	m·¿ms_Ën
;

145 } 
	tw¬ts_tb™_pkt_t
;

147 
	sw¬ts_tb™_pmtud


149 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
tb™_pmtud_v¬s
)];

150 
ušt16_t
 
	mæags_Ën
;

151 
ušt16_t
 
	m·¿ms_Ën
;

152 
ušt32_t
 
	mËn
;

153 } 
	tw¬ts_tb™_pmtud_t
;

155 
	sw¬ts_tb™_nuÎ


157 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
tb™_nuÎ_v¬s
)];

158 
ušt16_t
 
	mæags_Ën
;

159 
ušt16_t
 
	m·¿ms_Ën
;

160 
ušt32_t
 
	mËn
;

161 } 
	tw¬ts_tb™_nuÎ_t
;

163 
	sw¬ts_tb™_­p_h‰p


165 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
tb™_­p_h‰p_v¬s
)];

166 
ušt16_t
 
	mæags_Ën
;

167 
ušt16_t
 
	m·¿ms_Ën
;

168 
ušt32_t
 
	mËn
;

169 } 
	tw¬ts_tb™_­p_h‰p_t
;

171 
	$w¬ts_tb™_nuÎ_·¿ms
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,

172 
w¬ts_tb™_nuÎ_t
 *
¡©e
)

174 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
 = 
tb™
->
d©a
;

175 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

176 
i
, 
max_id
 = 0;

179 
	`mem£t
(
¡©e
->
æags
, 0, 
tb™_nuÎ_v¬s_mfb
);

180 
¡©e
->
·¿ms_Ën
 = 0;

182 
i
=0; i<(
tb™_nuÎ_v¬s
)/(
w¬ts_v¬_t
); i++)

184 
v¬
 = &
tb™_nuÎ_v¬s
[
i
];

185 if(
v¬
->
id
 =ğ
WARTS_TBIT_NULL_OPTIONS
 && 
nuÎ
->
İtiÚs
 == 0)

187 if(
v¬
->
id
 =ğ
WARTS_TBIT_NULL_RESULTS
 && 
nuÎ
->
»suÉs
 == 0)

190 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

191 
	`as£¹
(
v¬
->
size
 >= 0);

192 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

195 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

197 
¡©e
->
Ën
 = s‹->
æags_Ën
 + s‹->
·¿ms_Ën
;

198 if(
¡©e
->
·¿ms_Ën
 != 0)

199 
¡©e
->
Ën
 += 2;

202 
	}
}

204 
	$w¬ts_tb™_pmtud_·¿ms
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,

205 
w¬ts_add¹abË_t
 *
bË
,

206 
w¬ts_tb™_pmtud_t
 *
¡©e
)

208 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

209 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

210 
i
, 
max_id
 = 0;

213 
	`mem£t
(
¡©e
->
æags
, 0, 
tb™_pmtud_v¬s_mfb
);

214 
¡©e
->
·¿ms_Ën
 = 0;

216 
i
=0; i<(
tb™_pmtud_v¬s
)/(
w¬ts_v¬_t
); i++)

218 
v¬
 = &
tb™_pmtud_v¬s
[
i
];

219 if(
v¬
->
id
 =ğ
WARTS_TBIT_PMTUD_MTU
 && 
pmtud
->
mtu
 == 0)

221 if(
v¬
->
id
 =ğ
WARTS_TBIT_PMTUD_PTBRETX
 && 
pmtud
->
±b_»tx
 == 0)

223 if(
v¬
->
id
 =ğ
WARTS_TBIT_PMTUD_OPTIONS
 && 
pmtud
->
İtiÚs
 == 0)

225 if(
v¬
->
id
 =ğ
WARTS_TBIT_PMTUD_PTBSRC
 && 
pmtud
->
±b¤c
 =ğ
NULL
)

228 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

230 if(
v¬
->
id
 =ğ
WARTS_TBIT_PMTUD_PTBSRC
)

232 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
pmtud
->
±b¤c
);

236 
	`as£¹
(
v¬
->
size
 >= 0);

237 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

240 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

242 
¡©e
->
Ën
 = s‹->
æags_Ën
 + s‹->
·¿ms_Ën
;

243 if(
¡©e
->
·¿ms_Ën
 != 0)

244 
¡©e
->
Ën
 += 2;

247 
	}
}

249 
	$w¬ts_tb™_nuÎ_»ad
(
sÿm³r_tb™_t
 *
tb™
, cÚ¡ 
ušt8_t
 *
buf
,

250 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

252 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
 = 
tb™
->
d©a
;

253 
ušt16_t
 
İtiÚs
 = 0;

254 
ušt16_t
 
»suÉs
 = 0;

255 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

256 {&
İtiÚs
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

257 {&
»suÉs
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

259 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

260 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

261 
”r
;

262 
nuÎ
->
İtiÚs
 = options;

263 
nuÎ
->
»suÉs
 =„esults;

264 
tb™
->
d©a
 = 
nuÎ
;

267 
”r
:

269 
	}
}

271 
	$w¬ts_tb™_nuÎ_wr™e
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, 
ušt8_t
 *
buf
,

272 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

273 
w¬ts_tb™_nuÎ_t
 *
¡©e
)

275 
sÿm³r_tb™_nuÎ_t
 *
nuÎ
 = 
tb™
->
d©a
;

276 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

277 {&
nuÎ
->
İtiÚs
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

278 {&
nuÎ
->
»suÉs
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

280 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

281 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

282 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

284 
	}
}

286 
	$w¬ts_tb™_pmtud_»ad
(
sÿm³r_tb™_t
 *
tb™
,

287 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

288 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

290 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

291 
sÿm³r_addr_t
 *
±b¤c
 = 
NULL
;

292 
ušt16_t
 
mtu
 = 0;

293 
ušt8_t
 
±b_»tx
 = 0;

294 
ušt8_t
 
İtiÚs
 = 0;

295 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

296 {&
mtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

297 {&
±b_»tx
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

298 {&
İtiÚs
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

299 {&
±b¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

301 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

303 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

304 
”r
;

306 
pmtud
->
mtu
 = mtu;

307 
pmtud
->
±b_»tx
 =…tb_retx;

308 
pmtud
->
İtiÚs
 = options;

309 
pmtud
->
±b¤c
 =…tbsrc;

311 
tb™
->
d©a
 = 
pmtud
;

314 
”r
:

316 
	}
}

318 
	$w¬ts_tb™_pmtud_wr™e
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, 
ušt8_t
 *
buf
,

319 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

320 
w¬ts_add¹abË_t
 *
bË
,

321 
w¬ts_tb™_pmtud_t
 *
¡©e
)

323 
sÿm³r_tb™_pmtud_t
 *
pmtud
 = 
tb™
->
d©a
;

324 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

325 {&
pmtud
->
mtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

326 {&
pmtud
->
±b_»tx
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

327 {&
pmtud
->
İtiÚs
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

328 {
pmtud
->
±b¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

330 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

331 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

332 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

334 
	}
}

336 
	$w¬ts_tb™_­p_h‰p_·¿ms
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,

337 
w¬ts_tb™_­p_h‰p_t
 *
¡©e
)

339 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
 = 
tb™
->
­p_d©a
;

340 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

341 
i
, 
max_id
 = 0;

344 
	`mem£t
(
¡©e
->
æags
, 0, 
tb™_­p_h‰p_v¬s_mfb
);

345 
¡©e
->
·¿ms_Ën
 = 0;

347 
i
=0; i<(
tb™_­p_h‰p_v¬s
)/(
w¬ts_v¬_t
); i++)

349 
v¬
 = &
tb™_­p_h‰p_v¬s
[
i
];

350 if(
v¬
->
id
 =ğ
WARTS_TBIT_APP_HTTP_HOST
 && 
h‰p
->
ho¡
 =ğ
NULL
)

352 if(
v¬
->
id
 =ğ
WARTS_TBIT_APP_HTTP_FILE
 && 
h‰p
->
fe
 =ğ
NULL
)

355 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

357 if(
v¬
->
size
 < 0)

359 if(
v¬
->
id
 =ğ
WARTS_TBIT_APP_HTTP_HOST
)

360 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
h‰p
->
ho¡
);

361 if(
v¬
->
id
 =ğ
WARTS_TBIT_APP_HTTP_FILE
)

362 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
h‰p
->
fe
);

366 
	`as£¹
(
v¬
->
size
 >= 0);

367 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

370 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

372 
¡©e
->
Ën
 = s‹->
æags_Ën
 + s‹->
·¿ms_Ën
;

373 if(
¡©e
->
·¿ms_Ën
 != 0)

374 
¡©e
->
Ën
 += 2;

377 
	}
}

379 
	$w¬ts_tb™_­p_h‰p_»ad
(
sÿm³r_tb™_t
 *
tb™
, cÚ¡ 
ušt8_t
 *
buf
,

380 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

382 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
;

383 *
ho¡
 = 
NULL
, *
fe
 = NULL;

384 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

385 {&
ho¡
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

386 {&
fe
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

388 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

390 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

391 
”r
;

393 if((
h‰p
 = 
	`sÿm³r_tb™_­p_h‰p_®loc
(
ho¡
, 
fe
)è=ğ
NULL
)

394 
”r
;

395 if(
ho¡
 !ğ
NULL
è{ 
	`ä“
(host); host = NULL; }

396 if(
fe
 !ğ
NULL
è{ 
	`ä“
(file); file = NULL; }

397 
tb™
->
­p_d©a
 = 
h‰p
;

400 
”r
:

401 if(
ho¡
 !ğ
NULL
è
	`ä“
(host);

402 if(
fe
 !ğ
NULL
è
	`ä“
(file);

404 
	}
}

406 
	$w¬ts_tb™_­p_h‰p_wr™e
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
, 
ušt8_t
 *
buf
,

407 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

408 
w¬ts_tb™_­p_h‰p_t
 *
¡©e
)

410 
sÿm³r_tb™_­p_h‰p_t
 *
h‰p
 = 
tb™
->
­p_d©a
;

411 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

412 {
h‰p
->
ho¡
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

413 {
h‰p
->
fe
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

415 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

416 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

417 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

419 
	}
}

421 
	$w¬ts_tb™_pkt_·¿ms
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
,

422 
w¬ts_tb™_pkt_t
 *
¡©e
, 
ušt32_t
 *
Ën
)

424 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

425 
max_id
 = 0;

426 
ušt16_t
 
i
;

428 
	`mem£t
(
¡©e
->
æags
, 0, 
tb™_pkt_v¬s_mfb
);

429 
¡©e
->
·¿ms_Ën
 = 0;

431 
i
=0; i<(
tb™_pkt_v¬s
è/ (
w¬ts_v¬_t
); i++)

433 
v¬
 = &
tb™_pkt_v¬s
[
i
];

435 if(
v¬
->
id
 =ğ
WARTS_TBIT_PKT_DATA
)

437 if(
pkt
->
Ën
 == 0)

440 
¡©e
->
·¿ms_Ën
 +ğ
pkt
->
Ën
;

441 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

445 
	`as£¹
(
v¬
->
size
 >= 0);

446 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

447 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

450 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

452 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

454 if(
¡©e
->
·¿ms_Ën
 != 0)

455 *
Ën
 += 2;

458 
	}
}

460 
sÿm³r_tb™_pkt_t
 *
	$w¬ts_tb™_pkt_»ad
(
w¬ts_¡©e_t
 *
¡©e
,

461 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

462 
ušt32_t
 
Ën
)

464 
sÿm³r_tb™_pkt_t
 *
pkt
 = 
NULL
;

465 
ušt8_t
 
dœ
, *
d©a
 = 
NULL
;

466 
timev®
 
tv
;

467 
ušt16_t
 
¶’
;

468 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

469 {&
dœ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

470 {&
tv
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

471 {&
¶’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

472 {&
d©a
, (
w´_t
)
exŒaù_by‹s_±r
, &
¶’
},

474 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

476 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0 ||

477 (
pkt
 = 
	`sÿm³r_tb™_pkt_®loc
(
dœ
, 
d©a
, 
¶’
, &
tv
)è=ğ
NULL
)

478 
”r
;

480  
pkt
;

482 
”r
:

483 if(
pkt
 !ğ
NULL
è
	`sÿm³r_tb™_pkt_ä“
(pkt);

484  
NULL
;

485 
	}
}

487 
	$w¬ts_tb™_pkt_wr™e
(cÚ¡ 
sÿm³r_tb™_pkt_t
 *
pkt
,

488 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

489 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

490 
w¬ts_tb™_pkt_t
 *
¡©e
)

492 
ušt16_t
 
dl
 = 
pkt
->
Ën
;

493 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

494 {&
pkt
->
dœ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

495 {&
pkt
->
tv
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

496 {&
pkt
->
Ën
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

497 {
pkt
->
d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
dl
},

499 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

500 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

501 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

503 
	}
}

505 
	$w¬ts_tb™_·¿ms
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,

506 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

507 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

509 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

510 
i
, 
max_id
 = 0;

513 
	`mem£t
(
æags
, 0, 
tb™_v¬s_mfb
);

514 *
·¿ms_Ën
 = 0;

516 
i
=0; i<(
tb™_v¬s
)/(
w¬ts_v¬_t
); i++)

518 
v¬
 = &
tb™_v¬s
[
i
];

521 if(
v¬
->
id
 =ğ
WARTS_TBIT_PKTC16
)

523 if(
v¬
->
id
 =ğ
WARTS_TBIT_LIST
 && 
tb™
->
li¡
 =ğ
NULL
)

525 if(
v¬
->
id
 =ğ
WARTS_TBIT_CYCLE
 && 
tb™
->
cyşe
 =ğ
NULL
)

527 if(
v¬
->
id
 =ğ
WARTS_TBIT_USERID
 && 
tb™
->
u£rid
 == 0)

529 if(
v¬
->
id
 =ğ
WARTS_TBIT_SRC
 && 
tb™
->
¤c
 =ğ
NULL
)

531 if(
v¬
->
id
 =ğ
WARTS_TBIT_DST
 && 
tb™
->
d¡
 =ğ
NULL
)

535 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

538 if(
v¬
->
id
 =ğ
WARTS_TBIT_SRC
)

540 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
tb™
->
¤c
);

543 if(
v¬
->
id
 =ğ
WARTS_TBIT_DST
)

545 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
tb™
->
d¡
);

550 *
·¿ms_Ën
 +ğ
v¬
->
size
;

553 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

555 
	}
}

557 
	$w¬ts_tb™_·¿ms_»ad
(
sÿm³r_tb™_t
 *
tb™
,

558 
w¬ts_add¹abË_t
 *
bË
,

559 
w¬ts_¡©e_t
 *
¡©e
,

560 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

562 
ušt16_t
 
pktc16
 = 0;

563 
ušt32_t
 
pktc32
 = 0;

565 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

566 {&
tb™
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

567 {&
tb™
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

568 {&
tb™
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

569 {&
tb™
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

570 {&
tb™
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

571 {&
tb™
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

572 {&
tb™
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

573 {&
tb™
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

574 {&
tb™
->
»suÉ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

575 {&
tb™
->
ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

576 {&
tb™
->
­p_´Ùo
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

577 {&
tb™
->
ş›Á_mss
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

578 {&
tb™
->
£rv”_mss
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

579 {&
tb™
->
syn_»tx
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

580 {&
tb™
->
d©_»tx
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

581 {&
pktc16
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

582 {&
pktc32
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

584 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

586 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

590 if(
pktc32
 != 0)

591 
tb™
->
pktc
 = 
pktc32
;

592 if(
pktc16
 != 0)

593 
tb™
->
pktc
 = 
pktc16
;

596 
	}
}

598 
	$w¬ts_tb™_·¿ms_wr™e
(cÚ¡ 
sÿm³r_tb™_t
 *
tb™
,

599 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

600 
w¬ts_add¹abË_t
 *
bË
,

601 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

602 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 *
æags
,

603 cÚ¡ 
ušt16_t
 
æags_Ën
,

604 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

606 
ušt32_t
 
li¡_id
, 
cyşe_id
;

609 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

610 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

611 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

612 {&
tb™
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

613 {
tb™
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

614 {
tb™
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

615 {&
tb™
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

616 {&
tb™
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

617 {&
tb™
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

618 {&
tb™
->
»suÉ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

619 {&
tb™
->
ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

620 {&
tb™
->
­p_´Ùo
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

621 {&
tb™
->
ş›Á_mss
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

622 {&
tb™
->
£rv”_mss
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

623 {&
tb™
->
syn_»tx
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

624 {&
tb™
->
d©_»tx
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

625 {
NULL
, NULL, NULL},

626 {&
tb™
->
pktc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

628 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

630 if(
	`w¬ts_li¡_g‘id
(
sf
, 
tb™
->
li¡
, &
li¡_id
) == -1)  -1;

631 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
tb™
->
cyşe
, &
cyşe_id
) == -1)  -1;

633 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
,

634 
hªdËrs
, 
hªdËr_út
);

637 
	}
}

639 
	$sÿm³r_fe_w¬ts_tb™_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

640 
sÿm³r_tb™_t
 **
tb™_out
)

642 
sÿm³r_tb™_t
 *
tb™
 = 
NULL
;

643 
w¬ts_add¹abË_t
 
bË
;

644 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

645 
ušt8_t
 *
buf
 = 
NULL
;

646 
ušt16_t
 
junk16
;

647 
ušt32_t
 
junk32
;

648 
ušt32_t
 
off
 = 0;

649 
ušt32_t
 
i
;

651 
	`mem£t
(&
bË
, 0, (table));

654 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

656 
”r
;

659 if(
buf
 =ğ
NULL
)

661 *
tb™_out
 = 
NULL
;

666 if((
tb™
 = 
	`sÿm³r_tb™_®loc
()è=ğ
NULL
)

668 
”r
;

672 if(
	`w¬ts_tb™_·¿ms_»ad
(
tb™
, &
bË
, 
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

674 
”r
;

677 
tb™
->
ty³
)

679 
SCAMPER_TBIT_TYPE_PMTUD
:

680 if((
tb™
->
d©a
 = 
	`sÿm³r_tb™_pmtud_®loc
()è=ğ
NULL
)

681 
”r
;

684 
SCAMPER_TBIT_TYPE_NULL
:

685 if((
tb™
->
d©a
 = 
	`sÿm³r_tb™_nuÎ_®loc
()è=ğ
NULL
)

686 
”r
;

691 if(
tb™
->
pktc
 > 0)

694 if(
	`sÿm³r_tb™_pkts_®loc
(
tb™
,b™->
pktc
) != 0)

695 
”r
;

698 
i
=0; i<
tb™
->
pktc
; i++)

700 
tb™
->
pkts
[
i
] = 
	`w¬ts_tb™_pkt_»ad
(
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
);

701 if(
tb™
->
pkts
[
i
] =ğ
NULL
)

702 
”r
;

708 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
junk16
, 
NULL
) != 0)

709 
”r
;

710 if(
junk16
 =ğ
WARTS_TBIT_STRUCT_EOF
)

712 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
junk32
, 
NULL
) != 0)

713 
”r
;

715 
i
 = 
off
;

716 if(
junk16
 =ğ
WARTS_TBIT_STRUCT_TYPE
)

718 
tb™
->
ty³
)

720 
SCAMPER_TBIT_TYPE_PMTUD
:

721 if(
	`w¬ts_tb™_pmtud_»ad
(
tb™
, &
bË
, 
buf
, &
i
, 
hdr
->
Ën
) != 0)

722 
”r
;

725 
SCAMPER_TBIT_TYPE_NULL
:

726 if(
	`w¬ts_tb™_nuÎ_»ad
(
tb™
, 
buf
, &
i
, 
hdr
->
Ën
) != 0)

727 
”r
;

731 if(
junk16
 =ğ
WARTS_TBIT_STRUCT_APP
)

733 if(
tb™
->
­p_´Ùo
 =ğ
SCAMPER_TBIT_APP_HTTP
)

735 if(
	`w¬ts_tb™_­p_h‰p_»ad
(
tb™
, 
buf
, &
i
, 
hdr
->
Ën
) != 0)

736 
”r
;

740 
off
 +ğ
junk32
;

743 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

744 
	`w¬ts_add¹abË_ş—n
(&
bË
);

745 *
tb™_out
 = 
tb™
;

746 
	`ä“
(
buf
);

749 
”r
:

750 
	`w¬ts_add¹abË_ş—n
(&
bË
);

751 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

752 if(
tb™
 !ğ
NULL
è
	`sÿm³r_tb™_ä“
(tbit);

754 
	}
}

757 
	$sÿm³r_fe_w¬ts_tb™_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

758 cÚ¡ 
sÿm³r_tb™_t
 *
tb™
)

760 
w¬ts_add¹abË_t
 
bË
;

761 
w¬ts_tb™_pkt_t
 *
pkts
 = 
NULL
;

762 
w¬ts_tb™_pmtud_t
 
pmtud
;

763 
w¬ts_tb™_nuÎ_t
 
nuÎ
;

764 
w¬ts_tb™_­p_h‰p_t
 
h‰p
;

765 
ušt8_t
 *
buf
 = 
NULL
;

766 
ušt8_t
 
æags
[
tb™_v¬s_mfb
];

767 
ušt16_t
 
junk16
;

768 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

769 
ušt32_t
 
Ën
, 
i
, 
off
 = 0;

770 
size_t
 
size
;

772 
	`mem£t
(&
bË
, 0, (table));

775 
	`w¬ts_tb™_·¿ms
(
tb™
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

776 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

778 if(
tb™
->
pktc
 > 0)

781 
size
 = 
tb™
->
pktc
 * (
w¬ts_tb™_pkt_t
);

782 if((
pkts
 = (
w¬ts_tb™_pkt_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

783 
”r
;

785 
i
=0; i<
tb™
->
pktc
; i++)

786 
	`w¬ts_tb™_pkt_·¿ms
(
tb™
->
pkts
[
i
], &pkts[i], &
Ën
);

789 if(
tb™
->
d©a
 !ğ
NULL
)

791 
tb™
->
ty³
)

793 
SCAMPER_TBIT_TYPE_PMTUD
:

794 
	`w¬ts_tb™_pmtud_·¿ms
(
tb™
, &
bË
, &
pmtud
);

795 
Ën
 +ğ(2 + 4 + 
pmtud
.len);

798 
SCAMPER_TBIT_TYPE_NULL
:

799 
	`w¬ts_tb™_nuÎ_·¿ms
(
tb™
, &
nuÎ
);

800 
Ën
 +ğ(2 + 4 + 
nuÎ
.len);

804 
”r
;

808 if(
tb™
->
­p_d©a
 !ğ
NULL
)

810 if(
tb™
->
­p_´Ùo
 =ğ
SCAMPER_TBIT_APP_HTTP
)

812 
	`w¬ts_tb™_­p_h‰p_·¿ms
(
tb™
, &
h‰p
);

813 
Ën
 +ğ(2 + 4 + 
h‰p
.len);

815 
”r
;

819 
Ën
 += 2;

822 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

823 
”r
;

824 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_TBIT
);

827 if(
	`w¬ts_tb™_·¿ms_wr™e
(
tb™
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

828 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

830 
”r
;

833 if(
tb™
->
pktc
 > 0)

835 
i
=0; i<
tb™
->
pktc
; i++)

836 
	`w¬ts_tb™_pkt_wr™e
(
tb™
->
pkts
[
i
], 
sf
, 
buf
, &
off
, 
Ën
, &pkts[i]);

837 
	`ä“
(
pkts
);…kt ğ
NULL
;

840 if(
tb™
->
d©a
 !ğ
NULL
)

842 
junk16
 = 
WARTS_TBIT_STRUCT_TYPE
;

843 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
junk16
, 
NULL
);

845 
tb™
->
ty³
)

847 
SCAMPER_TBIT_TYPE_PMTUD
:

848 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
pmtud
.Ën, 
NULL
);

849 
	`w¬ts_tb™_pmtud_wr™e
(
tb™
, 
buf
, &
off
, 
Ën
, &
bË
, &
pmtud
);

852 
SCAMPER_TBIT_TYPE_NULL
:

853 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
nuÎ
.Ën, 
NULL
);

854 
	`w¬ts_tb™_nuÎ_wr™e
(
tb™
, 
buf
, &
off
, 
Ën
, &
nuÎ
);

858 
”r
;

862 if(
tb™
->
­p_d©a
 !ğ
NULL
)

864 
junk16
 = 
WARTS_TBIT_STRUCT_APP
;

865 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
junk16
, 
NULL
);

867 if(
tb™
->
­p_´Ùo
 =ğ
SCAMPER_TBIT_APP_HTTP
)

869 
	`š£¹_ušt32
(
buf
, &
off
, 
Ën
, &
h‰p
.Ën, 
NULL
);

870 
	`w¬ts_tb™_­p_h‰p_wr™e
(
tb™
, 
buf
, &
off
, 
Ën
, &
h‰p
);

872 
”r
;

875 
junk16
 = 
WARTS_TBIT_STRUCT_EOF
;

876 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
junk16
, 
NULL
);

878 
	`as£¹
(
off
 =ğ
Ën
);

881 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

882 
”r
;

884 
	`w¬ts_add¹abË_ş—n
(&
bË
);

885 
	`ä“
(
buf
);

888 
”r
:

889 
	`w¬ts_add¹abË_ş—n
(&
bË
);

890 if(
pkts
 !ğ
NULL
è
	`ä“
(pkts);

891 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

893 
	}
}

	@tbit/scamper_tbit_warts.h

32 #iâdeà
__SCAMPER_FILE_WARTS_TBIT_H


33 
	#__SCAMPER_FILE_WARTS_TBIT_H


	)

35 
sÿm³r_fe_w¬ts_tb™_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

36 cÚ¡ 
sÿm³r_tb™_t
 *
tb™
);

38 
sÿm³r_fe_w¬ts_tb™_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

39 
sÿm³r_tb™_t
 **
tb™_out
);

	@trace/scamper_trace.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r_addr.h
"

40 
	~"sÿm³r_li¡.h
"

41 
	~"sÿm³r_icm³xt.h
"

42 
	~"sÿm³r_Œaû.h
"

43 
	~"uts.h
"

45 
	$sÿm³r_Œaû_pmtud_®loc
(
sÿm³r_Œaû_t
 *
Œaû
)

47 if((
Œaû
->
pmtud
 = 
	`m®loc_z”o
((
sÿm³r_Œaû_pmtud_t
))è=ğ
NULL
)

50 
	}
}

52 
	$sÿm³r_Œaû_pmtud_ä“
(
sÿm³r_Œaû_t
 *
Œaû
)

54 
sÿm³r_Œaû_hİ_t
 *
hİ
, *
hİ_Ãxt
;

55 
ušt8_t
 
u8
;

57 if(
Œaû
->
pmtud
 =ğ
NULL
)

60 
hİ
 = 
Œaû
->
pmtud
->
hİs
;

61 
hİ
 !ğ
NULL
)

63 
hİ_Ãxt
 = 
hİ
->hop_next;

64 
	`sÿm³r_Œaû_hİ_ä“
(
hİ
);

65 
hİ
 = 
hİ_Ãxt
;

68 if(
Œaû
->
pmtud
->
nÙes
 !ğ
NULL
)

70 
u8
=0; u8<
Œaû
->
pmtud
->
nÙec
; u8++)

71 
	`sÿm³r_Œaû_pmtud_n_ä“
(
Œaû
->
pmtud
->
nÙes
[
u8
]);

72 
	`ä“
(
Œaû
->
pmtud
->
nÙes
);

75 
	`ä“
(
Œaû
->
pmtud
);

76 
Œaû
->
pmtud
 = 
NULL
;

79 
	}
}

81 
	$sÿm³r_Œaû_pmtud_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

83 
sÿm³r_Œaû_hİ_t
 *
hİ
;

84 
couÁ
 = 0;

85 if(
Œaû
 =ğ
NULL
 ||¿û->
pmtud
 == NULL)

87 
hİ
 = 
Œaû
->
pmtud
->
hİs
; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

88 
couÁ
++;

89  
couÁ
;

90 
	}
}

92 
sÿm³r_Œaû_pmtud_n_t
 *
	$sÿm³r_Œaû_pmtud_n_®loc
()

94  
	`m®loc_z”o
((
sÿm³r_Œaû_pmtud_n_t
));

95 
	}
}

97 
	$sÿm³r_Œaû_pmtud_n_ä“
(
sÿm³r_Œaû_pmtud_n_t
 *
n
)

99 
	`ä“
(
n
);

101 
	}
}

103 
	$sÿm³r_Œaû_pmtud_n_®loc_c
(
sÿm³r_Œaû_pmtud_t
 *
pmtud
, 
ušt8_t
 
couÁ
)

105 
size_t
 
Ën
 = 
couÁ
 * (
sÿm³r_Œaû_pmtud_n_t
 *);

106 if((
pmtud
->
nÙes
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

109 
	}
}

111 
	$sÿm³r_Œaû_pmtud_n_add
(
sÿm³r_Œaû_pmtud_t
 *
pmtud
,

112 
sÿm³r_Œaû_pmtud_n_t
 *
n
)

114 
size_t
 
Ën
 = (
pmtud
->
nÙec
 + 1è* (
sÿm³r_Œaû_pmtud_n_t
 *);

115 if(
	`»®loc_w¿p
((**)&
pmtud
->
nÙes
, 
Ën
) != 0)

117 
pmtud
->
nÙes
[pmtud->
nÙec
] = 
n
;

118 
pmtud
->
nÙec
++;

120 
	}
}

122 
	$sÿm³r_Œaû_Ï¡d™ch_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

124 
sÿm³r_Œaû_hİ_t
 *
hİ
;

125 
couÁ
 = 0;

126 if(
Œaû
 =ğ
NULL
 ||¿û->
Ï¡d™ch
 == NULL)

128 
hİ
 = 
Œaû
->
Ï¡d™ch
; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

129 
couÁ
++;

130  
couÁ
;

131 
	}
}

133 
	$sÿm³r_Œaû_dŒ“_®loc
(
sÿm³r_Œaû_t
 *
Œaû
)

135 if((
Œaû
->
dŒ“
 = 
	`m®loc_z”o
((
sÿm³r_Œaû_dŒ“_t
))è!ğ
NULL
)

138 
	}
}

140 
	$sÿm³r_Œaû_dŒ“_ä“
(
sÿm³r_Œaû_t
 *
Œaû
)

142 
sÿm³r_Œaû_dŒ“_t
 *
dt
;

143 
ušt16_t
 
i
;

145 if((
dt
 = 
Œaû
->
dŒ“
è=ğ
NULL
)

148 if(
dt
->
lss_¡İ
 !ğ
NULL
)

149 
	`sÿm³r_addr_ä“
(
dt
->
lss_¡İ
);

150 if(
dt
->
gss_¡İ
 !ğ
NULL
)

151 
	`sÿm³r_addr_ä“
(
dt
->
gss_¡İ
);

152 if(
dt
->
lss
 !ğ
NULL
)

153 
	`ä“
(
dt
->
lss
);

155 if(
dt
->
gss
 !ğ
NULL
)

157 
i
=0; i<
dt
->
gssc
; i++)

158 if(
dt
->
gss
[
i
] !ğ
NULL
)

159 
	`sÿm³r_addr_ä“
(
dt
->
gss
[
i
]);

160 
	`ä“
(
dt
->
gss
);

163 
	`ä“
(
dt
);

164 
Œaû
->
dŒ“
 = 
NULL
;

166 
	}
}

168 
	$sÿm³r_Œaû_dŒ“_lss
(
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ *
Çme
)

170 if(
Œaû
->
dŒ“
 =ğ
NULL
 || (Œaû->dŒ“->
lss
 = 
	`¡rdup
(
Çme
)) == NULL)

173 
	}
}

175 
	$sÿm³r_Œaû_dŒ“_gss_add
(
sÿm³r_Œaû_t
 *
Œaû
, 
sÿm³r_addr_t
 *
içû
)

177 
size_t
 
Ën
 = (
Œaû
->
dŒ“
->
gssc
 + 1è* (
sÿm³r_addr_t
 *);

179 if(
Œaû
->
dŒ“
 =ğ
NULL
)

182 if(
	`»®loc_w¿p
((**)&
Œaû
->
dŒ“
->
gss
, 
Ën
) != 0)

185 
Œaû
->
dŒ“
->
gss
[Œaû->dŒ“->
gssc
] = 
	`sÿm³r_addr_u£
(
içû
);

186 
Œaû
->
dŒ“
->
gssc
++;

188 
	`¬¿y_qsÜt
((**)
Œaû
->
dŒ“
->
gss
,¿û->dŒ“->
gssc
,

189 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
);

192 
	}
}

194 
sÿm³r_addr_t
 *
	$sÿm³r_Œaû_dŒ“_gss_fšd
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

195 cÚ¡ 
sÿm³r_addr_t
 *
içû
)

197 if(
Œaû
->
dŒ“
 =ğ
NULL
)

198  
NULL
;

200  
	`¬¿y_fšd
((**)
Œaû
->
dŒ“
->
gss
,¿û->dŒ“->
gssc
,

201 
içû
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
);

202 
	}
}

204 
	$sÿm³r_Œaû_hİs_®loc
(
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ 
hİs
)

206 
sÿm³r_Œaû_hİ_t
 **
h
;

207 
size_t
 
size
;

209 
size
 = (
sÿm³r_Œaû_hİ_t
 *è* 
hİs
;

211 if(
Œaû
->
hİs
 =ğ
NULL
)

213 
h
 = (
sÿm³r_Œaû_hİ_t
 **)
	`m®loc_z”o
(
size
);

217 
h
 = (
sÿm³r_Œaû_hİ_t
 **)
	`»®loc
(
Œaû
->
hİs
, 
size
);

220 if(
h
 !ğ
NULL
)

222 
Œaû
->
hİs
 = 
h
;

227 
	}
}

229 
	$sÿm³r_Œaû_hİ_ä“
(
sÿm³r_Œaû_hİ_t
 *
hİ
)

231 if(
hİ
 !ğ
NULL
)

233 
	`sÿm³r_icm³xt_ä“
(
hİ
->
hİ_icm³xt
);

234 
	`sÿm³r_addr_ä“
(
hİ
->
hİ_addr
);

235 
	`ä“
(
hİ
);

238 
	}
}

240 
sÿm³r_Œaû_hİ_t
 *
	$sÿm³r_Œaû_hİ_®loc
()

242 
sÿm³r_Œaû_hİ_t
 *
hİ
;

244 if((
hİ
 = 
	`m®loc_z”o
((
sÿm³r_Œaû_hİ
))è=ğ
NULL
)

246  
NULL
;

249  
hİ
;

250 
	}
}

252 
	$sÿm³r_Œaû_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

254 
sÿm³r_Œaû_hİ_t
 *
hİ
;

255 
hİs
 = 0;

256 
ušt8_t
 
i
;

258 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

260 
hİ
 = 
Œaû
->
hİs
[
i
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

262 
hİs
++;

266  
hİs
;

267 
	}
}

269 
	$sÿm³r_Œaû_hİ_addr_cmp
(cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
a
,

270 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
b
)

272 
	`as£¹
(
a
 !ğ
NULL
);

273 
	`as£¹
(
b
 !ğ
NULL
);

274  
	`sÿm³r_addr_cmp
(
a
->
hİ_addr
, 
b
->hop_addr);

275 
	}
}

286 
sÿm³r_addr_t
 *
	$sÿm³r_Œaû_addr
(cÚ¡ *
va
)

288  ((cÚ¡ 
sÿm³r_Œaû_t
 *)
va
)->
d¡
;

289 
	}
}

291 cÚ¡ *
	$sÿm³r_Œaû_ty³_to¡r
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

293 
Œaû
->
ty³
)

295 
SCAMPER_TRACE_TYPE_UDP
:  "udp";

296 
SCAMPER_TRACE_TYPE_UDP_PARIS
:  "udp-paris";

297 
SCAMPER_TRACE_TYPE_ICMP_ECHO
:  "icmp-echo";

298 
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
:  "icmp-echo-paris";

299 
SCAMPER_TRACE_TYPE_TCP
:  "tcp";

300 
SCAMPER_TRACE_TYPE_TCP_ACK
:  "tcp-ack";

302  
NULL
;

303 
	}
}

310 
	$sÿm³r_Œaû_´obe_h—d”Ën
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

312 
Ën
;

314 
Œaû
->
d¡
->
ty³
)

316 
SCAMPER_ADDR_TYPE_IPV4
:

317 
Ën
 = 20;

320 
SCAMPER_ADDR_TYPE_IPV6
:

321 
Ën
 = 40;

328 if(
Œaû
->
off£t
 > 0)

329  
Ën
;

331 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
))

332 
Ën
 += 8;

333 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
))

334 
Ën
 += (1 + 1 + 2 + 2 + 2);

335 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

336 
Ën
 += 20;

340  
Ën
;

341 
	}
}

343 
ušt16_t
 
	$sÿm³r_Œaû_·thËngth
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

345 
ušt16_t
 
i
=0, 
max
 = 0;

346 
i
=0; i !ğ
Œaû
->
hİ_couÁ
; i++)

348 if(
Œaû
->
hİs
[
i
] !ğ
NULL
)

349 
max
 = 
i
;

352  
max
;

353 
	}
}

355 
	$sÿm³r_Œaû_iscom¶‘e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

357 
ušt8_t
 
i
;

359 if(
Œaû
->
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_COMPLETED
)

362 
i
=
Œaû
->
fœ¡hİ
-1; i<Œaû->
hİ_couÁ
; i++)

363 if(
Œaû
->
hİs
[
i
] =ğ
NULL
)

367 
	}
}

373 
	$Œaû_hİ_fœ¡addr
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

374 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
)

376 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
tmp
 = 
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1];

378 
tmp
 !ğ
hİ
)

380 if(
	`sÿm³r_Œaû_hİ_addr_cmp
(
tmp
, 
hİ
) == 0)

382 
tmp
 =mp->
hİ_Ãxt
;

386 
	}
}

388 
	$sÿm³r_Œaû_loİ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ 
n
,

389 cÚ¡ 
sÿm³r_Œaû_hİ_t
 **
a
,

390 cÚ¡ 
sÿm³r_Œaû_hİ_t
 **
b
)

392 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
, *
tmp
;

393 
ušt8_t
 
i
;

394 
j
, 
loİc
 = 0;

396 
	`as£¹
(
Œaû
->
fœ¡hİ
 != 0);

398 if(
b
 !ğ
NULL
 && *b != NULL)

401 
hİ
 = *
b
;

402 if(
hİ
->
hİ_´obe_‰l
 >ğ
Œaû
->
hİ_couÁ
)

406 
tmp
 = 
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1];

407 
tmp
 !ğ
NULL
)

409 if(
tmp
 =ğ
hİ
) ;

410 
tmp
 =mp->
hİ_Ãxt
;

412 if(
tmp
 =ğ
NULL
)

418 
i
 = 
hİ
->
hİ_´obe_‰l
-1;

419 if((
hİ
 = hİ->
hİ_Ãxt
è=ğ
NULL
)

421 
i
++;

426 
i
 = 
Œaû
->
fœ¡hİ
;

427 
hİ
 = 
NULL
;

430 
i
<
Œaû
->
hİ_couÁ
)

432 if(
hİ
 =ğ
NULL
)

435 
i
<
Œaû
->
hİ_couÁ
)

437 if((
hİ
 = 
Œaû
->
hİs
[
i
]è!ğ
NULL
)

439 
i
++;

441 if(
i
 =ğ
Œaû
->
hİ_couÁ
)

448 
	`as£¹
(
hİ
 !ğ
NULL
);

456 if(
	`Œaû_hİ_fœ¡addr
(
Œaû
, 
hİ
) == 0)

458 
hİ
 = hİ->
hİ_Ãxt
;

463 
j
=
i
-1; j>=
Œaû
->
fœ¡hİ
-1; j--)

466 
tmp
 = 
Œaû
->
hİs
[
j
];m°!ğ
NULL
;m°ğtmp->
hİ_Ãxt
)

472 if(
	`sÿm³r_Œaû_hİ_addr_cmp
(
tmp
, 
hİ
) == 0 &&

473 
	`Œaû_hİ_fœ¡addr
(
Œaû
, 
tmp
) != 0)

475 if(++
loİc
 =ğ
n
)

477 if(
a
 !ğ
NULL
è*¨ğ
tmp
;

478 if(
b
 !ğ
NULL
è*b = 
hİ
;

479  
i
-
j
;

485 
hİ
 = hİ->
hİ_Ãxt
;

487 
hİ
 !ğ
NULL
);

489 
i
++;

493 
	}
}

499 
	$sÿm³r_Œaû_ä“
(
sÿm³r_Œaû_t
 *
Œaû
)

501 
sÿm³r_Œaû_hİ_t
 *
hİ
, *
hİ_Ãxt
;

502 
ušt8_t
 
i
;

504 if(
Œaû
 =ğ
NULL
) ;

507 if(
Œaû
->
hİs
 !ğ
NULL
)

509 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

511 
hİ
 = 
Œaû
->
hİs
[
i
];

512 
hİ
 !ğ
NULL
)

514 
hİ_Ãxt
 = 
hİ
->hop_next;

515 
	`sÿm³r_Œaû_hİ_ä“
(
hİ
);

516 
hİ
 = 
hİ_Ãxt
;

519 
	`ä“
(
Œaû
->
hİs
);

523 
hİ
 = 
Œaû
->
Ï¡d™ch
;

524 
hİ
 !ğ
NULL
)

526 
hİ_Ãxt
 = 
hİ
->hop_next;

527 
	`sÿm³r_Œaû_hİ_ä“
(
hİ
);

528 
hİ
 = 
hİ_Ãxt
;

531 if(
Œaû
->
·ylßd
 !ğ
NULL
è
	`ä“
(trace->payload);

533 
	`sÿm³r_Œaû_pmtud_ä“
(
Œaû
);

534 
	`sÿm³r_Œaû_dŒ“_ä“
(
Œaû
);

536 if(
Œaû
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(trace->dst);

537 if(
Œaû
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(trace->src);

539 if(
Œaû
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(trace->cycle);

540 if(
Œaû
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(trace->list);

542 
	`ä“
(
Œaû
);

544 
	}
}

551 
sÿm³r_Œaû_t
 *
	$sÿm³r_Œaû_®loc
()

553  (
sÿm³r_Œaû
 *)
	`m®loc_z”o
((scamper_trace));

554 
	}
}

	@trace/scamper_trace.h

27 #iâdeà
__SCAMPER_TRACE_H


28 
	#__SCAMPER_TRACE_H


	)

31 
	gsÿm³r_icm³xt
;

32 
	gsÿm³r_li¡
;

33 
	gsÿm³r_cyşe
;

34 
	gsÿm³r_addr
;

36 
	#SCAMPER_TRACE_STOP_NONE
 0x00

	)

37 
	#SCAMPER_TRACE_STOP_COMPLETED
 0x01

	)

38 
	#SCAMPER_TRACE_STOP_UNREACH
 0x02

	)

39 
	#SCAMPER_TRACE_STOP_ICMP
 0x03

	)

40 
	#SCAMPER_TRACE_STOP_LOOP
 0x04

	)

41 
	#SCAMPER_TRACE_STOP_GAPLIMIT
 0x05

	)

42 
	#SCAMPER_TRACE_STOP_ERROR
 0x06

	)

43 
	#SCAMPER_TRACE_STOP_HOPLIMIT
 0x07

	)

44 
	#SCAMPER_TRACE_STOP_GSS
 0x08

	)

45 
	#SCAMPER_TRACE_STOP_HALTED
 0x09

	)

47 
	#SCAMPER_TRACE_FLAG_ALLATTEMPTS
 0x01

	)

48 
	#SCAMPER_TRACE_FLAG_PMTUD
 0x02

	)

49 
	#SCAMPER_TRACE_FLAG_DL
 0x04

	)

50 
	#SCAMPER_TRACE_FLAG_IGNORETTLDST
 0x08

	)

51 
	#SCAMPER_TRACE_FLAG_DOUBLETREE
 0x10

	)

52 
	#SCAMPER_TRACE_FLAG_ICMPCSUMDP
 0x20

	)

54 
	#SCAMPER_TRACE_TYPE_ICMP_ECHO
 0x01

	)

55 
	#SCAMPER_TRACE_TYPE_UDP
 0x02

	)

56 
	#SCAMPER_TRACE_TYPE_TCP
 0x03

	)

57 
	#SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
 0x04

	)

58 
	#SCAMPER_TRACE_TYPE_UDP_PARIS
 0x05

	)

59 
	#SCAMPER_TRACE_TYPE_TCP_ACK
 0x06

	)

61 
	#SCAMPER_TRACE_GAPACTION_STOP
 0x01

	)

62 
	#SCAMPER_TRACE_GAPACTION_LASTDITCH
 0x02

	)

64 
	#SCAMPER_TRACE_HOP_IS_TCP
(
hİ
) ( \

65 (
hİ
->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
è!ğ0)

	)

67 
	#SCAMPER_TRACE_HOP_IS_ICMP
(
hİ
) ( \

68 (
hİ
->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
è=ğ0)

	)

70 
	#SCAMPER_TRACE_HOP_IS_ICMP_TTL_EXP
(
hİ
) ( \

71 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

72 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

73 (
hİ
)->
hİ_icmp_ty³
 == 11) || \

74 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

75 (
hİ
)->
hİ_icmp_ty³
 =ğ3)))

	)

77 
	#SCAMPER_TRACE_HOP_IS_ICMP_TTL_EXP_TRANS
(
hİ
) ( \

78 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

79 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

80 (
hİ
)->
hİ_icmp_ty³
 =ğ11 && (hİ)->
hİ_icmp_code
 == 0) || \

81 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

82 (
hİ
)->
hİ_icmp_ty³
 =ğ3 && (hİ)->
hİ_icmp_code
 =ğ0)))

	)

84 
	#SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
) ( \

85 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

86 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

87 (
hİ
)->
hİ_icmp_ty³
 =ğ3 && (hİ)->
hİ_icmp_code
 == 4) || \

88 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

89 (
hİ
)->
hİ_icmp_ty³
 =ğ2)))

	)

91 
	#SCAMPER_TRACE_HOP_IS_ICMP_PTB_BADSUGG
(
hİ
) ( \

92 
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
((
hİ
)) && \

93 (
hİ
)->
hİ_´obe_size
 <ğ(hİ)->
hİ_icmp_nhmtu
)

	)

95 
	#SCAMPER_TRACE_HOP_IS_ICMP_UNREACH
(
hİ
) ( \

96 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

97 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

98 (
hİ
)->
hİ_icmp_ty³
 == 3) || \

99 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

100 (
hİ
)->
hİ_icmp_ty³
 =ğ1)))

	)

102 
	#SCAMPER_TRACE_HOP_IS_ICMP_UNREACH_PORT
(
hİ
) ( \

103 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

104 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

105 (
hİ
)->
hİ_icmp_ty³
 =ğ3 && (hİ)->
hİ_icmp_code
 == 3) || \

106 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

107 (
hİ
)->
hİ_icmp_ty³
 =ğ1 && (hİ)->
hİ_icmp_code
 =ğ4)))

	)

109 
	#SCAMPER_TRACE_HOP_IS_ICMP_ECHO_REPLY
(
hİ
) ( \

110 ((
hİ
)->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) == 0 && \

111 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

112 (
hİ
)->
hİ_icmp_ty³
 == 0) || \

113 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

114 (
hİ
)->
hİ_icmp_ty³
 =ğ129)))

	)

116 
	#SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
) ( \

117 
	`SCAMPER_TRACE_HOP_IS_ICMP
(
hİ
) && \

118 (((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

119 ((
hİ
)->
hİ_icmp_ty³
 == 3 || (hop)->hop_icmp_type == 11)) ||\

120 ((
hİ
)->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

121 ((
hİ
)->
hİ_icmp_ty³
 >ğ1 && (hİ)->hİ_icmp_ty³ <ğ3))))

	)

123 
	#SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
) ( \

124 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO
 || \

125 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
)

	)

127 
	#SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
) ( \

128 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
 || \

129 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP_PARIS
)

	)

131 
	#SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
) ( \

132 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_TCP
 || \

133 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_TCP_ACK
)

	)

135 
	#SCAMPER_TRACE_TYPE_IS_UDP_PARIS
(
Œaû
) ( \

136 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP_PARIS
)

	)

141 
	#SCAMPER_TRACE_IS_ICMPCSUMDP
(
Œaû
) ( \

142 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_ICMPCSUMDP
)

	)

144 
	#SCAMPER_TRACE_IS_PMTUD
(
Œaû
) ( \

145 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_PMTUD
)

	)

147 
	#SCAMPER_TRACE_IS_DOUBLETREE
(
Œaû
) ( \

148 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_DOUBLETREE
)

	)

150 
	#SCAMPER_TRACE_IS_DL
(
Œaû
) ( \

151 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_DL
)

	)

153 
	#SCAMPER_TRACE_IS_IGNORETTLDST
(
Œaû
) ( \

154 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_IGNORETTLDST
)

	)

156 
	#SCAMPER_TRACE_IS_ALLATTEMPTS
(
Œaû
) ( \

157 (
Œaû
)->
æags
 & 
SCAMPER_TRACE_FLAG_ALLATTEMPTS
)

	)

164 
	#SCAMPER_TRACE_HOP_FLAG_TS_SOCK_RX
 0x01

	)

165 
	#SCAMPER_TRACE_HOP_FLAG_TS_DL_TX
 0x02

	)

166 
	#SCAMPER_TRACE_HOP_FLAG_TS_DL_RX
 0x04

	)

167 
	#SCAMPER_TRACE_HOP_FLAG_TS_TSC
 0x08

	)

168 
	#SCAMPER_TRACE_HOP_FLAG_REPLY_TTL
 0x10

	)

169 
	#SCAMPER_TRACE_HOP_FLAG_TCP
 0x20

	)

176 
	#SCAMPER_TRACE_HOP_FLAG_DL_RTT
(
hİ
) \

177 ((
hİ
->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TS_DL_TX
) && \

178 (
hİ
->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TS_DL_RX
))

	)

185 
	ssÿm³r_Œaû_hİ


188 
sÿm³r_addr_t
 *
	mhİ_addr
;

191 
ušt8_t
 
	mhİ_æags
;

202 
ušt8_t
 
	mhİ_´obe_id
;

203 
ušt8_t
 
	mhİ_´obe_‰l
;

204 
ušt16_t
 
	mhİ_´obe_size
;

205 
ušt8_t
 
	mhİ_»¶y_‰l
;

206 
ušt8_t
 
	mhİ_»¶y_tos
;

207 
ušt16_t
 
	mhİ_»¶y_size
;

208 
ušt16_t
 
	mhİ_»¶y_id
;

213 
	shİ_icmp


215 
ušt8_t
 
	mhİ_icmp_ty³
;

216 
ušt8_t
 
	mhİ_icmp_code
;

217 
ušt8_t
 
	mhİ_icmp_q_‰l
;

218 
ušt8_t
 
	mhİ_icmp_q_tos
;

219 
ušt16_t
 
	mhİ_icmp_q_l
;

220 
ušt16_t
 
	mhİ_icmp_nhmtu
;

221 } 
	micmp
;

222 
	shİ_tı


224 
ušt8_t
 
	mhİ_tı_æags
;

225 } 
	mtı
;

226 } 
	mhİ_un
;

229 
timev®
 
	mhİ_¹t
;

232 
sÿm³r_icm³xt
 *
	mhİ_icm³xt
;

234 
sÿm³r_Œaû_hİ
 *
	mhİ_Ãxt
;

235 } 
	tsÿm³r_Œaû_hİ_t
;

237 
	#hİ_icmp_ty³
 
hİ_un
.
icmp
.
hİ_icmp_ty³


	)

238 
	#hİ_icmp_code
 
hİ_un
.
icmp
.
hİ_icmp_code


	)

239 
	#hİ_icmp_q_‰l
 
hİ_un
.
icmp
.
hİ_icmp_q_‰l


	)

240 
	#hİ_icmp_q_l
 
hİ_un
.
icmp
.
hİ_icmp_q_l


	)

241 
	#hİ_icmp_q_tos
 
hİ_un
.
icmp
.
hİ_icmp_q_tos


	)

242 
	#hİ_icmp_nhmtu
 
hİ_un
.
icmp
.
hİ_icmp_nhmtu


	)

243 
	#hİ_tı_æags
 
hİ_un
.
tı
.
hİ_tı_æags


	)

253 
	ssÿm³r_Œaû_pmtud_n


255 
ušt8_t
 
	mty³
;

256 
ušt16_t
 
	mnhmtu
;

257 
sÿm³r_Œaû_hİ_t
 *
	mhİ
;

258 } 
	tsÿm³r_Œaû_pmtud_n_t
;

260 
	#SCAMPER_TRACE_PMTUD_N_TYPE_PTB
 1

	)

261 
	#SCAMPER_TRACE_PMTUD_N_TYPE_PTB_BAD
 2

	)

262 
	#SCAMPER_TRACE_PMTUD_N_TYPE_SILENCE
 3

	)

274 
	ssÿm³r_Œaû_pmtud


276 
ušt8_t
 
	mv”
;

277 
ušt16_t
 
	mifmtu
;

278 
ušt16_t
 
	moutmtu
;

279 
ušt16_t
 
	mpmtu
;

280 
sÿm³r_Œaû_hİ_t
 *
	mhİs
;

281 
sÿm³r_Œaû_pmtud_n_t
 **
	mnÙes
;

282 
ušt8_t
 
	mnÙec
;

283 } 
	tsÿm³r_Œaû_pmtud_t
;

285 
	ssÿm³r_Œaû_dŒ“


287 *
	mlss
;

288 
ušt8_t
 
	mfœ¡hİ
;

289 
ušt16_t
 
	mgssc
;

290 
sÿm³r_addr_t
 **
	mgss
;

291 
sÿm³r_addr_t
 *
	mgss_¡İ
;

292 
sÿm³r_addr_t
 *
	mlss_¡İ
;

293 } 
	tsÿm³r_Œaû_dŒ“_t
;

300 
	ssÿm³r_Œaû


303 
sÿm³r_li¡
 *
	mli¡
;

304 
sÿm³r_cyşe
 *
	mcyşe
;

305 
ušt32_t
 
	mu£rid
;

308 
sÿm³r_addr
 *
	m¤c
;

309 
sÿm³r_addr
 *
	md¡
;

312 
timev®
 
	m¡¬t
;

315 
sÿm³r_Œaû_hİ_t
 **
	mhİs
;

316 
ušt16_t
 
	mhİ_couÁ
;

319 
ušt16_t
 
	m´obec
;

322 
ušt8_t
 
	m¡İ_»asÚ
;

323 
ušt8_t
 
	m¡İ_d©a
;

326 
ušt8_t
 
	mty³
;

327 
ušt8_t
 
	mæags
;

328 
ušt8_t
 
	m©‹m±s
;

329 
ušt8_t
 
	mhİlim™
;

330 
ušt8_t
 
	mg­lim™
;

331 
ušt8_t
 
	mg­aùiÚ
;

332 
ušt8_t
 
	mfœ¡hİ
;

333 
ušt8_t
 
	mtos
;

334 
ušt8_t
 
	mwa™
;

335 
ušt8_t
 
	mwa™_´obe
;

336 
ušt8_t
 
	mloİs
;

337 
ušt8_t
 
	mloİaùiÚ
;

338 
ušt8_t
 
	mcÚfid’û
;

339 
ušt16_t
 
	m´obe_size
;

340 
ušt16_t
 
	m¥Üt
;

341 
ušt16_t
 
	mdpÜt
;

342 
ušt16_t
 
	moff£t
;

345 
ušt8_t
 *
	m·ylßd
;

346 
ušt16_t
 
	m·ylßd_Ën
;

349 
sÿm³r_Œaû_pmtud_t
 *
	mpmtud
;

352 
sÿm³r_Œaû_hİ_t
 *
	mÏ¡d™ch
;

355 
sÿm³r_Œaû_dŒ“_t
 *
	mdŒ“
;

357 } 
	tsÿm³r_Œaû_t
;

377 
sÿm³r_Œaû_t
 *
sÿm³r_Œaû_®loc
();

378 
sÿm³r_Œaû_hİs_®loc
(
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ 
hİs
);

379 
sÿm³r_Œaû_ä“
(
sÿm³r_Œaû_t
 *
Œaû
);

380 
ušt16_t
 
sÿm³r_Œaû_·thËngth
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

381 
sÿm³r_Œaû_´obe_h—d”Ën
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

382 
sÿm³r_addr_t
 *
sÿm³r_Œaû_addr
(cÚ¡ *
va
);

383 cÚ¡ *
sÿm³r_Œaû_ty³_to¡r
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

384 
sÿm³r_Œaû_iscom¶‘e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

394 
sÿm³r_Œaû_loİ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ 
n
,

395 cÚ¡ 
sÿm³r_Œaû_hİ_t
 **
a
,

396 cÚ¡ 
sÿm³r_Œaû_hİ_t
 **
b
);

408 
sÿm³r_Œaû_hİ_t
 *
sÿm³r_Œaû_hİ_®loc
();

409 
sÿm³r_Œaû_hİ_ä“
(
sÿm³r_Œaû_hİ_t
 *
hİ
);

410 
sÿm³r_Œaû_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

412 
sÿm³r_Œaû_hİ_addr_cmp
(cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
a
,

413 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
b
);

425 
sÿm³r_Œaû_pmtud_®loc
(
sÿm³r_Œaû_t
 *
Œaû
);

426 
sÿm³r_Œaû_pmtud_ä“
(
sÿm³r_Œaû_t
 *
Œaû
);

427 
sÿm³r_Œaû_pmtud_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

428 
sÿm³r_Œaû_pmtud_n_t
 *
sÿm³r_Œaû_pmtud_n_®loc
();

429 
sÿm³r_Œaû_pmtud_n_ä“
(
sÿm³r_Œaû_pmtud_n_t
 *
n
);

430 
sÿm³r_Œaû_pmtud_n_®loc_c
(
sÿm³r_Œaû_pmtud_t
 *
pmtud
, 
ušt8_t
 
c
);

431 
sÿm³r_Œaû_pmtud_n_add
(
sÿm³r_Œaû_pmtud_t
 *
pmtud
,

432 
sÿm³r_Œaû_pmtud_n_t
 *
n
);

434 
sÿm³r_Œaû_Ï¡d™ch_hİ_couÁ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
);

439 
sÿm³r_Œaû_dŒ“_®loc
(
sÿm³r_Œaû_t
 *
Œaû
);

440 
sÿm³r_Œaû_dŒ“_ä“
(
sÿm³r_Œaû_t
 *
Œaû
);

441 
sÿm³r_Œaû_dŒ“_lss
(
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ *
lss
);

442 
sÿm³r_Œaû_dŒ“_gss_add
(
sÿm³r_Œaû_t
 *
Œaû
, 
sÿm³r_addr_t
 *
içû
);

443 
sÿm³r_addr_t
 *
sÿm³r_Œaû_dŒ“_gss_fšd
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

444 cÚ¡ 
sÿm³r_addr_t
 *
içû
);

	@trace/scamper_trace_do.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r.h
"

40 
	~"sÿm³r_addr.h
"

41 
	~"sÿm³r_li¡.h
"

42 
	~"sÿm³r_icm³xt.h
"

43 
	~"sÿm³r_Œaû.h
"

44 
	~"sÿm³r_sk.h
"

45 
	~"sÿm³r_queue.h
"

46 
	~"sÿm³r_icmp_»¥.h
"

47 
	~"sÿm³r_dl.h
"

48 
	~"sÿm³r_fds.h
"

49 
	~"sÿm³r_dlhdr.h
"

50 
	~"sÿm³r_´obe.h
"

51 
	~"sÿm³r_¹sock.h
"

52 
	~"sÿm³r_g‘¤c.h
"

53 
	~"sÿm³r_fe.h
"

54 
	~"sÿm³r_debug.h
"

55 
	~"sÿm³r_Œaû_do.h
"

56 
	~"sÿm³r_addr2mac.h
"

57 
	~"sÿm³r_İtiÚs.h
"

58 
	~"sÿm³r_icmp4.h
"

59 
	~"sÿm³r_icmp6.h
"

60 
	~"sÿm³r_tı4.h
"

61 
	~"sÿm³r_udp4.h
"

62 
	~"sÿm³r_udp6.h
"

63 
	~"sÿm³r_if.h
"

64 
	~"sÿm³r_osšfo.h
"

65 
	~"mjl_¥ÏyŒ“.h
"

66 
	~"mjl_li¡.h
"

67 
	~"uts.h
"

69 
	#SCAMPER_DO_TRACE_ATTEMPTS_MIN
 1

	)

70 
	#SCAMPER_DO_TRACE_ATTEMPTS_DEF
 2

	)

71 
	#SCAMPER_DO_TRACE_ATTEMPTS_MAX
 20

	)

73 
	#SCAMPER_DO_TRACE_DPORT_MIN
 1

	)

74 
	#SCAMPER_DO_TRACE_DPORT_DEF
 (32768+666+1è

	)

75 
	#SCAMPER_DO_TRACE_DPORT_MAX
 65535

	)

77 
	#SCAMPER_DO_TRACE_FIRSTHOP_MIN
 1

	)

78 
	#SCAMPER_DO_TRACE_FIRSTHOP_DEF
 1

	)

79 
	#SCAMPER_DO_TRACE_FIRSTHOP_MAX
 255

	)

81 
	#SCAMPER_DO_TRACE_GAPLIMIT_MIN
 1

	)

82 
	#SCAMPER_DO_TRACE_GAPLIMIT_DEF
 5

	)

83 
	#SCAMPER_DO_TRACE_GAPLIMIT_MAX
 255

	)

85 
	#SCAMPER_DO_TRACE_GAPACTION_MIN
 1

	)

86 
	#SCAMPER_DO_TRACE_GAPACTION_DEF
 
SCAMPER_TRACE_GAPACTION_STOP


	)

87 
	#SCAMPER_DO_TRACE_GAPACTION_MAX
 2

	)

89 
	#SCAMPER_DO_TRACE_HOLDTIME_MIN
 0

	)

90 
	#SCAMPER_DO_TRACE_HOLDTIME_DEF
 0

	)

91 
	#SCAMPER_DO_TRACE_HOLDTIME_MAX
 255

	)

93 
	#SCAMPER_DO_TRACE_HOPLIMIT_MIN
 0

	)

94 
	#SCAMPER_DO_TRACE_HOPLIMIT_DEF
 0

	)

95 
	#SCAMPER_DO_TRACE_HOPLIMIT_MAX
 255

	)

97 
	#SCAMPER_DO_TRACE_LOOPS_MIN
 0

	)

98 
	#SCAMPER_DO_TRACE_LOOPS_DEF
 1

	)

99 
	#SCAMPER_DO_TRACE_LOOPS_MAX
 255

	)

101 
	#SCAMPER_DO_TRACE_LOOPACTION_MIN
 0

	)

102 
	#SCAMPER_DO_TRACE_LOOPACTION_DEF
 0

	)

103 
	#SCAMPER_DO_TRACE_LOOPACTION_MAX
 1

	)

105 
	#SCAMPER_DO_TRACE_OFFSET_MIN
 0

	)

106 
	#SCAMPER_DO_TRACE_OFFSET_DEF
 0

	)

107 
	#SCAMPER_DO_TRACE_OFFSET_MAX
 8190

	)

109 
	#SCAMPER_DO_TRACE_PPS_MIN
 1

	)

110 
	#SCAMPER_DO_TRACE_PPS_MAX
 1000

	)

111 
	#SCAMPER_DO_TRACE_PPS_DEF
 20

	)

113 
	#SCAMPER_DO_TRACE_SPORT_MIN
 1

	)

114 
	#SCAMPER_DO_TRACE_SPORT_MAX
 65535

	)

116 
	#SCAMPER_DO_TRACE_TOS_MIN
 0

	)

117 
	#SCAMPER_DO_TRACE_TOS_DEF
 0

	)

118 
	#SCAMPER_DO_TRACE_TOS_MAX
 255

	)

120 
	#SCAMPER_DO_TRACE_WAIT_MIN
 1

	)

121 
	#SCAMPER_DO_TRACE_WAIT_DEF
 5

	)

122 
	#SCAMPER_DO_TRACE_WAIT_MAX
 10

	)

124 
	#SCAMPER_DO_TRACE_WAITPROBE_MIN
 0

	)

125 
	#SCAMPER_DO_TRACE_WAITPROBE_DEF
 0

	)

126 
	#SCAMPER_DO_TRACE_WAITPROBE_MAX
 200

	)

137 
	spmtud_L2_¡©e


139 
	midx
;

140 
	mlow”
;

141 
	muµ”
;

142 
	mš
;

143 
	mout
;

144 
sÿm³r_Œaû_hİ_t
 *
	mhİ
;

145 } 
	tpmtud_L2_¡©e_t
;

154 
	spmtud_TTL_¡©e


156 
	mlow”
;

157 
	muµ”
;

158 
sÿm³r_Œaû_hİ_t
 *
	mhİ
;

159 } 
	tpmtud_TTL_¡©e_t
;

166 
	spmtud_L2


168 
	midx
;

169 
	mmtu
;

170 *
	mdesü
;

171 } 
	tpmtud_L2_t
;

173 
	sŒaû_lss


175 *
	mÇme
;

176 
¥ÏyŒ“_t
 *
	mŒ“
;

177 
¥ÏyŒ“_node_t
 *
	mnode
;

178 } 
	tŒaû_lss_t
;

185 
	sŒaû_´obe


187 
timev®
 
	mtx_tv
;

188 
timev®
 
	mrx_tv
;

189 
ušt16_t
 
	mrx
;

190 
ušt16_t
 
	msize
;

191 
ušt8_t
 
	m‰l
;

192 
ušt8_t
 
	mid
;

193 
ušt8_t
 
	mmode
;

194 
ušt8_t
 
	mæags
;

195 } 
	tŒaû_´obe_t
;

197 
	#TRACE_PROBE_FLAG_DL_TX
 0x01

	)

198 
	#TRACE_PROBE_FLAG_DL_RX
 0x02

	)

199 
	#TRACE_PROBE_FLAG_TIMEOUT
 0x04

	)

200 
	#TRACE_ALLOC_HOPS
 16

	)

207 
	sŒaû_pmtud_¡©e


209 
pmtud_L2_¡©e_t
 *
	mL2
;

210 
pmtud_TTL_¡©e_t
 *
	mTTL
;

211 
sÿm³r_Œaû_hİ_t
 *
	mÏ¡_äagmsg
;

212 
sÿm³r_Œaû_hİ_t
 *
	mÏ¡_hİ
;

213 
sÿm³r_Œaû_pmtud_n_t
 *
	mnÙe
;

214 } 
	tŒaû_pmtud_¡©e_t
;

222 
	sŒaû_¡©e


224 
ušt8_t
 
	mmode
;

225 
ušt8_t
 
	m‰l
;

226 
ušt8_t
 
	m©‹m±
;

227 
ušt8_t
 
	mloİc
;

228 
ušt8_t
 
	moİc
;

229 
ušt16_t
 
	m®loc_hİs
;

230 
ušt16_t
 
	m·ylßd_size
;

231 
ušt16_t
 
	mh—d”_size
;

232 
timev®
 
	mÃxt_tx
;

234 #iâdeà
_WIN32


235 
sÿm³r_fd_t
 *
	m¹sock
;

238 
sÿm³r_fd_t
 *
	micmp
;

239 
sÿm³r_fd_t
 *
	m´obe
;

240 
sÿm³r_fd_t
 *
	mdl
;

241 
sÿm³r_fd_t
 *
	m¿w
;

243 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

244 
sÿm³r_rou‹_t
 *
	mrou‹
;

246 
Œaû_´obe_t
 **
	m´obes
;

247 
ušt16_t
 
	mid_Ãxt
;

248 
ušt16_t
 
	mid_max
;

251 
ušt8_t
 
	mcÚfid’û
;

252 
ušt8_t
 
	mn
;

253 
sÿm³r_addr_t
 **
	mš‹rçûs
;

254 
ušt16_t
 
	mš‹rçûc
;

256 
Œaû_pmtud_¡©e_t
 *
	mpmtud
;

266 
sÿm³r_addr_t
 **
	mlss
;

267 
	mlssc
;

268 
Œaû_lss_t
 *
	mls¡
;

269 } 
	tŒaû_¡©e_t
;

271 cÚ¡ 
ušt8_t
 
	gMODE_RTSOCK
 = 0;

272 cÚ¡ 
ušt8_t
 
	gMODE_DLHDR
 = 1;

273 cÚ¡ 
ušt8_t
 
	gMODE_TRACE
 = 2;

274 cÚ¡ 
ušt8_t
 
	gMODE_LASTDITCH
 = 3;

275 cÚ¡ 
ušt8_t
 
	gMODE_PMTUD_DEFAULT
 = 4;

276 cÚ¡ 
ušt8_t
 
	gMODE_PMTUD_SILENT_L2
 = 5;

277 cÚ¡ 
ušt8_t
 
	gMODE_PMTUD_SILENT_TTL
 = 6;

278 cÚ¡ 
ušt8_t
 
	gMODE_PMTUD_BADSUGG
 = 7;

279 cÚ¡ 
ušt8_t
 
	gMODE_DTREE_FIRST
 = 8;

280 cÚ¡ 
ušt8_t
 
	gMODE_DTREE_FWD
 = 9;

281 cÚ¡ 
ušt8_t
 
	gMODE_DTREE_BACK
 = 10;

283 
	#MODE_MIN
 
MODE_TRACE


	)

284 
	#MODE_MAX
 
MODE_DTREE_BACK


	)

287 
sÿm³r_sk_funcs_t
 
	gŒaû_funcs
;

290 
sÿm³r_addrÿche_t
 *
addrÿche
;

293 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

294 
size_t
 
	gpktbuf_Ën
 = 0;

297 
¥ÏyŒ“_t
 *
	gls£s
 = 
NULL
;

300 
	gsunos
 = 0;

310 cÚ¡ 
pmtud_L2_t
 
	gL2
[] =

340 cÚ¡ 
pmtud_L2_t
 *
	gL2_1454
 = &
L2
[9];

341 cÚ¡ 
pmtud_L2_t
 *
	gL2_1500
 = &
L2
[12];

342 cÚ¡ 
	gL2_út
 = (
L2
è/ (
pmtud_L2_t
);

344 
	#TRACE_OPT_DPORT
 1

	)

345 
	#TRACE_OPT_FIRSTHOP
 2

	)

346 
	#TRACE_OPT_GAPLIMIT
 3

	)

347 
	#TRACE_OPT_GAPACTION
 4

	)

348 
	#TRACE_OPT_LOOPS
 5

	)

349 
	#TRACE_OPT_LOOPACTION
 6

	)

350 
	#TRACE_OPT_MAXTTL
 7

	)

351 
	#TRACE_OPT_PMTUD
 8

	)

352 
	#TRACE_OPT_PAYLOAD
 9

	)

353 
	#TRACE_OPT_PROTOCOL
 10

	)

354 
	#TRACE_OPT_ATTEMPTS
 11

	)

355 
	#TRACE_OPT_ALLATTEMPTS
 12

	)

356 
	#TRACE_OPT_SPORT
 13

	)

357 
	#TRACE_OPT_TOS
 14

	)

358 
	#TRACE_OPT_TTLDST
 15

	)

359 
	#TRACE_OPT_USERID
 16

	)

360 
	#TRACE_OPT_WAIT
 17

	)

361 
	#TRACE_OPT_SRCADDR
 18

	)

362 
	#TRACE_OPT_CONFIDENCE
 19

	)

363 
	#TRACE_OPT_WAITPROBE
 20

	)

364 
	#TRACE_OPT_GSSENTRY
 21

	)

365 
	#TRACE_OPT_LSSNAME
 22

	)

366 
	#TRACE_OPT_OFFSET
 23

	)

368 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

369 {'c', 
NULL
, 
TRACE_OPT_CONFIDENCE
, 
SCAMPER_OPTION_TYPE_NUM
},

370 {'d', 
NULL
, 
TRACE_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_STR
},

371 {'f', 
NULL
, 
TRACE_OPT_FIRSTHOP
, 
SCAMPER_OPTION_TYPE_NUM
},

372 {'g', 
NULL
, 
TRACE_OPT_GAPLIMIT
, 
SCAMPER_OPTION_TYPE_NUM
},

373 {'G', 
NULL
, 
TRACE_OPT_GAPACTION
, 
SCAMPER_OPTION_TYPE_NUM
},

374 {'l', 
NULL
, 
TRACE_OPT_LOOPS
, 
SCAMPER_OPTION_TYPE_NUM
},

375 {'L', 
NULL
, 
TRACE_OPT_LOOPACTION
, 
SCAMPER_OPTION_TYPE_NUM
},

376 {'m', 
NULL
, 
TRACE_OPT_MAXTTL
, 
SCAMPER_OPTION_TYPE_NUM
},

377 {'M', 
NULL
, 
TRACE_OPT_PMTUD
, 
SCAMPER_OPTION_TYPE_NULL
},

378 {'o', 
NULL
, 
TRACE_OPT_OFFSET
, 
SCAMPER_OPTION_TYPE_NUM
},

379 {'p', 
NULL
, 
TRACE_OPT_PAYLOAD
, 
SCAMPER_OPTION_TYPE_STR
},

380 {'P', 
NULL
, 
TRACE_OPT_PROTOCOL
, 
SCAMPER_OPTION_TYPE_STR
},

381 {'q', 
NULL
, 
TRACE_OPT_ATTEMPTS
, 
SCAMPER_OPTION_TYPE_NUM
},

382 {'Q', 
NULL
, 
TRACE_OPT_ALLATTEMPTS
, 
SCAMPER_OPTION_TYPE_NULL
},

383 {'s', 
NULL
, 
TRACE_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

384 {'S', 
NULL
, 
TRACE_OPT_SRCADDR
, 
SCAMPER_OPTION_TYPE_STR
},

385 {'t', 
NULL
, 
TRACE_OPT_TOS
, 
SCAMPER_OPTION_TYPE_NUM
},

386 {'T', 
NULL
, 
TRACE_OPT_TTLDST
, 
SCAMPER_OPTION_TYPE_NULL
},

387 {'U', 
NULL
, 
TRACE_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

388 {'w', 
NULL
, 
TRACE_OPT_WAIT
, 
SCAMPER_OPTION_TYPE_NUM
},

389 {'W', 
NULL
, 
TRACE_OPT_WAITPROBE
, 
SCAMPER_OPTION_TYPE_NUM
},

390 {'z', 
NULL
, 
TRACE_OPT_GSSENTRY
, 
SCAMPER_OPTION_TYPE_STR
},

391 {'Z', 
NULL
, 
TRACE_OPT_LSSNAME
, 
SCAMPER_OPTION_TYPE_STR
},

393 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

395 cÚ¡ *
	$sÿm³r_do_Œaû_u§ge
()

403 
	}
}

405 
sÿm³r_Œaû_t
 *
	$Œaû_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

407  
	`sÿm³r_sk_g‘d©a
(
sk
);

408 
	}
}

410 
Œaû_¡©e_t
 *
	$Œaû_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

412  
	`sÿm³r_sk_g‘¡©e
(
sk
);

413 
	}
}

415 
	$k
(
Œaû_¡©e_t
 *
¡©e
)

423 cÚ¡ 
k
[][2] = {

452 
	#TRACE_CONFIDENCE_MAX_N
 25

	)

454 
	`as£¹
(
¡©e
->
cÚfid’û
 < 2);

455 
	`as£¹
(
¡©e
->
n
 >= 2);

456 
	`as£¹
(
¡©e
->
n
 <ğ
TRACE_CONFIDENCE_MAX_N
);

457  
k
[
¡©e
->
n
][¡©e->
cÚfid’û
];

458 
	}
}

466 
	$Œaû_queue
(
sÿm³r_sk_t
 *
sk
)

468 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

469 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

470 
timev®
 
tv
;

472 
	`as£¹
(
¡©e
->
©‹m±
 < 
Œaû
->
©‹m±s
 ||¿û->
cÚfid’û
 != 0);

474 if(
Œaû
->
wa™_´obe
 == 0)

475  
	`sÿm³r_sk_queue_´obe
(
sk
);

477 
	`g‘timeofday_w¿p
(&
tv
);

478 if(
	`timev®_cmp
(&
¡©e
->
Ãxt_tx
, &
tv
) <= 0)

479  
	`sÿm³r_sk_queue_´obe
(
sk
);

481  
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
¡©e
->
Ãxt_tx
);

482 
	}
}

484 
	$Œaû_lss_ä“
(
Œaû_lss_t
 *
lss
)

486 if(
lss
 =ğ
NULL
)

489 if(
lss
->
Çme
 !ğ
NULL
)

490 
	`ä“
(
lss
->
Çme
);

491 if(
lss
->
Œ“
 !ğ
NULL
)

492 
	`¥ÏyŒ“_ä“
(
lss
->
Œ“
, (
¥ÏyŒ“_ä“_t
)
sÿm³r_addr_ä“
);

494 
	`ä“
(
lss
);

496 
	}
}

498 
	$Œaû_lss_cmp
(cÚ¡ *
va
, cÚ¡ *
vb
)

500 cÚ¡ 
Œaû_lss_t
 *
a
 = 
va
;

501 cÚ¡ 
Œaû_lss_t
 *
b
 = 
vb
;

502  
	`¡rÿ£cmp
(
a
->
Çme
, 
b
->name);

503 
	}
}

505 
Œaû_lss_t
 *
	$Œaû_lss_g‘
(*
Çme
)

507 
Œaû_lss_t
 
fšdme
, *
lss
;

510 if(
ls£s
 =ğ
NULL
 &&

511 (
ls£s
 = 
	`¥ÏyŒ“_®loc
((
¥ÏyŒ“_cmp_t
)
Œaû_lss_cmp
)è=ğ
NULL
)

513 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocate†ss");

514  
NULL
;

517 
fšdme
.
Çme
 =‚ame;

518 if((
lss
 = 
	`¥ÏyŒ“_fšd
(
ls£s
, &
fšdme
)è!ğ
NULL
)

519  
lss
;

521 if((
lss
 = 
	`m®loc_z”o
((
Œaû_lss_t
))è=ğ
NULL
 ||

522 (
lss
->
Çme
 = 
	`¡rdup
Òame)è=ğ
NULL
 ||

523 (
lss
->
Œ“
 = 
	`¥ÏyŒ“_®loc
((
¥ÏyŒ“_cmp_t
)
sÿm³r_addr_cmp
))==
NULL
 ||

524 (
lss
->
node
 = 
	`¥ÏyŒ“_š£¹
(
ls£s
,†ss)è=ğ
NULL
)

526 
	`Œaû_lss_ä“
(
lss
);

527  
NULL
;

530  
lss
;

531 
	}
}

540 
	$pmtud_L2_£t_´obesize
(
Œaû_¡©e_t
 *
¡©e
, 
low”
, 
uµ”
)

542 
pmtud_L2_¡©e_t
 *
l2
;

543 
idx
, 
size
;

546 
	`as£¹
(
low”
 + 1 !ğ
uµ”
);

549 
	`as£¹
(
¡©e
->
pmtud
 !ğ
NULL
);

550 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

551 
l2
 = 
¡©e
->
pmtud
->
L2
;

554 
idx
 = 
l2
->idx;

555 
	`as£¹
(
idx
 >= 0);

556 
	`as£¹
(
idx
 < 
L2_út
);

559 
	`as£¹
(
l2
->
low”
 == -1 ||†ower >=†2->lower);

560 
	`as£¹
(
l2
->
uµ”
 == -1 || upper <=†2->upper);

571 if(
low”
 =ğ1500 || (low” =ğ
L2
[
idx
].
mtu
 && 
uµ”
 <= L2[idx+1].mtu))

573 
size
 = 
low”
 + 1;

579 if(
low”
 >ğ
L2
[
idx
].
mtu
 && L2[idx+1].mtu < 
uµ”
)

581 
size
 = 
L2
[++
idx
].
mtu
;

587 if(
uµ”
 =ğ
L2
[
idx
].
mtu
 && 
low”
 < L2[idx-1].mtu)

589 
size
 = 
L2
[--
idx
].
mtu
;

596 
size
 = (
low”
 + 
uµ”
) / 2;

599 
¡©e
->
©‹m±
 = 0;

600 
¡©e
->
·ylßd_size
 = 
size
 - s‹->
h—d”_size
;

601 
l2
->
idx
 = idx;

602 
l2
->
low”
 =†ower;

603 
l2
->
uµ”
 = upper;

606 
	}
}

615 
	$pmtud_L2_š™
(
Œaû_¡©e_t
 *
¡©e
)

617 
pmtud_L2_¡©e_t
 *
l2
;

618 
size
 = 
¡©e
->
h—d”_size
 + s‹->
·ylßd_size
;

619 
idx
;

627 if(
size
 > 1500)

629 
idx
 = 
L2_1500
->idx;

635 if(
size
 > 1454)

637 
idx
 = 
L2_1454
->idx;

641 
idx
=0; idx<
L2_út
-1; idx++)

643 if(
size
 > 
L2
[
idx
].
mtu
 && size <= L2[idx+1].mtu)

650 if((
l2
 = 
	`m®loc_z”o
((
pmtud_L2_¡©e_t
))è=ğ
NULL
)

652 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc L2");

655 
l2
->
idx
 = idx;

656 
l2
->
low”
 = -1;

657 
l2
->
uµ”
 = 
size
;

658 
l2
->
š
 = 
size
;

659 
l2
->
out
 = -1;

661 
¡©e
->
pmtud
->
L2
 = 
l2
;

662 
¡©e
->
·ylßd_size
 = 
L2
[
idx
].
mtu
 - s‹->
h—d”_size
;

663 
¡©e
->
©‹m±
 = 0;

666 
	}
}

673 
	$pmtud_TTL_£t_´ob‘
(
sÿm³r_sk_t
 *
sk
,

674 cÚ¡ 
low”
, 
uµ”
)

676 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

677 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

678 
cur
;

680 
	`as£¹
(
¡©e
->
pmtud
->
TTL
 !ğ
NULL
);

683 
low”
 + 1 < 
uµ”
)

686 
cur
 = (
low”
 + 
uµ”
) / 2;

692 
cur
 < 
uµ”
 && 
Œaû
->
hİs
[cur-1] =ğ
NULL
)

694 
cur
++;

698 if(
cur
 !ğ
uµ”
)

700 
¡©e
->
pmtud
->
TTL
->
low”
 =†ower;

701 
¡©e
->
pmtud
->
TTL
->
uµ”
 = upper;

702 
¡©e
->
‰l
 = 
cur
;

703 
¡©e
->
©‹m±
 = 0;

711 
uµ”
 = (
low”
 + upper) / 2;

715 
	}
}

723 
sÿm³r_Œaû_hİ_t
 *
	$hİ_fšd
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

724 cÚ¡ 
sÿm³r_addr_t
 *
addr
)

726 
sÿm³r_Œaû_hİ_t
 *
hİ
;

727 
ušt16_t
 
i
;

729 
i
=
Œaû
->
fœ¡hİ
-1; i<Œaû->
hİ_couÁ
; i++)

731 
hİ
 = 
Œaû
->
hİs
[
i
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

733 if(
	`sÿm³r_addr_cmp
(
hİ
->
hİ_addr
, 
addr
) == 0)

735  
hİ
;

740  
NULL
;

741 
	}
}

748 
	$pmtud_TTL_š™
(
sÿm³r_sk_t
 *
sk
)

750 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

751 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

752 
sÿm³r_Œaû_hİ_t
 *
hİ
;

753 
low”
, 
uµ”
;

755 if((
¡©e
->
pmtud
->
TTL
 = 
	`m®loc_z”o
((
pmtud_TTL_¡©e_t
))è=ğ
NULL
)

757 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc TTL");

765 
¡©e
->
·ylßd_size
 = s‹->
pmtud
->
L2
->
š
 - s‹->
h—d”_size
;

773 
hİ
 = 
¡©e
->
pmtud
->
Ï¡_äagmsg
;

774 if(
hİ
 =ğ
NULL
 || (
low”
 = hİ->
hİ_´obe_‰l
 - hİ->
hİ_icmp_q_‰l
) < 1)

775 
low”
 = 0;

781 if((
hİ
 = 
	`hİ_fšd
(
Œaû
, 
¡©e
->
pmtud
->
L2
->hİ->
hİ_addr
)è!ğ
NULL
)

783 
uµ”
 = 
hİ
->
hİ_´obe_‰l
;

787 
hİ
 = 
¡©e
->
pmtud
->
L2
->hop;

788 
uµ”
 = 
hİ
->
hİ_´obe_‰l
 - hİ->
hİ_icmp_q_‰l
 + 1;

792 if(
	`pmtud_TTL_£t_´ob‘
(
sk
, 
low”
, 
uµ”
) == 0)

798 
	}
}

805 
	$pmtud_hİšs
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_Œaû_hİ_t
 *
hİ
)

807 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

808 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

810 
	`as£¹
(
hİ
 !ğ
NULL
);

811 
	`as£¹
(
hİ
->
hİ_Ãxt
 =ğ
NULL
);

813 if(
¡©e
->
pmtud
->
Ï¡_hİ
 =ğ
NULL
)

814 
Œaû
->
pmtud
->
hİs
 = 
hİ
;

816 
¡©e
->
pmtud
->
Ï¡_hİ
->
hİ_Ãxt
 = 
hİ
;

817 
¡©e
->
pmtud
->
Ï¡_hİ
 = 
hİ
;

820 
	}
}

829 
	$pmtud_L2_£¬ch_’d
(
sÿm³r_sk_t
 *
sk
)

831 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

832 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

833 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
;

834 
sÿm³r_Œaû_hİ_t
 *
hİ
;

835 
ušt16_t
 
out
;

837 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

838 
	`as£¹
(
¡©e
->
pmtud
->
L2
->
out
 >= 0);

839 
	`as£¹
(
¡©e
->
pmtud
->
L2
->
out
 <= 65535);

841 
out
 = 
¡©e
->
pmtud
->
L2
->out;

842 
hİ
 = 
¡©e
->
pmtud
->
L2
->hop;

845 
	`ä“
(
¡©e
->
pmtud
->
L2
);

846 
¡©e
->
pmtud
->
L2
 = 
NULL
;

848 
nÙe
 = 
¡©e
->
pmtud
->note;

849 
nÙe
->
nhmtu
 = 
out
;

850 
	`sÿm³r_Œaû_pmtud_n_add
(
Œaû
->
pmtud
, 
nÙe
);

851 
¡©e
->
pmtud
->
nÙe
 = 
NULL
;

857 if(
¡©e
->
pmtud
->
TTL
 !ğ
NULL
)

859 if(
¡©e
->
pmtud
->
TTL
->
hİ
 !ğ
NULL
)

865 
nÙe
->
hİ
 = 
¡©e
->
pmtud
->
TTL
->hop;

867 if(
¡©e
->
pmtud
->
TTL
->
low”
 == 0)

875 
Œaû
->
pmtud
->
outmtu
 = 
out
;

878 
	`ä“
(
¡©e
->
pmtud
->
TTL
);

879 
¡©e
->
pmtud
->
TTL
 = 
NULL
;

882 if(
hİ
 !ğ
NULL
)

889 
¡©e
->
pmtud
->
Ï¡_äagmsg
 = 
hİ
;

896 if(!
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
))

898 
Œaû
->
pmtud
->
pmtu
 = 
hİ
->
hİ_´obe_size
;

899 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

904 
¡©e
->
·ylßd_size
 = 
out
 - s‹->
h—d”_size
;

905 
¡©e
->
mode
 = 
MODE_PMTUD_DEFAULT
;

906 
¡©e
->
©‹m±
 = 0;

907 
¡©e
->
‰l
 = 255;

910 
	}
}

912 
	$dŒ“_lss_add
(
Œaû_¡©e_t
 *
¡©e
, 
sÿm³r_addr_t
 *
içû
)

914 
	`as£¹
(
¡©e
 !ğ
NULL
 && s‹->
ls¡
 != NULL);

915 if(
	`¥ÏyŒ“_š£¹
(
¡©e
->
ls¡
->
Œ“
, 
içû
è!ğ
NULL
)

917 
	`sÿm³r_addr_u£
(
içû
);

921 
	}
}

923 
	$dŒ“_lss_š
(
Œaû_¡©e_t
 *
¡©e
, 
sÿm³r_addr_t
 *
içû
)

925 
	`as£¹
(
¡©e
 !ğ
NULL
 && s‹->
ls¡
 != NULL);

926 if(
	`¥ÏyŒ“_fšd
(
¡©e
->
ls¡
->
Œ“
, 
içû
è!ğ
NULL
)

929 
	}
}

931 
	$¡©e_lss_š
(
Œaû_¡©e_t
 *
¡©e
, 
sÿm³r_addr_t
 *
içû
)

933 if(
	`¬¿y_fšd
((**)
¡©e
->
lss
, s‹->
lssc
, 
içû
,

934 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

939 
	}
}

941 
	$¡©e_lss_add
(
Œaû_¡©e_t
 *
¡©e
, 
sÿm³r_addr_t
 *
içû
)

943 if(
	`¬¿y_š£¹
((***)&
¡©e
->
lss
, &¡©e->
lssc
, 
içû
,

944 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
) == 0)

949 
	}
}

965 
	$Œaû_id_fudge
(cÚ¡ 
Œaû_¡©e_t
 *
¡©e
,

966 cÚ¡ 
ušt16_t
 
id
, ušt16_ˆ*
id
)

969 if(
id
 == 0)

975 if(
id
 <ğ
¡©e
->
id_Ãxt
)

977 *
id
 = 
id
 - 1;

982 if(
id
 =ğ
¡©e
->
id_Ãxt
 + 1)

984 
	`sÿm³r_debug
(
__func__
, "ip id one greaterhan sent");

985 *
id
 = 
id
 - 2;

990 if(
	`by‹sw­16
(
id
è<ğ
¡©e
->
id_Ãxt
)

992 
	`sÿm³r_debug
(
__func__
, "ip id byte swapped");

993 *
id
 = 
	`by‹sw­16
(
id
) - 1;

998 
	}
}

1005 
	$Œaû_¡İ
(
sÿm³r_Œaû_t
 *
Œaû
,

1006 cÚ¡ 
ušt8_t
 
»asÚ
, cÚ¡ ušt8_ˆ
d©a
)

1009 if(
Œaû
->
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
)

1011 
	`sÿm³r_debug
(
__func__
, "reason %d/%d…receeds %d/%d",

1012 
Œaû
->
¡İ_»asÚ
,¿û->
¡İ_d©a
, 
»asÚ
, 
d©a
);

1016 
Œaû
->
¡İ_»asÚ
 = 
»asÚ
;

1017 
Œaû
->
¡İ_d©a
 = 
d©a
;

1020 
	}
}

1022 
	$Œaû_¡İ_com¶‘ed
(
sÿm³r_Œaû_t
 *
Œaû
)

1024 
	`Œaû_¡İ
(
Œaû
, 
SCAMPER_TRACE_STOP_COMPLETED
, 0);

1026 
	}
}

1028 
	$Œaû_¡İ_g­lim™
(
sÿm³r_Œaû_t
 *
Œaû
)

1030 
	`Œaû_¡İ
(
Œaû
, 
SCAMPER_TRACE_STOP_GAPLIMIT
, 0);

1032 
	}
}

1034 
	$Œaû_¡İ_”rÜ
(
sÿm³r_Œaû_t
 *
Œaû
, 
”rÜ
)

1036 
	`Œaû_¡İ
(
Œaû
, 
SCAMPER_TRACE_STOP_ERROR
, 
”rÜ
);

1038 
	}
}

1040 
	$Œaû_¡İ_hİlim™
(
sÿm³r_Œaû_t
 *
Œaû
)

1042 
	`Œaû_¡İ
(
Œaû
, 
SCAMPER_TRACE_STOP_HOPLIMIT
, 0);

1044 
	}
}

1051 
	$Œaû_i¦oİ
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

1052 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
,

1053 
Œaû_¡©e_t
 *
¡©e
)

1055 
sÿm³r_Œaû_hİ_t
 *
tmp
;

1056 
i
;

1059 if(
hİ
->
hİ_´obe_‰l
 <ğ
Œaû
->
fœ¡hİ
)

1069 
tmp
 = 
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1];m°!ğhİ;m°ğtmp->
hİ_Ãxt
)

1071 if(
	`sÿm³r_addr_cmp
(
hİ
->
hİ_addr
, 
tmp
->hop_addr) == 0)

1078 
i
=
hİ
->
hİ_´obe_‰l
-2; i>=
Œaû
->
fœ¡hİ
-1; i--)

1080 
tmp
 = 
Œaû
->
hİs
[
i
];m°!ğ
NULL
;m°ğtmp->
hİ_Ãxt
)

1082 
	`as£¹
(
i
+1 =ğ
tmp
->
hİ_´obe_‰l
);

1085 if(
	`sÿm³r_addr_cmp
(
hİ
->
hİ_addr
, 
tmp
->hop_addr) == 0)

1090 if(
tmp
->
hİ_´obe_‰l
 + 1 =ğ
hİ
->hop_probe_ttl)

1096 if(
tmp
->
hİ_icmp_q_‰l
 =ğ0 && 
hİ
->hop_icmp_q_ttl == 1)

1106 if(++
¡©e
->
oİc
 <ğ
Œaû
->
loİaùiÚ
)

1111 
¡©e
->
loİc
++;

1112 if(
¡©e
->
loİc
 >ğ
Œaû
->
loİs
)

1124 
	}
}

1131 
	$Œaû_hİšs
(
sÿm³r_Œaû_hİ_t
 **
hİs
, sÿm³r_Œaû_hİ_ˆ*
hİ
)

1133 
sÿm³r_Œaû_hİ_t
 *
´e
, *
cur
;

1135 
	`as£¹
(
hİs
 !ğ
NULL
);

1136 
	`as£¹
(
hİ
 !ğ
NULL
);

1139 if((
cur
 = *
hİs
è=ğ
NULL
)

1141 *
hİs
 = 
hİ
;

1142 
hİ
->
hİ_Ãxt
 = 
NULL
;

1147 
´e
 = 
NULL
;

1148 
cur
 !ğ
NULL
 && cur->
hİ_´obe_id
 <ğ
hİ
->hop_probe_id)

1150 
´e
 = 
cur
;

1151 
cur
 = cur->
hİ_Ãxt
;

1155 if(
´e
 =ğ
NULL
)

1157 
	`as£¹
(
hİ
->
hİ_´obe_id
 < 
cur
->hop_probe_id);

1158 *
hİs
 = 
hİ
;

1162 
´e
->
hİ_Ãxt
 = 
hİ
;

1164 
hİ
->
hİ_Ãxt
 = 
cur
;

1167 
	}
}

1175 
	$Œaû_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, cÚ¡ 
”rÜ
)

1177 
	`Œaû_¡İ_”rÜ
(
	`Œaû_g‘d©a
(
sk
), 
”rÜ
);

1178 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1180 
	}
}

1189 
sÿm³r_Œaû_hİ_t
 *
	$Œaû_hİ
(cÚ¡ 
Œaû_´obe_t
 *
´obe
,

1190 cÚ¡ 
af
, cÚ¡ *
addr
)

1192 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
NULL
;

1193 
ty³
;

1196 if(
af
 =ğ
AF_INET
è
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

1197 if(
af
 =ğ
AF_INET6
è
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

1198 
”r
;

1200 if((
hİ
 = 
	`sÿm³r_Œaû_hİ_®loc
()è=ğ
NULL
)

1202 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc hop");

1203 
”r
;

1206 if((
hİ
->
hİ_addr
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
ty³
, 
addr
)è=ğ
NULL
)

1208 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get‡ddr");

1209 
”r
;

1212 
hİ
->
hİ_´obe_‰l
 = 
´obe
->
‰l
;

1213 
hİ
->
hİ_´obe_id
 = 
´obe
->
id
 + 1;

1214 
hİ
->
hİ_´obe_size
 = 
´obe
->
size
;

1220 if(
´obe
->
æags
 & 
TRACE_PROBE_FLAG_DL_TX
)

1221 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_TS_DL_TX
;

1223  
hİ
;

1225 
”r
:

1226 if(
hİ
 !ğ
NULL
è
	`sÿm³r_Œaû_hİ_ä“
(hop);

1227  
NULL
;

1228 
	}
}

1236 
sÿm³r_Œaû_hİ_t
 *
	$Œaû_icmp_hİ
(
sÿm³r_Œaû_t
 *
Œaû
,

1237 
Œaû_´obe_t
 *
´obe
,

1238 
sÿm³r_icmp_»¥_t
 *
œ
)

1240 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
NULL
;

1241 
sÿm³r_addr_t
 
addr
;

1244 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
addr
) != 0)

1245 
”r
;

1248 if((
hİ
 = 
	`Œaû_hİ
(
´obe
, 
œ
->
œ_af
, 
addr
.addr)è=ğ
NULL
)

1249 
”r
;

1252 
hİ
->
hİ_»¶y_size
 = 
œ
->
œ__size
;

1253 
hİ
->
hİ_icmp_ty³
 = 
œ
->
œ_icmp_ty³
;

1254 
hİ
->
hİ_icmp_code
 = 
œ
->
œ_icmp_code
;

1260 if(
œ
->
œ__‰l
 != -1)

1262 
hİ
->
hİ_»¶y_‰l
 = (
ušt8_t
)
œ
->
œ__‰l
;

1263 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_REPLY_TTL
;

1270 if(
´obe
->
æags
 & 
TRACE_PROBE_FLAG_DL_RX
)

1272 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_TS_DL_RX
;

1273 
	`timev®_diff_tv
(&
hİ
->
hİ_¹t
, &
´obe
->
tx_tv
, &´obe->
rx_tv
);

1277 
	`timev®_diff_tv
(&
hİ
->
hİ_¹t
, &
´obe
->
tx_tv
, &
œ
->
œ_rx
);

1278 if(
œ
->
œ_æags
 & 
SCAMPER_ICMP_RESP_FLAG_KERNRX
)

1280 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_TS_SOCK_RX
;

1284 if(
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
))

1285 
hİ
->
hİ_icmp_nhmtu
 = 
œ
->
œ_icmp_nhmtu
;

1287 if(
œ
->
œ_af
 =ğ
AF_INET
)

1289 
hİ
->
hİ_»¶y_id
 = 
œ
->
œ__id
;

1290 
hİ
->
hİ_»¶y_tos
 = 
œ
->
œ__tos
;

1293 if(
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
))

1295 
hİ
->
hİ_icmp_q_‰l
 = 
œ
->
œ_šÃr__‰l
;

1296 
hİ
->
hİ_icmp_q_l
 = 
œ
->
œ_šÃr__size
;

1302 if(
œ
->
œ_af
 =ğ
AF_INET
)

1303 
hİ
->
hİ_icmp_q_tos
 = 
œ
->
œ_šÃr__tos
;

1307 if(
œ
->
œ_ext
 !ğ
NULL
 &&

1308 
	`sÿm³r_icm³xt_·r£
(&
hİ
->
hİ_icm³xt
,
œ
->
œ_ext
,œ->
œ_ex’
) != 0)

1310 
”r
;

1314 if(
´obe
->
rx
 != 65535)

1315 
´obe
->
rx
++;

1317  
hİ
;

1319 
”r
:

1320 if(
hİ
 !ğ
NULL
è
	`sÿm³r_Œaû_hİ_ä“
(hop);

1321  
NULL
;

1322 
	}
}

1324 
sÿm³r_Œaû_hİ_t
 *
	$Œaû_tı_hİ
(
Œaû_´obe_t
 *
´obe
,

1325 
sÿm³r_dl_»c_t
 *
dl
)

1327 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
NULL
;

1330 if((
hİ
 = 
	`Œaû_hİ
(
´obe
, 
dl
->
dl_af
, dl->
dl__¤c
)è=ğ
NULL
)

1331 
”r
;

1334 
hİ
->
hİ_»¶y_size
 = 
dl
->
dl__size
;

1335 
hİ
->
hİ_»¶y_‰l
 = 
dl
->
dl__‰l
;

1336 
hİ
->
hİ_tı_æags
 = 
dl
->
dl_tı_æags
;

1337 
	`timev®_diff_tv
(&
hİ
->
hİ_¹t
, &
´obe
->
tx_tv
, &
dl
->
dl_tv
);

1340 
hİ
->
hİ_æags
 |ğ(
SCAMPER_TRACE_HOP_FLAG_REPLY_TTL
 |

1341 
SCAMPER_TRACE_HOP_FLAG_TCP
 |

1342 
SCAMPER_TRACE_HOP_FLAG_TS_DL_RX
);

1344 if(
dl
->
dl_af
 =ğ
AF_INET
)

1346 
hİ
->
hİ_»¶y_id
 = 
dl
->
dl__id
;

1347 
hİ
->
hİ_»¶y_tos
 = 
dl
->
dl__tos
;

1350  
hİ
;

1352 
”r
:

1353 if(
hİ
 !ğ
NULL
è
	`sÿm³r_Œaû_hİ_ä“
(hop);

1354  
NULL
;

1355 
	}
}

1363 
	$Œaû_Ãxt_mode
(
sÿm³r_sk_t
 *
sk
)

1365 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1366 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

1367 
ušt16_t
 
ifmtu
;

1368 
ifšdex
;

1370 if(
	`SCAMPER_TRACE_IS_DOUBLETREE
(
Œaû
))

1372 if(
¡©e
->
mode
 =ğ
MODE_DTREE_FWD
)

1374 if(
Œaû
->
fœ¡hİ
 > 1)

1376 
¡©e
->
mode
 = 
MODE_DTREE_BACK
;

1377 
¡©e
->
‰l
 = 
Œaû
->
fœ¡hİ
 - 1;

1378 
¡©e
->
©‹m±
 = 0;

1379 
	`Œaû_queue
(
sk
);

1381 
dÚe
;

1383 if(
¡©e
->
mode
 =ğ
MODE_DTREE_BACK
)

1384 
dÚe
;

1389 if(
	`SCAMPER_TRACE_IS_PMTUD
(
Œaû
) == 0 ||

1390 
Œaû
->
¡İ_»asÚ
 =ğ
SCAMPER_TRACE_STOP_HOPLIMIT
 ||

1391 
Œaû
->
¡İ_»asÚ
 =ğ
SCAMPER_TRACE_STOP_GAPLIMIT
 ||

1392 
Œaû
->
¡İ_»asÚ
 =ğ
SCAMPER_TRACE_STOP_LOOP
 ||

1393 
Œaû
->
¡İ_»asÚ
 =ğ
SCAMPER_TRACE_STOP_NONE
)

1394 
dÚe
;

1397 
	`sÿm³r_fd_ifšdex
(
¡©e
->
dl
, &
ifšdex
);

1398 if(
	`sÿm³r_if_g‘mtu
(
ifšdex
, &
ifmtu
è=ğ-1 || ifmtu <ğ
¡©e
->
h—d”_size
)

1399 
dÚe
;

1401 if(
	`sÿm³r_Œaû_pmtud_®loc
(
Œaû
) != 0)

1402 
dÚe
;

1403 if((
¡©e
->
pmtud
 = 
	`m®loc_z”o
((
Œaû_pmtud_¡©e_t
))è=ğ
NULL
)

1404 
dÚe
;

1405 
Œaû
->
pmtud
->
ifmtu
 = ifmtu;

1406 
Œaû
->
pmtud
->
v”
 = 2;

1408 
¡©e
->
©‹m±
 = 0;

1409 
¡©e
->
mode
 = 
MODE_PMTUD_DEFAULT
;

1410 
¡©e
->
·ylßd_size
 = 
ifmtu
 - s‹->
h—d”_size
;

1411 
¡©e
->
‰l
 = 255;

1413 
	`Œaû_queue
(
sk
);

1416 
dÚe
:

1417 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1419 
	}
}

1426 
	$Œaû_¡İ_»asÚ
(
sÿm³r_Œaû_t
 *
Œaû
, 
sÿm³r_Œaû_hİ_t
 *
hİ
,

1427 
Œaû_¡©e_t
 *
¡©e
,

1428 
ušt8_t
 *
¡İ_»asÚ
, ušt8_ˆ*
¡İ_d©a
)

1430 
rc
;

1437 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_UNREACH_PORT
(
hİ
) &&

1438 (
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
è|| 
	`SCAMPER_TRACE_TYPE_IS_TCP
(trace)))

1440 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_COMPLETED
;

1441 *
¡İ_d©a
 = 0;

1443 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_UNREACH
(
hİ
))

1445 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_UNREACH
;

1446 *
¡İ_d©a
 = 
hİ
->
hİ_icmp_code
;

1448 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_ECHO_REPLY
(
hİ
))

1455 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO
 ||

1456 
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
)

1458 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_COMPLETED
;

1459 *
¡İ_d©a
 = 0;

1463 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_NONE
;

1464 *
¡İ_d©a
 = 0;

1467 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 &&

1468 
hİ
->
hİ_icmp_ty³
 =ğ
ICMP6_PACKET_TOO_BIG
)

1474 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_ICMP
;

1475 *
¡İ_d©a
 = 
hİ
->
hİ_icmp_ty³
;

1477 if(
Œaû
->
loİs
 !ğ0 && (
rc
 = 
	`Œaû_i¦oİ
Ñ¿û, 
hİ
, 
¡©e
)) != 0)

1480 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_LOOP
;

1481 *
¡İ_d©a
 = 0;

1483 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_TTL_EXP
(
hİ
) &&

1484 
	`SCAMPER_TRACE_IS_IGNORETTLDST
(
Œaû
) == 0 &&

1485 
	`sÿm³r_addr_cmp
(
Œaû
->
d¡
, 
hİ
->
hİ_addr
) == 0)

1492 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_COMPLETED
;

1493 *
¡İ_d©a
 = 0;

1495 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
è&& 
	`SCAMPER_TRACE_HOP_IS_TCP
(
hİ
))

1497 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_COMPLETED
;

1498 *
¡İ_d©a
 = 0;

1500 if(
	`SCAMPER_TRACE_IS_DOUBLETREE
(
Œaû
) &&

1501 
	`sÿm³r_Œaû_dŒ“_gss_fšd
(
Œaû
, 
hİ
->
hİ_addr
è!ğ
NULL
)

1503 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_GSS
;

1504 *
¡İ_d©a
 = 0;

1505 
Œaû
->
dŒ“
->
gss_¡İ
 = 
	`sÿm³r_addr_u£
(
hİ
->
hİ_addr
);

1509 *
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_NONE
;

1510 *
¡İ_d©a
 = 0;

1514 
	}
}

1522 
	$hªdËicmp_Œaû
(
sÿm³r_sk_t
 *
sk
,

1523 
sÿm³r_icmp_»¥_t
 *
œ
,

1524 
Œaû_´obe_t
 *
´obe
)

1526 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1527 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

1528 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1529 
ušt8_t
 
¡İ_»asÚ
;

1530 
ušt8_t
 
¡İ_d©a
;

1531 
size_t
 
Ën
;

1533 
	`as£¹
(
¡©e
->
mode
 =ğ
MODE_TRACE
 ||

1534 
¡©e
->
mode
 =ğ
MODE_DTREE_FWD
 || s‹->mod=ğ
MODE_DTREE_BACK
);

1537 if(
´obe
->
mode
 !ğ
MODE_TRACE
 &&

1538 
´obe
->
mode
 !ğ
MODE_DTREE_FWD
 &&…robe->mod!ğ
MODE_DTREE_BACK
)

1544 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1548 
	`Œaû_hİšs
(&
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1], hop);

1554 if(
hİ
->
hİ_´obe_‰l
 !ğ
¡©e
->
‰l
)

1557 
	`Œaû_¡İ_»asÚ
(
Œaû
, 
hİ
, 
¡©e
, &
¡İ_»asÚ
, &
¡İ_d©a
);

1558 if(
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
)

1560 
	`Œaû_¡İ
(
Œaû
, 
¡İ_»asÚ
, 
¡İ_d©a
);

1561 
	`Œaû_Ãxt_mode
(
sk
);

1572 if(
	`SCAMPER_TRACE_IS_ALLATTEMPTS
(
Œaû
))

1574 
	`as£¹
(
Œaû
->
cÚfid’û
 == 0);

1580 if(
´obe
->
id
+1 !ğ
¡©e
->
©‹m±
)

1589 if(
¡©e
->
©‹m±
 < 
Œaû
->
©‹m±s
)

1591 
	`Œaû_queue
(
sk
);

1595 if(
Œaû
->
cÚfid’û
 != 0)

1601 if(
	`¬¿y_fšd
((**)
¡©e
->
š‹rçûs
, s‹->
š‹rçûc
,

1602 
hİ
->
hİ_addr
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è=ğ
NULL
)

1604 
Ën
 = (
¡©e
->
š‹rçûc
 + 1è* (
sÿm³r_addr_t
 *);

1605 if(
	`»®loc_w¿p
((**)&
¡©e
->
š‹rçûs
, 
Ën
) != 0)

1607 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

1609 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

1613 
¡©e
->
š‹rçûs
[¡©e->
š‹rçûc
++] = 
hİ
->
hİ_addr
;

1615 if(
¡©e
->
š‹rçûc
 > 1)

1617 
	`¬¿y_qsÜt
((**)
¡©e
->
š‹rçûs
, s‹->
š‹rçûc
,

1618 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
);

1619 
¡©e
->
n
++;

1627 if(
¡©e
->
n
 <ğ
TRACE_CONFIDENCE_MAX_N
)

1633 if(
´obe
->
id
+1 !ğ
¡©e
->
©‹m±
)

1642 if(
¡©e
->
©‹m±
 < 
	`k
(state))

1644 
	`Œaû_queue
(
sk
);

1649 
	`ä“
(
¡©e
->
š‹rçûs
);

1650 
¡©e
->
š‹rçûs
 = 
NULL
;

1651 
¡©e
->
š‹rçûc
 = 0;

1652 
¡©e
->
n
 = 2;

1655 
¡©e
->
©‹m±
 = 0;

1657 if(
¡©e
->
mode
 =ğ
MODE_DTREE_BACK
)

1659 if(
¡©e
->
‰l
 == 1)

1661 
	`Œaû_Ãxt_mode
(
sk
);

1669 if(
¡©e
->
ls¡
 !ğ
NULL
 && 
	`dŒ“_lss_š
(¡©e, 
hİ
->
hİ_addr
) == 0)

1671 
	`dŒ“_lss_add
(
¡©e
, 
hİ
->
hİ_addr
);

1672 
	`¡©e_lss_add
(
¡©e
, 
hİ
->
hİ_addr
);

1673 
¡©e
->
‰l
--;

1674 
Œaû
->
fœ¡hİ
--;

1675 
	`Œaû_queue
(
sk
);

1683 if(
	`¡©e_lss_š
(
¡©e
, 
hİ
->
hİ_addr
) != 0)

1685 
¡©e
->
‰l
--;

1686 
Œaû
->
fœ¡hİ
--;

1687 
	`Œaû_queue
(
sk
);

1691 
Œaû
->
dŒ“
->
lss_¡İ
 = 
	`sÿm³r_addr_u£
(
hİ
->
hİ_addr
);

1692 
	`Œaû_Ãxt_mode
(
sk
);

1696 
Œaû
->
hİ_couÁ
++;

1697 
¡©e
->
‰l
++;

1704 if(
Œaû
->
cÚfid’û
 =ğ0 && 
	`SCAMPER_TRACE_IS_ALLATTEMPTS
(trace) == 0)

1707 
	`Œaû_¡İ_»asÚ
(
Œaû
, 
hİ
, 
¡©e
, &
¡İ_»asÚ
, &
¡İ_d©a
);

1708 if(
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
)

1711 
	`Œaû_¡İ
(
Œaû
, 
¡İ_»asÚ
, 
¡İ_d©a
);

1712 
	`Œaû_Ãxt_mode
(
sk
);

1719 
hİ
 = 
Œaû
->
hİs
[Œaû->
hİ_couÁ
-1]; 
	`as£¹
(hİ !ğ
NULL
);

1720 
hİ
 !ğ
NULL
)

1722 
	`Œaû_¡İ_»asÚ
(
Œaû
, 
hİ
, 
¡©e
, &
¡İ_»asÚ
, &
¡İ_d©a
);

1723 if(
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
)

1726 
	`Œaû_¡İ
(
Œaû
, 
¡İ_»asÚ
, 
¡İ_d©a
);

1727 
	`Œaû_Ãxt_mode
(
sk
);

1730 
hİ
 = hİ->
hİ_Ãxt
;

1735 if(
Œaû
->
hİ_couÁ
 =ğ255 ||¿û->hİ_couÁ =ğŒaû->
hİlim™
)

1738 
	`Œaû_¡İ_hİlim™
(
Œaû
);

1739 
	`Œaû_Ãxt_mode
(
sk
);

1744 
	`Œaû_queue
(
sk
);

1746 
	}
}

1754 
	$hªdËicmp_dŒ“_fœ¡
(
sÿm³r_sk_t
 *
sk
,
sÿm³r_icmp_»¥_t
 *
œ
,

1755 
Œaû_´obe_t
 *
´obe
)

1757 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1758 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

1759 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1760 
sÿm³r_addr_t
 
¤c
;

1761 
ušt8_t
 
¡İ_»asÚ
, 
¡İ_d©a
;

1762 
dÚe
 = 0;

1765 if(
´obe
->
mode
 !ğ
MODE_DTREE_FIRST
)

1769 if(
´obe
->
‰l
 > 
Œaû
->
fœ¡hİ
)

1771 
	`as£¹
(
´obe
->
‰l
 =ğ
Œaû
->
fœ¡hİ
);

1774 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
¤c
) != 0)

1778 
¡©e
->
©‹m±
 = 0;

1781 if(
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ||

1782 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
) ||

1783 
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
) ||

1784 
	`sÿm³r_addr_cmp
(
Œaû
->
d¡
, &
¤c
) == 0)

1787 if(
´obe
->
‰l
 > 1)

1789 
Œaû
->
fœ¡hİ
 /= 2;

1790 
¡©e
->
‰l
 = 
Œaû
->
fœ¡hİ
;

1791 
	`Œaû_queue
(
sk
);

1794 
	`as£¹
(
´obe
->
‰l
 == 1);

1797 
dÚe
 = 1;

1801 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1805 
	`Œaû_hİšs
(&
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1], hop);

1808 
Œaû
->
hİ_couÁ
 = 
hİ
->
hİ_´obe_‰l
;

1811 if(
dÚe
 != 0)

1813 
Œaû
->
fœ¡hİ
 = 1;

1814 
	`Œaû_¡İ_»asÚ
(
Œaû
, 
hİ
, 
¡©e
, &
¡İ_»asÚ
, &
¡İ_d©a
);

1815 
	`as£¹
(
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
);

1816 
	`Œaû_¡İ
(
Œaû
, 
¡İ_»asÚ
, 
¡İ_d©a
);

1817 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1825 if(
	`sÿm³r_Œaû_dŒ“_gss_fšd
(
Œaû
, 
hİ
->
hİ_addr
è=ğ
NULL
)

1827 
¡©e
->
‰l
 = 
hİ
->
hİ_´obe_‰l
 + 1;

1828 
¡©e
->
mode
 = 
MODE_DTREE_FWD
;

1829 
	`Œaû_queue
(
sk
);

1834 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_GSS
;

1835 
Œaû
->
¡İ_d©a
 = 0;

1836 
Œaû
->
dŒ“
->
gss_¡İ
 = 
	`sÿm³r_addr_u£
(
hİ
->
hİ_addr
);

1839 if(
Œaû
->
fœ¡hİ
 == 1)

1841 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1846 
¡©e
->
‰l
 = 
Œaû
->
fœ¡hİ
 - 1;

1847 
¡©e
->
mode
 = 
MODE_DTREE_BACK
;

1848 
	`Œaû_queue
(
sk
);

1851 
	}
}

1859 
	$hªdËicmp_Ï¡d™ch
(
sÿm³r_sk_t
 *
sk
,

1860 
sÿm³r_icmp_»¥_t
 *
œ
,

1861 
Œaû_´obe_t
 *
´obe
)

1863 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1864 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1866 if(
´obe
->
mode
 =ğ
MODE_TRACE
)

1869 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1873 
	`Œaû_hİšs
(&
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1], hop);

1875 if(
´obe
->
mode
 =ğ
MODE_LASTDITCH
)

1877 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1881 
	`Œaû_hİšs
(&
Œaû
->
Ï¡d™ch
, 
hİ
);

1882 
	`Œaû_¡İ_g­lim™
(
Œaû
);

1883 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1887 
	}
}

1889 
	$hªdËicmp_pmtud_deçuÉ
(
sÿm³r_sk_t
 *
sk
,

1890 
sÿm³r_icmp_»¥_t
 *
œ
,

1891 
Œaû_´obe_t
 *
´obe
)

1893 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1894 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

1895 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1896 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
;

1902 if(
´obe
->
mode
 !ğ
MODE_PMTUD_DEFAULT
)

1904 if(
´obe
->
size
 !ğ
¡©e
->
h—d”_size
 + s‹->
·ylßd_size
)

1907 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1909 
	`pmtud_hİšs
(
sk
, 
hİ
);

1910 
¡©e
->
pmtud
->
Ï¡_äagmsg
 = 
hİ
;

1912 if(
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
))

1914 if((
nÙe
 = 
	`sÿm³r_Œaû_pmtud_n_®loc
()è=ğ
NULL
)

1916 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ote");

1919 
nÙe
->
hİ
 = hop;

1922 if(
œ
->
œ_icmp_nhmtu
 =ğ0 || ir->œ_icmp_nhmtu >ğ
´obe
->
size
)

1924 
nÙe
->
ty³
 = 
SCAMPER_TRACE_PMTUD_N_TYPE_PTB_BAD
;

1925 
¡©e
->
pmtud
->
nÙe
 =‚ote;

1927 
¡©e
->
mode
 = 
MODE_PMTUD_BADSUGG
;

1928 
	`pmtud_L2_š™
(
¡©e
);

1929 
	`Œaû_queue
(
sk
);

1933 
	`sÿm³r_Œaû_pmtud_n_add
(
Œaû
->
pmtud
, 
nÙe
);

1935 if(
œ
->
œ_icmp_nhmtu
 < 
¡©e
->
h—d”_size
)

1938 
nÙe
->
ty³
 = 
SCAMPER_TRACE_PMTUD_N_TYPE_PTB_BAD
;

1939 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1943 
nÙe
->
ty³
 = 
SCAMPER_TRACE_PMTUD_N_TYPE_PTB
;

1944 
nÙe
->
nhmtu
 = 
œ
->
œ_icmp_nhmtu
;

1945 
¡©e
->
©‹m±
 = 0;

1946 
¡©e
->
·ylßd_size
 = 
œ
->
œ_icmp_nhmtu
 - s‹->
h—d”_size
;

1947 
	`Œaû_queue
(
sk
);

1950 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) ||

1951 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ||

1952 
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
))

1954 
Œaû
->
pmtud
->
pmtu
 = 
´obe
->
size
;

1955 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1959 
	}
}

1961 
	$hªdËicmp_pmtud_s’t_L2
(
sÿm³r_sk_t
 *
sk
,

1962 
sÿm³r_icmp_»¥_t
 *
œ
,

1963 
Œaû_´obe_t
 *
´obe
)

1965 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

1966 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

1967 
pmtud_L2_¡©e_t
 *
l2
;

1968 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1970 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

1972 
l2
 = 
¡©e
->
pmtud
->
L2
;

1978 if(
´obe
->
size
 < 
l2
->
low”
 ||†2->
uµ”
 <=…robe->size)

1980 
	`sÿm³r_debug
(
__func__
, "L2 search %d < %d || %d <= %d",

1981 
´obe
->
size
, 
l2
->
low”
,†2->
uµ”
,…robe->size);

1986 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

1988 
	`pmtud_hİšs
(
sk
, 
hİ
);

1990 
l2
->
hİ
 = hop;

1996 if(
´obe
->
size
 + 1 !ğ
l2
->
uµ”
)

2002 
	`pmtud_L2_£t_´obesize
(
¡©e
, 
´obe
->
size
, 
l2
->
uµ”
);

2006 
l2
->
low”
 =†2->
out
 = 
´obe
->
size
;

2007 if(
	`pmtud_TTL_š™
(
sk
) == 1)

2009 
¡©e
->
mode
 = 
MODE_PMTUD_SILENT_TTL
;

2013 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2018 
	`Œaû_queue
(
sk
);

2020 
	}
}

2022 
	$hªdËicmp_pmtud_s’t_TTL
(
sÿm³r_sk_t
 *
sk
,

2023 
sÿm³r_icmp_»¥_t
 *
œ
,

2024 
Œaû_´obe_t
 *
´obe
)

2026 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2027 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2028 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2031 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
))

2034 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

2036 
	`pmtud_hİšs
(
sk
, 
hİ
);

2038 
	`as£¹
(
¡©e
->
pmtud
->
TTL
 !ğ
NULL
);

2039 
¡©e
->
pmtud
->
TTL
->
hİ
 = hop;

2042 if(
	`pmtud_TTL_£t_´ob‘
(
sk
,
´obe
->
‰l
,
¡©e
->
pmtud
->
TTL
->
uµ”
) == 0)

2048 if(
	`pmtud_L2_£¬ch_’d
(
sk
) == 1)

2053 
	`Œaû_queue
(
sk
);

2060 if(
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
) &&

2061 
œ
->
œ_icmp_nhmtu
 =ğ
¡©e
->
pmtud
->
L2
->
out
)

2064 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

2066 
	`pmtud_hİšs
(
sk
, 
hİ
);

2068 
¡©e
->
©‹m±
 = 0;

2069 
¡©e
->
·ylßd_size
 = 
œ
->
œ_icmp_nhmtu
 - s‹->
h—d”_size
;

2070 
¡©e
->
‰l
 = 255;

2071 
¡©e
->
mode
 = 
MODE_PMTUD_DEFAULT
;

2073 
	`ä“
(
¡©e
->
pmtud
->
L2
); s‹->pmtud->L2 = 
NULL
;

2074 
	`ä“
(
¡©e
->
pmtud
->
TTL
); s‹->pmtud->TTL = 
NULL
;

2077 
	`Œaû_queue
(
sk
);

2081 
	}
}

2089 
	$hªdËicmp_pmtud_badsugg
(
sÿm³r_sk_t
 *
sk
,

2090 
sÿm³r_icmp_»¥_t
 *
œ
,

2091 
Œaû_´obe_t
 *
´obe
)

2093 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2094 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2095 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2096 
sÿm³r_addr_t
 
addr
;

2097 
uµ”
, 
low”
;

2099 if(
	`sÿm³r_icmp_»¥_¤c
(
œ
, &
addr
) != 0)

2102 if((
hİ
 = 
	`Œaû_icmp_hİ
(
Œaû
, 
´obe
, 
œ
)è=ğ
NULL
)

2104 
	`pmtud_hİšs
(
sk
, 
hİ
);

2110 if(
	`sÿm³r_addr_cmp
(
¡©e
->
pmtud
->
Ï¡_äagmsg
->
hİ_addr
, &
addr
) == 0)

2112 
low”
 = 
¡©e
->
pmtud
->
L2
->lower;

2113 
uµ”
 = 
´obe
->
size
;

2117 
low”
 = 
´obe
->
size
;

2118 
uµ”
 = 
¡©e
->
pmtud
->
L2
->upper;

2121 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

2122 
¡©e
->
pmtud
->
L2
->
hİ
 = hop;

2125 if(
low”
 + 1 !ğ
uµ”
)

2127 
	`pmtud_L2_£t_´obesize
(
¡©e
, 
low”
, 
uµ”
);

2132 
¡©e
->
pmtud
->
L2
->
low”
 = s‹->pmtud->L2->
out
 =†ower;

2133 
¡©e
->
pmtud
->
L2
->
uµ”
 = upper;

2136 if(
	`pmtud_L2_£¬ch_’d
(
sk
) == 1)

2141 
	`Œaû_queue
(
sk
);

2144 
	}
}

2146 
	$do_Œaû_hªdË_icmp
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
)

2148 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_icmp_»¥_t
 *,

2149 
Œaû_´obe_t
 *) = {

2150 
NULL
,

2151 
NULL
,

2152 
hªdËicmp_Œaû
,

2153 
hªdËicmp_Ï¡d™ch
,

2154 
hªdËicmp_pmtud_deçuÉ
,

2155 
hªdËicmp_pmtud_s’t_L2
,

2156 
hªdËicmp_pmtud_s’t_TTL
,

2157 
hªdËicmp_pmtud_badsugg
,

2158 
hªdËicmp_dŒ“_fœ¡
,

2159 
hªdËicmp_Œaû
,

2160 
hªdËicmp_Œaû
,

2163 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2164 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2165 
ušt16_t
 
id
;

2166 
ušt8_t
 
´Ùo
;

2168 
	`as£¹
(
¡©e
->
mode
 <ğ
MODE_MAX
);

2175 if(
œ
->
œ_fd
 !ğ
	`sÿm³r_fd_fd_g‘
(
¡©e
->
icmp
))

2180 
	`sÿm³r_icmp_»¥_´št
(
œ
);

2186 if(
func
[
¡©e
->
mode
] =ğ
NULL
)

2192 if(!((
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) ||

2193 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ||

2194 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
)) &&

2195 
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
) &&

2196 
Œaû
->
off£t
 =ğ
œ
->
œ_šÃr__off
) &&

2197 !(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
) &&

2198 
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
)))

2203 if(
Œaû
->
off£t
 != 0)

2205 if(
œ
->
œ_šÃr_d©a
 =ğ
NULL
)

2208 if((
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
) &&

2209 
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_UDP
) ||

2210 (
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
) &&

2211 
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_TCP
))

2214 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

2216 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
) &&

2217 
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_ICMP
)

2220 if(
œ
->
œ_šÃr_d©®’
 < 8)

2223 if(
	`by‹s_Áohs
(
œ
->
œ_šÃr_d©a
+0è!ğ
Œaû
->
¥Üt
 ||

2224 
	`by‹s_Áohs
(
œ
->
œ_šÃr_d©a
+2è!ğ
Œaû
->
dpÜt
)

2227 
id
 = 
	`by‹s_Áohl
(
œ
->
œ_šÃr_d©a
+4);

2231 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
) &&

2232 
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_ICMPV6
)

2235 if((
œ
->
œ_šÃr__id
 >> 16è!ğ
Œaû
->
¥Üt
)

2238 if(
œ
->
œ_šÃr_d©®’
 < 4)

2241 
id
 = 
	`by‹s_Áohl
(
œ
->
œ_šÃr_d©a
);

2244 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
))

2251 if(
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_UDP
 ||

2252 
œ
->
œ_šÃr_udp_¥Üt
 !ğ
Œaû
->
¥Üt
)

2257 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
)

2259 if(
œ
->
œ_šÃr_udp_dpÜt
 < 
Œaû
->
dpÜt
 ||

2260 
œ
->
œ_šÃr_udp_dpÜt
 >ğ
Œaû
->
dpÜt
+
¡©e
->
id_Ãxt
)

2266 
id
 = 
œ
->
œ_šÃr_udp_dpÜt
 - 
Œaû
->
dpÜt
;

2268 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP_PARIS
)

2270 if(
œ
->
œ_šÃr_udp_dpÜt
 !ğ
Œaû
->
dpÜt
)

2273 if(
œ
->
œ_af
 =ğ
AF_INET
)

2275 if(
	`Áohs
(
œ
->
œ_šÃr_udp_sum
è=ğœ->
œ_šÃr__id
 &&

2276 
œ
->
œ_šÃr_udp_sum
 != 0)

2278 
id
 = 
	`Áohs
(
œ
->
œ_šÃr_udp_sum
) - 1;

2280 if(
	`Œaû_id_fudge
(
¡©e
, 
œ
->
œ_šÃr__id
, &
id
) != 0)

2287 if(
œ
->
œ_šÃr_udp_sum
 == 0)

2289 
id
 = 
	`Áohs
(
œ
->
œ_šÃr_udp_sum
) - 1;

2294 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
))

2296 if(
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
) == 0)

2298 if(
œ
->
œ_af
 =ğ
AF_INET
è
´Ùo
 = 
IPPROTO_ICMP
;

2299 if(
œ
->
œ_af
 =ğ
AF_INET6
è
´Ùo
 = 
IPPROTO_ICMPV6
;

2302 if(
œ
->
œ_šÃr__´Ùo
 !ğ
´Ùo
 ||

2303 
œ
->
œ_šÃr_icmp_id
 !ğ
Œaû
->
¥Üt
 ||

2304 
œ
->
œ_šÃr_icmp_£q
 >ğ
¡©e
->
id_Ãxt
)

2309 
id
 = 
œ
->
œ_šÃr_icmp_£q
;

2313 if(
œ
->
œ_icmp_id
 !ğ
Œaû
->
¥Üt
 ||

2314 
œ
->
œ_icmp_£q
 >ğ
¡©e
->
id_Ãxt
)

2319 
id
 = 
œ
->
œ_icmp_£q
;

2322 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

2329 if(
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
) == 0 ||

2330 
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_TCP
 ||

2331 
œ
->
œ_šÃr_tı_¥Üt
 !ğ
Œaû
->
¥Üt
 ||

2332 
œ
->
œ_šÃr_tı_dpÜt
 !ğ
Œaû
->
dpÜt
)

2337 if(
œ
->
œ_af
 =ğ
AF_INET
)

2340 if(
	`Œaû_id_fudge
(
¡©e
, 
œ
->
œ_šÃr__id
, &
id
) != 0)

2345 if(
œ
->
œ_šÃr__æow
 == 0)

2347 
id
 = 
œ
->
œ_šÃr__æow
 - 1;

2355 if(
id
 < 
¡©e
->
id_Ãxt
)

2357 
func
[
¡©e
->
mode
](
sk
, 
œ
, s‹->
´obes
[
id
]);

2361 
	}
}

2369 
	$timeout_Œaû
(
sÿm³r_sk_t
 *
sk
)

2371 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2372 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2373 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2374 
i
, 
d—d·th
;

2375 
ušt8_t
 
¡İ_»asÚ
, 
¡İ_d©a
;

2378 
Œaû
->
hİ_couÁ
++;

2379 
¡©e
->
‰l
++;

2382 if(
¡©e
->
š‹rçûs
 !ğ
NULL
)

2384 
	`ä“
(
¡©e
->
š‹rçûs
);

2385 
¡©e
->
š‹rçûs
 = 
NULL
;

2386 
¡©e
->
š‹rçûc
 = 0;

2388 
	`as£¹
(
¡©e
->
š‹rçûs
 =ğ
NULL
);

2389 
	`as£¹
(
¡©e
->
š‹rçûc
 == 0);

2390 
¡©e
->
n
 = 2;

2397 if(
	`SCAMPER_TRACE_IS_ALLATTEMPTS
(
Œaû
è||¿û->
cÚfid’û
 != 0)

2399 
hİ
 = 
Œaû
->
hİs
[Œaû->
hİ_couÁ
-1];hİ !ğ
NULL
; hİ=hİ->
hİ_Ãxt
)

2405 
	`Œaû_¡İ_»asÚ
(
Œaû
, 
hİ
, 
¡©e
, &
¡İ_»asÚ
, &
¡İ_d©a
);

2406 if(
¡İ_»asÚ
 !ğ
SCAMPER_TRACE_STOP_NONE
)

2408 
	`Œaû_¡İ
(
Œaû
, 
¡İ_»asÚ
, 
¡İ_d©a
);

2409 
	`Œaû_Ãxt_mode
(
sk
);

2415 if(
Œaû
->
hİ_couÁ
 =ğ255 ||¿û->hİ_couÁ =ğŒaû->
hİlim™
)

2417 
	`Œaû_¡İ_hİlim™
(
Œaû
);

2418 
	`Œaû_Ãxt_mode
(
sk
);

2428 if(
Œaû
->
hİ_couÁ
 - (Œaû->
fœ¡hİ
 - 1è>ğŒaû->
g­lim™
)

2430 
d—d·th
 = 1;

2431 
i
=0; i<
Œaû
->
g­lim™
; i++)

2433 if(
Œaû
->
hİs
[Œaû->
hİ_couÁ
-1-
i
] !ğ
NULL
)

2435 
d—d·th
 = 0;

2440 if(
d—d·th
 != 0)

2442 if(
Œaû
->
g­aùiÚ
 =ğ
SCAMPER_TRACE_GAPACTION_LASTDITCH
)

2444 
¡©e
->
mode
 = 
MODE_LASTDITCH
;

2445 
¡©e
->
‰l
 = 255;

2449 
	`Œaû_¡İ_g­lim™
(
Œaû
);

2450 
	`Œaû_Ãxt_mode
(
sk
);

2456 
	}
}

2458 
	$timeout_dŒ“_back
(
sÿm³r_sk_t
 *
sk
)

2460 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2461 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2462 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2465 if(
¡©e
->
š‹rçûs
 !ğ
NULL
)

2467 
	`ä“
(
¡©e
->
š‹rçûs
);

2468 
¡©e
->
š‹rçûs
 = 
NULL
;

2469 
¡©e
->
š‹rçûc
 = 0;

2472 if(
¡©e
->
‰l
 == 1)

2474 
	`Œaû_Ãxt_mode
(
sk
);

2478 if(
¡©e
->
ls¡
 !ğ
NULL
 &&

2479 (
	`SCAMPER_TRACE_IS_ALLATTEMPTS
(
Œaû
è||¿û->
cÚfid’û
 != 0))

2481 
hİ
 = 
Œaû
->
hİs
[
¡©e
->
‰l
-1]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

2483 if(
	`dŒ“_lss_š
(
¡©e
, 
hİ
->
hİ_addr
) != 0)

2485 
	`Œaû_Ãxt_mode
(
sk
);

2491 
¡©e
->
©‹m±
 = 0;

2492 
¡©e
->
‰l
--;

2493 
Œaû
->
fœ¡hİ
--;

2494 
	`Œaû_queue
(
sk
);

2497 
	}
}

2499 
	$timeout_dŒ“_fœ¡
(
sÿm³r_sk_t
 *
sk
)

2501 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2502 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2508 if(
¡©e
->
‰l
 == 1)

2510 
¡©e
->
mode
 = 
MODE_DTREE_FWD
;

2511 
¡©e
->
‰l
++;

2512 
Œaû
->
hİ_couÁ
++;

2517 
¡©e
->
‰l
 /= 2;

2518 
Œaû
->
fœ¡hİ
 /= 2;

2520 
	}
}

2522 
	$timeout_Ï¡d™ch
(
sÿm³r_sk_t
 *
sk
)

2525 
	`Œaû_¡İ_g­lim™
(
	`Œaû_g‘d©a
(
sk
));

2526 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2528 
	}
}

2530 
	$timeout_pmtud_deçuÉ
(
sÿm³r_sk_t
 *
sk
)

2532 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2533 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
;

2535 if((
nÙe
 = 
	`sÿm³r_Œaû_pmtud_n_®loc
()è=ğ
NULL
)

2537 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ote");

2538 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

2541 
nÙe
->
ty³
 = 
SCAMPER_TRACE_PMTUD_N_TYPE_SILENCE
;

2542 
¡©e
->
pmtud
->
nÙe
 =‚ote;

2544 
	`pmtud_L2_š™
(
¡©e
);

2545 
¡©e
->
mode
 = 
MODE_PMTUD_SILENT_L2
;

2547 
	}
}

2549 
	$timeout_pmtud_s’t_L2
(
sÿm³r_sk_t
 *
sk
)

2551 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2552 
size
 = 
¡©e
->
h—d”_size
 + s‹->
·ylßd_size
;

2554 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

2560 if(
¡©e
->
pmtud
->
L2
->
idx
 == 0)

2562 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2570 if(
¡©e
->
pmtud
->
L2
->
low”
 + 1 !ğ
size
)

2572 
	`pmtud_L2_£t_´obesize
(
¡©e
, s‹->
pmtud
->
L2
->
low”
, 
size
);

2576 
¡©e
->
pmtud
->
L2
->
out
 = s‹->pmtud->L2->
low”
;

2579 if(
	`pmtud_TTL_š™
(
sk
) == 1)

2580 
¡©e
->
mode
 = 
MODE_PMTUD_SILENT_TTL
;

2582 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2586 
	}
}

2588 
	$timeout_pmtud_s’t_TTL
(
sÿm³r_sk_t
 *
sk
)

2590 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2592 
	`as£¹
(
¡©e
->
pmtud
->
TTL
 !ğ
NULL
);

2598 if(
	`pmtud_TTL_£t_´ob‘
(
sk
, 
¡©e
->
pmtud
->
TTL
->
low”
, s‹->
‰l
) == 0)

2600 
	`pmtud_L2_£¬ch_’d
(
sk
);

2604 
	}
}

2613 
	$timeout_pmtud_badsugg
(
sÿm³r_sk_t
 *
sk
)

2615 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2616 
low”
, 
uµ”
;

2618 
	`as£¹
(
¡©e
->
pmtud
->
L2
 !ğ
NULL
);

2620 
low”
 = 
¡©e
->
h—d”_size
 + s‹->
·ylßd_size
;

2621 
uµ”
 = 
¡©e
->
pmtud
->
L2
->upper;

2622 
¡©e
->
pmtud
->
L2
->
hİ
 = 
NULL
;

2624 if(
low”
 + 1 !ğ
uµ”
)

2626 
	`pmtud_L2_£t_´obesize
(
¡©e
, 
low”
, 
uµ”
);

2631 
¡©e
->
pmtud
->
L2
->
low”
 = s‹->pmtud->L2->
out
 =†ower;

2632 
	`pmtud_L2_£¬ch_’d
(
sk
);

2636 
	}
}

2644 
	$do_Œaû_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

2646 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) = {

2647 
NULL
,

2648 
NULL
,

2649 
timeout_Œaû
,

2650 
timeout_Ï¡d™ch
,

2651 
timeout_pmtud_deçuÉ
,

2652 
timeout_pmtud_s’t_L2
,

2653 
timeout_pmtud_s’t_TTL
,

2654 
timeout_pmtud_badsugg
,

2655 
timeout_dŒ“_fœ¡
,

2656 
timeout_Œaû
,

2657 
timeout_dŒ“_back
,

2660 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2661 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2662 
Œaû_´obe_t
 *
´obe
;

2664 
	`as£¹
(
¡©e
->
mode
 <ğ
MODE_MAX
);

2667 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
 || s‹->mod=ğ
MODE_DLHDR
)

2669 
	`Œaû_hªdË”rÜ
(
sk
, 0);

2673 
´obe
 = 
¡©e
->
´obes
[¡©e->
id_Ãxt
-1];

2674 if(
´obe
->
rx
 == 0)

2676 
´obe
->
æags
 |ğ
TRACE_PROBE_FLAG_TIMEOUT
;

2680 
	`as£¹
(
Œaû
->
wa™_´obe
 != 0);

2688 if((
Œaû
->
cÚfid’û
 =ğ0 && 
¡©e
->
©‹m±
 =ğŒaû->
©‹m±s
) ||

2689 (
Œaû
->
cÚfid’û
 !ğ0 && 
¡©e
->
©‹m±
 =ğ
	`k
(state)))

2692 
¡©e
->
©‹m±
 = 0;

2695 
func
[
¡©e
->
mode
](
sk
);

2699 
	}
}

2701 
	$hªdËtı_Œaû
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
,

2702 
Œaû_´obe_t
 *
´obe
)

2704 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2705 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2706 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2707 
size_t
 
Ën
;

2710 if(
´obe
->
mode
 !ğ
MODE_TRACE
)

2716 if((
hİ
 = 
	`Œaû_tı_hİ
(
´obe
, 
dl
)è=ğ
NULL
)

2720 
	`Œaû_hİšs
(&
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1], hop);

2723 if(
´obe
->
rx
 != 65535)

2725 
´obe
->
rx
++;

2729 if(
	`SCAMPER_TRACE_IS_ALLATTEMPTS
(
Œaû
))

2731 if(
´obe
->
id
 + 1 !ğ
Œaû
->
©‹m±s
)

2733 
	`Œaû_queue
(
sk
);

2736 
Œaû
->
hİ_couÁ
++;

2738 if(
Œaû
->
cÚfid’û
 != 0)

2741 if(
	`¬¿y_fšd
((**)
¡©e
->
š‹rçûs
, s‹->
š‹rçûc
,

2742 
hİ
->
hİ_addr
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è=ğ
NULL
)

2744 
Ën
 = (
¡©e
->
š‹rçûc
 + 1è* (
sÿm³r_addr_t
 *);

2745 if(
	`»®loc_w¿p
((**)&
¡©e
->
š‹rçûs
, 
Ën
) != 0)

2747 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
,

2749 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

2753 
¡©e
->
š‹rçûs
[¡©e->
š‹rçûc
++] = 
hİ
->
hİ_addr
;

2755 if(
¡©e
->
š‹rçûc
 > 1)

2757 
	`¬¿y_qsÜt
((**)
¡©e
->
š‹rçûs
, s‹->
š‹rçûc
,

2758 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
);

2759 
¡©e
->
n
++;

2764 if(
¡©e
->
n
 <ğ
TRACE_CONFIDENCE_MAX_N
 && s‹->
©‹m±
 < 
	`k
(state))

2766 
	`Œaû_queue
(
sk
);

2769 
Œaû
->
hİ_couÁ
++;

2773 if(
´obe
->
rx
 =ğ1 && (´obe->
æags
 & 
TRACE_PROBE_FLAG_TIMEOUT
) == 0)

2775 
Œaû
->
hİ_couÁ
++;

2779 
	`Œaû_¡İ_com¶‘ed
(
Œaû
);

2780 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2783 
	}
}

2785 
	$hªdËtı_Ï¡d™ch
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
,

2786 
Œaû_´obe_t
 *
´obe
)

2788 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2789 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2792 if(
´obe
->
mode
 !ğ
MODE_TRACE
 &&…robe->mod!ğ
MODE_LASTDITCH
)

2797 if(
´obe
->
rx
 != 65535)…robe->rx++;

2800 if((
hİ
 = 
	`Œaû_tı_hİ
(
´obe
, 
dl
)è=ğ
NULL
)

2805 if(
´obe
->
mode
 =ğ
MODE_LASTDITCH
)

2807 
	`Œaû_hİšs
(&
Œaû
->
Ï¡d™ch
, 
hİ
);

2808 
	`Œaû_¡İ_g­lim™
(
Œaû
);

2812 
	`Œaû_hİšs
(&
Œaû
->
hİs
[
hİ
->
hİ_´obe_‰l
-1], hop);

2813 
	`Œaû_¡İ_com¶‘ed
(
Œaû
);

2816 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

2818 
	}
}

2829 
	$dlš_Œaû
(
sÿm³r_Œaû_t
 *
Œaû
,

2830 
sÿm³r_dl_»c_t
 *
dl
, 
Œaû_´obe_t
 *
´obe
)

2832 
sÿm³r_Œaû_hİ_t
 *
hİ
;

2833 
timev®
 
tv
;

2836 
	`timev®_diff_tv
(&
tv
, &
´obe
->
tx_tv
, &´obe->
rx_tv
);

2838 
hİ
=
Œaû
->
hİs
[
´obe
->
‰l
-1]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

2840 if(
´obe
->
id
 + 1 < 
hİ
->
hİ_´obe_id
) ;

2841 if(
´obe
->
id
 + 1 > 
hİ
->
hİ_´obe_id
) ;

2843 
	`sÿm³r_debug
(
__func__
,

2845 
hİ
->
hİ_¹t
.
tv_£c
, hİ->hİ_¹t.
tv_u£c
,

2846 
tv
.
tv_£c
,v.
tv_u£c
,

2847 
	`timev®_diff_us
(&
hİ
->
hİ_¹t
, &
tv
));

2849 
hİ
->
hİ_æags
 &ğ~(
SCAMPER_TRACE_HOP_FLAG_TS_SOCK_RX
);

2850 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_TS_DL_RX
;

2851 
	`timev®_ıy
(&
hİ
->
hİ_¹t
, &
tv
);

2855 
	}
}

2857 
	$dlout_­¶y
(
sÿm³r_Œaû_hİ_t
 *
hİ
,

2858 
Œaû_´obe_t
 *
´obe
, 
timev®
 *
diff
)

2860 
hİ
 !ğ
NULL
)

2862 if(
´obe
->
id
 + 1 > 
hİ
->
hİ_´obe_id
)

2867 if(
´obe
->
id
 + 1 =ğ
hİ
->
hİ_´obe_id
)

2869 
hİ
->
hİ_æags
 |ğ
SCAMPER_TRACE_HOP_FLAG_TS_DL_TX
;

2870 
	`timev®_add_tv
(&
hİ
->
hİ_¹t
, 
diff
);

2873 
hİ
 = hİ->
hİ_Ãxt
;

2877 
	}
}

2886 
	$dlout_Œaû
(
sÿm³r_Œaû_t
 *
Œaû
,

2887 
Œaû_´obe_t
 *
´obe
, 
timev®
 *
diff
)

2889 
	`dlout_­¶y
(
Œaû
->
hİs
[
´obe
->
‰l
-1],…robe, 
diff
);

2891 
	}
}

2897 
	$dlout_Ï¡d™ch
(
sÿm³r_Œaû_t
 *
Œaû
,

2898 
Œaû_´obe_t
 *
´obe
, 
timev®
 *
diff
)

2900 
	`dlout_­¶y
(
Œaû
->
Ï¡d™ch
, 
´obe
, 
diff
);

2902 
	}
}

2911 
	$do_Œaû_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

2913 (* cÚ¡ 
dlout_func
[])(
sÿm³r_Œaû_t
 *, 
Œaû_´obe_t
 *,

2914 
timev®
 *) =

2916 
NULL
,

2917 
NULL
,

2918 
dlout_Œaû
,

2919 
dlout_Ï¡d™ch
,

2920 
NULL
,

2921 
NULL
,

2922 
NULL
,

2923 
NULL
,

2924 
NULL
,

2925 
NULL
,

2926 
NULL
,

2929 (* cÚ¡ 
dlš_func
[])(
sÿm³r_Œaû_t
 *, 
sÿm³r_dl_»c_t
 *,

2930 
Œaû_´obe_t
 *) =

2932 
NULL
,

2933 
NULL
,

2934 
dlš_Œaû
,

2935 
NULL
,

2936 
NULL
,

2937 
NULL
,

2938 
NULL
,

2939 
NULL
,

2940 
NULL
,

2941 
NULL
,

2942 
NULL
,

2945 (* cÚ¡ 
hªdËtı_func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *,

2946 
Œaû_´obe_t
 *) =

2948 
NULL
,

2949 
NULL
,

2950 
hªdËtı_Œaû
,

2951 
hªdËtı_Ï¡d™ch
,

2952 
NULL
,

2953 
NULL
,

2954 
NULL
,

2955 
NULL
,

2956 
NULL
,

2957 
NULL
,

2958 
NULL
,

2961 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

2962 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

2963 
Œaû_´obe_t
 *
´obe
;

2964 
ušt16_t
 
´obe_id
;

2965 
dœeùiÚ
;

2966 
timev®
 
diff
;

2969 if((
dl
->
dl_æags
 & 
SCAMPER_DL_REC_FLAG_TIMESTAMP
) == 0)

2972 if(
	`SCAMPER_DL_IS_IP
(
dl
) == 0)

2979 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
 ||

2980 
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP_PARIS
)

2982 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_UDP
)

2984 if(
dl
->
dl_udp_¥Üt
 !ğ
Œaû
->
¥Üt
)

2987 
dœeùiÚ
 = 1;

2989 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
)

2991 
´obe_id
 = 
dl
->
dl_udp_dpÜt
 - 
Œaû
->
dpÜt
;

2995 
´obe_id
 = 
	`Áohs
(
dl
->
dl_udp_sum
) - 1;

2998 if(
	`SCAMPER_DL_IS_ICMP
(
dl
))

3000 if(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
) == 0 &&

3001 
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
) == 0 &&

3002 
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
) == 0)

3006 if(
dl
->
dl_icmp__´Ùo
 !ğ
IPPROTO_UDP
)

3008 if(
dl
->
dl_icmp_udp_¥Üt
 !ğ
Œaû
->
¥Üt
)

3011 
dœeùiÚ
 = 0;

3013 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
)

3015 
´obe_id
 = 
dl
->
dl_icmp_udp_dpÜt
 - 
Œaû
->
dpÜt
;

3019 if(
dl
->
dl_icmp_udp_dpÜt
 !ğ
Œaû
->
dpÜt
)

3022 if(
dl
->
dl_af
 =ğ
AF_INET
)

3024 if(
	`Áohs
(
dl
->
dl_icmp_udp_sum
è=ğdl->
dl_icmp__id
 &&

3025 
dl
->
dl_icmp_udp_sum
 != 0)

3027 
´obe_id
 = 
	`Áohs
(
dl
->
dl_icmp_udp_sum
) - 1;

3029 if(
	`Œaû_id_fudge
(
¡©e
,
dl
->
dl_icmp__id
,

3030 &
´obe_id
) != 0)

3037 
	`as£¹
(
dl
->
dl_af
 =ğ
AF_INET6
);

3038 if(
dl
->
dl_icmp_udp_sum
 == 0)

3041 
´obe_id
 = 
	`Áohs
(
dl
->
dl_icmp_udp_sum
) - 1;

3047 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO
 ||

3048 
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
)

3050 if(
	`SCAMPER_DL_IS_ICMP
(
dl
) == 0)

3053 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REQUEST
(
dl
))

3055 if(
dl
->
dl_icmp_id
 !ğ
Œaû
->
¥Üt
)

3058 
´obe_id
 = 
dl
->
dl_icmp_£q
;

3059 
dœeùiÚ
 = 1;

3061 if(
	`SCAMPER_DL_IS_ICMP_ECHO_REPLY
(
dl
))

3063 if(
dl
->
dl_icmp_id
 !ğ
Œaû
->
¥Üt
)

3066 
´obe_id
 = 
dl
->
dl_icmp_£q
;

3067 
dœeùiÚ
 = 0;

3069 if((
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
) ||

3070 
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
) ||

3071 
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
)) &&

3072 
	`SCAMPER_DL_IS_ICMP_Q_ICMP_ECHO_REQ
(
dl
))

3074 if(
dl
->
dl_icmp_icmp_id
 !ğ
Œaû
->
¥Üt
)

3077 
´obe_id
 = 
dl
->
dl_icmp_icmp_£q
;

3078 
dœeùiÚ
 = 0;

3082 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

3084 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_TCP
)

3091 if((
dl
->
dl_tı_æags
 & 
TH_SYN
) == TH_SYN &&

3092 (
dl
->
dl_tı_æags
 & ~
TH_SYN
) == 0 &&

3093 
dl
->
dl_tı_¥Üt
 =ğ
Œaû
->
¥Üt
)

3095 if(
dl
->
dl_af
 =ğ
AF_INET
)

3096 
´obe_id
 = 
dl
->
dl__id
 - 1;

3098 
´obe_id
 = 
dl
->
dl__æow
 - 1;

3100 
dœeùiÚ
 = 1;

3102 if(
dl
->
dl_tı_¥Üt
 =ğ
Œaû
->
dpÜt
 &&

3103 
dl
->
dl_tı_dpÜt
 =ğ
Œaû
->
¥Üt
)

3109 
´obe_id
 = 
¡©e
->
id_Ãxt
 - 1;

3110 
dœeùiÚ
 = 0;

3114 if(
	`SCAMPER_DL_IS_ICMP
(
dl
))

3116 if(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
) == 0 &&

3117 
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
) == 0 &&

3118 
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
) == 0)

3122 if(
dl
->
dl_icmp__´Ùo
 !ğ
IPPROTO_TCP
 ||

3123 
dl
->
dl_icmp_tı_¥Üt
 !ğ
Œaû
->
¥Üt
 ||

3124 
dl
->
dl_icmp_tı_dpÜt
 !ğ
Œaû
->
dpÜt
)

3130 if(
dl
->
dl_af
 =ğ
AF_INET
)

3132 if(
	`Œaû_id_fudge
(
¡©e
, 
dl
->
dl_icmp__id
, &
´obe_id
) != 0)

3139 if(
dl
->
dl_icmp__æow
 == 0)

3142 
´obe_id
 = 
dl
->
dl_icmp__æow
 - 1;

3145 
dœeùiÚ
 = 0;

3152 if(
´obe_id
 >ğ
¡©e
->
id_Ãxt
)

3156 
´obe
 = 
¡©e
->
´obes
[
´obe_id
];

3159 
	`as£¹
(
´obe
->
mode
 <ğ
MODE_MAX
);

3162 if(
dœeùiÚ
 == 0)

3165 if(
dl
->
dl__´Ùo
 =ğ
IPPROTO_TCP
)

3171 if((
´obe
->
æags
 & 
TRACE_PROBE_FLAG_DL_RX
) != 0)

3173 
	`timev®_ıy
(&
´obe
->
rx_tv
, &
dl
->
dl_tv
);

3174 
´obe
->
æags
 |ğ
TRACE_PROBE_FLAG_DL_RX
;

3177 if(
hªdËtı_func
[
´obe
->
mode
] !ğ
NULL
)

3179 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

3180 
hªdËtı_func
[
´obe
->
mode
](
sk
, 
dl
,…robe);

3184 if((
´obe
->
æags
 & 
TRACE_PROBE_FLAG_DL_RX
) == 0)

3187 
´obe
->
æags
 |ğ
TRACE_PROBE_FLAG_DL_RX
;

3188 
	`timev®_ıy
(&
´obe
->
rx_tv
, &
dl
->
dl_tv
);

3191 if(
´obe
->
rx
 > 0 && 
dlš_func
[´obe->
mode
] !ğ
NULL
)

3193 
dlš_func
[
´obe
->
mode
](
Œaû
, 
dl
,…robe);

3199 
	`sÿm³r_debug
(
__func__
, "probe %d.%06d dl %d.%06d diff %d",

3200 
´obe
->
tx_tv
.
tv_£c
,…robe->tx_tv.
tv_u£c
,

3201 
dl
->
dl_tv
.
tv_£c
, dl->dl_tv.
tv_u£c
,

3202 
	`timev®_diff_us
(&
´obe
->
tx_tv
, &
dl
->
dl_tv
));

3205 if(
´obe
->
rx
 > 0 && 
dlout_func
[´obe->
mode
] !ğ
NULL
 &&

3206 
	`timev®_cmp
(&
´obe
->
tx_tv
, &
dl
->
dl_tv
) < 0)

3208 
	`timev®_diff_tv
(&
diff
, &
´obe
->
tx_tv
, &
dl
->
dl_tv
);

3209 
dlout_func
[
´obe
->
mode
](
Œaû
,…robe, &
diff
);

3213 
´obe
->
æags
 |ğ
TRACE_PROBE_FLAG_DL_TX
;

3214 
	`timev®_ıy
(&
´obe
->
tx_tv
, &
dl
->
dl_tv
);

3218 
	}
}

3226 
	$Œaû_hªdË_dlhdr
(
sÿm³r_dlhdr_t
 *
dlhdr
)

3228 
sÿm³r_sk_t
 *
sk
 = 
dlhdr
->
·¿m
;

3229 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

3230 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

3232 if(
dlhdr
->
”rÜ
 != 0)

3234 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

3238 
¡©e
->
©‹m±
 = 0;

3239 if(
	`SCAMPER_TRACE_IS_DOUBLETREE
(
Œaû
))

3240 
¡©e
->
mode
 = 
MODE_DTREE_FIRST
;

3242 
¡©e
->
mode
 = 
MODE_TRACE
;

3244 
	`sÿm³r_sk_queue_´obe
(
sk
);

3246 
	}
}

3248 
	$Œaû_hªdË_¹
(
sÿm³r_rou‹_t
 *
¹
)

3250 
sÿm³r_sk_t
 *
sk
 = 
¹
->
·¿m
;

3251 
sÿm³r_Œaû_t
 *
Œ
 = 
	`Œaû_g‘d©a
(
sk
);

3252 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

3253 
sÿm³r_dl_t
 *
dl
;

3255 if(
¡©e
->
mode
 !ğ
MODE_RTSOCK
 || s‹->
rou‹
 !ğ
¹
)

3256 
dÚe
;

3258 #iâdeà
_WIN32


3259 if(
¡©e
->
¹sock
 !ğ
NULL
)

3261 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

3262 
¡©e
->
¹sock
 = 
NULL
;

3266 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

3268 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifindex");

3269 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

3270 
dÚe
;

3278 if((
¡©e
->
dl
 = 
	`sÿm³r_fd_dl
(
¹
->
ifšdex
)è=ğ
NULL
)

3280 
	`sÿm³r_debug
(
__func__
, "could‚Ù g‘ dÈfÜ %d", 
¹
->
ifšdex
);

3281 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

3282 
dÚe
;

3284 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->dl);

3291 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œ
è&& 
¡©e
->
¿w
 =ğ
NULL
 &&

3292 
	`sÿm³r_dl_tx_ty³
(
dl
è=ğ
SCAMPER_DL_TX_UNSUPPORTED
 &&

3293 
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
Œ
->
d¡
))

3295 
¡©e
->
¿w
 = 
	`sÿm³r_fd_4
();

3303 if(
	`SCAMPER_TRACE_IS_PMTUD
(
Œ
) ||

3304 (
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œ
è&& 
¡©e
->
¿w
 =ğ
NULL
) ||

3305 
Œ
->
off£t
 !ğ0 || (
	`SCAMPER_TRACE_TYPE_IS_UDP_PARIS
Ñrè&& 
sunos
 != 0))

3307 
¡©e
->
mode
 = 
MODE_DLHDR
;

3308 if((
¡©e
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

3310 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

3311 
dÚe
;

3313 
¡©e
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
Œ
->dst);

3314 
¡©e
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

3315 
¡©e
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

3316 
¡©e
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

3317 
¡©e
->
dlhdr
->
·¿m
 = 
sk
;

3318 
¡©e
->
dlhdr
->
cb
 = 
Œaû_hªdË_dlhdr
;

3319 if(
	`sÿm³r_dlhdr_g‘
(
¡©e
->
dlhdr
) != 0)

3321 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

3322 
dÚe
;

3327 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œ
è&& 
¡©e
->
¿w
 !ğ
NULL
)

3329 
¡©e
->
©‹m±
 = 0;

3330 if(
	`SCAMPER_TRACE_IS_DOUBLETREE
(
Œ
))

3331 
¡©e
->
mode
 = 
MODE_DTREE_FIRST
;

3333 
¡©e
->
mode
 = 
MODE_TRACE
;

3334 
	`sÿm³r_sk_queue_´obe
(
sk
);

3338 if(
¡©e
->
mode
 =ğ
MODE_DLHDR
 && 
	`sÿm³r_sk_queue_isdÚe
(
sk
) == 0)

3339 
	`sÿm³r_sk_queue_wa™
(
sk
, 
Œ
->
wa™
 * 1000);

3341 
dÚe
:

3342 
	`sÿm³r_rou‹_ä“
(
¹
);

3343 if(
¡©e
->
rou‹
 =ğ
¹
)

3344 
¡©e
->
rou‹
 = 
NULL
;

3346 
	}
}

3348 
	$do_Œaû_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

3350 
	`sÿm³r_fe_wr™e_Œaû
(
sf
, 
	`Œaû_g‘d©a
(
sk
));

3352 
	}
}

3354 
	$Œaû_pmtud_¡©e_ä“
(
Œaû_pmtud_¡©e_t
 *
¡©e
)

3356 if(
¡©e
->
L2
 !ğ
NULL
è
	`ä“
(state->L2);

3357 if(
¡©e
->
TTL
 !ğ
NULL
è
	`ä“
(state->TTL);

3358 if(
¡©e
->
nÙe
 !ğ
NULL
è
	`sÿm³r_Œaû_pmtud_n_ä“
(state->note);

3359 
	`ä“
(
¡©e
);

3361 
	}
}

3363 
	$Œaû_¡©e_ä“
(
Œaû_¡©e_t
 *
¡©e
)

3365 
Œaû_´obe_t
 *
´obe
;

3366 
i
;

3369 if(
¡©e
->
´obes
 !ğ
NULL
)

3371 
i
=0; i<
¡©e
->
id_Ãxt
; i++)

3373 
´obe
 = 
¡©e
->
´obes
[
i
];

3374 
	`ä“
(
´obe
);

3376 
	`ä“
(
¡©e
->
´obes
);

3379 #iâdeà
_WIN32


3380 if(
¡©e
->
¹sock
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->rtsock);

3383 if(
¡©e
->
dl
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->dl);

3384 if(
¡©e
->
icmp
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->icmp);

3385 if(
¡©e
->
´obe
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->probe);

3386 if(
¡©e
->
¿w
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->raw);

3387 if(
¡©e
->
rou‹
 !ğ
NULL
è
	`sÿm³r_rou‹_ä“
(state->route);

3388 if(
¡©e
->
dlhdr
 !ğ
NULL
è
	`sÿm³r_dlhdr_ä“
(state->dlhdr);

3389 if(
¡©e
->
š‹rçûs
 !ğ
NULL
è
	`ä“
(state->interfaces);

3390 if(
¡©e
->
lss
 !ğ
NULL
è
	`ä“
(state->lss);

3391 if(
¡©e
->
pmtud
 !ğ
NULL
è
	`Œaû_pmtud_¡©e_ä“
(state->pmtud);

3393 
	`ä“
(
¡©e
);

3395 
	}
}

3397 
	$Œaû_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

3399 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

3400 
Œaû_¡©e_t
 *
¡©e
;

3401 
id_max
;

3403 
	`as£¹
(
Œaû
 !ğ
NULL
);

3406 if((
¡©e
 = 
	`m®loc_z”o
((
Œaû_¡©e_t
))è=ğ
NULL
)

3408 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

3409 
”r
;

3412 
¡©e
->
n
 = 2;

3413 if(
Œaû
->
cÚfid’û
 == 99)

3414 
¡©e
->
cÚfid’û
 = 1;

3417 
¡©e
->
®loc_hİs
 = 
TRACE_ALLOC_HOPS
;

3418 if(
Œaû
->
fœ¡hİ
 >ğ
¡©e
->
®loc_hİs
)

3420 if(
¡©e
->
®loc_hİs
 + (
ušt16_t
)
Œaû
->
fœ¡hİ
 > 256)

3422 
¡©e
->
®loc_hİs
 = 256;

3426 
¡©e
->
®loc_hİs
 +ğ
Œaû
->
fœ¡hİ
;

3430 if(
Œaû
->
dŒ“
 !ğ
NULL
 &&¿û->dŒ“->
lss
 != NULL)

3432 if((
¡©e
->
ls¡
 = 
	`Œaû_lss_g‘
(
Œaû
->
dŒ“
->
lss
)è=ğ
NULL
)

3433 
”r
;

3436 if(
	`sÿm³r_Œaû_hİs_®loc
(
Œaû
, 
¡©e
->
®loc_hİs
) == -1)

3438 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc hops");

3439 
”r
;

3443 
id_max
 = (
¡©e
->
®loc_hİs
 - 
Œaû
->
fœ¡hİ
 + 2è*¿û->
©‹m±s
;

3446 if((
¡©e
->
´obes
 = 
	`m®loc
((
Œaû_´obe_t
 *è* 
id_max
)è=ğ
NULL
)

3448 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…robes");

3449 
”r
;

3452 
¡©e
->
dl
 = 
NULL
;

3453 
¡©e
->
dlhdr
 = 
NULL
;

3454 
¡©e
->
‰l
 = 
Œaû
->
fœ¡hİ
;

3455 
¡©e
->
©‹m±
 = 0;

3456 
¡©e
->
h—d”_size
 = 
	`sÿm³r_Œaû_´obe_h—d”Ën
(
Œaû
);

3457 
¡©e
->
·ylßd_size
 = 
Œaû
->
´obe_size
 - s‹->
h—d”_size
;

3458 
¡©e
->
id_Ãxt
 = 0;

3459 
¡©e
->
id_max
 = id_max;

3462 if(
	`SCAMPER_TRACE_IS_PMTUD
(
Œaû
è|| 
	`SCAMPER_TRACE_IS_DL
(trace) ||

3463 
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
è||¿û->
off£t
 != 0 ||

3464 (
	`SCAMPER_TRACE_TYPE_IS_UDP_PARIS
(
Œaû
è&& 
sunos
 != 0))

3466 
¡©e
->
mode
 = 
MODE_RTSOCK
;

3467 #iâdeà
_WIN32


3468 if((
¡©e
->
¹sock
 = 
	`sÿm³r_fd_¹sock
()è=ğ
NULL
)

3470 
”r
;

3476 if(
	`SCAMPER_TRACE_IS_DOUBLETREE
(
Œaû
))

3477 
¡©e
->
mode
 = 
MODE_DTREE_FIRST
;

3479 
¡©e
->
mode
 = 
MODE_TRACE
;

3482 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3483 
¡©e
->
icmp
 = 
	`sÿm³r_fd_icmp4
(
Œaû
->
¤c
->
addr
);

3484 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

3485 
¡©e
->
icmp
 = 
	`sÿm³r_fd_icmp6
(
Œaû
->
¤c
->
addr
);

3487 
”r
;

3488 if(
¡©e
->
icmp
 =ğ
NULL
)

3489 
”r
;

3491 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

3493 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3495 
¡©e
->
´obe
 = 
	`sÿm³r_fd_tı4
(
NULL
, 
Œaû
->
¥Üt
);

3496 if(
	`sÿm³r_İtiÚ_¿wtı
() != 0 &&

3497 (
¡©e
->
¿w
 = 
	`sÿm³r_fd_4
()è=ğ
NULL
)

3498 
”r
;

3502 
¡©e
->
´obe
 = 
	`sÿm³r_fd_tı6
(
NULL
, 
Œaû
->
¥Üt
);

3505 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
))

3507 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3508 
¡©e
->
´obe
 = 
	`sÿm³r_fd_icmp4
(
Œaû
->
¤c
->
addr
);

3510 
¡©e
->
´obe
 = 
	`sÿm³r_fd_icmp6
(
Œaû
->
¤c
->
addr
);

3512 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
))

3514 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3515 
¡©e
->
´obe
 = 
	`sÿm³r_fd_udp4
(
Œaû
->
¤c
->
addr
,¿û->
¥Üt
);

3517 
¡©e
->
´obe
 = 
	`sÿm³r_fd_udp6
(
Œaû
->
¤c
->
addr
,¿û->
¥Üt
);

3519 if(
¡©e
->
´obe
 =ğ
NULL
)

3520 
”r
;

3522 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

3525 
”r
:

3526 if(
¡©e
 !ğ
NULL
è
	`Œaû_¡©e_ä“
(state);

3528 
	}
}

3530 
	$do_Œaû_h®t
(
sÿm³r_sk_t
 *
sk
)

3532 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

3533 
Œaû
->
¡İ_»asÚ
 = 
SCAMPER_TRACE_STOP_HALTED
;

3534 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

3536 
	}
}

3538 
	$do_Œaû_ä“
(
sÿm³r_sk_t
 *
sk
)

3540 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

3541 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

3543 if(
¡©e
 !ğ
NULL
)

3544 
	`Œaû_¡©e_ä“
(
¡©e
);

3545 if(
Œaû
 !ğ
NULL
)

3546 
	`sÿm³r_Œaû_ä“
(
Œaû
);

3549 
	}
}

3556 
	$do_Œaû_´obe
(
sÿm³r_sk_t
 *
sk
)

3558 
sÿm³r_´obe_İt_t
 
İt
;

3559 
sÿm³r_Œaû_t
 *
Œaû
 = 
	`Œaû_g‘d©a
(
sk
);

3560 
Œaû_¡©e_t
 *
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

3561 
Œaû_´obe_t
 *

 = 
NULL
;

3562 
sÿm³r_´obe_t
 
´obe
;

3563 
ušt16_t
 
u16
, 
i
;

3564 
size_t
 
size
;

3566 
	`as£¹
(
Œaû
 !ğ
NULL
);

3567 
	`as£¹
(
Œaû
->
d¡
 !ğ
NULL
);

3568 
	`as£¹
(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 ||

3569 
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
);

3571 if(
¡©e
 !ğ
NULL
)

3573 
	`as£¹
(
¡©e
->
©‹m±
 < 
Œaû
->
©‹m±s
 ||¿û->
cÚfid’û
 != 0);

3574 
	`as£¹
(
¡©e
->
id_Ãxt
 <ğ¡©e->
id_max
);

3575 
	`as£¹
(
¡©e
->
®loc_hİs
 > 0);

3576 
	`as£¹
(
¡©e
->
®loc_hİs
 <= 256);

3577 
	`as£¹
(
¡©e
->
‰l
 != 0);

3582 
	`g‘timeofday_w¿p
(&
Œaû
->
¡¬t
);

3585 if(
	`Œaû_¡©e_®loc
(
sk
) != 0)

3587 
”r
;

3589 
¡©e
 = 
	`Œaû_g‘¡©e
(
sk
);

3592 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
)

3594 
¡©e
->
rou‹
 = 
	`sÿm³r_rou‹_®loc
(
Œaû
->
d¡
, 
sk
, 
Œaû_hªdË_¹
);

3595 if(
¡©e
->
rou‹
 =ğ
NULL
)

3596 
”r
;

3598 #iâdeà
_WIN32


3599 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
¹sock
, s‹->
rou‹
) != 0)

3600 
”r
;

3601 
¡©e
->
©‹m±
++;

3603 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
rou‹
) != 0)

3604 
”r
;

3607 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

3610 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
 || s‹->mod=ğ
MODE_DLHDR
)

3612 
	`sÿm³r_sk_queue_wa™
(
sk
, 
Œaû
->
wa™
 * 1000);

3618 if(
Œaû
->
hİ_couÁ
 =ğ
¡©e
->
®loc_hİs
)

3624 if(256 - 
¡©e
->
®loc_hİs
 <ğ
TRACE_ALLOC_HOPS
)

3625 
u16
 = 
¡©e
->
®loc_hİs
 + 
TRACE_ALLOC_HOPS
;

3627 
u16
 = 256;

3630 if(
	`sÿm³r_Œaû_hİs_®loc
(
Œaû
, 
u16
) != 0)

3632 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc hops");

3633 
”r
;

3637 
i
=
¡©e
->
®loc_hİs
; i<
u16
; i++)

3638 
Œaû
->
hİs
[
i
] = 
NULL
;

3639 
¡©e
->
®loc_hİs
 = 
u16
;

3643 if(
¡©e
->
id_Ãxt
 =ğ¡©e->
id_max
)

3645 
u16
 = 
¡©e
->
id_max
 + 
TRACE_ALLOC_HOPS
;

3646 
size
 = (
Œaû_´obe_t
 *è* 
u16
;

3647 if(
	`»®loc_w¿p
((**)&
¡©e
->
´obes
, 
size
) != 0)

3649 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

3650 
”r
;

3652 
¡©e
->
id_max
 = 
u16
;

3656 if(
pktbuf_Ën
 < 
¡©e
->
·ylßd_size
)

3658 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
¡©e
->
·ylßd_size
) != 0)

3660 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

3661 
”r
;

3663 
pktbuf_Ën
 = 
¡©e
->
·ylßd_size
;

3666 
	`mem£t
(&
´obe
, 0, (probe));

3667 
´obe
.
´__¤c
 = 
Œaû
->
¤c
;

3668 
´obe
.
´__d¡
 = 
Œaû
->
d¡
;

3669 
´obe
.
´__tos
 = 
Œaû
->
tos
;

3670 
´obe
.
´__‰l
 = 
¡©e
->
‰l
;

3671 
´obe
.
´_d©a
 = 
pktbuf
;

3672 
´obe
.
´_Ën
 = 
¡©e
->
·ylßd_size
;

3673 
´obe
.
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
¡©e
->probe);

3675 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
))

3676 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

3677 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

3678 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

3679 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
))

3680 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3681 
´obe
.
´__´Ùo
 = 
IPPROTO_ICMP
;

3683 
´obe
.
´__´Ùo
 = 
IPPROTO_ICMPV6
;

3685 
”r
;

3697 
´obe
.
´__id
 = 
¡©e
->
id_Ãxt
 + 1;

3699 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3700 
´obe
.
´__off
 = 
IP_DF
;

3702 if(
¡©e
->
dl
 !ğ
NULL
 &&

3703 (
¡©e
->
mode
 =ğ
MODE_PMTUD_DEFAULT
 ||

3704 
¡©e
->
mode
 =ğ
MODE_PMTUD_SILENT_L2
 ||

3705 
¡©e
->
mode
 =ğ
MODE_PMTUD_SILENT_TTL
 ||

3706 
¡©e
->
mode
 =ğ
MODE_PMTUD_BADSUGG
 ||

3707 
Œaû
->
off£t
 != 0 ||

3708 (
	`SCAMPER_TRACE_TYPE_IS_UDP_PARIS
(
Œaû
è&& 
sunos
 != 0) ||

3709 (
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
è&& 
¡©e
->
¿w
 =ğ
NULL
)))

3711 
´obe
.
´_dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
dl
);

3712 
´obe
.
´_dl_buf
 = 
¡©e
->
dlhdr
->
buf
;

3713 
´obe
.
´_dl_Ën
 = 
¡©e
->
dlhdr
->
Ën
;

3716 if(
Œaû
->
·ylßd_Ën
 == 0 ||

3717 (
¡©e
->
mode
 !ğ
MODE_TRACE
 && s‹->mod!ğ
MODE_LASTDITCH
))

3719 if(
´obe
.
´_Ën
 > 0)

3720 
	`mem£t
(
´obe
.
´_d©a
, 0,…robe.
´_Ën
);

3724 
	`memıy
(
´obe
.
´_d©a
, 
Œaû
->
·ylßd
,¿û->
·ylßd_Ën
);

3727 if(
Œaû
->
off£t
 != 0)

3729 
	`as£¹
(
	`SCAMPER_ADDR_TYPE_IS_IPV6
(
Œaû
->
d¡
));

3730 
´obe
.
´__off
 = 
Œaû
->
off£t
;

3731 
´obe
.
´_İts
 = &
İt
;

3732 
´obe
.
´_İtc
 = 1;

3734 
İt
.
ty³
 = 
SCAMPER_PROBE_IPOPTS_V6FRAG
;

3735 
İt
.
İt_v6äag_off
 = 
Œaû
->
off£t
 << 3;

3736 
İt
.
İt_v6äag_id
 = (
Œaû
->
¥Üt
 << 16è|¿û->
´obec
;

3739 
	`by‹s_htÚl
(
´obe
.
´_d©a
, 
Œaû
->
´obec
);

3741 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
))

3743 
´obe
.
´_udp_¥Üt
 = 
Œaû
->
¥Üt
;

3744 
´obe
.
´_udp_dpÜt
 = 
Œaû
->
dpÜt
;

3752 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_UDP
)

3754 
´obe
.
´_udp_dpÜt
 +ğ
¡©e
->
id_Ãxt
;

3765 
	`by‹s_htÚs
(
´obe
.
´_d©a
, 
¡©e
->
id_Ãxt
 + 1);

3766 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3767 
u16
 = 
	`sÿm³r_udp4_cksum
(&
´obe
);

3769 
u16
 = 
	`sÿm³r_udp6_cksum
(&
´obe
);

3770 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

3773 if(
	`SCAMPER_TRACE_TYPE_IS_ICMP
(
Œaû
))

3775 
	`SCAMPER_PROBE_ICMP_ECHO
(&
´obe
, 
Œaû
->
¥Üt
, 
¡©e
->
id_Ãxt
);

3782 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
)

3784 
´obe
.
´_icmp_sum
 = 
	`htÚs
(
Œaû
->
dpÜt
);

3785 
u16
 = 
	`htÚs
(
Œaû
->
dpÜt
);

3786 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

3787 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3788 
u16
 = 
	`sÿm³r_icmp4_cksum
(&
´obe
);

3790 
u16
 = 
	`sÿm³r_icmp6_cksum
(&
´obe
);

3791 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

3796 
	`as£¹
(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
));

3798 if(
¡©e
->
¿w
 !ğ
NULL
)

3799 
´obe
.
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
¡©e
->
¿w
);

3801 
´obe
.
´_fd
 = -1;

3803 
´obe
.
´_tı_¥Üt
 = 
Œaû
->
¥Üt
;

3804 
´obe
.
´_tı_dpÜt
 = 
Œaû
->
dpÜt
;

3805 
´obe
.
´_tı_£q
 = 0;

3806 
´obe
.
´_tı_ack
 = 0;

3807 
´obe
.
´_tı_wš
 = 0;

3809 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_TCP
)

3810 
´obe
.
´_tı_æags
 = 
TH_SYN
;

3812 
´obe
.
´_tı_æags
 = 
TH_ACK
;

3814 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

3815 
´obe
.
´__æow
 = 
¡©e
->
id_Ãxt
 + 1;

3823 if((

 = 
	`m®loc_z”o
((
Œaû_´obe_t
))è=ğ
NULL
)

3825 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot mallocrace_probe_t");

3826 
”r
;

3830 if(
	`sÿm³r_´obe
(&
´obe
) == -1)

3832 
”ºo
 = 
´obe
.
´_”ºo
;

3833 
”r
;

3837 
Œaû
->
´obec
++;

3839 
	`timev®_ıy
(&

->
tx_tv
, &
´obe
.
´_tx
);

3840 

->
‰l
 = 
´obe
.
´__‰l
;

3841 

->
size
 = 
´obe
.
´_Ën
 + 
¡©e
->
h—d”_size
;

3842 

->
mode
 = 
¡©e
->mode;

3843 

->
id
 = 
¡©e
->
©‹m±
;

3845 
¡©e
->
´obes
[¡©e->
id_Ãxt
] = 

;

3846 
¡©e
->
id_Ãxt
++;

3847 
¡©e
->
©‹m±
++;

3850 if(
Œaû
->
wa™_´obe
 > 0)

3851 
	`timev®_add_cs
(&
¡©e
->
Ãxt_tx
, &
´obe
.
´_tx
, 
Œaû
->
wa™_´obe
);

3854 
´obe
.
´_tx
.
tv_£c
 +ğ
Œaû
->
wa™
;

3855 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
´obe
.
´_tx
);

3859 
”r
:

3860 if(

 !ğ
NULL
è
	`ä“
(tp);

3861 
	`Œaû_hªdË”rÜ
(
sk
, 
”ºo
);

3863 
	}
}

3865 
	$Œaû_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

3867 
tmp
 = 0;

3869 
İtid
)

3871 
TRACE_OPT_DPORT
:

3872 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3873 
tmp
 < 
SCAMPER_DO_TRACE_DPORT_MIN
 ||

3874 
tmp
 > 
SCAMPER_DO_TRACE_DPORT_MAX
)

3876 
”r
;

3880 
TRACE_OPT_FIRSTHOP
:

3881 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3882 
tmp
 < 
SCAMPER_DO_TRACE_FIRSTHOP_MIN
 ||

3883 
tmp
 > 
SCAMPER_DO_TRACE_FIRSTHOP_MAX
)

3885 
”r
;

3889 
TRACE_OPT_GAPLIMIT
:

3890 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3891 
tmp
 < 
SCAMPER_DO_TRACE_GAPLIMIT_MIN
 ||

3892 
tmp
 > 
SCAMPER_DO_TRACE_GAPLIMIT_MAX
)

3894 
”r
;

3898 
TRACE_OPT_GAPACTION
:

3899 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3900 
tmp
 < 
SCAMPER_DO_TRACE_GAPACTION_MIN
 ||

3901 
tmp
 > 
SCAMPER_DO_TRACE_GAPACTION_MAX
)

3903 
”r
;

3907 
TRACE_OPT_LOOPS
:

3908 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3909 
tmp
 < 
SCAMPER_DO_TRACE_LOOPS_MIN
 ||

3910 
tmp
 > 
SCAMPER_DO_TRACE_LOOPS_MAX
)

3912 
”r
;

3916 
TRACE_OPT_LOOPACTION
:

3917 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3918 
tmp
 < 
SCAMPER_DO_TRACE_LOOPACTION_MIN
 ||

3919 
tmp
 > 
SCAMPER_DO_TRACE_LOOPACTION_MAX
)

3921 
”r
;

3925 
TRACE_OPT_OFFSET
:

3926 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3927 
tmp
 < 
SCAMPER_DO_TRACE_OFFSET_MIN
 ||

3928 
tmp
 > 
SCAMPER_DO_TRACE_OFFSET_MAX
)

3930 
”r
;

3934 
TRACE_OPT_MAXTTL
:

3935 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3936 
tmp
 < 
SCAMPER_DO_TRACE_HOPLIMIT_MIN
 ||

3937 
tmp
 > 
SCAMPER_DO_TRACE_HOPLIMIT_MAX
)

3939 
”r
;

3943 
TRACE_OPT_PAYLOAD
:

3944 if((
	`¡¾’
(
·¿m
) % 2) != 0)

3946 
”r
;

3950 
TRACE_OPT_PROTOCOL
:

3951 if(
	`¡rÿ£cmp
(
·¿m
, "UDP") == 0)

3952 
tmp
 = 
SCAMPER_TRACE_TYPE_UDP
;

3953 if(
	`¡rÿ£cmp
(
·¿m
, "TCP") == 0)

3954 
tmp
 = 
SCAMPER_TRACE_TYPE_TCP
;

3955 if(
	`¡rÿ£cmp
(
·¿m
, "ICMP") == 0)

3956 
tmp
 = 
SCAMPER_TRACE_TYPE_ICMP_ECHO
;

3957 if(
	`¡rÿ£cmp
(
·¿m
, "ICMP-paris") == 0)

3958 
tmp
 = 
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
;

3959 if(
	`¡rÿ£cmp
(
·¿m
, "UDP-paris") == 0)

3960 
tmp
 = 
SCAMPER_TRACE_TYPE_UDP_PARIS
;

3961 if(
	`¡rÿ£cmp
(
·¿m
, "TCP-ack") == 0)

3962 
tmp
 = 
SCAMPER_TRACE_TYPE_TCP_ACK
;

3963 
”r
;

3966 
TRACE_OPT_ATTEMPTS
:

3967 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3968 
tmp
 < 
SCAMPER_DO_TRACE_ATTEMPTS_MIN
 ||

3969 
tmp
 > 
SCAMPER_DO_TRACE_ATTEMPTS_MAX
)

3971 
”r
;

3975 
TRACE_OPT_SPORT
:

3976 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3977 
tmp
 < 
SCAMPER_DO_TRACE_SPORT_MIN
 ||

3978 
tmp
 > 
SCAMPER_DO_TRACE_SPORT_MAX
)

3980 
”r
;

3984 
TRACE_OPT_TOS
:

3985 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3986 
tmp
 < 
SCAMPER_DO_TRACE_TOS_MIN
 ||

3987 
tmp
 > 
SCAMPER_DO_TRACE_TOS_MAX
)

3989 
”r
;

3993 
TRACE_OPT_WAIT
:

3994 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

3995 
tmp
 < 
SCAMPER_DO_TRACE_WAIT_MIN
 ||

3996 
tmp
 > 
SCAMPER_DO_TRACE_WAIT_MAX
)

3998 
”r
;

4002 
TRACE_OPT_CONFIDENCE
:

4003 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 || (tmp != 95 &&mp != 99))

4005 
”r
;

4009 
TRACE_OPT_WAITPROBE
:

4010 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) == -1 ||

4011 
tmp
 < 
SCAMPER_DO_TRACE_WAITPROBE_MIN
 ||

4012 
tmp
 > 
SCAMPER_DO_TRACE_WAITPROBE_MAX
)

4014 
”r
;

4018 
TRACE_OPT_USERID
:

4019 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

4020 
”r
;

4023 
TRACE_OPT_SRCADDR
:

4024 
TRACE_OPT_GSSENTRY
:

4025 
TRACE_OPT_LSSNAME
:

4029 
TRACE_OPT_PMTUD
:

4030 
TRACE_OPT_ALLATTEMPTS
:

4031 
TRACE_OPT_TTLDST
:

4040 if(
out
 !ğ
NULL
)

4041 *
out
 = 
tmp
;

4044 
”r
:

4046 
	}
}

4055 *
	$sÿm³r_do_Œaû_®loc
(*
¡r
)

4058 
ušt8_t
 
ty³
 = 
SCAMPER_TRACE_TYPE_UDP_PARIS
;

4059 
ušt8_t
 
æags
 = 0;

4060 
ušt8_t
 
©‹m±s
 = 
SCAMPER_DO_TRACE_ATTEMPTS_DEF
;

4061 
ušt8_t
 
fœ¡hİ
 = 
SCAMPER_DO_TRACE_FIRSTHOP_DEF
;

4062 
ušt8_t
 
g­lim™
 = 
SCAMPER_DO_TRACE_GAPLIMIT_DEF
;

4063 
ušt8_t
 
g­aùiÚ
 = 
SCAMPER_DO_TRACE_GAPACTION_DEF
;

4064 
ušt8_t
 
hİlim™
 = 
SCAMPER_DO_TRACE_HOPLIMIT_DEF
;

4065 
ušt8_t
 
tos
 = 
SCAMPER_DO_TRACE_TOS_DEF
;

4066 
ušt8_t
 
wa™
 = 
SCAMPER_DO_TRACE_WAIT_DEF
;

4067 
ušt8_t
 
wa™_´obe
 = 
SCAMPER_DO_TRACE_WAITPROBE_DEF
;

4068 
ušt8_t
 
loİs
 = 
SCAMPER_DO_TRACE_LOOPS_DEF
;

4069 
ušt8_t
 
loİaùiÚ
 = 
SCAMPER_DO_TRACE_LOOPACTION_DEF
;

4070 
ušt8_t
 
cÚfid’û
 = 0;

4071 
ušt16_t
 
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

4072 
ušt16_t
 
dpÜt
 = 
SCAMPER_DO_TRACE_DPORT_DEF
;

4073 
ušt16_t
 
off£t
 = 
SCAMPER_DO_TRACE_OFFSET_DEF
;

4074 
ušt8_t
 *
·ylßd
 = 
NULL
;

4075 
ušt16_t
 
·ylßd_Ën
 = 0;

4076 
ušt32_t
 
u£rid
 = 0;

4077 *
lss
 = 
NULL
;

4078 
¦i¡_t
 *
gss
 = 
NULL
;

4079 
size_t
 
i
, 
Ën
;

4080 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

4081 
sÿm³r_Œaû_t
 *
Œaû
 = 
NULL
;

4082 
sÿm³r_addr_t
 *
§
;

4083 *
addr
;

4084 
tmp
 = 0;

4085 *
¤c
 = 
NULL
;

4086 
af
;

4087 
ušt32_t
 
İtids
 = 0;

4090 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

4092 
”r
;

4096 if(
addr
 =ğ
NULL
)

4098 
”r
;

4102 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

4104 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

4105 
	`Œaû_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

4107 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

4108 
”r
;

4111 
İtids
 |ğ(0x1 << 
İt
->
id
);

4113 
İt
->
id
)

4115 
TRACE_OPT_DPORT
:

4116 
dpÜt
 = (
ušt16_t
)
tmp
;

4119 
TRACE_OPT_FIRSTHOP
:

4120 
fœ¡hİ
 = (
ušt8_t
)
tmp
;

4123 
TRACE_OPT_GAPLIMIT
:

4124 
g­lim™
 = (
ušt8_t
)
tmp
;

4127 
TRACE_OPT_GAPACTION
:

4128 
g­aùiÚ
 = (
ušt8_t
)
tmp
;

4131 
TRACE_OPT_LOOPS
:

4132 
loİs
 = (
ušt8_t
)
tmp
;

4135 
TRACE_OPT_LOOPACTION
:

4136 
loİaùiÚ
 = (
ušt8_t
)
tmp
;

4139 
TRACE_OPT_MAXTTL
:

4140 
hİlim™
 = (
ušt8_t
)
tmp
;

4143 
TRACE_OPT_OFFSET
:

4144 
off£t
 = (
ušt16_t
)
tmp
;

4147 
TRACE_OPT_PAYLOAD
:

4148 
Ën
 = 
	`¡¾’
(
İt
->
¡r
);

4149 
·ylßd_Ën
 = 
Ën
/2;

4150 if((
·ylßd
 = 
	`m®loc
(
·ylßd_Ën
)è=ğ
NULL
)

4152 
	`´š‹¼Ü
(
”ºo
,
¡»¼Ü
,
__func__
, "could‚ot malloc…ayload");

4153 
”r
;

4155 
i
=0; i<
Ën
; i+=2)

4157 
·ylßd
[
i
/2] = 
	`hex2by‹
(
İt
->
¡r
[i], opt->str[i+1]);

4161 
TRACE_OPT_PMTUD
:

4162 
æags
 |ğ
SCAMPER_TRACE_FLAG_PMTUD
;

4165 
TRACE_OPT_PROTOCOL
:

4166 
ty³
 = (
ušt8_t
)
tmp
;

4169 
TRACE_OPT_ATTEMPTS
:

4170 
©‹m±s
 = (
ušt8_t
)
tmp
;

4173 
TRACE_OPT_ALLATTEMPTS
:

4174 
æags
 |ğ
SCAMPER_TRACE_FLAG_ALLATTEMPTS
;

4177 
TRACE_OPT_SPORT
:

4178 
¥Üt
 = (
ušt16_t
)
tmp
;

4181 
TRACE_OPT_TOS
:

4182 
tos
 = (
ušt8_t
)
tmp
;

4185 
TRACE_OPT_TTLDST
:

4186 
æags
 |ğ
SCAMPER_TRACE_FLAG_IGNORETTLDST
;

4189 
TRACE_OPT_WAIT
:

4190 
wa™
 = (
ušt8_t
)
tmp
;

4193 
TRACE_OPT_SRCADDR
:

4194 if(
¤c
 !ğ
NULL
)

4195 
”r
;

4196 
¤c
 = 
İt
->
¡r
;

4199 
TRACE_OPT_CONFIDENCE
:

4200 
cÚfid’û
 = (
ušt8_t
)
tmp
;

4203 
TRACE_OPT_USERID
:

4204 
u£rid
 = (
ušt32_t
)
tmp
;

4207 
TRACE_OPT_WAITPROBE
:

4208 
wa™_´obe
 = (
ušt8_t
)
tmp
;

4211 
TRACE_OPT_LSSNAME
:

4212 
lss
 = 
İt
->
¡r
;

4215 
TRACE_OPT_GSSENTRY
:

4216 if((
gss
 =ğ
NULL
 && (gs ğ
	`¦i¡_®loc
()) == NULL) ||

4217 
	`¦i¡__push
(
gss
, 
İt
->
¡r
è=ğ
NULL
)

4219 
”r
;

4224 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

4227 if(
fœ¡hİ
 > 
hİlim™
 && hoplimit != 0)

4229 
”r
;

4233 if((
æags
 & 
SCAMPER_TRACE_FLAG_PMTUD
) != 0 &&

4234 (
fœ¡hİ
 > 1 || 
gss
 !ğ
NULL
 || 
lss
 != NULL))

4236 
”r
;

4240 if(
cÚfid’û
 !ğ0 && (
æags
 & 
SCAMPER_TRACE_FLAG_ALLATTEMPTS
))

4242 
”r
;

4246 if((
æags
 & 
SCAMPER_TRACE_FLAG_PMTUD
) != 0 &&

4247 
ty³
 !ğ
SCAMPER_TRACE_TYPE_UDP
 &&y³ !ğ
SCAMPER_TRACE_TYPE_UDP_PARIS
)

4249 
”r
;

4252 if((
Œaû
 = 
	`sÿm³r_Œaû_®loc
()è=ğ
NULL
)

4254 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocrace");

4255 
”r
;

4257 if((
Œaû
->
d¡
ğ
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
)è=ğ
NULL
)

4259 
”r
;

4262 
Œaû
->
ty³
 =ype;

4263 
Œaû
->
æags
 = flags;

4264 
Œaû
->
©‹m±s
 =‡ttempts;

4265 
Œaû
->
hİlim™
 = hoplimit;

4266 
Œaû
->
g­lim™
 = gaplimit;

4267 
Œaû
->
g­aùiÚ
 = gapaction;

4268 
Œaû
->
fœ¡hİ
 = firsthop;

4269 
Œaû
->
tos
 =os;

4270 
Œaû
->
wa™
 = wait;

4271 
Œaû
->
loİs
 =†oops;

4272 
Œaû
->
loİaùiÚ
 =†oopaction;

4273 
Œaû
->
¥Üt
 = sport;

4274 
Œaû
->
dpÜt
 = dport;

4275 
Œaû
->
·ylßd
 =…aylßd;…aylßd = 
NULL
;

4276 
Œaû
->
·ylßd_Ën
 =…ayload_len;

4277 
Œaû
->
cÚfid’û
 = confidence;

4278 
Œaû
->
wa™_´obe
 = wait_probe;

4279 
Œaû
->
off£t
 = offset;

4280 
Œaû
->
u£rid
 = userid;

4285 
Œaû
->
hİ_couÁ
 = 
fœ¡hİ
 - 1;

4288 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
è&&¿û->
·ylßd_Ën
 > 0)

4290 
”r
;

4294 if(
Œaû
->
off£t
 !ğ0 &&¿û->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

4296 
”r
;

4299 
Œaû
->
d¡
->
ty³
)

4301 
SCAMPER_ADDR_TYPE_IPV4
:

4302 if(
	`SCAMPER_TRACE_TYPE_IS_TCP
(
Œaû
))

4304 
Œaû
->
´obe_size
 = 40;

4308 if(
Œaû
->
·ylßd_Ën
 == 0)

4309 
Œaû
->
´obe_size
 = 44;

4311 
Œaû
->
´obe_size
 = 20 + 8 +¿û->
·ylßd_Ën
;

4315 
SCAMPER_ADDR_TYPE_IPV6
:

4316 if(
Œaû
->
off£t
 != 0)

4318 
Œaû
->
´obe_size
 = 40 + 8 + 4 +¿û->
·ylßd_Ën
;

4320 if(
Œaû
->
·ylßd_Ën
 =ğ0 || 
	`SCAMPER_TRACE_TYPE_IS_TCP
(trace))

4322 
Œaû
->
´obe_size
 = 60;

4326 
Œaû
->
´obe_size
 = 40 + 8 +¿û->
·ylßd_Ën
;

4331 
”r
;

4334 
af
 = 
	`sÿm³r_addr_af
(
Œaû
->
d¡
);

4335 if(
af
 !ğ
AF_INET
 &&‡à!ğ
AF_INET6
)

4336 
”r
;

4338 if(
¤c
 !ğ
NULL
)

4340 if((
Œaû
->
¤c
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, src)è=ğ
NULL
)

4341 
”r
;

4348 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACE_TYPE_ICMP_ECHO_PARIS
)

4350 
Œaû
->
æags
 |ğ
SCAMPER_TRACE_FLAG_ICMPCSUMDP
;

4351 if((
İtids
 & (0x1 << 
TRACE_OPT_DPORT
)) == 0)

4352 
Œaû
->
dpÜt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

4355 if(
	`sÿm³r_İtiÚ_dl
() != 0)

4357 
Œaû
->
æags
 |ğ
SCAMPER_TRACE_FLAG_DL
;

4361 if(
gss
 !ğ
NULL
 || 
lss
 != NULL)

4363 if(
	`sÿm³r_Œaû_dŒ“_®loc
(
Œaû
) != 0)

4364 
”r
;

4365 
Œaû
->
æags
 |ğ
SCAMPER_TRACE_FLAG_DOUBLETREE
;

4366 
Œaû
->
dŒ“
->
fœ¡hİ
 =race->firsthop;

4369 if(
lss
 !ğ
NULL
)

4371 if(
	`sÿm³r_Œaû_dŒ“_lss
(
Œaû
, 
lss
) != 0)

4372 
”r
;

4375 if(
gss
 !ğ
NULL
)

4377 (
addr
 = 
	`¦i¡_h—d_pİ
(
gss
)è!ğ
NULL
)

4379 if((
§
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
, 
af
, 
addr
)è=ğ
NULL
 ||

4380 (
	`sÿm³r_Œaû_dŒ“_gss_fšd
(
Œaû
, 
§
è=ğ
NULL
 &&

4381 
	`sÿm³r_Œaû_dŒ“_gss_add
(
Œaû
, 
§
) != 0))

4382 
”r
;

4385 
	`¦i¡_ä“
(
gss
);

4386 
gss
 = 
NULL
;

4389  
Œaû
;

4391 
”r
:

4392 if(
·ylßd
 !ğ
NULL
è
	`ä“
(payload);

4393 if(
gss
 !ğ
NULL
è
	`¦i¡_ä“
(gss);

4394 if(
Œaû
 !ğ
NULL
è
	`sÿm³r_Œaû_ä“
(trace);

4395 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

4396  
NULL
;

4397 
	}
}

4399 
	$sÿm³r_do_Œaû_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

4401  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

4402 
Œaû_¬g_·¿m_v®id©e
);

4403 
	}
}

4405 
	$sÿm³r_do_Œaû_ä“
(*
d©a
)

4407 
	`sÿm³r_Œaû_ä“
((
sÿm³r_Œaû_t
 *)
d©a
);

4409 
	}
}

4411 
	$sÿm³r_do_Œaû_dŒ“_lss_ş—r
(*
Çme
)

4413 
Œaû_lss_t
 *
lss
, 
fšdme
;

4415 
fšdme
.
Çme
 =‚ame;

4416 if((
lss
 = 
	`¥ÏyŒ“_fšd
(
ls£s
, &
fšdme
)è=ğ
NULL
)

4419 
	`¥ÏyŒ“_em±y
(
lss
->
Œ“
, (
¥ÏyŒ“_ä“_t
)
sÿm³r_addr_ä“
);

4421 
	}
}

4427 
sÿm³r_sk_t
 *
	$sÿm³r_do_Œaû_®loùask
(*
d©a
,

4428 
sÿm³r_li¡_t
 *
li¡
,

4429 
sÿm³r_cyşe_t
 *
cyşe
)

4431 
sÿm³r_Œaû_t
 *
Œaû
 = (sÿm³r_Œaû_ˆ*)
d©a
;

4432 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

4433 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

4436 if((
sk
 = 
	`sÿm³r_sk_®loc
(
Œaû
, &
Œaû_funcs
)è=ğ
NULL
)

4437 
”r
;

4440 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

4441 
”r
;

4442 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
Œaû
->
d¡
);

4443 if(
Œaû
->
¤c
 =ğ
NULL
 && (Œaû->¤øğ
	`sÿm³r_g‘¤c
Ñ¿û->
d¡
,0)) == NULL)

4444 
”r
;

4445 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
Œaû
->
¤c
);

4446 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

4447 
”r
;

4448 
sig
 = 
NULL
;

4451 
Œaû
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

4452 
Œaû
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

4454  
sk
;

4456 
”r
:

4457 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

4458 if(
sk
 !ğ
NULL
)

4460 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

4461 
	`sÿm³r_sk_ä“
(
sk
);

4463  
NULL
;

4464 
	}
}

4466 
	$sÿm³r_do_Œaû_ş—nup
()

4468 if(
pktbuf
 !ğ
NULL
)

4470 
	`ä“
(
pktbuf
);

4471 
pktbuf
 = 
NULL
;

4474 if(
ls£s
 !ğ
NULL
)

4476 
	`¥ÏyŒ“_ä“
(
ls£s
, (
¥ÏyŒ“_ä“_t
)
Œaû_lss_ä“
);

4477 
ls£s
 = 
NULL
;

4481 
	}
}

4483 
	$sÿm³r_do_Œaû_š™
()

4485 cÚ¡ 
sÿm³r_osšfo_t
 *
osšfo
;

4487 
Œaû_funcs
.
´obe
 = 
do_Œaû_´obe
;

4488 
Œaû_funcs
.
hªdË_icmp
 = 
do_Œaû_hªdË_icmp
;

4489 
Œaû_funcs
.
hªdË_dl
 = 
do_Œaû_hªdË_dl
;

4490 
Œaû_funcs
.
hªdË_timeout
 = 
do_Œaû_hªdË_timeout
;

4491 
Œaû_funcs
.
wr™e
 = 
do_Œaû_wr™e
;

4492 
Œaû_funcs
.
sk_ä“
 = 
do_Œaû_ä“
;

4493 
Œaû_funcs
.
h®t
 = 
do_Œaû_h®t
;

4495 
osšfo
 = 
	`sÿm³r_osšfo_g‘
();

4496 if(
	`SCAMPER_OSINFO_IS_SUNOS
(
osšfo
))

4497 
sunos
 = 1;

4500 
	}
}

	@trace/scamper_trace_do.h

25 #iâdeà
__SCAMPER_DO_TRACE_H


26 
	#__SCAMPER_DO_TRACE_H


	)

28 *
sÿm³r_do_Œaû_®loc
(*
¡r
);

30 
sÿm³r_sk_t
 *
sÿm³r_do_Œaû_®loùask
(*
d©a
,

31 
sÿm³r_li¡_t
 *
li¡
,

32 
sÿm³r_cyşe_t
 *
cyşe
);

34 
sÿm³r_do_Œaû_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

36 
sÿm³r_do_Œaû_ä“
(*
d©a
);

38 cÚ¡ *
sÿm³r_do_Œaû_u§ge
();

40 
sÿm³r_do_Œaû_dŒ“_lss_ş—r
(*
Çme
);

42 
sÿm³r_do_Œaû_ş—nup
();

43 
sÿm³r_do_Œaû_š™
();

	@trace/scamper_trace_json.c

27 #iâdeà
lšt


28 cÚ¡ 
	grcsid
[] =

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

35 
	~"š‹º®.h
"

37 
	~"sÿm³r_addr.h
"

38 
	~"sÿm³r_li¡.h
"

39 
	~"sÿm³r_Œaû.h
"

40 
	~"sÿm³r_fe.h
"

41 
	~"sÿm³r_Œaû_jsÚ.h
"

42 
	~"uts.h
"

44 *
	$hİ_to¡r
(
sÿm³r_Œaû_hİ_t
 *
hİ
)

46 
buf
[512], 
tmp
[128];

47 
size_t
 
off
 = 0;

49 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "{\"addr\":\"%s\"",

50 
	`sÿm³r_addr_to¡r
(
hİ
->
hİ_addr
, 
tmp
, (tmp)));

51 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

53 
hİ
->
hİ_´obe_‰l
, hİ->
hİ_´obe_id
, hİ->
hİ_´obe_size
);

54 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"rtt\":%s",

55 
	`timev®_to¡r
(&
hİ
->
hİ_¹t
, 
tmp
, (tmp)));

56 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

58 
hİ
->
hİ_»¶y_‰l
, hİ->
hİ_»¶y_tos
, hİ->
hİ_»¶y_size
);

59 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"reply_ipid\":%u",

60 
hİ
->
hİ_»¶y_id
);

62 if(
	`SCAMPER_TRACE_HOP_IS_ICMP
(
hİ
))

64 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

66 
hİ
->
hİ_icmp_ty³
, hİ->
hİ_icmp_code
);

67 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
))

69 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

71 
hİ
->
hİ_icmp_q_‰l
, hİ->
hİ_icmp_q_l
);

72 if(
	`SCAMPER_ADDR_TYPE_IS_IPV4
(
hİ
->
hİ_addr
))

73 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"icmp_q_tos\":%u",

74 
hİ
->
hİ_icmp_q_tos
);

76 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
))

77 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"icmp_nhmtu:\":%u",

78 
hİ
->
hİ_icmp_nhmtu
);

82 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

83 ", \"tı_æags\":%u", 
hİ
->
hİ_tı_æags
);

85 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "}");

86  
	`¡rdup
(
buf
);

87 
	}
}

89 *
	$¡İ_»asÚ_to¡r
(
ušt8_t
 
»asÚ
, *
buf
, 
size_t
 
Ën
)

91 *
r
[] = {

102 if(
»asÚ
 > (
r
) / (*))

104 
	`¢´štf
(
buf
, 
Ën
, "%d", 
»asÚ
);

105  
buf
;

107  
r
[
»asÚ
];

108 
	}
}

110 *
	$h—d”_to¡r
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

112 
buf
[512], 
tmp
[64];

113 cÚ¡ *
±r
;

114 
size_t
 
off
 = 0;

115 
time_t
 
‰
 = 
Œaû
->
¡¬t
.
tv_£c
;

117 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "\"version\":\"0.1\",\"type\":\"trace\"");

118 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"u£rid\":%u", 
Œaû
->
u£rid
);

119 if((
±r
 = 
	`sÿm³r_Œaû_ty³_to¡r
(
Œaû
)è!ğ
NULL
)

120 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"m‘hod\":\"%s\"", 
±r
);

122 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"m‘hod\":\"%u\"", 
Œaû
->
ty³
);

123 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"src\":\"%s\"",

124 
	`sÿm³r_addr_to¡r
(
Œaû
->
¤c
, 
tmp
, (tmp)));

125 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"dst\":\"%s\"",

126 
	`sÿm³r_addr_to¡r
(
Œaû
->
d¡
, 
tmp
, (tmp)));

127 if(
	`SCAMPER_TRACE_TYPE_IS_UDP
(
Œaû
è|| 
	`SCAMPER_TRACE_TYPE_IS_TCP
(trace))

128 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"sport\":%u, \"dport\":%u",

129 
Œaû
->
¥Üt
,¿û->
dpÜt
);

130 if(
Œaû
->
æags
 & 
SCAMPER_TRACE_FLAG_ICMPCSUMDP
)

131 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"icmp_sum\":%u", 
Œaû
->
dpÜt
);

132 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

134 
	`¡İ_»asÚ_to¡r
(
Œaû
->
¡İ_»asÚ
, 
tmp
, (tmp)),

135 
Œaû
->
¡İ_d©a
);

136 
	`¡ráime
(
tmp
, Ñmp), "%Y-%m-%d %H:%M:%S", 
	`loÿÉime
(&
‰
));

137 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

139 
Œaû
->
¡¬t
.
tv_£c
,¿û->¡¬t.
tv_u£c
, 
tmp
);

140 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

142 
Œaû
->
hİ_couÁ
,¿û->
©‹m±s
,¿û->
hİlim™
);

143 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
,

145 
Œaû
->
fœ¡hİ
,¿û->
wa™
,¿û->
wa™_´obe
);

146 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ", \"tos\":%u, \"probe_size\":%u",

147 
Œaû
->
tos
,¿û->
´obe_size
);

149  
	`¡rdup
(
buf
);

150 
	}
}

152 
	$sÿm³r_fe_jsÚ_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

153 cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

155 
sÿm³r_Œaû_hİ_t
 *
hİ
;

156 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

157 
size_t
 
wc
, 
Ën
, 
off
 = 0;

158 
off_t
 
foff
 = 0;

159 *
¡r
 = 
NULL
, *
h—d”
 = NULL, **
hİs
 = NULL;

160 
hİc
, 
i
, 
j
, 
rc
 = -1;

162 if(
fd
 !ğ
STDOUT_FILENO
 && (
foff
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1)

165 if((
h—d”
 = 
	`h—d”_to¡r
(
Œaû
)è=ğ
NULL
)

166 
ş—nup
;

167 
Ën
 = 
	`¡¾’
(
h—d”
);

169 
i
=
Œaû
->
fœ¡hİ
-1, 
hİc
=0; i<Œaû->
hİ_couÁ
; i++)

170 
hİ
 = 
Œaû
->
hİs
[
i
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

171 
hİc
++;

172 if(
hİc
 > 0)

174 
Ën
 += 11;

175 if((
hİs
 = 
	`m®loc_z”o
((*è* 
hİc
)è=ğ
NULL
)

176 
ş—nup
;

177 
i
=
Œaû
->
fœ¡hİ
-1, 
j
=0; i<Œaû->
hİ_couÁ
; i++)

179 
hİ
 = 
Œaû
->
hİs
[
i
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

181 if(
j
 > 0è
Ën
++;

182 if((
hİs
[
j
] = 
	`hİ_to¡r
(
hİ
)è=ğ
NULL
)

183 
ş—nup
;

184 
Ën
 +ğ
	`¡¾’
(
hİs
[
j
]);

185 
j
++;

189 
Ën
 += 4;

191 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

192 
ş—nup
;

194 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "{%s", 
h—d”
);

195 if(
hİc
 > 0)

197 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, ", \"hops\":[");

198 
j
=0; j<
hİc
; j++)

200 if(
j
 > 0è
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, ",");

201 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "%s", 
hİs
[
j
]);

203 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "]");

205 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "}\n");

206 
	`as£¹
(
off
+1 =ğ
Ën
);

208 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
off
) != 0)

210 if(
fd
 !ğ
STDOUT_FILENO
)

212 if(
	`árunÿ‹
(
fd
, 
foff
) != 0)

213 
ş—nup
;

215 
ş—nup
;

218 
rc
 = 0;

220 
ş—nup
:

221 if(
hİs
 !ğ
NULL
)

223 
i
=0; i<
hİc
; i++)

224 if(
hİs
[
i
] !ğ
NULL
)

225 
	`ä“
(
hİs
[
i
]);

226 
	`ä“
(
hİs
);

228 if(
h—d”
 !ğ
NULL
è
	`ä“
(header);

229 if(
¡r
 !ğ
NULL
è
	`ä“
(str);

231  
rc
;

232 
	}
}

	@trace/scamper_trace_json.h

23 #iâdeà
__SCAMPER_TRACE_JSON_H


24 
	#__SCAMPER_TRACE_JSON_H


	)

26 
sÿm³r_fe_jsÚ_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

27 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

	@trace/scamper_trace_text.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_Œaû.h
"

38 
	~"sÿm³r_fe.h
"

39 
	~"sÿm³r_Œaû_‹xt.h
"

40 
	~"uts.h
"

42 *
	$addr_¡r
(cÚ¡ 
sÿm³r_addr_t
 *
addr
,*
buf
,cÚ¡ 
size_t
 
Ën
)

44 if(
addr
 !ğ
NULL
)

45 
	`sÿm³r_addr_to¡r
(
addr
, 
buf
, 
Ën
);

47 
	`¢´štf
(
buf
, 
Ën
, "*");

49  
buf
;

50 
	}
}

58 *
	$icmp_to¡r
(cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
,

59 *
¡r
, cÚ¡ 
size_t
 
Ën
)

61 if((
hİ
->
hİ_æags
 & 
SCAMPER_TRACE_HOP_FLAG_TCP
) != 0)

63 if((
hİ
->
hİ_tı_æags
 & 
TH_RST
) != 0)

65 
	`¢´štf
(
¡r
, 
Ën
, " [closed]");

67 if((
hİ
->
hİ_tı_æags
 & (
TH_SYN
|
TH_ACK
)) == (TH_SYN|TH_ACK))

69 if((
hİ
->
hİ_tı_æags
 & 
TH_ECE
) != 0)

70 
	`¢´štf
(
¡r
, 
Ën
, " [open,ƒcn]");

72 
	`¢´štf
(
¡r
, 
Ën
, " [open]");

76 if(
hİ
->
hİ_tı_æags
 == 0)

77 
	`¢´štf
(
¡r
, 
Ën
, " [unknown,‚o flags]");

79 
	`¢´štf
(
¡r
, 
Ën
, " [unknown,%s%s%s%s%s%s%s%s]",

80 (
hİ
->
hİ_tı_æags
 & 
TH_RST
) ? " RST" : "",

81 (
hİ
->
hİ_tı_æags
 & 
TH_SYN
) ? " SYN" : "",

82 (
hİ
->
hİ_tı_æags
 & 
TH_ACK
) ? " ACK" : "",

83 (
hİ
->
hİ_tı_æags
 & 
TH_PUSH
) ? " PSH" : "",

84 (
hİ
->
hİ_tı_æags
 & 
TH_FIN
) ? " FIN" : "",

85 (
hİ
->
hİ_tı_æags
 & 
TH_URG
) ? " URG" : "",

86 (
hİ
->
hİ_tı_æags
 & 
TH_CWR
) ? " CWR" : "",

87 (
hİ
->
hİ_tı_æags
 & 
TH_ECE
) ? " ECE" : "");

90 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_TTL_EXP
(
hİ
) ||

91 
	`SCAMPER_TRACE_HOP_IS_ICMP_ECHO_REPLY
(
hİ
))

93 
¡r
[0] = '\0';

95 if(
hİ
->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

97 if(
hİ
->
hİ_icmp_ty³
 =ğ
ICMP_UNREACH
)

99 
hİ
->
hİ_icmp_code
)

101 
ICMP_UNREACH_FILTER_PROHIB
:

102 
	`¢´štf
(
¡r
, 
Ën
, " !X");

105 
ICMP_UNREACH_HOST
:

106 
	`¢´štf
(
¡r
, 
Ën
, " !H");

109 
ICMP_UNREACH_NEEDFRAG
:

110 
	`¢´štf
(
¡r
, 
Ën
, " !F");

113 
ICMP_UNREACH_SRCFAIL
:

114 
	`¢´štf
(
¡r
, 
Ën
, " !S");

117 
ICMP_UNREACH_PROTOCOL
:

118 
	`¢´štf
(
¡r
, 
Ën
, " !P");

121 
ICMP_UNREACH_NET
:

122 
	`¢´štf
(
¡r
, 
Ën
, " !N");

125 
ICMP_UNREACH_PORT
:

126 
¡r
[0] = '\0';

130 
	`¢´štf
(
¡r
, 
Ën
, " !<%d>", 
hİ
->
hİ_icmp_code
);

136 
	`¢´štf
(
¡r
,
Ën
," !<%d,%d>",
hİ
->
hİ_icmp_ty³
,hİ->
hİ_icmp_code
);

139 if(
hİ
->
hİ_addr
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

141 if(
hİ
->
hİ_icmp_ty³
 =ğ
ICMP6_DST_UNREACH
)

143 
hİ
->
hİ_icmp_code
)

145 
ICMP6_DST_UNREACH_ADDR
:

146 
	`¢´štf
(
¡r
, 
Ën
," !A");

149 
ICMP6_DST_UNREACH_BEYONDSCOPE
:

150 
	`¢´štf
(
¡r
, 
Ën
," !S");

153 
ICMP6_DST_UNREACH_ADMIN
:

154 
	`¢´štf
(
¡r
, 
Ën
," !P");

157 
ICMP6_DST_UNREACH_NOROUTE
:

158 
	`¢´štf
(
¡r
, 
Ën
," !N");

161 
ICMP6_DST_UNREACH_NOPORT
:

162 
¡r
[0] = '\0';

166 
	`¢´štf
(
¡r
, 
Ën
, " !<%d>", 
hİ
->
hİ_icmp_code
);

170 if(
hİ
->
hİ_icmp_ty³
 =ğ
ICMP6_PACKET_TOO_BIG
)

172 
	`¢´štf
(
¡r
,
Ën
," !F");

176 
	`¢´štf
(
¡r
,
Ën
," !<%d,%d>",
hİ
->
hİ_icmp_ty³
,hİ->
hİ_icmp_code
);

180  
¡r
;

181 
	}
}

187 *
	$h—d”_to¡r
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

189 
¤c
[64], 
d¡
[64], 
h—d”
[192];

191 if(
Œaû
->
d¡
 =ğ
NULL
)

192  
NULL
;

193 
	`sÿm³r_addr_to¡r
(
Œaû
->
d¡
, dst, (dst));

195 if(
Œaû
->
¤c
 !ğ
NULL
)

197 
	`sÿm³r_addr_to¡r
(
Œaû
->
¤c
, src, (src));

198 
	`¢´štf
(
h—d”
, (h—d”), "Œaûrou‹ from % tØ%s", 
¤c
, 
d¡
);

202 
	`¢´štf
(
h—d”
, (h—d”), "Œaûrou‹Ø%s", 
d¡
);

205  
	`¡rdup
(
h—d”
);

206 
	}
}

214 *
	$hİ_to¡r
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
, cÚ¡ 
h
)

216 
sÿm³r_Œaû_hİ_t
 *
hİ
;

217 *
¡r
 = 
NULL
;

218 **
¡r_addrs
 = 
NULL
;

219 
size_t
 *
Ën_addrs
 = 
NULL
;

220 **
¡r_¹ts
 = 
NULL
;

221 
size_t
 *
Ën_¹ts
 = 
NULL
;

222 
size_t
 
Ën
;

223 
i
;

224 
¡r_hİ
[128];

225 
¡r_addr
[64];

226 
¡r_¹t
[24];

227 
¡r_icmp
[24];

228 
¥¬e
;

229 
»¶yc
;

232 if(
Œaû
->
hİs
[
h
] =ğ
NULL
)

234 if((
Œaû
->
æags
 & 
SCAMPER_TRACE_FLAG_ALLATTEMPTS
) == 0)

236 
	`¢´štf
(
¡r_hİ
, (¡r_hİ), "%2d *", 
h
+1);

237 
¡r
 = 
	`¡rdup
(
¡r_hİ
);

239 if((
¡r
 = 
	`m®loc
((
Ën
 = 4 + (2 * 
Œaû
->
©‹m±s
)))è!ğ
NULL
)

241 
	`¢´štf
(
¡r
, 
Ën
, "%2d ", 
h
+1);

242 
i
=0; i<
Œaû
->
©‹m±s
; i++)

244 
¡r
[4+(
i
*2)] = '*';

245 
¡r
[4+(
i
*2)+1] = ' ';

247 
¡r
[4+((
i
-1)*2)+1] = '\0';

250  
¡r
;

253 
»¶yc
 = 0;

254 
hİ
=
Œaû
->
hİs
[
h
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

255 
»¶yc
++;

257 if(
»¶yc
 == 1)

259 
hİ
 = 
Œaû
->
hİs
[
h
];

260 
	`sÿm³r_addr_to¡r
(
hİ
->
hİ_addr
, 
¡r_addr
, (str_addr));

261 
	`timev®_to¡r
(&
hİ
->
hİ_¹t
, 
¡r_¹t
, (str_rtt));

262 
	`icmp_to¡r
(
hİ
, 
¡r_icmp
, (str_icmp));

264 
	`¢´štf
(
¡r_hİ
, (str_hop),

265 "%2d %  % ms%s", 
h
+1, 
¡r_addr
, 
¡r_¹t
, 
¡r_icmp
);

266  
	`¡rdup
(
¡r_hİ
);

270 
Ën
 = (*è* 
»¶yc
;

271 if((
¡r_addrs
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

272 
out
;

273 if((
¡r_¹ts
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

274 
out
;

277 
Ën
 = (
size_t
è* 
»¶yc
;

278 if((
Ën_addrs
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

279 
out
;

280 if((
Ën_¹ts
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

281 
out
;

284 
i
 = 0;

285 
hİ
 = 
Œaû
->
hİs
[
h
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

291 
	`addr_¡r
(
hİ
->
hİ_addr
, 
¡r_addr
, (str_addr));

292 
Ën
 = 
	`¡¾’
(
¡r_addr
);

293 if((
¡r_addrs
[
i
] = 
	`m®loc
(
Ën
+1)è=ğ
NULL
)

294 
out
;

295 
	`memıy
(
¡r_addrs
[
i
], 
¡r_addr
, 
Ën
+1);

296 
Ën_addrs
[
i
] = 
Ën
;

302 
	`timev®_to¡r
(&
hİ
->
hİ_¹t
, 
¡r_¹t
, (str_rtt));

303 
	`icmp_to¡r
(
hİ
, 
¡r_icmp
, (str_icmp));

304 
Ën
 = 
	`¡¾’
(
¡r_¹t
è+ 3 + sŒËn(
¡r_icmp
);

305 if((
¡r_¹ts
[
i
] = 
	`m®loc
(
Ën
+1)è=ğ
NULL
)

306 
out
;

307 
	`¢´štf
(
¡r_¹ts
[
i
],
Ën
+1,"% ms%s",
¡r_¹t
,
¡r_icmp
);

308 
Ën_¹ts
[
i
] = 
Ën
;

310 
i
++;

318 
Ën
 = 5; 
¥¬e
 = -1;

319 
i
=0; i<
»¶yc
; i++)

322 if(
¡r_addrs
[
i
] =ğ
NULL
)

324 
Ën
 += 2;

331 if(
¥¬e
 !ğ-1 && 
	`¡rcmp
(
¡r_addrs
[¥¬e], sŒ_addrs[
i
]) == 0)

333 
Ën
 +ğ
Ën_¹ts
[
i
] + 2;

338 
¥¬e
 = 
i
;

339 
Ën
 +ğ
Ën_addrs
[
i
] + 2 + 
Ën_¹ts
[i] + 2;

344 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

345 
out
;

348 
	`¢´štf
(
¡r
, 
Ën
, "%2d ", 
h
+1);

349 
Ën
 = 
	`¡¾’
(
¡r
); 
¥¬e
 = -1;

350 
i
=0; i<
»¶yc
; i++)

352 if(
¡r_addrs
[
i
] =ğ
NULL
)

354 
¡r
[
Ën
++] = '*'; str[len++] = ' ';

356 if(
¥¬e
 !ğ-1 && 
	`¡rcmp
(
¡r_addrs
[¥¬e], sŒ_addrs[
i
]) == 0)

358 
	`memıy
(
¡r
+
Ën
, 
¡r_¹ts
[
i
], 
Ën_¹ts
[i]);

359 
Ën
 +ğ
Ën_¹ts
[
i
];

360 
¡r
[
Ën
++] = ' '; str[len++] = ' ';

364 
¥¬e
 = 
i
;

365 
	`memıy
(
¡r
+
Ën
, 
¡r_addrs
[
i
], 
Ën_addrs
[i]);

366 
Ën
 +ğ
Ën_addrs
[
i
];

367 
¡r
[
Ën
++] = ' '; str[len++] = ' ';

368 
	`memıy
(
¡r
+
Ën
, 
¡r_¹ts
[
i
], 
Ën_¹ts
[i]);

369 
Ën
 +ğ
Ën_¹ts
[
i
];

370 
¡r
[
Ën
++] = ' '; str[len++] = ' ';

375 
¡r
[
Ën
-1] == ' ')†en--;

376 
¡r
[
Ën
] = '\0';

378 
out
:

381 if(
¡r_addrs
 !ğ
NULL
)

383 
i
=0; i<
»¶yc
; i++)

384 if(
¡r_addrs
[
i
] !ğ
NULL
)

385 
	`ä“
(
¡r_addrs
[
i
]);

386 
	`ä“
(
¡r_addrs
);

388 if(
¡r_¹ts
 !ğ
NULL
)

390 
i
=0; i<
»¶yc
; i++)

391 if(
¡r_¹ts
[
i
] !ğ
NULL
)

392 
	`ä“
(
¡r_¹ts
[
i
]);

393 
	`ä“
(
¡r_¹ts
);

395 if(
Ën_addrs
 !ğ
NULL
è
	`ä“
(len_addrs);

396 if(
Ën_¹ts
 !ğ
NULL
è
	`ä“
(len_rtts);

398  
¡r
;

399 
	}
}

401 *
	$mtu_to¡r
(cÚ¡ 
mtu
, cÚ¡ 
size
)

403 
¡r
[24];

404 if(
mtu
 !ğ
size
)

405 
	`¢´štf
(
¡r
, (¡r), " [*mtu: %d]", 
size
);

407 
	`¢´štf
(
¡r
, (¡r), " [mtu: %d]", 
mtu
);

408  
	`¡rdup
(
¡r
);

409 
	}
}

411 
	$pmtud_v”1
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
, **
mtus
)

413 
sÿm³r_Œaû_hİ_t
 *
hİ
;

414 
ušt16_t
 
mtu
, 
size
;

415 
i
;

421 if((
hİ
 = 
Œaû
->
pmtud
->
hİs
è=ğ
NULL
)

423 
mtu
 = 
size
 = 
Œaû
->
pmtud
->
pmtu
;

427 
mtu
 = 
size
 = 
Œaû
->
pmtud
->
ifmtu
;

428 if(
Œaû
->
pmtud
->
outmtu
 != 0)

429 
size
 = 
Œaû
->
pmtud
->
outmtu
;

432 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

435 if(
Œaû
->
hİs
[
i
] =ğ
NULL
)

437 if(
mtus
[
i
] !ğ
NULL
)

438 
	`ä“
(
mtus
[
i
]);

439 
mtus
[
i
] = 
NULL
;

444 if(
hİ
 =ğ
NULL
)

452 if(
	`sÿm³r_addr_cmp
(
hİ
->
hİ_addr
, 
Œaû
->
hİs
[
i
]->hop_addr) == 0)

454 if((
mtus
[
i
] = 
	`mtu_to¡r
(
mtu
, 
size
)è=ğ
NULL
)

457 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
))

458 
mtu
 = 
hİ
->
hİ_icmp_nhmtu
;

460 
hİ
 = hİ->
hİ_Ãxt
;

461 if(
hİ
 =ğ
NULL
)

462 
size
 = 
Œaû
->
pmtud
->
pmtu
;

464 
size
 = 
hİ
->
hİ_´obe_size
;

474 if(
i
 >ğ
hİ
->
hİ_´obe_‰l
 - hİ->
hİ_icmp_q_‰l
)

476 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
))

477 
size
 = 
mtu
 = 
hİ
->
hİ_icmp_nhmtu
;

479 if((
mtus
[
i
] = 
	`mtu_to¡r
(
mtu
, 
size
)è=ğ
NULL
)

482 
hİ
 = hİ->
hİ_Ãxt
;

483 if(
hİ
 =ğ
NULL
)

484 
size
 = 
Œaû
->
pmtud
->
pmtu
;

486 
size
 = 
hİ
->
hİ_´obe_size
;

491 if((
mtus
[
i
] = 
	`mtu_to¡r
(
mtu
, 
size
)è=ğ
NULL
)

496 
	}
}

498 
	$pmtud_v”2
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
, **
mtus
)

500 cÚ¡ 
sÿm³r_Œaû_pmtud_t
 *
pmtud
 = 
Œaû
->pmtud;

501 cÚ¡ 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
;

502 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
;

503 cÚ¡ 
sÿm³r_addr_t
 *
ha
;

504 
buf
[256], 
addr
[128];

505 
size_t
 
off
;

506 
ušt16_t
 
mtu
, 
size
;

507 
ušt8_t
 
n
 = 0;

508 
ušt8_t
 
h
 = 0;

509 
i
;

511 
mtu
 = 
size
 = 
pmtud
->
ifmtu
;

513 if(
pmtud
->
outmtu
 != 0)

516 
	`as£¹
(
pmtud
->
nÙec
 > 0);

517 
	`as£¹
(
pmtud
->
nÙes
[0]->
hİ
 =ğ
NULL
);

518 
	`as£¹
(
pmtud
->
nÙes
[0]->
ty³
 =ğ
SCAMPER_TRACE_PMTUD_N_TYPE_SILENCE
);

519 
size
 = 
pmtud
->
outmtu
;

520 
n
++;

523 if(
n
 =ğ
pmtud
->
nÙec
)

525 
h
=0; h<
Œaû
->
hİ_couÁ
; h++)

526 if(
Œaû
->
hİs
[
h
] !ğ
NULL
 && (
mtus
[h] = 
	`mtu_to¡r
(
mtu
,
size
)) == NULL)

532 
n
 < 
pmtud
->
nÙec
)

534 
nÙe
 = 
pmtud
->
nÙes
[
n
];‚++;

535 if((
hİ
 = 
nÙe
->hİè=ğ
NULL
)

537 
size
 = 
nÙe
->
nhmtu
;

541 if(
nÙe
->
ty³
 =ğ
SCAMPER_TRACE_PMTUD_N_TYPE_SILENCE
)

543 
i
 = 
hİ
->
hİ_´obe_‰l
 - 1;

547 
ha
 = 
hİ
->
hİ_addr
;

549 
i
=
h
; i<
Œaû
->
hİ_couÁ
; i++)

551 if(
Œaû
->
hİs
[
i
] =ğ
NULL
)

553 if(
	`sÿm³r_addr_cmp
(
Œaû
->
hİs
[
i
]->
hİ_addr
, 
ha
) == 0)

558 if(
i
 =ğ
Œaû
->
hİ_couÁ
)

560 
i
 = 
hİ
->
hİ_´obe_‰l
 - hİ->
hİ_icmp_q_‰l
;

566 if(
Œaû
->
hİs
[
i
] !ğ
NULL
 &&

567 ((
ha
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 &&

568 
	`sÿm³r_addr_´efix
(
Œaû
->
hİs
[
i
]->
hİ_addr
,
ha
) >= 30) ||

569 (
ha
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 &&

570 
	`sÿm³r_addr_´efix
(
Œaû
->
hİs
[
i
]->
hİ_addr
,
ha
) >= 126)))

571 
i
--;

574 if(
i
 >ğ(
Œaû
->
hİ_couÁ
-1))

575 
i
 = 
Œaû
->
hİ_couÁ
-2;

576 if(
i
 < 0)

577 
i
 = 0;

581 
h
 <ğ
i
)

583 if(
Œaû
->
hİs
[
h
] !ğ
NULL
 && (
mtus
[h] = 
	`mtu_to¡r
(
mtu
,
size
)) == NULL)

585 
h
++;

588 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
))

590 if(
Œaû
->
hİs
[
i
] =ğ
NULL
 && (
mtus
[i] = 
	`mtu_to¡r
(
mtu
,
size
)) == NULL)

593 if(
Œaû
->
hİs
[
i
] =ğ
NULL
 ||

594 
	`sÿm³r_addr_cmp
(
Œaû
->
hİs
[
i
]->
hİ_addr
, 
hİ
->hop_addr) != 0)

595 
	`sÿm³r_addr_to¡r
(
hİ
->
hİ_addr
, 
addr
, (addr));

597 
addr
[0] = '\0';

599 if(
addr
[0] !ğ'\0' || 
nÙe
->
nhmtu
 !ğ
hİ
->
hİ_icmp_nhmtu
)

601 
off
 = 0;

602 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%s", 
mtus
[
i
]);

603 if(
addr
[0] != '\0')

604 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "…tb %s", 
addr
);

605 if(
nÙe
->
nhmtu
 !ğ
hİ
->
hİ_icmp_nhmtu
)

606 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "‚hmtu %d!",

607 
hİ
->
hİ_icmp_nhmtu
);

609 
	`ä“
(
mtus
[
i
]);

610 if((
mtus
[
i
] = 
	`¡rdup
(
buf
)è=ğ
NULL
)

614 
mtu
 = 
hİ
->
hİ_icmp_nhmtu
;

617 
size
 = 
nÙe
->
nhmtu
;

620 
h
 < 
Œaû
->
hİ_couÁ
)

622 if(
Œaû
->
hİs
[
h
] !ğ
NULL
 && (
mtus
[h] = 
	`mtu_to¡r
(
mtu
,
size
)) == NULL)

624 
h
++;

628 
	}
}

635 
	$sÿm³r_fe_‹xt_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

636 cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

638 (*cÚ¡ 
pmtud_to¡r
[])(cÚ¡ 
sÿm³r_Œaû_t
 *, **) = {

639 
NULL
,

640 
pmtud_v”1
,

641 
pmtud_v”2
,

645 
rc
 = -1;

648 
i
;

649 
size_t
 
off
, 
Ën
;

650 *
¡r
 = 
NULL
;

651 *
h—d”
 = 
NULL
;

652 **
hİs
 = 
NULL
;

653 **
mtus
 = 
NULL
;

656 
off_t
 
foff
 = 0;

657 
fd
;

658 
size_t
 
wc
;

664 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

665 if(
fd
 !ğ
STDOUT_FILENO
 && (
foff
 = 
	`l£ek
(fd, 0, 
SEEK_CUR
)) == -1)

666 
ş—nup
;

668 if((
hİs
 = 
	`m®loc_z”o
((*è* 
Œaû
->
hİ_couÁ
)è=ğ
NULL
)

669 
ş—nup
;

672 
h—d”
 = 
	`h—d”_to¡r
(
Œaû
);

674 
Ën
 = 
	`¡¾’
(
h—d”
) + 2;

675 
i
=0; i < 
Œaû
->
hİ_couÁ
; i++)

677 if((
hİs
[
i
] = 
	`hİ_to¡r
(
Œaû
, i)è=ğ
NULL
)

678 
ş—nup
;

679 
Ën
 +ğ
	`¡¾’
(
hİs
[
i
]);

683 if(
Œaû
->
pmtud
 !ğ
NULL
 &&¿û->pmtud->
v”
 >= 1 &&race->pmtud->ver <= 2)

685 if((
mtus
 = 
	`m®loc_z”o
((*è* 
Œaû
->
hİ_couÁ
)è=ğ
NULL
)

686 
ş—nup
;

688 if(
pmtud_to¡r
[
Œaû
->
pmtud
->
v”
]Ñ¿û, 
mtus
) != 0)

689 
ş—nup
;

691 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

692 if(
mtus
[
i
] !ğ
NULL
)

693 
Ën
 +ğ
	`¡¾’
(
mtus
[
i
]);

696 
Ën
 +ğ
Œaû
->
hİ_couÁ
;

697 
Ën
 += 1;

699 if((
¡r
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

700 
ş—nup
;

702 
off
 = 0;

703 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "%s\n", 
h—d”
);

704 
i
=0; i < 
Œaû
->
hİ_couÁ
; i++)

706 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "%s", 
hİs
[
i
]);

707 if(
mtus
 !ğ
NULL
 && mtus[
i
] != NULL)

708 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "%s", 
mtus
[
i
]);

709 
	`¡ršg_cÚÿt
(
¡r
, 
Ën
, &
off
, "\n");

716 if(
	`wr™e_w¿p
(
fd
, 
¡r
, &
wc
, 
off
) != 0)

718 if(
fd
 !ğ
STDOUT_FILENO
)

720 if(
	`árunÿ‹
(
fd
, 
foff
) != 0)

721 
ş—nup
;

723 
ş—nup
;

726 
rc
 = 0;

728 
ş—nup
:

729 if(
hİs
 !ğ
NULL
)

731 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

732 if(
hİs
[
i
] !ğ
NULL
)

733 
	`ä“
(
hİs
[
i
]);

734 
	`ä“
(
hİs
);

736 if(
mtus
 !ğ
NULL
)

738 
i
=0; i<
Œaû
->
hİ_couÁ
; i++)

739 if(
mtus
[
i
] !ğ
NULL
)

740 
	`ä“
(
mtus
[
i
]);

741 
	`ä“
(
mtus
);

743 if(
h—d”
 !ğ
NULL
è
	`ä“
(header);

744 if(
¡r
 !ğ
NULL
è
	`ä“
(str);

746  
rc
;

747 
	}
}

	@trace/scamper_trace_text.h

24 #iâdeà
__SCAMPER_TRACE_TEXT_H


25 
	#__SCAMPER_TRACE_TEXT_H


	)

27 
sÿm³r_fe_‹xt_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

28 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

	@trace/scamper_trace_warts.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_icm³xt.h
"

38 
	~"sÿm³r_Œaû.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_fe_w¬ts.h
"

41 
	~"sÿm³r_Œaû_w¬ts.h
"

43 
	~"mjl_¥ÏyŒ“.h
"

44 
	~"uts.h
"

50 
	#WARTS_TRACE_ATTR_HDR
(
ty³
, 
Ën
è(Ñy³ << 12è|†’)

	)

51 
	#WARTS_TRACE_ATTR_HDR_TYPE
(
hdr
è((hd¸>> 12è& 0xf)

	)

52 
	#WARTS_TRACE_ATTR_HDR_LEN
(
hdr
è(hd¸& 0x0fff)

	)

53 
	#WARTS_TRACE_ATTR_EOF
 0x0000

	)

54 
	#WARTS_TRACE_ATTR_PMTUD
 0x1

	)

55 
	#WARTS_TRACE_ATTR_LASTDITCH
 0x2

	)

56 
	#WARTS_TRACE_ATTR_DTREE
 0x3

	)

61 
	#WARTS_TRACE_LIST_ID
 1

	)

62 
	#WARTS_TRACE_CYCLE_ID
 2

	)

63 
	#WARTS_TRACE_ADDR_SRC_GID
 3

	)

64 
	#WARTS_TRACE_ADDR_DST_GID
 4

	)

65 
	#WARTS_TRACE_START
 5

	)

66 
	#WARTS_TRACE_STOP_R
 6

	)

67 
	#WARTS_TRACE_STOP_D
 7

	)

68 
	#WARTS_TRACE_FLAGS
 8

	)

69 
	#WARTS_TRACE_ATTEMPTS
 9

	)

70 
	#WARTS_TRACE_HOPLIMIT
 10

	)

71 
	#WARTS_TRACE_TYPE
 11

	)

72 
	#WARTS_TRACE_PROBE_S
 12

	)

73 
	#WARTS_TRACE_PORT_SRC
 13

	)

74 
	#WARTS_TRACE_PORT_DST
 14

	)

75 
	#WARTS_TRACE_FIRSTHOP
 15

	)

76 
	#WARTS_TRACE_TOS
 16

	)

77 
	#WARTS_TRACE_WAIT
 17

	)

78 
	#WARTS_TRACE_LOOPS
 18

	)

79 
	#WARTS_TRACE_HOPCOUNT
 19

	)

80 
	#WARTS_TRACE_GAPLIMIT
 20

	)

81 
	#WARTS_TRACE_GAPACTION
 21

	)

82 
	#WARTS_TRACE_LOOPACTION
 22

	)

83 
	#WARTS_TRACE_PROBEC
 23

	)

84 
	#WARTS_TRACE_WAITPROBE
 24

	)

85 
	#WARTS_TRACE_CONFIDENCE
 25

	)

86 
	#WARTS_TRACE_ADDR_SRC
 26

	)

87 
	#WARTS_TRACE_ADDR_DST
 27

	)

88 
	#WARTS_TRACE_USERID
 28

	)

89 
	#WARTS_TRACE_OFFSET
 29

	)

91 cÚ¡ 
w¬ts_v¬_t
 
	gŒaû_v¬s
[] =

93 {
WARTS_TRACE_LIST_ID
, 4, -1},

94 {
WARTS_TRACE_CYCLE_ID
, 4, -1},

95 {
WARTS_TRACE_ADDR_SRC_GID
, 4, -1},

96 {
WARTS_TRACE_ADDR_DST_GID
, 4, -1},

97 {
WARTS_TRACE_START
, 8, -1},

98 {
WARTS_TRACE_STOP_R
, 1, -1},

99 {
WARTS_TRACE_STOP_D
, 1, -1},

100 {
WARTS_TRACE_FLAGS
, 1, -1},

101 {
WARTS_TRACE_ATTEMPTS
, 1, -1},

102 {
WARTS_TRACE_HOPLIMIT
, 1, -1},

103 {
WARTS_TRACE_TYPE
, 1, -1},

104 {
WARTS_TRACE_PROBE_S
, 2, -1},

105 {
WARTS_TRACE_PORT_SRC
, 2, -1},

106 {
WARTS_TRACE_PORT_DST
, 2, -1},

107 {
WARTS_TRACE_FIRSTHOP
, 1, -1},

108 {
WARTS_TRACE_TOS
, 1, -1},

109 {
WARTS_TRACE_WAIT
, 1, -1},

110 {
WARTS_TRACE_LOOPS
, 1, -1},

111 {
WARTS_TRACE_HOPCOUNT
, 2, -1},

112 {
WARTS_TRACE_GAPLIMIT
, 1, -1},

113 {
WARTS_TRACE_GAPACTION
, 1, -1},

114 {
WARTS_TRACE_LOOPACTION
, 1, -1},

115 {
WARTS_TRACE_PROBEC
, 2, -1},

116 {
WARTS_TRACE_WAITPROBE
, 1, -1},

117 {
WARTS_TRACE_CONFIDENCE
, 1, -1},

118 {
WARTS_TRACE_ADDR_SRC
, -1, -1},

119 {
WARTS_TRACE_ADDR_DST
, -1, -1},

120 {
WARTS_TRACE_USERID
, 4, -1},

121 {
WARTS_TRACE_OFFSET
, 2, -1},

123 
	#Œaû_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaû_v¬s
)

	)

128 
	#WARTS_TRACE_PMTUD_IFMTU
 1

	)

129 
	#WARTS_TRACE_PMTUD_PMTU
 2

	)

130 
	#WARTS_TRACE_PMTUD_OUTMTU
 3

	)

131 
	#WARTS_TRACE_PMTUD_VER
 4

	)

132 
	#WARTS_TRACE_PMTUD_NOTEC
 5

	)

133 cÚ¡ 
w¬ts_v¬_t
 
	gpmtud_v¬s
[] =

135 {
WARTS_TRACE_PMTUD_IFMTU
, 2, -1},

136 {
WARTS_TRACE_PMTUD_PMTU
, 2, -1},

137 {
WARTS_TRACE_PMTUD_OUTMTU
, 2, -1},

138 {
WARTS_TRACE_PMTUD_VER
, 1, -1},

139 {
WARTS_TRACE_PMTUD_NOTEC
, 1, -1},

141 
	#pmtud_v¬s_mfb
 
	`WARTS_VAR_MFB
(
pmtud_v¬s
)

	)

143 
	#WARTS_TRACE_PMTUD_N_TYPE
 1

	)

144 
	#WARTS_TRACE_PMTUD_N_NHMTU
 2

	)

145 
	#WARTS_TRACE_PMTUD_N_HOP
 3

	)

146 cÚ¡ 
w¬ts_v¬_t
 
	gpmtud_n_v¬s
[] =

148 {
WARTS_TRACE_PMTUD_N_TYPE
, 1, -1},

149 {
WARTS_TRACE_PMTUD_N_NHMTU
, 2, -1},

150 {
WARTS_TRACE_PMTUD_N_HOP
, 2, -1},

152 
	#pmtud_n_v¬s_mfb
 
	`WARTS_VAR_MFB
(
pmtud_n_v¬s
)

	)

157 
	#WARTS_TRACE_DTREE_LSS_STOP_GID
 1

	)

158 
	#WARTS_TRACE_DTREE_GSS_STOP_GID
 2

	)

159 
	#WARTS_TRACE_DTREE_FIRSTHOP
 3

	)

160 
	#WARTS_TRACE_DTREE_LSS_STOP
 4

	)

161 
	#WARTS_TRACE_DTREE_GSS_STOP
 5

	)

162 
	#WARTS_TRACE_DTREE_LSS_NAME
 6

	)

163 cÚ¡ 
w¬ts_v¬_t
 
	gŒaû_dŒ“_v¬s
[] =

165 {
WARTS_TRACE_DTREE_LSS_STOP_GID
, 4, -1},

166 {
WARTS_TRACE_DTREE_GSS_STOP_GID
, 4, -1},

167 {
WARTS_TRACE_DTREE_FIRSTHOP
, 1, -1},

168 {
WARTS_TRACE_DTREE_LSS_STOP
, -1, -1},

169 {
WARTS_TRACE_DTREE_GSS_STOP
, -1, -1},

170 {
WARTS_TRACE_DTREE_LSS_NAME
, -1, -1},

172 
	#Œaû_dŒ“_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaû_dŒ“_v¬s
)

	)

177 
	#WARTS_TRACE_HOP_ADDR_GID
 1

	)

178 
	#WARTS_TRACE_HOP_PROBE_TTL
 2

	)

179 
	#WARTS_TRACE_HOP_REPLY_TTL
 3

	)

180 
	#WARTS_TRACE_HOP_FLAGS
 4

	)

181 
	#WARTS_TRACE_HOP_PROBE_ID
 5

	)

182 
	#WARTS_TRACE_HOP_RTT
 6

	)

183 
	#WARTS_TRACE_HOP_ICMP_TC
 7

	)

184 
	#WARTS_TRACE_HOP_PROBE_SIZE
 8

	)

185 
	#WARTS_TRACE_HOP_REPLY_SIZE
 9

	)

186 
	#WARTS_TRACE_HOP_REPLY_IPID
 10

	)

187 
	#WARTS_TRACE_HOP_REPLY_IPTOS
 11

	)

188 
	#WARTS_TRACE_HOP_NHMTU
 12

	)

189 
	#WARTS_TRACE_HOP_Q_IPLEN
 13

	)

190 
	#WARTS_TRACE_HOP_Q_IPTTL
 14

	)

191 
	#WARTS_TRACE_HOP_TCP_FLAGS
 15

	)

192 
	#WARTS_TRACE_HOP_Q_IPTOS
 16

	)

193 
	#WARTS_TRACE_HOP_ICMPEXT
 17

	)

194 
	#WARTS_TRACE_HOP_ADDR
 18

	)

195 cÚ¡ 
w¬ts_v¬_t
 
	ghİ_v¬s
[] =

197 {
WARTS_TRACE_HOP_ADDR_GID
, 4, -1},

198 {
WARTS_TRACE_HOP_PROBE_TTL
, 1, -1},

199 {
WARTS_TRACE_HOP_REPLY_TTL
, 1, -1},

200 {
WARTS_TRACE_HOP_FLAGS
, 1, -1},

201 {
WARTS_TRACE_HOP_PROBE_ID
, 1, -1},

202 {
WARTS_TRACE_HOP_RTT
, 4, -1},

203 {
WARTS_TRACE_HOP_ICMP_TC
, 2, -1},

204 {
WARTS_TRACE_HOP_PROBE_SIZE
, 2, -1},

205 {
WARTS_TRACE_HOP_REPLY_SIZE
, 2, -1},

206 {
WARTS_TRACE_HOP_REPLY_IPID
, 2, -1},

207 {
WARTS_TRACE_HOP_REPLY_IPTOS
, 1, -1},

208 {
WARTS_TRACE_HOP_NHMTU
, 2, -1},

209 {
WARTS_TRACE_HOP_Q_IPLEN
, 2, -1},

210 {
WARTS_TRACE_HOP_Q_IPTTL
, 1, -1},

211 {
WARTS_TRACE_HOP_TCP_FLAGS
, 1, -1},

212 {
WARTS_TRACE_HOP_Q_IPTOS
, 1, -1},

213 {
WARTS_TRACE_HOP_ICMPEXT
, -1, -1},

214 {
WARTS_TRACE_HOP_ADDR
, -1, -1},

216 
	#hİ_v¬s_mfb
 
	`WARTS_VAR_MFB
(
hİ_v¬s
)

	)

218 
	sw¬ts_Œaû_hİ


220 
sÿm³r_Œaû_hİ_t
 *
	mhİ
;

221 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
hİ_v¬s
)];

222 
ušt16_t
 
	mæags_Ën
;

223 
ušt16_t
 
	m·¿ms_Ën
;

224 } 
	tw¬ts_Œaû_hİ_t
;

226 
	sw¬ts_Œaû_dŒ“


228 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaû_dŒ“_v¬s
)];

229 
ušt16_t
 
	mæags_Ën
;

230 
ušt16_t
 
	m·¿ms_Ën
;

231 
ušt32_t
 
	mËn
;

232 } 
	tw¬ts_Œaû_dŒ“_t
;

234 
	sw¬ts_Œaû_pmtud_n


236 
ušt8_t
 
	mæags
[
pmtud_n_v¬s_mfb
];

237 
ušt16_t
 
	mæags_Ën
;

238 
ušt16_t
 
	m·¿ms_Ën
;

239 
ušt16_t
 
	mhİ
;

240 } 
	tw¬ts_Œaû_pmtud_n_t
;

242 
	sw¬ts_Œaû_pmtud


244 
ušt8_t
 
	mæags
[
pmtud_v¬s_mfb
];

245 
ušt16_t
 
	mæags_Ën
;

246 
ušt16_t
 
	m·¿ms_Ën
;

247 
w¬ts_Œaû_hİ_t
 *
	mhİs
;

248 
ušt16_t
 
	mhİc
;

249 
w¬ts_Œaû_pmtud_n_t
 *
	mnÙes
;

250 
ušt32_t
 
	mËn
;

251 } 
	tw¬ts_Œaû_pmtud_t
;

253 
	$w¬ts_Œaû_·¿ms
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

254 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

255 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

257 
max_id
 = 0;

258 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

259 
size_t
 
i
;

262 
	`mem£t
(
æags
, 0, 
Œaû_v¬s_mfb
);

263 *
·¿ms_Ën
 = 0;

265 
i
=0; i<(
Œaû_v¬s
)/(
w¬ts_v¬_t
); i++)

267 
v¬
 = &
Œaû_v¬s
[
i
];

269 if(
v¬
->
id
 =ğ
WARTS_TRACE_ADDR_SRC_GID
 ||

270 
v¬
->
id
 =ğ
WARTS_TRACE_ADDR_DST_GID
)

275 if(
v¬
->
id
 =ğ
WARTS_TRACE_USERID
)

277 if(
Œaû
->
u£rid
 == 0)

281 if(
v¬
->
id
 =ğ
WARTS_TRACE_OFFSET
)

283 if(
Œaû
->
off£t
 == 0)

287 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

289 if(
v¬
->
id
 =ğ
WARTS_TRACE_ADDR_SRC
)

291 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaû
->
¤c
);

294 if(
v¬
->
id
 =ğ
WARTS_TRACE_ADDR_DST
)

296 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaû
->
d¡
);

300 
	`as£¹
(
v¬
->
size
 >= 0);

301 *
·¿ms_Ën
 +ğ
v¬
->
size
;

304 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

306 
	}
}

308 
	$w¬ts_Œaû_·¿ms_»ad
(
sÿm³r_Œaû_t
 *
Œaû
,
w¬ts_¡©e_t
 *
¡©e
,

309 
w¬ts_add¹abË_t
 *
bË
,

310 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

312 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

313 {&
Œaû
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

314 {&
Œaû
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

315 {&
Œaû
->
¤c
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

316 {&
Œaû
->
d¡
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

317 {&
Œaû
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

318 {&
Œaû
->
¡İ_»asÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

319 {&
Œaû
->
¡İ_d©a
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

320 {&
Œaû
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

321 {&
Œaû
->
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

322 {&
Œaû
->
hİlim™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

323 {&
Œaû
->
ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

324 {&
Œaû
->
´obe_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

325 {&
Œaû
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

326 {&
Œaû
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

327 {&
Œaû
->
fœ¡hİ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

328 {&
Œaû
->
tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

329 {&
Œaû
->
wa™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

330 {&
Œaû
->
loİs
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

331 {&
Œaû
->
hİ_couÁ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

332 {&
Œaû
->
g­lim™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

333 {&
Œaû
->
g­aùiÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

334 {&
Œaû
->
loİaùiÚ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

335 {&
Œaû
->
´obec
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

336 {&
Œaû
->
wa™_´obe
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

337 {&
Œaû
->
cÚfid’û
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

338 {&
Œaû
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

339 {&
Œaû
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

340 {&
Œaû
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

341 {&
Œaû
->
off£t
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

343 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

345  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

346 
	}
}

348 
	$w¬ts_Œaû_·¿ms_wr™e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

349 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

350 
w¬ts_add¹abË_t
 *
bË
,

351 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

352 cÚ¡ 
ušt32_t
 
Ën
,

353 cÚ¡ 
ušt8_t
 *
æags
,

354 cÚ¡ 
ušt16_t
 
æags_Ën
,

355 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

357 
ušt32_t
 
li¡_id
, 
cyşe_id
;

358 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

359 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

360 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

361 {
NULL
, NULL, NULL},

362 {
NULL
, NULL, NULL},

363 {&
Œaû
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

364 {&
Œaû
->
¡İ_»asÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

365 {&
Œaû
->
¡İ_d©a
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

366 {&
Œaû
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

367 {&
Œaû
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

368 {&
Œaû
->
hİlim™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

369 {&
Œaû
->
ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

370 {&
Œaû
->
´obe_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

371 {&
Œaû
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

372 {&
Œaû
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

373 {&
Œaû
->
fœ¡hİ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

374 {&
Œaû
->
tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

375 {&
Œaû
->
wa™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

376 {&
Œaû
->
loİs
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

377 {&
Œaû
->
hİ_couÁ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

378 {&
Œaû
->
g­lim™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

379 {&
Œaû
->
g­aùiÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

380 {&
Œaû
->
loİaùiÚ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

381 {&
Œaû
->
´obec
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

382 {&
Œaû
->
wa™_´obe
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

383 {&
Œaû
->
cÚfid’û
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

384 {
Œaû
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

385 {
Œaû
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

386 {&
Œaû
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

387 {&
Œaû
->
off£t
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

389 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

391 if(
	`w¬ts_li¡_g‘id
(
sf
, 
Œaû
->
li¡
, &
li¡_id
) == -1)  -1;

392 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
Œaû
->
cyşe
, &
cyşe_id
) == -1)  -1;

394 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

395 
hªdËr_út
);

397 
	}
}

399 
	$w¬ts_Œaû_hİ_»ad_icmp_tc
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

400 
ušt32_t
 
Ën
, 
sÿm³r_Œaû_hİ_t
 *
hİ
,

401 *
·¿m
)

403 if(
Ën
 - *
off
 < 2)

405 
hİ
->
hİ_icmp_ty³
 = 
buf
[(*
off
)++];

406 
hİ
->
hİ_icmp_code
 = 
buf
[(*
off
)++];

408 
	}
}

410 
	$w¬ts_Œaû_hİ_wr™e_icmp_tc
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

411 cÚ¡ 
ušt32_t
 
Ën
,

412 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
,

413 *
·¿m
)

415 
	`as£¹
(
Ën
 - *
off
 >= 2);

416 
buf
[(*
off
)++] = 
hİ
->
hİ_icmp_ty³
;

417 
buf
[(*
off
)++] = 
hİ
->
hİ_icmp_code
;

419 
	}
}

421 
	$w¬ts_Œaû_hİ_»ad_´obe_id
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

422 
ušt32_t
 
Ën
, 
ušt8_t
 *
out
,

423 *
·¿m
)

425 if(
Ën
 - *
off
 < 1)

429 *
out
 = 
buf
[(*
off
)++] + 1;

431 
	}
}

433 
	$w¬ts_Œaû_hİ_wr™e_´obe_id
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

434 cÚ¡ 
ušt32_t
 
Ën
,

435 cÚ¡ 
ušt8_t
 *
š
, *
·¿m
)

437 
	`as£¹
(
Ën
 - *
off
 >= 1);

438 
buf
[(*
off
)++] = *
š
 - 1;

440 
	}
}

442 
	$w¬ts_Œaû_hİ_»ad_icm³xt
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

443 
ušt32_t
 
Ën
, 
sÿm³r_Œaû_hİ_t
 *
hİ
,

444 *
·¿m
)

446  
	`w¬ts_icm³xt_»ad
(
buf
, 
off
, 
Ën
, &
hİ
->
hİ_icm³xt
);

447 
	}
}

449 
	$w¬ts_Œaû_hİ_wr™e_icm³xt
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

450 cÚ¡ 
ušt32_t
 
Ën
,

451 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
,

452 *
·¿m
)

454 
	`w¬ts_icm³xt_wr™e
(
buf
, 
off
, 
Ën
, 
hİ
->
hİ_icm³xt
);

456 
	}
}

458 
	$w¬ts_Œaû_hİ_·¿ms
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

459 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
,

460 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

461 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

463 
sÿm³r_icm³xt_t
 *
›
;

464 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

465 
i
, 
max_id
 = 0;

468 
	`mem£t
(
æags
, 0, 
hİ_v¬s_mfb
);

469 *
·¿ms_Ën
 = 0;

471 
i
=0; i<(
hİ_v¬s
)/(
w¬ts_v¬_t
); i++)

473 
v¬
 = &
hİ_v¬s
[
i
];

476 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ADDR_GID
)

479 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ADDR
)

481 if(
hİ
->
hİ_addr
 =ğ
NULL
)

484 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_TCP_FLAGS
)

486 if(
	`SCAMPER_TRACE_HOP_IS_TCP
(
hİ
) == 0)

489 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ICMP_TC
)

491 if(
	`SCAMPER_TRACE_HOP_IS_ICMP
(
hİ
) == 0)

494 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_Q_IPLEN
)

496 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
) == 0)

498 if(
hİ
->
hİ_icmp_q_l
 =ğ
Œaû
->
´obe_size
)

501 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_Q_IPTTL
)

503 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
) == 0)

505 if(
hİ
->
hİ_icmp_q_‰l
 == 1)

508 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_Q_IPTOS
)

510 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
) == 0)

512 if(
hİ
->
hİ_addr
->
ty³
 !ğ
SCAMPER_ADDR_TYPE_IPV4
)

515 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_NHMTU
)

517 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_PTB
(
hİ
) == 0)

520 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ICMPEXT
)

522 if(
hİ
->
hİ_icm³xt
 =ğ
NULL
)

525 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_REPLY_IPID
)

527 if(
hİ
->
hİ_»¶y_id
 == 0)

531 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

533 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ADDR
)

535 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
hİ
->
hİ_addr
);

537 if(
v¬
->
id
 =ğ
WARTS_TRACE_HOP_ICMPEXT
)

539 *
·¿ms_Ën
 += 2;

540 
›
 = 
hİ
->
hİ_icm³xt
; i!ğ
NULL
; iğ›->
›_Ãxt
)

541 *
·¿ms_Ën
 +ğ(2 + 1 + 1 + 
›
->
›_dl
);

545 
	`as£¹
(
v¬
->
size
 >= 0);

546 *
·¿ms_Ën
 +ğ
v¬
->
size
;

550 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

552 
	}
}

554 
	$w¬ts_Œaû_hİ_¡©e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

555 
sÿm³r_Œaû_hİ_t
 *
hİ
,

556 
w¬ts_Œaû_hİ_t
 *
¡©e
,

557 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

560 
	`w¬ts_Œaû_hİ_·¿ms
(
Œaû
, 
hİ
, 
bË
, 
¡©e
->
æags
, &¡©e->
æags_Ën
,

561 &
¡©e
->
·¿ms_Ën
);

564 
¡©e
->
hİ
 = hop;

567 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

568 if(
¡©e
->
·¿ms_Ën
 != 0)

569 *
Ën
 += 2;

572 
	}
}

574 
	$w¬ts_Œaû_hİ_»ad
(
sÿm³r_Œaû_hİ_t
 *
hİ
, 
w¬ts_¡©e_t
 *
¡©e
,

575 
w¬ts_add¹abË_t
 *
bË
,

576 cÚ¡ 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,ušt32_ˆ
Ën
)

578 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

579 {&
hİ
->
hİ_addr
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

580 {&
hİ
->
hİ_´obe_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

581 {&
hİ
->
hİ_»¶y_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

582 {&
hİ
->
hİ_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

583 {&
hİ
->
hİ_´obe_id
, (
w´_t
)
w¬ts_Œaû_hİ_»ad_´obe_id
, 
NULL
},

584 {&
hİ
->
hİ_¹t
, (
w´_t
)
exŒaù_¹t
, 
NULL
},

585 {
hİ
, (
w´_t
)
w¬ts_Œaû_hİ_»ad_icmp_tc
, 
NULL
},

586 {&
hİ
->
hİ_´obe_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

587 {&
hİ
->
hİ_»¶y_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

588 {&
hİ
->
hİ_»¶y_id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

589 {&
hİ
->
hİ_»¶y_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

590 {&
hİ
->
hİ_icmp_nhmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

591 {&
hİ
->
hİ_icmp_q_l
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

592 {&
hİ
->
hİ_icmp_q_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

593 {&
hİ
->
hİ_tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

594 {&
hİ
->
hİ_icmp_q_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

595 {
hİ
, (
w´_t
)
w¬ts_Œaû_hİ_»ad_icm³xt
, 
NULL
},

596 {&
hİ
->
hİ_addr
, (
w´_t
)
exŒaù_addr
, 
bË
},

598 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

599 
ušt32_t
 
o
 = *
off
;

600 
rc
;

602 if((
rc
 = 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
)) != 0)

603  
rc
;

605 if(
	`SCAMPER_TRACE_HOP_IS_ICMP_Q
(
hİ
))

607 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_TRACE_HOP_Q_IPTTL
) == 0)

608 
hİ
->
hİ_icmp_q_‰l
 = 1;

609 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_TRACE_HOP_Q_IPLEN
) == 0)

610 
hİ
->
hİ_icmp_q_l
 = hİ->
hİ_´obe_size
;

614 
	}
}

616 
	$w¬ts_Œaû_hİ_wr™e
(cÚ¡ 
w¬ts_Œaû_hİ_t
 *
¡©e
,

617 
w¬ts_add¹abË_t
 *
bË
,

618 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

620 
sÿm³r_Œaû_hİ_t
 *
hİ
 = 
¡©e
->hop;

621 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

622 {
NULL
, NULL, NULL},

623 {&
hİ
->
hİ_´obe_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

624 {&
hİ
->
hİ_»¶y_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

625 {&
hİ
->
hİ_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

626 {&
hİ
->
hİ_´obe_id
, (
wpw_t
)
w¬ts_Œaû_hİ_wr™e_´obe_id
, 
NULL
},

627 {&
hİ
->
hİ_¹t
, (
wpw_t
)
š£¹_¹t
, 
NULL
},

628 {
hİ
, (
wpw_t
)
w¬ts_Œaû_hİ_wr™e_icmp_tc
, 
NULL
},

629 {&
hİ
->
hİ_´obe_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

630 {&
hİ
->
hİ_»¶y_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

631 {&
hİ
->
hİ_»¶y_id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

632 {&
hİ
->
hİ_»¶y_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

633 {&
hİ
->
hİ_icmp_nhmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

634 {&
hİ
->
hİ_icmp_q_l
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

635 {&
hİ
->
hİ_icmp_q_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

636 {&
hİ
->
hİ_tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

637 {&
hİ
->
hİ_icmp_q_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

638 {
hİ
, (
wpw_t
)
w¬ts_Œaû_hİ_wr™e_icm³xt
, 
NULL
},

639 {
hİ
->
hİ_addr
, (
wpw_t
)
š£¹_addr
, 
bË
},

641 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

642 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

643 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

645 
	}
}

647 
	$w¬ts_Œaû_hİs_»ad
(
sÿm³r_Œaû_hİ_t
 **
hİs
,

648 
w¬ts_¡©e_t
 *
¡©e
,

649 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

650 
ušt32_t
 *
off
, ušt32_ˆ
Ën
, 
ušt16_t
 
couÁ
)

652 
sÿm³r_Œaû_hİ_t
 *
h—d
 = 
NULL
, *
hİ
 = NULL;

653 
ušt16_t
 
i
;

655 
i
=0; i<
couÁ
; i++)

661 if(
hİ
 !ğ
NULL
)

663 
hİ
->
hİ_Ãxt
 = 
	`sÿm³r_Œaû_hİ_®loc
();

664 
hİ
 = hİ->
hİ_Ãxt
;

668 
h—d
 = 
hİ
 = 
	`sÿm³r_Œaû_hİ_®loc
();

672 if(
hİ
 =ğ
NULL
)

673 
”r
;

675 if(
	`w¬ts_Œaû_hİ_»ad
(
hİ
, 
¡©e
, 
bË
, 
buf
, 
off
, 
Ën
) != 0)

676 
”r
;

679 *
hİs
 = 
h—d
;

682 
”r
:

683 
h—d
 !ğ
NULL
)

685 
hİ
 = 
h—d
;

686 
h—d
 = h—d->
hİ_Ãxt
;

687 
	`sÿm³r_Œaû_hİ_ä“
(
hİ
);

690 
	}
}

692 
	$w¬ts_Œaû_pmtud_n_·¿ms
(cÚ¡ 
sÿm³r_Œaû_pmtud_t
 *
pmtud
,

693 cÚ¡ 
sÿm³r_Œaû_pmtud_n_t
 *
n
,

694 
w¬ts_Œaû_pmtud_n_t
 *
¡©e
)

696 cÚ¡ 
sÿm³r_Œaû_hİ_t
 *
hİ
;

697 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

698 
ušt16_t
 
u16
;

699 
i
, 
max_id
 = 0;

701 
	`mem£t
(
¡©e
->
æags
, 0, 
pmtud_n_v¬s_mfb
);

702 
¡©e
->
·¿ms_Ën
 = 0;

704 
i
=0; i<(
pmtud_n_v¬s
)/(
w¬ts_v¬_t
); i++)

706 
v¬
 = &
pmtud_n_v¬s
[
i
];

707 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_N_TYPE
)

709 if(
n
->
ty³
 == 0)

712 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_N_NHMTU
)

714 if(
n
->
nhmtu
 == 0)

717 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_N_HOP
)

719 if(
n
->
hİ
 =ğ
NULL
)

722 
u16
 = 0;

723 
hİ
 = 
pmtud
->
hİs
; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

725 if(
hİ
 =ğ
n
->hop)

727 
u16
++;

729 
	`as£¹
(
hİ
 !ğ
NULL
);

730 
¡©e
->
hİ
 = 
u16
;

733 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

734 
	`as£¹
(
v¬
->
size
 >= 0);

735 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

738 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

740 
	}
}

742 
	$w¬ts_Œaû_pmtud_n_wr™e
(cÚ¡ 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
,

743 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

744 
w¬ts_Œaû_pmtud_n_t
 *
¡©e
)

746 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

747 {&
nÙe
->
ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

748 {&
nÙe
->
nhmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

749 {&
¡©e
->
hİ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

751 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

752 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

753 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

755 
	}
}

757 
	$w¬ts_Œaû_pmtud_n_»ad
(cÚ¡ 
sÿm³r_Œaû_pmtud_t
 *
pmtud
,

758 
sÿm³r_Œaû_pmtud_n_t
 *
nÙe
,

759 cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

760 
ušt32_t
 
Ën
)

762 
sÿm³r_Œaû_hİ_t
 *
hİ
;

763 
ušt16_t
 
u16
 = 0;

764 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

765 {&
nÙe
->
ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

766 {&
nÙe
->
nhmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

767 {&
u16
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

769 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

770 
ušt32_t
 
o
 = *
off
;

772 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

775 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_TRACE_PMTUD_N_HOP
))

777 
hİ
 = 
pmtud
->
hİs
;

778 
u16
 > 0)

780 if(
hİ
 =ğ
NULL
)

782 
hİ
 = hİ->
hİ_Ãxt
;

783 
u16
--;

785 if(
hİ
 =ğ
NULL
)

787 
nÙe
->
hİ
 = hop;

791 
	}
}

793 
	$w¬ts_Œaû_pmtud_·¿ms
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

794 
w¬ts_Œaû_pmtud_t
 *
¡©e
)

796 cÚ¡ 
sÿm³r_Œaû_pmtud_t
 *
pmtud
 = 
Œaû
->pmtud;

797 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

798 
i
, 
max_id
 = 0;

801 
	`mem£t
(
¡©e
->
æags
, 0, 
pmtud_v¬s_mfb
);

802 
¡©e
->
·¿ms_Ën
 = 0;

804 
i
=0; i<(
pmtud_v¬s
)/(
w¬ts_v¬_t
); i++)

806 
v¬
 = &
pmtud_v¬s
[
i
];

807 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_IFMTU
)

809 if(
pmtud
->
ifmtu
 == 0)

812 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_PMTU
)

814 if(
pmtud
->
pmtu
 == 0)

817 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_OUTMTU
)

819 if(
pmtud
->
outmtu
 == 0)

822 if(
v¬
->
id
 =ğ
WARTS_TRACE_PMTUD_NOTEC
)

824 if(
pmtud
->
nÙec
 == 0)

828 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

829 
	`as£¹
(
v¬
->
size
 >= 0);

830 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

833 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

835 
	}
}

837 
	$w¬ts_Œaû_pmtud_¡©e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

838 
w¬ts_Œaû_pmtud_t
 *
¡©e
,

839 
w¬ts_add¹abË_t
 *
bË
)

841 
w¬ts_Œaû_pmtud_n_t
 *
nÙe
;

842 
sÿm³r_Œaû_hİ_t
 *
hİ
;

843 
ušt8_t
 
i
;

844 
size_t
 
size
;

845 
j
;

848 
	`w¬ts_Œaû_pmtud_·¿ms
(
Œaû
, 
¡©e
);

851 
¡©e
->
Ën
 = s‹->
æags_Ën
 + s‹->
·¿ms_Ën
 + 2;

852 if(
¡©e
->
·¿ms_Ën
 != 0)

853 
¡©e
->
Ën
 += 2;

856 
¡©e
->
hİc
 = 
	`sÿm³r_Œaû_pmtud_hİ_couÁ
(
Œaû
);

857 if(
¡©e
->
hİc
 > 0)

860 
size
 = 
¡©e
->
hİc
 * (
w¬ts_Œaû_hİ_t
);

861 if((
¡©e
->
hİs
 = (
w¬ts_Œaû_hİ_t
 *)
	`m®loc
(
size
)è=ğ
NULL
)

865 
hİ
 = 
Œaû
->
pmtud
->
hİs
, 
j
=0; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

866 
	`w¬ts_Œaû_hİ_¡©e
(
Œaû
,
hİ
,&
¡©e
->
hİs
[
j
++],
bË
,&¡©e->
Ën
);

870 if(
Œaû
->
pmtud
->
nÙec
 > 0)

872 
size
 = 
Œaû
->
pmtud
->
nÙec
 * (
w¬ts_Œaû_pmtud_n_t
);

873 if((
¡©e
->
nÙes
 = (
w¬ts_Œaû_pmtud_n_t
 *)
	`m®loc
(
size
)è=ğ
NULL
)

875 
i
=0; i<
Œaû
->
pmtud
->
nÙec
; i++)

877 
nÙe
 = &
¡©e
->
nÙes
[
i
];

878 
	`w¬ts_Œaû_pmtud_n_·¿ms
(
Œaû
->
pmtud
,Œaû->pmtud->
nÙes
[
i
],
nÙe
);

881 
¡©e
->
Ën
 +ğ
nÙe
->
æags_Ën
 +‚Ùe->
·¿ms_Ën
;

882 if(
nÙe
->
·¿ms_Ën
 != 0)

883 
¡©e
->
Ën
 += 2;

888 
	}
}

890 
	$w¬ts_Œaû_pmtud_»ad
(
sÿm³r_Œaû_t
 *
Œaû
, 
w¬ts_¡©e_t
 *
¡©e
,

891 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

892 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

894 
ušt16_t
 
ifmtu
 = 0, 
pmtu
 = 0, 
outmtu
 = 0;

895 
ušt8_t
 
v”
 = 1, 
nÙec
 = 0;

896 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

897 {&
ifmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

898 {&
pmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

899 {&
outmtu
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

900 {&
v”
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

901 {&
nÙec
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

903 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

904 
sÿm³r_Œaû_pmtud_n_t
 *
n
 = 
NULL
;

905 
sÿm³r_Œaû_hİ_t
 *
hİs
;

906 
ušt16_t
 
couÁ
;

907 
ušt8_t
 
u8
;

909 if(
	`sÿm³r_Œaû_pmtud_®loc
(
Œaû
) != 0)

910 
”r
;

912 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

913 
”r
;

914 
Œaû
->
pmtud
->
ifmtu
 = ifmtu;

915 
Œaû
->
pmtud
->
pmtu
 =…mtu;

916 
Œaû
->
pmtud
->
outmtu
 = outmtu;

917 
Œaû
->
pmtud
->
v”
 = ver;

918 
Œaû
->
pmtud
->
nÙec
 =‚otec;

921 if(
	`exŒaù_ušt16
(
buf
, 
off
, 
Ën
, &
couÁ
, 
NULL
) != 0)

922 
”r
;

923 if(
couÁ
 != 0)

925 if(
	`w¬ts_Œaû_hİs_»ad
(&
hİs
,
¡©e
,
bË
,
buf
,
off
,
Ën
,
couÁ
) != 0)

926 
”r
;

927 
Œaû
->
pmtud
->
hİs
 = hops;

930 if(
Œaû
->
pmtud
->
nÙec
 != 0)

932 if(
	`sÿm³r_Œaû_pmtud_n_®loc_c
(
Œaû
->
pmtud
,¿û->pmtud->
nÙec
) != 0)

933 
”r
;

935 
u8
=0; u8<
Œaû
->
pmtud
->
nÙec
; u8++)

937 if((
n
 = 
	`sÿm³r_Œaû_pmtud_n_®loc
()è=ğ
NULL
)

938 
”r
;

939 if(
	`w¬ts_Œaû_pmtud_n_»ad
(
Œaû
->
pmtud
, 
n
, 
buf
, 
off
, 
Ën
) != 0)

940 
”r
;

941 
Œaû
->
pmtud
->
nÙes
[
u8
] = 
n
;‚ = 
NULL
;

947 
”r
:

948 if(
n
 !ğ
NULL
è
	`sÿm³r_Œaû_pmtud_n_ä“
(n);

950 
	}
}

952 
	$w¬ts_Œaû_pmtud_wr™e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

953 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

954 
w¬ts_Œaû_pmtud_t
 *
¡©e
,

955 
w¬ts_add¹abË_t
 *
bË
)

957 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

958 {&
Œaû
->
pmtud
->
ifmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

959 {&
Œaû
->
pmtud
->
pmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

960 {&
Œaû
->
pmtud
->
outmtu
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

961 {&
Œaû
->
pmtud
->
v”
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

962 {&
Œaû
->
pmtud
->
nÙec
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

964 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

965 
ušt16_t
 
u16
;

966 
ušt8_t
 
u8
;

968 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

969 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

972 
	`š£¹_ušt16
(
buf
, 
off
, 
Ën
, &
¡©e
->
hİc
, 
NULL
);

975 
u16
=0; u16<
¡©e
->
hİc
; u16++)

976 
	`w¬ts_Œaû_hİ_wr™e
(&
¡©e
->
hİs
[
u16
], 
bË
, 
buf
, 
off
, 
Ën
);

979 
u8
=0; u8<
Œaû
->
pmtud
->
nÙec
; u8++)

980 
	`w¬ts_Œaû_pmtud_n_wr™e
(
Œaû
->
pmtud
->
nÙes
[
u8
], 
buf
, 
off
, 
Ën
,

981 &
¡©e
->
nÙes
[
u8
]);

984 
	}
}

986 
	$w¬ts_Œaû_pmtud_ä“
(
w¬ts_Œaû_pmtud_t
 *
¡©e
)

988 if(
¡©e
 =ğ
NULL
)

990 if(
¡©e
->
hİs
 !ğ
NULL
è
	`ä“
(state->hops);

991 
	`ä“
(
¡©e
);

993 
	}
}

995 
	$w¬ts_Œaû_Ï¡d™ch_»ad
(
sÿm³r_Œaû_t
 *
Œaû
,

996 
w¬ts_¡©e_t
 *
¡©e
,

997 
w¬ts_add¹abË_t
 *
bË
,

998 cÚ¡ 
ušt8_t
 *
buf
,

999 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1001 
sÿm³r_Œaû_hİ_t
 *
hİs
;

1002 
ušt16_t
 
couÁ
;

1004 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
NULL
, 0) != 0)

1005 
”r
;

1007 if(
	`exŒaù_ušt16
(
buf
, 
off
, 
Ën
, &
couÁ
, 
NULL
) != 0)

1008 
”r
;

1010 if(
couÁ
 != 0)

1012 if(
	`w¬ts_Œaû_hİs_»ad
(&
hİs
,
¡©e
,
bË
,
buf
,
off
,
Ën
,
couÁ
) != 0)

1013 
”r
;

1014 
Œaû
->
Ï¡d™ch
 = 
hİs
;

1019 
”r
:

1021 
	}
}

1023 
	$w¬ts_Œaû_dŒ“_·¿ms
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1024 cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

1025 
w¬ts_add¹abË_t
 *
bË
,

1026 
w¬ts_Œaû_dŒ“_t
 *
¡©e
)

1028 
sÿm³r_Œaû_dŒ“_t
 *
dŒ“
 = 
Œaû
->dtree;

1029 
max_id
 = 0;

1032 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaû_dŒ“_v¬s_mfb
);

1033 
¡©e
->
·¿ms_Ën
 = 0;

1036 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_TRACE_DTREE_FIRSTHOP
, &
max_id
);

1037 
¡©e
->
·¿ms_Ën
 += 1;

1040 if(
dŒ“
->
lss_¡İ
 !ğ
NULL
)

1042 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_TRACE_DTREE_LSS_STOP
, &
max_id
);

1043 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
dŒ“
->
lss_¡İ
);

1046 if(
dŒ“
->
lss
 !ğ
NULL
)

1048 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_TRACE_DTREE_LSS_NAME
, &
max_id
);

1049 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_¡r_size
(
dŒ“
->
lss
);

1053 if(
dŒ“
->
gss_¡İ
 !ğ
NULL
)

1055 
	`æag_£t
(
¡©e
->
æags
, 
WARTS_TRACE_DTREE_GSS_STOP
, &
max_id
);

1056 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
dŒ“
->
gss_¡İ
);

1059 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

1061 
¡©e
->
Ën
 = s‹->
æags_Ën
 + s‹->
·¿ms_Ën
;

1062 if(
¡©e
->
·¿ms_Ën
 != 0)

1063 
¡©e
->
Ën
 += 2 ;

1066 
	}
}

1068 
	$w¬ts_Œaû_dŒ“_wr™e
(cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
,

1069 
w¬ts_add¹abË_t
 *
bË
,

1070 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
,

1071 
w¬ts_Œaû_dŒ“_t
 *
¡©e
)

1073 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

1074 {
NULL
, NULL, NULL},

1075 {
NULL
, NULL, NULL},

1076 {&
Œaû
->
dŒ“
->
fœ¡hİ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

1077 {
Œaû
->
dŒ“
->
lss_¡İ
, (
wpw_t
)
š£¹_addr
, 
bË
},

1078 {
Œaû
->
dŒ“
->
gss_¡İ
, (
wpw_t
)
š£¹_addr
, 
bË
},

1079 {
Œaû
->
dŒ“
->
lss
, (
wpw_t
)
š£¹_¡ršg
, 
NULL
},

1081 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

1083 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
,

1084 
¡©e
->
æags
, s‹->
æags_Ën
, s‹->
·¿ms_Ën
,

1085 
hªdËrs
, 
hªdËr_út
);

1087 
	}
}

1089 
	$w¬ts_Œaû_dŒ“_»ad
(
sÿm³r_Œaû_t
 *
Œaû
, 
w¬ts_¡©e_t
 *
¡©e
,

1090 
w¬ts_add¹abË_t
 *
bË
, cÚ¡ 
ušt8_t
 *
buf
,

1091 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

1093 
sÿm³r_addr_t
 *
lss_¡İ
 = 
NULL
, *
gss_¡İ
 = NULL;

1094 
ušt8_t
 
fœ¡hİ
 = 0;

1095 *
lss
 = 
NULL
;

1097 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

1098 {&
lss_¡İ
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

1099 {&
gss_¡İ
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

1100 {&
fœ¡hİ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

1101 {&
lss_¡İ
, (
w´_t
)
exŒaù_addr
, 
bË
},

1102 {&
gss_¡İ
, (
w´_t
)
exŒaù_addr
, 
bË
},

1103 {&
lss
, (
w´_t
)
exŒaù_¡ršg
, 
NULL
},

1105 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

1107 if(
	`sÿm³r_Œaû_dŒ“_®loc
(
Œaû
) != 0 ||

1108 
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

1110 if(
lss_¡İ
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(lss_stop);

1111 if(
gss_¡İ
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(gss_stop);

1112 if(
lss
 !ğ
NULL
è
	`ä“
(lss);

1116 
Œaû
->
dŒ“
->
lss_¡İ
 =†ss_stop;

1117 
Œaû
->
dŒ“
->
gss_¡İ
 = gss_stop;

1118 
Œaû
->
dŒ“
->
fœ¡hİ
 = firsthop;

1119 
Œaû
->
dŒ“
->
lss
 =†ss;

1121 
	}
}

1127 
	$sÿm³r_fe_w¬ts_Œaû_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1128 
sÿm³r_Œaû_t
 **
Œaû_out
)

1130 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1131 
sÿm³r_Œaû_t
 *
Œaû
 = 
NULL
;

1132 
ušt8_t
 *
buf
 = 
NULL
;

1133 
ušt32_t
 
i
, 
off
 = 0;

1134 
sÿm³r_Œaû_hİ_t
 *
hİs
 = 
NULL
;

1135 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1136 
ušt16_t
 
couÁ
;

1137 
ušt8_t
 
max_‰l
;

1138 
ušt8_t
 
ty³
;

1139 
ušt16_t
 
Ën
;

1140 
ušt16_t
 
u16
;

1141 
w¬ts_add¹abË_t
 
bË
;

1143 
	`mem£t
(&
bË
, 0, (table));

1145 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1147 
”r
;

1149 if(
buf
 =ğ
NULL
)

1151 *
Œaû_out
 = 
NULL
;

1155 if((
Œaû
 = 
	`sÿm³r_Œaû_®loc
()è=ğ
NULL
)

1157 
”r
;

1161 if(
	`w¬ts_Œaû_·¿ms_»ad
(
Œaû
, 
¡©e
, &
bË
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1163 
”r
;

1170 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
couÁ
, 
NULL
) != 0)

1172 
”r
;

1176 if(
	`w¬ts_Œaû_hİs_»ad
(&
hİs
,
¡©e
,&
bË
,
buf
,&
off
,
hdr
->
Ën
,
couÁ
) != 0)

1177 
”r
;

1180 
max_‰l
 = 0;

1181 
i
=0, 
hİ
 = 
hİs
; i < 
couÁ
; i++)

1183 if(
hİ
->
hİ_´obe_‰l
 > 
max_‰l
)

1184 
max_‰l
 = 
hİ
->
hİ_´obe_‰l
;

1185 
hİ
 = hİ->
hİ_Ãxt
;

1192 if(
Œaû
->
hİ_couÁ
 != 0)

1194 if(
Œaû
->
hİ_couÁ
 < 
max_‰l
)

1195 
”r
;

1199 
Œaû
->
hİ_couÁ
 = 
max_‰l
;

1203 if(
	`sÿm³r_Œaû_hİs_®loc
(
Œaû
,¿û->
hİ_couÁ
) == -1)

1205 
”r
;

1208 if(
hİs
 =ğ
NULL
)

1210 
	`as£¹
(
couÁ
 == 0);

1211 
dÚe
;

1218 
Œaû
->
hİs
[hİs->
hİ_´obe_‰l
-1] = 
hİ
 = hops;

1219 
hİ
->
hİ_Ãxt
 !ğ
NULL
)

1221 if(
hİ
->
hİ_´obe_‰l
 !ğhİ->
hİ_Ãxt
->hop_probe_ttl)

1223 
i
 = 
hİ
->
hİ_Ãxt
->
hİ_´obe_‰l
-1;

1224 
Œaû
->
hİs
[
i
] = 
hİ
->
hİ_Ãxt
;

1225 
hİ
->
hİ_Ãxt
 = 
NULL
;

1226 
hİ
 = 
Œaû
->
hİs
[
i
];

1228 
hİ
 = hİ->
hİ_Ãxt
;

1230 
hİs
 = 
NULL
;

1234 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
u16
, 
NULL
) != 0)

1235 
”r
;

1236 if(
u16
 =ğ
WARTS_TRACE_ATTR_EOF
)

1239 
ty³
 = 
	`WARTS_TRACE_ATTR_HDR_TYPE
(
u16
);

1240 
Ën
 = 
	`WARTS_TRACE_ATTR_HDR_LEN
(
u16
);

1242 if(
ty³
 =ğ
WARTS_TRACE_ATTR_PMTUD
)

1244 
i
 = 
off
;

1245 if(
	`w¬ts_Œaû_pmtud_»ad
(
Œaû
,
¡©e
,&
bË
,
buf
,&
i
,
hdr
->
Ën
) != 0)

1246 
”r
;

1248 if(
ty³
 =ğ
WARTS_TRACE_ATTR_LASTDITCH
)

1250 
i
 = 
off
;

1251 if(
	`w¬ts_Œaû_Ï¡d™ch_»ad
(
Œaû
, 
¡©e
, &
bË
,

1252 
buf
, &
i
, 
hdr
->
Ën
) != 0)

1253 
”r
;

1255 if(
ty³
 =ğ
WARTS_TRACE_ATTR_DTREE
)

1257 
i
 = 
off
;

1258 if(
	`w¬ts_Œaû_dŒ“_»ad
(
Œaû
,
¡©e
,&
bË
,
buf
,&
i
,
hdr
->
Ën
) != 0)

1259 
”r
;

1262 
off
 +ğ
Ën
;

1265 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

1267 
dÚe
:

1268 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1269 
	`ä“
(
buf
);

1270 *
Œaû_out
 = 
Œaû
;

1273 
”r
:

1274 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1275 if(
hİs
 !ğ
NULL
è
	`ä“
(hops);

1276 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1277 if(
Œaû
 !ğ
NULL
è
	`sÿm³r_Œaû_ä“
(trace);

1279 
	}
}

1281 
	$sÿm³r_fe_w¬ts_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1282 cÚ¡ 
sÿm³r_Œaû_t
 *
Œaû
)

1284 
sÿm³r_Œaû_hİ_t
 *
hİ
;

1285 
ušt8_t
 *
buf
 = 
NULL
;

1286 
ušt8_t
 
Œaû_æags
[
Œaû_v¬s_mfb
];

1287 
ušt16_t
 
Œaû_æags_Ën
, 
Œaû_·¿ms_Ën
;

1288 
w¬ts_Œaû_hİ_t
 *
hİ_¡©e
 = 
NULL
;

1289 
ušt16_t
 
hİ_»cs
;

1290 
w¬ts_Œaû_pmtud_t
 *
pmtud
 = 
NULL
;

1291 
w¬ts_Œaû_hİ_t
 *
ld_¡©e
 = 
NULL
;

1292 
ušt16_t
 
ld_»cs
 = 0;

1293 
ušt32_t
 
ld_Ën
 = 0;

1294 
w¬ts_Œaû_dŒ“_t
 
dŒ“_¡©e
;

1295 
ušt16_t
 
u16
;

1296 
ušt8_t
 
u8
;

1297 
ušt32_t
 
off
 = 0, 
Ën
, 
Ën2
;

1298 
size_t
 
size
;

1299 
i
, 
j
;

1300 
w¬ts_add¹abË_t
 
bË
;

1303 
	`mem£t
(&
bË
, 0, (table));

1304 
	`mem£t
(&
dŒ“_¡©e
, 0, (dtree_state));

1307 
	`w¬ts_Œaû_·¿ms
(
Œaû
, &
bË
,

1308 
Œaû_æags
, &
Œaû_æags_Ën
, &
Œaû_·¿ms_Ën
);

1314 
Ën
 = 8 + 
Œaû_æags_Ën
 + 
Œaû_·¿ms_Ën
 + 2;

1315 if(
Œaû_·¿ms_Ën
 !ğ0è
Ën
 += 2;

1318 if((
hİ_»cs
 = 
	`sÿm³r_Œaû_hİ_couÁ
(
Œaû
)) > 0)

1320 
size
 = 
hİ_»cs
 * (
w¬ts_Œaû_hİ_t
);

1321 if((
hİ_¡©e
 = (
w¬ts_Œaû_hİ_t
 *)
	`m®loc
(
size
)è=ğ
NULL
)

1323 
”r
;

1326 
i
=0, 
j
=0; i<
Œaû
->
hİ_couÁ
; i++)

1328 
hİ
 = 
Œaû
->
hİs
[
i
]; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

1331 
Ën2
 = 
Ën
;

1332 
	`w¬ts_Œaû_hİ_¡©e
(
Œaû
,
hİ
,&
hİ_¡©e
[
j
++],&
bË
,&
Ën2
);

1333 if(
Ën2
 < 
Ën
)

1334 
”r
;

1335 
Ën
 = 
Ën2
;

1341 if(
Œaû
->
pmtud
 !ğ
NULL
)

1343 if((
pmtud
 = 
	`m®loc_z”o
((
w¬ts_Œaû_pmtud_t
))è=ğ
NULL
)

1344 
”r
;

1346 if(
	`w¬ts_Œaû_pmtud_¡©e
(
Œaû
, 
pmtud
, &
bË
) != 0)

1347 
”r
;

1349 
Ën
 +ğ(2 + 
pmtud
->len);

1352 if(
Œaû
->
Ï¡d™ch
 !ğ
NULL
)

1355 
ld_»cs
 = 
	`sÿm³r_Œaû_Ï¡d™ch_hİ_couÁ
(
Œaû
);

1358 
size
 = 
ld_»cs
 * (
w¬ts_Œaû_hİ_t
);

1359 if((
ld_¡©e
 = (
w¬ts_Œaû_hİ_t
 *)
	`m®loc
(
size
)è=ğ
NULL
)

1360 
”r
;

1363 
ld_Ën
 = 3;

1366 
hİ
 = 
Œaû
->
Ï¡d™ch
, 
j
=0; hİ !ğ
NULL
; hİ = hİ->
hİ_Ãxt
)

1367 
	`w¬ts_Œaû_hİ_¡©e
(
Œaû
, 
hİ
, &
ld_¡©e
[
j
++], &
bË
, &
ld_Ën
);

1369 
Ën
 +ğ(2 + 
ld_Ën
);

1372 if(
Œaû
->
dŒ“
 !ğ
NULL
)

1375 if(
	`w¬ts_Œaû_dŒ“_·¿ms
(
sf
, 
Œaû
, &
bË
, &
dŒ“_¡©e
) != 0)

1376 
”r
;

1379 
Ën
 +ğ(2 + 
dŒ“_¡©e
.len);

1382 
Ën
 += 2;

1384 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1386 
”r
;

1389 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_TRACE
);

1392 if(
	`w¬ts_Œaû_·¿ms_wr™e
(
Œaû
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
, 
Œaû_æags
,

1393 
Œaû_æags_Ën
, 
Œaû_·¿ms_Ën
) == -1)

1395 
”r
;

1399 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
hİ_»cs
, 
NULL
);

1402 
i
=0; i<
hİ_»cs
; i++)

1403 
	`w¬ts_Œaû_hİ_wr™e
(&
hİ_¡©e
[
i
], &
bË
, 
buf
, &
off
, 
Ën
);

1404 if(
hİ_¡©e
 !ğ
NULL
)

1405 
	`ä“
(
hİ_¡©e
);

1406 
hİ_¡©e
 = 
NULL
;

1409 if(
pmtud
 !ğ
NULL
)

1412 
u16
 = 
	`WARTS_TRACE_ATTR_HDR
(
WARTS_TRACE_ATTR_PMTUD
, 
pmtud
->
Ën
);

1413 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
u16
, 
NULL
);

1416 
	`w¬ts_Œaû_pmtud_wr™e
(
Œaû
, 
buf
, &
off
, 
Ën
, 
pmtud
, &
bË
);

1418 
	`w¬ts_Œaû_pmtud_ä“
(
pmtud
);

1419 
pmtud
 = 
NULL
;

1423 if(
Œaû
->
Ï¡d™ch
 !ğ
NULL
)

1426 
u16
 = 
	`WARTS_TRACE_ATTR_HDR
(
WARTS_TRACE_ATTR_LASTDITCH
, 
ld_Ën
);

1427 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
u16
, 
NULL
);

1430 
u8
 = 0;

1431 
	`š£¹_by‹
(
buf
, &
off
, 
Ën
, &
u8
, 
NULL
);

1434 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
ld_»cs
, 
NULL
);

1436 
i
=0; i<
ld_»cs
; i++)

1437 
	`w¬ts_Œaû_hİ_wr™e
(&
ld_¡©e
[
i
], &
bË
, 
buf
, &
off
, 
Ën
);

1439 
	`ä“
(
ld_¡©e
);

1440 
ld_¡©e
 = 
NULL
;

1444 if(
Œaû
->
dŒ“
 !ğ
NULL
)

1446 
u16
 = 
	`WARTS_TRACE_ATTR_HDR
(
WARTS_TRACE_ATTR_DTREE
, 
dŒ“_¡©e
.
Ën
);

1447 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
u16
, 
NULL
);

1450 
	`w¬ts_Œaû_dŒ“_wr™e
(
Œaû
, &
bË
, 
buf
, &
off
, 
Ën
, &
dŒ“_¡©e
);

1454 
u16
 = 
WARTS_TRACE_ATTR_EOF
;

1455 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
u16
, 
NULL
);

1457 
	`as£¹
(
off
 =ğ
Ën
);

1459 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

1461 
”r
;

1464 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1465 
	`ä“
(
buf
);

1468 
”r
:

1469 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1470 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1471 if(
hİ_¡©e
 !ğ
NULL
è
	`ä“
(hop_state);

1472 if(
pmtud
 !ğ
NULL
è
	`w¬ts_Œaû_pmtud_ä“
(pmtud);

1473 if(
ld_¡©e
 !ğ
NULL
è
	`ä“
(ld_state);

1475 
	}
}

	@trace/scamper_trace_warts.h

25 #iâdeà
__SCAMPER_TRACE_WARTS_H


26 
	#__SCAMPER_TRACE_WARTS_H


	)

28 
sÿm³r_fe_w¬ts_Œaû_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

29 
sÿm³r_Œaû
 **
Œaû_out
);

31 
sÿm³r_fe_w¬ts_Œaû_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

32 cÚ¡ 
sÿm³r_Œaû
 *
Œaû
);

	@tracebox/scamper_tracebox.c

9 #iâdeà
lšt


10 cÚ¡ 
	grcsid
[] =

14 #ifdeà
HAVE_CONFIG_H


15 
	~"cÚfig.h
"

17 
	~"š‹º®.h
"

19 
	~"sÿm³r_addr.h
"

20 
	~"sÿm³r_li¡.h
"

21 
	~"sÿm³r_Œaûbox.h
"

22 
	~"uts.h
"

24 
	$sÿm³r_Œaûbox_pkt_Ën
(cÚ¡ 
sÿm³r_Œaûbox_pkt_t
 *
pkt
)

26 
ušt8_t
 
v
 = 
pkt
->
d©a
[0] >> 4;

27 
rc
 = -1;

29 if(
v
 == 4)

30 
rc
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

31 if(
v
 == 6)

32 
rc
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4) + 40;

34  
rc
;

35 
	}
}

37 
	$sÿm³r_Œaûbox_pkt_h
(cÚ¡ 
sÿm³r_Œaûbox_pkt_t
 *
pkt
,

38 
ušt8_t
 *
´Ùo
, ušt8_ˆ*
hËn
, 
ušt16_t
 *
Ën
)

40 
ušt8_t
 
v
 = 
pkt
->
d©a
[0] >> 4;

42 if(
v
 == 4)

44 *
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

45 *
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

46 *
´Ùo
 = 
pkt
->
d©a
[9];

50 if(
v
 == 6)

52 *
hËn
 = 40;

53 *
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4) + 40;

54 *
´Ùo
 = 
pkt
->
d©a
[6];

57 *
´Ùo
)

59 
IPPROTO_HOPOPTS
:

60 
IPPROTO_DSTOPTS
:

61 
IPPROTO_ROUTING
:

62 *
´Ùo
 = 
pkt
->
d©a
[*
hËn
];

63 *
hËn
 +ğ(
pkt
->
d©a
[(*iphlen)+1] * 8) + 8;

65 
IPPROTO_FRAGMENT
:

66 *
´Ùo
 = 
pkt
->
d©a
[*
hËn
];

67 if((
	`by‹s_Áohs
(
pkt
->
d©a
+(*
hËn
)+2) & 0xfff8) != 0)

69 if((
pkt
->
d©a
[(*
hËn
)+3] & 0x1) != 0)

71 *
hËn
 += 8;

80 
	}
}

82 *
	$sÿm³r_Œaûbox_ty³2¡r
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, *
buf
, 
size_t
 
Ën
)

84 *
t
[] = {

85 
NULL
,

92 if(
Œaûbox
->
ty³
 > (
t
è/ (*è||[Œaûbox->ty³] =ğ
NULL
)

94 
	`¢´štf
(
buf
, 
Ën
, "%d", 
Œaûbox
->
ty³
);

95  
buf
;

98  
t
[
Œaûbox
->
ty³
];

99 
	}
}

101 *
	$sÿm³r_Œaûbox_»s2¡r
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, *
buf
, 
size_t
 
Ën
)

103 *
t
[] = {

118 
NULL
,

119 
NULL
,

120 
NULL
,

121 
NULL
,

122 
NULL
,

123 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

140 
NULL
,

141 
NULL
,

142 
NULL
,

143 
NULL
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NULL
,

161 if(
Œaûbox
->
»suÉ
 > (
t
è/ (*è||[Œaûbox->»suÉ] =ğ
NULL
)

163 
	`¢´štf
(
buf
, 
Ën
, "%d", 
Œaûbox
->
»suÉ
);

164  
buf
;

167  
t
[
Œaûbox
->
»suÉ
];

168 
	}
}

170 
sÿm³r_Œaûbox_pkt_t
 *
	$sÿm³r_Œaûbox_pkt_®loc
(
ušt8_t
 
dœ
, ušt8_ˆ*
d©a
,

171 
ušt16_t
 
Ën
, 
timev®
 *
tv
)

173 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

175 if((
pkt
 = 
	`m®loc_z”o
((
sÿm³r_Œaûbox_pkt_t
))è=ğ
NULL
)

176 
”r
;

178 
pkt
->
dœ
 = dir;

179 if(
Ën
 !ğ0 && 
d©a
 !ğ
NULL
)

181 if((
pkt
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

182 
”r
;

183 
pkt
->
Ën
 =†en;

185 if(
tv
 !ğ
NULL
è
	`timev®_ıy
(&
pkt
->tv,v);

186  
pkt
;

188 
”r
:

189 
	`ä“
(
pkt
);

190  
NULL
;

191 
	}
}

193 
	$sÿm³r_Œaûbox_pkt_ä“
(
sÿm³r_Œaûbox_pkt_t
 *
pkt
)

195 if(
pkt
 =ğ
NULL
)

197 if(
pkt
->
d©a
 !ğ
NULL
è
	`ä“
(pkt->data);

198 
	`ä“
(
pkt
);

200 
	}
}

202 
	$sÿm³r_Œaûbox_pkts_®loc
(
sÿm³r_Œaûbox_t
 *
Œaûbox
, 
ušt32_t
 
couÁ
)

204 
size_t
 
size
 = 
couÁ
 * (
sÿm³r_Œaûbox_pkt_t
 *);

205 if((
Œaûbox
->
pkts
 = (
sÿm³r_Œaûbox_pkt_t
 **)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

208 
	}
}

210 
	$sÿm³r_Œaûbox_»cÜd_pkt
(
sÿm³r_Œaûbox_t
 *
Œaûbox
, 
sÿm³r_Œaûbox_pkt_t
 *
pkt
)

212 
size_t
 
Ën
 = (
Œaûbox
->
pktc
 + 1è* (
sÿm³r_Œaûbox_pkt_t
 *);

215 if(
	`»®loc_w¿p
((**)&
Œaûbox
->
pkts
, 
Ën
) != 0)

218 
Œaûbox
->
pkts
[Œaûbox->
pktc
++] = 
pkt
;

220 
	}
}

223 
	$sÿm³r_Œaûbox_ä“
(
sÿm³r_Œaûbox_t
 *
Œaûbox
)

225 
ušt32_t
 
i
;

227 if(
Œaûbox
 =ğ
NULL
)

230 if(
Œaûbox
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(tracebox->src);

231 if(
Œaûbox
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(tracebox->dst);

232 if(
Œaûbox
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(tracebox->list);

233 if(
Œaûbox
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(tracebox->cycle);

236 if(
Œaûbox
->
pkts
 !ğ
NULL
)

238 
i
=0; i<
Œaûbox
->
pktc
; i++)

239 
	`sÿm³r_Œaûbox_pkt_ä“
(
Œaûbox
->
pkts
[
i
]);

240 
	`ä“
(
Œaûbox
->
pkts
);

243 
	`ä“
(
Œaûbox
);

245 
	}
}

247 
sÿm³r_Œaûbox_t
 *
	$sÿm³r_Œaûbox_®loc
()

249  (
sÿm³r_Œaûbox_t
 *)
	`m®loc_z”o
((scamper_tracebox_t));

250 
	}
}

	@tracebox/scamper_tracebox.h

9 #iâdeà
__SCAMPER_TRACEBOX_H


10 
	#__SCAMPER_TRACEBOX_H


	)

12 
	#SCAMPER_TRACEBOX_APP_DEFAULT
 1

	)

15 
	#SCAMPER_TRACEBOX_RESULT_NONE
 0

	)

16 
	#SCAMPER_TRACEBOX_RESULT_TCP_NOCONN
 1

	)

17 
	#SCAMPER_TRACEBOX_RESULT_TCP_RST
 2

	)

18 
	#SCAMPER_TRACEBOX_RESULT_TCP_ERROR
 3

	)

19 
	#SCAMPER_TRACEBOX_RESULT_ERROR
 4

	)

20 
	#SCAMPER_TRACEBOX_RESULT_ABORTED
 5

	)

21 
	#SCAMPER_TRACEBOX_RESULT_DEST_UNREACHABLE
 6

	)

22 
	#SCAMPER_TRACEBOX_RESULT_HALTED
 7

	)

23 
	#SCAMPER_TRACEBOX_RESULT_TCP_BADOPT
 8

	)

24 
	#SCAMPER_TRACEBOX_RESULT_TCP_FIN
 9

	)

25 
	#SCAMPER_TRACEBOX_RESULT_ICMP_TTL_EXP
 11

	)

26 
	#SCAMPER_TRACEBOX_RESULT_SUCCESS
 12

	)

27 
	#SCAMPER_TRACEBOX_RESULT_TIMEOUT
 13

	)

30 
	#SCAMPER_TRACEBOX_PKT_DIR_TX
 1

	)

31 
	#SCAMPER_TRACEBOX_PKT_DIR_RX
 2

	)

34 
	#SCAMPER_TRACEBOX_ANSWER_EMPTY
 1

	)

35 
	#SCAMPER_TRACEBOX_ANSWER_ONLY_L3
 2

	)

36 
	#SCAMPER_TRACEBOX_ANSWER_8B
 3

	)

37 
	#SCAMPER_TRACEBOX_ANSWER_FULL
 4

	)

38 
	#SCAMPER_TRACEBOX_ANSWER_SYNACK
 5

	)

41 
	ssÿm³r_Œaûbox_pkt


43 
timev®
 
	mtv
;

44 
ušt8_t
 
	mdœ
;

45 
ušt16_t
 
	mËn
;

46 
ušt8_t
 *
	md©a
;

47 } 
	tsÿm³r_Œaûbox_pkt_t
;

55 
	ssÿm³r_Œaûbox


57 
sÿm³r_li¡_t
 *
	mli¡
;

58 
sÿm³r_cyşe_t
 *
	mcyşe
;

59 
ušt32_t
 
	mu£rid
;

61 
sÿm³r_addr_t
 *
	m¤c
;

62 
sÿm³r_addr_t
 *
	md¡
;

63 
ušt16_t
 
	m¥Üt
;

64 
ušt16_t
 
	mdpÜt
;

65 
ušt16_t
 
	m£cÚd¬y_dpÜt
;

67 
ušt32_t
 
	m£q
;

69 
ušt8_t
 
	mpythÚ_bšdšgs
;

70 
ušt8_t
 
	mdÚÙ»sŞv
;

71 
ušt8_t
 
	mudp
;

72 
ušt8_t
 
	mv6
;

73 
ušt16_t
 
	mmaxhİs
;

74 *
	m´obe
;

75 
ušt8_t
 
	m´štmode
;

76 
ušt8_t
 
	m¹t
;

77 
ušt8_t
 
	micmp_quÙe_ty³
;

79 
ušt8_t
 
	meù
, 
	meû
, 
	mû
, 
	mdsı
, 
	mmpÿ·bË
, 
	mmpjoš
, 
	m§ckp
, 
	mts
, 
	mid
, 
	m§ck
, 
	mao
, 
	mmd5
,
	maokeyid
,
	maÜÃxtkeyid
, 
	m¤v_‰l
;

82 
ušt32_t
 
	mid_v®ue
, 
	mmss
,
	mwsÿË
,
	m§ck_¦e
,
	m§ck_¤e
,
	mtsv®
,
	mt£ü
, 
	m»c_tok’
, 
	m£nd_ºum
, 
	mh_skey
, 
	ml_skey
;

83 
ušt32_t
 
	mmd5dige¡
[4], 
	maomac
[4];

86 
timev®
 
	m¡¬t
;

89 
ušt16_t
 
	m»suÉ
;

92 
ušt8_t
 
	mty³
;

93 *
	md©a
;

96 
ušt8_t
 
	m­p_´Ùo
;

97 *
	m­p_d©a
;

100 
ušt16_t
 
	mş›Á_mss
;

101 
ušt16_t
 
	m£rv”_mss
;

104 
ušt8_t
 
	msyn_»tx
;

105 
ušt8_t
 
	md©_»tx
;

108 
sÿm³r_Œaûbox_pkt_t
 **
	mpkts
;

109 
ušt32_t
 
	mpktc
;

112 * 
	mmisc
;

113 
ušt32_t
 
	mmisş
;

115 } 
	tsÿm³r_Œaûbox_t
;

117 
sÿm³r_Œaûbox_t
 *
sÿm³r_Œaûbox_®loc
();

118 
sÿm³r_Œaûbox_ä“
(
sÿm³r_Œaûbox_t
 *
Œaûbox
);

120 *
sÿm³r_Œaûbox_»s2¡r
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, *
buf
, 
size_t
 
Ën
);

121 *
sÿm³r_Œaûbox_ty³2¡r
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, *
buf
, 
size_t
 
Ën
);

123 
sÿm³r_Œaûbox_pkt_t
 *
sÿm³r_Œaûbox_pkt_®loc
(
ušt8_t
 
dœ
, ušt8_ˆ*
d©a
,

124 
ušt16_t
 
Ën
, 
timev®
 *
tv
);

125 
sÿm³r_Œaûbox_pkt_ä“
(
sÿm³r_Œaûbox_pkt_t
 *
pkt
);

127 
sÿm³r_Œaûbox_pkts_®loc
(
sÿm³r_Œaûbox_t
 *
Œaûbox
, 
ušt32_t
 
couÁ
);

128 
sÿm³r_Œaûbox_»cÜd_pkt
(
sÿm³r_Œaûbox_t
 *
Œaûbox
, 
sÿm³r_Œaûbox_pkt_t
 *
pkt
);

	@tracebox/scamper_tracebox_do.c

9 #iâdeà
lšt


10 cÚ¡ 
	grcsid
[] =

14 #ifdeà
HAVE_CONFIG_H


15 
	~"cÚfig.h
"

17 
	~"š‹º®.h
"

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<time.h
>

22 
	~"sÿm³r.h
"

23 
	~"sÿm³r_addr.h
"

24 
	~"sÿm³r_li¡.h
"

25 
	~"sÿm³r_sk.h
"

26 
	~"sÿm³r_dl.h
"

27 
	~"sÿm³r_fds.h
"

28 
	~"sÿm³r_dlhdr.h
"

29 
	~"sÿm³r_fœew®l.h
"

30 
	~"sÿm³r_¹sock.h
"

31 
	~"sÿm³r_if.h
"

32 
	~"sÿm³r_´obe.h
"

33 
	~"sÿm³r_g‘¤c.h
"

34 
	~"sÿm³r_tı4.h
"

35 
	~"sÿm³r_4.h
"

36 
	~"sÿm³r_6.h
"

37 
	~"sÿm³r_tı6.h
"

38 
	~"sÿm³r_queue.h
"

39 
	~"sÿm³r_fe.h
"

40 
	~"sÿm³r_İtiÚs.h
"

41 
	~"sÿm³r_debug.h
"

42 
	~"uts.h
"

43 
	~"mjl_li¡.h
"

44 
	~"sÿm³r_Œaûbox.h
"

45 
	~"sÿm³r_Œaûbox_do.h
"

46 
	~"sÿm³r_Œaûbox_‹xt.h
"

49 
	#TRACEBOX_RETX_DEFAULT
 3

	)

50 
	#TRACEBOX_TIMEOUT_DEFAULT
 3000

	)

51 
	#TRACEBOX_TIMEOUT_LONG
 70000

	)

52 
	#TRACEBOX_SINGLE_HOP_MAX_REPLAYS
 3

	)

53 
	#TRACEBOX_TOTAL_MAX_REPLAYS
 5

	)

54 
	#TRACEBOX_MAX_HOPS
 64

	)

55 
	#TRACEBOX_DEFAULT_MSS
 1460

	)

56 
	#TRACEBOX_DEFAULT_WSCALE
 14

	)

58 
	sŒaûbox_İtiÚs


60 
ušt8_t
 
	mudp
;

61 
ušt8_t
 
	mv6
;

62 
ušt8_t
 
	m¹t
;

63 
ušt8_t
 
	micmp_quÙe_ty³
;

64 
ušt8_t
 
	mpythÚ_bšdšgs
;

65 
ušt16_t
 
	mdpÜt
;

66 
ušt16_t
 
	m£cÚd¬y_dpÜt
;

67 *
	m´obe
;

68 
	m´štmode
;

70 
ušt8_t
 
	m­p
;

72 } 
	tŒaûbox_İtiÚs_t
;

74 
	sŒaûbox_£gm’t


76 
ušt8_t
 *
	md©a
;

77 
ušt16_t
 
	mËn
;

78 } 
	tŒaûbox_£gm’t_t
;

80 
	sŒaûbox_äag


82 
ušt16_t
 
	moff
;

83 
ušt8_t
 *
	md©a
;

84 
ušt16_t
 
	md©®’
;

85 } 
	tŒaûbox_äag_t
;

87 
	sŒaûbox_äags


89 
timev®
 
	mtv
;

90 
ušt32_t
 
	mid
;

91 
Œaûbox_äag_t
 **
	mäags
;

92 
	mäagc
;

93 
ušt8_t
 
	mgÙÏ¡
;

94 } 
	tŒaûbox_äags_t
;

96 
	sŒaûbox_´obe


98 
ušt8_t
 
	mty³
;

99 
	mwa™
;

102 
	s_tı


104 
ušt16_t
 
	mËn
;

105 
ušt8_t
 
	mæags
;

106 
ušt8_t
 
	m§ckb
;

107 
ušt32_t
 
	m£q
;

108 
ušt32_t
 
	mack
;

109 
ušt32_t
 
	m§ck
[8];

110 } 
	mtı
;

111 } 
	mun
;

112 } 
	tŒaûbox_´obe_t
;

114 
	#_Ën
 
un
.
tı
.
Ën


	)

115 
	#_æags
 
un
.
tı
.
æags


	)

116 
	#_§ckb
 
un
.
tı
.
§ckb


	)

117 
	#_£q
 
un
.
tı
.
£q


	)

118 
	#_ack
 
un
.
tı
.
ack


	)

119 
	#_§ck
 
un
.
tı
.
§ck


	)

121 
	sŒaûbox_¡©e


124 
ušt16_t
 
	mÏ¡_‰l
;

125 
ušt8_t
 
	m»¶ayšg
;

126 
ušt8_t
 
	mtimeout_couÁ
;

127 
ušt8_t
 
	mloİ
;

129 #iâdeà
_WIN32


130 
sÿm³r_fd_t
 *
	m¹sock
;

132 
sÿm³r_fd_t
 *
	mdl
;

133 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

134 
sÿm³r_rou‹_t
 *
	mrou‹
;

135 
sÿm³r_fœew®l_’Œy_t
 *
	mfw
;

136 
ušt8_t
 
	mmode
;

137 
ušt8_t
 
	m©‹m±
;

138 
ušt16_t
 
	mæags
;

139 
timev®
 
	mtimeout
;

140 
ušt16_t
 
	mid
;

142 
¦i¡_t
 *
	mtx
;

143 
¦i¡_t
 *
	m£gm’ts
;

144 
ušt32_t
 
	m¢d_nxt
;

145 
ušt32_t
 
	mrcv_nxt
;

147 
Œaûbox_äags_t
 **
	mäags
;

148 
	mäagc
;

150 } 
	tŒaûbox_¡©e_t
;

152 
	#pmtud_±b_d©a
 
un
.
pmtud
.
±b_d©a


	)

153 
	#pmtud_±b_d©®’
 
un
.
pmtud
.
±b_d©®’


	)

154 
	#pmtud_±b_c
 
un
.
pmtud
.
±b_c


	)

155 
	#§ckr_rx
 
un
.
§ckr
.
rx


	)

156 
	#§ckr_x
 
un
.
§ckr
.
x


	)

157 
	#§ckr_æags
 
un
.
§ckr
.
æags


	)

158 
	#§ckr_timeout
 
un
.
§ckr
.
timeout


	)

159 
	#eú_æags
 
un
.
eú
.
æags


	)

162 
sÿm³r_sk_funcs_t
 
	gŒaûbox_funcs
;

165 
sÿm³r_addrÿche_t
 *
addrÿche
;

168 
	#TRACEBOX_OPT_DPORT
 1

	)

170 
	#TRACEBOX_OPT_IPV6
 3

	)

171 
	#TRACEBOX_OPT_UDP
 4

	)

172 
	#TRACEBOX_OPT_MAXHOPS
 5

	)

173 
	#TRACEBOX_OPT_PROBE
 6

	)

174 
	#TRACEBOX_OPT_RTT
 7

	)

175 
	#TRACEBOX_OPT_ICMP_QUOTE_TYPE
 8

	)

176 
	#TRACEBOX_OPT_PYTHON_BINDINGS
 9

	)

178 
	#TRACEBOX_OPT_FRAGS
 10

	)

180 
	#TRACEBOX_OPT_SIMPLIFIED_OUTPUT
 12

	)

181 
	#TRACEBOX_OPT_PROXY
 13

	)

182 
	#TRACEBOX_OPT_STATEFULL
 14

	)

183 
	#TRACEBOX_OPT_PROXY_SECONDARY_DPORT
 15

	)

186 
	#TRACEBOX_PROBE_TYPE_TCP
 1

	)

187 
	#TRACEBOX_PROBE_TYPE_UDP
 2

	)

189 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

190 {'6', "v6", 
TRACEBOX_OPT_IPV6
, 
SCAMPER_OPTION_TYPE_NULL
},

191 {'d', "dpÜt", 
TRACEBOX_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

192 {'p', "´obe", 
TRACEBOX_OPT_PROBE
, 
SCAMPER_OPTION_TYPE_STR
},

193 {'u', "udp", 
TRACEBOX_OPT_UDP
, 
SCAMPER_OPTION_TYPE_NULL
},

194 {'r', "¹t", 
TRACEBOX_OPT_RTT
, 
SCAMPER_OPTION_TYPE_NULL
},

195 {'t', "icmp-quÙe-ty³", 
TRACEBOX_OPT_ICMP_QUOTE_TYPE
, 
SCAMPER_OPTION_TYPE_NULL
},

196 {'s', "sim¶if›d", 
TRACEBOX_OPT_SIMPLIFIED_OUTPUT
, 
SCAMPER_OPTION_TYPE_NULL
},

197 {'\0', "pythÚ", 
TRACEBOX_OPT_PYTHON_BINDINGS
, 
SCAMPER_OPTION_TYPE_NULL
},

198 {'\0', "äags", 
TRACEBOX_OPT_FRAGS
, 
SCAMPER_OPTION_TYPE_NULL
},

199 {'\0', "´oxy", 
TRACEBOX_OPT_PROXY
, 
SCAMPER_OPTION_TYPE_NULL
},

200 {'\0', "´oxy-£cÚd¬y-dpÜt", 
TRACEBOX_OPT_PROXY_SECONDARY_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

201 {'\0', "¡©eful", 
TRACEBOX_OPT_STATEFULL
, 
SCAMPER_OPTION_TYPE_NULL
},

203 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

205 cÚ¡ 
ušt8_t
 
	gMODE_RTSOCK
 = 1;

206 cÚ¡ 
ušt8_t
 
	gMODE_DLHDR
 = 2;

207 cÚ¡ 
ušt8_t
 
	gMODE_PROXY
 = 3;

208 cÚ¡ 
ušt8_t
 
	gMODE_DONE
 = 4;

209 cÚ¡ 
ušt8_t
 
	gMODE_SYN
 = 5;

211 cÚ¡ *
	$sÿm³r_do_Œaûbox_u§ge
()

214 
	}
}

216 
sÿm³r_Œaûbox_t
 *
	$Œaûbox_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

218  
	`sÿm³r_sk_g‘d©a
(
sk
);

219 
	}
}

221 
Œaûbox_¡©e_t
 *
	$Œaûbox_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

223  
	`sÿm³r_sk_g‘¡©e
(
sk
);

224 
	}
}

226 
	$Œaûbox_queue
(
sÿm³r_sk_t
 *
sk
)

228 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

230 if(
	`¦i¡_couÁ
(
¡©e
->
tx
) > 0)

231 
	`sÿm³r_sk_queue_´obe
(
sk
);

232 if(
¡©e
->
mode
 =ğ
MODE_DONE
)

233 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

235 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
¡©e
->
timeout
);

238 
	}
}

245 
	$Œaûbox_»suÉ
(
sÿm³r_sk_t
 *
sk
, 
ušt8_t
 
»suÉ
)

247 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

248 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

249 
buf
[16], 
addr
[64];

250 
d
 = 0;

251 
»suÉ
)

253 
SCAMPER_TRACEBOX_RESULT_SUCCESS
:

254 
SCAMPER_TRACEBOX_RESULT_NONE
:

255 
SCAMPER_TRACEBOX_RESULT_TCP_NOCONN
:

256 
SCAMPER_TRACEBOX_RESULT_DEST_UNREACHABLE
:

257 
SCAMPER_TRACEBOX_RESULT_TCP_ERROR
:

258 
SCAMPER_TRACEBOX_RESULT_TCP_RST
:

259 
SCAMPER_TRACEBOX_RESULT_TCP_BADOPT
:

260 
SCAMPER_TRACEBOX_RESULT_TCP_FIN
:

261 
SCAMPER_TRACEBOX_RESULT_ERROR
:

262 
SCAMPER_TRACEBOX_RESULT_ABORTED
:

263 
SCAMPER_TRACEBOX_RESULT_TIMEOUT
:

264 
SCAMPER_TRACEBOX_RESULT_HALTED
:

265 
d
 = 1;

269 if(
Œaûbox
->
»suÉ
 =ğ
SCAMPER_TRACEBOX_RESULT_NONE
)

271 
Œaûbox
->
»suÉ
 =„esult;

272 
	`sÿm³r_addr_to¡r
(
Œaûbox
->
d¡
, 
addr
, (addr));

273 
	`sÿm³r_debug
(
__func__
, "% %s", 
addr
,

274 
	`sÿm³r_Œaûbox_»s2¡r
(
Œaûbox
, 
buf
, (buf)));

277 if(
d
 == 1)

279 
¡©e
->
mode
 = 
MODE_DONE
;

280 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

284 
	}
}

286 
	$Œaûbox_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”rÜ
)

288 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

289 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

290 
Œaûbox
->
»suÉ
 = 
SCAMPER_TRACEBOX_RESULT_ERROR
;

291 if(
¡©e
 !ğ
NULL
è¡©e->
mode
 = 
MODE_DONE
;

292 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

294 
	}
}

296 
	$_ä“
(
Œaûbox_´obe_t
 *

)

298 if(

 =ğ
NULL
)

300 
	`ä“
(

);

302 
	}
}

304 
Œaûbox_´obe_t
 *
	$_®loc
(
Œaûbox_¡©e_t
 *
¡©e
, 
ušt8_t
 
ty³
)

306 
Œaûbox_´obe_t
 *

;

307 if((

 = 
	`m®loc_z”o
((
Œaûbox_´obe_t
))è=ğ
NULL
)

309 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot mallocp");

310  
NULL
;

312 if(
	`¦i¡__push
(
¡©e
->
tx
, 

è=ğ
NULL
)

314 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot queuep");

315 
	`ä“
(

);

316  
NULL
;

318 

->
ty³
 =ype;

319  

;

320 
	}
}

322 
Œaûbox_´obe_t
 *
	$_tı
(
Œaûbox_¡©e_t
 *
¡©e
, 
ušt16_t
 
Ën
)

324 
Œaûbox_´obe_t
 *

;

326 if((

 = 
	`_®loc
(
¡©e
, 
TRACEBOX_PROBE_TYPE_TCP
)è=ğ
NULL
)

327  
NULL
;

329 

->
_æags
 = 
TH_ACK
;

330 

->
_£q
 = 
¡©e
->
¢d_nxt
;

331 

->
_ack
 = 
¡©e
->
rcv_nxt
;

332 

->
_Ën
 = 
Ën
;

334  

;

335 
	}
}

337 
	$Œaûbox_£gm’t_ä“
(
Œaûbox_£gm’t_t
 *
£g
)

339 if(
£g
 =ğ
NULL
)

341 if(
£g
->
d©a
 !ğ
NULL
)

342 
	`ä“
(
£g
->
d©a
);

343 
	`ä“
(
£g
);

345 
	}
}

347 
	$Œaûbox_£gm’t
(
Œaûbox_¡©e_t
 *
¡©e
, cÚ¡ 
ušt8_t
 *
d©a
, 
ušt16_t
 
Ën
)

349 
Œaûbox_£gm’t_t
 *
£g
 = 
NULL
;

351 if((
£g
 = 
	`m®loc_z”o
((
Œaûbox_£gm’t_t
))è=ğ
NULL
)

353 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc seg");

354 
”r
;

356 if((
£g
->
d©a
 = 
	`memdup
(d©a, 
Ën
)è=ğ
NULL
)

358 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc seg->data");

359 
”r
;

361 
£g
->
Ën
 =†en;

362 if(
	`¦i¡__push
(
¡©e
->
£gm’ts
, 
£g
è=ğ
NULL
)

364 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd seg");

365 
”r
;

370 
”r
:

371 
	`Œaûbox_£gm’t_ä“
(
£g
);

373 
	}
}

380 
	$dl_syn
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

382 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

383 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

384 
Œaûbox_´obe_t
 *

;

388 if(
	`SCAMPER_DL_IS_ICMP
(
dl
)) {

389 ià(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
)) {

390 
	`¦i¡__push
(
¡©e
->
tx
, 

);

396 } ià(
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
))

397 
	`sÿm³r_debug
(
__func__
,"ICMP_UNREACH");

398 ià(
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
))

399 
	`sÿm³r_debug
(
__func__
,"ICMP_PACKET_TOO_BIG") ;

403 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_PROXY
 && 
	`SCAMPER_DL_IS_TCP_SYNACK
(
dl
è&& 
¡©e
->
loİ
 == 0) {

404 
	`¦i¡__push
(
¡©e
->
tx
, 

);

405 
¡©e
->
loİ
++;

406 } ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_STATEFULL
 && 
¡©e
->
loİ
 < 5) {

407 
	`¦i¡__push
(
¡©e
->
tx
, 

);

408 
¡©e
->
loİ
++;

414 
	`Œaûbox_queue
(
sk
);

417 
”r
:

418 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

420 
	}
}

422 
	$dl_´oxy
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

424 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

425 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

427 
Œaûbox_´obe_t
 *

;

428 
rc
, 
wa™
 = 
TRACEBOX_TIMEOUT_DEFAULT
;

430 if(
	`SCAMPER_DL_IS_ICMP
(
dl
)) {

431 ià(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
)) {

433 
	`¦i¡__push
(
¡©e
->
tx
, 

);

438 } ià(
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
))

439 
	`sÿm³r_debug
(
__func__
,"b");

440 ià(
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
))

441 
	`sÿm³r_debug
(
__func__
,"c") ;

444 
	`Œaûbox_queue
(
sk
);

447 
”r
:

448 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

450 
	}
}

452 
	$»£t_timeout_couÁ”s
(
Œaûbox_¡©e_t
 *
¡©e
) {

453 
¡©e
->
»¶ayšg
 = 0;

454 
¡©e
->
timeout_couÁ
 = 0;

455 
¡©e
->
©‹m±
 = 0;

456 
	}
}

458 
	$timeout_¹
(
sÿm³r_sk_t
 *
sk
)

460 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_ERROR
);

462 
	}
}

464 
	$timeout_dlhdr
(
sÿm³r_sk_t
 *
sk
)

466 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_ERROR
);

468 
	}
}

470 
	$timeout_syn
(
sÿm³r_sk_t
 *
sk
)

472 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

473 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

475 
¡©e
->
timeout_couÁ
++;

477 if(
¡©e
->
timeout_couÁ
 >ğ
TRACEBOX_TOTAL_MAX_REPLAYS
) {

478 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_TIMEOUT
);

482 ià(
¡©e
->
©‹m±
 < 
TRACEBOX_SINGLE_HOP_MAX_REPLAYS
) {

483 
¡©e
->
Ï¡_‰l
--;

484 
¡©e
->
»¶ayšg
 = 1;

485 } ià(
¡©e
->
©‹m±
 =ğ
TRACEBOX_SINGLE_HOP_MAX_REPLAYS
) {

486 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_STATEFULL
 && 
¡©e
->
loİ
 == 2) {

487 
Œaûbox
->
£q
 += 10;

488 
¡©e
->
Ï¡_‰l
 = 0;

489 
	`»£t_timeout_couÁ”s
(
¡©e
);

490 
¡©e
->
loİ
 = 3;

492 
¡©e
->
»¶ayšg
 = 0;

493 
¡©e
->
©‹m±
=0;

494 
	`sÿm³r_debug
(
__func__
," max„eplay for single hops: skipping...");

495 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_FRAGS
è
¡©e
->
timeout_couÁ
=0;

500 
	}
}

502 
	$timeout_´oxy
(
sÿm³r_sk_t
 *
sk
)

504 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

505 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

507 
¡©e
->
timeout_couÁ
++;

509 if(
¡©e
->
timeout_couÁ
 >ğ
TRACEBOX_TOTAL_MAX_REPLAYS
) {

510 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_TIMEOUT
);

514 ià(
¡©e
->
©‹m±
 < 
TRACEBOX_SINGLE_HOP_MAX_REPLAYS
) {

515 
¡©e
->
Ï¡_‰l
--;

516 
¡©e
->
»¶ayšg
 = 1;

517 } ià(
¡©e
->
©‹m±
 =ğ
TRACEBOX_SINGLE_HOP_MAX_REPLAYS
) {

518 
¡©e
->
»¶ayšg
 = 0;

519 
¡©e
->
©‹m±
=0;

520 
	`sÿm³r_debug
(
__func__
,"max„eplay for single hops: skipping...");

525 
	}
}

533 
	$do_Œaûbox_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

536 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *) =

538 
NULL
,

539 
NULL
,

540 
NULL
,

541 
dl_´oxy
,

542 
NULL
,

543 
dl_syn
,

546 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

547 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

548 
sÿm³r_Œaûbox_pkt_t
 *
pkt
 = 
NULL
;

549 
sÿm³r_dl_»c_t
 *
Ãwp
 = 
NULL
;

550 
mÜe
 = 0;

551 
addr
[64];

553 ià(!
	`sÿm³r_addr_¿w_cmp
(
Œaûbox
->
¤c
, 
dl
->
dl__¤c
è&& !
	`SCAMPER_DL_IS_ICMP
(dl)) ;

555 
	`»£t_timeout_couÁ”s
(
¡©e
);

557 if(
	`SCAMPER_DL_IS_ICMP
(
dl
)) {

558 
	`sÿm³r_debug
(
__func__
,"received ICMP");

559 ià(
	`SCAMPER_DL_IS_ICMP_TTL_EXP
(
dl
)) {

561 ià(
	`SCAMPER_DL_IS_IPV4
(
dl
)) {

562 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
,
dl
->
dl__¤c
);

563 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

564 
	`sÿm³r_addr_ä“
(
a
);

565 } ià(
	`SCAMPER_DL_IS_IPV6
(
dl
)) {

566 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
,
dl
->
dl__¤c
);

567 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

568 
	`sÿm³r_addr_ä“
(
a
);

569 } 
	`¡rıy
(
addr
,"unkownransport");

571 
	`sÿm³r_debug
(
__func__
,"TTLƒx°äom %s",
addr
);

573 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_STATEFULL
 && 
¡©e
->
loİ
 == 1

574 && 
¡©e
->
Ï¡_‰l
 =ğ
Œaûbox
->
¤v_‰l
 - 1) {

575 
Œaûbox
->
£q
 -= 10;

576 
¡©e
->
Ï¡_‰l
 = 0;

577 
	`»£t_timeout_couÁ”s
(
¡©e
);

578 
¡©e
->
loİ
++;

580 
mÜe
 = 1;

581 } ià(
	`SCAMPER_DL_IS_ICMP_UNREACH
(
dl
)) {

582 
	`sÿm³r_debug
(
__func__
,"Destination unreachable");

583 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_DEST_UNREACHABLE
);

584 } ià(
	`SCAMPER_DL_IS_ICMP_PACKET_TOO_BIG
(
dl
)) {

585 
	`sÿm³r_debug
(
__func__
,"Pktoo big");

586 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_DEST_UNREACHABLE
);

589 } ià(
	`SCAMPER_DL_IS_TCP
(
dl
)) {

590 
	`sÿm³r_debug
(
__func__
,"received TCP");

591 ià(
	`SCAMPER_DL_IS_TCP_SYNACK
(
dl
)) {

592 
	`sÿm³r_debug
(
__func__
,"SYNACK");

593 } ià((
dl
->
dl_tı_æags
 & 
TH_RST
) != 0)

594 
	`sÿm³r_debug
(
__func__
,"RST");

597 } ià(
	`SCAMPER_DL_IS_UDP
(
dl
)) {

598 
	`sÿm³r_debug
(
__func__
,"received UDP");

602 
pkt
 = 
	`sÿm³r_Œaûbox_pkt_®loc
(
SCAMPER_TRACEBOX_PKT_DIR_RX
, 
dl
->
dl_Ãt_¿w
,

603 
dl
->
dl__size
, &dl->
dl_tv
);

604 if(
pkt
 =ğ
NULL
 || 
	`sÿm³r_Œaûbox_»cÜd_pkt
(
Œaûbox
,…kt) != 0) {

605 if(
pkt
 !ğ
NULL
è
	`sÿm³r_Œaûbox_pkt_ä“
(pkt);

606 
”r
;

610 ià(!
	`sÿm³r_addr_¿w_cmp
(
Œaûbox
->
d¡
, 
dl
->
dl__¤c
)) {

612 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_PROXY
 && 
¡©e
->
loİ
 == 0) {

613 
Œaûbox
->
udp
 = 1;

614 
¡©e
->
Ï¡_‰l
 = 0;

615 
	`»£t_timeout_couÁ”s
(
¡©e
);

616 ià(
Œaûbox
->
£cÚd¬y_dpÜt
 != 0)

617 
Œaûbox
->
dpÜt
 =¿ûbox->
£cÚd¬y_dpÜt
;

618 
mÜe
 = 1;

619 } ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_STATEFULL


620 && 
¡©e
->
loİ
 < 4 && state->loop != 2) {

621 
Œaûbox
->
£q
 -= 10;

622 
Œaûbox
->
¤v_‰l
 = 
¡©e
->
Ï¡_‰l
;

623 
¡©e
->
Ï¡_‰l
 = 0;

624 
	`»£t_timeout_couÁ”s
(
¡©e
);

625 
mÜe
 = 1;

630 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_SUCCESS
);

631 
dÚe
;

635 ià(
¡©e
->
Ï¡_‰l
 >ğ
TRACEBOX_MAX_HOPS
) {

637 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_ABORTED
);

638 
dÚe
;

641 if(
func
[
¡©e
->
mode
] =ğ
NULL
)

642 
dÚe
;

643 ià(
mÜe
è
func
[
¡©e
->
mode
](
sk
, 
dl
);

645 
dÚe
:

648 
”r
:

649 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

651 
	}
}

653 
	$do_Œaûbox_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

656 (* cÚ¡ 
func
[])(
sÿm³r_sk_t
 *) =

658 
NULL
,

659 
timeout_¹
,

660 
timeout_dlhdr
,

661 
timeout_´oxy
,

662 
NULL
,

663 
timeout_syn
,

666 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

669 if(
func
[
¡©e
->
mode
] !ğ
NULL
)

670 
func
[
¡©e
->
mode
](
sk
);

673 
	}
}

675 
	$Œaûbox_hªdË_dlhdr
(
sÿm³r_dlhdr_t
 *
dlhdr
)

677 
sÿm³r_sk_t
 *
sk
 = 
dlhdr
->
·¿m
;

678 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

680 if(
dlhdr
->
”rÜ
 != 0)

682 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

686 
¡©e
->
mode
 = 
MODE_SYN
;

687 
	`sÿm³r_sk_queue_´obe
(
sk
);

689 
	}
}

691 
	$Œaûbox_hªdË_¹
(
sÿm³r_rou‹_t
 *
¹
)

693 
sÿm³r_sk_t
 *
sk
 = 
¹
->
·¿m
;

694 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

695 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

696 
sÿm³r_dl_t
 *
dl
;

697 
ušt16_t
 
mtu
;

699 if(
¡©e
->
mode
 !ğ
MODE_RTSOCK
 || s‹->
rou‹
 !ğ
¹
)

700 
dÚe
;

702 #iâdeà
_WIN32


703 if(
¡©e
->
¹sock
 !ğ
NULL
)

705 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

706 
¡©e
->
¹sock
 = 
NULL
;

710 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

712 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifindex");

713 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

714 
dÚe
;

721 if((
¡©e
->
dl
 = 
	`sÿm³r_fd_dl
(
¹
->
ifšdex
)è=ğ
NULL
)

723 
	`sÿm³r_debug
(
__func__
, "could‚Ù g‘ dÈfÜ %d", 
¹
->
ifšdex
);

724 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

725 
dÚe
;

732 
¡©e
->
mode
 = 
MODE_DLHDR
;

733 if((
¡©e
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

735 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

736 
dÚe
;

738 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->dl);

739 
¡©e
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
Œaûbox
->dst);

740 
¡©e
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

741 
¡©e
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

742 
¡©e
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

743 
¡©e
->
dlhdr
->
·¿m
 = 
sk
;

744 
¡©e
->
dlhdr
->
cb
 = 
Œaûbox_hªdË_dlhdr
;

745 if(
	`sÿm³r_dlhdr_g‘
(
¡©e
->
dlhdr
) != 0)

747 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

748 
dÚe
;

751 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
) == 0)

753 
dÚe
:

754 
	`sÿm³r_rou‹_ä“
(
¹
);

755 if(
¡©e
->
rou‹
 =ğ
¹
)

756 
¡©e
->
rou‹
 = 
NULL
;

758 
	}
}

760 
	$do_Œaûbox_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

762 
	`sÿm³r_fe_wr™e_Œaûbox
(
sf
, 
	`Œaûbox_g‘d©a
(
sk
));

764 
	}
}

766 
	$Œaûbox_¡©e_ä“
(
sÿm³r_sk_t
 *
sk
)

768 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

769 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

770 
Œaûbox_£gm’t_t
 *
£g
;

771 
Œaûbox_´obe_t
 *

;

772 
i
;

774 if(
¡©e
 =ğ
NULL
)

776 
	`as£¹
(
Œaûbox
 !ğ
NULL
);

778 #iâdeà
_WIN32


779 if(
¡©e
->
¹sock
 !ğ
NULL
)

780 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

783 if(
¡©e
->
dl
 !ğ
NULL
)

784 
	`sÿm³r_fd_ä“
(
¡©e
->
dl
);

786 if(
¡©e
->
dlhdr
 !ğ
NULL
)

787 
	`sÿm³r_dlhdr_ä“
(
¡©e
->
dlhdr
);

789 if(
¡©e
->
rou‹
 !ğ
NULL
)

790 
	`sÿm³r_rou‹_ä“
(
¡©e
->
rou‹
);

792 if(
¡©e
->
£gm’ts
 !ğ
NULL
)

794 (
£g
 = 
	`¦i¡_h—d_pİ
(
¡©e
->
£gm’ts
)è!ğ
NULL
)

795 
	`Œaûbox_£gm’t_ä“
(
£g
);

796 
	`¦i¡_ä“
(
¡©e
->
£gm’ts
);

799 if(
¡©e
->
tx
 !ğ
NULL
)

801 (

 = 
	`¦i¡_h—d_pİ
(
¡©e
->
tx
)è!ğ
NULL
)

802 
	`_ä“
(

);

803 
	`¦i¡_ä“
(
¡©e
->
tx
);

806 
	`ä“
(
¡©e
);

808 
	}
}

810 
	$Œaûbox_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

812 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

813 
Œaûbox_¡©e_t
 *
¡©e
;

814 
ušt16_t
 
£q
;

816 if((
¡©e
 = 
	`m®loc_z”o
((
Œaûbox_¡©e_t
))è=ğ
NULL
)

818 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

819 
”r
;

822 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

825 if((
¡©e
->
£gm’ts
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

827 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot create segments†ist");

828 
”r
;

830 if((
¡©e
->
tx
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

832 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot createx†ist");

833 
”r
;

840 if(
	`¿ndom_u16
(&
£q
) != 0)

842 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„andom isn");

843 
”r
;

845 
¡©e
->
¢d_nxt
 = 
£q
;

847 #iâdeà
_WIN32


848 if((
¡©e
->
¹sock
 = 
	`sÿm³r_fd_¹sock
()è=ğ
NULL
)

850 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get„tsock");

851 
”r
;

854 
¡©e
->
mode
 = 
MODE_RTSOCK
;

855 
¡©e
->
Ï¡_‰l
=0;

856 
	`»£t_timeout_couÁ”s
(
¡©e
);

860 
”r
:

862 
	}
}

864 
	$do_Œaûbox_h®t
(
sÿm³r_sk_t
 *
sk
)

866 
	`Œaûbox_»suÉ
(
sk
, 
SCAMPER_TRACEBOX_RESULT_HALTED
);

868 
	}
}

870 
	$do_Œaûbox_ä“
(
sÿm³r_sk_t
 *
sk
)

872 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

873 if(
Œaûbox
 =ğ
NULL
)

875 
	`Œaûbox_¡©e_ä“
(
sk
);

876 
	`sÿm³r_Œaûbox_ä“
(
Œaûbox
);

878 
	}
}

880 
sÿm³r_´obe_t
 
	$bud_´obe
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_´obe_t
 
´obe
, 
ušt8_t
 
upd©e_‰l
) {

882 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

883 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

886 
´obe
.
´_dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
dl
);

887 
´obe
.
´_dl_buf
 = 
¡©e
->
dlhdr
->
buf
;

888 
´obe
.
´_dl_Ën
 = 
¡©e
->
dlhdr
->
Ën
;

889 
´obe
.
´__¤c
 = 
Œaûbox
->
¤c
;

890 
´obe
.
´__d¡
 = 
Œaûbox
->
d¡
;

892 ià(
upd©e_‰l
è
¡©e
->
Ï¡_‰l
++;

893 
´obe
.
´__‰l
 = 
¡©e
->
Ï¡_‰l
;

896 ià(
Œaûbox
->
eù
)

897 
´obe
.
´__tos
 |= 0x02;

898 ià(
Œaûbox
->
û
)

899 
´obe
.
´__tos
 |= 0x03;

901 ià(
Œaûbox
->
dsı
)

902 
´obe
.
´__tos
 |= 0x80;

905 if(
Œaûbox
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
) {

906 ià(
Œaûbox
->
id
)

907 
´obe
.
´__id
 = 
Œaûbox
->
id_v®ue
;

909 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_FRAGS
) {

911 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

912 
sÿm³r_´obe_t
 
fuÎ_´obe
;

913 
	`mem£t
(&
fuÎ_´obe
, 0, (full_probe));

914 
Œaûbox
->
´štmode
 = 
TRACEBOX_PRINT_MODE_STANDARD
;

915 
fuÎ_´obe
 = 
	`bud_´obe
(
sk
, full_probe, 0);

916 
Œaûbox
->
´štmode
 = 
TRACEBOX_PRINT_MODE_FRAGS
;

918 
ušt8_t
 *
‹¡
 = 
	`m®loc
(40);

919 
size_t
 
‹¡_Ën
 = 40;

920 
	`sÿm³r_tı4_bud
(&
fuÎ_´obe
, 
‹¡
, &
‹¡_Ën
);

922 ià(!
¡©e
->
loİ
) {

923 
´obe
.
´_no_Œªs
=1;

924 
´obe
.
´__off
 = 
IP_MF
;

925 
´obe
.
´_Ën
 = 8;

926 
´obe
.
´_d©a
 = 
	`m®loc
(8);

927 
i
;

928 
i
=0;i<
´obe
.
´_Ën
;i++)

929 
´obe
.
´_d©a
[
i
]=
‹¡
[20+i];

932 
´obe
.
´__off
 = 0x0001;

933 
´obe
.
´_Ën
 = 12;

934 
´obe
.
´_d©a
 = 
	`m®loc
(12);

935 
i
;

936 
i
=0;i<
´obe
.
´_Ën
;i++)

937 
´obe
.
´_d©a
[
i
]=
‹¡
[28+i];

938 
Œaûbox
->
id_v®ue
++;

940 
	`ä“
(
‹¡
);

941  
´obe
;

945 } ià(
Œaûbox
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
) {

946 ià(
Œaûbox
->
id
 &&¿ûbox->
´štmode
 !ğ
TRACEBOX_PRINT_MODE_FRAGS
)

947 
´obe
.
´__æow
 = 
Œaûbox
->
id_v®ue
;

949 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_FRAGS
) {

951 
´obe
.
´__´Ùo
 = 
IPPROTO_FRAGMENT
;

952 
sÿm³r_´obe_t
 
fuÎ_´obe
;

953 
	`mem£t
(&
fuÎ_´obe
, 0, (full_probe));

954 
Œaûbox
->
´štmode
 = 
TRACEBOX_PRINT_MODE_STANDARD
;

955 
fuÎ_´obe
 = 
	`bud_´obe
(
sk
, full_probe, 0);

956 
Œaûbox
->
´štmode
 = 
TRACEBOX_PRINT_MODE_FRAGS
;

958 
ušt8_t
 *
‹¡
 = 
	`m®loc
(60);

959 
size_t
 
‹¡_Ën
 = 60;

960 
	`sÿm³r_tı6_bud
(&
fuÎ_´obe
, 
‹¡
, &
‹¡_Ën
);

961 
i
;

962 
i
=0;i<60;i+=4)

963 
	`sÿm³r_debug
(
__func__
,"%x %x %x %x",
‹¡
[
i
],test[i+1],test[i+2],test[i+3]);

965 ià(!
¡©e
->
loİ
) {

966 
´obe
.
´_no_Œªs
=1;

967 
´obe
.
´_Ën
 = 16;

968 
´obe
.
´_d©a
 = 
	`m®loc
(16);

969 
´obe
.
´_d©a
[0] = 0x06;

970 
´obe
.
´_d©a
[1] = 0x00;

971 
´obe
.
´_d©a
[2] = 0x00;

972 
´obe
.
´_d©a
[3] = 0x01;

973 
	`by‹s_htÚl
(
´obe
.
´_d©a
+4, 
Œaûbox
->
id_v®ue
);

974 
i
=8;i<
´obe
.
´_Ën
;i++)

975 
´obe
.
´_d©a
[
i
]=
‹¡
[32+i];

977 
´obe
.
´_no_Œªs
=1;

978 
´obe
.
´_Ën
 = 20;

979 
´obe
.
´_d©a
 = 
	`m®loc
(20);

980 
´obe
.
´_d©a
[0] = 0x06;

981 
´obe
.
´_d©a
[1] = 0x00;

982 
´obe
.
´_d©a
[2] = 0x00;

983 
´obe
.
´_d©a
[3] = 0x08;

984 
	`by‹s_htÚl
(
´obe
.
´_d©a
+4, 
Œaûbox
->
id_v®ue
++);

985 
i
=8;i<
´obe
.
´_Ën
;i++)

986 
´obe
.
´_d©a
[
i
]=
‹¡
[40+i];

987 
i
=0;i<20;i+=4)

988 
	`sÿm³r_debug
(
__func__
,"%x %x %x %x",
´obe
.
´_d©a
[
i
],probe.pr_data[i+1],probe.pr_data[i+2],probe.pr_data[i+3]);

991 
	`ä“
(
‹¡
);

992  
´obe
;

998 ià(
Œaûbox
->
udp
) {

999 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

1000 
´obe
.
´_udp_¥Üt
 = 
Œaûbox
->
¥Üt
;

1001 
´obe
.
´_udp_dpÜt
 = 
Œaûbox
->
dpÜt
;

1004 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

1005 
´obe
.
´_tı_¥Üt
 = 
Œaûbox
->
¥Üt
;

1006 
´obe
.
´_tı_dpÜt
 = 
Œaûbox
->
dpÜt
;

1007 
´obe
.
´_tı_æags
 |ğ
TH_SYN
;

1008 
´obe
.
´_tı_£q
 = 
Œaûbox
->
£q
;

1009 
´obe
.
´_tı_wš
 = 65535;

1011 ià(
Œaûbox
->
mss
)

1012 
´obe
.
´_tı_mss
 = 
Œaûbox
->
mss
;

1013 ià(
Œaûbox
->
wsÿË
)

1014 
´obe
.
´_tı_wsÿË
 = 
Œaûbox
->
wsÿË
;

1016 ià(
Œaûbox
->
mpÿ·bË
) {

1017 
´obe
.
´_tı_mpÿ·bË
 = 
Œaûbox
->
h_skey
;

1018 
´obe
.
´_tı_mpÿ·bË2
 = 
Œaûbox
->
l_skey
;

1020 ià(
Œaûbox
->
mpjoš
) {

1021 
´obe
.
´_tı_mpjoš
 = 
Œaûbox
->
»c_tok’
;

1022 
´obe
.
´_tı_mpjoš2
 = 
Œaûbox
->
£nd_ºum
;

1024 ià(
Œaûbox
->
§ck
) {

1025 
´obe
.
´_tı_§ckb
 = 1;

1026 
´obe
.
´_tı_§ck
[0] = 
Œaûbox
->
§ck_¦e
;

1027 
´obe
.
´_tı_§ck
[1] = 
Œaûbox
->
§ck_¤e
;

1029 ià(
Œaûbox
->
§ckp
)

1030 
´obe
.
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_SACK
;

1031 ià(
Œaûbox
->
ts
) {

1032 
´obe
.
´_tı_İts
 |ğ
SCAMPER_PROBE_TCPOPT_TS
;

1033 
´obe
.
´_tı_tsv®
 = 
Œaûbox
->
tsv®
;

1034 
´obe
.
´_tı_t£ü
 = 
Œaûbox
->
t£ü
;

1036 ià(
Œaûbox
->
eû
è
´obe
.
´_tı_æags
 |ğ(
TH_ECE
|
TH_CWR
);

1037 ià(
Œaûbox
->
md5
) {

1038 
´obe
.
´_tı_md5
=1;

1039 
i
;

1040 
i
=0;i<4;i++)

1041 
´obe
.
´_tı_md5dige¡
[
i
]=
Œaûbox
->
md5dige¡
[i];

1043 ià(
Œaûbox
->
ao
) {

1044 
´obe
.
´_tı_auth
=1;

1045 
´obe
.
´_tı_authkeyid
=
Œaûbox
->
aokeyid
;

1046 
´obe
.
´_tı_authºextkeyid
=
Œaûbox
->
aÜÃxtkeyid
;

1047 
i
;

1048 
i
=0;i<4;i++)

1049 
´obe
.
´_tı_authmac
[
i
]=
Œaûbox
->
aomac
[i];

1053  
´obe
;

1054 
	}
}

1056 
	$do_Œaûbox_´obe
(
sÿm³r_sk_t
 *
sk
)

1058 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
	`Œaûbox_g‘d©a
(
sk
);

1059 
Œaûbox_¡©e_t
 *
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

1060 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

1061 
sÿm³r_´obe_t
 
´obe
;

1062 
Œaûbox_´obe_t
 *

 = 
NULL
;

1063 
wa™
, 
rc
;

1065 if(
¡©e
 =ğ
NULL
)

1068 
	`g‘timeofday_w¿p
(&
Œaûbox
->
¡¬t
);

1071 if(
	`Œaûbox_¡©e_®loc
(
sk
) != 0)

1072 
”r
;

1074 
¡©e
 = 
	`Œaûbox_g‘¡©e
(
sk
);

1077 if(
¡©e
->
mode
 =ğ
MODE_RTSOCK
)

1079 
¡©e
->
rou‹
 = 
	`sÿm³r_rou‹_®loc
(
Œaûbox
->
d¡
, 
sk
, 
Œaûbox_hªdË_¹
);

1080 if(
¡©e
->
rou‹
 =ğ
NULL
)

1081 
”r
;

1083 #iâdeà
_WIN32


1084 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
¹sock
, s‹->
rou‹
) != 0)

1085 
”r
;

1087 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
rou‹
) != 0)

1088 
”r
;

1091 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

1094 
	`sÿm³r_sk_queue_wa™
(
sk
, 1000);

1099 ià(
Œaûbox
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

1100 
	`sÿm³r_debug
(
__func__
,"IPV4‡ddr");

1101 ià(
Œaûbox
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

1102 
	`sÿm³r_debug
(
__func__
,"IPV6‡ddr");

1103 
	`sÿm³r_debug
(
__func__
,"Unknown‡ddrype");

1105 
	`mem£t
(&
´obe
, 0, (probe));

1107 
´obe
 = 
	`bud_´obe
(
sk
,…robe, 1);

1108 
wa™
 = 
TRACEBOX_TIMEOUT_DEFAULT
;

1109 

 = 
	`¦i¡_h—d_pİ
(
¡©e
->
tx
);

1112 if(
	`sÿm³r_´obe
(&
´obe
) != 0)

1114 
”ºo
 = 
´obe
.
´_”ºo
;

1115 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send…robe");

1116 
”r
;

1120 if((
pkt
 = 
	`sÿm³r_Œaûbox_pkt_®loc
(
SCAMPER_TRACEBOX_PKT_DIR_TX
, 
´obe
.
´_tx_¿w
,

1121 
´obe
.
´_tx_¿wËn
, &´obe.
´_tx
))==
NULL
 ||

1122 
	`sÿm³r_Œaûbox_»cÜd_pkt
(
Œaûbox
, 
pkt
) != 0)

1124 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecord…acket");

1125 
”r
;

1128 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_FRAGS
 && !
¡©e
->
loİ
) {

1129 
¡©e
->
loİ
=1;

1131 
	`mem£t
(&
´obe
, 0, (probe));

1132 
´obe
 = 
	`bud_´obe
(
sk
,…robe, 0);

1133 

 = 
	`¦i¡_h—d_pİ
(
¡©e
->
tx
);

1136 if(
	`sÿm³r_´obe
(&
´obe
) != 0)

1138 
”ºo
 = 
´obe
.
´_”ºo
;

1139 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot send…robe");

1140 
”r
;

1144 if((
pkt
 = 
	`sÿm³r_Œaûbox_pkt_®loc
(
SCAMPER_TRACEBOX_PKT_DIR_TX
, 
´obe
.
´_tx_¿w
,

1145 
´obe
.
´_tx_¿wËn
, &´obe.
´_tx
))==
NULL
 ||

1146 
	`sÿm³r_Œaûbox_»cÜd_pkt
(
Œaûbox
, 
pkt
) != 0)

1148 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ecord…acket");

1149 
”r
;

1151 
¡©e
->
loİ
=0;

1155 
¡©e
->
©‹m±
++;

1156 if(
wa™
 > 0)

1157 
	`timev®_add_ms
(&
¡©e
->
timeout
, &
´obe
.
´_tx
, 
wa™
);

1159 
	`Œaûbox_queue
(
sk
);

1162 
”r
:

1163 
	`Œaûbox_hªdË”rÜ
(
sk
, 
”ºo
);

1165 
dÚe
:

1167 
	}
}

1169 
	$Œaûbox_·¿m_´obe_v®id©e
(* 
´obe
) {

1173 
	}
}

1175 
	$Œaûbox_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

1177 
tmp
;

1178 
İtid
)

1181 
TRACEBOX_OPT_PROXY_SECONDARY_DPORT
:

1182 
TRACEBOX_OPT_DPORT
:

1183 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0 ||mp > 65535)

1184 
”r
;

1187 
TRACEBOX_OPT_PROXY
:

1188 
TRACEBOX_OPT_IPV6
:

1189 
TRACEBOX_OPT_UDP
:

1190 
TRACEBOX_OPT_FRAGS
:

1191 
TRACEBOX_OPT_STATEFULL
:

1192 
TRACEBOX_OPT_SIMPLIFIED_OUTPUT
:

1193 
TRACEBOX_OPT_ICMP_QUOTE_TYPE
:

1194 
TRACEBOX_OPT_RTT
:

1195 
TRACEBOX_OPT_PYTHON_BINDINGS
:

1196 
tmp
=0;

1198 
TRACEBOX_OPT_PROBE
:

1199 ià(!
	`Œaûbox_·¿m_´obe_v®id©e
(
·¿m
))

1200 
”r
;

1208 if(
out
 !ğ
NULL
)

1209 *
out
 = 
tmp
;

1212 
”r
:

1214 
	}
}

1216 
	$sÿm³r_do_Œaûbox_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

1219  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

1220 
Œaûbox_¬g_·¿m_v®id©e
);

1221 
	}
}

1223 
	$Œaûbox_­p_deçuÉ
(
sÿm³r_Œaûbox_t
 *
Œaûbox
, 
Œaûbox_İtiÚs_t
 *
o
)

1227 if(
Œaûbox
->
dpÜt
 == 0)racebox->dport = 80;

1229 
Œaûbox
->
syn_»tx
 = 
TRACEBOX_SINGLE_HOP_MAX_REPLAYS
;

1232 ià(!
Œaûbox
->
udp
è
	`¿ndom_u32
(&Œaûbox->
£q
);

1234 ià(
Œaûbox
->
id
è
	`¿ndom_u32
(&Œaûbox->
id_v®ue
);

1236 ià(
Œaûbox
->
ts
) {

1237 
timev®
 
tv
;

1238 
	`g‘timeofday_w¿p
(&
tv
);

1239 
Œaûbox
->
tsv®
 = (
tv
.
tv_£c
è* 1000 +v.
tv_u£c
/1000.0;

1240 
Œaûbox
->
t£ü
 = (
tv
.
tv_£c
è* 1000 +v.
tv_u£c
/1000.0;

1243 ià(
Œaûbox
->
§ck
) {

1244 
	`¿ndom_u32
(&
Œaûbox
->
§ck_¦e
);

1245 
	`¿ndom_u32
(&
Œaûbox
->
§ck_¤e
);

1248 ià(
Œaûbox
->
mpjoš
) {

1249 
	`¿ndom_u32
(&
Œaûbox
->
»c_tok’
);

1250 
	`¿ndom_u32
(&
Œaûbox
->
£nd_ºum
);

1253 ià(
Œaûbox
->
mpÿ·bË
) {

1254 
	`¿ndom_u32
(&
Œaûbox
->
h_skey
);

1255 
	`¿ndom_u32
(&
Œaûbox
->
l_skey
);

1258 ià(
Œaûbox
->
md5
) {

1259 
i
;

1260 
i
=0;i<4;i++)

1261 
	`¿ndom_u32
(&(
Œaûbox
->
md5dige¡
[
i
]));

1264 ià(
Œaûbox
->
ao
) {

1265 
	`¿ndom_u8
(&
Œaûbox
->
aokeyid
);

1266 
	`¿ndom_u8
(&
Œaûbox
->
aÜÃxtkeyid
);

1267 
i
;

1268 
i
=0;i<4;i++)

1269 
	`¿ndom_u32
(&(
Œaûbox
->
aomac
[
i
]));

1275 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_PROXY
) {

1276 
Œaûbox
->
udp
=0;

1279 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_STATEFULL
) {

1280 
Œaûbox
->
udp
=0;

1281 
Œaûbox
->
£q
+=20;

1284 ià(
Œaûbox
->
´štmode
 =ğ
TRACEBOX_PRINT_MODE_FRAGS
) {

1285 
Œaûbox
->
udp
=0;

1286 
Œaûbox
->
id
=1;

1287 
	`¿ndom_u32
(&
Œaûbox
->
id_v®ue
);

1291 
	}
}

1293 
	$·r£_´obe
(
sÿm³r_Œaûbox_t
 *
Œaûbox
) {

1295 *
tok’
, *
subtok’
;

1296 cÚ¡ * 
d–im™”
 = "/";

1298 
tok’
 = 
	`¡¹ok
(
Œaûbox
->
´obe
, 
d–im™”
);

1300 
tok’
) {

1301 ià(!
	`¡rÿ£cmp
(
tok’
,"IP")è
Œaûbox
->
v6
 = 0;

1302 ià(!
	`¡rÿ£cmp
(
tok’
,"IPV6")è
Œaûbox
->
v6
 = 1;

1303 ià(!
	`¡rÿ£cmp
(
tok’
,"TCP")è
Œaûbox
->
udp
 = 0;

1304 ià(!
	`¡rÿ£cmp
(
tok’
,"UDP")è
Œaûbox
->
udp
 = 1;

1307 ià(!
	`¡rÿ£cmp
(
tok’
,"id")è
Œaûbox
->
id
 = 1;

1308 ià(!
	`¡rÿ£cmp
(
tok’
,"eù")è
Œaûbox
->
eù
 = 1;

1309 ià(!
	`¡rÿ£cmp
(
tok’
,"eû")è
Œaûbox
->
eû
 = 1;

1310 ià(!
	`¡rÿ£cmp
(
tok’
,"û")è
Œaûbox
->
û
 = 1;

1311 ià(!
	`¡rÿ£cmp
(
tok’
,"dsı")è
Œaûbox
->
dsı
 = 1;

1314 ià(!
	`¡rÿ£cmp
(
tok’
,"mss")è
Œaûbox
->
mss
 = 
TRACEBOX_DEFAULT_MSS
;

1315 ià(!
	`¡rÿ£cmp
(
tok’
,"wscale") || !strcasecmp(token,"windowscale"))

1316 
Œaûbox
->
wsÿË
 = 
TRACEBOX_DEFAULT_WSCALE
;

1317 ià(!
	`¡rÿ£cmp
(
tok’
,"mpÿ·bË")è
Œaûbox
->
mpÿ·bË
 = 1;

1318 ià(!
	`¡rÿ£cmp
(
tok’
,"mpjoš")è
Œaûbox
->
mpjoš
 = 1;

1319 ià(!
	`¡rÿ£cmp
(
tok’
,"§ck")è
Œaûbox
->
§ck
 = 1;

1320 ià(!
	`¡rÿ£cmp
(
tok’
,"§ckp")è
Œaûbox
->
§ckp
 = 1;

1321 ià(!
	`¡rÿ£cmp
(
tok’
,"ts") || !strcasecmp(token,"timestamp")

1322 ||!
	`¡rÿ£cmp
(
tok’
,"tstamp"))

1323 
Œaûbox
->
ts
 = 1;

1324 ià(!
	`¡rÿ£cmp
(
tok’
,"md5"))

1325 
Œaûbox
->
md5
 = 1;

1326 ià(!
	`¡rÿ£cmp
(
tok’
,"ao") || !strcasecmp(token,"auth")

1327 ||!
	`¡rÿ£cmp
(
tok’
,"tcpao"))

1328 
Œaûbox
->
ao
 = 1;

1330 
tok’
 = 
	`¡¹ok
(
NULL
, 
d–im™”
);

1334 
	}
}

1342 *
	$sÿm³r_do_Œaûbox_®loc
(*
¡r
)

1345 (* cÚ¡ 
­p_func
[])(
sÿm³r_Œaûbox_t
 *, 
Œaûbox_İtiÚs_t
 *) = {

1346 
NULL
,

1347 
Œaûbox_­p_deçuÉ
,

1349 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

1350 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
NULL
;

1351 
Œaûbox_İtiÚs_t
 
o
;

1352 
ušt16_t
 
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

1353 
ušt32_t
 
u£rid
 = 0;

1354 *
addr
;

1355 
tmp
 = 0;

1356 
af
;

1358 
	`mem£t
(&
o
, 0, (o));

1360 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

1362 
	`sÿm³r_debug
(
__func__
, "could‚ot…arse options");

1363 
”r
;

1367 if(
addr
 =ğ
NULL
)

1369 
	`sÿm³r_debug
(
__func__
, "no‡ddress…arameter");

1370 
”r
;

1374 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

1376 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

1377 
	`Œaûbox_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

1379 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

1380 
”r
;

1383 
İt
->
id
)

1385 
TRACEBOX_OPT_DPORT
:

1386 
o
.
dpÜt
 = (
ušt16_t
)
tmp
;

1389 
TRACEBOX_OPT_IPV6
:

1390 
o
.
v6
 = (
ušt8_t
)1;

1393 
TRACEBOX_OPT_UDP
:

1394 
o
.
udp
 = (
ušt8_t
)1;

1396 
TRACEBOX_OPT_RTT
:

1397 
o
.
¹t
 = (
ušt8_t
)1;

1399 
TRACEBOX_OPT_ICMP_QUOTE_TYPE
:

1400 
o
.
icmp_quÙe_ty³
 = (
ušt8_t
)1;

1402 
TRACEBOX_OPT_PYTHON_BINDINGS
:

1403 
o
.
pythÚ_bšdšgs
 = (
ušt8_t
)1;

1405 
TRACEBOX_OPT_PROXY_SECONDARY_DPORT
:

1406 
o
.
£cÚd¬y_dpÜt
=(
ušt16_t
)
tmp
;

1408 
TRACEBOX_OPT_PROBE
:

1409 
o
.
´obe
 = 
İt
->
¡r
;

1411 
TRACEBOX_OPT_FRAGS
:

1412 
o
.
´štmode
 = 
TRACEBOX_PRINT_MODE_FRAGS
;

1414 
TRACEBOX_OPT_PROXY
:

1415 
o
.
´štmode
 = 
TRACEBOX_PRINT_MODE_PROXY
;

1417 
TRACEBOX_OPT_STATEFULL
:

1418 
o
.
´štmode
 = 
TRACEBOX_PRINT_MODE_STATEFULL
;

1420 
TRACEBOX_OPT_SIMPLIFIED_OUTPUT
:

1421 
o
.
´štmode
 = 
TRACEBOX_PRINT_MODE_SIMPLIFIED_OUTPUT
;

1426 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

1436 if((
Œaûbox
 = 
	`sÿm³r_Œaûbox_®loc
()è=ğ
NULL
)

1438 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocracebox");

1439 
”r
;

1441 if((
Œaûbox
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
)è=ğ
NULL
)

1443 
	`´š‹¼Ü
(
EFAULT
, 
¡»¼Ü
, 
__func__
, "could‚Ù„esŞv%s", 
addr
);

1444 
”r
;

1447 
Œaûbox
->
¥Üt
 = sport;

1448 
Œaûbox
->
dpÜt
 = 
o
.dport;

1449 
Œaûbox
->
udp
 = 
o
.udp;

1450 
Œaûbox
->
v6
 = 
o
.ipv6;

1451 
Œaûbox
->
´obe
 = 
o
.probe;

1452 
Œaûbox
->
¹t
 = 
o
.rtt;

1453 
Œaûbox
->
icmp_quÙe_ty³
 = 
o
.icmp_quote_type;

1454 
Œaûbox
->
pythÚ_bšdšgs
 = 
o
.python_bindings;

1455 
Œaûbox
->
´štmode
 = 
o
.printmode;

1456 
Œaûbox
->
£cÚd¬y_dpÜt
 = 
o
.secondary_dport;

1458 if(
o
.
­p
 =ğ0èo.­°ğ
SCAMPER_TRACEBOX_APP_DEFAULT
;

1460 ià(
Œaûbox
->
´obe
 !ğ
NULL
è
	`·r£_´obe
(tracebox);

1469 if(
­p_func
[
SCAMPER_TRACEBOX_APP_DEFAULT
] !ğ
NULL
 &&‡µ_func[SCAMPER_TRACEBOX_APP_DEFAULT](
Œaûbox
, &
o
) != 0)

1470 
”r
;

1472  
Œaûbox
;

1474 
”r
:

1475 if(
Œaûbox
 !ğ
NULL
è
	`sÿm³r_Œaûbox_ä“
(tracebox);

1476 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

1477  
NULL
;

1478 
	}
}

1482 
	$sÿm³r_do_Œaûbox_ä“
(*
d©a
)

1484 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = (sÿm³r_Œaûbox_ˆ*)
d©a
;

1485 
	`sÿm³r_Œaûbox_ä“
(
Œaûbox
);

1487 
	}
}

1489 
sÿm³r_sk_t
 *
	$sÿm³r_do_Œaûbox_®loùask
(*
d©a
, 
sÿm³r_li¡_t
 *
li¡
,

1490 
sÿm³r_cyşe_t
 *
cyşe
)

1492 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = (sÿm³r_Œaûbox_ˆ*)
d©a
;

1493 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

1494 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

1497 if((
sk
 = 
	`sÿm³r_sk_®loc
(
d©a
, &
Œaûbox_funcs
)è=ğ
NULL
)

1498 
”r
;

1501 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

1502 
”r
;

1503 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
Œaûbox
->
d¡
);

1504 if(
Œaûbox
->
¤c
 =ğ
NULL
 && (Œaûbox->¤øğ
	`sÿm³r_g‘¤c
Ñ¿ûbox->
d¡
,0)) == NULL)

1505 
”r
;

1506 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
Œaûbox
->
¤c
);

1507 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

1508 
”r
;

1509 
sig
 = 
NULL
;

1512 
Œaûbox
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

1513 
Œaûbox
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

1515  
sk
;

1517 
”r
:

1518 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

1519 if(
sk
 !ğ
NULL
)

1521 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

1522 
	`sÿm³r_sk_ä“
(
sk
);

1524  
NULL
;

1525 
	}
}

1527 
	$sÿm³r_do_Œaûbox_ş—nup
()

1530 
	}
}

1532 
	$sÿm³r_do_Œaûbox_š™
()

1534 
Œaûbox_funcs
.
´obe
 = 
do_Œaûbox_´obe
;

1535 
Œaûbox_funcs
.
hªdË_icmp
 = 
NULL
;

1536 
Œaûbox_funcs
.
hªdË_dl
 = 
do_Œaûbox_hªdË_dl
;

1537 
Œaûbox_funcs
.
hªdË_timeout
 = 
do_Œaûbox_hªdË_timeout
;

1538 
Œaûbox_funcs
.
wr™e
 = 
do_Œaûbox_wr™e
;

1539 
Œaûbox_funcs
.
sk_ä“
 = 
do_Œaûbox_ä“
;

1540 
Œaûbox_funcs
.
h®t
 = 
do_Œaûbox_h®t
;

1543 
	}
}

	@tracebox/scamper_tracebox_do.h

33 #iâdeà
__SCAMPER_DO_TRACEBOX_H


34 
	#__SCAMPER_DO_TRACEBOX_H


	)

36 cÚ¡ *
sÿm³r_do_Œaûbox_u§ge
();

38 *
sÿm³r_do_Œaûbox_®loc
(*
¡r
);

40 
sÿm³r_do_Œaûbox_ä“
(*
d©a
);

42 
sÿm³r_sk_t
 *
sÿm³r_do_Œaûbox_®loùask
(*
d©a
,

43 
sÿm³r_li¡_t
 *
li¡
,

44 
sÿm³r_cyşe_t
 *
cyşe
);

46 
sÿm³r_do_Œaûbox_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

48 
sÿm³r_do_Œaûbox_ş—nup
();

49 
sÿm³r_do_Œaûbox_š™
();

	@tracebox/scamper_tracebox_text.c

9 #iâdeà
lšt


10 cÚ¡ 
	grcsid
[] =

14 #ifdeà
HAVE_CONFIG_H


15 
	~"cÚfig.h
"

17 
	~"š‹º®.h
"

19 
	~<¡ršg.h
>

21 
	~"sÿm³r_addr.h
"

22 
	~"sÿm³r_li¡.h
"

23 
	~"sÿm³r_fe.h
"

24 
	~"sÿm³r_Œaûbox.h
"

25 
	~"sÿm³r_Œaûbox_‹xt.h
"

26 
	~"sÿm³r_debug.h
"

27 
	~"uts.h
"

30 
	#TRACEBOX_MAX_TCP_OPTIONS
 64

	)

32 cÚ¡ 
	gmodes_Ën
 = 7;

33 cÚ¡ *
	gmodes
[] = {

37 
NULL
,

46 cÚ¡ 
	gtı_İtiÚs_max
 = 30;

47 cÚ¡ *
	gtı_İtiÚs
[] = {

73 
NULL
,

81 cÚ¡ 
	gf›lds_Ën
 = 37;

82 cÚ¡ *
	gf›lds
[] = {

122 
ušt8_t
 
	gf›lds_size
[] = {

162 cÚ¡ 
	gtı_f›lds_Ën
 = 10;

163 cÚ¡ *
	gtı_f›lds
[] = {

176 cÚ¡ 
	gudp_f›lds_Ën
 = 4;

177 cÚ¡ *
	gudp_f›lds
[] = {

184 cÚ¡ 
	gv6_f›lds_Ën
 = 9;

185 cÚ¡ *
	gv6_f›lds
[] = {

197 cÚ¡ 
	gv4_f›lds_Ën
 = 13;

198 cÚ¡ *
	gv4_f›lds
[] = {

214 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_¡ªd¬d
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
) {

216 
sÿm³r_Œaûbox_pkt_t
 *
pkt
, *
´ev_pkt
 = 
NULL
;

218 
addr
[64], *
cmp_»suÉ
;

219 
timev®
 
diff
;

220 
ušt32_t
 
i
, 
£q
, 
ack
, 
off
;

221 
ušt16_t
 
Ën
;

222 
ušt8_t
 
´Ùo
, 
æags
, 
ty³
, 
hËn
, 
tıhËn
, *
±r
, 
‰l
, 
v
, 
´ev_qu”y
 = 0, 
syÇcked
 = 0;

223 
äag
, 
couÁ”
 = 1;

225 
i
=0; i<
Œaûbox
->
pktc
; i++)

227 
pkt
 = 
Œaûbox
->
pkts
[
i
];

228 
off
 = 0;
v
 = 0;

230 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 4)

232 
v
 = 4;

233 
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

234 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

235 
´Ùo
 = 
pkt
->
d©a
[9];

236 
‰l
=
pkt
->
d©a
[8];

237 
off
 = (
	`by‹s_Áohs
(
pkt
->
d©a
+6) & 0x1fff) * 8;

239 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 6)

241 
v
 = 6;

242 
hËn
 = 40;

243 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4è+ 
hËn
;

244 
´Ùo
 = 
pkt
->
d©a
[6];

245 
‰l
ğ
pkt
->
d©a
[7];

247 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

251 
_¡¬t
, 
Œªs_¡¬t
, 
dËn
;

252 ià(
syÇcked
) {

253 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

257 if(
´Ùo
 =ğ
IPPROTO_TCP
)

259 
æags
 = 
pkt
->
d©a
[
hËn
+13];

260 
tıhËn
 = ((
pkt
->
d©a
[
hËn
+12] & 0xf0) >> 4) * 4;

262 if(
æags
 & 0x02) {

264 if(
æags
 & 0x10) {

266 ià(
v
 == 4) {

267 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
,
pkt
->
d©a
+12);

268 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

269 
	`sÿm³r_addr_ä“
(
a
);

270 } ià(
v
 == 6) {

271 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
,
pkt
->
d©a
+8);

272 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

273 
	`sÿm³r_addr_ä“
(
a
);

276 
cmp_»suÉ
 = 
	`compu‹_difã»nûs
(
Œaûbox
, 
´ev_pkt
->
d©a
, 
pkt
->data,

277 
SCAMPER_TRACEBOX_ANSWER_SYNACK
, 
v
, 
´Ùo
);

278 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " %s", 
addr
);

279 ià(
Œaûbox
->
¹t
)

280 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " RTT:%.4f",

281 (((
pkt
->
tv
.
tv_£c
 - 
´ev_pkt
->tv.tv_£c)*1000000L+pkt->tv.
tv_u£c
) -…rev_pkt->tv.tv_usec)/1000.0);

282 ià(
cmp_»suÉ
) {

283 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, 
cmp_»suÉ
);

284 
	`ä“
(
cmp_»suÉ
);

286 
syÇcked
=1;

287 } ià(!(
æags
 & 0x01) && !(flags & 0x04)) {

289 ià(
´ev_qu”y
) {

290 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " *\n");

291 
couÁ”
++;

293 ià(
couÁ”
<10è
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " ", counter);

294 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " %d:", 
couÁ”
);

295 
´ev_pkt
 = 
pkt
;

297 
´ev_qu”y
=(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
);

300 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

305 } if(
æags
 & 0x01)

306 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " FIN");

307 if(
æags
 & 0x04)

308 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " RST");

310 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

315 } if(
´Ùo
 =ğ
IPPROTO_ICMP
) {

316 
´ev_qu”y
=0;

318 
ušt8_t
 
icmp_ty³
 = 
pkt
->
d©a
[
hËn
];

319 
ušt8_t
 
icmp_code
 = 
pkt
->
d©a
[
hËn
+1];

320 
_¡¬t
 = 
hËn
+8;

321 
Œªs_¡¬t
 = 
_¡¬t
+20;

322 
dËn
 = 
Ën
-
_¡¬t
;

324 ià(
icmp_ty³
 =ğ11 && 
icmp_code
 == 0) {

326 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
,
pkt
->
d©a
+12);

327 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

328 
	`sÿm³r_addr_ä“
(
a
);

329 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " % ", 
addr
);

331 ià(
Ën
-
_¡¬t
 <= 0) {

332 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_EMPTY
;

333 ià(
Œaûbox
->
icmp_quÙe_ty³
)

334 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(0)");

335 }ià(
Ën
-
Œªs_¡¬t
 <= 0) {

336 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
;

337 ià(
Œaûbox
->
icmp_quÙe_ty³
)

338 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(L3)");

339 }ià(
Ën
-
Œªs_¡¬t
 == 8) {

340 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_8B
;

341 ià(
Œaûbox
->
icmp_quÙe_ty³
)

342 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(8B)");

344 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_FULL
;

345 ià(
Œaûbox
->
icmp_quÙe_ty³
)

346 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(full)");

349 ià(
Œaûbox
->
¹t
)

350 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " RTT:%.4f",

351 (((
pkt
->
tv
.
tv_£c
 - 
´ev_pkt
->tv.tv_£c)*1000000L+pkt->tv.
tv_u£c
) -…rev_pkt->tv.tv_usec)/1000.0);

352 
cmp_»suÉ
 = 
	`compu‹_difã»nûs
(
Œaûbox
, 
´ev_pkt
->
d©a
, &(
pkt
->d©a[
_¡¬t
]),

353 
ty³
, 
v
, 
Œaûbox
->
udp
 ? 
IPPROTO_UDP
 : 
IPPROTO_TCP
);

354 ià(
cmp_»suÉ
) {

355 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, 
cmp_»suÉ
);

356 
	`ä“
(
cmp_»suÉ
);

358 } ià(
icmp_ty³
 == 3) {

359 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "Destination unreachable\n");

361 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

366 } if(
´Ùo
 =ğ
IPPROTO_UDP
) {

368 ià(
´ev_qu”y
) {

369 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " *\n");

370 
couÁ”
++;

372 ià(
couÁ”
<10è
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " ", counter);

373 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " %d:", 
couÁ”
);

375 
´ev_pkt
 = 
pkt
;

376 
´ev_qu”y
=(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
);

379 } if(
´Ùo
 =ğ
IPPROTO_ICMPV6
) {

380 
´ev_qu”y
=0;

382 
ušt8_t
 
ty³
 = 
pkt
->
d©a
[
hËn
];

383 
ušt8_t
 
code
 = 
pkt
->
d©a
[
hËn
+1];

384 
_¡¬t
 = 
hËn
+8;

385 
Œªs_¡¬t
 = 
_¡¬t
+40;

386 
dËn
 = 
Ën
-
_¡¬t
;

388 ià(
ty³
 =ğ3 && 
code
 == 0) {

389 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
,
pkt
->
d©a
+8);

390 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

391 
	`sÿm³r_addr_ä“
(
a
);

392 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " % ", 
addr
);

394 ià(
Ën
-
_¡¬t
 <= 0) {

395 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_EMPTY
;

396 ià(
Œaûbox
->
icmp_quÙe_ty³
)

397 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(0)");

398 }ià(
Ën
-
Œªs_¡¬t
 <= 0){

399 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
;

400 ià(
Œaûbox
->
icmp_quÙe_ty³
)

401 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(L3)");

402 }ià(
Ën
-
Œªs_¡¬t
 == 8) {

403 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_8B
;

404 ià(
Œaûbox
->
icmp_quÙe_ty³
)

405 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(8B)");

407 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_FULL
;

408 ià(
Œaûbox
->
icmp_quÙe_ty³
)

409 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "(full)");

411 ià(
Œaûbox
->
¹t
)

412 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " RTT:%.4f",

413 (((
pkt
->
tv
.
tv_£c
 - 
´ev_pkt
->tv.tv_£c)*1000000L+pkt->tv.
tv_u£c
) -…rev_pkt->tv.tv_usec)/1000.0);

414 
cmp_»suÉ
 = 
	`compu‹_difã»nûs
(
Œaûbox
, 
´ev_pkt
->
d©a
, &(
pkt
->d©a[
_¡¬t
]),

415 
ty³
, 
v
, 
Œaûbox
->
udp
 ? 
IPPROTO_UDP
 : 
IPPROTO_TCP
);

416 ià(
cmp_»suÉ
) {

417 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, 
cmp_»suÉ
);

418 
	`ä“
(
cmp_»suÉ
);

421 } ià(
ty³
 == 1) {

422 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "Destination unreachable\n");

424 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "ƒrroneous…acket\n");

429 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "\n");

430 
couÁ”
++;

431 
´ev_pkt
 = 
pkt
;

435 ià(
Œaûbox
->
»suÉ
 =ğ
SCAMPER_TRACEBOX_RESULT_TIMEOUT
)

436 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " *\n");

437 ià(
Œaûbox
->
»suÉ
 =ğ
SCAMPER_TRACEBOX_RESULT_TIMEOUT
)

440 
	}
}

442 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_fuÎ_icmp
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
) {

443 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

445 
addr
[64];

446 
ušt32_t
 
i
;

447 
ušt16_t
 
Ën
;

448 
ušt8_t
 
´Ùo
,
hËn
, 
tıhËn
, 
‰l
, 
v
, 
Ï¡_‰l
;

450 
i
=0; i<
Œaûbox
->
pktc
; i++)

452 
pkt
 = 
Œaûbox
->
pkts
[
i
];

453 
v
 = 0;

455 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 4) {

456 
v
 = 4;

457 
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

458 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

459 
´Ùo
 = 
pkt
->
d©a
[9];

460 
‰l
=
pkt
->
d©a
[8];

461 } if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 6) {

462 
v
 = 6;

463 
hËn
 = 40;

464 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4è+ 
hËn
;

465 
´Ùo
 = 
pkt
->
d©a
[6];

466 
‰l
ğ
pkt
->
d©a
[7];

469 if(
´Ùo
 =ğ
IPPROTO_TCP
 ||…rÙØ=ğ
IPPROTO_UDP
è
Ï¡_‰l
=
‰l
;

470 if(
´Ùo
 =ğ
IPPROTO_ICMP
) {

472 
ušt8_t
 
ty³
 = 
pkt
->
d©a
[
hËn
];

473 
ušt8_t
 
code
 = 
pkt
->
d©a
[
hËn
+1];

474 ià(
ty³
 =ğ11 && 
code
 == 0) {

476 
_¡¬t
 = 
hËn
+8;

477 
Œªs_¡¬t
 = 
_¡¬t
+20;

479 ià(
Ën
-
Œªs_¡¬t
 > 8) {

480 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
,
pkt
->
d©a
+12);

481 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

482 
	`sÿm³r_addr_ä“
(
a
);

484 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " %d: %s\n",
Ï¡_‰l
, 
addr
);

488 } if(
´Ùo
 =ğ
IPPROTO_ICMPV6
) {

490 
ušt8_t
 
ty³
 = 
pkt
->
d©a
[
hËn
];

491 
ušt8_t
 
code
 = 
pkt
->
d©a
[
hËn
+1];

492 ià(
ty³
 =ğ3 && 
code
 == 0) {

494 
_¡¬t
 = 
hËn
+8;

495 
Œªs_¡¬t
 = 
_¡¬t
+40;

497 ià(
Ën
-
Œªs_¡¬t
 > 8) {

498 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
,
pkt
->
d©a
+8);

499 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

500 
	`sÿm³r_addr_ä“
(
a
);

501 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " %d: %s\n",
Ï¡_‰l
, 
addr
);

508 
	}
}

510 
ušt8_t
 **
	$·r£_·ck‘
(cÚ¡ 
ušt8_t
 
ÃtwÜk
, cÚ¡ ušt8_ˆ
Œª¥Üt
, cÚ¡ ušt8_ˆ
ty³
, cÚ¡ ušt8_ˆ*
pkt
) {

511 
Œªsoff
 = (
ÃtwÜk
 == 4) ? 20 : 40;

512 
ušt8_t
 **
µkt
 = 
	`m®loc
(
f›lds_Ën
 * (ušt8_t*)), 
i
;

513 
i
=0;i<
f›lds_Ën
-1;i++)

514 
µkt
[
i
]=
	`ÿÎoc
(
f›lds_size
[i],(
ušt8_t
));

515 
µkt
[
f›lds_Ën
-1]=
NULL
;

517 
ty³
) {

518 
SCAMPER_TRACEBOX_ANSWER_FULL
:

519 ià(
Œª¥Üt
 =ğ
IPPROTO_TCP
) {

521 
i
=8;i<12;i++è
µkt
[0][i-8] = 
pkt
[
Œªsoff
];

522 
µkt
[1][0] = (
pkt
[
Œªsoff
+12] & 0xf0) >> 4;

523 
µkt
[2][0] = 
pkt
[
Œªsoff
+12] & 0x0f;

524 
µkt
[3][0] = 
pkt
[
Œªsoff
+13];

525 
µkt
[4][0] = 
pkt
[
Œªsoff
+14];…pkt[4][1] =…kt[transoff+15];

526 
µkt
[5][0] = 
pkt
[
Œªsoff
+16];…pkt[5][1] =…kt[transoff+17];

527 
µkt
[6][0] = 
pkt
[
Œªsoff
+18];…pkt[6][1] =…kt[transoff+19];

529 
ušt8_t
 
tı_İt_by‹s
 = (
µkt
[1][0] - 5)*4;

530 
f›lds_size
[
f›lds_Ën
-1] = 
tı_İt_by‹s
;

531 ià(
tı_İt_by‹s
>0) {

532 
İtoff
 = 
Œªsoff
+20;

533 
µkt
[
f›lds_Ën
-1] = 
	`ÿÎoc
(
tı_İt_by‹s
,(
ušt8_t
));

534 
i
=0;i<
tı_İt_by‹s
;i++è
µkt
[
f›lds_Ën
-1][i] = 
pkt
[
İtoff
+i];

537 
SCAMPER_TRACEBOX_ANSWER_8B
:

538 ià(
Œª¥Üt
 =ğ
IPPROTO_TCP
) {

539 
µkt
[7][0] = 
pkt
[
Œªsoff
];…pkt[7][1] =…kt[transoff+1];

540 
µkt
[8][0] = 
pkt
[
Œªsoff
+2];ppkt[8][1] =…kt[transoff+3];

541 
i
=4;i<8;i++è
µkt
[9][i-4] = 
pkt
[
Œªsoff
+i];

542 } ià(
Œª¥Üt
 =ğ
IPPROTO_UDP
) {

543 
µkt
[10][0] = 
pkt
[
Œªsoff
];…pkt[10][1] =…kt[transoff+1];

544 
µkt
[11][0] = 
pkt
[
Œªsoff
+2];ppkt[11][1] =…kt[transoff+3];

545 
µkt
[12][0] = 
pkt
[
Œªsoff
+4];ppkt[12][1] =…kt[transoff+5];

546 
µkt
[13][0] = 
pkt
[
Œªsoff
+6];ppkt[13][1] =…kt[transoff+7];

548 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
:

549 ià(
ÃtwÜk
 == 4) {

550 (
µkt
[23][0] = 
pkt
[0] & 0xf0) >> 4;

551 
µkt
[24][0] = 
pkt
[0] & 0x0f;

552 
µkt
[25][0] = (
pkt
[1] & 0xfc) >> 2;

553 
µkt
[26][0] = 
pkt
[1] & 0x03;

554 
µkt
[27][0] = 
pkt
[2];…pkt[27][1] =…kt[3];

555 
µkt
[28][0] = 
pkt
[4];…pkt[28][1] =…kt[5];

556 
µkt
[29][0] = (
pkt
[6] & 0xe0) >> 5;

557 
µkt
[30][0] = 
pkt
[6] & 0x1f;

558 
µkt
[30][1] = 
pkt
[7];

559 
µkt
[31][0] = 
pkt
[8];

560 
µkt
[32][0] = 
pkt
[9];

561 
µkt
[33][0] = 
pkt
[10];…pkt[33][1] =…kt[11];

562 
i
=12;i<16;i++è
µkt
[34][i-12] = 
pkt
[i];

563 
i
=16;i<20;i++è
µkt
[35][i-16] = 
pkt
[i];

564 } ià(
ÃtwÜk
 == 6) {

565 
µkt
[14][0] = (
pkt
[0] & 0xf0) >> 4;

566 
µkt
[15][0] = ((
pkt
[0] & 0x0f)<<2) | ((pkt[1] & 0xc0)>>6);

567 
µkt
[16][0] = (
pkt
[1] & 0x30)>>4;

568 
µkt
[17][0] = 
pkt
[1] & 0x0f;

569 
µkt
[17][1] = 
pkt
[2];…pkt[17][2] =…kt[3];

570 
µkt
[18][0] = 
pkt
[4];…pkt[18][1] =…kt[5];

571 
µkt
[19][0] = 
pkt
[6];

572 
µkt
[20][0] = 
pkt
[7];

573 
i
=8;i<24;i++è
µkt
[21][i-8] = 
pkt
[i];

574 
i
=24;i<40;i++è
µkt
[22][i-24] = 
pkt
[i];

580  
µkt
;

581 
	}
}

583 
	$ä“_¬¿y
(
ušt8_t
 **
µkt
, 
Ën
) {

584 ià(!
µkt
) ;

585 
ušt8_t
 
i
;

586 
i
=0;i<
Ën
;i++) {

587 ià(
µkt
[
i
]è
	`ä“
(ppkt[i]);

589 
	`ä“
(
µkt
);

590 
	}
}

595 *
	$Ï¡_ob£rved_v®ue
(
ušt8_t
 *
dËns
, **
addrs
, ušt8_ˆ
šdex
, ušt8_ˆ
f›ld
) {

597 
i
;

598 
ušt8_t
 
mš_ty³
;

600 ià(
f›ld
>=14è
mš_ty³
 = 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
;

601 ià(
f›ld
>=7è
mš_ty³
 = 
SCAMPER_TRACEBOX_ANSWER_8B
;

602 
mš_ty³
 = 
SCAMPER_TRACEBOX_ANSWER_FULL
;

604 
i
=
šdex
;i>=0;i--) {

605 ià(
dËns
[
i
] >ğ
mš_ty³
è 
addrs
[i];

609 
	}
}

618 
ušt8_t
 **
	$com·»_tı_İt
(cÚ¡ 
ušt8_t
 *
İi¡1
, cÚ¡ ušt8_ˆ*
İi¡2
, ušt8_ˆ
Î’1
, ušt8_ˆ
Î’2
) {

619 
ušt8_t
 **
diff
 = 
	`m®loc
(4*(uint8_t*));

620 
i
, 
j
=0, 
found
 = 0, 
modif›d
 = 0, 
Ën1
, 
Ën2
;

621 
diff
[0]=
	`ÿÎoc
(3,1);

622 
i
=1;i<4;i++)

623 
diff
[
i
]ğ
	`ÿÎoc
(
TRACEBOX_MAX_TCP_OPTIONS
,1);

625 
ušt8_t
 
İt_li¡
[
TRACEBOX_MAX_TCP_OPTIONS
], 
İt_couÁ
=0;

626 
İt_couÁ
=0;İt_couÁ<
TRACEBOX_MAX_TCP_OPTIONS
;opt_count++)

627 
İt_li¡
[
İt_couÁ
]=0;

628 
İt_couÁ
=0;
i
=0;

630 
i
<
Î’1
) {

631 
ušt8_t
 
ty³1
 = 
İi¡1
[
i
];

632 
ty³1
) {

635 
i
++;

642 
j
 = 0;
found
 = 0; 
modif›d
 = 0;

643 
Ën1
 = 
İi¡1
[
i
+1];

644 
İt_li¡
[
İt_couÁ
++] = 
ty³1
;

646 
j
<
Î’2
) {

647 
ušt8_t
 
ty³2
 = 
İi¡2
[
j
];

648 
ty³2
) {

650 
j
++;

657 
Ën2
 = 
İi¡2
[
j
+1];

658 ià(!
Ën2
)†en2++;

659 ià(
ty³2
 =ğ
ty³1
) {

660 
k
=0;

661 
found
 = 1;

662 ià(
Ën1
 !ğ
Ën2
è
modif›d
 = 1;

664 
k
=0;k<
Ën1
;k++) {

665 ià(
İi¡1
[
i
+
k
] !ğ
İi¡2
[
j
+k]) {

666 
modif›d
 = 1;

671 ià(
k
==
Ën1
) {

672 
modif›d
 = 0;

673 
j
=
Î’2
;

678 
j
+=
Ën2
;

681 
j
++;

687 ià(!
found
è
diff
[2][diff[0][1]++]=
ty³1
;

688 ià(
modif›d
è
diff
[1][diff[0][0]++]=
ty³1
;

690 
i
+=
Ën1
;

693 
i
++;

700 
j
 = 0;

701 
j
<
Î’2
) {

702 
ušt8_t
 
ty³2
 = 
İi¡2
[
j
];

703 
ty³2
) {

706 
j
++;

713 
found
 = 0;

714 
Ën2
 = 
İi¡2
[
j
+1];

715 ià(!
Ën2
)†en2++;

716 
i
=0; i<
İt_couÁ
; i++) {

717 ià(
İt_li¡
[
i
] =ğ
ty³2
è
found
 = 1;

719 ià(!
found
è
diff
[3][diff[0][2]++]=
ty³2
;

721 
j
+=
Ën2
;

724 
j
++;

729  
diff
;

730 
	}
}

732 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_sim¶if›d
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
, * 
d¡
) {

733 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

735 
addr
[64];

736 
ušt32_t
 
i
, 
off
, 
nb_by‹s
;

737 
ušt16_t
 
Ën
;

738 
ušt8_t
 
´Ùo
, 
hËn
, 
tıhËn
, 
v
, 
tı_İt
, 
‰l
, 
max_‰l
, 
chªged
=0, 
ªsw”ed
=0, 
´ev_´Ùo
, 
ty³
, 
‰l_šdex
 = 0;

739 
ušt8_t
 
icmp_dËn
=
SCAMPER_TRACEBOX_ANSWER_EMPTY
, 
´ev_icmp_dËn
=SCAMPER_TRACEBOX_ANSWER_EMPTY;

740 
ušt8_t
 **
»cv_µkt
 = 
NULL
, **
Ï¡v®ue_µkt
 = NULL;

743 
i
=0; i<
Œaûbox
->
pktc
; i++) {

744 
pkt
 = 
Œaûbox
->
pkts
[
i
];

745 if(((
pkt
->
d©a
[0] & 0xf0è>> 4è=ğ4è
‰l
=pkt->data[8];

746 if(((
pkt
->
d©a
[0] & 0xf0è>> 4è=ğ6è
‰l
=…kt->data[7];

748 ià(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
è
max_‰l
=
‰l
;

752 
ušt8_t
 *
dËns
 = 
	`ÿÎoc
(
max_‰l
,1);

754 **
addrs
 = 
	`m®loc
(
max_‰l
 * (*));

755 
i
=0; i<
max_‰l
; i++è
addrs
[i] = 
	`m®loc
(64*());

757 
i
=0; i<
Œaûbox
->
pktc
; i++) {

758 
pkt
 = 
Œaûbox
->
pkts
[
i
];

759 
off
 = 0;
v
 = 0;

761 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 4) {

762 
v
 = 4;

763 
hËn
 = (
pkt
->
d©a
[0] & 0xf) * 4;

764 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+2);

765 
‰l
=
pkt
->
d©a
[8];

766 
´Ùo
 = 
pkt
->
d©a
[9];

767 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV4
,
pkt
->
d©a
+12);

768 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

769 
	`sÿm³r_addr_ä“
(
a
);

770 
off
 = (
	`by‹s_Áohs
(
pkt
->
d©a
+6) & 0x1fff) * 8;

771 } if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 6) {

772 
v
 = 6;

773 
hËn
 = 40;

774 
Ën
 = 
	`by‹s_Áohs
(
pkt
->
d©a
+4è+ 
hËn
;

775 
´Ùo
 = 
pkt
->
d©a
[6];

776 
‰l
ğ
pkt
->
d©a
[7];

777 
sÿm³r_addr_t
 *
a
=
	`sÿm³r_addr_®loc
(
SCAMPER_ADDR_TYPE_IPV6
,
pkt
->
d©a
+8);

778 
	`sÿm³r_addr_to¡r
(
a
,
addr
,(addr));

779 
	`sÿm³r_addr_ä“
(
a
);

782 if(
´Ùo
 =ğ
IPPROTO_TCP
 ||…rÙØ=ğ
IPPROTO_UDP
) {

784 ià(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
) {

785 ià(
‰l_šdex
 =ğ0è
Ï¡v®ue_µkt
 = 
	`·r£_·ck‘
(
v
, 
´Ùo
, 
SCAMPER_TRACEBOX_ANSWER_FULL
, 
pkt
->
d©a
);

786 
´ev_´Ùo
 = 
´Ùo
;

789 ià(
»cv_µkt
è
	`ä“_¬¿y
Ôecv_µkt,
f›lds_Ën
);

790 
»cv_µkt
 = 
	`·r£_·ck‘
(
v
, 
´Ùo
, 
SCAMPER_TRACEBOX_ANSWER_FULL
, 
pkt
->
d©a
);

792 if(
»cv_µkt
[3][0] & 0x12) {

794 
šdex
;

795 
ušt8_t
 **
diff
 = 
	`com·»_tı_İt
(
Ï¡v®ue_µkt
[
f›lds_Ën
-1], 
»cv_µkt
[fields_len-1],

796 (
Ï¡v®ue_µkt
[1][0]-5)*4, (
»cv_µkt
[1][0]-5)*4);

797 ià(
diff
[0][0]) {

798 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " The destination host modified");

799 
šdex
=0;šdex<
diff
[0][0];index++)

800 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[1][
šdex
]]);

801 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "\n");

803 ià(
diff
[0][1]) {

804 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " The destination host„emoved");

805 
šdex
=0;šdex<
diff
[0][1];index++)

806 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[2][
šdex
]]);

807 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "\n");

809 ià(
diff
[0][2]) {

810 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " The destination host‡dded");

811 
šdex
=0;šdex<
diff
[0][2];index++)

812 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[3][
šdex
]]);

813 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "\n");

815 
	`ä“_¬¿y
(
diff
,4);

819 } if(
´Ùo
 =ğ
IPPROTO_ICMP
) {

821 
ušt8_t
 
icmp_ty³
 = 
pkt
->
d©a
[
hËn
];

822 
ušt8_t
 
icmp_code
 = 
pkt
->
d©a
[
hËn
+1];

824 
_¡¬t
 = 
hËn
+8;

825 
Œªs_¡¬t
 = 
_¡¬t
+20;

826 
dËn
 = 
Ën
-
_¡¬t
;

828 ià(
icmp_ty³
 =ğ11 && 
icmp_code
 == 0) {

829 ià(
»cv_µkt
è
	`ä“_¬¿y
Ôecv_µkt,
f›lds_Ën
);

831 
i
, 
j
;

832 ià(
Ën
-
_¡¬t
 <= 0) {

833 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_EMPTY
; 
i
=
f›lds_Ën
;

834 } ià(
Ën
-
Œªs_¡¬t
 <= 0) {

836 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
; 
i
=14;

837 } ià(
Ën
-
Œªs_¡¬t
 == 8) {

838 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_8B
; 
i
=7;

840 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_FULL
; 
i
=0;

843 
»cv_µkt
 = 
	`·r£_·ck‘
(
v
, 
´ev_´Ùo
, 
ty³
, &(
pkt
->
d©a
[
_¡¬t
]));

844 
dËns
[
‰l_šdex
] = 
ty³
;

845 
	`¡ºıy
(
addrs
[
‰l_šdex
++],
addr
,64);

846 
ªsw”ed
=1;

848 ;
i
<
f›lds_Ën
;i++) {

849 ià(
i
 == 31 || i == 33) ;

850 ià(
i
==36) {

851 ià(
ty³
 !ğ
SCAMPER_TRACEBOX_ANSWER_FULL
) ;

852 ià(!
Ï¡v®ue_µkt
[
i
] && !
»cv_µkt
[i]) ;

854 ià(
Ï¡v®ue_µkt
[1][0] !ğ
»cv_µkt
[1][0]) {

855 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " w¬nšg:ı o±iÚ Ëngth chªg(%d)\n",
‰l_šdex
);

859 
ušt8_t
 **
diff
 = 
	`com·»_tı_İt
(
Ï¡v®ue_µkt
[
i
], 
»cv_µkt
[i], (lastvalue_ppkt[1][0]-5)*4, (recv_ppkt[1][0]-5)*4);

861 ià((
diff
[0][0] || diff[0][1]) || diff[0][2]) {

862 
ušt8_t
 
šdex
;

863 
šdex
=0;šdex<
diff
[0][0];index++)

864 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Th%s::% f›ld wa modif›d b‘w“À% ªd % (%d)\n",
f›lds
[
i
],
tı_İtiÚs
[
diff
[1][
šdex
]], !
ªsw”ed
 ? "you" : 
	`Ï¡_ob£rved_v®ue
(
dËns
, 
addrs
, 
‰l_šdex
-2, iè,
addr
,tl_index-1);

865 
šdex
=0;šdex<
diff
[0][1];index++)

866 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Th%s::% f›ld wa »moved b‘w“À% ªd % (%d)\n",
f›lds
[
i
],
tı_İtiÚs
[
diff
[2][
šdex
]], !
ªsw”ed
 ? "you" : 
	`Ï¡_ob£rved_v®ue
(
dËns
, 
addrs
, 
‰l_šdex
-2, iè,
addr
,tl_index-1);

867 
šdex
=0;šdex<
diff
[0][2];index++)

868 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Th%s::% f›ld wa added b‘w“À% ªd % (%d)\n",
f›lds
[
i
],
tı_İtiÚs
[
diff
[3][
šdex
]], !
ªsw”ed
 ? "you" : 
	`Ï¡_ob£rved_v®ue
(
dËns
, 
addrs
, 
‰l_šdex
-2, iè,
addr
,tl_index-1);

870 
j
=0;j<
f›lds_size
[
i
];j++è
Ï¡v®ue_µkt
[i][j] = 
»cv_µkt
[i][j];

871 
chªged
=1;

874 
	`ä“_¬¿y
(
diff
,4);

878 
j
=0;j<
f›lds_size
[
i
];j++) {

879 ià(
Ï¡v®ue_µkt
[
i
][
j
] !ğ
»cv_µkt
[i][j]) {

880 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Th% f›ld chªged b‘w“À% ªd % (%d)\n",
f›lds
[
i
], (!
ªsw”ed
 || 
‰l_šdex
<2è? "you" : 
	`Ï¡_ob£rved_v®ue
(
dËns
, 
addrs
,_šdex-2, iè,
addr
,ttl_index);

882 
j
=0;j<
f›lds_size
[
i
];j++è
Ï¡v®ue_µkt
[i][j] = 
»cv_µkt
[i][j];

883 
chªged
=1;

890 } if(
´Ùo
 =ğ
IPPROTO_ICMPV6
) {

892 
ušt8_t
 
icmp_ty³
 = 
pkt
->
d©a
[
hËn
];

893 
ušt8_t
 
icmp_code
 = 
pkt
->
d©a
[
hËn
+1];

895 
_¡¬t
 = 
hËn
+8;

896 
Œªs_¡¬t
 = 
_¡¬t
+40;

897 
dËn
 = 
Ën
-
_¡¬t
;

899 ià(
icmp_ty³
 =ğ3 && 
icmp_code
 == 0) {

900 ià(
»cv_µkt
è
	`ä“_¬¿y
Ôecv_µkt,
f›lds_Ën
);

901 
ty³
 = 
SCAMPER_TRACEBOX_ANSWER_FULL
;

902 
»cv_µkt
 = 
	`·r£_·ck‘
(
v
, 
´ev_´Ùo
, 
ty³
, &(
pkt
->
d©a
[
_¡¬t
]));

903 
	`¡ºıy
(
addrs
[
‰l_šdex
++],
addr
,64);

904 
ªsw”ed
=1;

905 
i
 = 0, 
j
;

906 ;
i
<
f›lds_Ën
;i++) {

907 ià(
i
 == 20) ;

908 ià(
i
 == 36) {

910 ià(
ty³
 !ğ
SCAMPER_TRACEBOX_ANSWER_FULL
) ;

911 ià(!
Ï¡v®ue_µkt
[
i
] && !
»cv_µkt
[i]) ;

912 ià(
Ï¡v®ue_µkt
[1][0] !ğ
»cv_µkt
[1][0]) {

913 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, "w¬nšg:ı o±iÚ Ëngth chªg(%d)\n",
‰l_šdex
);

917 
ušt8_t
 **
diff
 = 
	`com·»_tı_İt
(
Ï¡v®ue_µkt
[
i
], 
»cv_µkt
[i], (lastvalue_ppkt[1][0]-5)*4, (recv_ppkt[1][0]-5)*4);

918 ià((
diff
[0][0] || diff[0][1]) || diff[0][2]) {

919 
ušt8_t
 
šdex
;

920 
šdex
=0;šdex<
diff
[0][0];index++)

921 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " ThTCP::O±iÚs::% f›ld wa modif›d‡ˆ% (%d)\n",
tı_İtiÚs
[
diff
[1][
šdex
]], 
addrs
[
‰l_šdex
-1 < 0 ? 0 :tl_index-1],tl_index-1);

922 
šdex
=0;šdex<
diff
[0][1];index++)

923 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " ThTCP::O±iÚs::% f›ld wa »moved‡ˆ% (%d)\n",
tı_İtiÚs
[
diff
[2][
šdex
]], 
addrs
[
‰l_šdex
-1 < 0 ? 0 :tl_index-1],tl_index-1);

924 
šdex
=0;šdex<
diff
[0][2];index++)

925 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " ThTCP::O±iÚs::% f›ld wa added‡ˆ% (%d)\n",
tı_İtiÚs
[
diff
[3][
šdex
]], 
addrs
[
‰l_šdex
-1 < 0 ? 0 :tl_index-1],tl_index-1);

927 
j
=0;j<
f›lds_size
[
i
];j++è
Ï¡v®ue_µkt
[i][j] = 
»cv_µkt
[i][j];

928 
chªged
=1;

930 
	`ä“_¬¿y
(
diff
,4);

934 
j
=0;j<
f›lds_size
[
i
];j++) {

935 ià(
Ï¡v®ue_µkt
[
i
][
j
] !ğ
»cv_µkt
[i][j]) {

936 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Th% f›ld wa modif›d‡ˆ% (%d)\n",
f›lds
[
i
], !
ªsw”ed
 ? "your£lf" : 
addrs
[
‰l_šdex
-2 < 0 ? 0 :tl_index-2] ,ttl_index-1);

938 
j
=0;j<
f›lds_size
[
i
];j++è
Ï¡v®ue_µkt
[i][j] = 
»cv_µkt
[i][j];

939 
chªged
=1;

950 ià(
ªsw”ed
 && !
chªged
) {

951 ià(
Œaûbox
->
»suÉ
 =ğ
SCAMPER_TRACEBOX_RESULT_TIMEOUT
)

952 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " NØmodifiÿtiÚ w”d‘eùed b‘w“Àyou‡ndhÏ¡„ou‹¸th©„•l›d (%s)\n",
addrs
[
‰l_šdex
-1 < 0 ? 0 :tl_index-1]);

954 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " NØmodifiÿtiÚ w”d‘eùed b‘w“Àyou‡ndhde¡š©iÚ (%s)\n",
d¡
);

957 ià(
»cv_µkt
è
	`ä“_¬¿y
Ôecv_µkt,
f›lds_Ën
);

958 ià(
Ï¡v®ue_µkt
è
	`ä“_¬¿y
Öa¡v®ue_µkt,
f›lds_Ën
);

959 
i
=0; i<
max_‰l
; i++è
	`ä“
(
addrs
[i]);

960 
	`ä“
(
addrs
); f»e(
dËns
);

963 
	}
}

965 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_äags
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
, * 
d¡
) {

968 
	}
}

970 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_´oxy
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
) {

972 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

973 
ušt32_t
 
i
;

974 
ušt8_t
 
´Ùo
, 
‰l
, 
Ï¡_‰l
, 
v
, 
tı_‰l
, 
udp_‰l
, 
loİ
 = 0;

976 
i
=0; i<
Œaûbox
->
pktc
; i++) {

977 
pkt
 = 
Œaûbox
->
pkts
[
i
];

978 
v
 = 0;

980 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 4) {

981 
v
 = 4;

982 
´Ùo
 = 
pkt
->
d©a
[9];

983 
‰l
=
pkt
->
d©a
[8];

984 } if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 6) {

985 
v
 = 6;

986 
´Ùo
 = 
pkt
->
d©a
[6];

987 
‰l
ğ
pkt
->
d©a
[7];

994 if(
´Ùo
 =ğ
IPPROTO_TCP
) {

995 ià(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
)

996 
tı_‰l
=
‰l
;

1001 } ià(
´Ùo
 =ğ
IPPROTO_UDP
) {

1003 ià(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_TX
)

1004 
udp_‰l
=
‰l
;

1016 ià(
tı_‰l
<
udp_‰l
)

1017 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " There is‡…roxy between you‡ndhe destination.\n");

1019 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " No…roxy between you‡ndhe destination was detected.\n");

1022 
	}
}

1024 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e_¡©efuÎ
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,*
buf
, 
size_t
 
bufsize
, size_ˆ*
soff
, * 
d¡
) {

1026 
sÿm³r_Œaûbox_pkt_t
 *
pkt
;

1027 
ušt32_t
 
i
;

1028 
ušt8_t
 
´Ùo
, 
‰l
, 
Ï¡_‰l
=0, 
v
, 
¤v_‰l
, 
loİ
=0, 
»Œ›s
=0;

1030 
i
=0; i<
Œaûbox
->
pktc
; i++)

1032 
pkt
 = 
Œaûbox
->
pkts
[
i
];
v
 = 0;

1034 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 4)

1036 
v
 = 4;

1037 
´Ùo
 = 
pkt
->
d©a
[9];

1038 
‰l
=
pkt
->
d©a
[8];

1040 if(((
pkt
->
d©a
[0] & 0xf0) >> 4) == 6)

1042 
v
 = 6;

1043 
´Ùo
 = 
pkt
->
d©a
[6];

1044 
‰l
ğ
pkt
->
d©a
[7];

1048 if(
´Ùo
 =ğ
IPPROTO_TCP
) {

1049 ià(
Ï¡_‰l
 > 
‰l
) {

1050 ià(
loİ
 =ğ0è
¤v_‰l
=
Ï¡_‰l
;

1051 
loİ
++;

1052 
»Œ›s
=0;

1053 } ià(
Ï¡_‰l
 =ğ
‰l
è
»Œ›s
++;

1054 
»Œ›s
=0;

1056 ià(
»Œ›s
 == 3) {

1057 
loİ
++;

1058 
»Œ›s
=0;

1061 ià(
pkt
->
dœ
 =ğ
SCAMPER_TRACEBOX_PKT_DIR_RX
) {

1062 ià(
loİ
 == 2) {

1063 ià(
‰l
 =ğ
¤v_‰l
) {

1064 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " There is‚o statefull middlebox between you‡ndhe destination.\n");

1068 } ià(
loİ
 == 4) {

1069 ià(
‰l
 =ğ
¤v_‰l
) {

1070 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " There is‡ statefull middlebox between you‡ndhe destination.\n");

1075 
Ï¡_‰l
=
‰l
;

1079 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, 
soff
, " Anƒrror happened.\n");

1081 
	}
}

1083 
	$sÿm³r_fe_‹xt_Œaûbox_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1084 cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
)

1087 cÚ¡ 
bufsize
 = 131072;

1088 
buf
[
bufsize
];

1089 
¤c
[64], 
d¡
[64], 
tmp
[256];

1090 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

1091 
size_t
 
soff
 = 0;

1093 
	`¡ršg_cÚÿt
(
buf
, (buf), &
soff
,

1094 "Œaûbox % modäom % tØ%s\À»suÉ: %s\n", 
modes
[
Œaûbox
->
´štmode
],

1095 
	`sÿm³r_addr_to¡r
(
Œaûbox
->
¤c
, src, (src)),

1096 
	`sÿm³r_addr_to¡r
(
Œaûbox
->
d¡
, dst, (dst)),

1097 
	`sÿm³r_Œaûbox_»s2¡r
(
Œaûbox
, 
tmp
, (tmp)));

1100 
Œaûbox
->
´štmode
) {

1101 
TRACEBOX_PRINT_MODE_FRAGS
:

1102 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_äags
(
Œaûbox
,
buf
,
bufsize
,&
soff
,
d¡
);

1104 
TRACEBOX_PRINT_MODE_FULL_ICMP
:

1105 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_fuÎ_icmp
(
Œaûbox
,
buf
,
bufsize
,&
soff
);

1107 
TRACEBOX_PRINT_MODE_PROXY
:

1108 ià(
Œaûbox
->
»suÉ
 =ğ
SCAMPER_TRACEBOX_RESULT_SUCCESS
)

1109 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_´oxy
(
Œaûbox
,
buf
,
bufsize
,&
soff
);

1111 
TRACEBOX_PRINT_MODE_STATEFULL
:

1112 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_¡©efuÎ
(
Œaûbox
,
buf
,
bufsize
,&
soff
,
d¡
);

1114 
TRACEBOX_PRINT_MODE_SIMPLIFIED_OUTPUT
:

1115 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_sim¶if›d
(
Œaûbox
,
buf
,
bufsize
,&
soff
,
d¡
);

1117 
TRACEBOX_PRINT_MODE_STANDARD
:

1119 
	`sÿm³r_fe_‹xt_Œaûbox_wr™e_¡ªd¬d
(
Œaûbox
,
buf
,
bufsize
,&
soff
);

1122 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
soff
);

1124 
	}
}

1126 *
	$compu‹_difã»nûs
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, cÚ¡ 
ušt8_t
 *
pkt1
, cÚ¡ ušt8_ˆ*
pkt2
, cÚ¡ ušt8_ˆ
ty³
, cÚ¡ ušt8_ˆ
ÃtwÜk
, cÚ¡ ušt8_ˆ
Œª¥Üt
) {

1127 *
buf
 = 
	`m®loc
(20480*());

1128 
size_t
 
bufsize
=20480;

1129 
size_t
 
soff
 = 0;

1131 
i
,
j
, 
Œªsoff
;

1132 
ušt8_t
 **
µkt1
 = 
	`·r£_·ck‘
(
ÃtwÜk
, 
Œª¥Üt
, 
ty³
, 
pkt1
);

1133 
ušt8_t
 **
µkt2
 = 
	`·r£_·ck‘
(
ÃtwÜk
, 
Œª¥Üt
, 
ty³
, 
pkt2
);

1135 ià(
ÃtwÜk
 == 4) {

1136 
Œªsoff
 = 20;

1137 ià(
µkt1
[24][0] !ğ
µkt2
[24][0]) {

1138 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " warning: IPHeaderLength changed\n");

1141 
Œªsoff
 = 40;

1142 ià((
µkt1
[27][0] !ğ
µkt2
[27][0]) || (ppkt1[27][1] !=…pkt2[27][1])) {

1143 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " warning: IPv6Length changed\n");

1147 
ty³
) {

1148 
SCAMPER_TRACEBOX_ANSWER_FULL
:

1149 
i
=0;i<7;i++) {

1150 
j
=0;j<
f›lds_size
[
i
];j++) {

1151 ià(
µkt1
[
i
][
j
] !ğ
µkt2
[i][j]) {

1152 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " %s",
f›lds
[
i
]);

1157 
SCAMPER_TRACEBOX_ANSWER_SYNACK
:

1158 ià(!
Œaûbox
->
udp
) {

1159 
İtoff
 = 
Œªsoff
+20;

1160 
ušt8_t
 
tı_İt
 = ((
pkt1
[
Œªsoff
+12]& 0xf0) >> 4)-5 ;

1161 
ušt8_t
 
tı_İt2
 = ((
pkt2
[
Œªsoff
+12]& 0xf0) >> 4)-5 ;

1162 
nb_by‹s
 = 
tı_İt
 * 4, 
nb_by‹s2
 = 
tı_İt2
 * 4;

1164 
ušt8_t
 **
diff
 = 
	`com·»_tı_İt
(
pkt1
+
İtoff
, 
pkt2
+İtoff, 
nb_by‹s
, 
nb_by‹s2
);

1165 ià((
diff
[0][0] || diff[0][1]) || diff[0][2]) {

1166 
ušt8_t
 
šdex
;

1167 
šdex
=0;šdex<
diff
[0][0];index++)

1168 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[1][
šdex
]]);

1169 
šdex
=0;šdex<
diff
[0][1];index++)

1170 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " -TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[2][
šdex
]]);

1171 
šdex
=0;šdex<
diff
[0][2];index++)

1172 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " +TCP::O±iÚs::%s",
tı_İtiÚs
[
diff
[3][
šdex
]]);

1174 
	`ä“_¬¿y
(
diff
,4);

1177 ià(
ty³
 =ğ
SCAMPER_TRACEBOX_ANSWER_SYNACK
) ;

1178 
SCAMPER_TRACEBOX_ANSWER_8B
:

1179 
i
=7;i<14;i++) {

1180 
j
=0;j<
f›lds_size
[
i
];j++) {

1181 ià(
µkt1
[
i
][
j
] !ğ
µkt2
[i][j]) {

1182 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " %s",
f›lds
[
i
]);

1187 
SCAMPER_TRACEBOX_ANSWER_ONLY_L3
:

1189 
i
=14;i<36;i++) {

1190 
j
=0;j<
f›lds_size
[
i
];j++) {

1191 ià(
µkt1
[
i
][
j
] !ğ
µkt2
[i][j]) {

1192 
	`¡ršg_cÚÿt
(
buf
, 
bufsize
, &
soff
, " %s",
f›lds
[
i
]);

1198 
SCAMPER_TRACEBOX_ANSWER_EMPTY
:

1201 
	`ä“_¬¿y
(
µkt1
,
f›lds_Ën
); f»e_¬¿y(
µkt2
,fields_len);

1202 ià(!
soff
è
	`ä“
(
buf
);

1203  !
soff
 ? 
NULL
 : 
buf
;

1204 
	}
}

	@tracebox/scamper_tracebox_text.h

9 #iâdeà
__SCAMPER_FILE_TEXT_TRACEBOX_H


10 
	#__SCAMPER_FILE_TEXT_TRACEBOX_H


	)

12 
	#TRACEBOX_PRINT_MODE_STANDARD
 0x0

	)

13 
	#TRACEBOX_PRINT_MODE_FRAGS
 0x1

	)

14 
	#TRACEBOX_PRINT_MODE_FULL_ICMP
 0x2

	)

15 
	#TRACEBOX_PRINT_MODE_PROXY
 0x4

	)

16 
	#TRACEBOX_PRINT_MODE_STATEFULL
 0x5

	)

17 
	#TRACEBOX_PRINT_MODE_SIMPLIFIED_OUTPUT
 0x6

	)

19 
ušt32_t
 
by‹_»v”£_32
(ušt32_ˆ
num
);

20 
ušt16_t
 
by‹_»v”£_16
(ušt16_ˆ
num
);

21 * 
compu‹_difã»nûs
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
, cÚ¡ 
ušt8_t
 *
pkt1
, cÚ¡ ušt8_ˆ*
pkt2
, cÚ¡ ušt8_ˆ
ty³
, cÚ¡ ušt8_ˆ
ÃtwÜk
, cÚ¡ ušt8_ˆ
Œª¥Üt
);

23 
sÿm³r_fe_‹xt_Œaûbox_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

24 cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
);

	@tracebox/scamper_tracebox_warts.c

9 #iâdeà
lšt


10 cÚ¡ 
	grcsid
[] =

14 #ifdeà
HAVE_CONFIG_H


15 
	~"cÚfig.h
"

17 
	~"š‹º®.h
"

19 
	~"sÿm³r_addr.h
"

20 
	~"sÿm³r_li¡.h
"

21 
	~"sÿm³r_icm³xt.h
"

22 
	~"sÿm³r_Œaûbox.h
"

23 
	~"sÿm³r_fe.h
"

24 
	~"sÿm³r_fe_w¬ts.h
"

25 
	~"sÿm³r_Œaûbox_w¬ts.h
"

26 
	~"uts.h
"

32 
	#WARTS_TRACEBOX_STRUCT_EOF
 0x0000

	)

33 
	#WARTS_TRACEBOX_STRUCT_TYPE
 0x0001

	)

34 
	#WARTS_TRACEBOX_STRUCT_APP
 0x0002

	)

36 
	#WARTS_TRACEBOX_LIST
 1

	)

37 
	#WARTS_TRACEBOX_CYCLE
 2

	)

38 
	#WARTS_TRACEBOX_USERID
 3

	)

39 
	#WARTS_TRACEBOX_SRC
 4

	)

40 
	#WARTS_TRACEBOX_DST
 5

	)

41 
	#WARTS_TRACEBOX_SPORT
 6

	)

42 
	#WARTS_TRACEBOX_DPORT
 7

	)

43 
	#WARTS_TRACEBOX_START
 8

	)

44 
	#WARTS_TRACEBOX_RESULT
 9

	)

45 
	#WARTS_TRACEBOX_TYPE
 10

	)

46 
	#WARTS_TRACEBOX_APPPROTO
 11

	)

47 
	#WARTS_TRACEBOX_CMSS
 12

	)

48 
	#WARTS_TRACEBOX_SMSS
 13

	)

49 
	#WARTS_TRACEBOX_SYNRETX
 14

	)

50 
	#WARTS_TRACEBOX_DATARETX
 15

	)

51 
	#WARTS_TRACEBOX_PKTC16
 16

	)

52 
	#WARTS_TRACEBOX_PKTC
 17

	)

54 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûbox_v¬s
[] =

56 {
WARTS_TRACEBOX_LIST
, 4, -1},

57 {
WARTS_TRACEBOX_CYCLE
, 4, -1},

58 {
WARTS_TRACEBOX_USERID
, 4, -1},

59 {
WARTS_TRACEBOX_SRC
, -1, -1},

60 {
WARTS_TRACEBOX_DST
, -1, -1},

61 {
WARTS_TRACEBOX_SPORT
, 2, -1},

62 {
WARTS_TRACEBOX_DPORT
, 2, -1},

63 {
WARTS_TRACEBOX_START
, 8, -1},

64 {
WARTS_TRACEBOX_RESULT
, 2, -1},

65 {
WARTS_TRACEBOX_TYPE
, 1, -1},

66 {
WARTS_TRACEBOX_APPPROTO
, 1, -1},

67 {
WARTS_TRACEBOX_CMSS
, 2, -1},

68 {
WARTS_TRACEBOX_SMSS
, 2, -1},

69 {
WARTS_TRACEBOX_SYNRETX
, 1, -1},

70 {
WARTS_TRACEBOX_DATARETX
, 1, -1},

71 {
WARTS_TRACEBOX_PKTC16
, 2, -1},

72 {
WARTS_TRACEBOX_PKTC
, 4, -1},

74 
	#Œaûbox_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûbox_v¬s
)

	)

76 
	#WARTS_TRACEBOX_PKT_DIR
 1

	)

77 
	#WARTS_TRACEBOX_PKT_TIME
 2

	)

78 
	#WARTS_TRACEBOX_PKT_DATALEN
 3

	)

79 
	#WARTS_TRACEBOX_PKT_DATA
 4

	)

81 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûbox_pkt_v¬s
[] =

83 {
WARTS_TRACEBOX_PKT_DIR
, 1, -1},

84 {
WARTS_TRACEBOX_PKT_TIME
, 8, -1},

85 {
WARTS_TRACEBOX_PKT_DATALEN
, 2, -1},

86 {
WARTS_TRACEBOX_PKT_DATA
, -1, -1},

88 
	#Œaûbox_pkt_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûbox_pkt_v¬s
)

	)

91 
	sw¬ts_Œaûbox_pkt


93 
ušt8_t
 
	mæags
[
Œaûbox_pkt_v¬s_mfb
];

94 
ušt16_t
 
	mæags_Ën
;

95 
ušt16_t
 
	m·¿ms_Ën
;

96 } 
	tw¬ts_Œaûbox_pkt_t
;

99 
	$w¬ts_Œaûbox_pkt_·¿ms
(cÚ¡ 
sÿm³r_Œaûbox_pkt_t
 *
pkt
,

100 
w¬ts_Œaûbox_pkt_t
 *
¡©e
, 
ušt32_t
 *
Ën
)

102 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

103 
max_id
 = 0;

104 
ušt16_t
 
i
;

106 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûbox_pkt_v¬s_mfb
);

107 
¡©e
->
·¿ms_Ën
 = 0;

109 
i
=0; i<(
Œaûbox_pkt_v¬s
è/ (
w¬ts_v¬_t
); i++)

111 
v¬
 = &
Œaûbox_pkt_v¬s
[
i
];

113 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_PKT_DATA
)

115 if(
pkt
->
Ën
 == 0)

118 
¡©e
->
·¿ms_Ën
 +ğ
pkt
->
Ën
;

119 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

123 
	`as£¹
(
v¬
->
size
 >= 0);

124 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

125 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

128 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

130 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

132 if(
¡©e
->
·¿ms_Ën
 != 0)

133 *
Ën
 += 2;

136 
	}
}

138 
sÿm³r_Œaûbox_pkt_t
 *
	$w¬ts_Œaûbox_pkt_»ad
(
w¬ts_¡©e_t
 *
¡©e
,

139 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

140 
ušt32_t
 
Ën
)

142 
sÿm³r_Œaûbox_pkt_t
 *
pkt
 = 
NULL
;

143 
ušt8_t
 
dœ
, *
d©a
 = 
NULL
;

144 
timev®
 
tv
;

145 
ušt16_t
 
¶’
;

146 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

147 {&
dœ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

148 {&
tv
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

149 {&
¶’
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

150 {&
d©a
, (
w´_t
)
exŒaù_by‹s_±r
, &
¶’
},

152 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

154 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0 ||

155 (
pkt
 = 
	`sÿm³r_Œaûbox_pkt_®loc
(
dœ
, 
d©a
, 
¶’
, &
tv
)è=ğ
NULL
)

156 
”r
;

158  
pkt
;

160 
”r
:

161 if(
pkt
 !ğ
NULL
è
	`sÿm³r_Œaûbox_pkt_ä“
(pkt);

162  
NULL
;

163 
	}
}

165 
	$w¬ts_Œaûbox_pkt_wr™e
(cÚ¡ 
sÿm³r_Œaûbox_pkt_t
 *
pkt
,

166 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

167 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,cÚ¡ ušt32_ˆ
Ën
,

168 
w¬ts_Œaûbox_pkt_t
 *
¡©e
)

170 
ušt16_t
 
dl
 = 
pkt
->
Ën
;

171 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

172 {&
pkt
->
dœ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

173 {&
pkt
->
tv
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

174 {&
pkt
->
Ën
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

175 {
pkt
->
d©a
, (
wpw_t
)
š£¹_by‹s_ušt16
, &
dl
},

177 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

178 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

179 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

181 
	}
}

183 
	$w¬ts_Œaûbox_·¿ms
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,

184 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

185 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

187 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

188 
i
, 
max_id
 = 0;

191 
	`mem£t
(
æags
, 0, 
Œaûbox_v¬s_mfb
);

192 *
·¿ms_Ën
 = 0;

194 
i
=0; i<(
Œaûbox_v¬s
)/(
w¬ts_v¬_t
); i++)

196 
v¬
 = &
Œaûbox_v¬s
[
i
];

199 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_PKTC16
)

201 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_LIST
 && 
Œaûbox
->
li¡
 =ğ
NULL
)

203 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_CYCLE
 && 
Œaûbox
->
cyşe
 =ğ
NULL
)

205 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_USERID
 && 
Œaûbox
->
u£rid
 == 0)

207 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_SRC
 && 
Œaûbox
->
¤c
 =ğ
NULL
)

209 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_DST
 && 
Œaûbox
->
d¡
 =ğ
NULL
)

213 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

216 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_SRC
)

218 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaûbox
->
¤c
);

221 if(
v¬
->
id
 =ğ
WARTS_TRACEBOX_DST
)

223 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaûbox
->
d¡
);

228 *
·¿ms_Ën
 +ğ
v¬
->
size
;

231 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

233 
	}
}

235 
	$w¬ts_Œaûbox_·¿ms_»ad
(
sÿm³r_Œaûbox_t
 *
Œaûbox
,

236 
w¬ts_add¹abË_t
 *
bË
,

237 
w¬ts_¡©e_t
 *
¡©e
,

238 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

240 
ušt16_t
 
pktc16
 = 0;

241 
ušt32_t
 
pktc32
 = 0;

243 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

244 {&
Œaûbox
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

245 {&
Œaûbox
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

246 {&
Œaûbox
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

247 {&
Œaûbox
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

248 {&
Œaûbox
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

249 {&
Œaûbox
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

250 {&
Œaûbox
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

251 {&
Œaûbox
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

252 {&
Œaûbox
->
»suÉ
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

253 {&
Œaûbox
->
ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

254 {&
Œaûbox
->
­p_´Ùo
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

255 {&
Œaûbox
->
ş›Á_mss
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

256 {&
Œaûbox
->
£rv”_mss
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

257 {&
Œaûbox
->
syn_»tx
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

258 {&
Œaûbox
->
d©_»tx
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

259 {&
pktc16
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

260 {&
pktc32
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

262 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

264 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

268 if(
pktc32
 != 0)

269 
Œaûbox
->
pktc
 = 
pktc32
;

270 if(
pktc16
 != 0)

271 
Œaûbox
->
pktc
 = 
pktc16
;

274 
	}
}

276 
	$w¬ts_Œaûbox_·¿ms_wr™e
(cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
,

277 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

278 
w¬ts_add¹abË_t
 *
bË
,

279 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

280 cÚ¡ 
ušt32_t
 
Ën
, cÚ¡ 
ušt8_t
 *
æags
,

281 cÚ¡ 
ušt16_t
 
æags_Ën
,

282 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

284 
ušt32_t
 
li¡_id
, 
cyşe_id
;

287 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

288 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

289 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

290 {&
Œaûbox
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

291 {
Œaûbox
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

292 {
Œaûbox
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

293 {&
Œaûbox
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

294 {&
Œaûbox
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

295 {&
Œaûbox
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

296 {&
Œaûbox
->
»suÉ
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

297 {&
Œaûbox
->
ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

298 {&
Œaûbox
->
­p_´Ùo
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

299 {&
Œaûbox
->
ş›Á_mss
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

300 {&
Œaûbox
->
£rv”_mss
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

301 {&
Œaûbox
->
syn_»tx
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

302 {&
Œaûbox
->
d©_»tx
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

303 {
NULL
, NULL, NULL},

304 {&
Œaûbox
->
pktc
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

306 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

308 if(
	`w¬ts_li¡_g‘id
(
sf
, 
Œaûbox
->
li¡
, &
li¡_id
) == -1)  -1;

309 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
Œaûbox
->
cyşe
, &
cyşe_id
) == -1)  -1;

311 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
,

312 
hªdËrs
, 
hªdËr_út
);

315 
	}
}

317 
	$sÿm³r_fe_w¬ts_Œaûbox_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

318 
sÿm³r_Œaûbox_t
 **
Œaûbox_out
)

320 
sÿm³r_Œaûbox_t
 *
Œaûbox
 = 
NULL
;

321 
w¬ts_add¹abË_t
 
bË
;

322 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

323 
ušt8_t
 *
buf
 = 
NULL
;

324 
ušt16_t
 
junk16
;

325 
ušt32_t
 
junk32
;

326 
ušt32_t
 
off
 = 0;

327 
ušt32_t
 
i
;

329 
	`mem£t
(&
bË
, 0, (table));

332 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

334 
”r
;

337 if(
buf
 =ğ
NULL
)

339 *
Œaûbox_out
 = 
NULL
;

344 if((
Œaûbox
 = 
	`sÿm³r_Œaûbox_®loc
()è=ğ
NULL
)

346 
”r
;

350 if(
	`w¬ts_Œaûbox_·¿ms_»ad
(
Œaûbox
, &
bË
, 
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

352 
”r
;

355 if(
Œaûbox
->
pktc
 > 0)

358 if(
	`sÿm³r_Œaûbox_pkts_®loc
(
Œaûbox
,¿ûbox->
pktc
) != 0)

359 
”r
;

362 
i
=0; i<
Œaûbox
->
pktc
; i++)

364 
Œaûbox
->
pkts
[
i
] = 
	`w¬ts_Œaûbox_pkt_»ad
(
¡©e
, 
buf
, &
off
, 
hdr
->
Ën
);

365 if(
Œaûbox
->
pkts
[
i
] =ğ
NULL
)

366 
”r
;

372 if(
	`exŒaù_ušt16
(
buf
, &
off
, 
hdr
->
Ën
, &
junk16
, 
NULL
) != 0)

373 
”r
;

374 if(
junk16
 =ğ
WARTS_TRACEBOX_STRUCT_EOF
)

376 if(
	`exŒaù_ušt32
(
buf
, &
off
, 
hdr
->
Ën
, &
junk32
, 
NULL
) != 0)

377 
”r
;

379 
i
 = 
off
;

380 
off
 +ğ
junk32
;

383 
	`as£¹
(
off
 =ğ
hdr
->
Ën
);

384 
	`w¬ts_add¹abË_ş—n
(&
bË
);

385 *
Œaûbox_out
 = 
Œaûbox
;

386 
	`ä“
(
buf
);

389 
”r
:

390 
	`w¬ts_add¹abË_ş—n
(&
bË
);

391 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

392 if(
Œaûbox
 !ğ
NULL
è
	`sÿm³r_Œaûbox_ä“
(tracebox);

394 
	}
}

397 
	$sÿm³r_fe_w¬ts_Œaûbox_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

398 cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
)

400 
w¬ts_add¹abË_t
 
bË
;

401 
w¬ts_Œaûbox_pkt_t
 *
pkts
 = 
NULL
;

402 
ušt8_t
 *
buf
 = 
NULL
;

403 
ušt8_t
 
æags
[
Œaûbox_v¬s_mfb
];

404 
ušt16_t
 
junk16
;

405 
ušt16_t
 
æags_Ën
, 
·¿ms_Ën
;

406 
ušt32_t
 
Ën
, 
i
, 
off
 = 0;

407 
size_t
 
size
;

409 
	`mem£t
(&
bË
, 0, (table));

412 
	`w¬ts_Œaûbox_·¿ms
(
Œaûbox
, &
bË
, 
æags
, &
æags_Ën
, &
·¿ms_Ën
);

413 
Ën
 = 8 + 
æags_Ën
 + 
·¿ms_Ën
 + 2;

415 if(
Œaûbox
->
pktc
 > 0)

418 
size
 = 
Œaûbox
->
pktc
 * (
w¬ts_Œaûbox_pkt_t
);

419 if((
pkts
 = (
w¬ts_Œaûbox_pkt_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

420 
”r
;

422 
i
=0; i<
Œaûbox
->
pktc
; i++)

423 
	`w¬ts_Œaûbox_pkt_·¿ms
(
Œaûbox
->
pkts
[
i
], &pkts[i], &
Ën
);

427 
Ën
 += 2;

430 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

431 
”r
;

432 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_TRACEBOX
);

435 if(
	`w¬ts_Œaûbox_·¿ms_wr™e
(
Œaûbox
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
,

436 
æags
, 
æags_Ën
, 
·¿ms_Ën
) != 0)

438 
”r
;

441 if(
Œaûbox
->
pktc
 > 0)

443 
i
=0; i<
Œaûbox
->
pktc
; i++)

444 
	`w¬ts_Œaûbox_pkt_wr™e
(
Œaûbox
->
pkts
[
i
], 
sf
, 
buf
, &
off
, 
Ën
, &pkts[i]);

445 
	`ä“
(
pkts
);…kt ğ
NULL
;

448 
junk16
 = 
WARTS_TRACEBOX_STRUCT_EOF
;

449 
	`š£¹_ušt16
(
buf
, &
off
, 
Ën
, &
junk16
, 
NULL
);

451 
	`as£¹
(
off
 =ğ
Ën
);

454 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
Ën
) == -1)

455 
”r
;

457 
	`w¬ts_add¹abË_ş—n
(&
bË
);

458 
	`ä“
(
buf
);

461 
”r
:

462 
	`w¬ts_add¹abË_ş—n
(&
bË
);

463 if(
pkts
 !ğ
NULL
è
	`ä“
(pkts);

464 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

466 
	}
}

	@tracebox/scamper_tracebox_warts.h

10 #iâdeà
__SCAMPER_FILE_WARTS_TRACEBOX_H


11 
	#__SCAMPER_FILE_WARTS_TRACEBOX_H


	)

13 
sÿm³r_fe_w¬ts_Œaûbox_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

14 cÚ¡ 
sÿm³r_Œaûbox_t
 *
Œaûbox
);

16 
sÿm³r_fe_w¬ts_Œaûbox_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

17 
sÿm³r_Œaûbox_t
 **
Œaûbox_out
);

	@tracelb/scamper_tracelb.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r_addr.h
"

40 
	~"sÿm³r_li¡.h
"

41 
	~"sÿm³r_icm³xt.h
"

42 
	~"sÿm³r_Œaûlb.h
"

43 
	~"uts.h
"

45 
	sŒaûlb_fwd·thc


47 
	m·thc
;

48 
	m·thcc
;

49 
	mloİ
;

50 } 
	tŒaûlb_fwd·thc_t
;

58 
	$sÿm³r_Œaûlb_node_cmp
(cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
a
,

59 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
b
)

61 
i
;

63 if(
a
->
addr
 =ğ
NULL
 || 
b
->addr == NULL)

65 if(
a
->
addr
 =ğ
NULL
 && 
b
->addr == NULL)

67 if(
a
->
addr
 =ğ
NULL
)

72 if((
i
 = 
	`sÿm³r_addr_humª_cmp
(
a
->
addr
, 
b
->addr)) != 0)

73  
i
;

75 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
a
è=ğSCAMPER_TRACELB_NODE_QTTL(
b
))

77 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
a
))

79 if(
a
->
q_‰l
 < 
b
->q_ttl)  -1;

80 if(
a
->
q_‰l
 > 
b
->q_ttl)  1;

84 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
a
))

89 
	}
}

97 
	$sÿm³r_Œaûlb_lšk_cmp
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
a
,

98 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
b
)

100 
i
;

102 if(
a
 =ğ
b
)

105 if((
i
 = 
	`sÿm³r_Œaûlb_node_cmp
(
a
->
äom
, 
b
->from)) != 0)

106  
i
;

108 if(
a
->
to
 !ğ
NULL
 && 
b
->to != NULL)

109  
	`sÿm³r_Œaûlb_node_cmp
(
a
->
to
, 
b
->to);

111 if(
a
->
to
 =ğ
NULL
 && 
b
->to == NULL)

113 if(
a
->
to
 =ğ
NULL
)

117 
	}
}

126 
	$Œaûlb_node_lšk_cmp
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
a
,

127 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
b
)

129 
	`as£¹
(
a
->
äom
 =ğ
b
->from);

130  
	`sÿm³r_Œaûlb_node_cmp
(
a
->
to
, 
b
->to);

131 
	}
}

138 
	$Œaûlb_nodes_exŒaù
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

139 
sÿm³r_Œaûlb_node_t
 *
äom
,

140 
sÿm³r_Œaûlb_node_t
 *
to
,

141 
sÿm³r_Œaûlb_node_t
 **
nodes
, *
nodec
)

143 
ušt16_t
 
i
;

145 if(
	`¬¿y_fšd
((**)
nodes
, *
nodec
, 
äom
,

146 (
¬¿y_cmp_t
)
sÿm³r_Œaûlb_node_cmp
è!ğ
NULL
)

149 
nodes
[*
nodec
] = 
äom
;

150 *
nodec
 = *nodec + 1;

151 
	`¬¿y_qsÜt
((**)
nodes
, *
nodec
, (
¬¿y_cmp_t
)
sÿm³r_Œaûlb_node_cmp
);

153 if(
to
 !ğ
NULL
 && 
äom
 ==o)

156 
i
=0; i<
äom
->
lškc
; i++)

158 
	`Œaûlb_nodes_exŒaù
(
Œaû
, 
äom
->
lšks
[
i
]->
to
,o, 
nodes
, 
nodec
);

162 
	}
}

170 
	$sÿm³r_Œaûlb_nodes_exŒaù
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

171 
sÿm³r_Œaûlb_node_t
 *
äom
,

172 
sÿm³r_Œaûlb_node_t
 *
to
,

173 
sÿm³r_Œaûlb_node_t
 **
nodes
)

175 
nodec
 = 0;

176 
	`Œaûlb_nodes_exŒaù
(
Œaû
, 
äom
, 
to
, 
nodes
, &
nodec
);

177  
nodec
;

178 
	}
}

185 
	$Œaûlb_node_šdex
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

186 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
)

188 
ušt16_t
 
i
;

189 
i
=0; i<
Œaû
->
nodec
; i++)

191 if(
Œaû
->
nodes
[
i
] =ğ
node
)

192  
i
;

195 
	}
}

197 
	$sÿm³r_Œaûlb_node_cÚv”g’ûpošt
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

198 cÚ¡ *
fwd·thc
,

199 
äom
, *
to
)

201 
sÿm³r_Œaûlb_node_t
 *
node
;

202 
n
, 
Â
, 
rc
 = -1;

203 *
loİ
;

206 if(
Œaû
->
nodes
[
äom
]->
lškc
 == 0)

208 *
to
 = -1;

216 if(
Œaû
->
nodes
[
äom
]->
lškc
 == 1)

218 if((
n
=
	`Œaûlb_node_šdex
(
Œaû
,¿û->
nodes
[
äom
]->
lšks
[0]->
to
)) == -1)

220 *
to
 = 
n
;

228 if((
loİ
 = 
	`m®loc_z”o
((è* 
Œaû
->
nodec
)è=ğ
NULL
)

230 
n
 = 
Â
 = 
äom
;

231 
loİ
[
n
] = 1;

235 
node
 = 
Œaû
->
nodes
[
n
];

238 if(
node
->
lškc
 == 0)

240 *
to
 = -1; 
rc
 = 0;

245 if((
n
 = 
	`Œaûlb_node_šdex
(
Œaû
, 
node
->
lšks
[0]->
to
)) == -1)

249 if(
loİ
[
n
] != 0)

251 *
to
 = -1; 
rc
 = 0;

254 
loİ
[
n
] = 1;

260 if(
fwd·thc
[
n
] >ğfwd·thc[
Â
])

262 *
to
 = 
n
; 
rc
 = 0;

267 
	`ä“
(
loİ
);

268  
rc
;

269 
	}
}

278 
	$Œaûlb_fwd·thc
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
, 
n
,

279 
Œaûlb_fwd·thc_t
 *
nodes
)

281 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

282 
sÿm³r_Œaûlb_node_t
 *
node
;

283 
ušt16_t
 
i
;

284 
Â
, 
c
, 
t
;

286 if(
nodes
[
n
].
·thc
 != 0)

294 
nodes
[
n
].
·thcc
 +ğnodes[n].
·thc
;

296 
node
 = 
Œaû
->
nodes
[
n
];

297 
i
=0; i<
node
->
lškc
; i++)

299 
lšk
 = 
node
->
lšks
[
i
];

300 
Â
 = 
	`Œaûlb_node_šdex
(
Œaû
, 
lšk
->
to
);

301 
	`as£¹
(
Â
 >ğ0 &&‚À< 
Œaû
->
nodec
);

302 
	`Œaûlb_fwd·thc
(
Œaû
, 
Â
, 
nodes
);

305 if(
Œaû
->
nodes
[
n
]->
lškc
 > 0)

311 
nodes
[
n
].
loİ
 = 1;

312 
c
 = 0;

313 
node
 = 
Œaû
->
nodes
[
n
];

314 
i
=0; i<
node
->
lškc
; i++)

316 
lšk
 = 
node
->
lšks
[
i
];

319 
Â
 = 
	`Œaûlb_node_šdex
(
Œaû
, 
lšk
->
to
);

320 
	`as£¹
(
Â
 >ğ0 &&‚À< 
Œaû
->
nodec
);

323 if(
nodes
[
Â
].
loİ
 != 0)

327 
t
 = 
	`Œaûlb_fwd·thc
(
Œaû
, 
Â
, 
nodes
);

328 
	`as£¹
(
t
 > 0);

331 
c
 +ğ
t
;

335 
nodes
[
n
].
·thcc
 =‚odes[n].
·thc
 = 
c
;

336 
nodes
[
n
].
loİ
 = 0;

344 
nodes
[
n
].
·thcc
 =‚odes[n].
·thc
 = 1;

347  
nodes
[
n
].
·thc
;

348 
	}
}

356 
	$sÿm³r_Œaûlb_fwd·thc
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
, *
nodes
)

358 
Œaûlb_fwd·thc_t
 *
fwd·thc
;

359 
ušt16_t
 
i
;

361 if(
Œaû
->
nodec
 == 0)

364 if((
fwd·thc
 = 
	`m®loc_z”o
((
Œaûlb_fwd·thc_t
)*
Œaû
->
nodec
)è=ğ
NULL
)

367 
	`Œaûlb_fwd·thc
(
Œaû
, 0, 
fwd·thc
);

368 
i
=0; i<
Œaû
->
nodec
; i++)

370 
nodes
[
i
] = 
fwd·thc
[i].
·thcc
;

372 
	`ä“
(
fwd·thc
);

375 
	}
}

377 
sÿm³r_Œaûlb_node_t
 *
	$sÿm³r_Œaûlb_node_®loc
(
sÿm³r_addr_t
 *
addr
)

379 
sÿm³r_Œaûlb_node_t
 *
node
;

380 if((
node
 = 
	`m®loc_z”o
((
sÿm³r_Œaûlb_node_t
))è!ğ
NULL
)

382 if(
addr
 !ğ
NULL
)

383 
node
->
addr
 = 
	`sÿm³r_addr_u£
(addr);

385  
node
;

386 
	}
}

388 
	$sÿm³r_Œaûlb_node_ä“
(
sÿm³r_Œaûlb_node_t
 *
node
)

390 if(
node
 =ğ
NULL
)

393 if(
node
->
lšks
 !ğ
NULL
)

394 
	`ä“
(
node
->
lšks
);

396 if(
node
->
addr
 !ğ
NULL
)

397 
	`sÿm³r_addr_ä“
(
node
->
addr
);

399 
	`ä“
(
node
);

401 
	}
}

403 
	$sÿm³r_Œaûlb_node_add
(
sÿm³r_Œaûlb_t
 *
Œaû
,

404 
sÿm³r_Œaûlb_node_t
 *
node
)

406 
size_t
 
Ën
 = (
Œaû
->
nodec
 + 1è* (
sÿm³r_Œaûlb_node_t
 *);

407 if(
	`»®loc_w¿p
((**)&
Œaû
->
nodes
, 
Ën
) == 0)

409 
Œaû
->
nodes
[Œaû->
nodec
++] = 
node
;

414 
	}
}

416 
sÿm³r_Œaûlb_node_t
 *
	$sÿm³r_Œaûlb_node_fšd
(
sÿm³r_Œaûlb_t
 *
Œaû
,

417 
sÿm³r_Œaûlb_node_t
 *
node
)

419 
ušt16_t
 
i
;

421 
i
=0; i<
Œaû
->
nodec
; i++)

423 if(
Œaû
->
nodes
[
i
]->
addr
 =ğ
NULL
)

426 if(
	`sÿm³r_Œaûlb_node_cmp
(
Œaû
->
nodes
[
i
], 
node
) == 0)

427  
Œaû
->
nodes
[
i
];

429  
NULL
;

430 
	}
}

432 
sÿm³r_Œaûlb_»¶y_t
 *
	$sÿm³r_Œaûlb_»¶y_®loc
(
sÿm³r_addr_t
 *
addr
)

434 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

436 if((
»¶y
 = 
	`m®loc_z”o
((
sÿm³r_Œaûlb_»¶y_t
))è=ğ
NULL
)

437  
NULL
;

439 if(
addr
 !ğ
NULL
)

440 
»¶y
->
»¶y_äom
 = 
	`sÿm³r_addr_u£
(
addr
);

442  
»¶y
;

443 
	}
}

445 
	$sÿm³r_Œaûlb_»¶y_ä“
(
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
)

447 if(
»¶y
 =ğ
NULL
)

450 if(
»¶y
->
»¶y_äom
 !ğ
NULL
)

451 
	`sÿm³r_addr_ä“
(
»¶y
->
»¶y_äom
);

453 if((
»¶y
->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) == 0)

454 
	`sÿm³r_icm³xt_ä“
(
»¶y
->
»¶y_icmp_ext
);

456 
	`ä“
(
»¶y
);

458 
	}
}

460 
sÿm³r_Œaûlb_´obe_t
 *
	$sÿm³r_Œaûlb_´obe_®loc
()

462 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

463 
´obe
 = 
	`m®loc_z”o
((
sÿm³r_Œaûlb_´obe_t
));

464  
´obe
;

465 
	}
}

467 
	$sÿm³r_Œaûlb_´obe_ä“
(
sÿm³r_Œaûlb_´obe_t
 *
´obe
)

469 
ušt16_t
 
i
;

471 if(
´obe
 =ğ
NULL
)

474 if(
´obe
->
rxs
 !ğ
NULL
)

476 
i
=0; i<
´obe
->
rxc
; i++)

477 
	`sÿm³r_Œaûlb_»¶y_ä“
(
´obe
->
rxs
[
i
]);

479 
	`ä“
(
´obe
->
rxs
);

481 
	`ä“
(
´obe
);

483 
	}
}

485 
	$sÿm³r_Œaûlb_´obe_»¶y
(
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

486 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
)

488 
size_t
 
Ën
;

491 
Ën
 = (
´obe
->
rxc
 + 1è* (
sÿm³r_Œaûlb_»¶y_t
 *);

492 if(
	`»®loc_w¿p
((**)&
´obe
->
rxs
, 
Ën
) != 0)

496 
´obe
->
rxs
[´obe->
rxc
++] = 
»¶y
;

498 
	}
}

500 
	$sÿm³r_Œaûlb_´obe£t_´obes_®loc
(
sÿm³r_Œaûlb_´obe£t_t
 *
£t
,

501 
ušt16_t
 
´obec
)

503 
size_t
 
Ën
 = (
sÿm³r_Œaûlb_´obe_t
 *è* 
´obec
;

504 if((
£t
->
´obes
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

507 
	}
}

509 
	$sÿm³r_Œaûlb_´obe£t_add
(
sÿm³r_Œaûlb_´obe£t_t
 *
´obe£t
,

510 
sÿm³r_Œaûlb_´obe_t
 *
´obe
)

512 
size_t
 
Ën
 = (
´obe£t
->
´obec
 + 1è* (
sÿm³r_Œaûlb_´obe_t
 *);

513 if(
	`»®loc_w¿p
((**)&
´obe£t
->
´obes
, 
Ën
) != 0)

517 
´obe£t
->
´obes
[´obe£t->
´obec
++] = 
´obe
;

519 
	}
}

521 
sÿm³r_Œaûlb_´obe£t_t
 *
	$sÿm³r_Œaûlb_´obe£t_®loc
()

523 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
;

524 
£t
 = 
	`m®loc_z”o
((
sÿm³r_Œaûlb_´obe£t_t
));

525  
£t
;

526 
	}
}

528 
	$sÿm³r_Œaûlb_´obe£t_ä“
(
sÿm³r_Œaûlb_´obe£t_t
 *
£t
)

530 
ušt16_t
 
i
;

532 if(
£t
 =ğ
NULL
)

535 if(
£t
->
´obes
 !ğ
NULL
)

537 
i
=0; i<
£t
->
´obec
; i++)

538 
	`sÿm³r_Œaûlb_´obe_ä“
(
£t
->
´obes
[
i
]);

540 
	`ä“
(
£t
->
´obes
);

543 
	`ä“
(
£t
);

545 
	}
}

547 
sÿm³r_Œaûlb_lšk_t
 *
	$sÿm³r_Œaûlb_lšk_fšd
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œ
,

548 
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

550  
	`¬¿y_fšd
((**)
Œ
->
lšks
,r->
lškc
, 
lšk
,

551 (
¬¿y_cmp_t
)
sÿm³r_Œaûlb_lšk_cmp
);

552 
	}
}

554 
sÿm³r_Œaûlb_lšk_t
 *
	$sÿm³r_Œaûlb_lšk_®loc
()

556  (
sÿm³r_Œaûlb_lšk_t
 *)
	`m®loc_z”o
((scamper_tracelb_link_t));

557 
	}
}

559 
	$sÿm³r_Œaûlb_lšk_ä“
(
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

561 
ušt8_t
 
i
;

563 if(
lšk
 =ğ
NULL
)

566 if(
lšk
->
£ts
 !ğ
NULL
)

568 
i
=0; i<
lšk
->
hİc
; i++)

569 
	`sÿm³r_Œaûlb_´obe£t_ä“
(
lšk
->
£ts
[
i
]);

571 
	`ä“
(
lšk
->
£ts
);

574 
	`ä“
(
lšk
);

576 
	}
}

578 
	$sÿm³r_Œaûlb_lšk_add
(
sÿm³r_Œaûlb_t
 *
Œaû
,

579 
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

581 
sÿm³r_Œaûlb_node_t
 *
node
 = 
NULL
;

582 
size_t
 
size
;

583 
ušt16_t
 
i
;

589 
i
=0; i<
Œaû
->
nodec
; i++)

591 if((
node
 = 
Œaû
->
nodes
[
i
]è=ğ
lšk
->
äom
)

594 if(
i
 =ğ
Œaû
->
nodec
)

596 
	`as£¹
(
node
 !ğ
NULL
);

599 
size
 = (
sÿm³r_Œaûlb_lšk_t
 *è* (
node
->
lškc
+1);

600 if(
	`»®loc_w¿p
((**)&
node
->
lšks
, 
size
) == 0)

602 
node
->
lšks
[node->
lškc
++] = 
lšk
;

603 
	`¬¿y_qsÜt
((**)
node
->
lšks
,‚ode->
lškc
,

604 (
¬¿y_cmp_t
)
sÿm³r_Œaûlb_lšk_cmp
);

609 
size
 = (
sÿm³r_Œaûlb_lšk_t
 *è* (
Œaû
->
lškc
+1);

610 if(
	`»®loc_w¿p
((**)&
Œaû
->
lšks
, 
size
) == 0)

612 
Œaû
->
lšks
[Œaû->
lškc
++] = 
lšk
;

613 
	`¬¿y_qsÜt
((**)
Œaû
->
lšks
,¿û->
lškc
,

614 (
¬¿y_cmp_t
)
sÿm³r_Œaûlb_lšk_cmp
);

618 
	}
}

625 
	$sÿm³r_Œaûlb_lšk_z”Ùfwd
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

627 if(
lšk
->
äom
->
addr
 =ğ
NULL
)

629 if(
	`sÿm³r_addr_cmp
(
lšk
->
äom
->
addr
,†šk->
to
->addr) != 0)

631 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
lšk
->
äom
) == 0)

633 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
lšk
->
to
) == 0)

635 if(
lšk
->
äom
->
q_‰l
 !ğ0 ||†šk->
to
->q_ttl != 1)

639 
	}
}

641 
	$sÿm³r_Œaûlb_lšk_´obe£ts_®loc
(
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

642 
ušt8_t
 
hİc
)

644 
size_t
 
Ën
 = 
hİc
 * (
sÿm³r_Œaûlb_´obe£t_t
 *);

645 if((
lšk
->
£ts
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

648 
	}
}

650 
	$sÿm³r_Œaûlb_lšk_´obe£t
(
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

651 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
)

653 
size_t
 
Ën
 = (
lšk
->
hİc
 + 1è* (
sÿm³r_Œaûlb_´obe£t_t
 *);

654 if(
	`»®loc_w¿p
((**)&
lšk
->
£ts
, 
Ën
) == 0)

656 
lšk
->
£ts
[lšk->
hİc
++] = 
£t
;

661 
	}
}

663 
	$sÿm³r_Œaûlb_nodes_®loc
(
sÿm³r_Œaûlb_t
 *
Œaû
, 
ušt16_t
 
couÁ
)

665 
size_t
 
size
 = (
sÿm³r_Œaûlb_node_t
 *è* 
couÁ
;

666 if((
Œaû
->
nodes
 = 
	`m®loc_z”o
(
size
)è!ğ
NULL
)

671 
	}
}

673 
	$sÿm³r_Œaûlb_lšks_®loc
(
sÿm³r_Œaûlb_t
 *
Œaû
, 
ušt16_t
 
couÁ
)

675 
size_t
 
size
 = (
sÿm³r_Œaûlb_lšk_t
 *è* 
couÁ
;

676 if((
Œaû
->
lšks
 = 
	`m®loc_z”o
(
size
)è!ğ
NULL
)

681 
	}
}

683 
	$sÿm³r_Œaûlb_node_lšks_®loc
(
sÿm³r_Œaûlb_node_t
 *
node
,

684 
ušt16_t
 
couÁ
)

686 
size_t
 
size
 = (
sÿm³r_Œaûlb_lšk_t
 *è* 
couÁ
;

687 if((
node
->
lšks
 = 
	`m®loc_z”o
(
size
)è!ğ
NULL
)

692 
	}
}

694 
	$sÿm³r_Œaûlb_´obe_»¶›s_®loc
(
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

695 
ušt16_t
 
couÁ
)

697 
size_t
 
size
 = (
sÿm³r_Œaûlb_»¶y_t
 *è* 
couÁ
;

698 if((
´obe
->
rxs
 = 
	`m®loc_z”o
(
size
)è!ğ
NULL
)

703 
	}
}

705 
	$sÿm³r_Œaûlb_node_lšks_sÜt
(
sÿm³r_Œaûlb_node_t
 *
node
)

707 
	`¬¿y_qsÜt
((**)
node
->
lšks
,‚ode->
lškc
,

708 (
¬¿y_cmp_t
)
Œaûlb_node_lšk_cmp
);

710 
	}
}

712 
sÿm³r_addr_t
 *
	$sÿm³r_Œaûlb_addr
(cÚ¡ *
va
)

714  ((
sÿm³r_Œaûlb_t
 *)
va
)->
d¡
;

715 
	}
}

717 cÚ¡ *
	$sÿm³r_Œaûlb_ty³_to¡r
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
)

719 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
)

721 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_ICMP_ECHO
)

723 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_SPORT
)

725 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_SPORT
)

727 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
)

729  
NULL
;

730 
	}
}

732 
	$sÿm³r_Œaûlb_sÜt
(
sÿm³r_Œaûlb_t
 *
Œaû
)

734 
sÿm³r_Œaûlb_node_t
 **
nodes
 = 
NULL
;

735 
sÿm³r_Œaûlb_node_t
 **
nq
 = 
NULL
;

736 
i
, 
k
, 
n
, 
q
, 
qt
;

737 
ušt16_t
 
j
;

739 if(
Œaû
->
nodec
 == 0)

742 if((
nodes
 = 
	`m®loc
((
sÿm³r_Œaûlb_node_t
 *)*
Œaû
->
nodec
)è=ğ
NULL
 ||

743 (
nq
 = 
	`m®loc
((
sÿm³r_Œaûlb_node_t
 *)*
Œaû
->
nodec
)è=ğ
NULL
)

745 
”r
;

748 
n
 = 0;

749 
q
 = 0;

751 
nq
[
q
++] = 
Œaû
->
nodes
[0];

753 
q
 > 0)

755 
qt
 = 
q
;

757 
i
=0; i<
qt
; i++)

759 
	`as£¹
(
n
 < 
Œaû
->
nodec
);

760 
nodes
[
n
++] = 
nq
[
i
];

762 
j
=0; j<
nq
[
i
]->
lškc
; j++)

764 
k
=0; k<
q
; k++)

766 if(
nq
[
i
]->
lšks
[
j
]->
to
 =ğnq[
k
])

770 if(
k
 !ğ
q
)

773 
k
=0; k<
n
; k++)

775 if(
nq
[
i
]->
lšks
[
j
]->
to
 =ğ
nodes
[
k
])

779 if(
k
 !ğ
n
)

782 
	`as£¹
(
q
 < 
Œaû
->
nodec
);

783 
nq
[
q
++] =‚q[
i
]->
lšks
[
j
]->
to
;

787 
	`memmove
(
nq
,‚q+
qt
, (
q
-qtè* (
sÿm³r_Œaûlb_node_t
 *));

788 
q
 -ğ
qt
;

791 
	`as£¹
(
n
 =ğ
Œaû
->
nodec
);

792 
	`memıy
(
Œaû
->
nodes
,‚odes,¿û->
nodec
*(
sÿm³r_Œaûlb_node_t
 *));

793 
	`ä“
(
nodes
);

794 
	`ä“
(
nq
);

797 
”r
:

798 if(
nodes
 !ğ
NULL
è
	`ä“
(nodes);

799 if(
nq
 !ğ
NULL
è
	`ä“
(nq);

801 
	}
}

807 
	$sÿm³r_Œaûlb_ä“
(
sÿm³r_Œaûlb_t
 *
Œaû
)

809 
ušt16_t
 
i
;

811 if(
Œaû
 =ğ
NULL
) ;

813 if(
Œaû
->
lšks
 !ğ
NULL
)

815 
i
=0; i<
Œaû
->
lškc
; i++)

816 
	`sÿm³r_Œaûlb_lšk_ä“
(
Œaû
->
lšks
[
i
]);

818 
	`ä“
(
Œaû
->
lšks
);

821 if(
Œaû
->
nodes
 !ğ
NULL
)

823 
i
=0; i<
Œaû
->
nodec
; i++)

824 
	`sÿm³r_Œaûlb_node_ä“
(
Œaû
->
nodes
[
i
]);

826 
	`ä“
(
Œaû
->
nodes
);

829 if(
Œaû
->
d¡
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(trace->dst);

830 if(
Œaû
->
¤c
 !ğ
NULL
è
	`sÿm³r_addr_ä“
(trace->src);

832 if(
Œaû
->
cyşe
 !ğ
NULL
è
	`sÿm³r_cyşe_ä“
(trace->cycle);

833 if(
Œaû
->
li¡
 !ğ
NULL
è
	`sÿm³r_li¡_ä“
(trace->list);

835 
	`ä“
(
Œaû
);

837 
	}
}

844 
sÿm³r_Œaûlb_t
 *
	$sÿm³r_Œaûlb_®loc
()

846  (
sÿm³r_Œaûlb_t
 *)
	`m®loc_z”o
((scamper_tracelb_t));

847 
	}
}

	@tracelb/scamper_tracelb.h

28 #iâdeà
__SCAMPER_TRACELB_H


29 
	#__SCAMPER_TRACELB_H


	)

31 
	~"sÿm³r_addr.h
"

32 
	~"sÿm³r_li¡.h
"

33 
	~"sÿm³r_icm³xt.h
"

36 
sÿm³r_Œaûlb_node
 
	tsÿm³r_Œaûlb_node_t
;

37 
sÿm³r_Œaûlb_lšk
 
	tsÿm³r_Œaûlb_lšk_t
;

38 
sÿm³r_Œaûlb_´obe
 
	tsÿm³r_Œaûlb_´obe_t
;

39 
sÿm³r_Œaûlb_»¶y
 
	tsÿm³r_Œaûlb_»¶y_t
;

40 
sÿm³r_Œaûlb_´obe£t
 
	tsÿm³r_Œaûlb_´obe£t_t
;

46 
	#SCAMPER_TRACELB_TYPE_UDP_DPORT
 0x01

	)

47 
	#SCAMPER_TRACELB_TYPE_ICMP_ECHO
 0x02

	)

48 
	#SCAMPER_TRACELB_TYPE_UDP_SPORT
 0x03

	)

49 
	#SCAMPER_TRACELB_TYPE_TCP_SPORT
 0x04

	)

50 
	#SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
 0x05

	)

56 
	#SCAMPER_TRACELB_NODE_FLAG_QTTL
 0x01

	)

58 
	#SCAMPER_TRACELB_NODE_QTTL
(
node
) \

59 ((
node
)->
æags
 & 
SCAMPER_TRACELB_NODE_FLAG_QTTL
)

	)

61 
	#SCAMPER_TRACELB_REPLY_FLAG_REPLY_TTL
 0x01

	)

62 
	#SCAMPER_TRACELB_REPLY_FLAG_TCP
 0x02

	)

64 
	#SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ( \

65 ((
»¶y
)->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) == 0 && \

66 (((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

67 (
»¶y
)->
»¶y_icmp_ty³
 == 11) || \

68 ((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

69 (
»¶y
)->
»¶y_icmp_ty³
 =ğ3)))

	)

71 
	#SCAMPER_TRACELB_REPLY_IS_ICMP_UNREACH
(
»¶y
) ( \

72 ((
»¶y
)->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) == 0 && \

73 (((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

74 (
»¶y
)->
»¶y_icmp_ty³
 == 3) || \

75 ((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

76 (
»¶y
)->
»¶y_icmp_ty³
 =ğ1)))

	)

78 
	#SCAMPER_TRACELB_REPLY_IS_ICMP_UNREACH_PORT
(
»¶y
) ( \

79 ((
»¶y
)->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) == 0 && \

80 (((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
 && \

81 (
»¶y
)->
»¶y_icmp_ty³
 =ğ3 && (»¶y)->
»¶y_icmp_code
 == 3) || \

82 ((
»¶y
)->
»¶y_äom
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 && \

83 (
»¶y
)->
»¶y_icmp_ty³
 =ğ1 && (»¶y)->
»¶y_icmp_code
 =ğ4)))

	)

85 
	#SCAMPER_TRACELB_REPLY_IS_TCP
(
»¶y
) ( \

86 ((
»¶y
)->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
è!ğ0)

	)

88 
	#SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
) ( \

89 ((
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_SPORT
 || \

90 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
))

	)

92 
	#SCAMPER_TRACELB_TYPE_IS_UDP
(
Œaû
) ( \

93 ((
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_SPORT
 || \

94 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
))

	)

96 
	#SCAMPER_TRACELB_TYPE_IS_ICMP
(
Œaû
) ( \

97 ((
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_ICMP_ECHO
))

	)

99 
	#SCAMPER_TRACELB_TYPE_VARY_SPORT
(
Œaû
) ( \

100 ((
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_SPORT
 || \

101 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_SPORT
 || \

102 (
Œaû
)->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
))

	)

109 
	ssÿm³r_Œaûlb_»¶y


111 
sÿm³r_addr_t
 *
	m»¶y_äom
;

112 
timev®
 
	m»¶y_rx
;

113 
ušt16_t
 
	m»¶y_id
;

114 
ušt8_t
 
	m»¶y_‰l
;

115 
ušt8_t
 
	m»¶y_æags
;

119 
	ssÿm³r_Œaûlb_»¶y_icmp


121 
ušt8_t
 
	m»¶y_icmp_ty³
;

122 
ušt8_t
 
	m»¶y_icmp_code
;

123 
ušt8_t
 
	m»¶y_icmp_q_tos
;

124 
ušt8_t
 
	m»¶y_icmp_q_‰l
;

125 
sÿm³r_icm³xt_t
 *
	m»¶y_icmp_ext
;

126 } 
	micmp
;

127 
	ssÿm³r_Œaûlb_»¶y_tı


129 
ušt8_t
 
	m»¶y_tı_æags
;

130 } 
	mtı
;

131 } 
	m»¶y_un
;

134 
	#»¶y_icmp_ty³
 
»¶y_un
.
icmp
.
»¶y_icmp_ty³


	)

135 
	#»¶y_icmp_code
 
»¶y_un
.
icmp
.
»¶y_icmp_code


	)

136 
	#»¶y_icmp_ext
 
»¶y_un
.
icmp
.
»¶y_icmp_ext


	)

137 
	#»¶y_icmp_q_‰l
 
»¶y_un
.
icmp
.
»¶y_icmp_q_‰l


	)

138 
	#»¶y_icmp_q_tos
 
»¶y_un
.
icmp
.
»¶y_icmp_q_tos


	)

139 
	#»¶y_tı_æags
 
»¶y_un
.
tı
.
»¶y_tı_æags


	)

146 
	ssÿm³r_Œaûlb_´obe


148 
timev®
 
	mtx
;

149 
ušt16_t
 
	mæowid
;

150 
ušt8_t
 
	m‰l
;

151 
ušt8_t
 
	m©‹m±
;

152 
sÿm³r_Œaûlb_»¶y_t
 **
	mrxs
;

153 
ušt16_t
 
	mrxc
;

161 
	ssÿm³r_Œaûlb_´obe£t


163 
sÿm³r_Œaûlb_´obe_t
 **
	m´obes
;

164 
ušt16_t
 
	m´obec
;

172 
	ssÿm³r_Œaûlb_node


174 
sÿm³r_addr_t
 *
	maddr
;

175 
ušt8_t
 
	mæags
;

176 
ušt8_t
 
	mq_‰l
;

177 
sÿm³r_Œaûlb_lšk_t
 **
	mlšks
;

178 
ušt16_t
 
	mlškc
;

186 
	ssÿm³r_Œaûlb_lšk


188 
sÿm³r_Œaûlb_node_t
 *
	mäom
;

189 
sÿm³r_Œaûlb_node_t
 *
	mto
;

190 
ušt8_t
 
	mhİc
;

191 
sÿm³r_Œaûlb_´obe£t_t
 **
	m£ts
;

200 
	ssÿm³r_Œaûlb


203 
sÿm³r_li¡_t
 *
	mli¡
;

204 
sÿm³r_cyşe_t
 *
	mcyşe
;

205 
ušt32_t
 
	mu£rid
;

208 
sÿm³r_addr_t
 *
	m¤c
;

209 
sÿm³r_addr_t
 *
	md¡
;

212 
timev®
 
	m¡¬t
;

215 
ušt16_t
 
	m¥Üt
;

216 
ušt16_t
 
	mdpÜt
;

217 
ušt16_t
 
	m´obe_size
;

218 
ušt8_t
 
	mty³
;

219 
ušt8_t
 
	mfœ¡hİ
;

220 
ušt8_t
 
	mwa™_timeout
;

221 
ušt8_t
 
	mwa™_´obe
;

222 
ušt8_t
 
	m©‹m±s
;

223 
ušt8_t
 
	mcÚfid’û
;

224 
ušt8_t
 
	mtos
;

225 
ušt8_t
 
	mg­lim™
;

226 
ušt32_t
 
	m´obec_max
;

246 
sÿm³r_Œaûlb_node_t
 **
	mnodes
;

247 
ušt16_t
 
	mnodec
;

248 
sÿm³r_Œaûlb_lšk_t
 **
	mlšks
;

249 
ušt16_t
 
	mlškc
;

250 
ušt32_t
 
	m´obec
;

251 
ušt8_t
 
	m”rÜ
;

252 } 
	tsÿm³r_Œaûlb_t
;

263 
sÿm³r_Œaûlb_t
 *
sÿm³r_Œaûlb_®loc
();

264 
sÿm³r_Œaûlb_ä“
(
sÿm³r_Œaûlb_t
 *);

265 
sÿm³r_addr_t
 *
sÿm³r_Œaûlb_addr
(const *);

266 cÚ¡ *
sÿm³r_Œaûlb_ty³_to¡r
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
);

267 
sÿm³r_Œaûlb_sÜt
(
sÿm³r_Œaûlb_t
 *);

278 
sÿm³r_Œaûlb_node_t
 *
sÿm³r_Œaûlb_node_®loc
(
sÿm³r_addr_t
 *);

279 
sÿm³r_Œaûlb_node_ä“
(
sÿm³r_Œaûlb_node_t
 *);

280 
sÿm³r_Œaûlb_node_add
(
sÿm³r_Œaûlb_t
 *,

281 
sÿm³r_Œaûlb_node_t
 *);

282 
sÿm³r_Œaûlb_node_t
 *
sÿm³r_Œaûlb_node_fšd
(
sÿm³r_Œaûlb_t
 *,

283 
sÿm³r_Œaûlb_node_t
 *);

284 
sÿm³r_Œaûlb_node_cmp
(cÚ¡ 
sÿm³r_Œaûlb_node_t
 *,

285 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *);

286 
sÿm³r_Œaûlb_node_lšks_®loc
(
sÿm³r_Œaûlb_node_t
 *, 
ušt16_t
);

287 
sÿm³r_Œaûlb_node_lšks_sÜt
(
sÿm³r_Œaûlb_node_t
 *);

295 
sÿm³r_Œaûlb_»¶y_t
 *
sÿm³r_Œaûlb_»¶y_®loc
(
sÿm³r_addr_t
 *);

296 
sÿm³r_Œaûlb_»¶y_ä“
(
sÿm³r_Œaûlb_»¶y_t
 *);

302 
sÿm³r_Œaûlb_´obe_t
 *
sÿm³r_Œaûlb_´obe_®loc
();

303 
sÿm³r_Œaûlb_´obe_ä“
(
sÿm³r_Œaûlb_´obe_t
 *);

304 
sÿm³r_Œaûlb_´obe_»¶y
(
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

305 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
);

306 
sÿm³r_Œaûlb_´obe_»¶›s_®loc
(
sÿm³r_Œaûlb_´obe_t
 *, 
ušt16_t
);

317 
sÿm³r_Œaûlb_lšk_t
 *
sÿm³r_Œaûlb_lšk_®loc
();

318 
sÿm³r_Œaûlb_lšk_t
 *
sÿm³r_Œaûlb_lšk_fšd
(cÚ¡ 
sÿm³r_Œaûlb_t
 *,

319 
sÿm³r_Œaûlb_lšk_t
 *);

320 
sÿm³r_Œaûlb_lšk_ä“
(
sÿm³r_Œaûlb_lšk_t
 *);

321 
sÿm³r_Œaûlb_lšk_cmp
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *,

322 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *);

323 
sÿm³r_Œaûlb_lšk_add
(
sÿm³r_Œaûlb_t
 *, 
sÿm³r_Œaûlb_lšk_t
 *);

324 
sÿm³r_Œaûlb_lšk_z”Ùfwd
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *);

325 
sÿm³r_Œaûlb_lšk_´obe£t
(
sÿm³r_Œaûlb_lšk_t
 *,

326 
sÿm³r_Œaûlb_´obe£t_t
 *);

327 
sÿm³r_Œaûlb_lšk_´obe£ts_®loc
(
sÿm³r_Œaûlb_lšk_t
 *, 
ušt8_t
);

333 
sÿm³r_Œaûlb_´obe£t_t
 *
sÿm³r_Œaûlb_´obe£t_®loc
();

334 
sÿm³r_Œaûlb_´obe£t_ä“
(
sÿm³r_Œaûlb_´obe£t_t
 *);

335 
sÿm³r_Œaûlb_´obe£t_add
(
sÿm³r_Œaûlb_´obe£t_t
 *,

336 
sÿm³r_Œaûlb_´obe_t
 *);

337 
sÿm³r_Œaûlb_´obe£t_´obes_®loc
(
sÿm³r_Œaûlb_´obe£t_t
 *,

338 
ušt16_t
);

344 
sÿm³r_Œaûlb_nodes_®loc
(
sÿm³r_Œaûlb_t
 *, 
ušt16_t
);

345 
sÿm³r_Œaûlb_lšks_®loc
(
sÿm³r_Œaûlb_t
 *, 
ušt16_t
);

355 
sÿm³r_Œaûlb_fwd·thc
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
, *
fwd·thc
);

366 
sÿm³r_Œaûlb_node_cÚv”g’ûpošt
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

367 cÚ¡ *
fwd·thc
,

368 
äom
, *
to
);

379 
sÿm³r_Œaûlb_nodes_exŒaù
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

380 
sÿm³r_Œaûlb_node_t
 *
äom
,

381 
sÿm³r_Œaûlb_node_t
 *
to
,

382 
sÿm³r_Œaûlb_node_t
 **
nodes
);

	@tracelb/scamper_tracelb_do.c

29 #iâdeà
lšt


30 cÚ¡ 
	grcsid
[] =

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

37 
	~"š‹º®.h
"

39 
	~"sÿm³r.h
"

40 
	~"sÿm³r_addr.h
"

41 
	~"sÿm³r_li¡.h
"

42 
	~"sÿm³r_icm³xt.h
"

43 
	~"sÿm³r_Œaûlb.h
"

44 
	~"sÿm³r_sk.h
"

45 
	~"sÿm³r_icmp_»¥.h
"

46 
	~"sÿm³r_dl.h
"

47 
	~"sÿm³r_fds.h
"

48 
	~"sÿm³r_dlhdr.h
"

49 
	~"sÿm³r_¹sock.h
"

50 
	~"sÿm³r_´obe.h
"

51 
	~"sÿm³r_g‘¤c.h
"

52 
	~"sÿm³r_udp4.h
"

53 
	~"sÿm³r_udp6.h
"

54 
	~"sÿm³r_icmp4.h
"

55 
	~"sÿm³r_icmp6.h
"

56 
	~"sÿm³r_queue.h
"

57 
	~"sÿm³r_fe.h
"

58 
	~"sÿm³r_İtiÚs.h
"

59 
	~"sÿm³r_debug.h
"

60 
	~"sÿm³r_Œaûlb_do.h
"

61 
	~"uts.h
"

62 
	~"mjl_li¡.h
"

63 
	~"mjl_h—p.h
"

65 
	#SCAMPER_DO_TRACELB_ATTEMPTS_MIN
 1

	)

66 
	#SCAMPER_DO_TRACELB_ATTEMPTS_DEF
 2

	)

67 
	#SCAMPER_DO_TRACELB_ATTEMPTS_MAX
 5

	)

69 
	#SCAMPER_DO_TRACELB_PORT_MIN
 1

	)

70 
	#SCAMPER_DO_TRACELB_PORT_MAX
 65535

	)

72 
	#SCAMPER_DO_TRACELB_DPORT_DEF
 (32768+666+1)

	)

74 
	#SCAMPER_DO_TRACELB_FIRSTHOP_MIN
 1

	)

75 
	#SCAMPER_DO_TRACELB_FIRSTHOP_DEF
 1

	)

76 
	#SCAMPER_DO_TRACELB_FIRSTHOP_MAX
 254

	)

78 
	#SCAMPER_DO_TRACELB_GAPLIMIT_MIN
 1

	)

79 
	#SCAMPER_DO_TRACELB_GAPLIMIT_DEF
 3

	)

80 
	#SCAMPER_DO_TRACELB_GAPLIMIT_MAX
 5

	)

82 
	#SCAMPER_DO_TRACELB_PROBECMAX_MIN
 50

	)

83 
	#SCAMPER_DO_TRACELB_PROBECMAX_DEF
 3000

	)

84 
	#SCAMPER_DO_TRACELB_PROBECMAX_MAX
 65535

	)

86 
	#SCAMPER_DO_TRACELB_TOS_MIN
 0

	)

87 
	#SCAMPER_DO_TRACELB_TOS_DEF
 0

	)

88 
	#SCAMPER_DO_TRACELB_TOS_MAX
 255

	)

90 
	#SCAMPER_DO_TRACELB_WAITPROBE_MIN
 15

	)

91 
	#SCAMPER_DO_TRACELB_WAITPROBE_DEF
 25

	)

92 
	#SCAMPER_DO_TRACELB_WAITPROBE_MAX
 200

	)

94 
	#SCAMPER_DO_TRACELB_WAITTIMEOUT_MIN
 1

	)

95 
	#SCAMPER_DO_TRACELB_WAITTIMEOUT_DEF
 5

	)

96 
	#SCAMPER_DO_TRACELB_WAITTIMEOUT_MAX
 10

	)

98 cÚ¡ 
ušt8_t
 
	gMODE_RTSOCK
 = 0;

99 cÚ¡ 
ušt8_t
 
	gMODE_DLHDR
 = 1;

100 cÚ¡ 
ušt8_t
 
	gMODE_FIRSTADDR
 = 2;

101 cÚ¡ 
ušt8_t
 
	gMODE_FIRSTHOP
 = 3;

102 cÚ¡ 
ušt8_t
 
	gMODE_HOPPROBE
 = 4;

103 cÚ¡ 
ušt8_t
 
	gMODE_PERPACKET
 = 5;

104 cÚ¡ 
ušt8_t
 
	gMODE_BRINGFWD
 = 6;

105 cÚ¡ 
ušt8_t
 
	gMODE_BRINGFWD0
 = 7;

106 cÚ¡ 
ušt8_t
 
	gMODE_CLUMP
 = 8;

109 
Œaûlb_lšk
 
	tŒaûlb_lšk_t
;

110 
Œaûlb_·th
 
	tŒaûlb_·th_t
;

111 
Œaûlb_´obe
 
	tŒaûlb_´obe_t
;

119 
	sŒaûlb_lšk


121 
sÿm³r_Œaûlb_lšk_t
 *
	mlšk
;

122 
¦i¡_t
 *
	mæowids
;

123 
Œaûlb_·th
 *
	m·th
;

132 
	sŒaûlb_·th


141 
Œaûlb_·th_t
 **
	mback
;

142 
	mbackc
;

143 
Œaûlb_lšk_t
 **
	mlšks
;

144 
	mlškc
;

145 
Œaûlb_·th_t
 **
	mfwd
;

146 
	mfwdc
;

154 
	mvis™ed
;

155 
	mdi¡ªû
;

168 
	sŒaûlb_bršgfwd


170 
Œaûlb_·th_t
 *
	m·th
;

171 
	mk
;

172 } 
	tŒaûlb_bršgfwd_t
;

179 
	sŒaûlb_æowid


181 
ušt16_t
 
	mid
;

182 
ušt8_t
 
	m‰l
;

183 } 
	tŒaûlb_æowid_t
;

186 
	sŒaûlb_Ãwnode


188 
sÿm³r_Œaûlb_node_t
 *
	mnode
;

189 
sÿm³r_Œaûlb_´obe_t
 *
	m´obe
;

190 } 
	tŒaûlb_Ãwnode_t
;

197 
	sŒaûlb_b¿nch


199 
Œaûlb_·th_t
 *
	m·th
;

200 
timev®
 
	mÏ¡_tx
;

201 
timev®
 
	mÃxt_tx
;

202 
ušt8_t
 
	mmode
;

203 
	mk
;

204 
	ml
;

205 
	mn
;

206 
Œaûlb_bršgfwd_t
 **
	mbršgfwd
;

207 
	mbršgfwdc
;

208 
	mbršgfwd0
;

209 
h—p_node_t
 *
	mh—²ode
;

210 
Œaûlb_Ãwnode_t
 **
	mÃwnodes
;

211 
	mÃwnodec
;

212 
Œaûlb_´obe_t
 **
	m´obes
;

213 
	m´obec
;

214 } 
	tŒaûlb_b¿nch_t
;

222 
	sŒaûlb_´obe


224 
Œaûlb_lšk_t
 *
	mlšk
;

225 
Œaûlb_b¿nch_t
 *
	mb¿nch
;

226 
sÿm³r_Œaûlb_´obe_t
 *
	m´obe
;

227 
ušt16_t
 
	mid
;

228 
ušt8_t
 
	mmode
;

236 
	sŒaûlb_¡©e


238 
ušt8_t
 
	mcÚfid’û
;

239 
sÿm³r_fd_t
 *
	micmp
;

240 
sÿm³r_fd_t
 *
	m´obe
;

241 
sÿm³r_fd_t
 *
	mdl
;

243 #iâdeà
_WIN32


244 
sÿm³r_fd_t
 *
	m¹sock
;

247 
sÿm³r_rou‹_t
 *
	mrou‹
;

248 
sÿm³r_dlhdr_t
 *
	mdlhdr
;

249 
timev®
 
	mÃxt_tx
;

250 
ušt16_t
 
	m·ylßd_size
;

251 
Œaûlb_´obe_t
 **
	m´obes
;

252 
ušt16_t
 
	mid_Ãxt
;

253 
ušt16_t
 
	mæowid_Ãxt
;

254 
h—p_t
 *
	maùive
;

255 
h—p_t
 *
	mwa™šg
;

256 
Œaûlb_lšk_t
 **
	mlšks
;

257 
	mlškc
;

258 
Œaûlb_·th_t
 **
	m·ths
;

259 
	m·thc
;

260 } 
	tŒaûlb_¡©e_t
;

263 
sÿm³r_addrÿche_t
 *
addrÿche
;

266 
ušt8_t
 *
	gpktbuf
 = 
NULL
;

267 
size_t
 
	gpktbuf_Ën
 = 0;

270 
sÿm³r_sk_funcs_t
 
	gfuncs
;

272 
	#TRACE_OPT_CONFIDENCE
 1

	)

273 
	#TRACE_OPT_DPORT
 2

	)

274 
	#TRACE_OPT_FIRSTHOP
 3

	)

275 
	#TRACE_OPT_GAPLIMIT
 4

	)

276 
	#TRACE_OPT_PROTOCOL
 5

	)

277 
	#TRACE_OPT_ATTEMPTS
 6

	)

278 
	#TRACE_OPT_PROBECMAX
 7

	)

279 
	#TRACE_OPT_SPORT
 8

	)

280 
	#TRACE_OPT_TOS
 9

	)

281 
	#TRACE_OPT_USERID
 10

	)

282 
	#TRACE_OPT_WAITTIMEOUT
 11

	)

283 
	#TRACE_OPT_WAITPROBE
 12

	)

285 cÚ¡ 
sÿm³r_İtiÚ_š_t
 
	gİts
[] = {

286 {'c', 
NULL
, 
TRACE_OPT_CONFIDENCE
, 
SCAMPER_OPTION_TYPE_NUM
},

287 {'d', 
NULL
, 
TRACE_OPT_DPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

288 {'f', 
NULL
, 
TRACE_OPT_FIRSTHOP
, 
SCAMPER_OPTION_TYPE_NUM
},

289 {'g', 
NULL
, 
TRACE_OPT_GAPLIMIT
, 
SCAMPER_OPTION_TYPE_NUM
},

290 {'P', 
NULL
, 
TRACE_OPT_PROTOCOL
, 
SCAMPER_OPTION_TYPE_STR
},

291 {'q', 
NULL
, 
TRACE_OPT_ATTEMPTS
, 
SCAMPER_OPTION_TYPE_NUM
},

292 {'Q', 
NULL
, 
TRACE_OPT_PROBECMAX
, 
SCAMPER_OPTION_TYPE_NUM
},

293 {'s', 
NULL
, 
TRACE_OPT_SPORT
, 
SCAMPER_OPTION_TYPE_NUM
},

294 {'t', 
NULL
, 
TRACE_OPT_TOS
, 
SCAMPER_OPTION_TYPE_NUM
},

295 {'U', 
NULL
, 
TRACE_OPT_USERID
, 
SCAMPER_OPTION_TYPE_NUM
},

296 {'w', 
NULL
, 
TRACE_OPT_WAITTIMEOUT
, 
SCAMPER_OPTION_TYPE_NUM
},

297 {'W', 
NULL
, 
TRACE_OPT_WAITPROBE
, 
SCAMPER_OPTION_TYPE_NUM
},

299 cÚ¡ 
	gİts_út
 = 
SCAMPER_OPTION_COUNT
(
İts
);

301 cÚ¡ *
	$sÿm³r_do_Œaûlb_u§ge
()

306 
	}
}

308 
Œaûlb_¡©e_t
 *
	$Œaûlb_g‘¡©e
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

310  
	`sÿm³r_sk_g‘¡©e
(
sk
);

311 
	}
}

313 
sÿm³r_Œaûlb_t
 *
	$Œaûlb_g‘d©a
(cÚ¡ 
sÿm³r_sk_t
 *
sk
)

315  
	`sÿm³r_sk_g‘d©a
(
sk
);

316 
	}
}

318 
	$k
(
Œaûlb_¡©e_t
 *
¡©e
, 
n
)

326 cÚ¡ 
k
[][2] = {

349 
	#TRACELB_CONFIDENCE_MAX_N
 99

	)

350 
	#TRACELB_CONFIDENCE_NLIMIT
(
v
) \

351 ((
v
è<ğ
TRACELB_CONFIDENCE_MAX_N
 ? (vè: TRACELB_CONFIDENCE_MAX_N)

	)

353 
	`as£¹
(
¡©e
->
cÚfid’û
 < 2);

354 
	`as£¹
(
n
 >= 2);

355 
	`as£¹
(
n
 <ğ
TRACELB_CONFIDENCE_MAX_N
);

357  
k
[
n
][
¡©e
->
cÚfid’û
];

358 
	}
}

360 
	$Œaûlb_hªdË”rÜ
(
sÿm³r_sk_t
 *
sk
, 
”r
)

362 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

363 
Œaû
->
”rÜ
 = 
”r
;

364 
	`sÿm³r_debug
(
__func__
, "%d", 
”r
);

365 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

367 
	}
}

369 #ifdeà
NDEBUG


370 
	#Œaûlb_·ths_as£¹
(
¡©e
è(()0)

	)

371 
	#Œaûlb_·ths_dump
(
¡©e
è(()0)

	)

372 
	#Œaûlb_lšks_dump
(
¡©e
è(()0)

	)

375 #iâdeà
NDEBUG


376 
	$Œaûlb_·ths_loİ_fwd
(
Œaûlb_·th_t
 *
·th
,¿ûlb_·th_ˆ*
node
)

378 
i
;

379 
i
=0; i<
·th
->
fwdc
; i++)

381 if(
·th
->
fwd
[
i
] =ğ
node
)

383 if(
	`Œaûlb_·ths_loİ_fwd
(
·th
->
fwd
[
i
], 
node
) != 0)

387 
	}
}

389 
	$Œaûlb_·ths_loİ_back
(
Œaûlb_·th_t
 *
·th
,¿ûlb_·th_ˆ*
node
)

391 
i
;

392 
i
=0; i<
·th
->
backc
; i++)

394 if(
·th
->
back
[
i
] =ğ
node
)

396 if(
	`Œaûlb_·ths_loİ_back
(
·th
->
back
[
i
], 
node
) != 0)

400 
	}
}

402 
	$Œaûlb_·ths_as£¹
(
Œaûlb_¡©e_t
 *
¡©e
)

404 
Œaûlb_·th_t
 *
·th
;

405 
i
, 
j
, 
d
, 
p
;

407 
p
=0;…<
¡©e
->
·thc
;…++)

409 
·th
 = 
¡©e
->
·ths
[
p
];

411 
	`as£¹
(
·th
->
lškc
 >= 0);

412 if(
·th
->
lškc
 == 0)

413 
	`as£¹
(
·th
->
lšks
 =ğ
NULL
);

415 
	`as£¹
(
·th
->
lšks
 !ğ
NULL
);

417 
	`as£¹
(
·th
->
fwdc
 >= 0);

418 if(
·th
->
fwdc
 == 0)

419 
	`as£¹
(
·th
->
fwd
 =ğ
NULL
);

421 
	`as£¹
(
·th
->
fwd
 !ğ
NULL
);

423 
	`as£¹
(
·th
->
backc
 >= 0);

424 if(
·th
->
backc
 == 0)

425 
	`as£¹
(
·th
->
back
 =ğ
NULL
);

427 
	`as£¹
(
·th
->
back
 !ğ
NULL
);

429 if(
·th
->
lškc
 =ğ0 &&…©h->
backc
 > 0)

431 
i
=0; i<
·th
->
backc
; i++)

432 
	`as£¹
(
·th
->
back
[
i
]->
lškc
 > 0);

435 
i
=0; i<
·th
->
lškc
; i++)

437 
	`as£¹
(
·th
->
lšks
[
i
]->path ==…ath);

438 
	`as£¹
(
·th
->
lšks
[
i
]->
lšk
 !ğ
NULL
);

439 
	`as£¹
(
·th
->
lšks
[
i
]->
lšk
->
äom
 !ğ
NULL
);

440 if(
i
+1 !ğ
·th
->
lškc
 ||…©h->
fwdc
 > 0)

441 
	`as£¹
(
·th
->
lšks
[
i
]->
lšk
->
to
 !ğ
NULL
);

444 
d
 = 0;

445 
i
=0; i<
·th
->
backc
; i++)

447 
	`as£¹
(
·th
->
back
[
i
]->
fwdc
 > 0);

449 if(
·th
->
back
[
i
]->
di¡ªû
 > 
d
)

450 
d
 = 
·th
->
back
[
i
]->
di¡ªû
;

452 
j
=0; j<
·th
->
back
[
i
]->
fwdc
; j++)

454 
	`as£¹
(
·th
->
di¡ªû
 >…©h->
back
[
i
]->distance);

455 if(
·th
->
back
[
i
]->
fwd
[
j
] ==…ath)

459 
	`as£¹
(
j
 !ğ
·th
->
back
[
i
]->
fwdc
);

462 if(
·th
->
backc
 > 0)

463 
	`as£¹
(
d
 + 1 =ğ
·th
->
di¡ªû
);

465 
i
=0; i<
·th
->
fwdc
; i++)

467 
	`as£¹
(
·th
->
fwd
[
i
]->
backc
 > 0);

468 
j
=0; j<
·th
->
fwd
[
i
]->
backc
; j++)

470 if(
·th
->
fwd
[
i
]->
back
[
j
] ==…ath)

473 
	`as£¹
(
j
 !ğ
·th
->
fwd
[
i
]->
backc
);

476 
	`as£¹
(
	`Œaûlb_·ths_loİ_fwd
(
·th
,…ath) == 0);

477 
	`as£¹
(
	`Œaûlb_·ths_loİ_back
(
·th
,…ath) == 0);

481 
	}
}

483 
	$Œaûlb_·ths_dump
(
Œaûlb_¡©e_t
 *
¡©e
)

485 
Œaûlb_·th_t
 *
·th
;

486 
Œaûlb_lšk_t
 *
lšk
;

487 
buf
[4096], 
addr
[64];

488 
size_t
 
off
;

489 
i
, 
c
, 
p
;

491 
p
=0;…<
¡©e
->
·thc
;…++)

493 
·th
 = 
¡©e
->
·ths
[
p
];

494 
off
 = 0;

496 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%p: %d %d %d %d", 
·th
,

497 
·th
->
di¡ªû
,…©h->
backc
,…©h->
lškc
,…©h->
fwdc
);

498 if(
·th
->
lškc
 > 0)

500 if(
·th
->
lšks
[0]->
lšk
->
äom
->
addr
 !ğ
NULL
)

502 
	`sÿm³r_addr_to¡r
(
·th
->
lšks
[0]->
lšk
->
äom
->
addr
,

503 
addr
, (addr));

504 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %s", 
addr
);

508 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " +");

511 
i
=0; i<
·th
->
lškc
; i++)

513 
lšk
 = 
·th
->
lšks
[
i
];

515 if(
lšk
->lšk->
to
 =ğ
NULL
)

517 
c
=0; c<
lšk
->lšk->
hİc
; c++)

518 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " +");

522 
c
=1; c<
lšk
->lšk->
hİc
; c++)

523 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " +");

524 
	`sÿm³r_addr_to¡r
(
lšk
->lšk->
to
->
addr
,‡ddr, (addr));

525 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %s", 
addr
);

528 if(
lšk
->
æowids
 !ğ
NULL
 && (
c
=
	`¦i¡_couÁ
(link->flowids)) != 0)

529 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " (%d)", 
c
);

533 
i
=0; i<
·th
->
fwdc
; i++)

534 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %p", 
·th
->
fwd
[
i
]);

536 
	`sÿm³r_debug
(
__func__
, "%s", 
buf
);

540 
	}
}

542 
	$Œaûlb_lšks_dump
(
Œaûlb_¡©e_t
 *
¡©e
)

544 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

545 
sÿm³r_Œaûlb_node_t
 *
node
;

546 
Œaûlb_lšk_t
 *
bl
;

547 
buf
[256], 
addr
[64];

548 
size_t
 
off
;

549 
i
, 
j
;

551 
i
=0; i<
¡©e
->
lškc
; i++)

553 
bl
 = 
¡©e
->
lšks
[
i
];

554 
lšk
 = 
bl
->link;

555 
off
 = 0;

557 
node
 = 
lšk
->
äom
;

558 if(
node
->
addr
 !ğ
NULL
)

560 
	`sÿm³r_addr_to¡r
(
node
->
addr
,‡ddr, (addr));

561 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "%s", 
addr
);

562 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
node
))

563 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",%d", 
node
->
q_‰l
);

566 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, "*");

568 
j
=1; j<
lšk
->
hİc
; j++)

569 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " +");

571 if(
lšk
->
to
 =ğ
NULL
)

573 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " *");

577 
node
 = 
lšk
->
to
;

578 
	`sÿm³r_addr_to¡r
(
node
->
addr
,‡ddr, (addr));

579 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, " %s", 
addr
);

580 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
node
))

581 
	`¡ršg_cÚÿt
(
buf
, (buf), &
off
, ",%d", 
node
->
q_‰l
);

584 
	`sÿm³r_debug
(
__func__
, "%s", 
buf
);

588 
	}
}

600 
Œaûlb_lšk_t
 *
	$Œaûlb_i¦oİ_addr
(cÚ¡ 
Œaûlb_·th_t
 *
·th
,

601 cÚ¡ 
sÿm³r_addr_t
 *
addr
)

603 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
;

604 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

605 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

606 
Œaûlb_lšk_t
 *
bl
;

607 
i
, 
j
;

608 
ušt16_t
 
k
, 
l
;

610 
i
=
·th
->
lškc
-1; i>=0; i--)

613 
bl
 = 
·th
->
lšks
[
i
]; 
	`as£¹
ÑlbÈ!ğ
NULL
);

616 if((
lšk
 = 
bl
->lškè=ğ
NULL
)

619 if(
lšk
->
äom
->
addr
 =ğ
NULL
)

623 if(
	`sÿm³r_addr_cmp
(
lšk
->
äom
->
addr
,‡ddr) == 0)

624  
bl
;

627 
j
=0; j<
lšk
->
hİc
-1; j++)

629 
£t
 = 
lšk
->
£ts
[
j
];

630 
k
=0; k<
£t
->
´obec
; k++)

632 
´obe
 = 
£t
->
´obes
[
k
];

633 
l
=0;†<
´obe
->
rxc
;†++)

634 if(
	`sÿm³r_addr_cmp
(
´obe
->
rxs
[
l
]->
»¶y_äom
, 
addr
) == 0)

635  
bl
;

640 
i
=0; i<
·th
->
backc
; i++)

642 if((
bl
 = 
	`Œaûlb_i¦oİ_addr
(
·th
->
back
[
i
], 
addr
)è!ğ
NULL
)

644  
bl
;

648  
NULL
;

649 
	}
}

657 
Œaûlb_lšk_t
 *
	$Œaûlb_i¦oİ
(cÚ¡ 
Œaûlb_·th_t
 *
·th
)

663 
	`as£¹
(
·th
->
lškc
 > 0);

670 if(
	`sÿm³r_Œaûlb_lšk_z”Ùfwd
(
·th
->
lšks
[·th->
lškc
-1]->
lšk
) != 0)

675  
	`Œaûlb_i¦oİ_addr
(
·th
,…©h->
lšks
[·th->
lškc
-1]->
lšk
->
to
->
addr
);

676 
	}
}

685 
	$Œaûlb_lšk_cÚtšue
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

686 cÚ¡ 
Œaûlb_·th_t
 *
·th
,

687 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

689 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
;

690 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

691 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

692 
ušt16_t
 
i
, 
j
;

695 if(
lšk
->
to
 !ğ
NULL
 && 
	`sÿm³r_addr_cmp
(
Œaû
->
d¡
,†šk->to->
addr
) == 0)

697 
	`sÿm³r_debug
(
__func__
, "reached destination");

702 
£t
 = 
lšk
->
£ts
[lšk->
hİc
-1];

703 
i
=0; i<
£t
->
´obec
; i++)

705 
´obe
 = 
£t
->
´obes
[
i
];

706 
j
=0; j<
´obe
->
rxc
; j++)

708 
»¶y
 = 
´obe
->
rxs
[
j
];

709 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) == 0)

711 
	`sÿm³r_debug
(
__func__
, "%d/%d‚Ùimexûeded", 
i
, 
j
);

718 if(
	`Œaûlb_i¦oİ
(
·th
è!ğ
NULL
)

720 
	`sÿm³r_debug
(
__func__
, "loopƒncountered");

725 
	}
}

732 
	$Œaûlb_£t_vis™ed0
(
Œaûlb_¡©e_t
 *
¡©e
)

734 
i
;

735 
i
=0; i<
¡©e
->
·thc
; i++)

736 
¡©e
->
·ths
[
i
]->
vis™ed
 = 0;

738 
	}
}

740 
	$Œaûlb_bršgfwd_ä“
(
Œaûlb_b¿nch_t
 *
br
)

742 
i
;

743 if(
br
->
bršgfwd
 !ğ
NULL
)

745 
i
=0; i<
br
->
bršgfwdc
; i++)

746 if(
br
->
bršgfwd
[
i
] !ğ
NULL
)

747 
	`ä“
(
br
->
bršgfwd
[
i
]);

748 
	`ä“
(
br
->
bršgfwd
);

749 
br
->
bršgfwd
 = 
NULL
;

751 
br
->
bršgfwdc
 = 0;

753 
	}
}

755 
	$Œaûlb_bršgfwd_add
(
Œaûlb_b¿nch_t
 *
br
, 
Œaûlb_·th_t
 *
·th
)

757 
Œaûlb_bršgfwd_t
 *
bf
;

758 if((
bf
 = 
	`m®loc_z”o
((
Œaûlb_bršgfwd_t
))è=ğ
NULL
)

760 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc");

763 
bf
->
·th
 =…ath;

764 
br
->
bršgfwd
[br->
bršgfwdc
++] = 
bf
;

766 
	}
}

774 
	$Œaûlb_bršgfwd_dá
(
Œaûlb_b¿nch_t
 *
b¿nch
, 
Œaûlb_·th_t
 *
·th
)

776 
i
, 
x
, 
rc
 = 0;

778 
	`as£¹
(
·th
 !ğ
NULL
);

780 if(
·th
->
vis™ed
 != 0)

783 if(
·th
->
backc
 == 0)

785 if(
	`Œaûlb_bršgfwd_add
(
b¿nch
, 
·th
) != 0)

787 
·th
->
vis™ed
 = 1;

791 
i
=0; i<
·th
->
backc
; i++)

793 if((
x
 = 
	`Œaûlb_bršgfwd_dá
(
b¿nch
, 
·th
->
back
[
i
])) == 1)

794 
rc
 = 1;

795 if(
x
 == -1)

799 if(
rc
 != 0)

801 if(
	`Œaûlb_bršgfwd_add
(
b¿nch
, 
·th
) != 0)

803 
·th
->
vis™ed
 = 1;

806  
rc
;

807 
	}
}

814 
	$Œaûlb_bršgfwd_£t
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_b¿nch_t
 *
br
,

815 
Œaûlb_lšk_t
 *
bl
, 
£t
)

817 
Œaûlb_·th_t
 *
·th
;

818 
i
, 
n
;

820 
i
=0; i<
br
->
bršgfwdc
; i++)

822 
·th
 = 
br
->
bršgfwd
[
i
]->path;

823 if(
·th
 =ğ
bl
->path)

825 
	`as£¹
(
·th
->
lšks
[·th->
lškc
-1] =ğ
bl
);

826 
n
 = 
	`TRACELB_CONFIDENCE_NLIMIT
(
·th
->
fwdc
+2);

828 if(
£t
 != 0)

830 
br
->
bršgfwd
[
i
]->
k
++;

831 if(
br
->
bršgfwd
[
i
]->
k
 >ğ
	`k
(
¡©e
, 
n
))

837 
br
->
bršgfwd
[
i
]->
k
 = 0;

839 
	`sÿm³r_debug
(
__func__
, "set %d i %d k %d < %d",

840 
£t
, 
i
, 
br
->
bršgfwd
[i]->
k
, 
	`k
(
¡©e
, 
n
));

845 
	`as£¹
(
i
 !ğ
br
->
bršgfwdc
);

848 
	}
}

850 
	$Œaûlb_æowids_li¡_add
(
¦i¡_t
 *
li¡
, 
Œaûlb_´obe_t
 *
´
)

852 
Œaûlb_æowid_t
 *
tf
;

854 
	`as£¹
(
´
->
mode
 !ğ
MODE_PERPACKET
);

855 
	`as£¹
(
´
->
mode
 !ğ
MODE_BRINGFWD0
);

856 
	`as£¹
(
´
->
mode
 !ğ
MODE_BRINGFWD
);

858 if((
tf
 = 
	`m®loc
((
Œaûlb_æowid_t
))è=ğ
NULL
)

860 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc flowid");

863 
tf
->
id
 = 
´
->
´obe
->
æowid
;

864 
tf
->
‰l
 = 
´
->
´obe
->ttl;

866 if(
	`¦i¡__push
(
li¡
, 
tf
è=ğ
NULL
)

868 
	`ä“
(
tf
);

869 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot slist_tail_push");

874 
	}
}

876 
	$Œaûlb_æowids_li¡_ä“
(
¦i¡_t
 *
li¡
)

878 
Œaûlb_æowid_t
 *
tf
;

880 if(
li¡
 =ğ
NULL
)

883 (
tf
 = 
	`¦i¡_h—d_pİ
(
li¡
)è!ğ
NULL
)

884 
	`ä“
(
tf
);

886 
	`¦i¡_ä“
(
li¡
);

888 
	}
}

896 
Œaûlb_æowid_t
 *
	$Œaûlb_lšk_æowid_g‘
(
Œaûlb_lšk_t
 *
lšk
)

898 
Œaûlb_æowid_t
 *
tf
;

900 if(
lšk
->
æowids
 =ğ
NULL
)

901  
NULL
;

903 
tf
 = 
	`¦i¡_h—d_pİ
(
lšk
->
æowids
);

905 if(
	`¦i¡_couÁ
(
lšk
->
æowids
) == 0)

907 
	`¦i¡_ä“
(
lšk
->
æowids
);

908 
lšk
->
æowids
 = 
NULL
;

911  
tf
;

912 
	}
}

919 
	$Œaûlb_lšk_cmp
(cÚ¡ 
Œaûlb_lšk_t
 *
a
, cÚ¡¿ûlb_lšk_ˆ*
b
)

921 
	`as£¹
(
a
 !ğ
NULL
);‡s£¹×->
lšk
 != NULL);

922 
	`as£¹
(
b
 !ğ
NULL
);‡s£¹(b->
lšk
 != NULL);

923  
	`sÿm³r_Œaûlb_lšk_cmp
(
a
->
lšk
, 
b
->link);

924 
	}
}

931 
	$Œaûlb_cmp_node2»¶y
(cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
,

932 cÚ¡ 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
)

934 
sÿm³r_Œaûlb_node_t
 
cmp
;

936 
	`mem£t
(&
cmp
, 0, (cmp));

937 
cmp
.
addr
 = 
»¶y
->
»¶y_äom
;

938 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ||

939 
	`SCAMPER_TRACELB_REPLY_IS_ICMP_UNREACH
(
»¶y
))

941 
cmp
.
q_‰l
 = 
»¶y
->
»¶y_icmp_q_‰l
;

942 
cmp
.
æags
 |ğ
SCAMPER_TRACELB_NODE_FLAG_QTTL
;

945  
	`sÿm³r_Œaûlb_node_cmp
(
node
, &
cmp
);

946 
	}
}

948 
	$Œaûlb_Ãwnode_cmp
(cÚ¡ 
Œaûlb_Ãwnode_t
 *
a
,

949 cÚ¡ 
Œaûlb_Ãwnode_t
 *
b
)

951  
	`sÿm³r_Œaûlb_node_cmp
(
a
->
node
, 
b
->node);

952 
	}
}

954 
Œaûlb_Ãwnode_t
 *
	$Œaûlb_Ãwnode_fšd
(
Œaûlb_b¿nch_t
 *
br
,

955 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
)

957 
Œaûlb_Ãwnode_t
 
fšdme
;

958 
sÿm³r_Œaûlb_node_t
 
node
;

960 
	`mem£t
(&
node
, 0, (node));

961 
fšdme
.
node
 = &node;

963 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ||

964 
	`SCAMPER_TRACELB_REPLY_IS_ICMP_UNREACH
(
»¶y
))

966 
node
.
q_‰l
 = 
»¶y
->
»¶y_icmp_q_‰l
;

967 
node
.
æags
 |ğ
SCAMPER_TRACELB_NODE_FLAG_QTTL
;

969 
node
.
addr
 = 
»¶y
->
»¶y_äom
;

971  
	`¬¿y_fšd
((**)
br
->
Ãwnodes
, br->
Ãwnodec
, &
fšdme
,

972 (
¬¿y_cmp_t
)
Œaûlb_Ãwnode_cmp
);

973 
	}
}

975 
	$Œaûlb_Ãwnode_add
(
Œaûlb_b¿nch_t
 *
br
,

976 
sÿm³r_Œaûlb_´obe_t
 *
´obe
)

978 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

979 
Œaûlb_Ãwnode_t
 *
Ãwnode
;

981 
	`as£¹
(
´obe
->
rxc
 == 1);

983 if((
Ãwnode
 = 
	`m®loc_z”o
((
Œaûlb_Ãwnode_t
))è=ğ
NULL
)

985 
”r
;

987 
Ãwnode
->
´obe
 =…robe;

989 
»¶y
 = 
´obe
->
rxs
[0];

990 if((
Ãwnode
->
node
 = 
	`sÿm³r_Œaûlb_node_®loc
(
»¶y
->
»¶y_äom
)è=ğ
NULL
)

992 
”r
;

994 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
»¶y
) ||

995 
	`SCAMPER_TRACELB_REPLY_IS_ICMP_UNREACH
(
»¶y
))

997 
Ãwnode
->
node
->
q_‰l
 = 
»¶y
->
»¶y_icmp_q_‰l
;

998 
Ãwnode
->
node
->
æags
 |ğ
SCAMPER_TRACELB_NODE_FLAG_QTTL
;

1001 if(
	`¬¿y_š£¹
((***)&
br
->
Ãwnodes
, &br->
Ãwnodec
, 
Ãwnode
,

1002 (
¬¿y_cmp_t
)
Œaûlb_Ãwnode_cmp
) != 0)

1004 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚odeo branch");

1005 
”r
;

1010 
”r
:

1012 
	}
}

1019 
Œaûlb_lšk_t
 *
	$Œaûlb_lšk_®loc
(
Œaûlb_¡©e_t
 *
¡©e
,

1020 
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

1021 
Œaûlb_·th_t
 *
·th
)

1023 
Œaûlb_lšk_t
 *
bl
;

1025 if((
bl
 = 
	`m®loc_z”o
((
Œaûlb_lšk_t
))è=ğ
NULL
)

1027 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloclbl");

1028  
NULL
;

1030 
bl
->
lšk
 =†ink;

1031 
bl
->
·th
 =…ath;

1033 if(
	`¬¿y_š£¹
((***)&
¡©e
->
lšks
, &¡©e->
lškc
, 
bl
,

1034 (
¬¿y_cmp_t
)
Œaûlb_lšk_cmp
) != 0)

1036 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insertlbl");

1037 
	`ä“
(
bl
);

1038  
NULL
;;

1041  
bl
;

1042 
	}
}

1044 
Œaûlb_lšk_t
 *
	$Œaûlb_lšk_fšd
(
Œaûlb_¡©e_t
 *
¡©e
,

1045 
sÿm³r_Œaûlb_lšk_t
 *
lšk
)

1047 
Œaûlb_lšk_t
 
fšdme
;

1048 
fšdme
.
lšk
 =†ink;

1049  (
Œaûlb_lšk_t
 *)
	`¬¿y_fšd
((**)
¡©e
->
lšks
, s‹->
lškc
,

1050 &
fšdme
, (
¬¿y_cmp_t
)
Œaûlb_lšk_cmp
);

1051 
	}
}

1058 
	$Œaûlb_lšk_ä“
(
Œaûlb_lšk_t
 *
lšk
)

1060 
Œaûlb_æowid_t
 *
tf
;

1061 (
tf
 = 
	`Œaûlb_lšk_æowid_g‘
(
lšk
)è!ğ
NULL
)

1063 
	`ä“
(
tf
);

1065 
	`ä“
(
lšk
);

1067 
	}
}

1074 
	$Œaûlb_lšk_æowid_add_
(
Œaûlb_lšk_t
 *
lšk
,

1075 
sÿm³r_Œaûlb_´obe_t
 *
´obe
)

1077 
Œaûlb_æowid_t
 *
tf
;

1080 if(
lšk
->
æowids
 =ğ
NULL
 && (lšk->æowid ğ
	`¦i¡_®loc
()) == NULL)

1082 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc flowids†ist");

1086 if((
tf
 = 
	`m®loc
((
Œaûlb_æowid_t
))è=ğ
NULL
)

1088 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc flowid");

1091 
tf
->
id
 = 
´obe
->
æowid
;

1092 
tf
->
‰l
 = 
´obe
->ttl;

1094 if(
	`¦i¡__push
(
lšk
->
æowids
, 
tf
è=ğ
NULL
)

1096 
	`ä“
(
tf
);

1097 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot slist_tail_push");

1102 
	}
}

1104 
	$Œaûlb_lšk_æowids_šc
(
Œaûlb_lšk_t
 *
bl
)

1106 
Œaûlb_æowid_t
 *
tf
;

1107 
¦i¡_node_t
 *
node
;

1109 if(
bl
->
æowids
 =ğ
NULL
)

1112 
node
 = 
	`¦i¡_h—d_node
(
bl
->
æowids
);

1113 
node
 !ğ
NULL
)

1115 
tf
 = 
	`¦i¡_node_™em
(
node
);

1116 
tf
->
‰l
++;

1117 
node
 = 
	`¦i¡_node_Ãxt
(node);

1121 
	}
}

1127 
	$Œaûlb_lšk_æowids_add_li¡
(
Œaûlb_lšk_t
 *
bl
, 
¦i¡_t
 *
li¡
)

1130 if(
bl
->
æowids
 =ğ
NULL
)

1132 
bl
->
æowids
 = 
li¡
;

1136 
	`¦i¡_cÚÿt
(
li¡
, 
bl
->
æowids
);

1137 
	`¦i¡_ä“
(
bl
->
æowids
);

1138 
bl
->
æowids
 = 
li¡
;

1141 
	}
}

1148 
	$Œaûlb_´obe_add
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_b¿nch_t
 *
br
,

1149 
Œaûlb_´obe_t
 *
´
)

1151 
size_t
 
Ën
 = (
Œaûlb_´obe_t
 *è* (
¡©e
->
id_Ãxt
 + 1);

1152 if(
	`»®loc_w¿p
((**)&
¡©e
->
´obes
, 
Ën
) != 0)

1154 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù„—Îoø%d by‹s", 
Ën
);

1157 
´
->
id
 = 
¡©e
->
id_Ãxt
;

1159 
¡©e
->
´obes
[¡©e->
id_Ãxt
] = 
´
;

1160 
¡©e
->
id_Ãxt
++;

1162 if(
	`¬¿y_š£¹
((***)&
br
->
´obes
, &br->
´obec
, 
´
, 
NULL
) != 0)

1164 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…robeo branch");

1167 
´
->
b¿nch
 = 
br
;

1170 
	}
}

1177 
ušt8_t
 
	$Œaûlb_·th_Ëngth
(cÚ¡ 
Œaûlb_·th_t
 *
·th
)

1179 cÚ¡ 
Œaûlb_·th_t
 *
shÜ‹¡
;

1180 
ušt8_t
 
Ën
 = 
·th
->
lškc
;

1181 
i
;

1183 
·th
->
backc
 > 0)

1185 
shÜ‹¡
 = 
·th
->
back
[0];

1186 
i
=1; i<
·th
->
backc
; i++)

1188 if(
shÜ‹¡
->
lškc
 > 
·th
->
back
[
i
]->linkc)

1189 
shÜ‹¡
 = 
·th
->
back
[
i
];

1191 
Ën
 +ğ
shÜ‹¡
->
lškc
;

1192 
·th
 = 
shÜ‹¡
;

1195  
Ën
;

1196 
	}
}

1203 
	$Œaûlb_·th_add_lšk
(
Œaûlb_·th_t
 *
·th
, 
Œaûlb_lšk_t
 *
lšk
)

1205 if(
	`¬¿y_š£¹
((***)&
·th
->
lšks
, &·th->
lškc
, 
lšk
, 
NULL
) != 0)

1207 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd†ink");

1211 
	}
}

1218 
	$Œaûlb_·th_add_fwd
(
Œaûlb_·th_t
 *
·th
,¿ûlb_·th_ˆ*
fwd
)

1220 if(
	`¬¿y_š£¹
((***)&
·th
->
fwd
, &·th->
fwdc
, fwd, 
NULL
) != 0)

1222 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd fwd");

1226 
	}
}

1233 
	$Œaûlb_·th_add_back
(
Œaûlb_·th_t
 *
·th
,¿ûlb_·th_ˆ*
back
)

1235 if(
	`¬¿y_š£¹
((***)&
·th
->
back
, &·th->
backc
, back, 
NULL
) != 0)

1237 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd back");

1241  
	`Œaûlb_·th_add_fwd
(
back
, 
·th
);

1242 
	}
}

1244 
	$Œaûlb_·th_ä“
(
Œaûlb_·th_t
 *
·th
)

1246 if(
·th
 =ğ
NULL
)

1249 if(
·th
->
back
 !ğ
NULL
è
	`ä“
(path->back);

1250 if(
·th
->
fwd
 !ğ
NULL
è
	`ä“
(path->fwd);

1251 if(
·th
->
lšks
 !ğ
NULL
è
	`ä“
(path->links);

1252 
	`ä“
(
·th
);

1255 
	}
}

1263 
Œaûlb_·th_t
 *
	$Œaûlb_·th_®loc
(
Œaûlb_¡©e_t
 *
¡©e
, 
lškc
)

1265 
Œaûlb_·th_t
 *
·th
;

1266 
size_t
 
Ën
;

1268 
	`as£¹
(
lškc
 >= 0);

1270 if((
·th
 = 
	`m®loc_z”o
((
Œaûlb_·th_t
))è=ğ
NULL
)

1272 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…ath");

1273 
”r
;

1276 
Ën
 = (
sÿm³r_Œaûlb_lšk_t
 *è* 
lškc
;

1277 if(
lškc
 !ğ0 && (
·th
->
lšks
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

1279 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc…ath->links");

1280 
”r
;

1283 if(
	`¬¿y_š£¹
((***)&
¡©e
->
·ths
, &¡©e->
·thc
, 
·th
, 
NULL
) != 0)

1285 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert…ath");

1286 
”r
;

1289  
·th
;

1291 
”r
:

1292 
	`Œaûlb_·th_ä“
(
·th
);

1293  
NULL
;

1294 
	}
}

1302 
	$Œaûlb_bršgfwd_cmp
(cÚ¡ 
Œaûlb_bršgfwd_t
 *
a
,

1303 cÚ¡ 
Œaûlb_bršgfwd_t
 *
b
)

1305 if(
a
->
·th
->
di¡ªû
 < 
b
->path->distance)

1307 if(
a
->
·th
->
di¡ªû
 > 
b
->path->distance)

1310 
	}
}

1318 
	$Œaûlb_b¿nch_aùive_cmp
(cÚ¡ 
Œaûlb_b¿nch_t
 *
a
,

1319 cÚ¡ 
Œaûlb_b¿nch_t
 *
b
)

1321  
	`timev®_cmp
(&
b
->
Ãxt_tx
, &
a
->next_tx);

1322 
	}
}

1324 
	$Œaûlb_b¿nch_aùive
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_b¿nch_t
 *
br
)

1326 
	`as£¹
(
	`h—p_couÁ
(
¡©e
->
aùive
) == 0);

1327 
	`as£¹
(
br
->
´obec
 > 0 || br->
mode
 =ğ
MODE_RTSOCK
 || br->mod=ğ
MODE_DLHDR
);

1328 if((
br
->
h—²ode
 = 
	`h—p_š£¹
(
¡©e
->
aùive
, br)è!ğ
NULL
)

1332 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert branch on‡ctive");

1334 
	}
}

1343 
	$Œaûlb_b¿nch_wa™šg_cmp
(cÚ¡ 
Œaûlb_b¿nch_t
 *
a
,

1344 cÚ¡ 
Œaûlb_b¿nch_t
 *
b
)

1346  
	`Œaûlb_·th_Ëngth
(
b
->
·th
è-¿ûlb_·th_Ëngth(
a
->path);

1347 
	}
}

1349 
	$Œaûlb_b¿nch_wa™šg
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_b¿nch_t
 *
br
)

1351 if((
br
->
h—²ode
 = 
	`h—p_š£¹
(
¡©e
->
wa™šg
, br)è!ğ
NULL
)

1355 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot insert branch on waiting");

1357 
	}
}

1366 
	$Œaûlb_b¿nch_»£t
(
Œaûlb_b¿nch_t
 *
b¿nch
)

1368 
i
;

1370 
b¿nch
->
l
 = 0;

1371 
b¿nch
->
k
 = 0;

1372 
b¿nch
->
n
 = 2;

1374 if(
b¿nch
->
mode
 !ğ
MODE_PERPACKET
)

1377 if(
b¿nch
->
´obes
 !ğ
NULL
)

1379 
i
=0; i<
b¿nch
->
´obec
; i++)

1380 
b¿nch
->
´obes
[
i
]->b¿nch = 
NULL
;

1381 
	`ä“
(
b¿nch
->
´obes
);

1382 
b¿nch
->
´obes
 = 
NULL
;

1384 
b¿nch
->
´obec
 = 0;

1388 
	`Œaûlb_bršgfwd_ä“
(
b¿nch
);

1391 
	}
}

1393 
	$Œaûlb_b¿nch_ä“
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_b¿nch_t
 *
br
)

1395 
i
;

1397 if(
br
->
´obes
 !ğ
NULL
)

1399 
i
=0; i<
br
->
´obec
; i++)

1400 
br
->
´obes
[
i
]->
b¿nch
 = 
NULL
;

1401 
	`ä“
(
br
->
´obes
);

1404 
	`Œaûlb_bršgfwd_ä“
(
br
);

1406 if(
br
->
Ãwnodes
 !ğ
NULL
)

1407 
	`ä“
(
br
->
Ãwnodes
);

1409 
	`ä“
(
br
);

1411 
	}
}

1418 
	$Œaûlb_·th_add
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_·th_t
 *
·th
)

1420 
Œaûlb_b¿nch_t
 *
b¿nch
 = 
NULL
;

1422 if((
b¿nch
 = 
	`m®loc_z”o
((
Œaûlb_b¿nch_t
))è=ğ
NULL
)

1424 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc branch");

1425 
”r
;

1427 
b¿nch
->
mode
 = 
MODE_HOPPROBE
;

1428 
b¿nch
->
·th
 =…ath;

1429 
	`Œaûlb_b¿nch_»£t
(
b¿nch
);

1430 if(
	`Œaûlb_b¿nch_wa™šg
(
¡©e
, 
b¿nch
) != 0)

1431 
”r
;

1435 
”r
:

1436 if(
b¿nch
 !ğ
NULL
è
	`Œaûlb_b¿nch_ä“
(
¡©e
, branch);

1438 
	}
}

1446 
	$Œaûlb_·th_di¡ªû_1
(
Œaûlb_·th_t
 *
·th
, 
di¡ªû
)

1448 
i
;

1450 
	`sÿm³r_debug
(
__func__
, "·th %p,%d %d->%d", 
·th
,…©h->
vis™ed
,

1451 
·th
->
di¡ªû
, distance);

1453 
·th
->
vis™ed
++;

1454 if(
·th
->
di¡ªû
 >= distance)

1457 
·th
->
di¡ªû
 = distance;

1459 
i
=0; i<
·th
->
fwdc
; i++)

1461 
	`as£¹
(
·th
 !ğ·th->
fwd
[
i
]);

1462 
	`Œaûlb_·th_di¡ªû_1
(
·th
->
fwd
[
i
], 
di¡ªû
+1);

1466 
	}
}

1468 
	$Œaûlb_·th_cmp
(cÚ¡ 
Œaûlb_·th_t
 *
a
, cÚ¡¿ûlb_·th_ˆ*
b
)

1470 if(
a
->
di¡ªû
 < 
b
->distance)

1472 if(
a
->
di¡ªû
 > 
b
->distance)

1475 
	}
}

1477 
	$Œaûlb_·ths_sÜt
(
Œaûlb_¡©e_t
 *
¡©e
)

1479 
	`¬¿y_qsÜt
((**)
¡©e
->
·ths
, s‹->
·thc
,

1480 (
¬¿y_cmp_t
)
Œaûlb_·th_cmp
);

1482 
	}
}

1492 
	$Œaûlb_·th_di¡ªû
(
Œaûlb_¡©e_t
 *
¡©e
,

1493 
Œaûlb_·th_t
 *
·th
, 
di¡ªû
)

1495 
	`Œaûlb_£t_vis™ed0
(
¡©e
);

1496 
	`Œaûlb_·th_di¡ªû_1
(
·th
, 
di¡ªû
);

1497 
	`h—p_»make
(
¡©e
->
wa™šg
);

1498 
	`Œaûlb_·ths_sÜt
(
¡©e
);

1500 
	}
}

1508 
	$Œaûlb_·ths_¥liû
(
Œaûlb_¡©e_t
 *
¡©e
, 
Œaûlb_·th_t
 *
·th0
,

1509 
Œaûlb_·th_t
 *
·th
, 
lškc
)

1511 
Œaûlb_·th_t
 *
Ãwp
;

1512 
i
, 
j
, 
d
;

1518 if((
Ãwp
 = 
	`Œaûlb_·th_®loc
(
¡©e
, 
lškc
)è=ğ
NULL
)

1524 
Ãwp
->
back
 = 
·th
->back;

1525 
Ãwp
->
backc
 = 
·th
->backc;

1526 
·th
->
back
 = 
NULL
;

1527 
·th
->
backc
 = 0;

1528 
i
=0; i<
Ãwp
->
backc
; i++)

1530 
j
=0; j<
Ãwp
->
back
[
i
]->
fwdc
; j++)

1532 if(
Ãwp
->
back
[
i
]->
fwd
[
j
] =ğ
·th
)

1533 
Ãwp
->
back
[
i
]->
fwd
[
j
] =‚ewp;

1538 
Ãwp
->
lškc
=0;‚ewp->linkc <†inkc;‚ewp->linkc++)

1540 
Ãwp
->
lšks
[Ãwp->
lškc
] = 
·th
->links[newp->linkc];

1541 
Ãwp
->
lšks
[Ãwp->
lškc
]->
·th
 =‚ewp;

1545 if(
·th
->
lškc
 -†inkc > 0)

1547 
i
=0; i<
·th
->
lškc
-linkc; i++)

1549 
·th
->
lšks
[
i
] =…©h->lšks[
lškc
+i];

1551 
·th
->
lškc
 =…ath->linkc -†inkc;

1555 
	`as£¹
(
·th
->
lškc
 -†inkc == 0);

1556 
	`ä“
(
·th
->
lšks
);

1557 
·th
->
lšks
 = 
NULL
;

1558 
·th
->
lškc
 = 0;

1562 if(
	`Œaûlb_·th_add_back
(
·th
, 
Ãwp
) != 0 ||

1563 
	`Œaûlb_·th_add_back
(
·th
, 
·th0
) != 0)

1569 
Ãwp
->
di¡ªû
 = 
·th
->distance;

1570 if(
·th0
->
di¡ªû
 > 
·th
->distance)

1571 
d
 = 
·th0
->
di¡ªû
 + 1;

1573 
d
 = 
·th
->
di¡ªû
 + 1;

1574 
	`Œaûlb_·th_di¡ªû
(
¡©e
, 
·th
, 
d
);

1577 
	}
}

1584 
	$Œaûlb_·ths_¥liû_bynode
(
Œaûlb_¡©e_t
 *
¡©e
,

1585 
Œaûlb_·th_t
 *
·th0
)

1587 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

1588 
Œaûlb_·th_t
 *
·th
;

1589 
Œaûlb_lšk_t
 *
bl
;

1590 
i
, 
j
;

1592 
	`Œaûlb_·ths_as£¹
(
¡©e
);

1600 
bl
 = 
·th0
->
lšks
[·th0->
lškc
-1];

1601 
lšk
 = 
bl
->link;

1602 
i
=0; i<
¡©e
->
lškc
; i++)

1604 if(
¡©e
->
lšks
[
i
] !ğ
bl
 &&

1605 
¡©e
->
lšks
[
i
]->
lšk
->
to
 !ğ
NULL
 &&

1606 
	`sÿm³r_Œaûlb_node_cmp
(
¡©e
->
lšks
[
i
]->
lšk
->
to
,†ink->to) == 0)

1611 
	`as£¹
(
i
 !ğ
¡©e
->
lškc
);

1614 
bl
 = 
¡©e
->
lšks
[
i
];

1615 
·th
 = 
bl
->path;

1616 
i
=0; i<
·th
->
lškc
; i++)

1618 if(
·th
->
lšks
[
i
] =ğ
bl
)

1621 
	`as£¹
(
i
 !ğ
·th
->
lškc
);

1623 if(
i
+1 =ğ
·th
->
lškc
 &&…©h->
fwdc
 != 0)

1625 
j
=0; j<
·th
->
fwdc
; j++)

1627 
	`Œaûlb_·th_add_back
(
·th
->
fwd
[
j
], 
·th0
);

1628 
	`Œaûlb_·th_di¡ªû
(
¡©e
, 
·th
->
fwd
[
j
], 
·th0
->
di¡ªû
 + 1);

1633 
	`Œaûlb_·ths_¥liû
(
¡©e
, 
·th0
, 
·th
, 
i
+1);

1636 
	`Œaûlb_·ths_as£¹
(
¡©e
);

1638 
	}
}

1646 
	$Œaûlb_queue
(
sÿm³r_sk_t
 *
sk
)

1648 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

1649 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

1650 
Œaûlb_b¿nch_t
 *
b¿nch
;

1651 
timev®
 
now
, 
Ãxt_tx
;

1653 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

1657 if(
	`h—p_couÁ
(
¡©e
->
aùive
è=ğ0 && h—p_couÁ(¡©e->
wa™šg
) == 0)

1659 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1663 if((
b¿nch
 = 
	`h—p_h—d_™em
(
¡©e
->
aùive
)è!ğ
NULL
)

1665 
	`timev®_ıy
(&
Ãxt_tx
, &
b¿nch
->next_tx);

1669 
	`timev®_ıy
(&
Ãxt_tx
, &
¡©e
->next_tx);

1673 
	`g‘timeofday_w¿p
(&
now
);

1676 if(
	`timev®_cmp
(&
Ãxt_tx
, &
now
) <= 0)

1679 if(
Œaû
->
´obec
 >ğŒaû->
´obec_max
)

1681 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

1685 
	`sÿm³r_sk_queue_´obe
(
sk
);

1689 
	`sÿm³r_sk_queue_wa™_tv
(
sk
, &
Ãxt_tx
);

1691 
	}
}

1693 
	$Œaûlb_´oûss_hİs
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

1695 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

1696 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

1697 
Œaûlb_·th_t
 *
·th0
 = 
br
->
·th
;

1698 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
;

1699 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

1700 
sÿm³r_Œaûlb_node_t
 *
äom
, *
to
;

1701 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

1702 
Œaûlb_lšk_t
 *
bl
;

1703 
Œaûlb_·th_t
 *
Ãwp
;

1704 
Œaûlb_´obe_t
 *
´
;

1705 
ušt16_t
 
æowid
;

1706 
¦i¡_t
 *
æowids
 = 
NULL
;

1707 
i
, 
j
, 
k
, 
¥liû
, 
»cÜd
, 
timxûed
;

1709 
	`as£¹
(
br
->
´obec
 > 0);

1715 if(
br
->
mode
 =ğ
MODE_FIRSTHOP
)

1716 
äom
 = 
Œaû
->
nodes
[0];

1717 if(
br
->
mode
 =ğ
MODE_CLUMP
)

1718 
äom
 = 
NULL
;

1719 if(
·th0
->
lškc
 > 0)

1720 
äom
 = 
·th0
->
lšks
[·th0->
lškc
-1]->
lšk
->
to
;

1722 
äom
 = 
·th0
->
back
[0]->
lšks
[·th0->back[0]->
lškc
-1]->
lšk
->
to
;

1724 
i
=0; i<
br
->
Ãwnodec
; i++)

1727 
to
 = 
	`sÿm³r_Œaûlb_node_fšd
(
Œaû
, 
br
->
Ãwnodes
[
i
]->
node
);

1728 if(
to
 =ğ
NULL
)

1730 
to
 = 
br
->
Ãwnodes
[
i
]->
node
;

1731 if(
	`sÿm³r_Œaûlb_node_add
(
Œaû
, 
to
) != 0)

1732 
”r
;

1733 
¥liû
 = 0;

1737 
	`sÿm³r_Œaûlb_node_ä“
(
br
->
Ãwnodes
[
i
]->
node
);

1738 
¥liû
 = 1;

1740 
	`ä“
(
br
->
Ãwnodes
[
i
]);

1741 
br
->
Ãwnodes
[
i
] = 
NULL
;

1744 if(
br
->
mode
 !ğ
MODE_CLUMP
)

1746 
	`as£¹
(
äom
 !ğ
NULL
);

1747 if((
lšk
 = 
	`sÿm³r_Œaûlb_lšk_®loc
()è=ğ
NULL
)

1749 
”r
;

1751 
lšk
->
äom
 = from;

1752 
lšk
->
to
 =o;

1756 
lšk
 = 
·th0
->
lšks
[·th0->
lškc
-1]->link;

1757 
	`as£¹
(
lšk
->
to
 =ğ
NULL
);

1758 
lšk
->
to
 =o;

1765 if((
£t
 = 
	`sÿm³r_Œaûlb_´obe£t_®loc
()è=ğ
NULL
 ||

1766 (
æowids
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

1768 if(
br
->
mode
 !ğ
MODE_CLUMP
)

1769 
	`sÿm³r_Œaûlb_lšk_ä“
(
lšk
);

1770 
”r
;

1779 
æowid
 = 
br
->
´obes
[0]->
´obe
->flowid;

1780 
k
 = 0; 
»cÜd
 = 0; 
timxûed
 = 1;

1781 
j
=0; j<=
br
->
´obec
; j++)

1790 if(
j
 =ğ
br
->
´obec
 || br->
´obes
[j]->
´obe
->
æowid
 != flowid)

1796 if(
»cÜd
 != 0)

1802 if(
timxûed
 !ğ0 && 
br
->
´obes
[
k
]->
mode
 !ğ
MODE_PERPACKET
)

1804 
´
 = 
br
->
´obes
[
k
];

1805 if(
	`Œaûlb_æowids_li¡_add
(
æowids
, 
´
) != 0)

1806 
”r
;

1813 
k
<
j
)

1815 
´
 = 
br
->
´obes
[
k
];

1816 if(
	`sÿm³r_Œaûlb_´obe£t_add
(
£t
, 
´
->
´obe
) != 0)

1817 
”r
;

1818 
k
++;

1822 if(
j
 =ğ
br
->
´obec
)

1826 
timxûed
 = 1;

1827 
»cÜd
 = 0;

1828 
æowid
 = 
br
->
´obes
[
j
]->
´obe
->flowid;

1829 
k
 = 
j
;

1832 
´
 = 
br
->
´obes
[
j
];

1833 
´obe
 = 
´
->probe;

1836 if(
´
->
mode
 =ğ
MODE_BRINGFWD
 ||…r->mod=ğ
MODE_BRINGFWD0
)

1838 
k
++;

1843 if(
´obe
->
rxc
 == 0)

1850 
	`as£¹
(
´obe
->
rxc
 =ğ1 || 
´
->
mode
 =ğ
MODE_PERPACKET
);

1856 if(
	`Œaûlb_cmp_node2»¶y
(
to
, 
´obe
->
rxs
[0]) == 0)

1858 
»cÜd
 = 1;

1859 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
´obe
->
rxs
[0]) == 0)

1860 
timxûed
 = 0;

1865 if(
	`sÿm³r_Œaûlb_lšk_´obe£t
(
lšk
, 
£t
) != 0)

1867 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…robeset");

1868 
”r
;

1872 if(
lšk
->
hİc
 =ğ1 && 
	`sÿm³r_Œaûlb_lšk_add
(
Œaû
,†ink) != 0)

1874 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚ew†ink");

1875 
”r
;

1878 if(
br
->
mode
 =ğ
MODE_FIRSTHOP
)

1880 
	`as£¹
(
¥liû
 =ğ0 || 
lšk
->
äom
 =ğlšk->
to
);

1881 if((
Ãwp
 = 
	`Œaûlb_·th_®loc
(
¡©e
, 0)è=ğ
NULL
 ||

1882 (
bl
 = 
	`Œaûlb_lšk_®loc
(
¡©e
, 
lšk
, 
Ãwp
)è=ğ
NULL
 ||

1883 
	`Œaûlb_·th_add_lšk
(
Ãwp
, 
bl
) != 0)

1885 
”r
;

1888 if(
br
->
mode
 =ğ
MODE_CLUMP
)

1890 
bl
 = 
·th0
->
lšks
[·th0->
lškc
-1];

1891 
	`Œaûlb_lšk_æowids_šc
(
bl
);

1892 
Ãwp
 = 
·th0
;

1894 if(
br
->
Ãwnodec
 == 1)

1901 if((
bl
 = 
	`Œaûlb_lšk_®loc
(
¡©e
, 
lšk
, 
·th0
)è=ğ
NULL
 ||

1902 
	`Œaûlb_·th_add_lšk
(
·th0
, 
bl
) != 0)

1904 
”r
;

1906 
Ãwp
 = 
·th0
;

1910 if((
Ãwp
 = 
	`Œaûlb_·th_®loc
(
¡©e
, 0)è=ğ
NULL
 ||

1911 (
bl
 = 
	`Œaûlb_lšk_®loc
(
¡©e
, 
lšk
, 
Ãwp
)è=ğ
NULL
 ||

1912 
	`Œaûlb_·th_add_lšk
(
Ãwp
, 
bl
) != 0 ||

1913 
	`Œaûlb_·th_add_back
(
Ãwp
, 
·th0
) != 0)

1915 
”r
;

1919 
Ãwp
->
di¡ªû
 = 
·th0
->distance + 1;

1920 
	`Œaûlb_·ths_sÜt
(
¡©e
);

1923 
	`Œaûlb_lšk_æowids_add_li¡
(
bl
, 
æowids
);

1924 
æowids
 = 
NULL
;

1926 if(
	`Œaûlb_lšk_cÚtšue
(
Œaû
, 
Ãwp
, 
lšk
) == 0)

1929 if(
¥liû
 == 0)

1931 if(
	`Œaûlb_·th_add
(
¡©e
, 
Ãwp
) != 0)

1933 
”r
;

1938 if(
	`Œaûlb_·ths_¥liû_bynode
(
¡©e
, 
Ãwp
) != 0)

1940 
”r
;

1945 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

1946 
	`Œaûlb_·ths_as£¹
(
¡©e
);

1949 
”r
:

1951 
	}
}

1953 
	$Œaûlb_´oûss_şump
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

1955 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

1956 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

1957 
Œaûlb_·th_t
 *
·th0
 = 
br
->
·th
;

1958 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

1959 
sÿm³r_Œaûlb_node_t
 *
node
;

1960 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

1961 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
 = 
NULL
;

1962 
Œaûlb_´obe_t
 *
´
;

1963 
Œaûlb_lšk_t
 *
bl
 = 
NULL
;

1964 
¦i¡_t
 *
æowids
 = 
NULL
;

1965 
ušt16_t
 
æowid
;

1966 
i
, 
j
, 
k
, 
h®t
 = 0;

1968 
	`Œaûlb_·ths_dump
(
¡©e
);

1970 if(
·th0
 =ğ
NULL
)

1972 
	`as£¹
(
Œaû
->
nodec
 == 1);

1973 
i
=0; i<
br
->
Ãwnodec
; i++)

1975 
node
 = 
br
->
Ãwnodes
[
i
]->node;

1976 if(
	`sÿm³r_Œaûlb_node_cmp
(
Œaû
->
nodes
[0], 
node
) == 0)

1978 
	`sÿm³r_debug
(
__func__
, "nod%d†oİ", 
i
);

1979 
h®t
 = 1;

1981 
	`sÿm³r_Œaûlb_node_ä“
(
br
->
Ãwnodes
[
i
]->
node
);

1982 
	`ä“
(
br
->
Ãwnodes
[
i
]); br->Ãwnodes[i] = 
NULL
;

1984 
	`ä“
(
br
->
Ãwnodes
);

1985 
br
->
Ãwnodes
 = 
NULL
;

1986 
br
->
Ãwnodec
 = 0;

1988 if((
·th0
 = 
	`Œaûlb_·th_®loc
(
¡©e
, 0)è=ğ
NULL
)

1989 
”r
;

1990 
br
->
·th
 = 
·th0
;

1992 if(
br
->
Ãwnodec
 > 0)

1998 
i
=0; i<
br
->
Ãwnodec
; i++)

2000 
node
 = 
br
->
Ãwnodes
[
i
]->node;

2001 if(
h®t
 =ğ0 && 
	`Œaûlb_i¦oİ_addr
(
·th0
, 
node
->
addr
è!ğ
NULL
)

2003 
	`sÿm³r_debug
(
__func__
, "nod%d†oİ", 
i
);

2004 
h®t
 = 1;

2006 
	`sÿm³r_Œaûlb_node_ä“
(
br
->
Ãwnodes
[
i
]->
node
);

2007 
	`ä“
(
br
->
Ãwnodes
[
i
]); br->Ãwnodes[i] = 
NULL
;

2009 
	`ä“
(
br
->
Ãwnodes
);

2010 
br
->
Ãwnodes
 = 
NULL
;

2011 
br
->
Ãwnodec
 = 0;

2013 if(
·th0
->
lškc
 > 0)

2015 
lšk
 = 
·th0
->
lšks
[·th0->
lškc
-1]->link;

2016 if(
Œaû
->
g­lim™
 < 2)

2018 
h®t
 = 1;

2020 if(
lšk
->
to
 =ğ
NULL
 &&†šk->
hİc
+1 >ğ
Œaû
->
g­lim™
)

2022 
k
 = 1;

2023 
i
=
lšk
->
hİc
-1; i>=0; i--)

2025 if(
k
 =ğ
Œaû
->
g­lim™
)

2028 
£t
 = 
lšk
->
£ts
[
i
];

2029 
j
=0; j<
£t
->
´obec
; j++)

2030 if(
£t
->
´obes
[
j
]->
rxc
 > 0)

2033 if(
j
 =ğ
£t
->
´obec
)

2034 
k
++;

2036 if(
k
 =ğ
Œaû
->
g­lim™
)

2037 
h®t
 = 1;

2042 if((
æowids
 = 
	`¦i¡_®loc
()è=ğ
NULL
)

2044 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc†ist");

2045 
”r
;

2049 if((
£t
 = 
	`sÿm³r_Œaûlb_´obe£t_®loc
()è=ğ
NULL
)

2051 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…robeset");

2052 
”r
;

2055 
æowid
 = 
br
->
´obes
[0]->
´obe
->æowid; 
k
 = 0;

2056 
i
=0; i<=
br
->
´obec
; i++)

2063 if(
i
 =ğ
br
->
´obec
 || 
æowid
 !ğbr->
´obes
[i]->
´obe
->flowid)

2065 if(
h®t
 =ğ0 && 
k
<
i
)

2067 
´
 = 
br
->
´obes
[
k
];

2068 if(
´
->
mode
 !ğ
MODE_PERPACKET
 &&

2069 
	`Œaûlb_æowids_li¡_add
(
æowids
, 
´
) != 0)

2070 
”r
;

2072 if(
i
 =ğ
br
->
´obec
)

2075 
æowid
 = 
br
->
´obes
[
i
]->
´obe
->flowid;

2076 
k
 = 
i
;

2079 
´
 = 
br
->
´obes
[
i
];

2080 if(
´
->
mode
 =ğ
MODE_BRINGFWD
 ||…r->mod=ğ
MODE_BRINGFWD0
)

2082 
k
++;

2086 
´obe
 = 
´
->probe;

2087 if(
	`sÿm³r_Œaûlb_´obe£t_add
(
£t
, 
´obe
) != 0)

2089 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚Ù‡dd…rob%d", 
i
);

2090 
”r
;

2097 if(
h®t
 != 0)

2099 
j
=0; j<
´obe
->
rxc
; j++)

2101 if(
	`SCAMPER_TRACELB_REPLY_IS_ICMP_TTL_EXP
(
´obe
->
rxs
[
j
]) == 0)

2102 
h®t
 = 1;

2110 if(
·th0
->
lškc
 =ğ0 ||…©h0->
lšks
[·th0->lškc-1]->
lšk
->
to
 !ğ
NULL
)

2112 if((
lšk
 = 
	`sÿm³r_Œaûlb_lšk_®loc
()è=ğ
NULL
)

2114 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc†ink");

2115 
”r
;

2118 if(
·th0
->
lškc
 > 0)

2119 
lšk
->
äom
 = 
·th0
->
lšks
[·th0->
lškc
-1]->lšk->
to
;

2120 if(
·th0
->
backc
 > 0)

2121 
lšk
->
äom
 = 
·th0
->
back
[0]->
lšks
[·th0->back[0]->
lškc
-1]->lšk->
to
;

2123 
lšk
->
äom
 = 
Œaû
->
nodes
[0];

2127 
bl
 = 
·th0
->
lšks
[·th0->
lškc
-1];

2128 
lšk
 = 
bl
->link;

2129 
	`Œaûlb_lšk_æowids_šc
(
bl
);

2133 if(
	`sÿm³r_Œaûlb_lšk_´obe£t
(
lšk
, 
£t
) != 0)

2135 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd…robeset");

2136 
”r
;

2140 if(
lšk
->
hİc
 == 1)

2142 if(
	`sÿm³r_Œaûlb_lšk_add
(
Œaû
, 
lšk
) != 0)

2144 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚ew†ink");

2145 
”r
;

2148 if((
bl
 = 
	`Œaûlb_lšk_®loc
(
¡©e
, 
lšk
, 
·th0
)è=ğ
NULL
 ||

2149 
	`Œaûlb_·th_add_lšk
(
·th0
, 
bl
) != 0)

2151 
”r
;

2155 if(
h®t
 == 0)

2157 
	`Œaûlb_lšk_æowids_add_li¡
(
bl
, 
æowids
);

2160 
br
->
mode
 = 
MODE_CLUMP
;

2161 
	`Œaûlb_b¿nch_»£t
(
br
);

2162 
	`timev®_add_cs
(&
br
->
Ãxt_tx
, &br->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2163 if(
	`Œaûlb_b¿nch_wa™šg
(
¡©e
, 
br
) != 0)

2164 
”r
;

2168 
	`Œaûlb_æowids_li¡_ä“
(
æowids
);

2169 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

2174 
”r
:

2176 
	}
}

2178 
	$Œaûlb_´oûss_³½ack‘
(
sÿm³r_sk_t
 *
sk
,
Œaûlb_b¿nch_t
 *
br
)

2180 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2181 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2183 
br
->
mode
 = 
MODE_PERPACKET
;

2184 
	`Œaûlb_b¿nch_»£t
(
br
);

2185 
	`timev®_add_cs
(&
br
->
Ãxt_tx
, &br->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2186 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
br
) != 0)

2190 
	}
}

2192 
	$Œaûlb_´oûss_´obes
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

2194 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2195 
Œaûlb_´obe_t
 *
´
;

2196 
sÿm³r_addr_t
 *
addr
 = 
NULL
;

2197 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

2198 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2199 
ušt16_t
 
æowid
;

2200 
ušt8_t
 
mode
;

2201 
i
, 
n
 = 0, 
c
 = 0, 
x
 = 0, 
hİ´obe
 = 0;

2203 #iâdeà
NDEBUG


2204 *
ms
;

2205 
i
=0; i<
br
->
´obec
; i++)

2207 
´
 = 
br
->
´obes
[
i
]; 
´obe
 =…r->probe;

2208 if(
´
->
mode
 =ğ
MODE_FIRSTADDR
è
ms
 = "firstaddr";

2209 if(
´
->
mode
 =ğ
MODE_FIRSTHOP
è
ms
 = "firsthop";

2210 if(
´
->
mode
 =ğ
MODE_HOPPROBE
è
ms
 = "hopprobe";

2211 if(
´
->
mode
 =ğ
MODE_BRINGFWD
è
ms
 = "bringfwd";

2212 if(
´
->
mode
 =ğ
MODE_BRINGFWD0
è
ms
 = "bringfwd0";

2213 if(
´
->
mode
 =ğ
MODE_CLUMP
è
ms
 = "clump";

2214 if(
´
->
mode
 =ğ
MODE_PERPACKET
è
ms
 = "perpacket";

2215 
ms
 = "???";

2216 
	`sÿm³r_debug
(
__func__
, "flow %dtl %d„x %d %s",

2217 
´obe
->
æowid
,…robe->
‰l
,…robe->
rxc
, 
ms
);

2222 if(
br
->
h—²ode
 !ğ
NULL
)

2223 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
br
->
h—²ode
);

2225 
	`as£¹
(
br
->
mode
 =ğ
MODE_FIRSTHOP
 || br->mod=ğ
MODE_HOPPROBE
 ||

2226 
br
->
mode
 =ğ
MODE_PERPACKET
 || br->mod=ğ
MODE_CLUMP
);

2239 
æowid
 = 
br
->
´obes
[0]->
´obe
->flowid;

2240 
i
=0; i<=
br
->
´obec
; i++)

2242 if(
i
 =ğ
br
->
´obec
)

2244 if(
x
 =ğ0 && 
hİ´obe
 != 0)

2245 
n
++;

2249 
´
 = 
br
->
´obes
[
i
];

2250 
´obe
 = 
´
->probe;

2252 if(
´obe
->
æowid
 != flowid)

2258 if(
x
 =ğ0 && 
hİ´obe
 != 0)

2259 
n
++;

2261 
æowid
 = 
´obe
->flowid;

2262 
x
 = 0; 
hİ´obe
 = 0; 
addr
 = 
NULL
;

2269 if(
´
->
mode
 =ğ
MODE_HOPPROBE
 ||…r->mod=ğ
MODE_FIRSTHOP
 ||

2270 
´
->
mode
 =ğ
MODE_CLUMP
)

2272 
hİ´obe
 = 1;

2275 if(
´obe
->
rxc
 > 0)

2276 
x
++;

2279 if(
´obe
->
rxc
 > 1)

2280 
c
++;

2286 if(
´obe
->
rxc
 == 1)

2288 
»¶y
 = 
´obe
->
rxs
[0];

2289 if(
addr
 =ğ
NULL
)

2290 
addr
 = 
»¶y
->
»¶y_äom
;

2291 if(
	`sÿm³r_addr_cmp
(
addr
, 
»¶y
->
»¶y_äom
) != 0)

2292 
c
++;

2297 if(
br
->
mode
 =ğ
MODE_PERPACKET
)

2299 if(
br
->
k
 <ğ
	`k
(
¡©e
, 2è|| 
c
 > 0 || 
n
 > 0)

2300 
mode
 = 
MODE_CLUMP
;

2302 
mode
 = 
MODE_HOPPROBE
;

2306 if(
c
 > 0 || 
n
 > 0)

2308 
mode
 = 
MODE_CLUMP
;

2310 if(
br
->
Ãwnodec
 > 1)

2312 if(
br
->
mode
 =ğ
MODE_HOPPROBE
)

2313 
mode
 = 
MODE_PERPACKET
;

2315 
mode
 = 
MODE_CLUMP
;

2319 
mode
 = 
MODE_HOPPROBE
;

2323 if(
mode
 =ğ
MODE_HOPPROBE
)

2324 
	`Œaûlb_´oûss_hİs
(
sk
, 
br
);

2325 if(
mode
 =ğ
MODE_CLUMP
)

2326 
	`Œaûlb_´oûss_şump
(
sk
, 
br
);

2328 
	`Œaûlb_´oûss_³½ack‘
(
sk
, 
br
);

2330 
	`Œaûlb_·ths_dump
(
¡©e
);

2331 
	`Œaûlb_queue
(
sk
);

2333 
	}
}

2341 
	$Œaûlb_·th_æowid
(
Œaûlb_·th_t
 *
·th
,

2342 
sÿm³r_Œaûlb_´obe_t
 *
´obe
)

2344 
Œaûlb_æowid_t
 *
æowid
;

2345 
i
;

2348 
i
=
·th
->
lškc
-1; i>=0; i--)

2350 if((
æowid
 = 
	`Œaûlb_lšk_æowid_g‘
(
·th
->
lšks
[
i
])è=ğ
NULL
)

2353 
´obe
->
æowid
 = flowid->
id
;

2354 
´obe
->
‰l
 = 
æowid
->ttl + 1;

2355 
	`ä“
(
æowid
);

2357 
i
=i+1; i<
·th
->
lškc
; i++)

2358 
´obe
->
‰l
 +ğ
·th
->
lšks
[
i
]->
lšk
->
hİc
;

2369 
i
=0; i<
·th
->
backc
; i++)

2371 if(
·th
->
back
[
i
]->
fwdc
 == 1 &&

2372 
	`Œaûlb_·th_æowid
(
·th
->
back
[
i
], 
´obe
) != 0)

2374 
i
=0; i<
·th
->
lškc
; i++)

2375 
´obe
->
‰l
 +ğ
·th
->
lšks
[
i
]->
lšk
->
hİc
;

2382 
	}
}

2391 
	$Œaûlb_´obe_v®s
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
b¿nch
,

2392 
Œaûlb_´obe_t
 *
´
)

2394 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2395 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2396 
Œaûlb_·th_t
 *
·th0
, *
·th
;

2397 
size_t
 
Ën
;

2398 
i
;

2400 #iâdeà
NDEBUG


2401 
sÿm³r_Œaûlb_node_t
 *
node
;

2402 
äom
[64], 
to
[64];

2405 
	`Œaûlb_·ths_as£¹
(
¡©e
);

2408 
·th0
 = 
b¿nch
->
·th
;

2411 
´
->
mode
 = 
b¿nch
->mode;

2412 
´
->
´obe
->
©‹m±
 = 0;

2420 if(
	`Œaûlb_·th_æowid
(
·th0
, 
´
->
´obe
) != 0)

2423 
i
=0; i<
b¿nch
->
bršgfwdc
; i++)

2424 
b¿nch
->
bršgfwd
[
i
]->
k
 = 0;

2426 if(
·th0
->
lškc
 > 0)

2427 
´
->
lšk
 = 
·th0
->
lšks
[·th0->
lškc
-1];

2428 if(
·th0
->
backc
 > 0)

2429 
´
->
lšk
 = 
·th0
->
back
[0]->
lšks
[·th0->back[0]->
lškc
-1];

2435 
	`as£¹
(
Œaû
->
nodec
 > 0);

2436 
	`as£¹
(
Œaû
->
nodes
[0] !ğ
NULL
);

2437 
	`as£¹
(
Œaû
->
nodes
[0]->
lškc
 > 0);

2443 if(
·th0
->
back
 =ğ
NULL
 && 
Œaû
->
nodes
[0]->
lškc
 == 1)

2445 
´
->
´obe
->
‰l
 = 
Œaû
->
fœ¡hİ
 + 1;

2446 
i
=0; i<
·th0
->
lškc
; i++)

2447 
´
->
´obe
->
‰l
 +ğ
·th0
->
lšks
[
i
]->
lšk
->
hİc
;

2449 
´
->
´obe
->
æowid
 = 
¡©e
->
æowid_Ãxt
++;

2450 
´
->
lšk
 = 
·th0
->
lšks
[·th0->
lškc
-1];

2455 if(
b¿nch
->
bršgfwd
 =ğ
NULL
 || b¿nch->bršgfwd[0]->
·th
 !ğ
·th0
)

2458 
	`Œaûlb_bršgfwd_ä“
(
b¿nch
);

2461 
Ën
 = (
Œaûlb_bršgfwd_t
 *è* 
¡©e
->
·thc
;

2462 if((
b¿nch
->
bršgfwd
 = 
	`m®loc_z”o
(
Ën
)è=ğ
NULL
)

2464 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc set");

2475 
	`Œaûlb_£t_vis™ed0
(
¡©e
);

2476 if(
	`Œaûlb_bršgfwd_dá
(
b¿nch
, 
·th0
) == -1)

2478 
	`¬¿y_qsÜt
((**)
b¿nch
->
bršgfwd
, b¿nch->
bršgfwdc
,

2479 (
¬¿y_cmp_t
)
Œaûlb_bršgfwd_cmp
);

2481 #iâdeà
NDEBUG


2482 
i
=
b¿nch
->
bršgfwdc
-1; i>=0; i--)

2484 
·th
 = 
b¿nch
->
bršgfwd
[
i
]->path;

2486 if(
·th
->
lškc
 == 0)

2489 
node
 = 
·th
->
lšks
[0]->
lšk
->
äom
;

2490 if(
node
->
addr
 !ğ
NULL
)

2491 
	`sÿm³r_addr_to¡r
(
node
->
addr
, 
äom
, (from));

2493 
	`¢´štf
(
äom
, (from), "*");

2494 if((
node
 = 
·th
->
lšks
[·th->
lškc
-1]->
lšk
->
to
è!ğ
NULL
)

2495 
	`sÿm³r_addr_to¡r
(
node
->
addr
, 
to
, (to));

2497 
	`¢´štf
(
to
, (to), "*");

2499 
	`sÿm³r_debug
(
__func__
, "%d % %s", 
·th
->
di¡ªû
, 
äom
, 
to
);

2508 
	`as£¹
(
b¿nch
->
bršgfwd
[0]->
·th
 =ğ
·th0
);

2509 
	`as£¹
(
b¿nch
->
bršgfwd
[b¿nch->
bršgfwdc
-1]->
·th
->
backc
 == 0);

2512 
i
=0; i<
b¿nch
->
bršgfwdc
; i++)

2513 
b¿nch
->
bršgfwd
[
i
]->
·th
->
vis™ed
 = 0;

2516 
´
->
mode
 = 
MODE_BRINGFWD
;

2522 
i
=1; i<
b¿nch
->
bršgfwdc
; i++)

2524 
·th
 = 
b¿nch
->
bršgfwd
[
i
]->path;

2525 if(
·th
->
vis™ed
 != 0)

2530 if(
	`Œaûlb_·th_æowid
(
·th
, 
´
->
´obe
) != 0)

2532 if(
·th
->
lškc
 != 0)

2533 
´
->
lšk
 = 
·th
->
lšks
[·th->
lškc
-1];

2535 
´
->
lšk
 = 
·th
->
back
[0]->
lšks
[·th->back[0]->
lškc
-1];

2536 
dÚe
;

2544 
´
->
´obe
->
æowid
 = 
¡©e
->
æowid_Ãxt
++;

2545 
´
->
´obe
->
‰l
 = 
Œaû
->
fœ¡hİ
 + 1;

2547 if(
Œaû
->
nodes
[0]->
lškc
 == 1)

2549 
·th
 = 
b¿nch
->
bršgfwd
[b¿nch->
bršgfwdc
-1]->path;

2550 
´
->
lšk
 = 
·th
->
lšks
[·th->
lškc
-1];

2552 
i
=0; i<
·th
->
lškc
; i++)

2553 
´
->
´obe
->
‰l
 +ğ
·th
->
lšks
[
i
]->
lšk
->
hİc
;

2557 
´
->
mode
 = 
MODE_BRINGFWD0
;

2558 
´
->
lšk
 = 
NULL
;

2561 
dÚe
:

2562 
	`sÿm³r_debug
(
__func__
, "bringfwd:tl %d flowid %d",

2563 
´
->
´obe
->
‰l
,…r->´obe->
æowid
);

2565 
	}
}

2567 
	$Œaûlb_b¿nch_ÿnûl
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

2569 
	`sÿm³r_debug
(
__func__
, "ÿnûÎšg…©h %p", 
br
->
·th
);

2570 
	`Œaûlb_´oûss_´obes
(
sk
, 
br
);

2572 
	}
}

2579 
sÿm³r_Œaûlb_»¶y_t
 *
	$hªdËicmp_»¶y
(cÚ¡ 
sÿm³r_icmp_»¥_t
 *
œ
,

2580 
sÿm³r_addr_t
 *
äom
)

2582 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2584 if((
»¶y
 = 
	`sÿm³r_Œaûlb_»¶y_®loc
(
äom
)è=ğ
NULL
)

2586 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocate„eply");

2587  
NULL
;

2590 
	`timev®_ıy
(&
»¶y
->
»¶y_rx
, &
œ
->
œ_rx
);

2591 
»¶y
->
»¶y_id
 = 
œ
->
œ__id
;

2592 
»¶y
->
»¶y_icmp_ty³
 = 
œ
->
œ_icmp_ty³
;

2593 
»¶y
->
»¶y_icmp_code
 = 
œ
->
œ_icmp_code
;

2594 
»¶y
->
»¶y_icmp_q_‰l
 = 
œ
->
œ_šÃr__‰l
;

2595 
»¶y
->
»¶y_icmp_q_tos
 = 
œ
->
œ_šÃr__tos
;

2597 if(
œ
->
œ__‰l
 >= 0)

2599 
»¶y
->
»¶y_‰l
 = (
ušt8_t
)
œ
->
œ__‰l
;

2600 
»¶y
->
»¶y_æags
 |ğ
SCAMPER_TRACELB_REPLY_FLAG_REPLY_TTL
;

2603 if(
œ
->
œ_ext
 !ğ
NULL
 &&

2604 
	`sÿm³r_icm³xt_·r£
(&
»¶y
->
»¶y_icmp_ext
,

2605 
œ
->
œ_ext
, ir->
œ_ex’
) != 0)

2607 
	`sÿm³r_debug
(
__func__
, "could‚ot include icmpƒxtension data");

2608 
	`sÿm³r_Œaûlb_»¶y_ä“
(
»¶y
);

2609  
NULL
;

2612  
»¶y
;

2613 
	}
}

2615 
sÿm³r_Œaûlb_»¶y_t
 *
	$hªdËtı_»¶y
(cÚ¡ 
sÿm³r_dl_»c_t
 *
dl
,

2616 
sÿm³r_addr_t
 *
äom
)

2618 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2620 if((
»¶y
 = 
	`sÿm³r_Œaûlb_»¶y_®loc
(
äom
)è=ğ
NULL
)

2622 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡llocate„eply");

2623  
NULL
;

2626 
	`timev®_ıy
(&
»¶y
->
»¶y_rx
, &
dl
->
dl_tv
);

2627 
»¶y
->
»¶y_æags
 = 
SCAMPER_TRACELB_REPLY_FLAG_TCP
;

2628 
»¶y
->
»¶y_æags
 |ğ
SCAMPER_TRACELB_REPLY_FLAG_REPLY_TTL
;

2629 
»¶y
->
»¶y_‰l
 = 
dl
->
dl__‰l
;

2630 
»¶y
->
»¶y_tı_æags
 = 
dl
->
dl_tı_æags
;

2631 
»¶y
->
»¶y_id
 = 
dl
->
dl__id
;

2633  
»¶y
;

2634 
	}
}

2641 
	$hªdËicmp_fœ¡addr
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
,

2642 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
äom
)

2644 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2645 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2646 
Œaûlb_b¿nch_t
 *
b¿nch
 = 
´
->branch;

2647 
sÿm³r_Œaûlb_node_t
 *
node
 = 
NULL
;

2649 
	`as£¹
(
´
->
´obe
->
‰l
 =ğ
Œaû
->
fœ¡hİ
);

2650 
	`as£¹
(
Œaû
->
nodes
 =ğ
NULL
);

2652 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
b¿nch
->
h—²ode
);

2655 if((
node
 = 
	`sÿm³r_Œaûlb_node_®loc
(
äom
)è=ğ
NULL
)

2657 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ode");

2658 
”r
;

2660 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
è|| 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(ir))

2662 
node
->
æags
 |ğ
SCAMPER_TRACELB_NODE_FLAG_QTTL
;

2663 
node
->
q_‰l
 = 
œ
->
œ_šÃr__‰l
;

2666 if(
	`sÿm³r_Œaûlb_node_add
(
Œaû
, 
node
) != 0)

2668 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚ode");

2669 
”r
;

2671 
node
 = 
NULL
;

2674 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) == 0 ||

2675 
	`sÿm³r_addr_cmp
(
Œaû
->
d¡
, 
äom
) == 0)

2677 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
b¿nch
);

2678 
	`Œaûlb_queue
(
sk
);

2683 
b¿nch
->
mode
 = 
MODE_FIRSTHOP
;

2684 
	`Œaûlb_b¿nch_»£t
(
b¿nch
);

2685 
	`timev®_add_cs
(&
b¿nch
->
Ãxt_tx
, &b¿nch->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2686 if(
	`Œaûlb_b¿nch_wa™šg
(
¡©e
, 
b¿nch
) != 0)

2687 
”r
;

2689 
	`Œaûlb_queue
(
sk
);

2692 
”r
:

2693 
	`sÿm³r_Œaûlb_node_ä“
(
node
);

2694 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
b¿nch
);

2695 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

2697 
	}
}

2699 
	$hİ´obe_hªdË»¶y
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_´obe_t
 *
´
,

2700 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
)

2702 
Œaûlb_b¿nch_t
 *
b¿nch
 = 
´
->branch;

2703 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2704 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2706 if(
	`sÿm³r_Œaûlb_´obe_»¶y
(
´
->
´obe
, 
»¶y
) != 0)

2708 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd„eplyo…robe");

2709 
	`sÿm³r_Œaûlb_»¶y_ä“
(
»¶y
);

2717 if(
b¿nch
->
´obes
[b¿nch->
´obec
-1] !ğ
´
 ||…r->
´obe
->
rxc
 > 1)

2722 if(
	`Œaûlb_Ãwnode_fšd
(
b¿nch
, 
»¶y
è=ğ
NULL
)

2724 if(
	`Œaûlb_Ãwnode_add
(
b¿nch
, 
´
->
´obe
) != 0)

2727 if(
b¿nch
->
n
 =ğb¿nch->
Ãwnodec
)

2729 
	`sÿm³r_debug
(
__func__
, "b¿nch->À%d", 
b¿nch
->
n
);

2730 
b¿nch
->
n
++;

2734 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
b¿nch
->
h—²ode
);

2735 
b¿nch
->
k
++;

2745 if(
b¿nch
->
n
 >ğ
TRACELB_CONFIDENCE_MAX_N
 ||

2746 (
	`sÿm³r_addr_cmp
(
»¶y
->
»¶y_äom
, 
Œaû
->
d¡
) == 0 &&

2747 
b¿nch
->
Ãwnodec
 < 2) ||

2748 
b¿nch
->
k
 >ğ
	`k
(
¡©e
, b¿nch->
n
))

2750 
	`Œaûlb_´oûss_´obes
(
sk
, 
b¿nch
);

2754 
	`timev®_add_cs
(&
b¿nch
->
Ãxt_tx
, &b¿nch->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2755 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
b¿nch
) != 0)

2758 
	`Œaûlb_queue
(
sk
);

2762 
	}
}

2770 
	$hªdËicmp_hİ´obe
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
,

2771 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
œäom
)

2773 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2775 if(
´
->
b¿nch
 =ğ
NULL
)

2782 if((
»¶y
 = 
	`hªdËicmp_»¶y
(
œ
, 
œäom
)è=ğ
NULL
 ||

2783 
	`hİ´obe_hªdË»¶y
(
sk
, 
´
, 
»¶y
) != 0)

2785 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

2789 
	}
}

2797 
	$hªdËicmp_³½ack‘
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
,

2798 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
äom
)

2800 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2801 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2802 
Œaûlb_b¿nch_t
 *
b¿nch
 = 
´
->branch;

2803 
sÿm³r_Œaûlb_node_t
 *
node
 = 
b¿nch
->
Ãwnodes
[0]->node;

2804 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2805 
´oûss
 = 0;

2807 if(
´
->
b¿nch
 =ğ
NULL
)

2810 
	`as£¹
(
b¿nch
->
Ãwnodec
 > 1);

2812 if((
»¶y
 = 
	`hªdËicmp_»¶y
(
œ
, 
äom
)è=ğ
NULL
)

2814 
”r
;

2816 if(
	`sÿm³r_Œaûlb_´obe_»¶y
(
´
->
´obe
, 
»¶y
) != 0)

2818 
	`sÿm³r_Œaûlb_»¶y_ä“
(
»¶y
);

2819 
”r
;

2822 if(
´
->
´obe
->
rxc
 == 1)

2823 
b¿nch
->
k
++;

2825 if(
	`Œaûlb_cmp_node2»¶y
(
node
, 
»¶y
) != 0)

2827 
´oûss
 = 1;

2829 if(
´
->
´obe
->
rxc
 =ğ1 && 
b¿nch
->
k
 =ğ
	`k
(
¡©e
, 2))

2831 
´oûss
 = 1;

2832 
b¿nch
->
k
++;

2835 if(
´oûss
 == 0)

2837 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
b¿nch
->
h—²ode
);

2838 
	`timev®_add_cs
(&
b¿nch
->
Ãxt_tx
, &b¿nch->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2839 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
b¿nch
) != 0)

2840 
”r
;

2841 
	`Œaûlb_queue
(
sk
);

2845 
	`Œaûlb_´oûss_´obes
(
sk
, 
´
->
b¿nch
);

2850 
”r
:

2851 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

2853 
	}
}

2860 
	$hªdËicmp_bršgfwd
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_icmp_»¥_t
 *
œ
,

2861 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
äom
)

2863 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

2864 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

2865 
Œaûlb_b¿nch_t
 *
b¿nch
 = 
´
->branch;

2866 
Œaûlb_´obe_t
 *
ır
;

2867 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

2868 
sÿm³r_Œaûlb_lšk_t
 
fšdme
;

2869 
sÿm³r_Œaûlb_node_t
 
node
;

2870 
Œaûlb_lšk_t
 *
bl
;

2871 
i
, 
rx
, 
£t
, 
n
;

2873 #ifdeà
HAVE_SCAMPER_DEBUG


2874 
f
[64], 
t
[64];

2877 if((
»¶y
 = 
	`hªdËicmp_»¶y
(
œ
, 
äom
)è=ğ
NULL
)

2879 
”r
;

2881 if(
	`sÿm³r_Œaûlb_´obe_»¶y
(
´
->
´obe
, 
»¶y
) != 0)

2883 
	`sÿm³r_Œaûlb_»¶y_ä“
(
»¶y
);

2884 
”r
;

2891 
ır
 = 
b¿nch
->
´obes
[b¿nch->
´obec
-1];

2892 if(
´
->
mode
 !ğ
ır
->mode ||

2893 
´
->
´obe
->
æowid
 !ğ
ır
->probe->flowid ||

2894 
´
->
´obe
->
‰l
 !ğ
ır
->probe->ttl)

2898 
i
=0, 
rx
=0; i<=
ır
->
´obe
->
©‹m±
; i++)

2900 
rx
 +ğ
b¿nch
->
´obes
[b¿nch->
´obec
-1-
i
]->
´obe
->
rxc
;

2902 if(
rx
 != 1)

2907 
	`mem£t
(&
node
, 0, (node));

2908 if(
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
è|| 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(ir))

2910 
node
.
q_‰l
 |ğ
œ
->
œ_šÃr__‰l
;

2911 
node
.
æags
 = 
SCAMPER_TRACELB_NODE_FLAG_QTTL
;

2913 
node
.
addr
 = 
äom
;

2914 
fšdme
.
to
 = &
node
;

2916 
	`as£¹
(
´
->
mode
 =ğ
MODE_BRINGFWD
 ||…r->mod=ğ
MODE_BRINGFWD0
);

2917 if(
´
->
mode
 =ğ
MODE_BRINGFWD
)

2918 
fšdme
.
äom
 = 
´
->
lšk
->lšk->
to
;

2920 
fšdme
.
äom
 = 
Œaû
->
nodes
[0];

2922 
	`sÿm³r_debug
(
__func__
, "reply†ink %s %s",

2923 
	`sÿm³r_addr_to¡r
(
fšdme
.
äom
->
addr
, 
f
, (f)),

2924 
	`sÿm³r_addr_to¡r
(
fšdme
.
to
->
addr
, 
t
, (t)));

2926 if((
bl
 = 
	`Œaûlb_lšk_fšd
(
¡©e
, &
fšdme
)è=ğ
NULL
)

2928 
	`sÿm³r_debug
(
__func__
, "no matching†ink inrace");

2929 
£t
 = 1;

2933 if(
	`Œaûlb_lšk_æowid_add_
(
bl
, 
´
->
´obe
) != 0)

2934 
”r
;

2936 
i
=0; i<
b¿nch
->
bršgfwdc
; i++)

2938 if(
b¿nch
->
bršgfwd
[
i
]->
·th
->
lškc
 == 0)

2941 if(
b¿nch
->
bršgfwd
[
i
]->
·th
->
lšks
[0] =ğ
bl
)

2945 if(
i
 !ğ
b¿nch
->
bršgfwdc
)

2946 
£t
 = 0;

2948 
£t
 = 1;

2955 if(
´
->
mode
 =ğ
MODE_BRINGFWD
)

2957 if(
	`Œaûlb_bršgfwd_£t
(
¡©e
, 
b¿nch
, 
´
->
lšk
, 
£t
) != 0)

2959 
	`Œaûlb_b¿nch_ÿnûl
(
sk
, 
b¿nch
);

2960 
b¿nch
 = 
NULL
;

2965 
	`as£¹
(
´
->
mode
 =ğ
MODE_BRINGFWD0
);

2966 
n
 = 
	`TRACELB_CONFIDENCE_NLIMIT
(
Œaû
->
nodes
[0]->
lškc
+2);

2968 if(
£t
 == 0)

2969 
b¿nch
->
bršgfwd0
 = 0;

2971 
b¿nch
->
bršgfwd0
++;

2973 
	`sÿm³r_debug
(
__func__
, "˜0 k %d : %d", 
b¿nch
->
bršgfwd0
, 
	`k
(
¡©e
, 
n
));

2975 if(
b¿nch
->
bršgfwd0
 >ğ
	`k
(
¡©e
, 
n
))

2977 
	`Œaûlb_b¿nch_ÿnûl
(
sk
, 
b¿nch
);

2978 
b¿nch
 = 
NULL
;

2982 if(
b¿nch
 !ğ
NULL
)

2984 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
b¿nch
->
h—²ode
);

2985 
	`timev®_add_cs
(&
b¿nch
->
Ãxt_tx
, &b¿nch->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

2986 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
b¿nch
) != 0)

2987 
”r
;

2990 
	`Œaûlb_·ths_dump
(
¡©e
);

2991 
	`Œaûlb_queue
(
sk
);

2994 
”r
:

2995 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

2997 
	}
}

2999 
	$do_Œaûlb_hªdË_icmp
(
sÿm³r_sk_t
 *
sk
,

3000 
sÿm³r_icmp_»¥_t
 *
œ
)

3002 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_icmp_»¥_t
 *,

3003 
Œaûlb_´obe_t
 *, 
sÿm³r_addr_t
 *) = {

3004 
NULL
,

3005 
NULL
,

3006 
hªdËicmp_fœ¡addr
,

3007 
hªdËicmp_hİ´obe
,

3008 
hªdËicmp_hİ´obe
,

3009 
hªdËicmp_³½ack‘
,

3010 
hªdËicmp_bršgfwd
,

3011 
hªdËicmp_bršgfwd
,

3012 
hªdËicmp_hİ´obe
,

3014 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3015 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3016 
Œaûlb_´obe_t
 *
´
;

3017 
sÿm³r_addr_t
 *
icmpäom
 = 
NULL
;

3018 
ušt16_t
 
id
;

3019 
ušt8_t
 
´Ùo
;

3020 *
addr
;

3021 
ty³
;

3023 
	`as£¹
(
œ
->
œ_af
 =ğ
AF_INET
 || ir->œ_aà=ğ
AF_INET6
);

3029 if(
¡©e
->
id_Ãxt
 == 0)

3037 if(
œ
->
œ_fd
 !ğ
	`sÿm³r_fd_fd_g‘
(
¡©e
->
icmp
))

3040 
	`sÿm³r_icmp_»¥_´št
(
œ
);

3043 if(!((
	`SCAMPER_ICMP_RESP_IS_TTL_EXP
(
œ
) ||

3044 
	`SCAMPER_ICMP_RESP_IS_UNREACH
(
œ
) ||

3045 
	`SCAMPER_ICMP_RESP_IS_PACKET_TOO_BIG
(
œ
)) &&

3046 
	`SCAMPER_ICMP_RESP_INNER_IS_SET
(
œ
è&& ir->
œ_šÃr__off
 == 0) &&

3047 !(
	`SCAMPER_TRACELB_TYPE_IS_ICMP
(
Œaû
) &&

3048 
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
)))

3053 if(
	`SCAMPER_TRACELB_TYPE_IS_UDP
(
Œaû
))

3060 if(
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_UDP
)

3063 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
)

3066 if(
œ
->
œ_šÃr_udp_¥Üt
 !ğ
Œaû
->
¥Üt
)

3072 if(
œ
->
œ_šÃr_udp_dpÜt
 !ğ
Œaû
->
dpÜt
)

3077 if(
œ
->
œ_af
 =ğ
AF_INET
)

3079 if(
	`Áohs
(
œ
->
œ_šÃr_udp_sum
è=ğœ->
œ_šÃr__id
 &&

3080 
œ
->
œ_šÃr_udp_sum
 != 0)

3082 
id
 = 
	`Áohs
(
œ
->
œ_šÃr_udp_sum
) - 1;

3084 if(
œ
->
œ_šÃr__id
 != 0)

3086 
id
 = 
œ
->
œ_šÃr__id
 - 1;

3093 if(
œ
->
œ_af
 =ğ
AF_INET6
)

3095 if(
œ
->
œ_šÃr_udp_sum
 == 0)

3097 
id
 = 
	`Áohs
(
œ
->
œ_šÃr_udp_sum
) - 1;

3101 if(
	`SCAMPER_TRACELB_TYPE_IS_ICMP
(
Œaû
))

3103 if(
	`SCAMPER_ICMP_RESP_IS_ECHO_REPLY
(
œ
) == 0)

3105 if(
œ
->
œ_af
 =ğ
AF_INET
è
´Ùo
 = 
IPPROTO_ICMP
;

3106 if(
œ
->
œ_af
 =ğ
AF_INET6
è
´Ùo
 = 
IPPROTO_ICMPV6
;

3109 if(
œ
->
œ_šÃr__´Ùo
 !ğ
´Ùo
 ||

3110 
œ
->
œ_šÃr_icmp_id
 !ğ
Œaû
->
¥Üt
 ||

3111 
œ
->
œ_šÃr_icmp_£q
 >ğ
¡©e
->
id_Ãxt
)

3116 
id
 = 
œ
->
œ_šÃr_icmp_£q
;

3120 if(
œ
->
œ_icmp_id
 !ğ
Œaû
->
¥Üt
 ||

3121 
œ
->
œ_icmp_£q
 >ğ
¡©e
->
id_Ãxt
)

3126 
id
 = 
œ
->
œ_icmp_£q
;

3129 if(
	`SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
))

3136 if(
œ
->
œ_šÃr__´Ùo
 !ğ
IPPROTO_TCP
 ||

3137 
œ
->
œ_šÃr_tı_dpÜt
 !ğ
Œaû
->
dpÜt
)

3142 if(
œ
->
œ_šÃr__id
 != 0)

3143 
id
 = 
œ
->
œ_šÃr__id
 - 1;

3150 if(
id
 >ğ
¡©e
->
id_Ãxt
)

3154 
´
 = 
¡©e
->
´obes
[
id
];

3156 if(
´
->
b¿nch
 =ğ
NULL
)

3158 
	`sÿm³r_debug
(
__func__
, "pr->branch is‚ull");

3163 if(
œ
->
œ_af
 =ğ
AF_INET
)

3165 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV4
;

3166 
addr
 = &
œ
->
œ__¤c
.
v4
;

3170 
ty³
 = 
SCAMPER_ADDR_TYPE_IPV6
;

3171 
addr
 = &
œ
->
œ__¤c
.
v6
;

3174 if((
icmpäom
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
ty³
, 
addr
)è=ğ
NULL
)

3176 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get icmpfrom");

3177 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3181 
func
[
´
->
mode
](
sk
, 
œ
,…r, 
icmpäom
);

3182 
	`sÿm³r_addr_ä“
(
icmpäom
);

3184 
	}
}

3192 
	$hªdËtimeout_fœ¡addr
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

3194 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3195 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3196 
sÿm³r_Œaûlb_node_t
 *
node
 = 
NULL
;

3198 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
br
->
h—²ode
);

3200 if((
node
 = 
	`sÿm³r_Œaûlb_node_®loc
(
NULL
)) == NULL)

3202 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ode");

3203 
”r
;

3206 if(
	`sÿm³r_Œaûlb_node_add
(
Œaû
, 
node
) != 0)

3208 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡dd‚ode");

3209 
”r
;

3211 
node
 = 
NULL
;

3213 
br
->
mode
 = 
MODE_FIRSTHOP
;

3214 
	`Œaûlb_b¿nch_»£t
(
br
);

3215 
	`timev®_add_cs
(&
br
->
Ãxt_tx
, &br->
Ï¡_tx
, 
Œaû
->
wa™_´obe
);

3216 if(
	`Œaûlb_b¿nch_wa™šg
(
¡©e
, 
br
) != 0)

3217 
”r
;

3219 
	`Œaûlb_queue
(
sk
);

3222 
”r
:

3223 
	`sÿm³r_Œaûlb_node_ä“
(
node
);

3224 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

3225 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3227 
	}
}

3235 
	$hªdËtimeout_abªdÚ
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

3237 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3238 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
br
->
h—²ode
);

3239 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

3240 
	`Œaûlb_queue
(
sk
);

3242 
	}
}

3251 
	$hªdËtimeout_hİ´obe
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

3253 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3255 
br
->
l
++;

3257 
	`as£¹
(
br
->
mode
 =ğ
MODE_FIRSTHOP
 || br->mod=ğ
MODE_HOPPROBE
 ||

3258 
br
->
mode
 =ğ
MODE_CLUMP
);

3264 if((
br
->
k
 + br->
l
è>ğ
	`k
(
¡©e
, br->
n
))

3266 
	`Œaûlb_´oûss_´obes
(
sk
, 
br
);

3270 
	`Œaûlb_queue
(
sk
);

3273 
	}
}

3279 
	$hªdËtimeout_³½ack‘
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

3281 
	`as£¹
(
br
->
Ãwnodec
 > 1);

3282 
	`Œaûlb_´oûss_´obes
(
sk
, 
br
);

3284 
	}
}

3286 
	$hªdËtimeout_bršgfwd
(
sÿm³r_sk_t
 *
sk
, 
Œaûlb_b¿nch_t
 *
br
)

3288 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3289 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3290 
Œaûlb_´obe_t
 *
´
 = 
br
->
´obes
[br->
´obec
-1];

3291 
ÿnûl
 = 0, 
n
;

3293 
	`as£¹
(
´
->
mode
 =ğ
MODE_BRINGFWD
 ||…r->mod=ğ
MODE_BRINGFWD0
);

3299 if(
´
->
mode
 =ğ
MODE_BRINGFWD
)

3301 if(
	`Œaûlb_bršgfwd_£t
(
¡©e
, 
br
, 
´
->
lšk
, 1) != 0)

3303 
ÿnûl
 = 1;

3308 
br
->
bršgfwd0
++;

3310 
n
 = 
	`TRACELB_CONFIDENCE_NLIMIT
(
Œaû
->
nodes
[0]->
lškc
+2);

3311 if(
br
->
bršgfwd0
 >ğ
	`k
(
¡©e
, 
n
))

3313 
ÿnûl
 = 1;

3317 if(
ÿnûl
 != 0)

3319 
	`Œaûlb_b¿nch_ÿnûl
(
sk
, 
br
);

3322 
	`Œaûlb_queue
(
sk
);

3324 
	}
}

3331 
	$do_Œaûlb_hªdË_timeout
(
sÿm³r_sk_t
 *
sk
)

3333 (*cÚ¡ 
func
[])(
sÿm³r_sk_t
 *, 
Œaûlb_b¿nch_t
 *) = {

3334 
NULL
,

3335 
NULL
,

3336 
hªdËtimeout_fœ¡addr
,

3337 
hªdËtimeout_hİ´obe
,

3338 
hªdËtimeout_hİ´obe
,

3339 
hªdËtimeout_³½ack‘
,

3340 
hªdËtimeout_bršgfwd
,

3341 
hªdËtimeout_bršgfwd
,

3342 
hªdËtimeout_hİ´obe
,

3344 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3345 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3346 
Œaûlb_b¿nch_t
 *
br
;

3347 
Œaûlb_´obe_t
 *
´
;

3349 
	`as£¹
(
	`h—p_couÁ
(
¡©e
->
aùive
è> 0 || h—p_couÁ(¡©e->
wa™šg
) > 0);

3355 if((
br
 = 
	`h—p_h—d_™em
(
¡©e
->
aùive
)è=ğ
NULL
)

3357 
	`Œaûlb_queue
(
sk
);

3361 if(
br
->
mode
 =ğ
MODE_RTSOCK
 || br->mod=ğ
MODE_DLHDR
)

3363 
	`hªdËtimeout_abªdÚ
(
sk
, 
br
);

3371 
	`as£¹
(
br
->
´obec
 > 0);

3372 
´
 = 
br
->
´obes
[br->
´obec
-1];

3373 if(
´
->
´obe
->
rxc
 =ğ0 &&…r->´obe->
©‹m±
 + 1 >ğ
Œaû
->
©‹m±s
)

3375 
func
[
´
->
mode
](
sk
, 
br
);

3379 
	`Œaûlb_queue
(
sk
);

3381 
	}
}

3383 
	$hªdËtı_fœ¡addr
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
,

3384 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
äom
)

3386 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3387 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3388 
sÿm³r_Œaûlb_node_t
 *
node
 = 
NULL
;

3389 
Œaûlb_b¿nch_t
 *
br
 = 
´
->
b¿nch
;

3391 
	`as£¹
(
´
->
´obe
->
‰l
 =ğ
Œaû
->
fœ¡hİ
);

3392 
	`as£¹
(
Œaû
->
nodes
 =ğ
NULL
);

3395 if(
br
->
h—²ode
 !ğ
NULL
)

3396 
	`h—p_d–‘e
(
¡©e
->
aùive
, 
br
->
h—²ode
);

3397 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

3400 if((
node
 = 
	`sÿm³r_Œaûlb_node_®loc
(
äom
)è=ğ
NULL
 ||

3401 
	`sÿm³r_Œaûlb_node_add
(
Œaû
, 
node
) != 0)

3403 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‚ode");

3404 
”r
;

3407 
	`Œaûlb_·ths_as£¹
(
¡©e
);

3408 
	`Œaûlb_queue
(
sk
);

3411 
”r
:

3412 
	`sÿm³r_Œaûlb_node_ä“
(
node
);

3413 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3415 
	}
}

3417 
	$hªdËtı_hİ´obe
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
,

3418 
Œaûlb_´obe_t
 *
´
, 
sÿm³r_addr_t
 *
tıäom
)

3420 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

3422 if(
´
->
b¿nch
 =ğ
NULL
)

3425 if((
»¶y
 = 
	`hªdËtı_»¶y
(
dl
, 
tıäom
)è=ğ
NULL
 ||

3426 
	`hİ´obe_hªdË»¶y
(
sk
, 
´
, 
»¶y
) != 0)

3428 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3432 
	}
}

3442 
	$hªdËtı_³½ack‘
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
,

3443 
Œaûlb_´obe_t
 *
´obe
, 
sÿm³r_addr_t
 *
äom
)

3446 
	}
}

3448 
	$do_Œaûlb_hªdË_dl
(
sÿm³r_sk_t
 *
sk
, 
sÿm³r_dl_»c_t
 *
dl
)

3450 (* cÚ¡ 
hªdËtı_func
[])(
sÿm³r_sk_t
 *, 
sÿm³r_dl_»c_t
 *,

3451 
Œaûlb_´obe_t
 *, 
sÿm³r_addr_t
 *) =

3453 
NULL
,

3454 
NULL
,

3455 
hªdËtı_fœ¡addr
,

3456 
hªdËtı_hİ´obe
,

3457 
hªdËtı_hİ´obe
,

3458 
hªdËtı_³½ack‘
,

3459 
NULL
,

3460 
NULL
,

3461 
hªdËtı_hİ´obe
,

3464 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3465 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3466 
sÿm³r_addr_t
 *
äom
;

3467 
Œaûlb_´obe_t
 *
´
;

3469 if(
	`SCAMPER_DL_IS_TCP
(
dl
) == 0)

3473 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_SPORT
)

3479 if(
dl
->
dl_tı_æags
 =ğ
TH_SYN
)

3482 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
)

3488 if(
dl
->
dl_tı_æags
 =ğ
TH_ACK
)

3492 
	`sÿm³r_dl_»c_tı_´št
(
dl
);

3494 if(
dl
->
dl_tı_¥Üt
 !ğ
Œaû
->
dpÜt
)

3496 
	`sÿm³r_debug
(
__func__
, "ignoring„eply sport %d dport %d",

3497 
dl
->
dl_tı_¥Üt
, 
Œaû
->
dpÜt
);

3505 
	`as£¹
(
¡©e
->
id_Ãxt
 > 0);

3506 
´
 = 
¡©e
->
´obes
[¡©e->
id_Ãxt
-1];

3508 if(
´
->
b¿nch
 =ğ
NULL
)

3510 
	`sÿm³r_debug
(
__func__
, "pr->branch is‚ull");

3515 if(
´
->
´obe
->
æowid
 !ğ
dl
->
dl_tı_dpÜt
)

3517 
	`sÿm³r_debug
(
__func__
, "ignoring„eply flowid %d dport %d",

3518 
´
->
´obe
->
æowid
, 
dl
->
dl_tı_dpÜt
);

3523 if(
hªdËtı_func
[
´
->
mode
] !ğ
NULL
)

3525 if((
äom
 = 
	`sÿm³r_addrÿche_g‘
(
addrÿche
, 
Œaû
->
d¡
->
ty³
,

3526 
dl
->
dl__¤c
)è=ğ
NULL
)

3528 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get‡ddr");

3529 
”r
;

3532 
hªdËtı_func
[
´
->
mode
](
sk
, 
dl
,…r, 
äom
);

3537 
”r
:

3538 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3540 
	}
}

3547 
	$Œaûlb_hªdË_dlhdr
(
sÿm³r_dlhdr_t
 *
dlhdr
)

3549 
sÿm³r_sk_t
 *
sk
 = 
dlhdr
->
·¿m
;

3550 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3551 
Œaûlb_b¿nch_t
 *
br
;

3553 if(
dlhdr
->
”rÜ
 != 0)

3555 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

3560 
	`as£¹
(
	`h—p_couÁ
(
¡©e
->
aùive
) == 1);

3561 
br
 = 
	`h—p_h—d_™em
(
¡©e
->
aùive
);

3562 
	`as£¹
(
br
->
mode
 =ğ
MODE_DLHDR
);

3565 
br
->
mode
 = 
MODE_FIRSTADDR
;

3566 
	`Œaûlb_b¿nch_»£t
(
br
);

3567 
	`sÿm³r_sk_queue_´obe
(
sk
);

3570 
	}
}

3578 
	$Œaûlb_hªdË_¹
(
sÿm³r_rou‹_t
 *
¹
)

3580 
sÿm³r_sk_t
 *
sk
 = 
¹
->
·¿m
;

3581 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3582 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3583 
Œaûlb_b¿nch_t
 *
br
;

3584 
sÿm³r_dl_t
 *
dl
;

3586 #iâdeà
_WIN32


3587 if(
¡©e
->
¹sock
 =ğ
NULL
)

3588 
dÚe
;

3591 if(
¡©e
->
rou‹
 !ğ
¹
)

3592 
dÚe
;

3594 
	`as£¹
(
	`h—p_couÁ
(
¡©e
->
aùive
) == 1);

3595 
br
 = 
	`h—p_h—d_™em
(
¡©e
->
aùive
);

3596 
	`as£¹
(
br
->
mode
 =ğ
MODE_RTSOCK
);

3598 #iâdeà
_WIN32


3599 
	`sÿm³r_fd_ä“
(
¡©e
->
¹sock
);

3600 
¡©e
->
¹sock
 = 
NULL
;

3604 if(
¹
->
”rÜ
 !ğ0 ||„t->
ifšdex
 < 0)

3606 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot get ifindex");

3607 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3608 
dÚe
;

3611 if((
¡©e
->
dl
 = 
	`sÿm³r_fd_dl
(
¹
->
ifšdex
)è=ğ
NULL
)

3613 
	`sÿm³r_debug
(
__func__
, "could‚Ù g‘ dÈfÜ %d", 
¹
->
ifšdex
);

3614 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3615 
dÚe
;

3622 
br
->
mode
 = 
MODE_DLHDR
;

3623 if((
¡©e
->
dlhdr
 = 
	`sÿm³r_dlhdr_®loc
()è=ğ
NULL
)

3625 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3626 
dÚe
;

3628 
dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->dl);

3629 
¡©e
->
dlhdr
->
d¡
 = 
	`sÿm³r_addr_u£
(
Œaû
->dst);

3630 
¡©e
->
dlhdr
->
gw
 = 
¹
->gw !ğ
NULL
 ? 
	`sÿm³r_addr_u£
(rt->gw) : NULL;

3631 
¡©e
->
dlhdr
->
ifšdex
 = 
¹
->ifindex;

3632 
¡©e
->
dlhdr
->
txty³
 = 
	`sÿm³r_dl_tx_ty³
(
dl
);

3633 
¡©e
->
dlhdr
->
·¿m
 = 
sk
;

3634 
¡©e
->
dlhdr
->
cb
 = 
Œaûlb_hªdË_dlhdr
;

3635 if(
	`sÿm³r_dlhdr_g‘
(
¡©e
->
dlhdr
) != 0)

3637 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

3638 
dÚe
;

3642 if(
br
->
mode
 =ğ
MODE_FIRSTADDR
)

3644 
	`timev®_ıy
(&
¡©e
->
Ãxt_tx
, &
br
->
Ï¡_tx
);

3645 
	`timev®_ıy
(&
br
->
Ãxt_tx
, &br->
Ï¡_tx
);

3648 
	`Œaûlb_queue
(
sk
);

3650 
dÚe
:

3651 
	`sÿm³r_rou‹_ä“
(
¹
);

3652 if(
¡©e
->
rou‹
 =ğ
¹
)

3653 
¡©e
->
rou‹
 = 
NULL
;

3655 
	}
}

3657 
	$do_Œaûlb_wr™e
(
sÿm³r_fe_t
 *
sf
, 
sÿm³r_sk_t
 *
sk
)

3659 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3660 
	`sÿm³r_fe_wr™e_Œaûlb
(
sf
, 
Œaû
);

3662 
	}
}

3664 
	$Œaûlb_¡©e_ä“
(
sÿm³r_Œaûlb_t
 *
Œaû
,
Œaûlb_¡©e_t
 *
¡©e
)

3666 
Œaûlb_b¿nch_t
 *
br
;

3667 
Œaûlb_´obe_t
 *
´
;

3668 
i
;

3670 
	`Œaûlb_·ths_dump
(
¡©e
);

3671 
	`Œaûlb_lšks_dump
(
¡©e
);

3674 if(
¡©e
->
aùive
 !ğ
NULL
)

3676 (
br
 = 
	`h—p_»move
(
¡©e
->
aùive
)è!ğ
NULL
)

3678 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

3680 
	`h—p_ä“
(
¡©e
->
aùive
, 
NULL
);

3684 if(
¡©e
->
wa™šg
 !ğ
NULL
)

3686 (
br
 = 
	`h—p_»move
(
¡©e
->
wa™šg
)è!ğ
NULL
)

3688 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
br
);

3690 
	`h—p_ä“
(
¡©e
->
wa™šg
, 
NULL
);

3694 if(
¡©e
->
´obes
 !ğ
NULL
)

3696 
i
=0; i<
¡©e
->
id_Ãxt
; i++)

3698 
´
 = 
¡©e
->
´obes
[
i
];

3699 if(
´
->
mode
 =ğ
MODE_FIRSTADDR
 ||…r->mod=ğ
MODE_BRINGFWD
 ||

3700 
´
->
mode
 =ğ
MODE_BRINGFWD0
)

3702 
	`sÿm³r_Œaûlb_´obe_ä“
(
´
->
´obe
);

3704 
	`ä“
(
´
);

3706 
	`ä“
(
¡©e
->
´obes
);

3710 if(
¡©e
->
·ths
 !ğ
NULL
)

3712 
i
=0; i<
¡©e
->
·thc
; i++)

3714 
	`Œaûlb_·th_ä“
(
¡©e
->
·ths
[
i
]);

3716 
	`ä“
(
¡©e
->
·ths
);

3720 if(
¡©e
->
lšks
 !ğ
NULL
)

3722 
i
=0; i<
¡©e
->
lškc
; i++)

3724 
	`Œaûlb_lšk_ä“
(
¡©e
->
lšks
[
i
]);

3726 
	`ä“
(
¡©e
->
lšks
);

3729 if(
¡©e
->
icmp
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->icmp);

3730 if(
¡©e
->
dl
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->dl);

3731 #iâdeà
_WIN32


3732 if(
¡©e
->
¹sock
 !ğ
NULL
è
	`sÿm³r_fd_ä“
(state->rtsock);

3734 if(
¡©e
->
dlhdr
 !ğ
NULL
è
	`sÿm³r_dlhdr_ä“
(state->dlhdr);

3735 if(
¡©e
->
rou‹
 !ğ
NULL
è
	`sÿm³r_rou‹_ä“
(state->route);

3737 
Œaû
->
ty³
)

3739 
SCAMPER_TRACELB_TYPE_UDP_DPORT
:

3740 
SCAMPER_TRACELB_TYPE_ICMP_ECHO
:

3741 if(
¡©e
->
´obe
 !ğ
NULL
)

3742 
	`sÿm³r_fd_ä“
(
¡©e
->
´obe
);

3745 
SCAMPER_TRACELB_TYPE_UDP_SPORT
:

3746 
SCAMPER_TRACELB_TYPE_TCP_SPORT
:

3747 
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
:

3751 
	`ä“
(
¡©e
);

3753 
	}
}

3755 
	$do_Œaûlb_h®t
(
sÿm³r_sk_t
 *
sk
)

3757 
	`sÿm³r_sk_queue_dÚe
(
sk
, 0);

3759 
	}
}

3761 
	$do_Œaûlb_ä“
(
sÿm³r_sk_t
 *
sk
)

3763 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3764 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3766 if(
Œaû
 =ğ
NULL
)

3768 
	`as£¹
(
¡©e
 =ğ
NULL
);

3773 if(
¡©e
 !ğ
NULL
)

3774 
	`Œaûlb_¡©e_ä“
(
Œaû
, 
¡©e
);

3777 
	`sÿm³r_Œaûlb_ä“
(
Œaû
);

3780 
	}
}

3782 
	$Œaûlb_b¿nch_Ú»move
(*
™em
)

3784 ((
Œaûlb_b¿nch_t
 *)
™em
)->
h—²ode
 = 
NULL
;

3786 
	}
}

3794 
	$Œaûlb_¡©e_®loc
(
sÿm³r_sk_t
 *
sk
)

3796 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3797 
Œaûlb_¡©e_t
 *
¡©e
 = 
NULL
;

3798 *
addr
 = 
Œaû
->
¤c
->addr;

3799 
Œaûlb_b¿nch_t
 *
b¿nch
;

3801 
	`as£¹
(
Œaû
 !ğ
NULL
);

3803 if((
¡©e
 = 
	`m®loc_z”o
((
Œaûlb_¡©e_t
))è=ğ
NULL
)

3805 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot malloc state");

3806 
”r
;

3809 
Œaû
->
cÚfid’û
)

3812 
¡©e
->
cÚfid’û
 = 0;

3816 
¡©e
->
cÚfid’û
 = 1;

3820 
”r
;

3823 if((
¡©e
->
aùive
 = 
	`h—p_®loc
((
h—p_cmp_t
)
Œaûlb_b¿nch_aùive_cmp
))==
NULL
)

3825 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc‡ctive heap");

3826 
”r
;

3828 
	`h—p_Ú»move
(
¡©e
->
aùive
, 
Œaûlb_b¿nch_Ú»move
);

3829 if((
¡©e
->
wa™šg
=
	`h—p_®loc
((
h—p_cmp_t
)
Œaûlb_b¿nch_wa™šg_cmp
))==
NULL
)

3831 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc waiting heap");

3832 
”r
;

3834 
	`h—p_Ú»move
(
¡©e
->
wa™šg
, 
Œaûlb_b¿nch_Ú»move
);

3836 if((
b¿nch
 = 
	`m®loc_z”o
((
Œaûlb_b¿nch_t
))è=ğ
NULL
)

3838 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc branch");

3839 
”r
;

3842 if(
	`SCAMPER_TRACELB_TYPE_VARY_SPORT
(
Œaû
))

3844 
b¿nch
->
mode
 = 
MODE_RTSOCK
;

3846 #iâdeà
_WIN32


3847 if((
¡©e
->
¹sock
 = 
	`sÿm³r_fd_¹sock
()è=ğ
NULL
)

3849 
”r
;

3855 
b¿nch
->
mode
 = 
MODE_FIRSTADDR
;

3857 
	`Œaûlb_b¿nch_»£t
(
b¿nch
);

3858 if(
	`Œaûlb_b¿nch_wa™šg
(
¡©e
, 
b¿nch
) != 0)

3859 
”r
;

3862 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

3864 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
)

3866 if((
¡©e
->
´obe
 = 
	`sÿm³r_fd_udp4
(
addr
, 
Œaû
->
¥Üt
)è=ğ
NULL
)

3867 
”r
;

3869 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_ICMP_ECHO
)

3871 if((
¡©e
->
´obe
 = 
	`sÿm³r_fd_icmp4
(
addr
)è=ğ
NULL
)

3872 
”r
;

3874 if(
	`SCAMPER_TRACELB_TYPE_VARY_SPORT
(
Œaû
) == 0)

3876 
”r
;

3879 if(
	`SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
))

3880 
¡©e
->
·ylßd_size
 = 0;

3882 
¡©e
->
·ylßd_size
 = 
Œaû
->
´obe_size
 - 28;

3884 
¡©e
->
icmp
 = 
	`sÿm³r_fd_icmp4
(
addr
);

3886 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
)

3888 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
)

3890 if((
¡©e
->
´obe
 = 
	`sÿm³r_fd_udp6
(
addr
, 
Œaû
->
¥Üt
)è=ğ
NULL
)

3891 
”r
;

3893 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_ICMP_ECHO
)

3895 if((
¡©e
->
´obe
 = 
	`sÿm³r_fd_icmp6
(
addr
)è=ğ
NULL
)

3896 
”r
;

3898 if(
Œaû
->
ty³
 !ğ
SCAMPER_TRACELB_TYPE_UDP_SPORT
)

3900 
”r
;

3903 
¡©e
->
icmp
 = 
	`sÿm³r_fd_icmp6
(
addr
);

3904 
¡©e
->
·ylßd_size
 = 
Œaû
->
´obe_size
 - 48;

3906 
”r
;

3909 if(
pktbuf_Ën
 < 
¡©e
->
·ylßd_size
)

3911 if(
	`»®loc_w¿p
((**)&
pktbuf
, 
¡©e
->
·ylßd_size
) != 0)

3913 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot„ealloc");

3914 
”r
;

3916 
pktbuf_Ën
 = 
¡©e
->
·ylßd_size
;

3919 if(
¡©e
->
icmp
 =ğ
NULL
)

3921 
”r
;

3924 
Œaû
->
ty³
)

3926 
SCAMPER_TRACELB_TYPE_UDP_DPORT
:

3927 
¡©e
->
æowid_Ãxt
 = 
Œaû
->
dpÜt
;

3930 
SCAMPER_TRACELB_TYPE_ICMP_ECHO
:

3931 
¡©e
->
æowid_Ãxt
 = 1;

3934 
SCAMPER_TRACELB_TYPE_UDP_SPORT
:

3935 
SCAMPER_TRACELB_TYPE_TCP_SPORT
:

3936 
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
:

3937 
¡©e
->
æowid_Ãxt
 = 
Œaû
->
¥Üt
;

3941 
”r
;

3944 
	`sÿm³r_sk_£t¡©e
(
sk
, 
¡©e
);

3947 
”r
:

3948 
	`Œaûlb_¡©e_ä“
(
Œaû
, 
¡©e
);

3950 
	}
}

3952 
	$do_Œaûlb_´obe
(
sÿm³r_sk_t
 *
sk
)

3954 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
	`Œaûlb_g‘d©a
(
sk
);

3955 
Œaûlb_¡©e_t
 *
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3956 
Œaûlb_b¿nch_t
 *
b¿nch
;

3957 
Œaûlb_´obe_t
 *

 = 
NULL
;

3958 
Œaûlb_´obe_t
 *
l
;

3959 
sÿm³r_´obe_t
 
´obe
;

3960 
ušt16_t
 
u16
;

3962 
	`as£¹
(
Œaû
 !ğ
NULL
);

3964 if(
¡©e
 =ğ
NULL
)

3967 
	`g‘timeofday_w¿p
(&
Œaû
->
¡¬t
);

3970 if(
	`Œaûlb_¡©e_®loc
(
sk
) != 0)

3971 
”r
;

3973 
¡©e
 = 
	`Œaûlb_g‘¡©e
(
sk
);

3977 if((
b¿nch
 = 
	`h—p_»move
(
¡©e
->
aùive
)è=ğ
NULL
)

3979 
b¿nch
 = 
	`h—p_»move
(
¡©e
->
wa™šg
);

3981 
	`as£¹
(
b¿nch
 !ğ
NULL
);

3983 if(
b¿nch
->
mode
 =ğ
MODE_RTSOCK
)

3985 
¡©e
->
rou‹
 = 
	`sÿm³r_rou‹_®loc
(
Œaû
->
d¡
, 
sk
, 
Œaûlb_hªdË_¹
);

3986 if(
¡©e
->
rou‹
 =ğ
NULL
)

3987 
”r
;

3989 #iâdeà
_WIN32


3990 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
¹sock
, s‹->
rou‹
) != 0)

3991 
”r
;

3993 if(
	`sÿm³r_¹sock_g‘rou‹
(
¡©e
->
rou‹
) != 0)

3994 
”r
;

3997 if(
	`sÿm³r_sk_queue_isdÚe
(
sk
))

3999 
	`Œaûlb_b¿nch_ä“
(
¡©e
, 
b¿nch
);

4003 if(
b¿nch
->
mode
 =ğ
MODE_RTSOCK
 || b¿nch->mod=ğ
MODE_DLHDR
)

4009 
	`g‘timeofday_w¿p
(&
b¿nch
->
Ï¡_tx
);

4010 
	`timev®_add_cs
(&
¡©e
->
Ãxt_tx
,&
b¿nch
->
Ï¡_tx
,
Œaû
->
wa™_´obe
);

4011 
	`timev®_add_s
(&
b¿nch
->
Ãxt_tx
,&b¿nch->
Ï¡_tx
,
Œaû
->
wa™_timeout
);

4012 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
b¿nch
) != 0)

4013 
”r
;

4014 
	`Œaûlb_queue
(
sk
);

4020 if(
b¿nch
->
´obec
 > 0)

4022 
l
 = 
b¿nch
->
´obes
[b¿nch->
´obec
-1];

4024 
l
 = 
NULL
;

4027 if((

 = 
	`m®loc_z”o
((
Œaûlb_´obe_t
))è=ğ
NULL
 ||

4028 (

->
´obe
 = 
	`sÿm³r_Œaûlb_´obe_®loc
()è=ğ
NULL
)

4030 
	`´š‹¼Ü
(
”ºo
, 
¡»¼Ü
, 
__func__
, "could‚ot‡lloc…robe");

4031 
”r
;

4034 
	`as£¹
((
l
 !ğ
NULL
 &&¶->
´obe
->
rxc
 == 0 &&

4035 
l
->
´obe
->
©‹m±
+1 < 
Œaû
->
©‹m±s
) ||

4036 
b¿nch
->
mode
 =ğ
MODE_FIRSTADDR
 || b¿nch->mod=ğ
MODE_FIRSTHOP
 ||

4037 
b¿nch
->
mode
 =ğ
MODE_HOPPROBE
 || b¿nch->mod=ğ
MODE_PERPACKET
 ||

4038 
b¿nch
->
mode
 =ğ
MODE_CLUMP
);

4041 

->
mode
 = 
b¿nch
->mode;

4043 if(
l
 !ğ
NULL
 &&¶->
´obe
->
rxc
 == 0 &&

4044 
l
->
´obe
->
©‹m±
+1 < 
Œaû
->
©‹m±s
)

4050 

->
´obe
->
æowid
 = 
l
->probe->flowid;

4051 

->
´obe
->
‰l
 = 
l
->probe->ttl;

4052 

->
´obe
->
©‹m±
 = 
l
->probe->attempt + 1;

4053 

->
lšk
 = 
l
->link;

4054 

->
mode
 = 
l
->mode;

4056 if(
b¿nch
->
mode
 =ğ
MODE_FIRSTADDR
)

4059 
	`as£¹
(
Œaû
->
nodec
 == 0);

4060 

->
´obe
->
æowid
 = 
¡©e
->
æowid_Ãxt
;

4061 

->
´obe
->
‰l
 = 
Œaû
->
fœ¡hİ
;

4062 

->
´obe
->
©‹m±
 = 0;

4064 if(
b¿nch
->
mode
 =ğ
MODE_FIRSTHOP
)

4067 
	`as£¹
(
Œaû
->
nodec
 > 0);

4068 

->
´obe
->
æowid
 = 
¡©e
->
æowid_Ãxt
++;

4069 

->
´obe
->
‰l
 = 
Œaû
->
fœ¡hİ
 + 1;

4070 

->
´obe
->
©‹m±
 = 0;

4072 if(
b¿nch
->
mode
 =ğ
MODE_HOPPROBE
 || b¿nch->mod=ğ
MODE_CLUMP
)

4078 if(
	`Œaûlb_´obe_v®s
(
sk
, 
b¿nch
, 

) < 0)

4079 
”r
;

4081 if(
b¿nch
->
mode
 =ğ
MODE_PERPACKET
)

4083 
	`as£¹
(
b¿nch
->
Ãwnodec
 > 1);

4084 

->
´obe
->
æowid
 = 
b¿nch
->
Ãwnodes
[0]->probe->flowid;

4085 

->
´obe
->
‰l
 = 
b¿nch
->
Ãwnodes
[0]->probe->ttl;

4086 

->
´obe
->
©‹m±
 = 0;

4089 
	`mem£t
(&
´obe
, 0, (probe));

4090 
´obe
.
´__¤c
 = 
Œaû
->
¤c
;

4091 
´obe
.
´__d¡
 = 
Œaû
->
d¡
;

4092 
´obe
.
´__tos
 = 
Œaû
->
tos
;

4093 
´obe
.
´_d©a
 = 
pktbuf
;

4094 
´obe
.
´_Ën
 = 
¡©e
->
·ylßd_size
;

4095 
´obe
.
´__‰l
 = 

->´obe->
‰l
;

4097 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

4098 
´obe
.
´__off
 = 
IP_DF
;

4101 
	`mem£t
(
´obe
.
´_d©a
, 0,…robe.
´_Ën
);

4103 if(
	`SCAMPER_TRACELB_TYPE_IS_UDP
(
Œaû
))

4105 
´obe
.
´__´Ùo
 = 
IPPROTO_UDP
;

4106 
´obe
.
´__id
 = 
¡©e
->
id_Ãxt
 + 1;

4108 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_UDP_DPORT
)

4110 
´obe
.
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
¡©e
->probe);

4111 
´obe
.
´_udp_¥Üt
 = 
Œaû
->
¥Üt
;

4112 
´obe
.
´_udp_dpÜt
 = 

->´obe->
æowid
;

4116 
´obe
.
´_udp_dpÜt
 = 
Œaû
->
dpÜt
;

4117 
´obe
.
´_udp_¥Üt
 = 

->´obe->
æowid
;

4125 
u16
 = 
	`htÚs
(
¡©e
->
id_Ãxt
 + 1);

4126 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

4127 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

4129 
´obe
.
´__id
 = 
¡©e
->
id_Ãxt
 + 1;

4130 
u16
 = 
	`sÿm³r_udp4_cksum
(&
´obe
);

4134 
u16
 = 
	`sÿm³r_udp6_cksum
(&
´obe
);

4136 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

4138 if(
	`SCAMPER_TRACELB_TYPE_IS_ICMP
(
Œaû
))

4140 
´obe
.
´_fd
 = 
	`sÿm³r_fd_fd_g‘
(
¡©e
->probe);

4141 
	`SCAMPER_PROBE_ICMP_ECHO
(&
´obe
, 
Œaû
->
¥Üt
, 
¡©e
->
id_Ãxt
);

4144 
u16
 = 
	`htÚs
(

->
´obe
->
æowid
);

4145 
´obe
.
´_icmp_sum
 = 
u16
;

4148 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

4149 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV4
)

4150 
u16
 = 
	`sÿm³r_icmp4_cksum
(&
´obe
);

4152 
u16
 = 
	`sÿm³r_icmp6_cksum
(&
´obe
);

4153 
	`memıy
(
´obe
.
´_d©a
, &
u16
, 2);

4157 
	`as£¹
(
	`SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
));

4159 
´obe
.
´__´Ùo
 = 
IPPROTO_TCP
;

4160 
´obe
.
´_tı_dpÜt
 = 
Œaû
->
dpÜt
;

4161 
´obe
.
´_tı_¥Üt
 = 

->´obe->
æowid
;

4162 
´obe
.
´_tı_£q
 = 0;

4163 
´obe
.
´_tı_ack
 = 0;

4164 
´obe
.
´_tı_wš
 = 0;

4165 
´obe
.
´__id
 = 
¡©e
->
id_Ãxt
 + 1;

4167 if(
Œaû
->
ty³
 =ğ
SCAMPER_TRACELB_TYPE_TCP_SPORT
)

4168 
´obe
.
´_tı_æags
 = 
TH_SYN
;

4170 
´obe
.
´_tı_æags
 = 
TH_ACK
;

4173 if(
	`SCAMPER_TRACELB_TYPE_VARY_SPORT
(
Œaû
))

4175 
´obe
.
´_dl
 = 
	`sÿm³r_fd_dl_g‘
(
¡©e
->
dl
);

4176 
´obe
.
´_dl_buf
 = 
¡©e
->
dlhdr
->
buf
;

4177 
´obe
.
´_dl_Ën
 = 
¡©e
->
dlhdr
->
Ën
;

4180 if(
	`sÿm³r_´obe
(&
´obe
) == -1)

4182 
”ºo
 = 
´obe
.
´_”ºo
;

4183 
”r
;

4187 
Œaû
->
´obec
++;

4190 
	`timev®_ıy
(&

->
´obe
->
tx
, &´obe.
´_tx
);

4193 if(
	`Œaûlb_´obe_add
(
¡©e
, 
b¿nch
, 

) != 0)

4194 
”r
;

4197 
	`timev®_add_cs
(&
¡©e
->
Ãxt_tx
, &
´obe
.
´_tx
, 
Œaû
->
wa™_´obe
);

4203 
	`timev®_ıy
(&
b¿nch
->
Ï¡_tx
, &
´obe
.
´_tx
);

4204 
b¿nch
->
Ãxt_tx
.
tv_£c
 = 
´obe
.
´_tx
.tv_£ø+ 
Œaû
->
wa™_timeout
;

4205 
b¿nch
->
Ãxt_tx
.
tv_u£c
 = 
´obe
.
´_tx
.tv_usec;

4206 if(
	`Œaûlb_b¿nch_aùive
(
¡©e
, 
b¿nch
) != 0)

4207 
”r
;

4209 
	`Œaûlb_queue
(
sk
);

4212 
”r
:

4213 if(

 !ğ
NULL
è
	`ä“
(tp);

4214 
	`Œaûlb_hªdË”rÜ
(
sk
, 
”ºo
);

4216 
	}
}

4218 
	$Œaûlb_¬g_·¿m_v®id©e
(
İtid
, *
·¿m
, *
out
)

4220 
tmp
;

4222 
İtid
)

4224 
TRACE_OPT_CONFIDENCE
:

4225 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 || (tmp != 95 &&mp != 99))

4227 
”r
;

4231 
TRACE_OPT_SPORT
:

4232 
TRACE_OPT_DPORT
:

4233 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4234 
tmp
 < 
SCAMPER_DO_TRACELB_PORT_MIN
 ||

4235 
tmp
 > 
SCAMPER_DO_TRACELB_PORT_MAX
)

4237 
”r
;

4241 
TRACE_OPT_FIRSTHOP
:

4242 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4243 
tmp
 < 
SCAMPER_DO_TRACELB_FIRSTHOP_MIN
 ||

4244 
tmp
 > 
SCAMPER_DO_TRACELB_FIRSTHOP_MAX
)

4246 
”r
;

4250 
TRACE_OPT_GAPLIMIT
:

4251 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4252 
tmp
 < 
SCAMPER_DO_TRACELB_GAPLIMIT_MIN
 ||

4253 
tmp
 > 
SCAMPER_DO_TRACELB_GAPLIMIT_MAX
)

4255 
”r
;

4259 
TRACE_OPT_PROTOCOL
:

4260 if(
	`¡rÿ£cmp
(
·¿m
, "udp-dport") == 0)

4261 
tmp
 = 
SCAMPER_TRACELB_TYPE_UDP_DPORT
;

4262 if(
	`¡rÿ£cmp
(
·¿m
, "icmp-echo") == 0)

4263 
tmp
 = 
SCAMPER_TRACELB_TYPE_ICMP_ECHO
;

4264 if(
	`¡rÿ£cmp
(
·¿m
, "udp-sport") == 0)

4265 
tmp
 = 
SCAMPER_TRACELB_TYPE_UDP_SPORT
;

4266 if(
	`¡rÿ£cmp
(
·¿m
, "tcp-sport") == 0)

4267 
tmp
 = 
SCAMPER_TRACELB_TYPE_TCP_SPORT
;

4268 if(
	`¡rÿ£cmp
(
·¿m
, "tcp-ack-sport") == 0)

4269 
tmp
 = 
SCAMPER_TRACELB_TYPE_TCP_ACK_SPORT
;

4271 
”r
;

4274 
TRACE_OPT_TOS
:

4275 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4276 
tmp
 < 
SCAMPER_DO_TRACELB_TOS_MIN
 ||m°> 
SCAMPER_DO_TRACELB_TOS_MAX
)

4278 
”r
;

4282 
TRACE_OPT_ATTEMPTS
:

4283 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4284 
tmp
 < 
SCAMPER_DO_TRACELB_ATTEMPTS_MIN
 ||

4285 
tmp
 > 
SCAMPER_DO_TRACELB_ATTEMPTS_MAX
)

4287 
”r
;

4291 
TRACE_OPT_PROBECMAX
:

4292 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4293 
tmp
 < 
SCAMPER_DO_TRACELB_PROBECMAX_MIN
 ||

4294 
tmp
 > 
SCAMPER_DO_TRACELB_PROBECMAX_MAX
)

4296 
”r
;

4300 
TRACE_OPT_USERID
:

4301 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||mp < 0)

4303 
”r
;

4307 
TRACE_OPT_WAITPROBE
:

4308 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4309 
tmp
 < 
SCAMPER_DO_TRACELB_WAITPROBE_MIN
 ||

4310 
tmp
 > 
SCAMPER_DO_TRACELB_WAITPROBE_MAX
)

4312 
”r
;

4316 
TRACE_OPT_WAITTIMEOUT
:

4317 if(
	`¡ršg_tŞÚg
(
·¿m
, &
tmp
) != 0 ||

4318 
tmp
 < 
SCAMPER_DO_TRACELB_WAITTIMEOUT_MIN
 ||

4319 
tmp
 > 
SCAMPER_DO_TRACELB_WAITTIMEOUT_MAX
)

4321 
”r
;

4330 if(
out
 !ğ
NULL
)

4331 *
out
 = 
tmp
;

4334 
”r
:

4336 
	}
}

4345 *
	$sÿm³r_do_Œaûlb_®loc
(*
¡r
)

4347 
sÿm³r_İtiÚ_out_t
 *
İts_out
 = 
NULL
, *
İt
;

4348 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
NULL
;

4349 
ušt8_t
 
ty³
 = 
SCAMPER_TRACELB_TYPE_UDP_DPORT
;

4350 
ušt16_t
 
¥Üt
 = 
	`sÿm³r_¥Üt_deçuÉ
();

4351 
ušt8_t
 
cÚfid’û
 = 95;

4352 
ušt16_t
 
dpÜt
 = 
SCAMPER_DO_TRACELB_DPORT_DEF
;

4353 
ušt8_t
 
©‹m±s
 = 
SCAMPER_DO_TRACELB_ATTEMPTS_DEF
;

4354 
ušt8_t
 
fœ¡hİ
 = 
SCAMPER_DO_TRACELB_FIRSTHOP_DEF
;

4355 
ušt8_t
 
wa™_timeout
 = 
SCAMPER_DO_TRACELB_WAITTIMEOUT_DEF
;

4356 
ušt8_t
 
wa™_´obe
 = 
SCAMPER_DO_TRACELB_WAITPROBE_DEF
;

4357 
ušt8_t
 
tos
 = 
SCAMPER_DO_TRACELB_TOS_DEF
;

4358 
ušt32_t
 
´obec_max
 = 
SCAMPER_DO_TRACELB_PROBECMAX_DEF
;

4359 
ušt8_t
 
g­lim™
 = 
SCAMPER_DO_TRACELB_GAPLIMIT_DEF
;

4360 
ušt32_t
 
u£rid
 = 0;

4361 *
addr
;

4362 
tmp
 = 0;

4365 if(
	`sÿm³r_İtiÚs_·r£
(
¡r
, 
İts
, 
İts_út
, &
İts_out
, &
addr
) != 0)

4367 
”r
;

4371 if(
addr
 =ğ
NULL
)

4373 
”r
;

4376 
İt
 = 
İts_out
; o± !ğ
NULL
; o± = o±->
Ãxt
)

4378 if(
İt
->
ty³
 !ğ
SCAMPER_OPTION_TYPE_NULL
 &&

4379 
	`Œaûlb_¬g_·¿m_v®id©e
(
İt
->
id
, o±->
¡r
, &
tmp
) != 0)

4381 
	`sÿm³r_debug
(
__func__
, "v®id©iÚ oàİtid %d faed", 
İt
->
id
);

4382 
”r
;

4385 
İt
->
id
)

4387 
TRACE_OPT_CONFIDENCE
:

4388 
cÚfid’û
 = (
ušt8_t
)
tmp
;

4391 
TRACE_OPT_DPORT
:

4392 
dpÜt
 = (
ušt16_t
)
tmp
;

4395 
TRACE_OPT_FIRSTHOP
:

4396 
fœ¡hİ
 = (
ušt8_t
)
tmp
;

4399 
TRACE_OPT_GAPLIMIT
:

4400 
g­lim™
 = (
ušt8_t
)
tmp
;

4403 
TRACE_OPT_PROTOCOL
:

4404 
ty³
 = (
ušt8_t
)
tmp
;

4407 
TRACE_OPT_TOS
:

4408 
tos
 = (
ušt8_t
)
tmp
;

4411 
TRACE_OPT_ATTEMPTS
:

4412 
©‹m±s
 = (
ušt8_t
)
tmp
;

4415 
TRACE_OPT_PROBECMAX
:

4416 
´obec_max
 = (
ušt32_t
)
tmp
;

4419 
TRACE_OPT_USERID
:

4420 
u£rid
 = (
ušt32_t
)
tmp
;

4423 
TRACE_OPT_WAITPROBE
:

4424 
wa™_´obe
 = (
ušt8_t
)
tmp
;

4427 
TRACE_OPT_WAITTIMEOUT
:

4428 
wa™_timeout
 = (
ušt8_t
)
tmp
;

4433 
	`sÿm³r_İtiÚs_ä“
(
İts_out
); o±s_ouˆğ
NULL
;

4435 if((
Œaû
 = 
	`sÿm³r_Œaûlb_®loc
()è=ğ
NULL
)

4437 
”r
;

4440 if((
Œaû
->
d¡
 = 
	`sÿm³r_addrÿche_»sŞve
(
addrÿche
,
AF_UNSPEC
,
addr
))==
NULL
)

4442 
”r
;

4445 if(
Œaû
->
d¡
->
ty³
 =ğ
SCAMPER_ADDR_TYPE_IPV6
 &&

4446 
	`SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
))

4448 
”r
;

4451 
Œaû
->
¥Üt
 = sport;

4452 
Œaû
->
dpÜt
 = dport;

4453 
Œaû
->
tos
 =os;

4454 
Œaû
->
fœ¡hİ
 = firsthop;

4455 
Œaû
->
wa™_timeout
 = wait_timeout;

4456 
Œaû
->
wa™_´obe
 = wait_probe;

4457 
Œaû
->
©‹m±s
 =‡ttempts;

4458 
Œaû
->
cÚfid’û
 = confidence;

4459 
Œaû
->
ty³
 =ype;

4460 
Œaû
->
´obec_max
 =…robec_max;

4461 
Œaû
->
g­lim™
 = gaplimit;

4462 
Œaû
->
u£rid
 = userid;

4464 
Œaû
->
d¡
->
ty³
)

4466 
SCAMPER_ADDR_TYPE_IPV4
:

4467 if(
	`SCAMPER_TRACELB_TYPE_IS_TCP
(
Œaû
))

4468 
Œaû
->
´obe_size
 = 40;

4470 
Œaû
->
´obe_size
 = 44;

4473 
SCAMPER_ADDR_TYPE_IPV6
:

4474 
Œaû
->
´obe_size
 = 60;

4478 
”r
;

4481  
Œaû
;

4483 
”r
:

4484 if(
Œaû
 !ğ
NULL
è
	`sÿm³r_Œaûlb_ä“
(trace);

4485 if(
İts_out
 !ğ
NULL
è
	`sÿm³r_İtiÚs_ä“
(opts_out);

4486  
NULL
;

4487 
	}
}

4489 
sÿm³r_sk_t
 *
	$sÿm³r_do_Œaûlb_®loùask
(*
d©a
,

4490 
sÿm³r_li¡_t
 *
li¡
,

4491 
sÿm³r_cyşe_t
 *
cyşe
)

4493 
sÿm³r_Œaûlb_t
 *
Œaû
 = (sÿm³r_Œaûlb_ˆ*)
d©a
;

4494 
sÿm³r_sk_sig_t
 *
sig
 = 
NULL
;

4495 
sÿm³r_sk_t
 *
sk
 = 
NULL
;

4498 if((
sk
 = 
	`sÿm³r_sk_®loc
(
Œaû
, &
funcs
)è=ğ
NULL
)

4499 
”r
;

4502 if((
sig
 = 
	`sÿm³r_sk_sig_®loc
(
SCAMPER_TASK_SIG_TYPE_TX_IP
)è=ğ
NULL
)

4503 
”r
;

4504 
sig
->
sig_tx__d¡
 = 
	`sÿm³r_addr_u£
(
Œaû
->
d¡
);

4505 if(
Œaû
->
¤c
 =ğ
NULL
 && (Œaû->¤øğ
	`sÿm³r_g‘¤c
Ñ¿û->
d¡
,0)) == NULL)

4506 
”r
;

4507 
sig
->
sig_tx__¤c
 = 
	`sÿm³r_addr_u£
(
Œaû
->
¤c
);

4508 if(
	`sÿm³r_sk_sig_add
(
sk
, 
sig
) != 0)

4509 
”r
;

4510 
sig
 = 
NULL
;

4513 
Œaû
->
li¡
 = 
	`sÿm³r_li¡_u£
(list);

4514 
Œaû
->
cyşe
 = 
	`sÿm³r_cyşe_u£
(cycle);

4516  
sk
;

4518 
”r
:

4519 if(
sig
 !ğ
NULL
è
	`sÿm³r_sk_sig_ä“
(sig);

4520 if(
sk
 !ğ
NULL
)

4522 
	`sÿm³r_sk_£td©ªuÎ
(
sk
);

4523 
	`sÿm³r_sk_ä“
(
sk
);

4525  
NULL
;

4526 
	}
}

4533 
	$sÿm³r_do_Œaûlb_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
)

4535  
	`sÿm³r_İtiÚs_v®id©e
(
İts
, 
İts_út
, 
¬gc
, 
¬gv
, 
¡İ
,

4536 
Œaûlb_¬g_·¿m_v®id©e
);

4537 
	}
}

4539 
	$sÿm³r_do_Œaûlb_ä“
(*
d©a
)

4541 
	`sÿm³r_Œaûlb_ä“
((
sÿm³r_Œaûlb_t
 *)
d©a
);

4543 
	}
}

4545 
	$sÿm³r_do_Œaûlb_ş—nup
()

4547 if(
pktbuf
 !ğ
NULL
)

4549 
	`ä“
(
pktbuf
);

4550 
pktbuf
 = 
NULL
;

4554 
	}
}

4556 
	$sÿm³r_do_Œaûlb_š™
()

4558 
funcs
.
´obe
 = 
do_Œaûlb_´obe
;

4559 
funcs
.
hªdË_icmp
 = 
do_Œaûlb_hªdË_icmp
;

4560 
funcs
.
hªdË_dl
 = 
do_Œaûlb_hªdË_dl
;

4561 
funcs
.
hªdË_timeout
 = 
do_Œaûlb_hªdË_timeout
;

4562 
funcs
.
wr™e
 = 
do_Œaûlb_wr™e
;

4563 
funcs
.
sk_ä“
 = 
do_Œaûlb_ä“
;

4564 
funcs
.
h®t
 = 
do_Œaûlb_h®t
;

4567 
	}
}

	@tracelb/scamper_tracelb_do.h

28 #iâdeà
__SCAMPER_DO_TRACELB_H


29 
	#__SCAMPER_DO_TRACELB_H


	)

31 *
sÿm³r_do_Œaûlb_®loc
(*
¡r
);

33 
sÿm³r_sk_t
 *
sÿm³r_do_Œaûlb_®loùask
(*
d©a
,

34 
sÿm³r_li¡_t
 *
li¡
,

35 
sÿm³r_cyşe_t
 *
cyşe
);

37 
sÿm³r_do_Œaûlb_¬g_v®id©e
(
¬gc
, *
¬gv
[], *
¡İ
);

39 
sÿm³r_do_Œaûlb_ä“
(*);

41 cÚ¡ *
sÿm³r_do_Œaûlb_u§ge
();

43 
sÿm³r_do_Œaûlb_ş—nup
();

44 
sÿm³r_do_Œaûlb_š™
();

	@tracelb/scamper_tracelb_text.c

25 #iâdeà
lšt


26 cÚ¡ 
	grcsid
[] =

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

33 
	~"š‹º®.h
"

35 
	~"sÿm³r_addr.h
"

36 
	~"sÿm³r_li¡.h
"

37 
	~"sÿm³r_Œaûlb.h
"

38 
	~"sÿm³r_fe.h
"

39 
	~"sÿm³r_Œaûlb_‹xt.h
"

40 
	~"uts.h
"

42 
	s´obe£t_summ¬y


44 
sÿm³r_addr_t
 **
	maddrs
;

45 
	maddrc
;

46 
	mnuÎc
;

47 } 
	t´obe£t_summ¬y_t
;

49 
´obe£t_summ¬y_t
 *
	$´obe£t_summ¬y
(
sÿm³r_Œaûlb_´obe£t_t
 *
£t
)

51 
sÿm³r_Œaûlb_´obe_t
 *
´obe
;

52 
sÿm³r_addr_t
 *
addr
;

53 
´obe£t_summ¬y_t
 *
sum
;

54 
ušt16_t
 
æowid
, 
j
;

55 
i
, 
x
;

57 if((
sum
 = 
	`m®loc_z”o
((
´obe£t_summ¬y_t
))è=ğ
NULL
)

59  
NULL
;

62 if(
£t
->
´obec
 == 0)

63  
sum
;

65 
æowid
 = 
£t
->
´obes
[0]->flowid;

66 
x
 = 0;

67 
i
=0; i<=
£t
->
´obec
; i++)

69 if(
i
 =ğ
£t
->
´obec
)

71 if(
x
 == 0)

72 
sum
->
nuÎc
++;

76 
´obe
 = 
£t
->
´obes
[
i
];

77 if(
´obe
->
æowid
 != flowid)

83 if(
x
 == 0)

84 
sum
->
nuÎc
++;

86 
æowid
 = 
´obe
->flowid;

87 
x
 = 0;

90 if(
´obe
->
rxc
 > 0)

92 
j
=0; j<
´obe
->
rxc
; j++)

94 
addr
 = 
´obe
->
rxs
[
j
]->
»¶y_äom
;

95 if(
	`¬¿y_fšd
((**)
sum
->
addrs
, sum->
addrc
, 
addr
,

96 (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
è!ğ
NULL
)

99 
	`¬¿y_š£¹
((***)&
sum
->
addrs
, &sum->
addrc
,

100 
addr
, (
¬¿y_cmp_t
)
sÿm³r_addr_cmp
);

102 
x
++;

106  
sum
;

107 
	}
}

109 
	$´obe£t_summ¬y_to¡r
(
´obe£t_summ¬y_t
 *
sum
,

110 *
buf
, 
size_t
 
Ën
, size_ˆ*
off
)

112 
d¡
[64];

113 
k
;

115 if(
sum
->
nuÎc
 > 0 && sum->
addrc
 == 0)

117 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, 
off
, "*");

121 
	`sÿm³r_addr_to¡r
(
sum
->
addrs
[0], 
d¡
, (dst));

122 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, 
off
, "(%s", 
d¡
);

123 
k
=1; k<
sum
->
addrc
; k++)

125 
	`sÿm³r_addr_to¡r
(
sum
->
addrs
[
k
], 
d¡
, (dst));

126 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, 
off
, ", %s", 
d¡
);

128 if(
sum
->
nuÎc
 > 0)

129 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, 
off
, ", *)");

131 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, 
off
, ")");

134 
	}
}

136 
	$sÿm³r_fe_‹xt_Œaûlb_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

137 cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
)

139 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
;

140 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

141 
´obe£t_summ¬y_t
 *
sum
;

142 
size_t
 
Ën
;

143 
size_t
 
off
;

144 
buf
[1024], 
¤c
[64], 
d¡
[64];

145 
fd
 = 
	`sÿm³r_fe_g‘fd
(
sf
);

146 
i
, 
j
;

148 
	`¢´štf
(
buf
, (buf),

150 
	`sÿm³r_addr_to¡r
(
Œaû
->
¤c
, src, (src)),

151 
	`sÿm³r_addr_to¡r
(
Œaû
->
d¡
, dst, (dst)),

152 
Œaû
->
nodec
,¿û->
lškc
,¿û->
´obec
,¿û->
cÚfid’û
);

154 
Ën
 = 
	`¡¾’
(
buf
);

155 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
);

157 
i
=0; i<
Œaû
->
nodec
; i++)

159 
node
 = 
Œaû
->
nodes
[
i
];

161 if(
node
->
addr
 !ğ
NULL
)

162 
	`sÿm³r_addr_to¡r
(
node
->
addr
, 
¤c
, (src));

164 
	`¢´štf
(
¤c
, (src), "*");

166 if(
node
->
lškc
 > 1)

168 
j
=0; j<
node
->
lškc
; j++)

170 
	`sÿm³r_addr_to¡r
(
node
->
lšks
[
j
]->
to
->
addr
, 
d¡
, (dst));

171 
	`¢´štf
(
buf
, (buf), "% -> %s\n", 
¤c
, 
d¡
);

172 
Ën
 = 
	`¡¾’
(
buf
);

173 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
Ën
);

176 if(
node
->
lškc
 == 1)

178 
lšk
 = 
node
->
lšks
[0];

179 
Ën
 = (
buf
);

180 
off
 = 0;

182 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "% -> ", 
¤c
);

183 
j
=0; j<
lšk
->
hİc
-1; j++)

185 
sum
 = 
	`´obe£t_summ¬y
(
lšk
->
£ts
[
j
]);

186 
	`´obe£t_summ¬y_to¡r
(
sum
, 
buf
, 
Ën
, &
off
);

187 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, " -> ");

188 if(
sum
->
addrs
 !ğ
NULL
è
	`ä“
(sum->addrs);

189 
	`ä“
(
sum
);

192 if(
lšk
->
to
 !ğ
NULL
)

194 
	`sÿm³r_addr_to¡r
(
lšk
->
to
->
addr
, 
d¡
, (dst));

195 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "%s", 
d¡
);

199 
sum
 = 
	`´obe£t_summ¬y
(
lšk
->
£ts
[lšk->
hİc
-1]);

200 
	`´obe£t_summ¬y_to¡r
(
sum
, 
buf
, 
Ën
, &
off
);

201 if(
sum
->
addrs
 !ğ
NULL
è
	`ä“
(sum->addrs);

202 
	`ä“
(
sum
);

205 
	`¡ršg_cÚÿt
(
buf
, 
Ën
, &
off
, "\n");

206 
	`wr™e_w¿p
(
fd
, 
buf
, 
NULL
, 
off
);

211 
	}
}

	@tracelb/scamper_tracelb_text.h

24 #iâdeà
__SCAMPER_TRACELB_TEXT_H


25 
	#__SCAMPER_TRACELB_TEXT_H


	)

27 
sÿm³r_fe_‹xt_Œaûlb_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

28 cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
);

	@tracelb/scamper_tracelb_warts.c

24 #iâdeà
lšt


25 cÚ¡ 
	grcsid
[] =

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

32 
	~"š‹º®.h
"

34 
	~"sÿm³r_addr.h
"

35 
	~"sÿm³r_li¡.h
"

36 
	~"sÿm³r_icm³xt.h
"

37 
	~"sÿm³r_Œaûlb.h
"

38 
	~"sÿm³r_fe.h
"

39 
	~"sÿm³r_fe_w¬ts.h
"

40 
	~"sÿm³r_Œaûlb_w¬ts.h
"

41 
	~"mjl_¥ÏyŒ“.h
"

42 
	~"uts.h
"

47 
	#WARTS_TRACELB_LIST_ID
 1

	)

48 
	#WARTS_TRACELB_CYCLE_ID
 2

	)

49 
	#WARTS_TRACELB_ADDR_SRC_GID
 3

	)

50 
	#WARTS_TRACELB_ADDR_DST_GID
 4

	)

51 
	#WARTS_TRACELB_START
 5

	)

52 
	#WARTS_TRACELB_SPORT
 6

	)

53 
	#WARTS_TRACELB_DPORT
 7

	)

54 
	#WARTS_TRACELB_PROBE_SIZE
 8

	)

55 
	#WARTS_TRACELB_TYPE
 9

	)

56 
	#WARTS_TRACELB_FIRSTHOP
 10

	)

57 
	#WARTS_TRACELB_WAIT_TIMEOUT
 11

	)

58 
	#WARTS_TRACELB_WAIT_PROBE
 12

	)

59 
	#WARTS_TRACELB_ATTEMPTS
 13

	)

60 
	#WARTS_TRACELB_CONFIDENCE
 14

	)

61 
	#WARTS_TRACELB_TOS
 15

	)

62 
	#WARTS_TRACELB_NODEC
 16

	)

63 
	#WARTS_TRACELB_LINKC
 17

	)

64 
	#WARTS_TRACELB_PROBEC
 18

	)

65 
	#WARTS_TRACELB_PROBECMAX
 19

	)

66 
	#WARTS_TRACELB_GAPLIMIT
 20

	)

67 
	#WARTS_TRACELB_ADDR_SRC
 21

	)

68 
	#WARTS_TRACELB_ADDR_DST
 22

	)

69 
	#WARTS_TRACELB_USERID
 23

	)

71 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_v¬s
[] =

73 {
WARTS_TRACELB_LIST_ID
, 4, -1},

74 {
WARTS_TRACELB_CYCLE_ID
, 4, -1},

75 {
WARTS_TRACELB_ADDR_SRC_GID
, 4, -1},

76 {
WARTS_TRACELB_ADDR_DST_GID
, 4, -1},

77 {
WARTS_TRACELB_START
, 8, -1},

78 {
WARTS_TRACELB_SPORT
, 2, -1},

79 {
WARTS_TRACELB_DPORT
, 2, -1},

80 {
WARTS_TRACELB_PROBE_SIZE
, 2, -1},

81 {
WARTS_TRACELB_TYPE
, 1, -1},

82 {
WARTS_TRACELB_FIRSTHOP
, 1, -1},

83 {
WARTS_TRACELB_WAIT_TIMEOUT
, 1, -1},

84 {
WARTS_TRACELB_WAIT_PROBE
, 1, -1},

85 {
WARTS_TRACELB_ATTEMPTS
, 1, -1},

86 {
WARTS_TRACELB_CONFIDENCE
, 1, -1},

87 {
WARTS_TRACELB_TOS
, 1, -1},

88 {
WARTS_TRACELB_NODEC
, 2, -1},

89 {
WARTS_TRACELB_LINKC
, 2, -1},

90 {
WARTS_TRACELB_PROBEC
, 4, -1},

91 {
WARTS_TRACELB_PROBECMAX
, 4, -1},

92 {
WARTS_TRACELB_GAPLIMIT
, 1, -1},

93 {
WARTS_TRACELB_ADDR_SRC
, -1, -1},

94 {
WARTS_TRACELB_ADDR_DST
, -1, -1},

95 {
WARTS_TRACELB_USERID
, 4, -1},

97 
	#Œaûlb_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_v¬s
)

	)

99 
	#WARTS_TRACELB_NODE_ADDR_GID
 1

	)

100 
	#WARTS_TRACELB_NODE_FLAGS
 2

	)

101 
	#WARTS_TRACELB_NODE_LINKC
 3

	)

102 
	#WARTS_TRACELB_NODE_QTTL
 4

	)

103 
	#WARTS_TRACELB_NODE_ADDR
 5

	)

105 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_node_v¬s
[] =

107 {
WARTS_TRACELB_NODE_ADDR_GID
, 4, -1},

108 {
WARTS_TRACELB_NODE_FLAGS
, 1, -1},

109 {
WARTS_TRACELB_NODE_LINKC
, 2, -1},

110 {
WARTS_TRACELB_NODE_QTTL
, 1, -1},

111 {
WARTS_TRACELB_NODE_ADDR
, -1, -1},

113 
	#Œaûlb_node_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_node_v¬s
)

	)

115 
	#WARTS_TRACELB_LINK_FROM
 1

	)

116 
	#WARTS_TRACELB_LINK_TO
 2

	)

117 
	#WARTS_TRACELB_LINK_HOPC
 3

	)

119 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_lšk_v¬s
[] =

121 {
WARTS_TRACELB_LINK_FROM
, 2, -1},

122 {
WARTS_TRACELB_LINK_TO
, 2, -1},

123 {
WARTS_TRACELB_LINK_HOPC
, 1, -1},

125 
	#Œaûlb_lšk_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_lšk_v¬s
)

	)

127 
	#WARTS_TRACELB_PROBE_TX
 1

	)

128 
	#WARTS_TRACELB_PROBE_FLOWID
 2

	)

129 
	#WARTS_TRACELB_PROBE_TTL
 3

	)

130 
	#WARTS_TRACELB_PROBE_ATTEMPT
 4

	)

131 
	#WARTS_TRACELB_PROBE_RXC
 5

	)

133 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_´obe_v¬s
[] =

135 {
WARTS_TRACELB_PROBE_TX
, 8, -1},

136 {
WARTS_TRACELB_PROBE_FLOWID
, 2, -1},

137 {
WARTS_TRACELB_PROBE_TTL
, 1, -1},

138 {
WARTS_TRACELB_PROBE_ATTEMPT
, 1, -1},

139 {
WARTS_TRACELB_PROBE_RXC
, 2, -1},

141 
	#Œaûlb_´obe_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_´obe_v¬s
)

	)

143 
	#WARTS_TRACELB_REPLY_RX
 1

	)

144 
	#WARTS_TRACELB_REPLY_IPID
 2

	)

145 
	#WARTS_TRACELB_REPLY_TTL
 3

	)

146 
	#WARTS_TRACELB_REPLY_FLAGS
 4

	)

147 
	#WARTS_TRACELB_REPLY_ICMP_TC
 5

	)

148 
	#WARTS_TRACELB_REPLY_TCP_FLAGS
 6

	)

149 
	#WARTS_TRACELB_REPLY_ICMP_EXT
 7

	)

150 
	#WARTS_TRACELB_REPLY_ICMP_Q_TTL
 8

	)

151 
	#WARTS_TRACELB_REPLY_ICMP_Q_TOS
 9

	)

152 
	#WARTS_TRACELB_REPLY_FROM_GID
 10

	)

153 
	#WARTS_TRACELB_REPLY_FROM
 11

	)

155 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_»¶y_v¬s
[] =

157 {
WARTS_TRACELB_REPLY_RX
, 8, -1},

158 {
WARTS_TRACELB_REPLY_IPID
, 2, -1},

159 {
WARTS_TRACELB_REPLY_TTL
, 1, -1},

160 {
WARTS_TRACELB_REPLY_FLAGS
, 1, -1},

161 {
WARTS_TRACELB_REPLY_ICMP_TC
, 2, -1},

162 {
WARTS_TRACELB_REPLY_TCP_FLAGS
, 1, -1},

163 {
WARTS_TRACELB_REPLY_ICMP_EXT
, -1, -1},

164 {
WARTS_TRACELB_REPLY_ICMP_Q_TTL
, 1, -1},

165 {
WARTS_TRACELB_REPLY_ICMP_Q_TOS
, 1, -1},

166 {
WARTS_TRACELB_REPLY_FROM_GID
, 4, -1},

167 {
WARTS_TRACELB_REPLY_FROM
, -1, -1},

169 
	#Œaûlb_»¶y_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_»¶y_v¬s
)

	)

171 
	#WARTS_TRACELB_PROBESET_PROBEC
 1

	)

173 cÚ¡ 
w¬ts_v¬_t
 
	gŒaûlb_´obe£t_v¬s
[] =

175 {
WARTS_TRACELB_PROBESET_PROBEC
, 2, -1},

177 
	#Œaûlb_´obe£t_v¬s_mfb
 
	`WARTS_VAR_MFB
(
Œaûlb_´obe£t_v¬s
)

	)

180 
	sw¬ts_Œaûlb_node


182 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaûlb_node_v¬s
)];

183 
ušt16_t
 
	mæags_Ën
;

184 
ušt16_t
 
	m·¿ms_Ën
;

185 } 
	tw¬ts_Œaûlb_node_t
;

187 
	sw¬ts_Œaûlb_»¶y


189 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaûlb_»¶y_v¬s
)];

190 
ušt16_t
 
	mæags_Ën
;

191 
ušt16_t
 
	m·¿ms_Ën
;

192 } 
	tw¬ts_Œaûlb_»¶y_t
;

194 
	sw¬ts_Œaûlb_´obe


196 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaûlb_´obe_v¬s
)];

197 
ušt16_t
 
	mæags_Ën
;

198 
ušt16_t
 
	m·¿ms_Ën
;

199 
w¬ts_Œaûlb_»¶y_t
 *
	m»¶›s
;

200 } 
	tw¬ts_Œaûlb_´obe_t
;

202 
	sw¬ts_Œaûlb_´obe£t


204 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaûlb_´obe£t_v¬s
)];

205 
ušt16_t
 
	mæags_Ën
;

206 
ušt16_t
 
	m·¿ms_Ën
;

207 
w¬ts_Œaûlb_´obe_t
 *
	m´obes
;

208 
ušt16_t
 
	m´obec
;

209 } 
	tw¬ts_Œaûlb_´obe£t_t
;

211 
	sw¬ts_Œaûlb_lšk


213 
ušt16_t
 
	mäom
;

214 
ušt16_t
 
	mto
;

215 
ušt8_t
 
	mæags
[
WARTS_VAR_MFB
(
Œaûlb_lšk_v¬s
)];

216 
ušt16_t
 
	mæags_Ën
;

217 
ušt16_t
 
	m·¿ms_Ën
;

218 
w¬ts_Œaûlb_´obe£t_t
 *
	m£ts
;

219 
ušt8_t
 
	mhİc
;

220 } 
	tw¬ts_Œaûlb_lšk_t
;

223 
	$w¬ts_Œaûlb_·¿ms
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

224 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
æags
,

225 
ušt16_t
 *
æags_Ën
, ušt16_ˆ*
·¿ms_Ën
)

227 
i
, 
max_id
 = 0;

228 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

231 
	`mem£t
(
æags
, 0, 
Œaûlb_v¬s_mfb
);

232 *
·¿ms_Ën
 = 0;

235 
i
=0; i<(
Œaûlb_v¬s
)/(
w¬ts_v¬_t
); i++)

237 
v¬
 = &
Œaûlb_v¬s
[
i
];

239 if(
v¬
->
id
 =ğ
WARTS_TRACELB_ADDR_SRC_GID
 ||

240 
v¬
->
id
 =ğ
WARTS_TRACELB_ADDR_DST_GID
)

245 if(
v¬
->
id
 =ğ
WARTS_TRACELB_USERID
)

247 if(
Œaû
->
u£rid
 == 0)

251 
	`æag_£t
(
æags
, 
v¬
->
id
, &
max_id
);

253 if(
v¬
->
id
 =ğ
WARTS_TRACELB_ADDR_SRC
)

255 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaû
->
¤c
);

258 if(
v¬
->
id
 =ğ
WARTS_TRACELB_ADDR_DST
)

260 *
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
Œaû
->
d¡
);

264 
	`as£¹
(
v¬
->
size
 >= 0);

265 *
·¿ms_Ën
 +ğ
v¬
->
size
;

268 *
æags_Ën
 = 
	`fŞd_æags
(
æags
, 
max_id
);

270 
	}
}

272 
	$w¬ts_Œaûlb_·¿ms_»ad
(
sÿm³r_Œaûlb_t
 *
Œaû
,

273 
w¬ts_¡©e_t
 *
¡©e
,

274 
w¬ts_add¹abË_t
 *
bË
, 
ušt8_t
 *
buf
,

275 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

277 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

278 {&
Œaû
->
li¡
, (
w´_t
)
exŒaù_li¡
, 
¡©e
},

279 {&
Œaû
->
cyşe
, (
w´_t
)
exŒaù_cyşe
, 
¡©e
},

280 {&
Œaû
->
¤c
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

281 {&
Œaû
->
d¡
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

282 {&
Œaû
->
¡¬t
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

283 {&
Œaû
->
¥Üt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

284 {&
Œaû
->
dpÜt
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

285 {&
Œaû
->
´obe_size
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

286 {&
Œaû
->
ty³
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

287 {&
Œaû
->
fœ¡hİ
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

288 {&
Œaû
->
wa™_timeout
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

289 {&
Œaû
->
wa™_´obe
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

290 {&
Œaû
->
©‹m±s
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

291 {&
Œaû
->
cÚfid’û
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

292 {&
Œaû
->
tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

293 {&
Œaû
->
nodec
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

294 {&
Œaû
->
lškc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

295 {&
Œaû
->
´obec
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

296 {&
Œaû
->
´obec_max
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

297 {&
Œaû
->
g­lim™
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

298 {&
Œaû
->
¤c
, (
w´_t
)
exŒaù_addr
, 
bË
},

299 {&
Œaû
->
d¡
, (
w´_t
)
exŒaù_addr
, 
bË
},

300 {&
Œaû
->
u£rid
, (
w´_t
)
exŒaù_ušt32
, 
NULL
},

302 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

303  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

304 
	}
}

306 
	$w¬ts_Œaûlb_·¿ms_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

307 cÚ¡ 
sÿm³r_fe_t
 *
sf
,

308 
w¬ts_add¹abË_t
 *
bË
,

309 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

310 cÚ¡ 
ušt32_t
 
Ën
,

311 cÚ¡ 
ušt8_t
 *
æags
,

312 cÚ¡ 
ušt16_t
 
æags_Ën
,

313 cÚ¡ 
ušt16_t
 
·¿ms_Ën
)

315 
ušt32_t
 
li¡_id
, 
cyşe_id
;

316 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

317 {&
li¡_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

318 {&
cyşe_id
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

319 {
NULL
, NULL, NULL},

320 {
NULL
, NULL, NULL},

321 {&
Œaû
->
¡¬t
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

322 {&
Œaû
->
¥Üt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

323 {&
Œaû
->
dpÜt
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

324 {&
Œaû
->
´obe_size
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

325 {&
Œaû
->
ty³
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

326 {&
Œaû
->
fœ¡hİ
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

327 {&
Œaû
->
wa™_timeout
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

328 {&
Œaû
->
wa™_´obe
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

329 {&
Œaû
->
©‹m±s
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

330 {&
Œaû
->
cÚfid’û
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

331 {&
Œaû
->
tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

332 {&
Œaû
->
nodec
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

333 {&
Œaû
->
lškc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

334 {&
Œaû
->
´obec
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

335 {&
Œaû
->
´obec_max
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

336 {&
Œaû
->
g­lim™
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

337 {
Œaû
->
¤c
, (
wpw_t
)
š£¹_addr
, 
bË
},

338 {
Œaû
->
d¡
, (
wpw_t
)
š£¹_addr
, 
bË
},

339 {&
Œaû
->
u£rid
, (
wpw_t
)
š£¹_ušt32
, 
NULL
},

341 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

343 if(
	`w¬ts_li¡_g‘id
(
sf
, 
Œaû
->
li¡
, &
li¡_id
) == -1)  -1;

344 if(
	`w¬ts_cyşe_g‘id
(
sf
, 
Œaû
->
cyşe
, &
cyşe_id
) == -1)  -1;

346 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
æags
, 
æags_Ën
, 
·¿ms_Ën
, 
hªdËrs
,

347 
hªdËr_út
);

349 
	}
}

351 
	$w¬ts_Œaûlb_node_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

352 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
,

353 
w¬ts_add¹abË_t
 *
bË
,

354 
w¬ts_Œaûlb_node_t
 *
¡©e
, 
ušt32_t
 *
Ën
)

356 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

357 
i
, 
max_id
 = 0;

360 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûlb_node_v¬s_mfb
);

361 
¡©e
->
·¿ms_Ën
 = 0;

364 
i
=0; i<(
Œaûlb_node_v¬s
)/(
w¬ts_v¬_t
); i++)

366 
v¬
 = &
Œaûlb_node_v¬s
[
i
];

368 if(
v¬
->
id
 =ğ
WARTS_TRACELB_NODE_ADDR_GID
)

372 if(
v¬
->
id
 =ğ
WARTS_TRACELB_NODE_QTTL
)

375 if(
	`SCAMPER_TRACELB_NODE_QTTL
(
node
) == 0)

379 if(
v¬
->
id
 =ğ
WARTS_TRACELB_NODE_ADDR
)

381 if(
node
->
addr
 !ğ
NULL
)

383 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

384 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
node
->
addr
);

389 
	`as£¹
(
v¬
->
size
 >= 0);

391 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

392 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

395 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

397 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

398 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

401 
	}
}

403 
	$w¬ts_Œaûlb_node_»ad
(
sÿm³r_Œaûlb_node_t
 *
node
,

404 
w¬ts_¡©e_t
 *
¡©e
,

405 
w¬ts_add¹abË_t
 *
bË
,cÚ¡ 
ušt8_t
 *
buf
,

406 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

408 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

409 {&
node
->
addr
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

410 {&
node
->
æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

411 {&
node
->
lškc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

412 {&
node
->
q_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

413 {&
node
->
addr
, (
w´_t
)
exŒaù_addr
, 
bË
},

415 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

417 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

423 
	}
}

425 
	$w¬ts_Œaûlb_node_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
,

426 cÚ¡ 
w¬ts_Œaûlb_node_t
 *
¡©e
,

427 
w¬ts_add¹abË_t
 *
bË
,

428 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

430 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

431 {
NULL
, NULL, NULL},

432 {&
node
->
æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

433 {&
node
->
lškc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

434 {&
node
->
q_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

435 {
node
->
addr
, (
wpw_t
)
š£¹_addr
, 
bË
},

437 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

438 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

439 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

441 
	}
}

443 
	$exŒaù_Œaûlb_»¶y_icmp_tc
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

444 
ušt32_t
 
Ën
,

445 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

446 *
·¿m
)

448 if(
Ën
 - *
off
 < 2)

452 
»¶y
->
»¶y_icmp_ty³
 = 
buf
[(*
off
)++];

453 
»¶y
->
»¶y_icmp_code
 = 
buf
[(*
off
)++];

455 
	}
}

457 
	$š£¹_Œaûlb_»¶y_icmp_tc
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

458 cÚ¡ 
ušt32_t
 
Ën
,

459 cÚ¡ 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

460 *
·¿m
)

462 
	`as£¹
(
Ën
 - *
off
 >= 2);

463 
buf
[(*
off
)++] = 
»¶y
->
»¶y_icmp_ty³
;

464 
buf
[(*
off
)++] = 
»¶y
->
»¶y_icmp_code
;

466 
	}
}

468 
	$exŒaù_Œaûlb_»¶y_icmp_ext
(cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

469 
ušt32_t
 
Ën
,

470 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

471 *
·¿m
)

473  
	`w¬ts_icm³xt_»ad
(
buf
, 
off
, 
Ën
, &
»¶y
->
»¶y_icmp_ext
);

474 
	}
}

476 
	$š£¹_Œaûlb_»¶y_icmp_ext
(
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

477 cÚ¡ 
ušt32_t
 
Ën
,

478 cÚ¡ 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

479 *
·¿m
)

481 
	`w¬ts_icm³xt_wr™e
(
buf
, 
off
, 
Ën
, 
»¶y
->
»¶y_icmp_ext
);

483 
	}
}

485 
	$w¬ts_Œaûlb_»¶y_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

486 cÚ¡ 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

487 
w¬ts_Œaûlb_»¶y_t
 *
¡©e
,

488 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

490 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

491 
sÿm³r_icm³xt_t
 *
›
;

492 
i
, 
max_id
 = 0;

495 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûlb_»¶y_v¬s_mfb
);

496 
¡©e
->
·¿ms_Ën
 = 0;

499 
i
=0; i<(
Œaûlb_»¶y_v¬s
)/(
w¬ts_v¬_t
); i++)

501 
v¬
 = &
Œaûlb_»¶y_v¬s
[
i
];

503 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_FROM_GID
)

507 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_TTL
)

509 if((
»¶y
->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_REPLY_TTL
) == 0)

512 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_ICMP_TC
 ||

513 
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_ICMP_Q_TTL
 ||

514 
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_ICMP_Q_TOS
)

516 if((
»¶y
->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) != 0)

519 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_TCP_FLAGS
)

521 if((
»¶y
->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) == 0)

524 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_ICMP_EXT
)

526 if((
»¶y
->
»¶y_æags
 & 
SCAMPER_TRACELB_REPLY_FLAG_TCP
) != 0 ||

527 
»¶y
->
»¶y_icmp_ext
 =ğ
NULL
)

530 
¡©e
->
·¿ms_Ën
 += 2;

531 
›
 = 
»¶y
->
»¶y_icmp_ext
; i!ğ
NULL
; iğ›->
›_Ãxt
)

533 
¡©e
->
·¿ms_Ën
 +ğ(2 + 1 + 1 + 
›
->
›_dl
);

536 if(
v¬
->
id
 =ğ
WARTS_TRACELB_REPLY_FROM
)

538 
¡©e
->
·¿ms_Ën
 +ğ
	`w¬ts_addr_size
(
bË
, 
»¶y
->
»¶y_äom
);

541 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

543 if(
v¬
->
size
 > 0)

545 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

549 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

551 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

552 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

555 
	}
}

557 
	$w¬ts_Œaûlb_»¶y_»ad
(
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

558 
w¬ts_¡©e_t
 *
¡©e
,

559 
w¬ts_add¹abË_t
 *
bË
,

560 cÚ¡ 
ušt8_t
 *
buf
,

561 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

563 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

564 {&
»¶y
->
»¶y_rx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

565 {&
»¶y
->
»¶y_id
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

566 {&
»¶y
->
»¶y_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

567 {&
»¶y
->
»¶y_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

568 {
»¶y
, (
w´_t
)
exŒaù_Œaûlb_»¶y_icmp_tc
, 
NULL
},

569 {&
»¶y
->
»¶y_tı_æags
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

570 {
»¶y
, (
w´_t
)
exŒaù_Œaûlb_»¶y_icmp_ext
, 
NULL
},

571 {&
»¶y
->
»¶y_icmp_q_‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

572 {&
»¶y
->
»¶y_icmp_q_tos
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

573 {&
»¶y
->
»¶y_äom
, (
w´_t
)
exŒaù_addr_gid
, 
¡©e
},

574 {&
»¶y
->
»¶y_äom
, (
w´_t
)
exŒaù_addr
, 
bË
},

576 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

577  
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
);

578 
	}
}

580 
	$w¬ts_Œaûlb_»¶y_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
,

581 cÚ¡ 
w¬ts_Œaûlb_»¶y_t
 *
¡©e
,

582 
w¬ts_add¹abË_t
 *
bË
,

583 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,ušt32_ˆ
Ën
)

585 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

586 {&
»¶y
->
»¶y_rx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

587 {&
»¶y
->
»¶y_id
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

588 {&
»¶y
->
»¶y_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

589 {&
»¶y
->
»¶y_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

590 {
»¶y
, (
wpw_t
)
š£¹_Œaûlb_»¶y_icmp_tc
, 
NULL
},

591 {&
»¶y
->
»¶y_tı_æags
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

592 {
»¶y
, (
wpw_t
)
š£¹_Œaûlb_»¶y_icmp_ext
, 
NULL
},

593 {&
»¶y
->
»¶y_icmp_q_‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

594 {&
»¶y
->
»¶y_icmp_q_tos
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

595 {
NULL
, NULL, NULL},

596 {
»¶y
->
»¶y_äom
, (
wpw_t
)
š£¹_addr
, 
bË
},

598 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

599 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

600 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

602 
	}
}

604 
	$w¬ts_Œaûlb_´obe_ä“
(
w¬ts_Œaûlb_´obe_t
 *
¡©e
)

606 if(
¡©e
->
»¶›s
 !ğ
NULL
)

608 
	`ä“
(
¡©e
->
»¶›s
);

609 
¡©e
->
»¶›s
 = 
NULL
;

612 
	}
}

614 
	$w¬ts_Œaûlb_´obe_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

615 cÚ¡ 
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

616 
w¬ts_Œaûlb_´obe_t
 *
¡©e
,

617 
w¬ts_add¹abË_t
 *
bË
,

618 
ušt32_t
 *
Ën
)

620 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

621 
i
, 
max_id
 = 0;

622 
size_t
 
size
;

624 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûlb_´obe_v¬s_mfb
);

625 
¡©e
->
·¿ms_Ën
 = 0;

627 
i
=0; i<(
Œaûlb_´obe_v¬s
)/(
w¬ts_v¬_t
); i++)

629 
v¬
 = &
Œaûlb_´obe_v¬s
[
i
];

630 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

631 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

634 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

636 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

637 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

639 if(
´obe
->
rxc
 > 0)

641 
size
 = (
w¬ts_Œaûlb_»¶y_t
è* 
´obe
->
rxc
;

642 if((
¡©e
->
»¶›s
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

647 
i
=0; i<
´obe
->
rxc
; i++)

649 if(
	`w¬ts_Œaûlb_»¶y_¡©e
(
sf
, 
´obe
->
rxs
[
i
], &
¡©e
->
»¶›s
[i],

650 
bË
, 
Ën
) != 0)

656 
	}
}

658 
	$w¬ts_Œaûlb_´obe_»ad
(
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

659 
w¬ts_¡©e_t
 *
¡©e
,

660 
w¬ts_add¹abË_t
 *
bË
,

661 cÚ¡ 
ušt8_t
 *
buf
,

662 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

664 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

665 {&
´obe
->
tx
, (
w´_t
)
exŒaù_timev®
, 
NULL
},

666 {&
´obe
->
æowid
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

667 {&
´obe
->
‰l
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

668 {&
´obe
->
©‹m±
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

669 {&
´obe
->
rxc
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

671 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

672 
sÿm³r_Œaûlb_»¶y_t
 *
»¶y
;

673 
ušt16_t
 
i
;

675 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

678 if(
´obe
->
rxc
 > 0)

680 if(
	`sÿm³r_Œaûlb_´obe_»¶›s_®loc
(
´obe
,…robe->
rxc
) != 0)

683 
i
=0; i<
´obe
->
rxc
; i++)

685 if((
»¶y
 = 
	`sÿm³r_Œaûlb_»¶y_®loc
(
NULL
)) == NULL)

687 
´obe
->
rxs
[
i
] = 
»¶y
;

689 if(
	`w¬ts_Œaûlb_»¶y_»ad
(
»¶y
, 
¡©e
, 
bË
, 
buf
, 
off
, 
Ën
) != 0)

695 
	}
}

697 
	$w¬ts_Œaûlb_´obe_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_´obe_t
 *
´obe
,

698 cÚ¡ 
w¬ts_Œaûlb_´obe_t
 *
¡©e
,

699 
w¬ts_add¹abË_t
 *
bË
,

700 
ušt8_t
 *
buf
,
ušt32_t
 *
off
,ušt32_ˆ
Ën
)

702 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

703 {&
´obe
->
tx
, (
wpw_t
)
š£¹_timev®
, 
NULL
},

704 {&
´obe
->
æowid
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

705 {&
´obe
->
‰l
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

706 {&
´obe
->
©‹m±
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

707 {&
´obe
->
rxc
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

709 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

710 
ušt16_t
 
i
;

712 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

713 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

715 
i
=0; i<
´obe
->
rxc
; i++)

717 
	`w¬ts_Œaûlb_»¶y_wr™e
(
´obe
->
rxs
[
i
], &
¡©e
->
»¶›s
[i], 
bË
,

718 
buf
, 
off
, 
Ën
);

722 
	}
}

724 
	$w¬ts_Œaûlb_´obe£t_ä“
(
w¬ts_Œaûlb_´obe£t_t
 *
¡©e
)

726 
ušt16_t
 
i
;

728 if(
¡©e
->
´obes
 !ğ
NULL
)

730 
i
=0; i<
¡©e
->
´obec
; i++)

731 
	`w¬ts_Œaûlb_´obe_ä“
(&
¡©e
->
´obes
[
i
]);

732 
	`ä“
(
¡©e
->
´obes
);

733 
¡©e
->
´obes
 = 
NULL
;

737 
	}
}

739 
	$w¬ts_Œaûlb_´obe£t_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

740 cÚ¡ 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
,

741 
w¬ts_Œaûlb_´obe£t_t
 *
¡©e
,

742 
w¬ts_add¹abË_t
 *
bË
,

743 
ušt32_t
 *
Ën
)

745 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

746 
i
, 
max_id
 = 0;

747 
size_t
 
size
;

749 
¡©e
->
´obec
 = 
£t
->probec;

751 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûlb_´obe£t_v¬s_mfb
);

752 
¡©e
->
·¿ms_Ën
 = 0;

754 
i
=0; i<(
Œaûlb_´obe£t_v¬s
)/(
w¬ts_v¬_t
); i++)

756 
v¬
 = &
Œaûlb_´obe£t_v¬s
[
i
];

757 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

758 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

761 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

763 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

764 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

766 if(
£t
->
´obec
 > 0)

768 
size
 = (
w¬ts_Œaûlb_´obe_t
è* 
£t
->
´obec
;

769 if((
¡©e
->
´obes
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

774 
i
=0; i<
£t
->
´obec
; i++)

776 if(
	`w¬ts_Œaûlb_´obe_¡©e
(
sf
, 
£t
->
´obes
[
i
], &
¡©e
->probes[i],

777 
bË
, 
Ën
) != 0)

783 
	}
}

785 
	$w¬ts_Œaûlb_´obe£t_»ad
(
sÿm³r_Œaûlb_´obe£t_t
 *
£t
,

786 
w¬ts_¡©e_t
 *
¡©e
,

787 
w¬ts_add¹abË_t
 *
bË
,

788 cÚ¡ 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

789 
ušt32_t
 
Ën
)

791 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

792 {&
£t
->
´obec
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

794 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

795 
ušt16_t
 
i
;

797 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

800 if(
£t
->
´obec
 > 0)

802 if(
	`sÿm³r_Œaûlb_´obe£t_´obes_®loc
(
£t
, s‘->
´obec
) != 0)

805 
i
=0; i<
£t
->
´obec
; i++)

807 if((
£t
->
´obes
[
i
] = 
	`sÿm³r_Œaûlb_´obe_®loc
()è=ğ
NULL
 ||

808 
	`w¬ts_Œaûlb_´obe_»ad
(
£t
->
´obes
[
i
], 
¡©e
, 
bË
,

809 
buf
, 
off
, 
Ën
) != 0)

817 
	}
}

819 
	$w¬ts_Œaûlb_´obe£t_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
,

820 cÚ¡ 
w¬ts_Œaûlb_´obe£t_t
 *
¡©e
,

821 
w¬ts_add¹abË_t
 *
bË
,

822 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
,

823 
ušt32_t
 
Ën
)

825 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

826 {&
£t
->
´obec
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

828 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

829 
ušt16_t
 
i
;

831 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

832 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

834 
i
=0; i<
£t
->
´obec
; i++)

836 
	`w¬ts_Œaûlb_´obe_wr™e
(
£t
->
´obes
[
i
], &
¡©e
->´obes[i], 
bË
,

837 
buf
, 
off
, 
Ën
);

841 
	}
}

843 
	$w¬ts_Œaûlb_lšk_ä“
(
w¬ts_Œaûlb_lšk_t
 *
¡©e
)

845 
ušt8_t
 
i
;

846 if(
¡©e
->
£ts
 !ğ
NULL
)

848 
i
=0; i<
¡©e
->
hİc
; i++)

849 
	`w¬ts_Œaûlb_´obe£t_ä“
(&
¡©e
->
£ts
[
i
]);

850 
	`ä“
(
¡©e
->
£ts
);

851 
¡©e
->
£ts
 = 
NULL
;

854 
	}
}

856 
	$w¬ts_Œaûlb_lšk_¡©e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

857 cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
,

858 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

859 
w¬ts_Œaûlb_lšk_t
 *
¡©e
,

860 
w¬ts_add¹abË_t
 *
bË
, 
ušt32_t
 *
Ën
)

862 cÚ¡ 
w¬ts_v¬_t
 *
v¬
;

863 
size_t
 
size
;

864 
i
, 
j
, 
max_id
 = 0;

865 
ušt8_t
 
s
;

867 
¡©e
->
hİc
 = 
lšk
->hopc;

874 
i
=0, 
j
=0; i<
Œaû
->
nodec
; i++)

876 if(
lšk
->
äom
 =ğ
Œaû
->
nodes
[
i
])

878 
¡©e
->
äom
 = 
i
;

879 
j
++;

881 if(
lšk
->
to
 =ğ
Œaû
->
nodes
[
i
])

883 
¡©e
->
to
 = 
i
;

884 
j
++;

887 if(
j
 =ğ2 || (
lšk
->
to
 =ğ
NULL
 && j == 1))

892 
	`mem£t
(
¡©e
->
æags
, 0, 
Œaûlb_lšk_v¬s_mfb
);

893 
¡©e
->
·¿ms_Ën
 = 0;

895 
i
=0; i<(
Œaûlb_lšk_v¬s
)/(
w¬ts_v¬_t
); i++)

897 
v¬
 = &
Œaûlb_lšk_v¬s
[
i
];

900 if(
v¬
->
id
 =ğ
WARTS_TRACELB_LINK_TO
 && 
lšk
->
to
 =ğ
NULL
)

903 
	`æag_£t
(
¡©e
->
æags
, 
v¬
->
id
, &
max_id
);

904 
¡©e
->
·¿ms_Ën
 +ğ
v¬
->
size
;

907 
¡©e
->
æags_Ën
 = 
	`fŞd_æags
(¡©e->
æags
, 
max_id
);

909 *
Ën
 +ğ
¡©e
->
æags_Ën
 + s‹->
·¿ms_Ën
;

910 if(
¡©e
->
·¿ms_Ën
 !ğ0è*
Ën
 += 2;

912 if(
lšk
->
hİc
 > 0)

914 
size
 = (
w¬ts_Œaûlb_´obe£t_t
è* 
lšk
->
hİc
;

915 if((
¡©e
->
£ts
 = 
	`m®loc_z”o
(
size
)è=ğ
NULL
)

920 
s
=0; s<
lšk
->
hİc
; s++)

922 if(
	`w¬ts_Œaûlb_´obe£t_¡©e
(
sf
, 
lšk
->
£ts
[
s
], &
¡©e
->sets[s],

923 
bË
, 
Ën
) != 0)

929 
	}
}

931 
	$w¬ts_Œaûlb_lšk_»ad
(
sÿm³r_Œaûlb_t
 *
Œaû
,

932 
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

933 
w¬ts_¡©e_t
 *
¡©e
,

934 
w¬ts_add¹abË_t
 *
bË
,

935 cÚ¡ 
ušt8_t
 *
buf
,

936 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

938 
ušt16_t
 
äom
, 
to
;

939 
w¬ts_·¿m_»ad”_t
 
hªdËrs
[] = {

940 {&
äom
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

941 {&
to
, (
w´_t
)
exŒaù_ušt16
, 
NULL
},

942 {&
lšk
->
hİc
, (
w´_t
)
exŒaù_by‹
, 
NULL
},

944 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_»ad”_t
);

945 
sÿm³r_Œaûlb_´obe£t_t
 *
£t
;

946 
ušt8_t
 
i
;

947 
ušt32_t
 
o
 = *
off
;

949 if(
	`w¬ts_·¿ms_»ad
(
buf
, 
off
, 
Ën
, 
hªdËrs
, 
hªdËr_út
) != 0)

953 
lšk
->
äom
 = 
Œaû
->
nodes
[from];

955 if(
	`æag_is£t
(&
buf
[
o
], 
WARTS_TRACELB_LINK_TO
) != 0)

956 
lšk
->
to
 = 
Œaû
->
nodes
[to];

958 
lšk
->
to
 = 
NULL
;

960 if(
lšk
->
hİc
 > 0)

962 if(
	`sÿm³r_Œaûlb_lšk_´obe£ts_®loc
(
lšk
,†šk->
hİc
) != 0)

965 
i
=0; i<
lšk
->
hİc
; i++)

967 if((
£t
 = 
	`sÿm³r_Œaûlb_´obe£t_®loc
()è=ğ
NULL
)

969 
lšk
->
£ts
[
i
] = 
£t
;

971 if(
	`w¬ts_Œaûlb_´obe£t_»ad
(
£t
, 
¡©e
, 
bË
, 
buf
, 
off
, 
Ën
) != 0)

977 
	}
}

979 
	$w¬ts_Œaûlb_lšk_wr™e
(cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
lšk
,

980 cÚ¡ 
w¬ts_Œaûlb_lšk_t
 *
¡©e
,

981 
w¬ts_add¹abË_t
 *
bË
,

982 
ušt8_t
 *
buf
, 
ušt32_t
 *
off
, ušt32_ˆ
Ën
)

984 
w¬ts_·¿m_wr™”_t
 
hªdËrs
[] = {

985 {&
¡©e
->
äom
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

986 {&
¡©e
->
to
, (
wpw_t
)
š£¹_ušt16
, 
NULL
},

987 {&
lšk
->
hİc
, (
wpw_t
)
š£¹_by‹
, 
NULL
},

989 cÚ¡ 
hªdËr_út
 = (
hªdËrs
)/(
w¬ts_·¿m_wr™”_t
);

990 
ušt32_t
 
i
;

992 
	`w¬ts_·¿ms_wr™e
(
buf
, 
off
, 
Ën
, 
¡©e
->
æags
, s‹->
æags_Ën
,

993 
¡©e
->
·¿ms_Ën
, 
hªdËrs
, 
hªdËr_út
);

995 
i
=0; i<
lšk
->
hİc
; i++)

997 
	`w¬ts_Œaûlb_´obe£t_wr™e
(
lšk
->
£ts
[
i
], &
¡©e
->£ts[i], 
bË
,

998 
buf
, 
off
, 
Ën
);

1002 
	}
}

1008 
	$sÿm³r_fe_w¬ts_Œaûlb_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

1009 
sÿm³r_Œaûlb_t
 **
Œaû_out
)

1011 
w¬ts_¡©e_t
 *
¡©e
 = 
	`sÿm³r_fe_g‘¡©e
(
sf
);

1012 
sÿm³r_Œaûlb_t
 *
Œaû
 = 
NULL
;

1013 
ušt8_t
 *
buf
 = 
NULL
;

1014 
ušt32_t
 
i
, 
off
 = 0;

1015 
ušt16_t
 *
Æc
 = 
NULL
, 
j
;

1016 
sÿm³r_Œaûlb_node_t
 *
node
;

1017 
w¬ts_add¹abË_t
 
bË
;

1019 
	`mem£t
(&
bË
, 0, (table));

1021 if(
	`w¬ts_»ad
(
sf
, &
buf
, 
hdr
->
Ën
) != 0)

1023 
”r
;

1025 if(
buf
 =ğ
NULL
)

1027 *
Œaû_out
 = 
NULL
;

1031 if((
Œaû
 = 
	`sÿm³r_Œaûlb_®loc
()è=ğ
NULL
)

1033 
”r
;

1037 if(
	`w¬ts_Œaûlb_·¿ms_»ad
(
Œaû
, 
¡©e
, &
bË
, 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1039 
”r
;

1043 if(
Œaû
->
nodec
 > 0)

1045 if(
	`sÿm³r_Œaûlb_nodes_®loc
(
Œaû
,¿û->
nodec
) != 0)

1047 
”r
;

1049 
i
=0; i<
Œaû
->
nodec
; i++)

1051 if((
Œaû
->
nodes
[
i
] = 
	`sÿm³r_Œaûlb_node_®loc
(
NULL
)) == NULL)

1052 
”r
;

1054 if(
	`w¬ts_Œaûlb_node_»ad
(
Œaû
->
nodes
[
i
], 
¡©e
, &
bË
,

1055 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1056 
”r
;

1061 if(
Œaû
->
lškc
 > 0)

1063 if(
	`sÿm³r_Œaûlb_lšks_®loc
(
Œaû
,¿û->
lškc
) != 0)

1065 
”r
;

1067 
i
=0; i<
Œaû
->
lškc
; i++)

1069 if((
Œaû
->
lšks
[
i
] = 
	`sÿm³r_Œaûlb_lšk_®loc
()è=ğ
NULL
)

1070 
”r
;

1072 if(
	`w¬ts_Œaûlb_lšk_»ad
(
Œaû
,¿û->
lšks
[
i
], 
¡©e
, &
bË
,

1073 
buf
, &
off
, 
hdr
->
Ën
) != 0)

1074 
”r
;

1079 
	`ä“
(
buf
); buàğ
NULL
;

1084 if(
Œaû
->
nodec
 > 0)

1086 if((
Æc
 = 
	`m®loc_z”o
((
ušt16_t
è* 
Œaû
->
nodec
)è=ğ
NULL
)

1088 
”r
;

1090 
i
=0; i<
Œaû
->
lškc
; i++)

1092 
j
=0; j<
Œaû
->
nodec
; j++)

1094 if(
Œaû
->
lšks
[
i
]->
äom
 =ğŒaû->
nodes
[
j
])

1098 if(
j
 =ğ
Œaû
->
nodec
)

1099 
”r
;

1101 
node
 = 
Œaû
->
nodes
[
j
];

1103 if(
node
->
lšks
 =ğ
NULL
 &&

1104 
	`sÿm³r_Œaûlb_node_lšks_®loc
(
node
,‚ode->
lškc
) != 0)

1105 
”r
;

1107 if(
Æc
[
j
] =ğ
node
->
lškc
)

1108 
”r
;

1110 
node
->
lšks
[
Æc
[
j
]++] = 
Œaû
->lšks[
i
];

1113 
i
=0; i<
Œaû
->
nodec
; i++)

1115 if(
Æc
[
i
] !ğ
Œaû
->
nodes
[i]->
lškc
)

1116 
”r
;

1119 
	`ä“
(
Æc
);‚løğ
NULL
;

1122 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1123 *
Œaû_out
 = 
Œaû
;

1126 
”r
:

1127 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1128 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1129 if(
Æc
 !ğ
NULL
è
	`ä“
(nlc);

1130 if(
Œaû
 !ğ
NULL
è
	`sÿm³r_Œaûlb_ä“
(trace);

1132 
	}
}

1134 
	$sÿm³r_fe_w¬ts_Œaûlb_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

1135 cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
)

1137 cÚ¡ 
sÿm³r_Œaûlb_node_t
 *
node
;

1138 cÚ¡ 
sÿm³r_Œaûlb_lšk_t
 *
lšk
;

1139 
ušt8_t
 *
buf
 = 
NULL
;

1140 
ušt32_t
 
off
 = 0, 
Ën
, 
Ën2
;

1141 
ušt8_t
 
Œaû_æags
[
Œaûlb_v¬s_mfb
];

1142 
ušt16_t
 
Œaû_æags_Ën
, 
Œaû_·¿ms_Ën
;

1143 
w¬ts_Œaûlb_node_t
 *
node_¡©e
 = 
NULL
;

1144 
w¬ts_Œaûlb_lšk_t
 *
lšk_¡©e
 = 
NULL
;

1145 
size_t
 
size
;

1146 
i
;

1147 
w¬ts_add¹abË_t
 
bË
;

1150 
	`mem£t
(&
bË
, 0, (table));

1153 
	`w¬ts_Œaûlb_·¿ms
(
Œaû
, &
bË
, 
Œaû_æags
, &
Œaû_æags_Ën
,

1154 &
Œaû_·¿ms_Ën
);

1157 
Ën
 = 8 + 
Œaû_æags_Ën
 + 
Œaû_·¿ms_Ën
;

1158 if(
Œaû_·¿ms_Ën
 !ğ0è
Ën
 += 2;

1161 if(
Œaû
->
nodec
 > 0)

1163 
size
 = 
Œaû
->
nodec
 * (
w¬ts_Œaûlb_node_t
);

1164 if((
node_¡©e
 = (
w¬ts_Œaûlb_node_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1166 
”r
;

1169 
i
=0; i<
Œaû
->
nodec
; i++)

1171 
Ën2
 = 
Ën
;

1172 
node
 = 
Œaû
->
nodes
[
i
];

1173 if(
	`w¬ts_Œaûlb_node_¡©e
(
sf
, 
node
, &
bË
, &
node_¡©e
[
i
],

1174 &
Ën2
) != 0)

1176 
”r
;

1180 if(
Ën2
 < 
Ën
)

1181 
”r
;

1182 
Ën
 = 
Ën2
;

1187 if(
Œaû
->
lškc
 > 0)

1189 
size
 = 
Œaû
->
lškc
 * (
w¬ts_Œaûlb_lšk_t
);

1190 if((
lšk_¡©e
 = (
w¬ts_Œaûlb_lšk_t
 *)
	`m®loc_z”o
(
size
)è=ğ
NULL
)

1192 
”r
;

1195 
i
=0; i<
Œaû
->
lškc
; i++)

1197 
Ën2
 = 
Ën
;

1198 
lšk
 = 
Œaû
->
lšks
[
i
];

1199 if(
	`w¬ts_Œaûlb_lšk_¡©e
(
sf
, 
Œaû
, 
lšk
, &
lšk_¡©e
[
i
],

1200 &
bË
, &
Ën2
) != 0)

1202 
”r
;

1206 if(
Ën2
 < 
Ën
)

1207 
”r
;

1208 
Ën
 = 
Ën2
;

1212 if((
buf
 = 
	`m®loc
(
Ën
)è=ğ
NULL
)

1214 
”r
;

1217 
	`š£¹_w¬tshdr
(
buf
, &
off
, 
Ën
, 
SCAMPER_FILE_OBJ_TRACELB
);

1220 if(
	`w¬ts_Œaûlb_·¿ms_wr™e
(
Œaû
, 
sf
, &
bË
, 
buf
, &
off
, 
Ën
, 
Œaû_æags
,

1221 
Œaû_æags_Ën
, 
Œaû_·¿ms_Ën
) != 0)

1223 
”r
;

1227 
i
=0; i<
Œaû
->
nodec
; i++)

1229 
	`w¬ts_Œaûlb_node_wr™e
(
Œaû
->
nodes
[
i
], &
node_¡©e
[i], &
bË
,

1230 
buf
, &
off
, 
Ën
);

1232 if(
node_¡©e
 !ğ
NULL
)

1234 
	`ä“
(
node_¡©e
);

1235 
node_¡©e
 = 
NULL
;

1239 
i
=0; i<
Œaû
->
lškc
; i++)

1241 
lšk
 = 
Œaû
->
lšks
[
i
];

1242 
	`w¬ts_Œaûlb_lšk_wr™e
(
lšk
, &
lšk_¡©e
[
i
], &
bË
, 
buf
, &
off
, 
Ën
);

1243 
	`w¬ts_Œaûlb_lšk_ä“
(&
lšk_¡©e
[
i
]);

1245 if(
lšk_¡©e
 !ğ
NULL
)

1247 
	`ä“
(
lšk_¡©e
);

1248 
lšk_¡©e
 = 
NULL
;

1251 
	`as£¹
(
off
 =ğ
Ën
);

1253 if(
	`w¬ts_wr™e
(
sf
, 
buf
, 
off
) == -1)

1255 
”r
;

1258 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1259 
	`ä“
(
buf
);

1262 
”r
:

1263 
	`w¬ts_add¹abË_ş—n
(&
bË
);

1264 if(
node_¡©e
 !ğ
NULL
è
	`ä“
(node_state);

1265 if(
lšk_¡©e
 !ğ
NULL
è
	`ä“
(link_state);

1266 if(
buf
 !ğ
NULL
è
	`ä“
(buf);

1268 
	}
}

	@tracelb/scamper_tracelb_warts.h

24 #iâdeà
__SCAMPER_TRACELB_WARTS_H


25 
	#__SCAMPER_TRACELB_WARTS_H


	)

27 
sÿm³r_fe_w¬ts_Œaûlb_»ad
(
sÿm³r_fe_t
 *
sf
, cÚ¡ 
w¬ts_hdr_t
 *
hdr
,

28 
sÿm³r_Œaûlb_t
 **
Œaû_out
);

30 
sÿm³r_fe_w¬ts_Œaûlb_wr™e
(cÚ¡ 
sÿm³r_fe_t
 *
sf
,

31 cÚ¡ 
sÿm³r_Œaûlb_t
 *
Œaû
);

	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_MISC


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ifdeà
__USE_ISOC99


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_MISC


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ifdeà
__USE_ISOC99


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ifdeà
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ifdeà
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_MISC


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ifdeà
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


618 #iâdeà
__USE_FILE_OFFSET64


619 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

621 #ifdeà
__REDIRECT


622 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

623 
	`__nÚnuÎ
 ((1)è
__wur
;

625 
	#mk¡emp
 
mk¡emp64


	)

628 #ifdeà
__USE_LARGEFILE64


629 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_MISC


640 #iâdeà
__USE_FILE_OFFSET64


641 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #ifdeà
__REDIRECT


644 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

645 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

647 
	#mk¡emps
 
mk¡emps64


	)

650 #ifdeà
__USE_LARGEFILE64


651 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

652 
	`__nÚnuÎ
 ((1)è
__wur
;

656 #ifdeà
__USE_XOPEN2K8


662 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

665 #ifdeà
__USE_GNU


672 #iâdeà
__USE_FILE_OFFSET64


673 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

675 #ifdeà
__REDIRECT


676 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

677 
	`__nÚnuÎ
 ((1)è
__wur
;

679 
	#mko¡emp
 
mko¡emp64


	)

682 #ifdeà
__USE_LARGEFILE64


683 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

692 #iâdeà
__USE_FILE_OFFSET64


693 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

694 
	`__nÚnuÎ
 ((1)è
__wur
;

696 #ifdeà
__REDIRECT


697 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

698 
__æags
), 
mko¡emps64
)

699 
	`__nÚnuÎ
 ((1)è
__wur
;

701 
	#mko¡emps
 
mko¡emps64


	)

704 #ifdeà
__USE_LARGEFILE64


705 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

706 
	`__nÚnuÎ
 ((1)è
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

724 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

727 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


733 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

734 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

739 #iâdeà
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com·r_â_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com·r_â_t
 
	tcom·risÚ_â_t
;

747 #ifdeà
__USE_GNU


748 (*
	t__com·r_d_â_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

755 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

756 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

758 #ifdeà
__USE_EXTERN_INLINES


759 
	~<b™s/¡dlib-b£¬ch.h
>

764 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

766 #ifdeà
__USE_GNU


767 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

768 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

769 
	`__nÚnuÎ
 ((1, 4));

774 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

775 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
__END_NAMESPACE_STD


778 #ifdeà
__USE_ISOC99


779 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

780 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

784 
__BEGIN_NAMESPACE_STD


788 
div_t
 
	$div
 (
__num”
, 
__d’om
)

789 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

790 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

791 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

792 
__END_NAMESPACE_STD


794 #ifdeà
__USE_ISOC99


795 
__BEGIN_NAMESPACE_C99


796 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

797 
__d’om
)

798 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

799 
__END_NAMESPACE_C99


803 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

804 || 
defšed
 
__USE_MISC


811 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

812 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

817 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

818 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

823 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

824 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

827 #ifdeà
__USE_MISC


829 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

833 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

834 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

835 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

836 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

841 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

844 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

845 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

846 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

848 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

849 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

850 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

851 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

852 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

853 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

854 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

855 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

859 
__BEGIN_NAMESPACE_STD


862 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

865 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

866 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

869 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

873 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

874 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

876 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

877 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

878 
__THROW
;

879 
__END_NAMESPACE_STD


882 #ifdeà
__USE_MISC


887 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


898 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

899 *cÚ¡ *
__»¡riù
 
__tok’s
,

900 **
__»¡riù
 
__v®u•
)

901 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

905 #ifdeà
__USE_XOPEN


907 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

913 #ifdeà
__USE_XOPEN2KXSI


915 
	$posix_İ’±
 (
__oæag
è
__wur
;

918 #ifdeà
__USE_XOPEN


923 
	$g¿Á±
 (
__fd
è
__THROW
;

927 
	$uÆock±
 (
__fd
è
__THROW
;

932 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

935 #ifdeà
__USE_GNU


939 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

940 
__THROW
 
	`__nÚnuÎ
 ((2));

943 
	`g‘±
 ();

946 #ifdeà
__USE_MISC


950 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	~<b™s/¡dlib-æßt.h
>

957 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


958 
	~<b™s/¡dlib.h
>

960 #ifdeà
__LDBL_COMPAT


961 
	~<b™s/¡dlib-ldbl.h
>

965 #undeà
__Ãed_m®loc_ªd_ÿÎoc


967 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ifdeà
__USE_POSIX


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_MISC


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ifdeà
__USE_POSIX


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_POSIX


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_MISC


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/bits/stdlib-bsearch.h

19 
__ex‹º_šlše
 *

20 
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

21 
__com·r_â_t
 
__com·r
)

23 
size_t
 
__l
, 
__u
, 
__idx
;

24 cÚ¡ *
__p
;

25 
__com·risÚ
;

27 
__l
 = 0;

28 
__u
 = 
__nmemb
;

29 
__l
 < 
__u
)

31 
__idx
 = (
__l
 + 
__u
) / 2;

32 
__p
 = (*è(((cÚ¡ *è
__ba£
è+ (
__idx
 * 
__size
));

33 
__com·risÚ
 = (*
__com·r
è(
__key
, 
__p
);

34 ià(
__com·risÚ
 < 0)

35 
__u
 = 
__idx
;

36 ià(
__com·risÚ
 > 0)

37 
__l
 = 
__idx
 + 1;

39  (*è
__p
;

42  
NULL
;

43 
	}
}

	@/usr/include/bits/stdlib-float.h

19 #iâdeà
_STDLIB_H


23 #ifdeà
__USE_EXTERN_INLINES


24 
__BEGIN_NAMESPACE_STD


25 
__ex‹º_šlše
 

26 
__NTH
 (
	$©of
 (cÚ¡ *
__ÅŒ
))

28  
	`¡¹od
 (
__ÅŒ
, (**è
NULL
);

29 
	}
}

30 
	g__END_NAMESPACE_STD


	@/usr/include/bits/stdlib-ldbl.h

19 #iâdeà
_STDLIB_H


23 #ifdef 
__USE_ISOC99


24 
__BEGIN_NAMESPACE_C99


25 
	$__LDBL_REDIR1_DECL
 (
¡¹Şd
, 
¡¹od
)

26 
__END_NAMESPACE_C99


29 #ifdeà
__USE_GNU


30 
	$__LDBL_REDIR1_DECL
 (
¡¹Şd_l
, 
¡¹od_l
)

33 #ifdeà
__USE_MISC


34 
	$__LDBL_REDIR1_DECL
 (
qecvt
, 
ecvt
)

35 
	$__LDBL_REDIR1_DECL
 (
qfcvt
, 
fcvt
)

36 
	$__LDBL_REDIR1_DECL
 (
qgcvt
, 
gcvt
)

37 
	$__LDBL_REDIR1_DECL
 (
qecvt_r
, 
ecvt_r
)

38 
	$__LDBL_REDIR1_DECL
 (
qfcvt_r
, 
fcvt_r
)

	@/usr/include/bits/stdlib.h

19 #iâdeà
_STDLIB_H


23 *
	$__»®·th_chk
 (cÚ¡ *
__»¡riù
 
__Çme
,

24 *
__»¡riù
 
__»sŞved
,

25 
size_t
 
__»sŞvedËn
è
__THROW
 
__wur
;

26 *
	`__REDIRECT_NTH
 (
__»®·th_®Ÿs
,

27 (cÚ¡ *
__»¡riù
 
__Çme
,

28 *
__»¡riù
 
__»sŞved
), 
»®·th
è
__wur
;

29 *
	`__REDIRECT_NTH
 (
__»®·th_chk_w¬n
,

30 (cÚ¡ *
__»¡riù
 
__Çme
,

31 *
__»¡riù
 
__»sŞved
,

32 
size_t
 
__»sŞvedËn
), 
__»®·th_chk
è
__wur


33 
	`__w¬Ç‰r
 ("second‡rgument of„ealpath must beƒither NULL or‡t "

36 
__fÜtify_funùiÚ
 
__wur
 *

37 
	`__NTH
 (
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
, *__»¡riù 
__»sŞved
))

39 ià(
	`__bos
 (
__»sŞved
è!ğ(
size_t
) -1)

41 #ià
defšed
 
_LIBC_LIMITS_H_
 && defšed 
PATH_MAX


42 ià(
	`__bos
 (
__»sŞved
è< 
PATH_MAX
)

43  
	`__»®·th_chk_w¬n
 (
__Çme
, 
__»sŞved
, 
	`__bos
 (__resolved));

45  
	`__»®·th_chk
 (
__Çme
, 
__»sŞved
, 
	`__bos
 (__resolved));

48  
	`__»®·th_®Ÿs
 (
__Çme
, 
__»sŞved
);

49 
	}
}

52 
	$__±¢ame_r_chk
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

53 
size_t
 
__Ä—l
è
__THROW
 
	`__nÚnuÎ
 ((2));

54 
	`__REDIRECT_NTH
 (
__±¢ame_r_®Ÿs
, (
__fd
, *
__buf
,

55 
size_t
 
__buæ’
), 
±¢ame_r
)

56 
	`__nÚnuÎ
 ((2));

57 
	`__REDIRECT_NTH
 (
__±¢ame_r_chk_w¬n
,

58 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

59 
size_t
 
__Ä—l
), 
__±¢ame_r_chk
)

60 
	`__nÚnuÎ
 ((2)è
	`__w¬Ç‰r
 ("ptsname_r called with buflen biggerhan "

63 
__fÜtify_funùiÚ
 

64 
	`__NTH
 (
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
))

66 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

68 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

69  
	`__±¢ame_r_chk
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

70 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

71  
	`__±¢ame_r_chk_w¬n
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

73  
	`__±¢ame_r_®Ÿs
 (
__fd
, 
__buf
, 
__buæ’
);

74 
	}
}

77 
	$__wùomb_chk
 (*
__s
, 
wch¬_t
 
__wch¬
, 
size_t
 
__buæ’
)

78 
__THROW
 
__wur
;

79 
	`__REDIRECT_NTH
 (
__wùomb_®Ÿs
, (*
__s
, 
wch¬_t
 
__wch¬
),

80 
wùomb
è
__wur
;

82 
__fÜtify_funùiÚ
 
__wur
 

83 
	`__NTH
 (
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
))

88 
	#__STDLIB_MB_LEN_MAX
 16

	)

89 #ià
defšed
 
MB_LEN_MAX
 && MB_LEN_MAX !ğ
__STDLIB_MB_LEN_MAX


92 ià(
	`__bos
 (
__s
è!ğ(
size_t
è-1 && 
__STDLIB_MB_LEN_MAX
 > __bos (__s))

93  
	`__wùomb_chk
 (
__s
, 
__wch¬
, 
	`__bos
 (__s));

94  
	`__wùomb_®Ÿs
 (
__s
, 
__wch¬
);

95 
	}
}

98 
size_t
 
	$__mb¡owcs_chk
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

99 cÚ¡ *
__»¡riù
 
__¤c
,

100 
size_t
 
__Ën
, size_ˆ
__d¡Ën
è
__THROW
;

101 
size_t
 
	`__REDIRECT_NTH
 (
__mb¡owcs_®Ÿs
,

102 (
wch¬_t
 *
__»¡riù
 
__d¡
,

103 cÚ¡ *
__»¡riù
 
__¤c
,

104 
size_t
 
__Ën
), 
mb¡owcs
);

105 
size_t
 
	`__REDIRECT_NTH
 (
__mb¡owcs_chk_w¬n
,

106 (
wch¬_t
 *
__»¡riù
 
__d¡
,

107 cÚ¡ *
__»¡riù
 
__¤c
,

108 
size_t
 
__Ën
, size_ˆ
__d¡Ën
), 
__mb¡owcs_chk
)

109 
	`__w¬Ç‰r
 ("mbstowcs called with dst buffer smallerhan†en "

112 
__fÜtify_funùiÚ
 
size_t


113 
	`__NTH
 (
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
, cÚ¡ *__»¡riù 
__¤c
,

114 
size_t
 
__Ën
))

116 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

118 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

119  
	`__mb¡owcs_chk
 (
__d¡
, 
__¤c
, 
__Ën
,

120 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

122 ià(
__Ën
 > 
	`__bos
 (
__d¡
è/  (
wch¬_t
))

123  
	`__mb¡owcs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
,

124 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

126  
	`__mb¡owcs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
);

127 
	}
}

130 
size_t
 
	$__wc¡ombs_chk
 (*
__»¡riù
 
__d¡
,

131 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
,

132 
size_t
 
__Ën
, size_ˆ
__d¡Ën
è
__THROW
;

133 
size_t
 
	`__REDIRECT_NTH
 (
__wc¡ombs_®Ÿs
,

134 (*
__»¡riù
 
__d¡
,

135 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
,

136 
size_t
 
__Ën
), 
wc¡ombs
);

137 
size_t
 
	`__REDIRECT_NTH
 (
__wc¡ombs_chk_w¬n
,

138 (*
__»¡riù
 
__d¡
,

139 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
,

140 
size_t
 
__Ën
, size_ˆ
__d¡Ën
), 
__wc¡ombs_chk
)

141 
	`__w¬Ç‰r
 ("wcstombs called with dst buffer smallerhan†en");

143 
__fÜtify_funùiÚ
 
size_t


144 
	`__NTH
 (
	$wc¡ombs
 (*
__»¡riù
 
__d¡
, cÚ¡ 
wch¬_t
 *__»¡riù 
__¤c
,

145 
size_t
 
__Ën
))

147 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

149 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

150  
	`__wc¡ombs_chk
 (
__d¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dst));

151 ià(
__Ën
 > 
	`__bos
 (
__d¡
))

152  
	`__wc¡ombs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dst));

154  
	`__wc¡ombs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
);

155 
	}
}

	@/usr/include/bits/string.h

19 #iâdeà
_STRING_H


24 
	#_STRING_INLINE_uÇligÃd
 1

	)

27 
	#_HAVE_STRING_ARCH_mempıy
 1

	)

31 #ià!
defšed
 
__x86_64__
 && (defšed 
__i486__
 || defšed 
__³Áium__
 \

32 || 
defšed
 
	g__³Áium´o__
 || defšed 
	g__³Áium4__
 \

33 || 
defšed
 
	g__nocÚa__
 || defšed 
	g__©om__
 \

34 || 
defšed
 
	g__cÜe2__
 || defšed 
	g__cÜei7__
 \

35 || 
defšed
 
	g__§ndybridge__
 || defšed 
	g__hasw–l__
 \

36 || 
defšed
 
	g__bÚÃÎ__
 || defšed 
	g__sv”mÚt__
 \

37 || 
defšed
 
	g__k6__
 || defšed 
	g__geode__
 \

38 || 
defšed
 
	g__k8__
 || defšed 
	g__©hlÚ__
 \

39 || 
defšed
 
	g__amdçm10__
 || defšed 
	g__bdv”1__
 \

40 || 
defšed
 
	g__bdv”2__
 || defšed 
	g__bdv”3__
 \

41 || 
defšed
 
	g__bdv”4__
 || defšed 
	g__btv”1__
 \

42 || 
defšed
 
	g__btv”2__
)

46 #ià!
defšed
 
__NO_STRING_INLINES
 && defšed 
__USE_STRING_INLINES
 \

47 && 
defšed
 
	g__GNUC__
 && __GNUC__ >= 2

49 #iâdeà
__STRING_INLINE


50 #iâdeà
__ex‹º_šlše


51 
	#__STRING_INLINE
 
šlše


	)

53 
	#__STRING_INLINE
 
__ex‹º_šlše


	)

58 
	#__STRING_SMALL_GET16
(
¤c
, 
idx
) \

59 ((((cÚ¡ *è(
¤c
))[
idx
 + 1] << 8) \

60 | ((cÚ¡ *è(
¤c
))[
idx
])

	)

61 
	#__STRING_SMALL_GET32
(
¤c
, 
idx
) \

62 (((((cÚ¡ *è(
¤c
))[
idx
 + 3] << 8 \

63 | ((cÚ¡ *è(
¤c
))[
idx
 + 2]) << 8 \

64 | ((cÚ¡ *è(
¤c
))[
idx
 + 1]) << 8 \

65 | ((cÚ¡ *è(
¤c
))[
idx
])

	)

69 
	#_HAVE_STRING_ARCH_memıy
 1

	)

70 
	#memıy
(
de¡
, 
¤c
, 
n
) \

71 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) \

72 ? 
	`__memıy_c
 ((
de¡
), (
¤c
), (
n
)) \

73 : 
	`__memıy_g
 ((
de¡
), (
¤c
), (
n
))))

	)

74 
	#__memıy_c
(
de¡
, 
¤c
, 
n
) \

75 ((
n
) == 0 \

76 ? (
de¡
) \

77 : (((
n
) % 4 == 0) \

78 ? 
	`__memıy_by4
 (
de¡
, 
¤c
, 
n
) \

79 : (((
n
) % 2 == 0) \

80 ? 
	`__memıy_by2
 (
de¡
, 
¤c
, 
n
) \

81 : 
	`__memıy_g
 (
de¡
, 
¤c
, 
n
))))

	)

83 
__STRING_INLINE
 *
__memıy_by4
 (*
__de¡
, cÚ¡ *
__¤c
,

84 
size_t
 
__n
);

86 
__STRING_INLINE
 *

87 
	$__memıy_by4
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

89 
__d0
, 
__d1
;

90 *
__tmp
 = 
__de¡
;

91 
__asm__
 
__vŞ©e__


99 : "=&r" (
__d0
), "=&r" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__d1
)

100 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__n
 / 4)

102  
__de¡
;

103 
	}
}

105 
__STRING_INLINE
 *
__memıy_by2
 (*
__de¡
, cÚ¡ *
__¤c
,

106 
size_t
 
__n
);

108 
__STRING_INLINE
 *

109 
	$__memıy_by2
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

111 
__d0
, 
__d1
;

112 *
__tmp
 = 
__de¡
;

113 
__asm__
 
__vŞ©e__


126 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__d1
)

127 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__n
 / 2)

129  
__de¡
;

130 
	}
}

132 
__STRING_INLINE
 *
__memıy_g
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
);

134 
__STRING_INLINE
 *

135 
	$__memıy_g
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

137 
__d0
, 
__d1
, 
__d2
;

138 *
__tmp
 = 
__de¡
;

139 
__asm__
 
__vŞ©e__


150 : "=&c" (
__d0
), "=&D" (
__d1
), "=&S" (
__d2
),

151 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__de¡
)

152 : "0" (
__n
), "1" (
__tmp
), "2" (
__¤c
),

153 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__¤c
)

155  
__de¡
;

156 
	}
}

158 
	#_HAVE_STRING_ARCH_memmove
 1

	)

159 #iâdeà
_FORCE_INLINES


162 
	#memmove
(
de¡
, 
¤c
, 
n
è
	`__memmove_g
 (de¡, src,‚)

	)

164 
__STRING_INLINE
 *
	$__memmove_g
 (*, cÚ¡ *, 
size_t
)

165 
	`__asm__
 ("memmove");

167 
__STRING_INLINE
 *

168 
	$__memmove_g
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

170 
__d0
, 
__d1
, 
__d2
;

171 *
__tmp
 = 
__de¡
;

172 ià(
__de¡
 < 
__¤c
)

173 
__asm__
 
__vŞ©e__


176 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

177 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__de¡
)

178 : "0" (
__n
), "1" (
__¤c
), "2" (
__tmp
),

179 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__¤c
));

181 
__asm__
 
__vŞ©e__


187 : "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
),

188 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__de¡
)

189 : "0" (
__n
), "1" (__À+ (cÚ¡ *è
__¤c
),

190 "2" (
__n
 + (*è
__tmp
),

191 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__¤c
));

192  
__de¡
;

193 
	}
}

197 
	#_HAVE_STRING_ARCH_memcmp
 1

	)

198 #iâdeà
_FORCE_INLINES


199 #iâdeà
__PIC__


201 
__STRING_INLINE
 

202 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

204 
__d0
, 
__d1
, 
__d2
;

205 
__»s
;

206 
__asm__
 
__vŞ©e__


214 : "=&a" (
__»s
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

215 : "0" (0), "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

216 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s1
),

217 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s2
)

219  
__»s
;

220 
	}
}

225 
	#_HAVE_STRING_ARCH_mem£t
 1

	)

226 
	#_USE_STRING_ARCH_mem£t
 1

	)

227 
	#mem£t
(
s
, 
c
, 
n
) \

228 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) && (n) <= 16 \

229 ? ((
n
) == 1 \

230 ? 
	`__mem£t_c1
 ((
s
), (
c
)) \

231 : 
	`__mem£t_gc
 ((
s
), (
c
), (
n
))) \

232 : (
	`__butš_cÚ¡ªt_p
 (
c
) \

233 ? (
	`__butš_cÚ¡ªt_p
 (
n
) \

234 ? 
	`__mem£t_cú
 ((
s
), (
c
), (
n
)) \

235 : 
	`mem£t
 ((
s
), (
c
), (
n
))) \

236 : (
	`__butš_cÚ¡ªt_p
 (
n
) \

237 ? 
	`__mem£t_gú
 ((
s
), (
c
), (
n
)) \

238 : 
	`mem£t
 ((
s
), (
c
), (
n
))))))

	)

240 
	#__mem£t_c1
(
s
, 
c
è({ *
__s
 = (s); \

241 *((*è
__s
èğ(è(
c
); \

242 
__s
; })

	)

244 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

245 ({ *
__s
 = (
s
); \

247 
__ui
; \

248 
__usi
; \

249 
__uc
; \

250 } *
__u
 = 
__s
; \

251 
__c
 = ((è((è(
c
))) * 0x01010101; \

257 ià((
n
) == 3 || (n) >= 5) \

258 
__asm__
 
	`__vŞ©e__
 ("" : "ô" (
__c
) : "0" (__c)); \

261 
n
) \

264 
__u
->
__ui
 = 
__c
; \

265 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

267 
__u
->
__ui
 = 
__c
; \

268 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

270 
__u
->
__ui
 = 
__c
; \

271 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

273 
__u
->
__usi
 = (è
__c
; \

274 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

275 
__u
->
__uc
 = (è
__c
; \

279 
__u
->
__ui
 = 
__c
; \

280 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

282 
__u
->
__ui
 = 
__c
; \

283 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

285 
__u
->
__ui
 = 
__c
; \

286 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

288 
__u
->
__usi
 = (è
__c
; \

292 
__u
->
__ui
 = 
__c
; \

293 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

295 
__u
->
__ui
 = 
__c
; \

296 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

298 
__u
->
__ui
 = 
__c
; \

299 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

301 
__u
->
__uc
 = (è
__c
; \

305 
__u
->
__ui
 = 
__c
; \

306 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

308 
__u
->
__ui
 = 
__c
; \

309 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

311 
__u
->
__ui
 = 
__c
; \

312 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

314 
__u
->
__ui
 = 
__c
; \

319 
__s
; })

	)

321 
	#__mem£t_cú
(
s
, 
c
, 
n
) \

322 (((
n
) % 4 == 0) \

323 ? 
	`__mem£t_cú_by4
 (
s
, ((è((è(
c
))) * 0x01010101,\

324 
n
) \

325 : (((
n
) % 2 == 0) \

326 ? 
	`__mem£t_cú_by2
 (
s
, \

327 ((è((è(
c
))) * 0x01010101,\

328 
n
) \

329 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

331 
__STRING_INLINE
 *
__mem£t_cú_by4
 (*
__s
, 
__c
,

332 
size_t
 
__n
);

334 
__STRING_INLINE
 *

335 
	$__mem£t_cú_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

337 *
__tmp
 = 
__s
;

338 
__d0
;

339 #ifdeà
__i686__


340 
__asm__
 
__vŞ©e__


343 : "=&a" (
__c
), "=&D" (
__tmp
), "=&c" (
__d0
),

344 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

345 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

348 
__asm__
 
__vŞ©e__


354 : "=&r" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

355 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

356 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

359  
__s
;

360 
	}
}

362 
__STRING_INLINE
 *
__mem£t_cú_by2
 (*
__s
, 
__c
,

363 
size_t
 
__n
);

365 
__STRING_INLINE
 *

366 
	$__mem£t_cú_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

368 
__d0
, 
__d1
;

369 *
__tmp
 = 
__s
;

370 #ifdeà
__i686__


371 
__asm__
 
__vŞ©e__


375 : "=&a" (
__d0
), "=&D" (
__tmp
), "=&c" (
__d1
),

376 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

377 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

380 
__asm__
 
__vŞ©e__


386 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

387 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

388 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

391  
__s
;

392 
	}
}

394 
	#__mem£t_gú
(
s
, 
c
, 
n
) \

395 (((
n
) % 4 == 0) \

396 ? 
	`__mem£t_gú_by4
 (
s
, 
c
, 
n
) \

397 : (((
n
) % 2 == 0) \

398 ? 
	`__mem£t_gú_by2
 (
s
, 
c
, 
n
) \

399 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

401 
__STRING_INLINE
 *
__mem£t_gú_by4
 (*
__s
, 
__c
, 
size_t
 
__n
);

403 
__STRING_INLINE
 *

404 
	$__mem£t_gú_by4
 (*
__s
, 
__c
, 
size_t
 
__n
)

406 *
__tmp
 = 
__s
;

407 
__d0
;

408 
__asm__
 
__vŞ©e__


418 : "=&q" (
__c
), "=&r" (
__tmp
), "=&r" (
__d0
),

419 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

420 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

422  
__s
;

423 
	}
}

425 
__STRING_INLINE
 *
__mem£t_gú_by2
 (*
__s
, 
__c
, 
size_t
 
__n
);

427 
__STRING_INLINE
 *

428 
	$__mem£t_gú_by2
 (*
__s
, 
__c
, 
size_t
 
__n
)

430 
__d0
, 
__d1
;

431 *
__tmp
 = 
__s
;

432 
__asm__
 
__vŞ©e__


443 : "=&q" (
__d0
), "=&r" (
__tmp
), "=&r" (
__d1
),

444 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

445 : "0" ((è
__c
), "1" (
__tmp
), "2" (
__n
 / 4)

447  
__s
;

448 
	}
}

452 
	#_HAVE_STRING_ARCH_memchr
 1

	)

453 #iâdeà
_FORCE_INLINES


454 
__STRING_INLINE
 *

455 
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

457 
__d0
;

458 #ifdeà
__i686__


459 
__d1
;

461 *
__»s
;

462 ià(
__n
 == 0)

463  
NULL
;

464 #ifdeà
__i686__


465 
__asm__
 
__vŞ©e__


469 : "=D" (
__»s
), "=&c" (
__d0
), "=&r" (
__d1
)

470 : "a" (
__c
), "0" (
__s
), "1" (
__n
), "2" (1),

471 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

474 
__asm__
 
__vŞ©e__


480 : "=D" (
__»s
), "=&c" (
__d0
)

481 : "a" (
__c
), "0" (
__s
), "1" (
__n
),

482 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

485  
__»s
 - 1;

486 
	}
}

489 
	#_HAVE_STRING_ARCH_memrchr
 1

	)

490 #iâdeà
_FORCE_INLINES


491 
__STRING_INLINE
 *
__memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
);

493 
__STRING_INLINE
 *

494 
	$__memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

496 
__d0
;

497 #ifdeà
__i686__


498 
__d1
;

500 *
__»s
;

501 ià(
__n
 == 0)

502  
NULL
;

503 #ifdeà
__i686__


504 
__asm__
 
__vŞ©e__


510 : "=D" (
__»s
), "=&c" (
__d0
), "=&r" (
__d1
)

511 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n), "2" (-1),

512 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

515 
__asm__
 
__vŞ©e__


522 : "=D" (
__»s
), "=&c" (
__d0
)

523 : "a" (
__c
), "0" (
__s
 + 
__n
 - 1), "1" (__n),

524 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s
)

527  
__»s
;

528 
	}
}

529 #ifdeà
__USE_GNU


530 
	#memrchr
(
s
, 
c
, 
n
è
	`__memrchr
 ((s), (c), (n))

	)

535 
	#_HAVE_STRING_ARCH_¿wmemchr
 1

	)

536 
__STRING_INLINE
 *
__¿wmemchr
 (cÚ¡ *
__s
, 
__c
);

538 #iâdeà
_FORCE_INLINES


539 
__STRING_INLINE
 *

540 
	$__¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

542 
__d0
;

543 *
__»s
;

544 
__asm__
 
__vŞ©e__


547 : "=D" (
__»s
), "=&c" (
__d0
)

548 : "a" (
__c
), "0" (
__s
), "1" (0xffffffff),

549 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

551  
__»s
 - 1;

552 
	}
}

553 #ifdeà
__USE_GNU


554 
__STRING_INLINE
 *

555 
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

557  
	`__¿wmemchr
 (
__s
, 
__c
);

558 
	}
}

564 
	#_HAVE_STRING_ARCH_¡¾’
 1

	)

565 
	#¡¾’
(
¡r
) \

566 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¡r
) \

567 ? 
	`__butš_¡¾’
 (
¡r
) \

568 : 
	`__¡¾’_g
 (
¡r
)))

	)

569 
__STRING_INLINE
 
size_t
 
__¡¾’_g
 (cÚ¡ *
__¡r
);

571 
__STRING_INLINE
 
size_t


572 
	$__¡¾’_g
 (cÚ¡ *
__¡r
)

574 
__dummy
;

575 cÚ¡ *
__tmp
 = 
__¡r
;

576 
__asm__
 
__vŞ©e__


582 : "ô" (
__tmp
), "=&q" (
__dummy
)

583 : "0" (
__¡r
),

584 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__¡r
)

586  
__tmp
 - 
__¡r
 - 1;

587 
	}
}

591 
	#_HAVE_STRING_ARCH_¡rıy
 1

	)

592 
	#¡rıy
(
de¡
, 
¤c
) \

593 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

594 ? ( ((
¤c
)[0]è=ğ1 && 
	`¡¾’
 (src) + 1 <= 8 \

595 ? 
	`__¡rıy_a_sm®l
 ((
de¡
), (
¤c
), 
	`¡¾’
 (src) + 1) \

596 : (*è
	`memıy
 ((*è(
de¡
), \

597 (cÚ¡ *è(
¤c
), \

598 
	`¡¾’
 (
¤c
) + 1)) \

599 : 
	`__¡rıy_g
 ((
de¡
), (
¤c
))))

	)

601 
	#__¡rıy_a_sm®l
(
de¡
, 
¤c
, 
¤ş’
) \

602 (
	`__ex‹nsiÚ__
 ({ *
__de¡
 = (
de¡
); \

604 
__ui
; \

605 
__usi
; \

606 
__uc
; \

607 
__c
; \

608 } *
__u
 = (*è
__de¡
; \

609 
¤ş’
) \

612 
__u
->
__uc
 = '\0'; \

615 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 0); \

618 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 0); \

619 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

620 
__u
->
__uc
 = '\0'; \

623 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

626 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

627 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

628 
__u
->
__uc
 = '\0'; \

631 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

632 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

633 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 4); \

636 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

637 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

638 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 4); \

639 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

640 
__u
->
__uc
 = '\0'; \

643 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

644 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

645 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 4); \

648 (*è
__de¡
; }))

	)

650 
__STRING_INLINE
 *
__¡rıy_g
 (*
__de¡
, cÚ¡ *
__¤c
);

652 
__STRING_INLINE
 *

653 
	$__¡rıy_g
 (*
__de¡
, cÚ¡ *
__¤c
)

655 *
__tmp
 = 
__de¡
;

656 
__dummy
;

657 
__asm__
 
__vŞ©e__


666 : "=&r" (
__¤c
), "=&r" (
__tmp
), "=&q" (
__dummy
),

667 "=m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__de¡
)

668 : "0" (
__¤c
), "1" (
__tmp
),

669 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__¤c
)

671  
__de¡
;

672 
	}
}

675 #ifdeà
__USE_GNU


676 
	#_HAVE_STRING_ARCH_¡pıy
 1

	)

678 
	#__¡pıy
(
de¡
, 
¤c
) \

679 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

680 ? (
	`¡¾’
 (
¤c
) + 1 <= 8 \

681 ? 
	`__¡pıy_a_sm®l
 ((
de¡
), (
¤c
), 
	`¡¾’
 (src) + 1) \

682 : 
	`__¡pıy_c
 ((
de¡
), (
¤c
), 
	`¡¾’
 (src) + 1)) \

683 : 
	`__¡pıy_g
 ((
de¡
), (
¤c
))))

	)

684 
	#__¡pıy_c
(
de¡
, 
¤c
, 
¤ş’
) \

685 ((
¤ş’
) % 4 == 0 \

686 ? 
	`__mempıy_by4
 (
de¡
, 
¤c
, 
¤ş’
) - 1 \

687 : ((
¤ş’
) % 2 == 0 \

688 ? 
	`__mempıy_by2
 (
de¡
, 
¤c
, 
¤ş’
) - 1 \

689 : 
	`__mempıy_byn
 (
de¡
, 
¤c
, 
¤ş’
è- 1))

	)

692 
	#¡pıy
(
de¡
, 
¤c
è
	`__¡pıy
 ((de¡), (¤c))

	)

694 
	#__¡pıy_a_sm®l
(
de¡
, 
¤c
, 
¤ş’
) \

695 (
	`__ex‹nsiÚ__
 ({ union { \

696 
__ui
; \

697 
__usi
; \

698 
__uc
; \

699 
__c
; \

700 } *
__u
 = (*è(
de¡
); \

701 
¤ş’
) \

704 
__u
->
__uc
 = '\0'; \

707 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 0); \

708 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1); \

711 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 0); \

712 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

713 
__u
->
__uc
 = '\0'; \

716 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

717 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3); \

720 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

721 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

722 
__u
->
__uc
 = '\0'; \

725 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

726 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

727 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 4); \

728 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1); \

731 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

732 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

733 
__u
->
__usi
 = 
	`__STRING_SMALL_GET16
 (
¤c
, 4); \

734 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

735 
__u
->
__uc
 = '\0'; \

738 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 0); \

739 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

740 
__u
->
__ui
 = 
	`__STRING_SMALL_GET32
 (
¤c
, 4); \

741 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3); \

744 (*è
__u
; }))

	)

746 
__STRING_INLINE
 *
__mempıy_by4
 (*
__de¡
, cÚ¡ *
__¤c
,

747 
size_t
 
__¤ş’
);

749 
__STRING_INLINE
 *

750 
	$__mempıy_by4
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__¤ş’
)

752 *
__tmp
 = 
__de¡
;

753 
__d0
, 
__d1
;

754 
__asm__
 
__vŞ©e__


762 : "=&r" (
__d0
), "ô" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__d1
)

763 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__¤ş’
 / 4)

765  
__tmp
;

766 
	}
}

768 
__STRING_INLINE
 *
__mempıy_by2
 (*
__de¡
, cÚ¡ *
__¤c
,

769 
size_t
 
__¤ş’
);

771 
__STRING_INLINE
 *

772 
	$__mempıy_by2
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__¤ş’
)

774 *
__tmp
 = 
__de¡
;

775 
__d0
, 
__d1
;

776 
__asm__
 
__vŞ©e__


789 : "=&q" (
__d0
), "ô" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__d1
),

790 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__de¡
)

791 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__¤ş’
 / 2),

792 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

794  
__tmp
 + 2;

795 
	}
}

797 
__STRING_INLINE
 *
__mempıy_byn
 (*
__de¡
, cÚ¡ *
__¤c
,

798 
size_t
 
__¤ş’
);

800 
__STRING_INLINE
 *

801 
	$__mempıy_byn
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__¤ş’
)

803 
__d0
, 
__d1
;

804 *
__tmp
 = 
__de¡
;

805 
__asm__
 
__vŞ©e__


816 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

817 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__de¡
)

818 : "0" (
__tmp
), "1" (
__¤ş’
), "2" (
__¤c
),

819 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

821  
__tmp
;

822 
	}
}

824 
__STRING_INLINE
 *
__¡pıy_g
 (*
__de¡
, cÚ¡ *
__¤c
);

826 
__STRING_INLINE
 *

827 
	$__¡pıy_g
 (*
__de¡
, cÚ¡ *
__¤c
)

829 *
__tmp
 = 
__de¡
;

830 
__dummy
;

831 
__asm__
 
__vŞ©e__


840 : "=&r" (
__¤c
), "ô" (
__tmp
), "=&q" (
__dummy
),

841 "=m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__de¡
)

842 : "0" (
__¤c
), "1" (
__tmp
),

843 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__¤c
)

845  
__tmp
 - 1;

846 
	}
}

851 
	#_HAVE_STRING_ARCH_¡ºıy
 1

	)

852 
	#¡ºıy
(
de¡
, 
¤c
, 
n
) \

853 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

854 ? ((
	`¡¾’
 (
¤c
è+ 1 >ğ((
size_t
è(
n
)) \

855 ? (*è
	`memıy
 ((*è(
de¡
), \

856 (cÚ¡ *è(
¤c
), 
n
) \

857 : 
	`__¡ºıy_cg
 ((
de¡
), (
¤c
), 
	`¡¾’
 (¤cè+ 1, 
n
))) \

858 : 
	`__¡ºıy_gg
 ((
de¡
), (
¤c
), 
n
)))

	)

859 
	#__¡ºıy_cg
(
de¡
, 
¤c
, 
¤ş’
, 
n
) \

860 (((
¤ş’
) % 4 == 0) \

861 ? 
	`__¡ºıy_by4
 (
de¡
, 
¤c
, 
¤ş’
, 
n
) \

862 : (((
¤ş’
) % 2 == 0) \

863 ? 
	`__¡ºıy_by2
 (
de¡
, 
¤c
, 
¤ş’
, 
n
) \

864 : 
	`__¡ºıy_byn
 (
de¡
, 
¤c
, 
¤ş’
, 
n
)))

	)

866 
__STRING_INLINE
 *
__¡ºıy_by4
 (*
__de¡
, cÚ¡ 
__¤c
[],

867 
size_t
 
__¤ş’
, size_ˆ
__n
);

869 
__STRING_INLINE
 *

870 
	$__¡ºıy_by4
 (*
__de¡
, cÚ¡ 
__¤c
[], 
size_t
 
__¤ş’
, size_ˆ
__n
)

872 *
__tmp
 = 
__de¡
;

873 
__dummy1
, 
__dummy2
;

874 
__asm__
 
__vŞ©e__


882 : "=&r" (
__dummy1
), "ô" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__dummy2
),

883 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__de¡
)

884 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__¤ş’
 / 4),

885 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

887 (è
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__¤ş’
);

888  
__de¡
;

889 
	}
}

891 
__STRING_INLINE
 *
__¡ºıy_by2
 (*
__de¡
, cÚ¡ 
__¤c
[],

892 
size_t
 
__¤ş’
, size_ˆ
__n
);

894 
__STRING_INLINE
 *

895 
	$__¡ºıy_by2
 (*
__de¡
, cÚ¡ 
__¤c
[], 
size_t
 
__¤ş’
, size_ˆ
__n
)

897 *
__tmp
 = 
__de¡
;

898 
__dummy1
, 
__dummy2
;

899 
__asm__
 
__vŞ©e__


912 : "=&q" (
__dummy1
), "ô" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__dummy2
),

913 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__de¡
)

914 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__¤ş’
 / 2),

915 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

917 (è
	`mem£t
 (
__tmp
 + 2, '\0', 
__n
 - 
__¤ş’
);

918  
__de¡
;

919 
	}
}

921 
__STRING_INLINE
 *
__¡ºıy_byn
 (*
__de¡
, cÚ¡ 
__¤c
[],

922 
size_t
 
__¤ş’
, size_ˆ
__n
);

924 
__STRING_INLINE
 *

925 
	$__¡ºıy_byn
 (*
__de¡
, cÚ¡ 
__¤c
[], 
size_t
 
__¤ş’
, size_ˆ
__n
)

927 
__d0
, 
__d1
;

928 *
__tmp
 = 
__de¡
;

929 
__asm__
 
__vŞ©e__


940 : "=D" (
__tmp
), "=&c" (
__d0
), "=&S" (
__d1
),

941 "=m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__de¡
)

942 : "1" (
__¤ş’
), "0" (
__tmp
),"2" (
__¤c
),

943 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

945 (è
	`mem£t
 (
__tmp
, '\0', 
__n
 - 
__¤ş’
);

946  
__de¡
;

947 
	}
}

949 
__STRING_INLINE
 *
__¡ºıy_gg
 (*
__de¡
, cÚ¡ *
__¤c
,

950 
size_t
 
__n
);

952 
__STRING_INLINE
 *

953 
	$__¡ºıy_gg
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

955 *
__tmp
 = 
__de¡
;

956 
__dummy
;

957 ià(
__n
 > 0)

958 
__asm__
 
__vŞ©e__


974 : "=&r" (
__¤c
), "=&r" (
__tmp
), "=&q" (
__dummy
), "=&r" (
__n
)

975 : "0" (
__¤c
), "1" (
__tmp
), "3" (
__n
)

978  
__de¡
;

979 
	}
}

983 
	#_HAVE_STRING_ARCH_¡rÿt
 1

	)

984 
	#¡rÿt
(
de¡
, 
¤c
) \

985 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

986 ? 
	`__¡rÿt_c
 ((
de¡
), (
¤c
), 
	`¡¾’
 (src) + 1) \

987 : 
	`__¡rÿt_g
 ((
de¡
), (
¤c
))))

	)

989 
__STRING_INLINE
 *
__¡rÿt_c
 (*
__de¡
, cÚ¡ 
__¤c
[],

990 
size_t
 
__¤ş’
);

992 
__STRING_INLINE
 *

993 
	$__¡rÿt_c
 (*
__de¡
, cÚ¡ 
__¤c
[], 
size_t
 
__¤ş’
)

995 #ifdeà
__i686__


996 
__d0
;

997 *
__tmp
;

998 
__asm__
 
__vŞ©e__


1000 : "=D" (
__tmp
), "=&c" (
__d0
),

1001 "=m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__de¡
)

1002 : "0" (
__de¡
), "1" (0xffffffff), "a" (0),

1003 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

1005 --
__tmp
;

1007 *
__tmp
 = 
__de¡
;

1008 
__asm__
 
__vŞ©e__


1014 : "ô" (
__tmp
),

1015 "=m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__de¡
)

1016 : "0" (
__tmp
),

1017 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__¤ş’
]; } *)
__¤c
)

1020 (è
	`memıy
 (
__tmp
, 
__¤c
, 
__¤ş’
);

1021  
__de¡
;

1022 
	}
}

1024 
__STRING_INLINE
 *
__¡rÿt_g
 (*
__de¡
, cÚ¡ *
__¤c
);

1026 
__STRING_INLINE
 *

1027 
	$__¡rÿt_g
 (*
__de¡
, cÚ¡ *
__¤c
)

1029 *
__tmp
 = 
__de¡
;

1030 
__dummy
;

1031 
__asm__
 
__vŞ©e__


1044 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__¤c
),

1045 "=m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__de¡
)

1046 : "1" (
__tmp
), "2" (
__¤c
),

1047 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__¤c
)

1049  
__de¡
;

1050 
	}
}

1054 
	#_HAVE_STRING_ARCH_¡ºÿt
 1

	)

1055 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
) \

1056 (
	`__ex‹nsiÚ__
 ({ *
__de¡
 = (
de¡
); \

1057 
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

1058 ? (
	`¡¾’
 (
¤c
è< ((
size_t
è(
n
)) \

1059 ? 
	`¡rÿt
 (
__de¡
, (
¤c
)) \

1060 : (*(*)
	`__mempıy
 (
	`¡rchr
 (
__de¡
, '\0'), \

1061 (cÚ¡ *è(
¤c
), \

1062 (
n
)èğ0, 
__de¡
)) \

1063 : 
	`__¡ºÿt_g
 (
__de¡
, (
¤c
), (
n
)); }))

	)

1065 
__STRING_INLINE
 *
__¡ºÿt_g
 (*
__de¡
, cÚ¡ 
__¤c
[],

1066 
size_t
 
__n
);

1068 
__STRING_INLINE
 *

1069 
	$__¡ºÿt_g
 (*
__de¡
, cÚ¡ 
__¤c
[], 
size_t
 
__n
)

1071 *
__tmp
 = 
__de¡
;

1072 
__dummy
;

1073 #ifdeà
__i686__


1074 
__asm__
 
__vŞ©e__


1088 : "=&a" (
__dummy
), "=&D" (
__tmp
), "=&S" (
__¤c
), "=&c" (
__n
)

1089 : "g" (
__n
), "0" (0), "1" (
__tmp
), "2" (
__¤c
), "3" (0xffffffff)

1092 --
__tmp
;

1093 
__asm__
 
__vŞ©e__


1110 : "=&q" (
__dummy
), "=&r" (
__tmp
), "=&r" (
__¤c
), "=&r" (
__n
)

1111 : "1" (
__tmp
), "2" (
__¤c
), "3" (
__n
)

1114  
__de¡
;

1115 
	}
}

1119 
	#_HAVE_STRING_ARCH_¡rcmp
 1

	)

1120 
	#¡rcmp
(
s1
, 
s2
) \

1121 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& __butš_cÚ¡ªt_°(
s2
) \

1122 && ( ((
s1
)[0]è!ğ1 || 
	`¡¾’
 (s1) >= 4) \

1123 && ( ((
s2
)[0]è!ğ1 || 
	`¡¾’
 (s2) >= 4) \

1124 ? 
	`memcmp
 ((cÚ¡ *è(
s1
), (cÚ¡ *è(
s2
), \

1125 (
	`¡¾’
 (
s1
è< sŒËÀ(
s2
) \

1126 ? 
	`¡¾’
 (
s1
è: sŒËÀ(
s2
)) + 1) \

1127 : (
	`__butš_cÚ¡ªt_p
 (
s1
) &&  ((s1)[0]) == 1 \

1128 &&  ((
s2
)[0]è=ğ1 && 
	`¡¾’
 (
s1
) < 4 \

1129 ? (
	`__butš_cÚ¡ªt_p
 (
s2
) &&  ((s2)[0]) == 1 \

1130 ? 
	`__¡rcmp_cc
 ((cÚ¡ *è(
s1
), \

1131 (cÚ¡ *è(
s2
), \

1132 
	`¡¾’
 (
s1
)) \

1133 : 
	`__¡rcmp_cg
 ((cÚ¡ *è(
s1
), \

1134 (cÚ¡ *è(
s2
), \

1135 
	`¡¾’
 (
s1
))) \

1136 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&&  ((
s1
)[0]) == 1 \

1137 &&  ((
s2
)[0]è=ğ1 && 
	`¡¾’
 (s2) < 4 \

1138 ? (
	`__butš_cÚ¡ªt_p
 (
s1
) \

1139 ? 
	`__¡rcmp_cc
 ((cÚ¡ *è(
s1
), \

1140 (cÚ¡ *è(
s2
), \

1141 
	`¡¾’
 (
s2
)) \

1142 : 
	`__¡rcmp_gc
 ((cÚ¡ *è(
s1
), \

1143 (cÚ¡ *è(
s2
), \

1144 
	`¡¾’
 (
s2
))) \

1145 : 
	`__¡rcmp_gg
 ((
s1
), (
s2
))))))

	)

1147 
	#__¡rcmp_cc
(
s1
, 
s2
, 
l
) \

1148 (
	`__ex‹nsiÚ__
 ({ 
__»suÉ
 = (
s1
)[0] - (
s2
)[0]; \

1149 ià(
l
 > 0 && 
__»suÉ
 == 0) \

1151 
__»suÉ
 = (
s1
)[1] - (
s2
)[1]; \

1152 ià(
l
 > 1 && 
__»suÉ
 == 0) \

1154 
__»suÉ
 = (
s1
)[2] - (
s2
)[2]; \

1155 ià(
l
 > 2 && 
__»suÉ
 == 0) \

1156 
__»suÉ
 = (
s1
)[3] - (
s2
)[3]; \

1159 
__»suÉ
; }))

	)

1161 
	#__¡rcmp_cg
(
s1
, 
s2
, 
l1
) \

1162 (
	`__ex‹nsiÚ__
 ({ cÚ¡ *
__s2
 = (
s2
); \

1163 
__»suÉ
 = (
s1
)[0] - 
__s2
[0]; \

1164 ià(
l1
 > 0 && 
__»suÉ
 == 0) \

1166 
__»suÉ
 = (
s1
)[1] - 
__s2
[1]; \

1167 ià(
l1
 > 1 && 
__»suÉ
 == 0) \

1169 
__»suÉ
 = (
s1
)[2] - 
__s2
[2]; \

1170 ià(
l1
 > 2 && 
__»suÉ
 == 0) \

1171 
__»suÉ
 = (
s1
)[3] - 
__s2
[3]; \

1174 
__»suÉ
; }))

	)

1176 
	#__¡rcmp_gc
(
s1
, 
s2
, 
l2
) \

1177 (
	`__ex‹nsiÚ__
 ({ cÚ¡ *
__s1
 = (
s1
); \

1178 
__»suÉ
 = 
__s1
[0] - (
s2
)[0]; \

1179 ià(
l2
 > 0 && 
__»suÉ
 == 0) \

1181 
__»suÉ
 = 
__s1
[1] - (
s2
)[1]; \

1182 ià(
l2
 > 1 && 
__»suÉ
 == 0) \

1184 
__»suÉ
 = 
__s1
[2] - (
s2
)[2]; \

1185 ià(
l2
 > 2 && 
__»suÉ
 == 0) \

1186 
__»suÉ
 = 
__s1
[3] - (
s2
)[3]; \

1189 
__»suÉ
; }))

	)

1191 
__STRING_INLINE
 
__¡rcmp_gg
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
);

1193 
__STRING_INLINE
 

1194 
	$__¡rcmp_gg
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

1196 
__»s
;

1197 
__asm__
 
__vŞ©e__


1213 : "=q" (
__»s
), "=&r" (
__s1
), "=&r" (
__s2
)

1214 : "1" (
__s1
), "2" (
__s2
),

1215 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s1
),

1216 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s2
)

1218  
__»s
;

1219 
	}
}

1223 
	#_HAVE_STRING_ARCH_¡ºcmp
 1

	)

1224 
	#¡ºcmp
(
s1
, 
s2
, 
n
) \

1225 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`¡¾’
 (s1è< ((
size_t
è(
n
)) \

1226 ? 
	`¡rcmp
 ((
s1
), (
s2
)) \

1227 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`¡¾’
 (s2è< ((
size_t
è(
n
))\

1228 ? 
	`¡rcmp
 ((
s1
), (
s2
)) \

1229 : 
	`__¡ºcmp_g
 ((
s1
), (
s2
), (
n
)))))

	)

1231 
__STRING_INLINE
 
__¡ºcmp_g
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

1232 
size_t
 
__n
);

1234 
__STRING_INLINE
 

1235 
	$__¡ºcmp_g
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

1237 
__»s
;

1238 
__asm__
 
__vŞ©e__


1257 : "=q" (
__»s
), "=&r" (
__s1
), "=&r" (
__s2
), "=&r" (
__n
)

1258 : "1" (
__s1
), "2" (
__s2
), "3" (
__n
),

1259 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s1
),

1260 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__n
]; } *)
__s2
)

1262  
__»s
;

1263 
	}
}

1267 
	#_HAVE_STRING_ARCH_¡rchr
 1

	)

1268 
	#_USE_STRING_ARCH_¡rchr
 1

	)

1269 
	#¡rchr
(
s
, 
c
) \

1270 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) \

1271 ? ((
c
) == '\0' \

1272 ? (*è
	`__¿wmemchr
 ((
s
), (
c
)) \

1273 : 
	`__¡rchr_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1274 : 
	`__¡rchr_g
 ((
s
), (
c
))))

	)

1276 
__STRING_INLINE
 *
__¡rchr_c
 (cÚ¡ *
__s
, 
__c
);

1278 
__STRING_INLINE
 *

1279 
	$__¡rchr_c
 (cÚ¡ *
__s
, 
__c
)

1281 
__d0
;

1282 *
__»s
;

1283 
__asm__
 
__vŞ©e__


1293 : "ô" (
__»s
), "=&a" (
__d0
)

1294 : "0" (
__s
), "1" (
__c
),

1295 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1297  
__»s
;

1298 
	}
}

1300 
__STRING_INLINE
 *
__¡rchr_g
 (cÚ¡ *
__s
, 
__c
);

1302 
__STRING_INLINE
 *

1303 
	$__¡rchr_g
 (cÚ¡ *
__s
, 
__c
)

1305 
__d0
;

1306 *
__»s
;

1307 
__asm__
 
__vŞ©e__


1318 : "ô" (
__»s
), "=&a" (
__d0
)

1319 : "0" (
__s
), "1" (
__c
),

1320 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1322  
__»s
;

1323 
	}
}

1327 
	#_HAVE_STRING_ARCH_¡rchºul
 1

	)

1328 
	#__¡rchºul
(
s
, 
c
) \

1329 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) \

1330 ? ((
c
) == '\0' \

1331 ? (*è
	`__¿wmemchr
 ((
s
), 
c
) \

1332 : 
	`__¡rchºul_c
 ((
s
), ((
c
) & 0xff) << 8)) \

1333 : 
	`__¡rchºul_g
 ((
s
), 
c
)))

	)

1335 
__STRING_INLINE
 *
__¡rchºul_c
 (cÚ¡ *
__s
, 
__c
);

1337 
__STRING_INLINE
 *

1338 
	$__¡rchºul_c
 (cÚ¡ *
__s
, 
__c
)

1340 
__d0
;

1341 *
__»s
;

1342 
__asm__
 
__vŞ©e__


1352 : "ô" (
__»s
), "=&a" (
__d0
)

1353 : "0" (
__s
), "1" (
__c
),

1354 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1356  
__»s
;

1357 
	}
}

1359 
__STRING_INLINE
 *
__¡rchºul_g
 (cÚ¡ *
__s
, 
__c
);

1361 
__STRING_INLINE
 *

1362 
	$__¡rchºul_g
 (cÚ¡ *
__s
, 
__c
)

1364 
__d0
;

1365 *
__»s
;

1366 
__asm__
 
__vŞ©e__


1377 : "ô" (
__»s
), "=&a" (
__d0
)

1378 : "0" (
__s
), "1" (
__c
),

1379 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1381  
__»s
;

1382 
	}
}

1383 #ifdeà
__USE_GNU


1384 
	#¡rchºul
(
s
, 
c
è
	`__¡rchºul
 ((s), (c))

	)

1388 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


1390 
	#_HAVE_STRING_ARCH_šdex
 1

	)

1391 
	#šdex
(
s
, 
c
) \

1392 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) \

1393 ? 
	`__¡rchr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1394 : 
	`__¡rchr_g
 ((
s
), (
c
))))

	)

1399 
	#_HAVE_STRING_ARCH_¡¼chr
 1

	)

1400 
	#¡¼chr
(
s
, 
c
) \

1401 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) \

1402 ? 
	`__¡¼chr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1403 : 
	`__¡¼chr_g
 ((
s
), (
c
))))

	)

1405 #ifdeà
__i686__


1406 
__STRING_INLINE
 *
__¡¼chr_c
 (cÚ¡ *
__s
, 
__c
);

1408 
__STRING_INLINE
 *

1409 
	$__¡¼chr_c
 (cÚ¡ *
__s
, 
__c
)

1411 
__d0
, 
__d1
;

1412 *
__»s
;

1413 
__asm__
 
__vŞ©e__


1421 : "=d" (
__»s
), "=&S" (
__d0
), "=&a" (
__d1
)

1422 : "0" (1), "1" (
__s
), "2" (
__c
),

1423 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1425  
__»s
 - 1;

1426 
	}
}

1428 
__STRING_INLINE
 *
__¡¼chr_g
 (cÚ¡ *
__s
, 
__c
);

1430 
__STRING_INLINE
 *

1431 
	$__¡¼chr_g
 (cÚ¡ *
__s
, 
__c
)

1433 
__d0
, 
__d1
;

1434 *
__»s
;

1435 
__asm__
 
__vŞ©e__


1444 : "=d" (
__»s
), "=&S" (
__d0
), "=&a" (
__d1
)

1445 : "0" (1), "1" (
__s
), "2" (
__c
),

1446 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1448  
__»s
 - 1;

1449 
	}
}

1451 
__STRING_INLINE
 *
__¡¼chr_c
 (cÚ¡ *
__s
, 
__c
);

1453 
__STRING_INLINE
 *

1454 
	$__¡¼chr_c
 (cÚ¡ *
__s
, 
__c
)

1456 
__d0
, 
__d1
;

1457 *
__»s
;

1458 
__asm__
 
__vŞ©e__


1468 : "=d" (
__»s
), "=&S" (
__d0
), "=&a" (
__d1
)

1469 : "0" (0), "1" (
__s
), "2" (
__c
),

1470 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1472  
__»s
;

1473 
	}
}

1475 
__STRING_INLINE
 *
__¡¼chr_g
 (cÚ¡ *
__s
, 
__c
);

1477 
__STRING_INLINE
 *

1478 
	$__¡¼chr_g
 (cÚ¡ *
__s
, 
__c
)

1480 
__d0
, 
__d1
;

1481 *
__»s
;

1482 
__asm__
 
__vŞ©e__


1493 : "ô" (
__»s
), "=&S" (
__d0
), "=&a" (
__d1
)

1494 : "0" (0), "1" (
__s
), "2" (
__c
),

1495 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1497  
__»s
;

1498 
	}
}

1502 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


1504 
	#_HAVE_STRING_ARCH_ršdex
 1

	)

1505 
	#ršdex
(
s
, 
c
) \

1506 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) \

1507 ? 
	`__¡¼chr_c
 ((
s
), ((
c
) & 0xff) << 8) \

1508 : 
	`__¡¼chr_g
 ((
s
), (
c
))))

	)

1514 
	#_HAVE_STRING_ARCH_¡rc¥n
 1

	)

1515 
	#¡rc¥n
(
s
, 
»jeù
) \

1516 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
»jeù
) &&  ((reject)[0]) == 1 \

1517 ? ((
»jeù
)[0] == '\0' \

1518 ? 
	`¡¾’
 (
s
) \

1519 : ((
»jeù
)[1] == '\0' \

1520 ? 
	`__¡rc¥n_c1
 ((
s
), (((
»jeù
)[0] << 8) & 0xff00)) \

1521 : 
	`__¡rc¥n_cg
 ((
s
), (
»jeù
), 
	`¡¾’
 (reject)))) \

1522 : 
	`__¡rc¥n_g
 ((
s
), (
»jeù
))))

	)

1524 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c1
 (cÚ¡ *
__s
, 
__»jeù
);

1526 #iâdeà
_FORCE_INLINES


1527 
__STRING_INLINE
 
size_t


1528 
	$__¡rc¥n_c1
 (cÚ¡ *
__s
, 
__»jeù
)

1530 
__d0
;

1531 *
__»s
;

1532 
__asm__
 
__vŞ©e__


1541 : "ô" (
__»s
), "=&a" (
__d0
)

1542 : "0" (
__s
), "1" (
__»jeù
),

1543 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1545  (
__»s
 - 1è- 
__s
;

1546 
	}
}

1549 
__STRING_INLINE
 
size_t
 
__¡rc¥n_cg
 (cÚ¡ *
__s
, cÚ¡ 
__»jeù
[],

1550 
size_t
 
__»jeù_Ën
);

1552 
__STRING_INLINE
 
size_t


1553 
	$__¡rc¥n_cg
 (cÚ¡ *
__s
, cÚ¡ 
__»jeù
[], 
size_t
 
__»jeù_Ën
)

1555 
__d0
, 
__d1
, 
__d2
;

1556 cÚ¡ *
__»s
;

1557 
__asm__
 
__vŞ©e__


1568 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1569 : "0" (
__s
), "d" (
__»jeù
), "g" (
__»jeù_Ën
)

1571  (
__»s
 - 1è- 
__s
;

1572 
	}
}

1574 
__STRING_INLINE
 
size_t
 
__¡rc¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
);

1575 #ifdeà
__PIC__


1577 
__STRING_INLINE
 
size_t


1578 
	$__¡rc¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

1580 
__d0
, 
__d1
, 
__d2
;

1581 cÚ¡ *
__»s
;

1582 
__asm__
 
__vŞ©e__


1599 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1600 : "r" (
__»jeù
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1602  (
__»s
 - 1è- 
__s
;

1603 
	}
}

1605 
__STRING_INLINE
 
size_t


1606 
	$__¡rc¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

1608 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1609 cÚ¡ *
__»s
;

1610 
__asm__
 
__vŞ©e__


1624 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1625 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__»jeù
), "b" (__reject)

1628  (
__»s
 - 1è- 
__s
;

1629 
	}
}

1635 
	#_HAVE_STRING_ARCH_¡r¥n
 1

	)

1636 
	#¡r¥n
(
s
, 
acû±
) \

1637 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
acû±
) &&  ((accept)[0]) == 1 \

1638 ? ((
acû±
)[0] == '\0' \

1639 ? ((è(
s
), 0) \

1640 : ((
acû±
)[1] == '\0' \

1641 ? 
	`__¡r¥n_c1
 ((
s
), (((
acû±
)[0] << 8 ) & 0xff00)) \

1642 : 
	`__¡r¥n_cg
 ((
s
), (
acû±
), 
	`¡¾’
 (accept)))) \

1643 : 
	`__¡r¥n_g
 ((
s
), (
acû±
))))

	)

1645 #iâdeà
_FORCE_INLINES


1646 
__STRING_INLINE
 
size_t
 
__¡r¥n_c1
 (cÚ¡ *
__s
, 
__acû±
);

1648 
__STRING_INLINE
 
size_t


1649 
	$__¡r¥n_c1
 (cÚ¡ *
__s
, 
__acû±
)

1651 
__d0
;

1652 *
__»s
;

1654 
__asm__
 
__vŞ©e__


1660 : "ô" (
__»s
), "=&q" (
__d0
)

1661 : "0" (
__s
), "1" (
__acû±
),

1662 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
)

1664  (
__»s
 - 1è- 
__s
;

1665 
	}
}

1668 
__STRING_INLINE
 
size_t
 
__¡r¥n_cg
 (cÚ¡ *
__s
, cÚ¡ 
__acû±
[],

1669 
size_t
 
__acû±_Ën
);

1671 
__STRING_INLINE
 
size_t


1672 
	$__¡r¥n_cg
 (cÚ¡ *
__s
, cÚ¡ 
__acû±
[], 
size_t
 
__acû±_Ën
)

1674 
__d0
, 
__d1
, 
__d2
;

1675 cÚ¡ *
__»s
;

1676 
__asm__
 
__vŞ©e__


1687 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1688 : "0" (
__s
), "g" (
__acû±
), "g" (
__acû±_Ën
),

1691 "m" ( *(¡ruù { 
__x
[0xfffffff]; } *)
__s
),

1692 "m" ( *(¡ruù { 
__ex‹nsiÚ__
 
__x
[
__acû±_Ën
]; } *)
__acû±
)

1694  (
__»s
 - 1è- 
__s
;

1695 
	}
}

1697 
__STRING_INLINE
 
size_t
 
__¡r¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
);

1698 #ifdeà
__PIC__


1700 
__STRING_INLINE
 
size_t


1701 
	$__¡r¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

1703 
__d0
, 
__d1
, 
__d2
;

1704 cÚ¡ *
__»s
;

1705 
__asm__
 
__vŞ©e__


1721 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1722 : "d" (
__acû±
), "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (__accept)

1724  (
__»s
 - 1è- 
__s
;

1725 
	}
}

1727 
__STRING_INLINE
 
size_t


1728 
	$__¡r¥n_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

1730 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1731 cÚ¡ *
__»s
;

1732 
__asm__
 
__vŞ©e__


1746 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1747 : "0" (
__s
), "1" (0), "2" (0xffffffff), "3" (
__acû±
), "b" (__accept)

1749  (
__»s
 - 1è- 
__s
;

1750 
	}
}

1755 
	#_HAVE_STRING_ARCH_¡½brk
 1

	)

1756 
	#¡½brk
(
s
, 
acû±
) \

1757 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
acû±
) &&  ((accept)[0]) == 1 \

1758 ? ((
acû±
)[0] == '\0' \

1759 ? ((è(
s
), (*) 0) \

1760 : ((
acû±
)[1] == '\0' \

1761 ? 
	`¡rchr
 ((
s
), (
acû±
)[0]) \

1762 : 
	`__¡½brk_cg
 ((
s
), (
acû±
), 
	`¡¾’
 (accept)))) \

1763 : 
	`__¡½brk_g
 ((
s
), (
acû±
))))

	)

1765 
__STRING_INLINE
 *
__¡½brk_cg
 (cÚ¡ *
__s
, cÚ¡ 
__acû±
[],

1766 
size_t
 
__acû±_Ën
);

1768 
__STRING_INLINE
 *

1769 
	$__¡½brk_cg
 (cÚ¡ *
__s
, cÚ¡ 
__acû±
[], 
size_t
 
__acû±_Ën
)

1771 
__d0
, 
__d1
, 
__d2
;

1772 *
__»s
;

1773 
__asm__
 
__vŞ©e__


1788 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1789 : "0" (
__s
), "d" (
__acû±
), "g" (
__acû±_Ën
)

1791  
__»s
;

1792 
	}
}

1794 
__STRING_INLINE
 *
__¡½brk_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
);

1795 #ifdeà
__PIC__


1797 
__STRING_INLINE
 *

1798 
	$__¡½brk_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

1800 
__d0
, 
__d1
, 
__d2
;

1801 *
__»s
;

1802 
__asm__
 
__vŞ©e__


1823 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&D" (
__d2
)

1824 : "d" (
__acû±
), "0" (
__s
), "1" (0), "2" (0xffffffff)

1826  
__»s
;

1827 
	}
}

1829 
__STRING_INLINE
 *

1830 
	$__¡½brk_g
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

1832 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1833 *
__»s
;

1834 
__asm__
 
__vŞ©e__


1853 : "=S" (
__»s
), "=&a" (
__d0
), "=&c" (
__d1
), "=&d" (
__d2
), "=&D" (
__d3
)

1854 : "0" (
__s
), "1" (0), "2" (0xffffffff), "b" (
__acû±
)

1856  
__»s
;

1857 
	}
}

1862 
	#_HAVE_STRING_ARCH_¡r¡r
 1

	)

1863 
	#¡r¡r
(
hay¡ack
, 
ÃedË
) \

1864 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
ÃedË
) &&  ((needle)[0]) == 1 \

1865 ? ((
ÃedË
)[0] == '\0' \

1866 ? (
hay¡ack
) \

1867 : ((
ÃedË
)[1] == '\0' \

1868 ? 
	`¡rchr
 ((
hay¡ack
), (
ÃedË
)[0]) \

1869 : 
	`__¡r¡r_cg
 ((
hay¡ack
), (
ÃedË
), \

1870 
	`¡¾’
 (
ÃedË
)))) \

1871 : 
	`__¡r¡r_g
 ((
hay¡ack
), (
ÃedË
))))

	)

1875 
__STRING_INLINE
 *
__¡r¡r_cg
 (cÚ¡ *
__hay¡ack
,

1876 cÚ¡ 
__ÃedË
[],

1877 
size_t
 
__ÃedË_Ën
);

1879 
__STRING_INLINE
 *

1880 
	$__¡r¡r_cg
 (cÚ¡ *
__hay¡ack
, cÚ¡ 
__ÃedË
[],

1881 
size_t
 
__ÃedË_Ën
)

1883 
__d0
, 
__d1
, 
__d2
;

1884 *
__»s
;

1885 
__asm__
 
__vŞ©e__


1898 : "=&a" (
__»s
), "=&S" (
__d0
), "=&D" (
__d1
), "=&c" (
__d2
)

1899 : "g" (
__ÃedË_Ën
), "1" (
__hay¡ack
), "d" (
__ÃedË
)

1901  
__»s
;

1902 
	}
}

1904 
__STRING_INLINE
 *
__¡r¡r_g
 (cÚ¡ *
__hay¡ack
,

1905 cÚ¡ *
__ÃedË
);

1906 #ifdeà
__PIC__


1908 
__STRING_INLINE
 *

1909 
	$__¡r¡r_g
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

1911 
__d0
, 
__d1
, 
__d2
;

1912 *
__»s
;

1913 
__asm__
 
__vŞ©e__


1932 : "=&a" (
__»s
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
)

1933 : "0" (0), "1" (0xffffffff), "2" (
__hay¡ack
), "3" (
__ÃedË
),

1934 "d" (
__ÃedË
)

1936  
__»s
;

1937 
	}
}

1939 
__STRING_INLINE
 *

1940 
	$__¡r¡r_g
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

1942 
__d0
, 
__d1
, 
__d2
, 
__d3
;

1943 *
__»s
;

1944 
__asm__
 
__vŞ©e__


1961 : "=&a" (
__»s
), "=&c" (
__d0
), "=&S" (
__d1
), "=&D" (
__d2
), "=&d" (
__d3
)

1962 : "0" (0), "1" (0xffffffff), "2" (
__hay¡ack
), "3" (
__ÃedË
),

1963 "b" (
__ÃedË
)

1965  
__»s
;

1966 
	}
}

1972 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


1973 #ifdeà
__i686__


1974 
	#_HAVE_STRING_ARCH_ffs
 1

	)

1975 
	#ffs
(
wÜd
è(
	`__butš_cÚ¡ªt_p
 (word) \

1976 ? 
	`__butš_ffs
 (
wÜd
) \

1977 : ({ 
__út
, 
__tmp
; \

1978 
__asm__
 
__vŞ©e__
 \

1981 : "=&r" (
__út
), "ô" (
__tmp
) \

1982 : "rm" (
wÜd
), "1" (-1)); \

1983 
__út
 + 1; }))

	)

1985 #iâdeà
ff¦


1986 
	#ff¦
(
wÜd
è
	`ffs
(wÜd)

	)

1991 #iâdeà
_FORCE_INLINES


1992 #undeà
__STRING_INLINE


	@/usr/include/bits/string2.h

20 #iâdeà
_STRING_H


24 #iâdeà
__NO_STRING_INLINES


41 #iâdeà
__STRING_INLINE


42 #ifdeà
__ılu¥lus


43 
	#__STRING_INLINE
 
šlše


	)

45 
	#__STRING_INLINE
 
__ex‹º_šlše


	)

49 #ià
_STRING_INLINE_uÇligÃd


51 
	~<’dŸn.h
>

52 
	~<b™s/ty³s.h
>

54 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


55 
	#__STRING2_SMALL_GET16
(
¤c
, 
idx
) \

56 (((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 1] << 8 \

57 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
])

	)

58 
	#__STRING2_SMALL_GET32
(
¤c
, 
idx
) \

59 (((((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 3] << 8 \

60 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 2]) << 8 \

61 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 1]) << 8 \

62 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
])

	)

64 
	#__STRING2_SMALL_GET16
(
¤c
, 
idx
) \

65 (((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
] << 8 \

66 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 1])

	)

67 
	#__STRING2_SMALL_GET32
(
¤c
, 
idx
) \

68 (((((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
] << 8 \

69 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 1]) << 8 \

70 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 2]) << 8 \

71 | ((cÚ¡ *è(cÚ¡ *è(
¤c
))[
idx
 + 3])

	)

76 
	#__STRING2_COPY_TYPE
(
N
) \

77 ¡ruù { 
__¬r
[
N
]; } \

78 
	t__©Œibu‹__
 ((
	t__·cked__
)è
	t__STRING2_COPY_ARR
##
	tN


	)

79 
	t__STRING2_COPY_TYPE
 (2);

80 
__STRING2_COPY_TYPE
 (3);

81 
__STRING2_COPY_TYPE
 (4);

82 
__STRING2_COPY_TYPE
 (5);

83 
__STRING2_COPY_TYPE
 (6);

84 
__STRING2_COPY_TYPE
 (7);

85 
__STRING2_COPY_TYPE
 (8);

86 #undeà
__STRING2_COPY_TYPE


92 
	#__¡ršg2_1b±r_p
(
__x
) \

93 ((
size_t
)(cÚ¡ *)((
__x
è+ 1è- (size_t)(cÚ¡ *)(__xè=ğ1)

	)

96 #ià!
defšed
 
_HAVE_STRING_ARCH_mem£t


97 #ià!
__GNUC_PREREQ
 (3, 0)

98 #ià
_STRING_INLINE_uÇligÃd


99 
	#mem£t
(
s
, 
c
, 
n
) \

100 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) && (n) <= 16 \

101 ? ((
n
) == 1 \

102 ? 
	`__mem£t_1
 (
s
, 
c
) \

103 : 
	`__mem£t_gc
 (
s
, 
c
, 
n
)) \

104 : (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

105 ? ({ *
__s
 = (
s
); 
	`__bz”o
 (__s, 
n
); __s; }) \

106 : 
	`mem£t
 (
s
, 
c
, 
n
))))

	)

108 
	#__mem£t_1
(
s
, 
c
è({ *
__s
 = (s); \

109 *((
__ušt8_t
 *è
__s
èğ(__ušt8_tè
c
; __s; })

	)

111 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

112 ({ *
__s
 = (
s
); \

114 
__ui
; \

115 
__usi
; \

116 
__uc
; \

117 } *
__u
 = 
__s
; \

118 
__ušt8_t
 
__c
 = (__ušt8_tè(
c
); \

121 (è(
n
)) \

124 
__u
->
__ui
 = 
__c
 * 0x01010101; \

125 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

127 
__u
->
__ui
 = 
__c
 * 0x01010101; \

128 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

130 
__u
->
__ui
 = 
__c
 * 0x01010101; \

131 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

133 
__u
->
__usi
 = (è
__c
 * 0x0101; \

134 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

135 
__u
->
__uc
 = (è
__c
; \

139 
__u
->
__ui
 = 
__c
 * 0x01010101; \

140 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

142 
__u
->
__ui
 = 
__c
 * 0x01010101; \

143 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

145 
__u
->
__ui
 = 
__c
 * 0x01010101; \

146 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

148 
__u
->
__usi
 = (è
__c
 * 0x0101; \

152 
__u
->
__ui
 = 
__c
 * 0x01010101; \

153 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

155 
__u
->
__ui
 = 
__c
 * 0x01010101; \

156 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

158 
__u
->
__ui
 = 
__c
 * 0x01010101; \

159 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

161 
__u
->
__uc
 = (è
__c
; \

165 
__u
->
__ui
 = 
__c
 * 0x01010101; \

166 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

168 
__u
->
__ui
 = 
__c
 * 0x01010101; \

169 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

171 
__u
->
__ui
 = 
__c
 * 0x01010101; \

172 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

174 
__u
->
__ui
 = 
__c
 * 0x01010101; \

179 
__s
; })

	)

181 
	#mem£t
(
s
, 
c
, 
n
) \

182 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

183 ? ({ *
__s
 = (
s
); 
	`__bz”o
 (__s, 
n
); __s; }) \

184 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

193 #ià
__GNUC_PREREQ
 (2, 91)

194 
	#__bz”o
(
s
, 
n
è
	`__butš_mem£t
 (s, '\0',‚)

	)

202 #ifdeà
__USE_GNU


203 #ià!
defšed
 
_HAVE_STRING_ARCH_mempıy
 || defšed 
_FORCE_INLINES


204 #iâdeà
_HAVE_STRING_ARCH_mempıy


205 #ià
__GNUC_PREREQ
 (3, 4)

206 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__butš_mempıy
 (de¡, src,‚)

	)

207 #–ià
__GNUC_PREREQ
 (3, 0)

208 
	#__mempıy
(
de¡
, 
¤c
, 
n
) \

209 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

210 && 
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
n
 <= 8 \

211 ? 
	`__butš_memıy
 (
de¡
, 
¤c
, 
n
) + (n) \

212 : 
	`__mempıy
 (
de¡
, 
¤c
, 
n
)))

	)

214 
	#__mempıy
(
de¡
, 
¤c
, 
n
) \

215 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

216 && 
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
n
 <= 8 \

217 ? 
	`__mempıy_sm®l
 (
de¡
, 
	`__mempıy_¬gs
 (
¤c
), 
n
) \

218 : 
	`__mempıy
 (
de¡
, 
¤c
, 
n
)))

	)

222 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy
 (de¡, src,‚)

	)

225 #ià!
__GNUC_PREREQ
 (3, 0è|| 
defšed
 
_FORCE_INLINES


226 #ià
_STRING_INLINE_uÇligÃd


227 #iâdeà
_FORCE_INLINES


228 
	#__mempıy_¬gs
(
¤c
) \

229 ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[2], \

230 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[6], \

231 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

232 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

233 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

234 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

236 
__STRING_INLINE
 *
__mempıy_sm®l
 (*, , , , ,

237 
__ušt16_t
, __ušt16_t, 
__ušt32_t
,

238 
__ušt32_t
, 
size_t
);

239 
__STRING_INLINE
 *

240 
	$__mempıy_sm®l
 (*
__de¡1
,

241 
__¤c0_1
, 
__¤c2_1
, 
__¤c4_1
, 
__¤c6_1
,

242 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

243 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

244 
size_t
 
__¤ş’
)

247 
__ušt32_t
 
__ui
;

248 
__ušt16_t
 
__usi
;

249 
__uc
;

250 
__c
;

251 } *
__u
 = 
__de¡1
;

252 (è
__¤ş’
)

255 
__u
->
__c
 = 
__¤c0_1
;

256 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

259 
__u
->
__usi
 = 
__¤c0_2
;

260 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

263 
__u
->
__usi
 = 
__¤c0_2
;

264 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

265 
__u
->
__c
 = 
__¤c2_1
;

266 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

269 
__u
->
__ui
 = 
__¤c0_4
;

270 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

273 
__u
->
__ui
 = 
__¤c0_4
;

274 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

275 
__u
->
__c
 = 
__¤c4_1
;

276 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

279 
__u
->
__ui
 = 
__¤c0_4
;

280 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

281 
__u
->
__usi
 = 
__¤c4_2
;

282 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

285 
__u
->
__ui
 = 
__¤c0_4
;

286 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

287 
__u
->
__usi
 = 
__¤c4_2
;

288 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

289 
__u
->
__c
 = 
__¤c6_1
;

290 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

293 
__u
->
__ui
 = 
__¤c0_4
;

294 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

295 
__u
->
__ui
 = 
__¤c4_4
;

296 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

299  (*è
__u
;

300 
	}
}

302 #iâdeà
_FORCE_INLINES


303 
	#__mempıy_¬gs
(
¤c
) \

304 ((cÚ¡ *è(
¤c
))[0], \

305 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

306 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1] } }), \

307 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

308 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

309 ((cÚ¡ *è(
¤c
))[2] } }), \

310 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

311 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

312 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3] } }), \

313 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

314 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

315 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

316 ((cÚ¡ *è(
¤c
))[4] } }), \

317 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

318 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

319 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

320 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5] } }), \

321 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

322 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

323 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

324 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

325 ((cÚ¡ *è(
¤c
))[6] } }), \

326 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

327 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

328 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

329 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

330 ((cÚ¡ *è(
¤c
))[6], ((cÚ¡ *è(¤c))[7] } })

	)

332 
__STRING_INLINE
 *
__mempıy_sm®l
 (*, , 
__STRING2_COPY_ARR2
,

333 
__STRING2_COPY_ARR3
,

334 
__STRING2_COPY_ARR4
,

335 
__STRING2_COPY_ARR5
,

336 
__STRING2_COPY_ARR6
,

337 
__STRING2_COPY_ARR7
,

338 
__STRING2_COPY_ARR8
, 
size_t
);

339 
__STRING_INLINE
 *

340 
	$__mempıy_sm®l
 (*
__de¡
, 
__¤c1
,

341 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

342 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

343 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

344 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

347 
__c
;

348 
__STRING2_COPY_ARR2
 
__sÿ2
;

349 
__STRING2_COPY_ARR3
 
__sÿ3
;

350 
__STRING2_COPY_ARR4
 
__sÿ4
;

351 
__STRING2_COPY_ARR5
 
__sÿ5
;

352 
__STRING2_COPY_ARR6
 
__sÿ6
;

353 
__STRING2_COPY_ARR7
 
__sÿ7
;

354 
__STRING2_COPY_ARR8
 
__sÿ8
;

355 } *
__u
 = 
__de¡
;

356 (è
__¤ş’
)

359 
__u
->
__c
 = 
__¤c1
;

362 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

365 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

368 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

371 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

374 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

377 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

380 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

383  
	`__ex‹nsiÚ__
 ((*è
__u
 + 
__¤ş’
);

384 
	}
}

392 #iâdeà
_HAVE_STRING_ARCH_¡rchr


393 *
__¿wmemchr
 (cÚ¡ *
__s
, 
__c
);

394 #ià
__GNUC_PREREQ
 (3, 2)

395 
	#¡rchr
(
s
, 
c
) \

396 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
è&& !__butš_cÚ¡ªt_°(
s
) \

397 && (
c
) == '\0' \

398 ? (*è
	`__¿wmemchr
 (
s
, 
c
) \

399 : 
	`__butš_¡rchr
 (
s
, 
c
)))

	)

401 
	#¡rchr
(
s
, 
c
) \

402 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

403 ? (*è
	`__¿wmemchr
 (
s
, 
c
) \

404 : 
	`¡rchr
 (
s
, 
c
)))

	)

410 #ià(!
defšed
 
_HAVE_STRING_ARCH_¡rıy
 && !
__GNUC_PREREQ
 (3, 0)) \

411 || 
defšed
 
	g_FORCE_INLINES


412 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rıy
 && !
__GNUC_PREREQ
 (3, 0)

413 
	#¡rıy
(
de¡
, 
¤c
) \

414 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

415 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

416 ? 
	`__¡rıy_sm®l
 (
de¡
, 
	`__¡rıy_¬gs
 (
¤c
), \

417 
	`¡¾’
 (
¤c
) + 1) \

418 : (*è
	`memıy
 (
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1)) \

419 : 
	`¡rıy
 (
de¡
, 
¤c
)))

	)

422 #ià
_STRING_INLINE_uÇligÃd


423 #iâdeà
_FORCE_INLINES


424 
	#__¡rıy_¬gs
(
¤c
) \

425 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

426 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

427 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

428 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

430 
__STRING_INLINE
 *
__¡rıy_sm®l
 (*, 
__ušt16_t
, __uint16_t,

431 
__ušt32_t
, __ušt32_t, 
size_t
);

432 
__STRING_INLINE
 *

433 
	$__¡rıy_sm®l
 (*
__de¡
,

434 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

435 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

436 
size_t
 
__¤ş’
)

439 
__ušt32_t
 
__ui
;

440 
__ušt16_t
 
__usi
;

441 
__uc
;

442 } *
__u
 = (*è
__de¡
;

443 (è
__¤ş’
)

446 
__u
->
__uc
 = '\0';

449 
__u
->
__usi
 = 
__¤c0_2
;

452 
__u
->
__usi
 = 
__¤c0_2
;

453 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

454 
__u
->
__uc
 = '\0';

457 
__u
->
__ui
 = 
__¤c0_4
;

460 
__u
->
__ui
 = 
__¤c0_4
;

461 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

462 
__u
->
__uc
 = '\0';

465 
__u
->
__ui
 = 
__¤c0_4
;

466 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

467 
__u
->
__usi
 = 
__¤c4_2
;

470 
__u
->
__ui
 = 
__¤c0_4
;

471 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

472 
__u
->
__usi
 = 
__¤c4_2
;

473 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

474 
__u
->
__uc
 = '\0';

477 
__u
->
__ui
 = 
__¤c0_4
;

478 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

479 
__u
->
__ui
 = 
__¤c4_4
;

482  
__de¡
;

483 
	}
}

485 #iâdeà
_FORCE_INLINES


486 
	#__¡rıy_¬gs
(
¤c
) \

487 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

488 { { ((cÚ¡ *è(
¤c
))[0], '\0' } }), \

489 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

490 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

492 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

493 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

494 ((cÚ¡ *è(
¤c
))[2], '\0' } }), \

495 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

496 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

497 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

499 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

500 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

501 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

502 ((cÚ¡ *è(
¤c
))[4], '\0' } }), \

503 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

504 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

505 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

506 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

508 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

509 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

510 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

511 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

512 ((cÚ¡ *è(
¤c
))[6], '\0' } })

	)

514 
__STRING_INLINE
 *
__¡rıy_sm®l
 (*, 
__STRING2_COPY_ARR2
,

515 
__STRING2_COPY_ARR3
,

516 
__STRING2_COPY_ARR4
,

517 
__STRING2_COPY_ARR5
,

518 
__STRING2_COPY_ARR6
,

519 
__STRING2_COPY_ARR7
,

520 
__STRING2_COPY_ARR8
, 
size_t
);

521 
__STRING_INLINE
 *

522 
	$__¡rıy_sm®l
 (*
__de¡
,

523 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

524 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

525 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

526 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

529 
__c
;

530 
__STRING2_COPY_ARR2
 
__sÿ2
;

531 
__STRING2_COPY_ARR3
 
__sÿ3
;

532 
__STRING2_COPY_ARR4
 
__sÿ4
;

533 
__STRING2_COPY_ARR5
 
__sÿ5
;

534 
__STRING2_COPY_ARR6
 
__sÿ6
;

535 
__STRING2_COPY_ARR7
 
__sÿ7
;

536 
__STRING2_COPY_ARR8
 
__sÿ8
;

537 } *
__u
 = (*è
__de¡
;

538 (è
__¤ş’
)

541 
__u
->
__c
 = '\0';

544 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

547 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

550 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

553 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

556 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

559 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

562 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

565  
__de¡
;

566 
	}
}

572 #ifdeà
__USE_GNU


573 #ià!
defšed
 
_HAVE_STRING_ARCH_¡pıy
 || defšed 
_FORCE_INLINES


574 #iâdeà
_HAVE_STRING_ARCH_¡pıy


575 #ià
__GNUC_PREREQ
 (3, 4)

576 
	#__¡pıy
(
de¡
, 
¤c
è
	`__butš_¡pıy
 (de¡, src)

	)

577 #–ià
__GNUC_PREREQ
 (3, 0)

578 
	#__¡pıy
(
de¡
, 
¤c
) \

579 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

580 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

581 ? 
	`__butš_¡rıy
 (
de¡
, 
¤c
è+ 
	`¡¾’
 (src) \

582 : ((*è(
__mempıy
è(
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1) \

584 : 
	`__¡pıy
 (
de¡
, 
¤c
)))

	)

586 
	#__¡pıy
(
de¡
, 
¤c
) \

587 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

588 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

589 ? 
	`__¡pıy_sm®l
 (
de¡
, 
	`__¡pıy_¬gs
 (
¤c
), \

590 
	`¡¾’
 (
¤c
) + 1) \

591 : ((*è(
__mempıy
è(
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1) \

593 : 
	`__¡pıy
 (
de¡
, 
¤c
)))

	)

597 
	#¡pıy
(
de¡
, 
¤c
è
	`__¡pıy
 (de¡, src)

	)

600 #ià!
__GNUC_PREREQ
 (3, 0è|| 
defšed
 
_FORCE_INLINES


601 #ià
_STRING_INLINE_uÇligÃd


602 #iâdeà
_FORCE_INLINES


603 
	#__¡pıy_¬gs
(
¤c
) \

604 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

605 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

606 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

607 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

609 
__STRING_INLINE
 *
__¡pıy_sm®l
 (*, 
__ušt16_t
, __uint16_t,

610 
__ušt32_t
, __ušt32_t, 
size_t
);

611 
__STRING_INLINE
 *

612 
	$__¡pıy_sm®l
 (*
__de¡
,

613 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

614 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

615 
size_t
 
__¤ş’
)

618 
__ui
;

619 
__usi
;

620 
__uc
;

621 
__c
;

622 } *
__u
 = (*è
__de¡
;

623 (è
__¤ş’
)

626 
__u
->
__uc
 = '\0';

629 
__u
->
__usi
 = 
__¤c0_2
;

630 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

633 
__u
->
__usi
 = 
__¤c0_2
;

634 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

635 
__u
->
__uc
 = '\0';

638 
__u
->
__ui
 = 
__¤c0_4
;

639 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3);

642 
__u
->
__ui
 = 
__¤c0_4
;

643 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

644 
__u
->
__uc
 = '\0';

647 
__u
->
__ui
 = 
__¤c0_4
;

648 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

649 
__u
->
__usi
 = 
__¤c4_2
;

650 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

653 
__u
->
__ui
 = 
__¤c0_4
;

654 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

655 
__u
->
__usi
 = 
__¤c4_2
;

656 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

657 
__u
->
__uc
 = '\0';

660 
__u
->
__ui
 = 
__¤c0_4
;

661 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

662 
__u
->
__ui
 = 
__¤c4_4
;

663 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3);

666  &
__u
->
__c
;

667 
	}
}

669 #iâdeà
_FORCE_INLINES


670 
	#__¡pıy_¬gs
(
¤c
) \

671 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

672 { { ((cÚ¡ *è(
¤c
))[0], '\0' } }), \

673 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

674 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

676 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

677 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

678 ((cÚ¡ *è(
¤c
))[2], '\0' } }), \

679 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

680 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

681 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

683 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

684 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

685 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

686 ((cÚ¡ *è(
¤c
))[4], '\0' } }), \

687 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

688 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

689 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

690 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

692 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

693 { { ((cÚ¡ *è(
¤c
))[0], ((const *) (src))[1], \

694 ((cÚ¡ *è(
¤c
))[2], ((const *) (src))[3], \

695 ((cÚ¡ *è(
¤c
))[4], ((const *) (src))[5], \

696 ((cÚ¡ *è(
¤c
))[6], '\0' } })

	)

698 
__STRING_INLINE
 *
__¡pıy_sm®l
 (*, 
__STRING2_COPY_ARR2
,

699 
__STRING2_COPY_ARR3
,

700 
__STRING2_COPY_ARR4
,

701 
__STRING2_COPY_ARR5
,

702 
__STRING2_COPY_ARR6
,

703 
__STRING2_COPY_ARR7
,

704 
__STRING2_COPY_ARR8
, 
size_t
);

705 
__STRING_INLINE
 *

706 
	$__¡pıy_sm®l
 (*
__de¡
,

707 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

708 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

709 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

710 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

713 
__c
;

714 
__STRING2_COPY_ARR2
 
__sÿ2
;

715 
__STRING2_COPY_ARR3
 
__sÿ3
;

716 
__STRING2_COPY_ARR4
 
__sÿ4
;

717 
__STRING2_COPY_ARR5
 
__sÿ5
;

718 
__STRING2_COPY_ARR6
 
__sÿ6
;

719 
__STRING2_COPY_ARR7
 
__sÿ7
;

720 
__STRING2_COPY_ARR8
 
__sÿ8
;

721 } *
__u
 = (*è
__de¡
;

722 (è
__¤ş’
)

725 
__u
->
__c
 = '\0';

728 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

731 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

734 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

737 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

740 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

743 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

746 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

749  
__de¡
 + 
__¤ş’
 - 1;

750 
	}
}

758 #iâdeà
_HAVE_STRING_ARCH_¡ºıy


759 #ià
__GNUC_PREREQ
 (3, 2)

760 
	#¡ºıy
(
de¡
, 
¤c
, 
n
è
	`__butš_¡ºıy
 (de¡, src,‚)

	)

762 
	#¡ºıy
(
de¡
, 
¤c
, 
n
) \

763 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

764 ? (
	`¡¾’
 (
¤c
è+ 1 >ğ((
size_t
è(
n
)) \

765 ? (*è
	`memıy
 (
de¡
, 
¤c
, 
n
) \

766 : 
	`¡ºıy
 (
de¡
, 
¤c
, 
n
)) \

767 : 
	`¡ºıy
 (
de¡
, 
¤c
, 
n
)))

	)

773 #iâdeà
_HAVE_STRING_ARCH_¡ºÿt


774 #ifdeà
_USE_STRING_ARCH_¡rchr


775 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
) \

776 (
	`__ex‹nsiÚ__
 ({ *
__de¡
 = (
de¡
); \

777 
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

778 ? (
	`¡¾’
 (
¤c
è< ((
size_t
è(
n
)) \

779 ? 
	`¡rÿt
 (
__de¡
, 
¤c
) \

780 : (*((*è
	`__mempıy
 (
	`¡rchr
 (
__de¡
, '\0'), \

781 
¤c
, 
n
)èğ'\0', 
__de¡
)) \

782 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
); }))

	)

783 #–ià
__GNUC_PREREQ
 (3, 2)

784 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
è
	`__butš_¡ºÿt
 (de¡, src,‚)

	)

786 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
) \

787 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

788 ? (
	`¡¾’
 (
¤c
è< ((
size_t
è(
n
)) \

789 ? 
	`¡rÿt
 (
de¡
, 
¤c
) \

790 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
)) \

791 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
)))

	)

797 #iâdeà
_HAVE_STRING_ARCH_¡rcmp


798 #ià
__GNUC_PREREQ
 (3, 2)

799 
	#¡rcmp
(
s1
, 
s2
) \

800 
__ex‹nsiÚ__
 \

801 ({ 
size_t
 
__s1_Ën
, 
__s2_Ën
; \

802 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& __butš_cÚ¡ªt_°(
s2
) \

803 && (
__s1_Ën
 = 
	`__butš_¡¾’
 (
s1
), 
__s2_Ën
 = __butš_¡¾’ (
s2
), \

804 (!
	`__¡ršg2_1b±r_p
 (
s1
è|| 
__s1_Ën
 >= 4) \

805 && (!
	`__¡ršg2_1b±r_p
 (
s2
è|| 
__s2_Ën
 >= 4)) \

806 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

807 : (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

808 && (
__s1_Ën
 = 
	`__butš_¡¾’
 (
s1
), __s1_len < 4) \

809 ? (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

810 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

811 : 
	`__¡rcmp_cg
 (
s1
, 
s2
, 
__s1_Ën
)) \

812 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

813 && (
__s2_Ën
 = 
	`__butš_¡¾’
 (
s2
), __s2_len < 4) \

814 ? (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

815 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

816 : 
	`__¡rcmp_gc
 (
s1
, 
s2
, 
__s2_Ën
)) \

817 : 
	`__butš_¡rcmp
 (
s1
, 
s2
)))); })

	)

819 
	#¡rcmp
(
s1
, 
s2
) \

820 
__ex‹nsiÚ__
 \

821 ({ 
size_t
 
__s1_Ën
, 
__s2_Ën
; \

822 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& __butš_cÚ¡ªt_°(
s2
) \

823 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), 
__s2_Ën
 = sŒËÀ(
s2
), \

824 (!
	`__¡ršg2_1b±r_p
 (
s1
è|| 
__s1_Ën
 >= 4) \

825 && (!
	`__¡ršg2_1b±r_p
 (
s2
è|| 
__s2_Ën
 >= 4)) \

826 ? 
	`memcmp
 ((cÚ¡ *è(
s1
), (cÚ¡ *è(
s2
), \

827 (
__s1_Ën
 < 
__s2_Ën
 ? __s1_len : __s2_len) + 1) \

828 : (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

829 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), __s1_len < 4) \

830 ? (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

831 ? 
	`__¡rcmp_cc
 (
s1
, 
s2
, 
__s1_Ën
) \

832 : 
	`__¡rcmp_cg
 (
s1
, 
s2
, 
__s1_Ën
)) \

833 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

834 && (
__s2_Ën
 = 
	`¡¾’
 (
s2
), __s2_len < 4) \

835 ? (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

836 ? 
	`__¡rcmp_cc
 (
s1
, 
s2
, 
__s2_Ën
) \

837 : 
	`__¡rcmp_gc
 (
s1
, 
s2
, 
__s2_Ën
)) \

838 : 
	`¡rcmp
 (
s1
, 
s2
)))); })

	)

841 
	#__¡rcmp_cc
(
s1
, 
s2
, 
l
) \

842 (
	`__ex‹nsiÚ__
 ({ 
__»suÉ
 = \

843 (((cÚ¡ *è(cÚ¡ *è(
s1
))[0] \

844 - ((cÚ¡ *è(cÚ¡ *)(
s2
))[0]); \

845 ià(
l
 > 0 && 
__»suÉ
 == 0) \

847 
__»suÉ
 = (((const *) \

848 (cÚ¡ *è(
s1
))[1] \

850 (cÚ¡ *è(
s2
))[1]); \

851 ià(
l
 > 1 && 
__»suÉ
 == 0) \

853 
__»suÉ
 = \

855 (cÚ¡ *è(
s1
))[2] \

857 (cÚ¡ *è(
s2
))[2]); \

858 ià(
l
 > 2 && 
__»suÉ
 == 0) \

859 
__»suÉ
 = \

861 (cÚ¡ *è(
s1
))[3] \

863 (cÚ¡ *è(
s2
))[3]); \

866 
__»suÉ
; }))

	)

868 
	#__¡rcmp_cg
(
s1
, 
s2
, 
l1
) \

869 (
	`__ex‹nsiÚ__
 ({ cÚ¡ *
__s2
 = \

870 (cÚ¡ *è(cÚ¡ *è(
s2
); \

871 
__»suÉ
 = \

872 (((cÚ¡ *è(cÚ¡ *è(
s1
))[0] \

873 - 
__s2
[0]); \

874 ià(
l1
 > 0 && 
__»suÉ
 == 0) \

876 
__»suÉ
 = (((const *) \

877 (cÚ¡ *è(
s1
))[1] - 
__s2
[1]); \

878 ià(
l1
 > 1 && 
__»suÉ
 == 0) \

880 
__»suÉ
 = (((const *) \

881 (cÚ¡ *è(
s1
))[2] - 
__s2
[2]); \

882 ià(
l1
 > 2 && 
__»suÉ
 == 0) \

883 
__»suÉ
 = (((const *) \

884 (cÚ¡ *è(
s1
))[3] \

885 - 
__s2
[3]); \

888 
__»suÉ
; }))

	)

890 
	#__¡rcmp_gc
(
s1
, 
s2
, 
l2
è(- 
	`__¡rcmp_cg
 (s2, s1,†2))

	)

895 #iâdeà
_HAVE_STRING_ARCH_¡ºcmp


896 
	#¡ºcmp
(
s1
, 
s2
, 
n
) \

897 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) \

898 && ((
	`__butš_cÚ¡ªt_p
 (
s1
) \

899 && 
	`¡¾’
 (
s1
è< ((
size_t
è(
n
))) \

900 || (
	`__butš_cÚ¡ªt_p
 (
s2
) \

901 && 
	`¡¾’
 (
s2
è< ((
size_t
è(
n
)))) \

902 ? 
	`¡rcmp
 (
s1
, 
s2
è: 
	`¡ºcmp
 (s1, s2, 
n
)))

	)

908 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rc¥n
 || defšed 
_FORCE_INLINES


909 #iâdeà
_HAVE_STRING_ARCH_¡rc¥n


910 #ià
__GNUC_PREREQ
 (3, 2)

911 
	#¡rc¥n
(
s
, 
»jeù
) \

912 
__ex‹nsiÚ__
 \

913 ({ 
__r0
, 
__r1
, 
__r2
; \

914 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

915 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

916 ? 
	`__butš_¡rc¥n
 (
s
, 
»jeù
) \

917 : ((
__r0
 = ((cÚ¡ *è(
»jeù
))[0], __r0 == '\0') \

918 ? 
	`¡¾’
 (
s
) \

919 : ((
__r1
 = ((cÚ¡ *è(
»jeù
))[1], __r1 == '\0') \

920 ? 
	`__¡rc¥n_c1
 (
s
, 
__r0
) \

921 : ((
__r2
 = ((cÚ¡ *è(
»jeù
))[2], __r2 == '\0') \

922 ? 
	`__¡rc¥n_c2
 (
s
, 
__r0
, 
__r1
) \

923 : (((cÚ¡ *è(
»jeù
))[3] == '\0' \

924 ? 
	`__¡rc¥n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

925 : 
	`__butš_¡rc¥n
 (
s
, 
»jeù
)))))) \

926 : 
	`__butš_¡rc¥n
 (
s
, 
»jeù
)); })

	)

928 
	#¡rc¥n
(
s
, 
»jeù
) \

929 
__ex‹nsiÚ__
 \

930 ({ 
__r0
, 
__r1
, 
__r2
; \

931 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

932 ? ((
__r0
 = ((cÚ¡ *è(
»jeù
))[0], __r0 == '\0') \

933 ? 
	`¡¾’
 (
s
) \

934 : ((
__r1
 = ((cÚ¡ *è(
»jeù
))[1], __r1 == '\0') \

935 ? 
	`__¡rc¥n_c1
 (
s
, 
__r0
) \

936 : ((
__r2
 = ((cÚ¡ *è(
»jeù
))[2], __r2 == '\0') \

937 ? 
	`__¡rc¥n_c2
 (
s
, 
__r0
, 
__r1
) \

938 : (((cÚ¡ *è(
»jeù
))[3] == '\0' \

939 ? 
	`__¡rc¥n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

940 : 
	`¡rc¥n
 (
s
, 
»jeù
))))) \

941 : 
	`¡rc¥n
 (
s
, 
»jeù
)); })

	)

945 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c1
 (cÚ¡ *
__s
, 
__»jeù
);

946 
__STRING_INLINE
 
size_t


947 
	$__¡rc¥n_c1
 (cÚ¡ *
__s
, 
__»jeù
)

949 
size_t
 
__»suÉ
 = 0;

950 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù
)

951 ++
__»suÉ
;

952  
__»suÉ
;

953 
	}
}

955 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c2
 (cÚ¡ *
__s
, 
__»jeù1
,

956 
__»jeù2
);

957 
__STRING_INLINE
 
size_t


958 
	$__¡rc¥n_c2
 (cÚ¡ *
__s
, 
__»jeù1
, 
__»jeù2
)

960 
size_t
 
__»suÉ
 = 0;

961 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù1


962 && 
__s
[
__»suÉ
] !ğ
__»jeù2
)

963 ++
__»suÉ
;

964  
__»suÉ
;

965 
	}
}

967 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c3
 (cÚ¡ *
__s
, 
__»jeù1
,

968 
__»jeù2
, 
__»jeù3
);

969 
__STRING_INLINE
 
size_t


970 
	$__¡rc¥n_c3
 (cÚ¡ *
__s
, 
__»jeù1
, 
__»jeù2
,

971 
__»jeù3
)

973 
size_t
 
__»suÉ
 = 0;

974 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù1


975 && 
__s
[
__»suÉ
] !ğ
__»jeù2
 && __s[__»suÉ] !ğ
__»jeù3
)

976 ++
__»suÉ
;

977  
__»suÉ
;

978 
	}
}

984 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r¥n
 || defšed 
_FORCE_INLINES


985 #iâdeà
_HAVE_STRING_ARCH_¡r¥n


986 #ià
__GNUC_PREREQ
 (3, 2)

987 
	#¡r¥n
(
s
, 
acû±
) \

988 
__ex‹nsiÚ__
 \

989 ({ 
__a0
, 
__a1
, 
__a2
; \

990 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

991 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

992 ? 
	`__butš_¡r¥n
 (
s
, 
acû±
) \

993 : ((
__a0
 = ((cÚ¡ *è(
acû±
))[0], __a0 == '\0') \

994 ? ((è(
s
), (
size_t
) 0) \

995 : ((
__a1
 = ((cÚ¡ *è(
acû±
))[1], __a1 == '\0') \

996 ? 
	`__¡r¥n_c1
 (
s
, 
__a0
) \

997 : ((
__a2
 = ((cÚ¡ *è(
acû±
))[2], __a2 == '\0') \

998 ? 
	`__¡r¥n_c2
 (
s
, 
__a0
, 
__a1
) \

999 : (((cÚ¡ *è(
acû±
))[3] == '\0' \

1000 ? 
	`__¡r¥n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1001 : 
	`__butš_¡r¥n
 (
s
, 
acû±
)))))) \

1002 : 
	`__butš_¡r¥n
 (
s
, 
acû±
)); })

	)

1004 
	#¡r¥n
(
s
, 
acû±
) \

1005 
__ex‹nsiÚ__
 \

1006 ({ 
__a0
, 
__a1
, 
__a2
; \

1007 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1008 ? ((
__a0
 = ((cÚ¡ *è(
acû±
))[0], __a0 == '\0') \

1009 ? ((è(
s
), (
size_t
) 0) \

1010 : ((
__a1
 = ((cÚ¡ *è(
acû±
))[1], __a1 == '\0') \

1011 ? 
	`__¡r¥n_c1
 (
s
, 
__a0
) \

1012 : ((
__a2
 = ((cÚ¡ *è(
acû±
))[2], __a2 == '\0') \

1013 ? 
	`__¡r¥n_c2
 (
s
, 
__a0
, 
__a1
) \

1014 : (((cÚ¡ *è(
acû±
))[3] == '\0' \

1015 ? 
	`__¡r¥n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1016 : 
	`¡r¥n
 (
s
, 
acû±
))))) \

1017 : 
	`¡r¥n
 (
s
, 
acû±
)); })

	)

1021 
__STRING_INLINE
 
size_t
 
__¡r¥n_c1
 (cÚ¡ *
__s
, 
__acû±
);

1022 
__STRING_INLINE
 
size_t


1023 
	$__¡r¥n_c1
 (cÚ¡ *
__s
, 
__acû±
)

1025 
size_t
 
__»suÉ
 = 0;

1027 
__s
[
__»suÉ
] =ğ
__acû±
)

1028 ++
__»suÉ
;

1029  
__»suÉ
;

1030 
	}
}

1032 
__STRING_INLINE
 
size_t
 
__¡r¥n_c2
 (cÚ¡ *
__s
, 
__acû±1
,

1033 
__acû±2
);

1034 
__STRING_INLINE
 
size_t


1035 
	$__¡r¥n_c2
 (cÚ¡ *
__s
, 
__acû±1
, 
__acû±2
)

1037 
size_t
 
__»suÉ
 = 0;

1039 
__s
[
__»suÉ
] =ğ
__acû±1
 || __s[__»suÉ] =ğ
__acû±2
)

1040 ++
__»suÉ
;

1041  
__»suÉ
;

1042 
	}
}

1044 
__STRING_INLINE
 
size_t
 
__¡r¥n_c3
 (cÚ¡ *
__s
, 
__acû±1
,

1045 
__acû±2
, 
__acû±3
);

1046 
__STRING_INLINE
 
size_t


1047 
	$__¡r¥n_c3
 (cÚ¡ *
__s
, 
__acû±1
, 
__acû±2
, 
__acû±3
)

1049 
size_t
 
__»suÉ
 = 0;

1051 
__s
[
__»suÉ
] =ğ
__acû±1
 || __s[__»suÉ] =ğ
__acû±2


1052 || 
__s
[
__»suÉ
] =ğ
__acû±3
)

1053 ++
__»suÉ
;

1054  
__»suÉ
;

1055 
	}
}

1060 #ià!
defšed
 
_HAVE_STRING_ARCH_¡½brk
 || defšed 
_FORCE_INLINES


1061 #iâdeà
_HAVE_STRING_ARCH_¡½brk


1062 #ià
__GNUC_PREREQ
 (3, 2)

1063 
	#¡½brk
(
s
, 
acû±
) \

1064 
__ex‹nsiÚ__
 \

1065 ({ 
__a0
, 
__a1
, 
__a2
; \

1066 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1067 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

1068 ? 
	`__butš_¡½brk
 (
s
, 
acû±
) \

1069 : ((
__a0
 = ((cÚ¡ *è(
acû±
))[0], __a0 == '\0') \

1070 ? ((è(
s
), (*è
NULL
) \

1071 : ((
__a1
 = ((cÚ¡ *è(
acû±
))[1], __a1 == '\0') \

1072 ? 
	`__butš_¡rchr
 (
s
, 
__a0
) \

1073 : ((
__a2
 = ((cÚ¡ *è(
acû±
))[2], __a2 == '\0') \

1074 ? 
	`__¡½brk_c2
 (
s
, 
__a0
, 
__a1
) \

1075 : (((cÚ¡ *è(
acû±
))[3] == '\0' \

1076 ? 
	`__¡½brk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1077 : 
	`__butš_¡½brk
 (
s
, 
acû±
)))))) \

1078 : 
	`__butš_¡½brk
 (
s
, 
acû±
)); })

	)

1080 
	#¡½brk
(
s
, 
acû±
) \

1081 
__ex‹nsiÚ__
 \

1082 ({ 
__a0
, 
__a1
, 
__a2
; \

1083 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1084 ? ((
__a0
 = ((cÚ¡ *è(
acû±
))[0], __a0 == '\0') \

1085 ? ((è(
s
), (*è
NULL
) \

1086 : ((
__a1
 = ((cÚ¡ *è(
acû±
))[1], __a1 == '\0') \

1087 ? 
	`¡rchr
 (
s
, 
__a0
) \

1088 : ((
__a2
 = ((cÚ¡ *è(
acû±
))[2], __a2 == '\0') \

1089 ? 
	`__¡½brk_c2
 (
s
, 
__a0
, 
__a1
) \

1090 : (((cÚ¡ *è(
acû±
))[3] == '\0' \

1091 ? 
	`__¡½brk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1092 : 
	`¡½brk
 (
s
, 
acû±
))))) \

1093 : 
	`¡½brk
 (
s
, 
acû±
)); })

	)

1097 
__STRING_INLINE
 *
__¡½brk_c2
 (cÚ¡ *
__s
, 
__acû±1
,

1098 
__acû±2
);

1099 
__STRING_INLINE
 *

1100 
	$__¡½brk_c2
 (cÚ¡ *
__s
, 
__acû±1
, 
__acû±2
)

1103 *
__s
 !ğ'\0' && *__ !ğ
__acû±1
 && *__ !ğ
__acû±2
)

1104 ++
__s
;

1105  *
__s
 =ğ'\0' ? 
NULL
 : (*è(
size_t
) __s;

1106 
	}
}

1108 
__STRING_INLINE
 *
__¡½brk_c3
 (cÚ¡ *
__s
, 
__acû±1
,

1109 
__acû±2
, 
__acû±3
);

1110 
__STRING_INLINE
 *

1111 
	$__¡½brk_c3
 (cÚ¡ *
__s
, 
__acû±1
, 
__acû±2
, 
__acû±3
)

1114 *
__s
 !ğ'\0' && *__ !ğ
__acû±1
 && *__ !ğ
__acû±2


1115 && *
__s
 !ğ
__acû±3
)

1116 ++
__s
;

1117  *
__s
 =ğ'\0' ? 
NULL
 : (*è(
size_t
) __s;

1118 
	}
}

1124 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r¡r
 && !
__GNUC_PREREQ
 (2, 97)

1125 
	#¡r¡r
(
hay¡ack
, 
ÃedË
) \

1126 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
ÃedË
è&& 
	`__¡ršg2_1b±r_p
 (needle) \

1127 ? (((cÚ¡ *è(
ÃedË
))[0] == '\0' \

1128 ? (*è(
size_t
è(
hay¡ack
) \

1129 : (((cÚ¡ *è(
ÃedË
))[1] == '\0' \

1130 ? 
	`¡rchr
 (
hay¡ack
, \

1131 ((cÚ¡ *è(
ÃedË
))[0]) \

1132 : 
	`¡r¡r
 (
hay¡ack
, 
ÃedË
))) \

1133 : 
	`¡r¡r
 (
hay¡ack
, 
ÃedË
)))

	)

1137 #ià!
defšed
 
_HAVE_STRING_ARCH_¡¹ok_r
 || defšed 
_FORCE_INLINES


1138 #iâdeà
_HAVE_STRING_ARCH_¡¹ok_r


1139 
	#__¡¹ok_r
(
s
, 
£p
, 
Ãx
) \

1140 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
£p
è&& 
	`__¡ršg2_1b±r_p
 (sep) \

1141 && ((cÚ¡ *è(
£p
))[0] != '\0' \

1142 && ((cÚ¡ *è(
£p
))[1] == '\0' \

1143 ? 
	`__¡¹ok_r_1c
 (
s
, ((cÚ¡ *è(
£p
))[0], 
Ãx
) \

1144 : 
	`__¡¹ok_r
 (
s
, 
£p
, 
Ãx
)))

	)

1147 
__STRING_INLINE
 *
__¡¹ok_r_1c
 (*
__s
, 
__£p
, **
__Ãx
);

1148 
__STRING_INLINE
 *

1149 
	$__¡¹ok_r_1c
 (*
__s
, 
__£p
, **
__Ãx
)

1151 *
__»suÉ
;

1152 ià(
__s
 =ğ
NULL
)

1153 
__s
 = *
__Ãx
;

1154 *
__s
 =ğ
__£p
)

1155 ++
__s
;

1156 
__»suÉ
 = 
NULL
;

1157 ià(*
__s
 != '\0')

1159 
__»suÉ
 = 
__s
++;

1160 *
__s
 != '\0')

1161 ià(*
__s
++ =ğ
__£p
)

1163 
__s
[-1] = '\0';

1167 *
__Ãx
 = 
__s
;

1168  
__»suÉ
;

1169 
	}
}

1170 #ifdeà
__USE_POSIX


1171 
	#¡¹ok_r
(
s
, 
£p
, 
Ãx
è
	`__¡¹ok_r
 (s, s•,‚ex)

	)

1176 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r£p
 || defšed 
_FORCE_INLINES


1177 #iâdeà
_HAVE_STRING_ARCH_¡r£p


1179 *
__¡r£p_g
 (**
__¡ršgp
, cÚ¡ *
__d–im
);

1180 
	#__¡r£p
(
s
, 
»jeù
) \

1181 
__ex‹nsiÚ__
 \

1182 ({ 
__r0
, 
__r1
, 
__r2
; \

1183 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

1184 && (
__r0
 = ((cÚ¡ *è(
»jeù
))[0], \

1185 ((cÚ¡ *è(
»jeù
))[0] != '\0') \

1186 ? ((
__r1
 = ((cÚ¡ *è(
»jeù
))[1], \

1187 ((cÚ¡ *è(
»jeù
))[1] == '\0') \

1188 ? 
	`__¡r£p_1c
 (
s
, 
__r0
) \

1189 : ((
__r2
 = ((cÚ¡ *è(
»jeù
))[2], __r2 == '\0') \

1190 ? 
	`__¡r£p_2c
 (
s
, 
__r0
, 
__r1
) \

1191 : (((cÚ¡ *è(
»jeù
))[3] == '\0' \

1192 ? 
	`__¡r£p_3c
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

1193 : 
	`__¡r£p_g
 (
s
, 
»jeù
)))) \

1194 : 
	`__¡r£p_g
 (
s
, 
»jeù
)); })

	)

1197 
__STRING_INLINE
 *
__¡r£p_1c
 (**
__s
, 
__»jeù
);

1198 
__STRING_INLINE
 *

1199 
	$__¡r£p_1c
 (**
__s
, 
__»jeù
)

1201 *
__»tv®
 = *
__s
;

1202 ià(
__»tv®
 !ğ
NULL
 && (*
__s
 = 
	`¡rchr
 (__»tv®, 
__»jeù
)) != NULL)

1203 *(*
__s
)++ = '\0';

1204  
__»tv®
;

1205 
	}
}

1207 
__STRING_INLINE
 *
__¡r£p_2c
 (**
__s
, 
__»jeù1
, 
__»jeù2
);

1208 
__STRING_INLINE
 *

1209 
	$__¡r£p_2c
 (**
__s
, 
__»jeù1
, 
__»jeù2
)

1211 *
__»tv®
 = *
__s
;

1212 ià(
__»tv®
 !ğ
NULL
)

1214 *
__ı
 = 
__»tv®
;

1217 ià(*
__ı
 == '\0')

1219 
__ı
 = 
NULL
;

1222 ià(*
__ı
 =ğ
__»jeù1
 || *__ı =ğ
__»jeù2
)

1224 *
__ı
++ = '\0';

1227 ++
__ı
;

1229 *
__s
 = 
__ı
;

1231  
__»tv®
;

1232 
	}
}

1234 
__STRING_INLINE
 *
__¡r£p_3c
 (**
__s
, 
__»jeù1
, 
__»jeù2
,

1235 
__»jeù3
);

1236 
__STRING_INLINE
 *

1237 
	$__¡r£p_3c
 (**
__s
, 
__»jeù1
, 
__»jeù2
, 
__»jeù3
)

1239 *
__»tv®
 = *
__s
;

1240 ià(
__»tv®
 !ğ
NULL
)

1242 *
__ı
 = 
__»tv®
;

1245 ià(*
__ı
 == '\0')

1247 
__ı
 = 
NULL
;

1250 ià(*
__ı
 =ğ
__»jeù1
 || *__ı =ğ
__»jeù2
 || *__ı =ğ
__»jeù3
)

1252 *
__ı
++ = '\0';

1255 ++
__ı
;

1257 *
__s
 = 
__ı
;

1259  
__»tv®
;

1260 
	}
}

1261 #ifdeà
__USE_MISC


1262 
	#¡r£p
(
s
, 
»jeù
è
	`__¡r£p
 (s,„ejeù)

	)

1269 #ifdeà
__USE_MISC


1271 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rdup
 || !defšed 
_HAVE_STRING_ARCH_¡ºdup


1272 
	#__Ãed_m®loc_ªd_ÿÎoc


	)

1273 
	~<¡dlib.h
>

1276 #iâdeà
_HAVE_STRING_ARCH_¡rdup


1278 *
	$__¡rdup
 (cÚ¡ *
__¡ršg
è
__THROW
 
__©Œibu‹_m®loc__
;

1279 
	#__¡rdup
(
s
) \

1280 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s) \

1281 ? (((cÚ¡ *è(
s
))[0] == '\0' \

1282 ? (*è
	`ÿÎoc
 ((
size_t
) 1, (size_t) 1) \

1283 : ({ 
size_t
 
__Ën
 = 
	`¡¾’
 (
s
) + 1; \

1284 *
__»tv®
 = (*è
	`m®loc
 (
__Ën
); \

1285 ià(
__»tv®
 !ğ
NULL
) \

1286 
__»tv®
 = (*è
	`memıy
 (__»tv®, 
s
, 
__Ën
); \

1287 
__»tv®
; 
	}
})) \

1288 : 
	`__¡rdup
 (
s
)))

	)

1290 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


1291 
	#¡rdup
(
s
è
	`__¡rdup
 (s)

	)

1295 #iâdeà
_HAVE_STRING_ARCH_¡ºdup


1297 *
	$__¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

1298 
__THROW
 
__©Œibu‹_m®loc__
;

1299 
	#__¡ºdup
(
s
, 
n
) \

1300 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s) \

1301 ? (((cÚ¡ *è(
s
))[0] == '\0' \

1302 ? (*è
	`ÿÎoc
 ((
size_t
) 1, (size_t) 1) \

1303 : ({ 
size_t
 
__Ën
 = 
	`¡¾’
 (
s
) + 1; \

1304 
size_t
 
__n
 = (
n
); \

1305 *
__»tv®
; \

1306 ià(
__n
 < 
__Ën
) \

1307 
__Ën
 = 
__n
 + 1; \

1308 
__»tv®
 = (*è
	`m®loc
 (
__Ën
); \

1309 ià(
__»tv®
 !ğ
NULL
) \

1311 
__»tv®
[
__Ën
 - 1] = '\0'; \

1312 
__»tv®
 = (*è
	`memıy
 (__»tv®, 
s
, \

1313 
__Ën
 - 1); \

1315 
__»tv®
; 
	}
})) \

1316 : 
	`__¡ºdup
 (
s
, 
n
)))

	)

1318 #ifdeà
__USE_XOPEN2K8


1319 
	#¡ºdup
(
s
, 
n
è
	`__¡ºdup
 (s,‚)

	)

1325 #iâdeà
_FORCE_INLINES


1326 #undeà
__STRING_INLINE


	@/usr/include/bits/string3.h

18 #iâdeà
_STRING_H


22 #ià!
__GNUC_PREREQ
 (5,0)

23 
__w¬ndeş
 (
__w¬n_mem£t_z”o_Ën
,

27 #iâdeà
__ılu¥lus


31 #undeà
memıy


32 #undeà
memmove


33 #undeà
mem£t


34 #undeà
¡rÿt


35 #undeà
¡rıy


36 #undeà
¡ºÿt


37 #undeà
¡ºıy


38 #ifdeà
__USE_GNU


39 #undeà
mempıy


40 #undeà
¡pıy


42 #ifdeà
__USE_MISC


43 #undeà
bcİy


44 #undeà
bz”o


49 
__fÜtify_funùiÚ
 *

50 
__NTH
 (
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

51 
size_t
 
__Ën
))

53  
	`__butš___memıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

54 
	}
}

56 
__fÜtify_funùiÚ
 *

57 
__NTH
 (
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__Ën
))

59  
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

60 
	}
}

62 #ifdeà
__USE_GNU


63 
__fÜtify_funùiÚ
 *

64 
__NTH
 (
	$mempıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

65 
size_t
 
__Ën
))

67  
	`__butš___mempıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

68 
	}
}

77 
__fÜtify_funùiÚ
 *

78 
__NTH
 (
	$mem£t
 (*
__de¡
, 
__ch
, 
size_t
 
__Ën
))

82 #ià!
	`__GNUC_PREREQ
 (5,0)

83 ià(
	`__butš_cÚ¡ªt_p
 (
__Ën
) && __len == 0

84 && (!
	`__butš_cÚ¡ªt_p
 (
__ch
) || __ch != 0))

86 
	`__w¬n_mem£t_z”o_Ën
 ();

87  
__de¡
;

90  
	`__butš___mem£t_chk
 (
__de¡
, 
__ch
, 
__Ën
, 
	`__bos0
 (__dest));

91 
	}
}

93 #ifdeà
__USE_MISC


94 
__fÜtify_funùiÚ
 

95 
__NTH
 (
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__Ën
))

97 (è
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

98 
	}
}

100 
__fÜtify_funùiÚ
 

101 
__NTH
 (
	$bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

103 (è
	`__butš___mem£t_chk
 (
__de¡
, '\0', 
__Ën
, 
	`__bos0
 (__dest));

104 
	}
}

107 
__fÜtify_funùiÚ
 *

108 
__NTH
 (
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

110  
	`__butš___¡rıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

111 
	}
}

113 #ifdeà
__USE_GNU


114 
__fÜtify_funùiÚ
 *

115 
__NTH
 (
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

117  
	`__butš___¡pıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

118 
	}
}

122 
__fÜtify_funùiÚ
 *

123 
__NTH
 (
	$¡ºıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

124 
size_t
 
__Ën
))

126  
	`__butš___¡ºıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

127 
	}
}

130 *
	$__¡²ıy_chk
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

131 
size_t
 
__de¡Ën
è
__THROW
;

132 *
	`__REDIRECT_NTH
 (
__¡²ıy_®Ÿs
, (*
__de¡
, cÚ¡ *
__¤c
,

133 
size_t
 
__n
), 
¡²ıy
);

135 
__fÜtify_funùiÚ
 *

136 
	`__NTH
 (
	$¡²ıy
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
))

138 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1

139 && (!
	`__butš_cÚ¡ªt_p
 (
__n
è|| __À> 
	`__bos
 (
__de¡
)))

140  
	`__¡²ıy_chk
 (
__de¡
, 
__¤c
, 
__n
, 
	`__bos
 (__dest));

141  
	`__¡²ıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

142 
	}
}

145 
__fÜtify_funùiÚ
 *

146 
__NTH
 (
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

148  
	`__butš___¡rÿt_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

149 
	}
}

152 
__fÜtify_funùiÚ
 *

153 
__NTH
 (
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

154 
size_t
 
__Ën
))

156  
	`__butš___¡ºÿt_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

157 
	}
}

	@/usr/include/bits/time.h

23 #ià
defšed
 
__Ãed_timev®
 || defšed 
__USE_GNU


24 #iâdeà
_STRUCT_TIMEVAL


25 
	#_STRUCT_TIMEVAL
 1

	)

26 
	~<b™s/ty³s.h
>

30 
	stimev®


32 
__time_t
 
	mtv_£c
;

33 
__su£cÚds_t
 
	mtv_u£c
;

38 #iâdeà
__Ãed_timev®


39 #iâdeà
_BITS_TIME_H


40 
	#_BITS_TIME_H
 1

	)

48 
	#CLOCKS_PER_SEC
 ((
şock_t
è1000000)

	)

50 #ià(!
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_POSIX
) \

51 && !
defšed
 
	g__USE_XOPEN2K


54 
	~<b™s/ty³s.h
>

55 
__syscÚf
 ();

56 
	#CLK_TCK
 ((
__şock_t
è
	`__syscÚf
 (2)è

	)

59 #ifdeà
__USE_POSIX199309


61 
	#CLOCK_REALTIME
 0

	)

63 
	#CLOCK_MONOTONIC
 1

	)

65 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

67 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

69 
	#CLOCK_MONOTONIC_RAW
 4

	)

71 
	#CLOCK_REALTIME_COARSE
 5

	)

73 
	#CLOCK_MONOTONIC_COARSE
 6

	)

75 
	#CLOCK_BOOTTIME
 7

	)

77 
	#CLOCK_REALTIME_ALARM
 8

	)

79 
	#CLOCK_BOOTTIME_ALARM
 9

	)

81 
	#CLOCK_TAI
 11

	)

84 
	#TIMER_ABSTIME
 1

	)

87 #ifdeà
__USE_GNU


88 
	~<b™s/timex.h
>

90 
__BEGIN_DECLS


93 
	$şock_adjtime
 (
__şockid_t
 
__şock_id
, 
timex
 *
__utx
è
__THROW
;

95 
__END_DECLS


101 #undeà
__Ãed_timev®


	@/usr/include/bits/types.h

23 #iâdef 
_BITS_TYPES_H


24 
	#_BITS_TYPES_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	~<b™s/wÜdsize.h
>

30 
	t__u_ch¬
;

31 
	t__u_shÜt
;

32 
	t__u_št
;

33 
	t__u_lÚg
;

36 sigÃd 
	t__št8_t
;

37 
	t__ušt8_t
;

38 sigÃd 
	t__št16_t
;

39 
	t__ušt16_t
;

40 sigÃd 
	t__št32_t
;

41 
	t__ušt32_t
;

42 #ià
__WORDSIZE
 == 64

43 sigÃd 
	t__št64_t
;

44 
	t__ušt64_t
;

46 
__ex‹nsiÚ__
 sigÃd 
	t__št64_t
;

47 
__ex‹nsiÚ__
 
	t__ušt64_t
;

51 #ià
__WORDSIZE
 == 64

52 
	t__quad_t
;

53 
	t__u_quad_t
;

55 
__ex‹nsiÚ__
 
	t__quad_t
;

56 
__ex‹nsiÚ__
 
	t__u_quad_t
;

89 
	#__S16_TYPE
 

	)

90 
	#__U16_TYPE
 

	)

91 
	#__S32_TYPE
 

	)

92 
	#__U32_TYPE
 

	)

93 
	#__SLONGWORD_TYPE
 

	)

94 
	#__ULONGWORD_TYPE
 

	)

95 #ià
__WORDSIZE
 == 32

96 
	#__SQUAD_TYPE
 
__quad_t


	)

97 
	#__UQUAD_TYPE
 
__u_quad_t


	)

98 
	#__SWORD_TYPE
 

	)

99 
	#__UWORD_TYPE
 

	)

100 
	#__SLONG32_TYPE
 

	)

101 
	#__ULONG32_TYPE
 

	)

102 
	#__S64_TYPE
 
__quad_t


	)

103 
	#__U64_TYPE
 
__u_quad_t


	)

106 
	#__STD_TYPE
 
__ex‹nsiÚ__
 

	)

107 #–ià
__WORDSIZE
 == 64

108 
	t__SQUAD_TYPE
 

	)

109 
	t__UQUAD_TYPE
 

	)

110 
	t__SWORD_TYPE
 

	)

111 
	t__UWORD_TYPE
 

	)

112 
	t__SLONG32_TYPE
 

	)

113 
	t__ULONG32_TYPE
 

	)

114 
	t__S64_TYPE
 

	)

115 
	t__U64_TYPE
 

	)

117 
	t__STD_TYPE
 

	)

121 
	~<b™s/ty³sizes.h
>

124 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

125 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

126 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

127 
__STD_TYPE
 
__INO_T_TYPE
 
	g__šo_t
;

128 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__šo64_t
;

129 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

130 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__Æšk_t
;

131 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

132 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

133 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

134 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

135 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__şock_t
;

136 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__¾im_t
;

137 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__¾im64_t
;

138 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

139 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

140 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£cÚds_t
;

141 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£cÚds_t
;

143 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

144 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

147 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__şockid_t
;

150 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__tim”_t
;

153 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

158 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blkút_t
;

159 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blkút64_t
;

162 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblkút_t
;

163 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblkút64_t
;

166 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfút_t
;

167 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfút64_t
;

170 
__STD_TYPE
 
__FSWORD_T_TYPE
 
	g__fswÜd_t
;

172 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

175 
__STD_TYPE
 
__SYSCALL_SLONG_TYPE
 
	g__sysÿÎ_¦Úg_t
;

177 
__STD_TYPE
 
__SYSCALL_ULONG_TYPE
 
	g__sysÿÎ_ulÚg_t
;

181 
__off64_t
 
	t__loff_t
;

182 
__quad_t
 *
	t__qaddr_t
;

183 *
	t__ÿddr_t
;

186 
__STD_TYPE
 
__SWORD_TYPE
 
	g__šŒ_t
;

189 
__STD_TYPE
 
__U32_TYPE
 
	g__sockËn_t
;

192 #undeà
__STD_TYPE


	@/usr/include/bits/waitflags.h

19 #ià!
defšed
 
_SYS_WAIT_H
 && !defšed 
_STDLIB_H


25 
	#WNOHANG
 1

	)

26 
	#WUNTRACED
 2

	)

29 
	#WSTOPPED
 2

	)

30 
	#WEXITED
 4

	)

31 
	#WCONTINUED
 8

	)

32 
	#WNOWAIT
 0x01000000

	)

34 
	#__WNOTHREAD
 0x20000000

	)

36 
	#__WALL
 0x40000000

	)

37 
	#__WCLONE
 0x80000000

	)

40 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


41 #iâdeà
__ENUM_IDTYPE_T


42 
	#__ENUM_IDTYPE_T
 1

	)

46 #undeà
P_ALL


47 #undeà
P_PID


48 #undeà
P_PGID


52 
	mP_ALL
,

53 
	mP_PID
,

54 
	mP_PGID


55 } 
	tidty³_t
;

	@/usr/include/bits/waitstatus.h

19 #ià!
defšed
 
_SYS_WAIT_H
 && !defšed 
_STDLIB_H


28 
	#__WEXITSTATUS
(
¡©us
è(((¡©usè& 0xff00è>> 8)

	)

31 
	#__WTERMSIG
(
¡©us
è((¡©usè& 0x7f)

	)

34 
	#__WSTOPSIG
(
¡©us
è
	`__WEXITSTATUS
(¡©us)

	)

37 
	#__WIFEXITED
(
¡©us
è(
	`__WTERMSIG
(¡©usè=ğ0)

	)

40 
	#__WIFSIGNALED
(
¡©us
) \

41 (((sigÃd è(((
¡©us
è& 0x7fè+ 1è>> 1è> 0)

	)

44 
	#__WIFSTOPPED
(
¡©us
è(((¡©usè& 0xffè=ğ0x7f)

	)

48 #ifdeà
WCONTINUED


49 
	#__WIFCONTINUED
(
¡©us
è((¡©usè=ğ
__W_CONTINUED
)

	)

53 
	#__WCOREDUMP
(
¡©us
è((¡©usè& 
__WCOREFLAG
)

	)

56 
	#__W_EXITCODE
(
»t
, 
sig
è(Ô‘è<< 8 | (sig))

	)

57 
	#__W_STOPCODE
(
sig
è((sigè<< 8 | 0x7f)

	)

58 
	#__W_CONTINUED
 0xffff

	)

59 
	#__WCOREFLAG
 0x80

	)

62 #ifdef 
__USE_MISC


64 
	~<’dŸn.h
>

66 
	uwa™


68 
	mw_¡©us
;

71 #if 
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


72 
	m__w_‹rmsig
:7;

73 
	m__w_cÜedump
:1;

74 
	m__w_»tcode
:8;

77 #if 
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


79 
	m__w_»tcode
:8;

80 
	m__w_cÜedump
:1;

81 
	m__w_‹rmsig
:7;

83 } 
	m__wa™_‹rmš©ed
;

86 #if 
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


87 
	m__w_¡İv®
:8;

88 
	m__w_¡İsig
:8;

91 #if 
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


93 
	m__w_¡İsig
:8;

94 
	m__w_¡İv®
:8;

96 } 
	m__wa™_¡İ³d
;

99 
	#w_‹rmsig
 
__wa™_‹rmš©ed
.
__w_‹rmsig


	)

100 
	#w_cÜedump
 
__wa™_‹rmš©ed
.
__w_cÜedump


	)

101 
	#w_»tcode
 
__wa™_‹rmš©ed
.
__w_»tcode


	)

102 
	#w_¡İsig
 
__wa™_¡İ³d
.
__w_¡İsig


	)

103 
	#w_¡İv®
 
__wa™_¡İ³d
.
__w_¡İv®


	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/sys/types.h

22 #iâdef 
_SYS_TYPES_H


23 
	#_SYS_TYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/ty³s.h
>

31 #ifdef 
__USE_MISC


32 #iâdeà
__u_ch¬_defšed


33 
__u_ch¬
 
	tu_ch¬
;

34 
__u_shÜt
 
	tu_shÜt
;

35 
__u_št
 
	tu_št
;

36 
__u_lÚg
 
	tu_lÚg
;

37 
__quad_t
 
	tquad_t
;

38 
__u_quad_t
 
	tu_quad_t
;

39 
__fsid_t
 
	tfsid_t
;

40 
	#__u_ch¬_defšed


	)

44 
__loff_t
 
	tloff_t
;

46 #iâdeà
__šo_t_defšed


47 #iâdeà
__USE_FILE_OFFSET64


48 
__šo_t
 
	tšo_t
;

50 
__šo64_t
 
	tšo_t
;

52 
	#__šo_t_defšed


	)

54 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__šo64_t_defšed


55 
__šo64_t
 
	tšo64_t
;

56 
	#__šo64_t_defšed


	)

59 #iâdeà
__dev_t_defšed


60 
__dev_t
 
	tdev_t
;

61 
	#__dev_t_defšed


	)

64 #iâdeà
__gid_t_defšed


65 
__gid_t
 
	tgid_t
;

66 
	#__gid_t_defšed


	)

69 #iâdeà
__mode_t_defšed


70 
__mode_t
 
	tmode_t
;

71 
	#__mode_t_defšed


	)

74 #iâdeà
__Æšk_t_defšed


75 
__Æšk_t
 
	tÆšk_t
;

76 
	#__Æšk_t_defšed


	)

79 #iâdeà
__uid_t_defšed


80 
__uid_t
 
	tuid_t
;

81 
	#__uid_t_defšed


	)

84 #iâdeà
__off_t_defšed


85 #iâdeà
__USE_FILE_OFFSET64


86 
__off_t
 
	toff_t
;

88 
__off64_t
 
	toff_t
;

90 
	#__off_t_defšed


	)

92 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


93 
__off64_t
 
	toff64_t
;

94 
	#__off64_t_defšed


	)

97 #iâdeà
__pid_t_defšed


98 
__pid_t
 
	tpid_t
;

99 
	#__pid_t_defšed


	)

102 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
) \

103 && !
defšed
 
__id_t_defšed


104 
__id_t
 
	tid_t
;

105 
	#__id_t_defšed


	)

108 #iâdeà
__ssize_t_defšed


109 
__ssize_t
 
	tssize_t
;

110 
	#__ssize_t_defšed


	)

113 #ifdef 
__USE_MISC


114 #iâdeà
__daddr_t_defšed


115 
__daddr_t
 
	tdaddr_t
;

116 
__ÿddr_t
 
	tÿddr_t
;

117 
	#__daddr_t_defšed


	)

121 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN
è&& !defšed 
__key_t_defšed


122 
__key_t
 
	tkey_t
;

123 
	#__key_t_defšed


	)

126 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


127 
	#__Ãed_şock_t


	)

129 
	#__Ãed_time_t


	)

130 
	#__Ãed_tim”_t


	)

131 
	#__Ãed_şockid_t


	)

132 
	~<time.h
>

134 #ifdeà
__USE_XOPEN


135 #iâdeà
__u£cÚds_t_defšed


136 
__u£cÚds_t
 
	tu£cÚds_t
;

137 
	#__u£cÚds_t_defšed


	)

139 #iâdeà
__su£cÚds_t_defšed


140 
__su£cÚds_t
 
	tsu£cÚds_t
;

141 
	#__su£cÚds_t_defšed


	)

145 
	#__Ãed_size_t


	)

146 
	~<¡ddef.h
>

148 #ifdeà
__USE_MISC


150 
	tulÚg
;

151 
	tushÜt
;

152 
	tušt
;

157 #ià!
__GNUC_PREREQ
 (2, 7)

160 #iâdeà
__št8_t_defšed


161 
	#__št8_t_defšed


	)

162 
	tšt8_t
;

163 
	tšt16_t
;

164 
	tšt32_t
;

165 #ià
__WORDSIZE
 == 64

166 
	tšt64_t
;

168 
__ex‹nsiÚ__
 
	tšt64_t
;

173 
	tu_št8_t
;

174 
	tu_št16_t
;

175 
	tu_št32_t
;

176 #ià
__WORDSIZE
 == 64

177 
	tu_št64_t
;

179 
__ex‹nsiÚ__
 
	tu_št64_t
;

182 
	t»gi¡”_t
;

187 
	#__štN_t
(
N
, 
MODE
) \

188 ##
	tN
##
	t_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	tMODE
)))

	)

189 
	t__u_štN_t
(
	tN
, 
	tMODE
) \

190 
	tu_št
##
	tN
##
	t_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	tMODE
)))

	)

192 #iâdeà
	t__št8_t_defšed


193 
	t__št8_t_defšed


	)

194 
	t__štN_t
 (8, 
	t__QI__
);

195 
__štN_t
 (16, 
__HI__
);

196 
__štN_t
 (32, 
__SI__
);

197 
__štN_t
 (64, 
__DI__
);

200 
__u_štN_t
 (8, 
__QI__
);

201 
__u_štN_t
 (16, 
__HI__
);

202 
__u_štN_t
 (32, 
__SI__
);

203 
__u_štN_t
 (64, 
__DI__
);

205 
	t»gi¡”_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__wÜd__
)));

211 
	#__BIT_TYPES_DEFINED__
 1

	)

214 #ifdef 
__USE_MISC


216 
	~<’dŸn.h
>

219 
	~<sys/£Ëù.h
>

222 
	~<sys/sysmaüos.h
>

226 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
) \

227 && !
defšed
 
__blksize_t_defšed


228 
__blksize_t
 
	tblksize_t
;

229 
	#__blksize_t_defšed


	)

233 #iâdeà
__USE_FILE_OFFSET64


234 #iâdeà
__blkút_t_defšed


235 
__blkút_t
 
	tblkút_t
;

236 
	#__blkút_t_defšed


	)

238 #iâdeà
__fsblkút_t_defšed


239 
__fsblkút_t
 
	tfsblkút_t
;

240 
	#__fsblkút_t_defšed


	)

242 #iâdeà
__fsfút_t_defšed


243 
__fsfút_t
 
	tfsfút_t
;

244 
	#__fsfút_t_defšed


	)

247 #iâdeà
__blkút_t_defšed


248 
__blkút64_t
 
	tblkút_t
;

249 
	#__blkút_t_defšed


	)

251 #iâdeà
__fsblkút_t_defšed


252 
__fsblkút64_t
 
	tfsblkút_t
;

253 
	#__fsblkút_t_defšed


	)

255 #iâdeà
__fsfút_t_defšed


256 
__fsfút64_t
 
	tfsfút_t
;

257 
	#__fsfút_t_defšed


	)

261 #ifdeà
__USE_LARGEFILE64


262 
__blkút64_t
 
	tblkút64_t
;

263 
__fsblkút64_t
 
	tfsblkút64_t
;

264 
__fsfút64_t
 
	tfsfút64_t
;

269 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


270 
	~<b™s/±h»adty³s.h
>

273 
	g__END_DECLS


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/bits/pthreadtypes.h

18 #iâdeà
_BITS_PTHREADTYPES_H


19 
	#_BITS_PTHREADTYPES_H
 1

	)

21 
	~<b™s/wÜdsize.h
>

23 #ifdeà
__x86_64__


24 #ià
__WORDSIZE
 == 64

25 
	#__SIZEOF_PTHREAD_ATTR_T
 56

	)

26 
	#__SIZEOF_PTHREAD_MUTEX_T
 40

	)

27 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

28 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

29 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

30 
	#__SIZEOF_PTHREAD_RWLOCK_T
 56

	)

31 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

32 
	#__SIZEOF_PTHREAD_BARRIER_T
 32

	)

33 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

35 
	#__SIZEOF_PTHREAD_ATTR_T
 32

	)

36 
	#__SIZEOF_PTHREAD_MUTEX_T
 32

	)

37 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

38 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

39 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

40 
	#__SIZEOF_PTHREAD_RWLOCK_T
 44

	)

41 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

42 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

43 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

46 
	#__SIZEOF_PTHREAD_ATTR_T
 36

	)

47 
	#__SIZEOF_PTHREAD_MUTEX_T
 24

	)

48 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

49 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

50 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

51 
	#__SIZEOF_PTHREAD_RWLOCK_T
 32

	)

52 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

53 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

54 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

60 
	t±h»ad_t
;

63 
	u±h»ad_©Œ_t


65 
	m__size
[
__SIZEOF_PTHREAD_ATTR_T
];

66 
	m__®ign
;

68 #iâdeà
__have_±h»ad_©Œ_t


69 
±h»ad_©Œ_t
 
	t±h»ad_©Œ_t
;

70 
	#__have_±h»ad_©Œ_t
 1

	)

74 #ifdeà
__x86_64__


75 
	s__±h»ad_š‹º®_li¡


77 
__±h»ad_š‹º®_li¡
 *
	m__´ev
;

78 
__±h»ad_š‹º®_li¡
 *
	m__Ãxt
;

79 } 
	t__±h»ad_li¡_t
;

81 
	s__±h»ad_š‹º®_¦i¡


83 
__±h»ad_š‹º®_¦i¡
 *
	m__Ãxt
;

84 } 
	t__±h»ad_¦i¡_t
;

92 
	s__±h»ad_mu‹x_s


94 
	m__lock
;

95 
	m__couÁ
;

96 
	m__owÃr
;

97 #ifdeà
__x86_64__


98 
	m__nu£rs
;

102 
	m__kšd
;

103 #ifdeà
__x86_64__


104 
	m__¥šs
;

105 
	m__–isiÚ
;

106 
__±h»ad_li¡_t
 
	m__li¡
;

107 
	#__PTHREAD_MUTEX_HAVE_PREV
 1

	)

109 
	#__PTHREAD_SPINS
 0, 0

	)

111 
	m__nu£rs
;

112 
__ex‹nsiÚ__
 union

116 
	m__e¥šs
;

117 
	m__–isiÚ
;

118 
	#__¥šs
 
__–isiÚ_d©a
.
__e¥šs


	)

119 
	#__–isiÚ
 
__–isiÚ_d©a
.
__–isiÚ


	)

120 
	#__PTHREAD_SPINS
 { 0, 0 }

	)

121 } 
	m__–isiÚ_d©a
;

122 
__±h»ad_¦i¡_t
 
	m__li¡
;

125 } 
	m__d©a
;

126 
	m__size
[
__SIZEOF_PTHREAD_MUTEX_T
];

127 
	m__®ign
;

128 } 
	t±h»ad_mu‹x_t
;

132 
	m__size
[
__SIZEOF_PTHREAD_MUTEXATTR_T
];

133 
	m__®ign
;

134 } 
	t±h»ad_mu‹x©Œ_t
;

143 
	m__lock
;

144 
	m__fu‹x
;

145 
__ex‹nsiÚ__
 
	m__tÙ®_£q
;

146 
__ex‹nsiÚ__
 
	m__wakeup_£q
;

147 
__ex‹nsiÚ__
 
	m__wok’_£q
;

148 *
	m__mu‹x
;

149 
	m__nwa™”s
;

150 
	m__brßdÿ¡_£q
;

151 } 
	m__d©a
;

152 
	m__size
[
__SIZEOF_PTHREAD_COND_T
];

153 
__ex‹nsiÚ__
 
	m__®ign
;

154 } 
	t±h»ad_cÚd_t
;

158 
	m__size
[
__SIZEOF_PTHREAD_CONDATTR_T
];

159 
	m__®ign
;

160 } 
	t±h»ad_cÚd©Œ_t
;

164 
	t±h»ad_key_t
;

168 
	t±h»ad_Úû_t
;

171 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


176 #ifdeà
__x86_64__


179 
	m__lock
;

180 
	m__Ä_»ad”s
;

181 
	m__»ad”s_wakeup
;

182 
	m__wr™”_wakeup
;

183 
	m__Ä_»ad”s_queued
;

184 
	m__Ä_wr™”s_queued
;

185 
	m__wr™”
;

186 
	m__sh¬ed
;

187 sigÃd 
	m__rw–isiÚ
;

188 #ifdeà 
__ILP32__


189 
	m__·d1
[3];

190 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0, { 0, 0, 0 }

	)

192 
	m__·d1
[7];

193 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0, { 0, 0, 0, 0, 0, 0, 0 }

	)

195 
	m__·d2
;

198 
	m__æags
;

199 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

200 } 
	m__d©a
;

204 
	m__lock
;

205 
	m__Ä_»ad”s
;

206 
	m__»ad”s_wakeup
;

207 
	m__wr™”_wakeup
;

208 
	m__Ä_»ad”s_queued
;

209 
	m__Ä_wr™”s_queued
;

212 
	m__æags
;

213 
	m__sh¬ed
;

214 sigÃd 
	m__rw–isiÚ
;

215 
	#__PTHREAD_RWLOCK_ELISION_EXTRA
 0

	)

216 
	m__·d2
;

217 
	m__wr™”
;

218 } 
	m__d©a
;

220 
	m__size
[
__SIZEOF_PTHREAD_RWLOCK_T
];

221 
	m__®ign
;

222 } 
	t±h»ad_rwlock_t
;

226 
	m__size
[
__SIZEOF_PTHREAD_RWLOCKATTR_T
];

227 
	m__®ign
;

228 } 
	t±h»ad_rwlock©Œ_t
;

232 #ifdeà
__USE_XOPEN2K


234 vŞ©
	t±h»ad_¥šlock_t
;

241 
	m__size
[
__SIZEOF_PTHREAD_BARRIER_T
];

242 
	m__®ign
;

243 } 
	t±h»ad_b¬r›r_t
;

247 
	m__size
[
__SIZEOF_PTHREAD_BARRIERATTR_T
];

248 
	m__®ign
;

249 } 
	t±h»ad_b¬r›¿‰r_t
;

253 #iâdeà
__x86_64__


255 
	#__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
	`__»g·rm__
 (1)))

	)

	@/usr/include/bits/timex.h

18 #iâdef 
_BITS_TIMEX_H


19 
	#_BITS_TIMEX_H
 1

	)

21 
	~<b™s/ty³s.h
>

25 
	stimex


27 
	mmodes
;

28 
__sysÿÎ_¦Úg_t
 
	moff£t
;

29 
__sysÿÎ_¦Úg_t
 
	mäeq
;

30 
__sysÿÎ_¦Úg_t
 
	mmax”rÜ
;

31 
__sysÿÎ_¦Úg_t
 
	me¡”rÜ
;

32 
	m¡©us
;

33 
__sysÿÎ_¦Úg_t
 
	mcÚ¡ªt
;

34 
__sysÿÎ_¦Úg_t
 
	m´ecisiÚ
;

35 
__sysÿÎ_¦Úg_t
 
	mtŞ”ªû
;

36 
timev®
 
	mtime
;

37 
__sysÿÎ_¦Úg_t
 
	mtick
;

38 
__sysÿÎ_¦Úg_t
 
	mµsäeq
;

39 
__sysÿÎ_¦Úg_t
 
	mj™‹r
;

40 
	mshiá
;

41 
__sysÿÎ_¦Úg_t
 
	m¡ab
;

42 
__sysÿÎ_¦Úg_t
 
	mj™út
;

43 
__sysÿÎ_¦Úg_t
 
	mÿlút
;

44 
__sysÿÎ_¦Úg_t
 
	m”rút
;

45 
__sysÿÎ_¦Úg_t
 
	m¡bút
;

47 
	mi
;

56 
	#ADJ_OFFSET
 0x0001

	)

57 
	#ADJ_FREQUENCY
 0x0002

	)

58 
	#ADJ_MAXERROR
 0x0004

	)

59 
	#ADJ_ESTERROR
 0x0008

	)

60 
	#ADJ_STATUS
 0x0010

	)

61 
	#ADJ_TIMECONST
 0x0020

	)

62 
	#ADJ_TAI
 0x0080

	)

63 
	#ADJ_SETOFFSET
 0x0100

	)

64 
	#ADJ_MICRO
 0x1000

	)

65 
	#ADJ_NANO
 0x2000

	)

66 
	#ADJ_TICK
 0x4000

	)

67 
	#ADJ_OFFSET_SINGLESHOT
 0x8001

	)

68 
	#ADJ_OFFSET_SS_READ
 0xa001

	)

71 
	#MOD_OFFSET
 
ADJ_OFFSET


	)

72 
	#MOD_FREQUENCY
 
ADJ_FREQUENCY


	)

73 
	#MOD_MAXERROR
 
ADJ_MAXERROR


	)

74 
	#MOD_ESTERROR
 
ADJ_ESTERROR


	)

75 
	#MOD_STATUS
 
ADJ_STATUS


	)

76 
	#MOD_TIMECONST
 
ADJ_TIMECONST


	)

77 
	#MOD_CLKB
 
ADJ_TICK


	)

78 
	#MOD_CLKA
 
ADJ_OFFSET_SINGLESHOT


	)

79 
	#MOD_TAI
 
ADJ_TAI


	)

80 
	#MOD_MICRO
 
ADJ_MICRO


	)

81 
	#MOD_NANO
 
ADJ_NANO


	)

85 
	#STA_PLL
 0x0001

	)

86 
	#STA_PPSFREQ
 0x0002

	)

87 
	#STA_PPSTIME
 0x0004

	)

88 
	#STA_FLL
 0x0008

	)

90 
	#STA_INS
 0x0010

	)

91 
	#STA_DEL
 0x0020

	)

92 
	#STA_UNSYNC
 0x0040

	)

93 
	#STA_FREQHOLD
 0x0080

	)

95 
	#STA_PPSSIGNAL
 0x0100

	)

96 
	#STA_PPSJITTER
 0x0200

	)

97 
	#STA_PPSWANDER
 0x0400

	)

98 
	#STA_PPSERROR
 0x0800

	)

100 
	#STA_CLOCKERR
 0x1000

	)

101 
	#STA_NANO
 0x2000

	)

102 
	#STA_MODE
 0x4000

	)

103 
	#STA_CLK
 0x8000

	)

106 
	#STA_RONLY
 (
STA_PPSSIGNAL
 | 
STA_PPSJITTER
 | 
STA_PPSWANDER
 | \

107 
STA_PPSERROR
 | 
STA_CLOCKERR
 | 
STA_NANO
 | 
STA_MODE
 | 
STA_CLK
)

	)

	@/usr/include/bits/typesizes.h

19 #iâdeà
_BITS_TYPES_H


23 #iâdef 
_BITS_TYPESIZES_H


24 
	#_BITS_TYPESIZES_H
 1

	)

30 #ià
defšed
 
__x86_64__
 && defšed 
__ILP32__


31 
	#__SYSCALL_SLONG_TYPE
 
__SQUAD_TYPE


	)

32 
	#__SYSCALL_ULONG_TYPE
 
__UQUAD_TYPE


	)

34 
	#__SYSCALL_SLONG_TYPE
 
__SLONGWORD_TYPE


	)

35 
	#__SYSCALL_ULONG_TYPE
 
__ULONGWORD_TYPE


	)

38 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

39 
	#__UID_T_TYPE
 
__U32_TYPE


	)

40 
	#__GID_T_TYPE
 
__U32_TYPE


	)

41 
	#__INO_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

42 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

43 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

44 #ifdeà
__x86_64__


45 
	#__NLINK_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

46 
	#__FSWORD_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

48 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

49 
	#__FSWORD_T_TYPE
 
__SWORD_TYPE


	)

51 
	#__OFF_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

52 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

53 
	#__PID_T_TYPE
 
__S32_TYPE


	)

54 
	#__RLIM_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

55 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

56 
	#__BLKCNT_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

57 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

58 
	#__FSBLKCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

59 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

60 
	#__FSFILCNT_T_TYPE
 
__SYSCALL_ULONG_TYPE


	)

61 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

62 
	#__ID_T_TYPE
 
__U32_TYPE


	)

63 
	#__CLOCK_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

64 
	#__TIME_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

65 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

66 
	#__SUSECONDS_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

67 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

68 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

69 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

70 
	#__TIMER_T_TYPE
 *

	)

71 
	#__BLKSIZE_T_TYPE
 
__SYSCALL_SLONG_TYPE


	)

72 
	#__FSID_T_TYPE
 sŒuù { 
__v®
[2]; }

	)

73 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

74 
	#__CPU_MASK_TYPE
 
__SYSCALL_ULONG_TYPE


	)

76 #ifdeà
__x86_64__


80 
	#__OFF_T_MATCHES_OFF64_T
 1

	)

83 
	#__INO_T_MATCHES_INO64_T
 1

	)

87 
	#__FD_SETSIZE
 1024

	)

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__
 && !defšed 
__ILP32__


4 
	#__WORDSIZE
 64

	)

6 
	#__WORDSIZE
 32

	)

9 #ifdeà
__x86_64__


10 
	#__WORDSIZE_TIME64_COMPAT32
 1

	)

12 
	#__SYSCALL_WORDSIZE
 64

	)

	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/gnu/stubs.h

6 #ià!
defšed
 
__x86_64__


7 
	~<gnu/¡ubs-32.h
>

9 #ià
defšed
 
__x86_64__
 && defšed 
__LP64__


10 
	~<gnu/¡ubs-64.h
>

12 #ià
defšed
 
__x86_64__
 && defšed 
__ILP32__


13 
	~<gnu/¡ubs-x32.h
>

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/sys/cdefs.h

18 #iâdef 
_SYS_CDEFS_H


19 
	#_SYS_CDEFS_H
 1

	)

22 #iâdeà
_FEATURES_H


23 
	~<ã©u»s.h
>

29 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


34 #undeà
__P


35 #undeà
__PMT


37 #ifdeà
__GNUC__


41 #ià
__GNUC_PREREQ
 (4, 6è&& !
defšed
 
_LIBC


42 
	#__LEAF
 , 
__Ëaf__


	)

43 
	#__LEAF_ATTR
 
	`__©Œibu‹__
 ((
__Ëaf__
))

	)

45 
	#__LEAF


	)

46 
	#__LEAF_ATTR


	)

54 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

55 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
))

	)

56 
	#__THROWNL
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

57 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
)è
	)
fct

59 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

60 
	#__THROW
 
	`throw
 ()

	)

61 
	#__THROWNL
 
	`throw
 ()

	)

62 
	#__NTH
(
fù
è
__LEAF_ATTR
 fù 
	`throw
 ()

	)

64 
	#__THROW


	)

65 
	#__THROWNL


	)

66 
	#__NTH
(
fù
è
	)
fct

72 
	#__šlše


	)

74 
	#__THROW


	)

75 
	#__THROWNL


	)

76 
	#__NTH
(
fù
è
	)
fct

82 
	#__P
(
¬gs
è
	)
args

83 
	#__PMT
(
¬gs
è
	)
args

88 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

89 
	#__STRING
(
x
è#x

	)

92 
	#__±r_t
 *

	)

93 
	#__lÚg_doubË_t
 

	)

97 #ifdef 
__ılu¥lus


98 
	#__BEGIN_DECLS
 "C" {

	)

99 
	#__END_DECLS
 }

	)

101 
	#__BEGIN_DECLS


	)

102 
	#__END_DECLS


	)

111 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES


112 
	#__BEGIN_NAMESPACE_STD
 
Çme¥aû
 
¡d
 {

	)

113 
	#__END_NAMESPACE_STD
 }

	)

114 
	#__USING_NAMESPACE_STD
(
Çme
è
usšg
 
¡d
::Çme;

	)

115 
	#__BEGIN_NAMESPACE_C99
 
Çme¥aû
 
__c99
 {

	)

116 
	#__END_NAMESPACE_C99
 }

	)

117 
	#__USING_NAMESPACE_C99
(
Çme
è
usšg
 
__c99
::Çme;

	)

122 
	#__BEGIN_NAMESPACE_STD


	)

123 
	#__END_NAMESPACE_STD


	)

124 
	#__USING_NAMESPACE_STD
(
Çme
)

	)

125 
	#__BEGIN_NAMESPACE_C99


	)

126 
	#__END_NAMESPACE_C99


	)

127 
	#__USING_NAMESPACE_C99
(
Çme
)

	)

132 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

133 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

135 #ià
__GNUC_PREREQ
 (4,3)

136 
	#__w¬ndeş
(
Çme
, 
msg
) \

137 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

138 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

139 
	#__”rÜdeş
(
Çme
, 
msg
) \

140 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

142 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

143 
	#__w¬Ç‰r
(
msg
)

	)

144 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

148 #ià
__GNUC_PREREQ
 (2,97)

150 
	#__æex¬r
 []

	)

152 #ifdeà
__GNUC__


153 
	#__æex¬r
 [0]

	)

155 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

156 
	#__æex¬r
 []

	)

159 
	#__æex¬r
 [1]

	)

175 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

177 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

178 #ifdeà
__ılu¥lus


179 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

180 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

181 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

182 
Çme
 
´Ùo
 
__THROWNL
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

184 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

185 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

186 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

187 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROWNL


	)

189 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

190 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

203 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

204 
	#__©Œibu‹__
(
xyz
è

	)

210 #ià
__GNUC_PREREQ
 (2,96)

211 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

213 
	#__©Œibu‹_m®loc__


	)

218 #ià
__GNUC_PREREQ
 (4, 3)

219 
	#__©Œibu‹_®loc_size__
(
·¿ms
) \

220 
	`__©Œibu‹__
 ((
__®loc_size__
 
·¿ms
))

	)

222 
	#__©Œibu‹_®loc_size__
(
·¿ms
è

	)

228 #ià
__GNUC_PREREQ
 (2,96)

229 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

231 
	#__©Œibu‹_pu»__


	)

235 #ià
__GNUC_PREREQ
 (2,5)

236 
	#__©Œibu‹_cÚ¡__
 
	`__©Œibu‹__
 ((
__cÚ¡__
))

	)

238 
	#__©Œibu‹_cÚ¡__


	)

244 #ià
__GNUC_PREREQ
 (3,1)

245 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

246 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

248 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

249 
	#__©Œibu‹_nošlše__


	)

253 #ià
__GNUC_PREREQ
 (3,2)

254 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

256 
	#__©Œibu‹_d•»ÿ‹d__


	)

265 #ià
__GNUC_PREREQ
 (2,8)

266 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

268 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

275 #ià
__GNUC_PREREQ
 (2,97)

276 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

277 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

279 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

284 #ià
__GNUC_PREREQ
 (3,3)

285 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

287 
	#__nÚnuÎ
(
·¿ms
)

	)

292 #ià
__GNUC_PREREQ
 (3,4)

293 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

294 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

295 #ià
__USE_FORTIFY_LEVEL
 > 0

296 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

299 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

301 #iâdeà
__wur


302 
	#__wur


	)

306 #ià
__GNUC_PREREQ
 (3,2)

307 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

309 
	#__®ways_šlše
 
__šlše


	)

314 #ià
__GNUC_PREREQ
 (4,3)

315 
	#__©Œibu‹_¬tificŸl__
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

317 
	#__©Œibu‹_¬tificŸl__


	)

329 #ià(!
defšed
 
__ılu¥lus
 || 
__GNUC_PREREQ
 (4,3) \

330 || (
defšed
 
__şªg__
 && (defšed 
__GNUC_STDC_INLINE__
 \

331 || 
defšed
 
__GNUC_GNU_INLINE__
)))

332 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


333 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

334 
	#__ex‹º_®ways_šlše
 \

335 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

337 
	#__ex‹º_šlše
 
__šlše


	)

338 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

342 #ifdeà
__ex‹º_®ways_šlše


343 
	#__fÜtify_funùiÚ
 
__ex‹º_®ways_šlše
 
__©Œibu‹_¬tificŸl__


	)

348 #ià
__GNUC_PREREQ
 (4,3)

349 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

350 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

357 #ià!
__GNUC_PREREQ
 (2,8)

358 
	#__ex‹nsiÚ__


	)

362 #ià!
__GNUC_PREREQ
 (2,92)

363 
	#__»¡riù


	)

369 #ià
__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


370 
	#__»¡riù_¬r
 
__»¡riù


	)

372 #ifdeà
__GNUC__


373 
	#__»¡riù_¬r


	)

375 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

376 
	#__»¡riù_¬r
 
»¡riù


	)

379 
	#__»¡riù_¬r


	)

384 #ià
__GNUC__
 >= 3

385 
	#__glibc_uÆik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 0)

	)

386 
	#__glibc_lik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 1)

	)

388 
	#__glibc_uÆik–y
(
cÚd
è(cÚd)

	)

389 
	#__glibc_lik–y
(
cÚd
è(cÚd)

	)

392 #ià(!
defšed
 
_NÜ‘uº
 \

393 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

394 && !
	$__GNUC_PREREQ
 (4,7))

395 #ià
	`__GNUC_PREREQ
 (2,8)

396 
	#_NÜ‘uº
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

	)

398 
	#_NÜ‘uº


	)

402 #ià(!
defšed
 
_Stic_as£¹
 && !defšed 
__ılu¥lus
 \

403 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

404 && (!
	`__GNUC_PREREQ
 (4, 6è|| 
defšed
 
__STRICT_ANSI__
))

405 
	#_Stic_as£¹
(
ex´
, 
dŸgno¡ic
) \

406 (*
	`__Stic_as£¹_funùiÚ
 ()) \

407 [!! (¡ruù { 
__”rÜ_if_Ãg©ive
: (
ex´
è? 2 : -1; })]

	)

410 
	~<b™s/wÜdsize.h
>

412 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


413 
	#__LDBL_COMPAT
 1

	)

414 #ifdeà
__REDIRECT


415 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

416 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

417 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

418 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

419 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

420 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

421 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

422 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

423 
	#__LDBL_REDIR_DECL
(
Çme
) \

424 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

425 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

426 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

427 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

428 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

431 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


432 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

433 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

434 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

435 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

436 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

437 #ifdeà
__REDIRECT


438 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

439 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

440 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

	@/usr/include/sys/select.h

21 #iâdeà
_SYS_SELECT_H


22 
	#_SYS_SELECT_H
 1

	)

24 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

30 
	~<b™s/£Ëù.h
>

33 
	~<b™s/sig£t.h
>

35 #iâdeà
__sig£t_t_defšed


36 
	#__sig£t_t_defšed


	)

37 
__sig£t_t
 
	tsig£t_t
;

41 
	#__Ãed_time_t


	)

42 
	#__Ãed_time¥ec


	)

43 
	~<time.h
>

44 
	#__Ãed_timev®


	)

45 
	~<b™s/time.h
>

47 #iâdeà
__su£cÚds_t_defšed


48 
__su£cÚds_t
 
	tsu£cÚds_t
;

49 
	#__su£cÚds_t_defšed


	)

54 
	t__fd_mask
;

57 #undeà
__NFDBITS


59 
	#__NFDBITS
 (8 * (è (
__fd_mask
))

	)

60 
	#__FD_ELT
(
d
è((dè/ 
__NFDBITS
)

	)

61 
	#__FD_MASK
(
d
è((
__fd_mask
è(1UL << ((dè% 
__NFDBITS
)))

	)

68 #ifdeà
__USE_XOPEN


69 
__fd_mask
 
	mfds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

70 
	#__FDS_BITS
(
£t
è((£t)->
fds_b™s
)

	)

72 
__fd_mask
 
	m__fds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

73 
	#__FDS_BITS
(
£t
è((£t)->
__fds_b™s
)

	)

75 } 
	tfd_£t
;

78 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

80 #ifdeà
__USE_MISC


82 
__fd_mask
 
	tfd_mask
;

85 
	#NFDBITS
 
__NFDBITS


	)

90 
	#FD_SET
(
fd
, 
fd£
è
	`__FD_SET
 (fd, fd£)

	)

91 
	#FD_CLR
(
fd
, 
fd£
è
	`__FD_CLR
 (fd, fd£)

	)

92 
	#FD_ISSET
(
fd
, 
fd£
è
	`__FD_ISSET
 (fd, fd£)

	)

93 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
 (fd£)

	)

96 
__BEGIN_DECLS


106 
£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

107 
fd_£t
 *
__»¡riù
 
__wr™efds
,

108 
fd_£t
 *
__»¡riù
 
__exû±fds
,

109 
timev®
 *
__»¡riù
 
__timeout
);

111 #ifdeà
__USE_XOPEN2K


118 
p£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

119 
fd_£t
 *
__»¡riù
 
__wr™efds
,

120 
fd_£t
 *
__»¡riù
 
__exû±fds
,

121 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
,

122 cÚ¡ 
__sig£t_t
 *
__»¡riù
 
__sigmask
);

127 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__GNUC__


128 
	~<b™s/£Ëù2.h
>

131 
	g__END_DECLS


	@/usr/include/sys/sysmacros.h

19 #iâdeà
_SYS_SYSMACROS_H


20 
	#_SYS_SYSMACROS_H
 1

	)

22 
	~<ã©u»s.h
>

24 
__BEGIN_DECLS


26 
__ex‹nsiÚ__


27 
	$gnu_dev_majÜ
 (
__dev
)

28 
__THROW
 
__©Œibu‹_cÚ¡__
;

29 
__ex‹nsiÚ__


30 
	$gnu_dev_mšÜ
 (
__dev
)

31 
__THROW
 
__©Œibu‹_cÚ¡__
;

32 
__ex‹nsiÚ__


33 
	$gnu_dev_makedev
 (
__majÜ
,

34 
__mšÜ
)

35 
__THROW
 
__©Œibu‹_cÚ¡__
;

37 #ifdeà
__USE_EXTERN_INLINES


38 
__ex‹nsiÚ__
 
__ex‹º_šlše
 
__©Œibu‹_cÚ¡__
 

39 
	`__NTH
 (
	$gnu_dev_majÜ
 (
__dev
))

41  ((
__dev
 >> 8) & 0xfff) | (() (__dev >> 32) & ~0xfff);

42 
	}
}

44 
__ex‹nsiÚ__
 
__ex‹º_šlše
 
__©Œibu‹_cÚ¡__
 

45 
__NTH
 (
	$gnu_dev_mšÜ
 (
__dev
))

47  (
__dev
 & 0xff) | (() (__dev >> 12) & ~0xff);

48 
	}
}

50 
__ex‹nsiÚ__
 
__ex‹º_šlše
 
__©Œibu‹_cÚ¡__
 

51 
__NTH
 (
	$gnu_dev_makedev
 (
__majÜ
, 
__mšÜ
))

53  ((
__mšÜ
 & 0xffè| ((
__majÜ
 & 0xfff) << 8)

54 | (((è(
__mšÜ
 & ~0xff)) << 12)

55 | (((è(
__majÜ
 & ~0xfff)) << 32));

56 
	}
}

58 
	g__END_DECLS


61 
	#majÜ
(
dev
è
	`gnu_dev_majÜ
 (dev)

	)

62 
	#mšÜ
(
dev
è
	`gnu_dev_mšÜ
 (dev)

	)

63 
	#makedev
(
maj
, 
mš
è
	`gnu_dev_makedev
 (maj, mš)

	)

	@/usr/include/bits/byteswap.h

19 #ià!
defšed
 
_BYTESWAP_H
 && !defšed 
_NETINET_IN_H
 && !defšed 
_ENDIAN_H


23 #iâdeà
_BITS_BYTESWAP_H


24 
	#_BITS_BYTESWAP_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

28 
	~<b™s/wÜdsize.h
>

31 
	#__bsw­_cÚ¡ªt_16
(
x
) \

32 ((è((((
x
è>> 8è& 0xffè| (((xè& 0xffè<< 8)))

	)

35 
	~<b™s/by‹sw­-16.h
>

38 
	#__bsw­_cÚ¡ªt_32
(
x
) \

39 ((((
x
) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >> 8) | \

40 (((
x
è& 0x0000ff00è<< 8è| (((xè& 0x000000ffè<< 24))

	)

42 #ifdeà
__GNUC__


43 #ià
__GNUC_PREREQ
 (4, 3)

44 
__šlše
 

45 
	$__bsw­_32
 (
__bsx
)

47  
	`__butš_bsw­32
 (
__bsx
);

48 
	}
}

49 #–ià
__GNUC__
 >= 2

50 #ià
__WORDSIZE
 =ğ64 || (
defšed
 
__i486__
 || defšed 
__³Áium__
 \

51 || 
defšed
 
	g__³Áium´o__
 || defšed 
	g__³Áium4__
 \

52 || 
defšed
 
	g__k8__
 || defšed 
	g__©hlÚ__
 \

53 || 
defšed
 
	g__k6__
 || defšed 
	g__nocÚa__
 \

54 || 
defšed
 
	g__cÜe2__
 || defšed 
	g__geode__
 \

55 || 
defšed
 
	g__amdçm10__
)

58 
	#__bsw­_32
(
x
) \

59 (
__ex‹nsiÚ__
 \

60 ({ 
__v
, 
__x
 = (
x
); \

61 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

62 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

64 
	`__asm__
 ("bsw­ %0" : "ô" (
__v
è: "0" (
__x
)); \

65 
__v
; }))

	)

67 
	#__bsw­_32
(
x
) \

68 (
__ex‹nsiÚ__
 \

69 ({ 
__v
, 
__x
 = (
x
); \

70 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

71 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

73 
	`__asm__
 ("rorw $8, %w0;" \

76 : "ô" (
__v
) \

77 : "0" (
__x
) \

79 
__v
; }))

	)

82 
	#__bsw­_32
(
x
) \

83 (
__ex‹nsiÚ__
 \

84 ({ 
__x
 = (
x
); 
	`__bsw­_cÚ¡ªt_32
 (__x); }))

	)

87 
__šlše
 

88 
	$__bsw­_32
 (
__bsx
)

90  
	`__bsw­_cÚ¡ªt_32
 (
__bsx
);

91 
	}
}

95 #ià
__GNUC_PREREQ
 (2, 0)

97 
	#__bsw­_cÚ¡ªt_64
(
x
) \

98 (
	`__ex‹nsiÚ__
 ((((
x
) & 0xff00000000000000ull) >> 56) \

99 | (((
x
) & 0x00ff000000000000ull) >> 40) \

100 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

101 | (((
x
) & 0x000000ff00000000ull) >> 8) \

102 | (((
x
) & 0x00000000ff000000ull) << 8) \

103 | (((
x
) & 0x0000000000ff0000ull) << 24) \

104 | (((
x
) & 0x000000000000ff00ull) << 40) \

105 | (((
x
è& 0x00000000000000ffuÎè<< 56)))

	)

107 #ià
__GNUC_PREREQ
 (4, 3)

108 
__šlše
 
__ušt64_t


109 
	$__bsw­_64
 (
__ušt64_t
 
__bsx
)

111  
	`__butš_bsw­64
 (
__bsx
);

112 
	}
}

113 #–ià
__WORDSIZE
 == 64

114 
	#__bsw­_64
(
x
) \

115 (
__ex‹nsiÚ__
 \

116 ({ 
__ušt64_t
 
__v
, 
__x
 = (
x
); \

117 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

118 
__v
 = 
	`__bsw­_cÚ¡ªt_64
 (
__x
); \

120 
	`__asm__
 ("bsw­ %q0" : "ô" (
__v
è: "0" (
__x
)); \

121 
__v
; }))

	)

123 
	#__bsw­_64
(
x
) \

124 (
__ex‹nsiÚ__
 \

125 ({ uniÚ { 
__ex‹nsiÚ__
 
__ušt64_t
 
__Î
; \

126 
__l
[2]; } 
__w
, 
__r
; \

127 ià(
	`__butš_cÚ¡ªt_p
 (
x
)) \

128 
__r
.
__Î
 = 
	`__bsw­_cÚ¡ªt_64
 (
x
); \

131 
__w
.
__Î
 = (
x
); \

132 
__r
.
__l
[0] = 
	`__bsw­_32
 (
__w
.__l[1]); \

133 
__r
.
__l
[1] = 
	`__bsw­_32
 (
__w
.__l[0]); \

135 
__r
.
__Î
; }))

	)

138 
	#__bsw­_cÚ¡ªt_64
(
x
) \

139 ((((
x
) & 0xff00000000000000ull) >> 56) \

140 | (((
x
) & 0x00ff000000000000ull) >> 40) \

141 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

142 | (((
x
) & 0x000000ff00000000ull) >> 8) \

143 | (((
x
) & 0x00000000ff000000ull) << 8) \

144 | (((
x
) & 0x0000000000ff0000ull) << 24) \

145 | (((
x
) & 0x000000000000ff00ull) << 40) \

146 | (((
x
è& 0x00000000000000ffuÎè<< 56))

	)

148 
__šlše
 
__ušt64_t


149 
	$__bsw­_64
 (
__ušt64_t
 
__bsx
)

151  
	`__bsw­_cÚ¡ªt_64
 (
__bsx
);

152 
	}
}

	@/usr/include/bits/endian.h

3 #iâdeà
_ENDIAN_H


7 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@/usr/include/bits/select.h

18 #iâdeà
_SYS_SELECT_H


22 
	~<b™s/wÜdsize.h
>

25 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

27 #ià
__WORDSIZE
 == 64

28 
	#__FD_ZERO_STOS
 "¡osq"

	)

30 
	#__FD_ZERO_STOS
 "¡o¦"

	)

33 
	#__FD_ZERO
(
fd¥
) \

35 
__d0
, 
__d1
; \

36 
__asm__
 
	`__vŞ©e__
 ("şd;„•; " 
__FD_ZERO_STOS
 \

37 : "=c" (
__d0
), "=D" (
__d1
) \

38 : "a" (0), "0" ( (
fd_£t
) \

39 /  (
__fd_mask
)), \

40 "1" (&
	`__FDS_BITS
 (
fd¥
)[0]) \

42 } 0)

	)

48 
	#__FD_ZERO
(
£t
) \

50 
__i
; \

51 
fd_£t
 *
__¬r
 = (
£t
); \

52 
__i
 = 0; __˜<  (
fd_£t
è/  (
__fd_mask
); ++__i) \

53 
	`__FDS_BITS
 (
__¬r
)[
__i
] = 0; \

54 } 0)

	)

58 
	#__FD_SET
(
d
, 
£t
) \

59 ((è(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] |ğ
	`__FD_MASK
 (d)))

	)

60 
	#__FD_CLR
(
d
, 
£t
) \

61 ((è(
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] &ğ~
	`__FD_MASK
 (d)))

	)

62 
	#__FD_ISSET
(
d
, 
£t
) \

63 ((
	`__FDS_BITS
 (
£t
)[
	`__FD_ELT
 (
d
)] & 
	`__FD_MASK
 (d)è!ğ0)

	)

	@/usr/include/bits/select2.h

19 #iâdeà
_SYS_SELECT_H


24 
__fd–t_chk
 (
__d
);

25 
	$__fd–t_w¬n
 (
__d
)

26 
	`__w¬Ç‰r
 ("bit outside of fd_set selected");

27 #undeà
__FD_ELT


28 
	#__FD_ELT
(
d
) \

29 
__ex‹nsiÚ__
 \

30 ({ 
__d
 = (
d
); \

31 (
	`__butš_cÚ¡ªt_p
 (
__d
) \

32 ? (0 <ğ
__d
 && __d < 
__FD_SETSIZE
 \

33 ? (
__d
 / 
__NFDBITS
) \

34 : 
	`__fd–t_w¬n
 (
__d
)) \

35 : 
	`__fd–t_chk
 (
__d
)); 
	}
})

	)

	@/usr/include/bits/sigset.h

19 #iâdef 
_SIGSET_H_ty³s


20 
	#_SIGSET_H_ty³s
 1

	)

22 
	t__sig_©omic_t
;

26 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

29 
	m__v®
[
_SIGSET_NWORDS
];

30 } 
	t__sig£t_t
;

41 #ià!
defšed
 
_SIGSET_H_âs
 && defšed 
_SIGNAL_H


42 
	#_SIGSET_H_âs
 1

	)

44 #iâdeà
_EXTERN_INLINE


45 
	#_EXTERN_INLINE
 
__ex‹º_šlše


	)

49 
	#__sigmask
(
sig
) \

50 (((è1è<< (((
sig
è- 1è% (8 *  ())))

	)

53 
	#__sigwÜd
(
sig
è(((sigè- 1è/ (8 *  ()))

	)

55 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

56 
	#__sigem±y£t
(
£t
) \

57 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

58 
sig£t_t
 *
__£t
 = (
£t
); \

59 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = 0; \

60 0; }))

	)

61 
	#__sigfl£t
(
£t
) \

62 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

63 
sig£t_t
 *
__£t
 = (
£t
); \

64 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = ~0UL; \

65 0; }))

	)

67 #ifdeà
__USE_GNU


71 
	#__sigi£m±y£t
(
£t
) \

72 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

73 cÚ¡ 
sig£t_t
 *
__£t
 = (
£t
); \

74 
__»t
 = 
__£t
->
__v®
[--
__út
]; \

75 !
__»t
 && --
__út
 >= 0) \

76 
__»t
 = 
__£t
->
__v®
[
__út
]; \

77 
__»t
 =ğ0; }))

	)

78 
	#__sigªd£t
(
de¡
, 
Ëá
, 
right
) \

79 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

80 
sig£t_t
 *
__de¡
 = (
de¡
); \

81 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

82 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

83 --
__út
 >= 0) \

84 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

85 & 
__right
->
__v®
[
__út
]); \

86 0; }))

	)

87 
	#__sigÜ£t
(
de¡
, 
Ëá
, 
right
) \

88 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

89 
sig£t_t
 *
__de¡
 = (
de¡
); \

90 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

91 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

92 --
__út
 >= 0) \

93 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

94 | 
__right
->
__v®
[
__út
]); \

95 0; }))

	)

102 
__sigismemb”
 (cÚ¡ 
__sig£t_t
 *, );

103 
__sigadd£t
 (
__sig£t_t
 *, );

104 
__sigd–£t
 (
__sig£t_t
 *, );

106 #ifdeà
__USE_EXTERN_INLINES


107 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

108 
_EXTERN_INLINE
 \

109 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

111 
__mask
 = 
	`__sigmask
 (
__sig
); \

112 
__wÜd
 = 
	`__sigwÜd
 (
__sig
); \

113  
BODY
; \

114 }

	)

116 
__SIGSETFN
 (
__sigismemb”
, (
__£t
->
__v®
[
__wÜd
] & 
__mask
) ? 1 : 0, const)

117 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__v®
[
__wÜd
] |ğ
__mask
), 0), )

118 
__SIGSETFN
 (
__sigd–£t
, ((
__£t
->
__v®
[
__wÜd
] &ğ~
__mask
), 0), )

120 #undeà
__SIGSETFN


	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub_chæags


	)

11 
	#__¡ub_ç‰ach


	)

12 
	#__¡ub_fchæags


	)

13 
	#__¡ub_fd‘ach


	)

14 
	#__¡ub_g‰y


	)

15 
	#__¡ub_lchmod


	)

16 
	#__¡ub_»voke


	)

17 
	#__¡ub_£ogš


	)

18 
	#__¡ub_sig»tuº


	)

19 
	#__¡ub_s¡k


	)

20 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___com·t_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-x32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___com·t_bdæush


	)

11 
	#__¡ub___com·t_ü—‹_moduË


	)

12 
	#__¡ub___com·t_g‘_k”Ãl_syms


	)

13 
	#__¡ub___com·t_qu”y_moduË


	)

14 
	#__¡ub___com·t_u£lib


	)

15 
	#__¡ub_chæags


	)

16 
	#__¡ub_ç‰ach


	)

17 
	#__¡ub_fchæags


	)

18 
	#__¡ub_fd‘ach


	)

19 
	#__¡ub_g‘msg


	)

20 
	#__¡ub_g‰y


	)

21 
	#__¡ub_lchmod


	)

22 
	#__¡ub_nfs£rvùl


	)

23 
	#__¡ub_putmsg


	)

24 
	#__¡ub_»voke


	)

25 
	#__¡ub_£ogš


	)

26 
	#__¡ub_sig»tuº


	)

27 
	#__¡ub_s¡k


	)

28 
	#__¡ub_¡ty


	)

	@/usr/include/bits/byteswap-16.h

19 #iâdeà
_BITS_BYTESWAP_H


23 #ifdeà
__GNUC__


24 #ià
__GNUC__
 >= 2

25 
	#__bsw­_16
(
x
) \

26 (
__ex‹nsiÚ__
 \

27 ({ 
__v
, 
__x
 = (è(
x
); \

28 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

29 
__v
 = 
	`__bsw­_cÚ¡ªt_16
 (
__x
); \

31 
	`__asm__
 ("rorw $8, %w0" \

32 : "ô" (
__v
) \

33 : "0" (
__x
) \

35 
__v
; }))

	)

38 
	#__bsw­_16
(
x
) \

39 (
__ex‹nsiÚ__
 \

40 ({ 
__x
 = (è(
x
); \

41 
	`__bsw­_cÚ¡ªt_16
 (
__x
); }))

	)

44 
__šlše
 

45 
	$__bsw­_16
 (
__bsx
)

47  
	`__bsw­_cÚ¡ªt_16
 (
__bsx
);

48 
	}
}

	@
1
.
1
/usr/include
203
4793
dealias/scamper_dealias.c
dealias/scamper_dealias.h
dealias/scamper_dealias_do.c
dealias/scamper_dealias_do.h
dealias/scamper_dealias_json.c
dealias/scamper_dealias_json.h
dealias/scamper_dealias_text.c
dealias/scamper_dealias_text.h
dealias/scamper_dealias_warts.c
dealias/scamper_dealias_warts.h
fprinting/scamper_fprinting.c
fprinting/scamper_fprinting.h
fprinting/scamper_fprinting_do.c
fprinting/scamper_fprinting_do.h
fprinting/scamper_fprinting_text.c
fprinting/scamper_fprinting_text.h
fprinting/scamper_fprinting_warts.c
fprinting/scamper_fprinting_warts.h
neighbourdisc/scamper_neighbourdisc.c
neighbourdisc/scamper_neighbourdisc.h
neighbourdisc/scamper_neighbourdisc_do.c
neighbourdisc/scamper_neighbourdisc_do.h
neighbourdisc/scamper_neighbourdisc_warts.c
neighbourdisc/scamper_neighbourdisc_warts.h
ping/scamper_ping.c
ping/scamper_ping.h
ping/scamper_ping_do.c
ping/scamper_ping_do.h
ping/scamper_ping_json.c
ping/scamper_ping_json.h
ping/scamper_ping_text.c
ping/scamper_ping_text.h
ping/scamper_ping_warts.c
ping/scamper_ping_warts.h
scamper.c
scamper.h
scamper_addr.c
scamper_addr.h
scamper_addr2mac.c
scamper_addr2mac.h
scamper_control.c
scamper_control.h
scamper_cyclemon.c
scamper_cyclemon.h
scamper_debug.c
scamper_debug.h
scamper_dl.c
scamper_dl.h
scamper_dlhdr.c
scamper_dlhdr.h
scamper_fds.c
scamper_fds.h
scamper_file.c
scamper_file.h
scamper_file_arts.c
scamper_file_arts.h
scamper_file_text.c
scamper_file_text.h
scamper_file_warts.c
scamper_file_warts.h
scamper_firewall.c
scamper_firewall.h
scamper_getsrc.c
scamper_getsrc.h
scamper_icmp4.c
scamper_icmp4.h
scamper_icmp6.c
scamper_icmp6.h
scamper_icmp_resp.c
scamper_icmp_resp.h
scamper_icmpext.c
scamper_icmpext.h
scamper_if.c
scamper_if.h
scamper_ip4.c
scamper_ip4.h
scamper_ip6.c
scamper_ip6.h
scamper_linepoll.c
scamper_linepoll.h
scamper_list.c
scamper_list.h
scamper_options.c
scamper_options.h
scamper_osinfo.c
scamper_osinfo.h
scamper_outfiles.c
scamper_outfiles.h
scamper_privsep.c
scamper_privsep.h
scamper_probe.c
scamper_probe.h
scamper_queue.c
scamper_queue.h
scamper_rtsock.c
scamper_rtsock.h
scamper_source_cmdline.c
scamper_source_cmdline.h
scamper_source_control.c
scamper_source_control.h
scamper_source_file.c
scamper_source_file.h
scamper_source_tsps.c
scamper_source_tsps.h
scamper_sources.c
scamper_sources.h
scamper_task.c
scamper_task.h
scamper_tcp4.c
scamper_tcp4.h
scamper_tcp6.c
scamper_tcp6.h
scamper_udp4.c
scamper_udp4.h
scamper_udp6.c
scamper_udp6.h
scamper_writebuf.c
scamper_writebuf.h
sniff/scamper_sniff.c
sniff/scamper_sniff.h
sniff/scamper_sniff_do.c
sniff/scamper_sniff_do.h
sniff/scamper_sniff_warts.c
sniff/scamper_sniff_warts.h
sting/scamper_sting.c
sting/scamper_sting.h
sting/scamper_sting_do.c
sting/scamper_sting_do.h
sting/scamper_sting_text.c
sting/scamper_sting_text.h
sting/scamper_sting_warts.c
sting/scamper_sting_warts.h
tbit/scamper_tbit.c
tbit/scamper_tbit.h
tbit/scamper_tbit_do.c
tbit/scamper_tbit_do.h
tbit/scamper_tbit_text.c
tbit/scamper_tbit_text.h
tbit/scamper_tbit_warts.c
tbit/scamper_tbit_warts.h
trace/scamper_trace.c
trace/scamper_trace.h
trace/scamper_trace_do.c
trace/scamper_trace_do.h
trace/scamper_trace_json.c
trace/scamper_trace_json.h
trace/scamper_trace_text.c
trace/scamper_trace_text.h
trace/scamper_trace_warts.c
trace/scamper_trace_warts.h
tracebox/scamper_tracebox.c
tracebox/scamper_tracebox.h
tracebox/scamper_tracebox_do.c
tracebox/scamper_tracebox_do.h
tracebox/scamper_tracebox_text.c
tracebox/scamper_tracebox_text.h
tracebox/scamper_tracebox_warts.c
tracebox/scamper_tracebox_warts.h
tracelb/scamper_tracelb.c
tracelb/scamper_tracelb.h
tracelb/scamper_tracelb_do.c
tracelb/scamper_tracelb_do.h
tracelb/scamper_tracelb_text.c
tracelb/scamper_tracelb_text.h
tracelb/scamper_tracelb_warts.c
tracelb/scamper_tracelb_warts.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/time.h
/usr/include/alloca.h
/usr/include/bits/stdlib-bsearch.h
/usr/include/bits/stdlib-float.h
/usr/include/bits/stdlib-ldbl.h
/usr/include/bits/stdlib.h
/usr/include/bits/string.h
/usr/include/bits/string2.h
/usr/include/bits/string3.h
/usr/include/bits/time.h
/usr/include/bits/types.h
/usr/include/bits/waitflags.h
/usr/include/bits/waitstatus.h
/usr/include/features.h
/usr/include/sys/types.h
/usr/include/xlocale.h
/usr/include/bits/pthreadtypes.h
/usr/include/bits/timex.h
/usr/include/bits/typesizes.h
/usr/include/bits/wordsize.h
/usr/include/endian.h
/usr/include/gnu/stubs.h
/usr/include/stdc-predef.h
/usr/include/sys/cdefs.h
/usr/include/sys/select.h
/usr/include/sys/sysmacros.h
/usr/include/bits/byteswap.h
/usr/include/bits/endian.h
/usr/include/bits/select.h
/usr/include/bits/select2.h
/usr/include/bits/sigset.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
/usr/include/gnu/stubs-x32.h
/usr/include/bits/byteswap-16.h
